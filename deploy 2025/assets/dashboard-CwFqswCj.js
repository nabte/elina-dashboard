import"./auth-Ctw1L6k3.js";class lt{constructor(){this.file=null,this.iti=null,this.init(),this.insertPlaceholder=this.insertPlaceholder.bind(this),this.openAiModalForBulk=this.openAiModalForBulk.bind(this),this.handleTestSend=this.handleTestSend.bind(this)}init(){document.addEventListener("panel:activated",({detail:e})=>{e.panelId==="bulk-sending"&&this.onPanelActivated()})}onPanelActivated(){console.log("Panel de Envío Masivo activado."),this.checkPrerequisites(),this.setupEventListeners(),this.populateLabelSelectors(),document.addEventListener("profile:updated",()=>this.checkPrerequisites())}async checkPrerequisites(){var n,o,s;const e=document.getElementById("bulk-submit-btn");if(!e)return;const t=(o=(n=window.auth.getSession())==null?void 0:n.user)==null?void 0:o.id;if(!t){console.error("No se encontró el ID de usuario para verificar el estado de la campaña.");return}try{const[i,v,x]=await Promise.all([window.auth.sb.from("profiles").select("active_campaign_id, whatsapp_connected").eq("id",t).single(),window.appInstance.loadUserUsage(),window.appInstance.loadUserSubscription()]);if(i.error)throw i.error;const g=i.data,L=v,J=x,te=((s=J==null?void 0:J.plans)==null?void 0:s.bulk_sends_limit)||0,R=(L==null?void 0:L.bulk_sends_used)||0;console.log(`[Bulk Sending] Usage: ${R} / ${te}`),g.whatsapp_connected?g.active_campaign_id?(e.disabled=!0,e.querySelector(".button-text").textContent="Campaña en progreso..."):R>=te?(e.disabled=!0,e.querySelector(".button-text").textContent="Límite de envíos alcanzado"):(e.disabled=!1,e.querySelector(".button-text").textContent="Enviar Campaña"):(e.disabled=!0,e.querySelector(".button-text").textContent="Conecta WhatsApp primero")}catch(i){console.error("Error al verificar pre-requisitos de envío masivo:",i),e.disabled=!0,e.querySelector(".button-text").textContent="Error al verificar"}}setupEventListeners(){var s,i,v;const e=document.getElementById("bulk-send-form");if(!e||e.dataset.listenersAttached==="true")return;e.dataset.listenersAttached="true",e.addEventListener("submit",this.handleBulkSend.bind(this));const t=document.getElementById("file-drop-zone"),n=document.getElementById("bulk-file-input"),o=document.getElementById("remove-file-btn");t.addEventListener("click",()=>n.click()),t.addEventListener("dragover",x=>{x.preventDefault(),t.classList.add("border-blue-500","bg-blue-50")}),t.addEventListener("dragleave",()=>t.classList.remove("border-blue-500","bg-blue-50")),t.addEventListener("drop",x=>{x.preventDefault(),t.classList.remove("border-blue-500","bg-blue-50"),x.dataTransfer.files.length&&this.handleFileSelect(x.dataTransfer.files[0])}),n.addEventListener("change",x=>{x.target.files.length&&this.handleFileSelect(x.target.files[0])}),o.addEventListener("click",()=>this.removeFile()),(s=document.getElementById("personalize-name-btn"))==null||s.addEventListener("click",this.insertPlaceholder),(i=document.getElementById("bulk-test-btn"))==null||i.addEventListener("click",this.handleTestSend),(v=document.getElementById("bulk-ai-enhance-btn"))==null||v.addEventListener("click",this.openAiModalForBulk)}handleFileSelect(e){if(e.size>10485760){confirm("Ups, el archivo es muy grande (máximo 10MB). Te recomendamos esta web para reducir el peso de tu archivo.")&&window.open("https://www.iloveimg.com/compress-image","_blank"),this.removeFile();return}this.file=e;const n=document.getElementById("file-preview"),o=document.getElementById("file-image-preview");document.getElementById("file-name").textContent=e.name,e.type.startsWith("image/")?(o.src=URL.createObjectURL(e),o.classList.remove("hidden")):o.classList.add("hidden"),n.classList.remove("hidden"),document.getElementById("file-drop-zone").classList.add("hidden"),lucide.createIcons()}removeFile(){this.file=null,document.getElementById("bulk-file-input").value="",document.getElementById("file-preview").classList.add("hidden"),document.getElementById("file-image-preview").classList.add("hidden"),document.getElementById("file-drop-zone").classList.remove("hidden")}async populateLabelSelectors(){const e=document.getElementById("include-labels"),t=document.getElementById("exclude-labels");try{const{data:n,error:o}=await window.auth.sb.from("labels").select("name");if(o)throw o;const s=[...new Set(n.map(i=>i.name))].sort();e.innerHTML='<option value="todos">Todos los contactos</option>',s.forEach(i=>e.innerHTML+=`<option value="${i}">${i}</option>`),t.innerHTML='<option value="ninguno">Ninguno</option>',s.forEach(i=>t.innerHTML+=`<option value="${i}">${i}</option>`)}catch(n){console.error("Error al cargar etiquetas para selectores:",n),e.innerHTML="<option>Error al cargar</option>",t.innerHTML="<option>Error al cargar</option>"}}insertPlaceholder(){const e=document.getElementById("bulk-message"),t=e.selectionStart,n=e.selectionEnd,o=e.value,s="%nombre%";e.value=o.substring(0,t)+s+o.substring(n),e.focus(),e.selectionEnd=t+s.length}openAiModalForBulk(){const e=document.getElementById("bulk-message"),t=e.value;if(!t){alert("Primero escribe un mensaje para poder mejorarlo.");return}window.appInstance.openAiEnhanceModal(t,n=>{e.value=n})}async handleBulkSend(e){e.preventDefault();const t=e.target.querySelector('button[type="submit"]');t.disabled=!0;const n=t.querySelector(".button-text");n.textContent="Preparando...",t.querySelector(".loading-spinner").classList.remove("hidden");try{const o=window.auth.getSession().user.id,{error:s}=await window.auth.sb.from("profiles").update({active_campaign_id:`campaign_${Date.now()}`}).eq("id",o);if(s)throw new Error(`No se pudo actualizar el estado: ${s.message}`);let i=null;if(this.file){if(n.textContent="Subiendo archivo...",!window.appInstance)throw new Error("La instancia de la aplicación no está lista.");i=await window.appInstance.uploadAsset(this.file,"bulk-campaigns")}n.textContent="Enviando campaña...";const v={userId:o,message:document.getElementById("bulk-message").value,includeTag:document.getElementById("include-labels").value,excludeTag:document.getElementById("exclude-labels").value,fileUrl:i};if(!(await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/masivos-elina",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(v)})).ok)throw new Error("El servidor de automatización (n8n) no respondió correctamente.");alert("¡Campaña enviada! El proceso se ejecutará en segundo plano. Puedes cerrar esta ventana."),e.target.reset(),this.removeFile()}catch(o){console.error("Error al enviar la campaña:",o),alert(`Error al enviar la campaña: ${o.message}`)}finally{t.disabled=!1,n.textContent="Enviar Campaña",t.querySelector(".loading-spinner").classList.add("hidden")}}handleTestSend(){if(document.getElementById("test-send-modal").classList.remove("hidden"),!this.iti){const t=document.querySelector("#test-phone-input");this.iti=window.intlTelInput(t,{utilsScript:"https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",initialCountry:"mx",separateDialCode:!0}),document.getElementById("cancel-test-send-btn").addEventListener("click",()=>this.closeTestModal()),document.getElementById("confirm-test-send-btn").addEventListener("click",()=>this.executeTestSend())}}closeTestModal(){document.getElementById("test-send-modal").classList.add("hidden"),document.getElementById("test-phone-error").classList.add("hidden")}async executeTestSend(){if(!this.iti.isValidNumber()){document.getElementById("test-phone-error").classList.remove("hidden");return}document.getElementById("test-phone-error").classList.add("hidden");const e=this.iti.getNumber(),t=document.getElementById("confirm-test-send-btn");t.disabled=!0,t.textContent="Enviando...";try{const n=window.auth.getSession().user.id,o=document.getElementById("bulk-message").value.replace("%nombre%","Prueba");let s=null;if(this.file){if(!window.appInstance)throw new Error("La instancia de la aplicación no está lista.");s=await window.appInstance.uploadAsset(this.file,"bulk-tests")}if(!(await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/masivos-test-elina",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:n,testNumber:e,message:o,fileUrl:s})})).ok)throw new Error("El servidor no respondió correctamente.");alert(`Mensaje de prueba enviado a ${e}.`)}catch(n){console.error("Error en envío de prueba:",n),alert(`Error al enviar la prueba: ${n.message}`)}finally{t.disabled=!1,t.textContent="Enviar Prueba",this.closeTestModal()}}}new lt;(function(){let ae=!1,e=null,t=null,n=[],o=[],s=null,i={current:!1},v={current:null},x=[],g=[],L=null;document.addEventListener("panel:activated",({detail:B})=>{var M;B.panelId==="chats"?(ae||J(),(M=B.options)!=null&&M.contactId&&setTimeout(()=>q(B.options.contactId),200)):r()});async function J(){var F,z,X;console.log("Inicializando panel de Chats..."),ae=!0,te(),(F=window.lucide)!=null&&F.createIcons&&lucide.createIcons();const B=(X=(z=window.auth.getSession())==null?void 0:z.user)==null?void 0:X.id;n=await window.auth.sb.from("labels").select("*").eq("user_id",B).then(ee=>ee.data||[]),await W();const M=document.querySelector("#chat-contacts-list .contact-item");M&&M.click()}function te(){var X,ee,O,ne,K,Z,h,_,A;(X=document.getElementById("chat-contacts-list"))==null||X.addEventListener("click",E=>{const G=E.target.closest(".contact-item");if(G){document.querySelectorAll(".contact-item").forEach(me=>me.classList.remove("bg-slate-200")),G.classList.add("bg-slate-200");const re=G.dataset.contactId;G.dataset.contactName,G.dataset.contactPhone,q(re)}}),(ee=document.getElementById("chat-input-form"))==null||ee.addEventListener("submit",H);const B=document.getElementById("chat-message-input");B==null||B.addEventListener("input",k),B==null||B.addEventListener("keydown",E=>{E.key==="Enter"&&!E.shiftKey&&(E.preventDefault(),H(E))}),(O=document.getElementById("chat-contact-info-toggle"))==null||O.addEventListener("click",()=>R()),(ne=document.getElementById("info-ignore-ia-toggle"))==null||ne.addEventListener("change",w),(K=document.getElementById("info-manage-labels-btn"))==null||K.addEventListener("click",c),(Z=document.getElementById("chat-search-input"))==null||Z.addEventListener("input",m),document.getElementById("chat-contact-info-panel");const M=document.getElementById("chat-info-overlay");M&&M.addEventListener("click",()=>R(!1));const F=document.getElementById("back-to-chats-btn");F&&F.addEventListener("click",()=>R(!1)),(h=document.getElementById("chat-attach-file-btn"))==null||h.addEventListener("click",()=>{var E;(E=document.getElementById("chat-file-input"))==null||E.click()}),(_=document.getElementById("chat-file-input"))==null||_.addEventListener("change",E=>{E.target.files&&E.target.files[0]&&j(E.target.files[0])}),(A=document.getElementById("chat-remove-image-btn"))==null||A.addEventListener("click",Q);const z=document.getElementById("chat-view-main");z&&(z.addEventListener("dragover",E=>{E.preventDefault(),E.stopPropagation(),z.classList.add("bg-blue-50")}),B.addEventListener("paste",T),z.addEventListener("paste",T),z.addEventListener("dragleave",E=>{E.preventDefault(),E.stopPropagation(),z.classList.remove("bg-blue-50")}),z.addEventListener("drop",P))}function R(B=null){const M=document.getElementById("chat-contact-info-panel");document.getElementById("chat-view-main");const F=document.getElementById("chat-info-overlay"),z=B===null?!M.classList.contains("open"):!B;M.classList.toggle("hidden",!z),M.classList.toggle("open",z),F==null||F.classList.toggle("hidden",!z)}async function W(){var F,z;const B=document.getElementById("chat-contacts-list"),M=document.getElementById("contacts-list-loader");if(!(!B||!M)){M.classList.remove("hidden"),M.textContent="Cargando conversaciones...",B.innerHTML="";try{const{data:X,error:ee}=await window.auth.sb.rpc("get_recent_contacts").order("last_message_at",{ascending:!1});if(ee)throw ee;const O=(F=window.appInstance)==null?void 0:F.teamInfo,ne=O==null?void 0:O.user_role,K=(z=O==null?void 0:O.profiles)==null?void 0:z.full_name,Z=O==null?void 0:O.allow_all_chats_visibility;let h=X;ne==="advisor"&&K&&!Z&&(h=X.filter(_=>(_.labels||[]).includes(K))),o=h,h.length===0?M.textContent="No hay conversaciones recientes.":(M.classList.add("hidden"),B.innerHTML=h.map(_=>`
                    <div class="contact-item p-3 flex items-center gap-3 cursor-pointer hover:bg-slate-100 rounded-lg transition-colors"
                         data-contact-id="${_.contact_id}" 
                         data-contact-name="${_.full_name}"
                         data-contact-phone="${_.phone_number}">
                        <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0">
                            ${(_.full_name||"?").charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <p class="font-bold truncate">${_.full_name||_.phone_number}</p>
                            <p class="text-sm text-slate-500 truncate">${(_.last_message_content||"").substring(0,40)}...</p>
                        </div>
                    </div>
                `).join(""))}catch(X){console.error("Error al cargar lista de contactos para chat:",X),M.textContent="Error al cargar contactos."}}}async function q(B){var ne,K,Z,h;e=B,r();const{data:M,error:F}=await window.auth.sb.from("contacts").select("*").eq("id",B).single();if(F){console.error("Error buscando contacto:",F);return}t={contact_id:M.id,...M};const z=document.getElementById("chat-history"),X=document.getElementById("chat-header-name"),ee=document.getElementById("chat-view-placeholder"),O=document.getElementById("chat-view-main");if(!(!z||!X||!ee||!O)){ee.classList.add("hidden"),O.classList.remove("hidden"),O.classList.add("flex"),(ne=window.lucide)!=null&&ne.createIcons&&lucide.createIcons({root:O}),X.textContent=t.full_name||t.phone_number,z.innerHTML='<p class="text-center text-slate-400">Cargando mensajes...</p>';try{const _=(Z=(K=window.auth.getSession())==null?void 0:K.user)==null?void 0:Z.id,{data:A,error:E}=await window.auth.sb.from("chat_history").select("message_type, content, created_at").eq("user_id",_).eq("contact_id",B).order("created_at",{ascending:!0});if(E)throw E;A.length===0?z.innerHTML='<p class="text-center text-slate-400">Inicia la conversación.</p>':(z.innerHTML="",A.forEach(G=>p(G,!0)),setTimeout(()=>z.scrollTop=z.scrollHeight,0)),(h=window.lucide)!=null&&h.createIcons&&lucide.createIcons({root:z}),C(),b()}catch(_){console.error("Error al cargar historial de chat:",_),z.innerHTML='<p class="text-center text-red-500">Error al cargar mensajes.</p>'}}}async function H(B){var ne,K;B.preventDefault();const M=B.target.closest("form");if(!M)return;const F=document.getElementById("chat-message-input");let z=F.value.trim();if(!z&&!L||!e)return;const X=M.querySelector('button[type="submit"]');X.disabled=!0;const ee=X.innerHTML;let O=z;F.value="";try{const Z=(K=(ne=window.auth.getSession())==null?void 0:ne.user)==null?void 0:K.id;if(!t)throw new Error("Contacto no encontrado");let h=null;if(L){if(X.innerHTML='<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>',h=await window.appInstance.uploadAsset(L,"chat-files"),!h)throw new Error("No se pudo subir el archivo.");z||(z="Imagen adjunta")}L&&(X.innerHTML=ee),O=h?`${z} ${h}`:z;const _=window.auth.sb.from("chat_history").insert({user_id:Z,contact_id:e,message_type:"ai",content:O}),E=fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/manual-send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:Z,phone_number:t.phone_number,message:z,media_url:h})}),[G,re]=await Promise.all([_,E]);if(G.error)throw new Error(`Error guardando el mensaje: ${G.error.message}`);if(!(await re).ok)throw new Error("El servidor no pudo enviar el mensaje.");p({message_type:"ai",content:O,created_at:new Date().toISOString(),_localEcho:!0}),g.push({content:z,expiresAt:Date.now()+5e3})}catch(Z){console.error("Error al enviar mensaje:",Z),window.showToast(`Error al enviar mensaje: ${Z.message}`,"error"),F.value=z}finally{X.disabled=!1,X.innerHTML=ee,Q()}}function k(){s&&(i.current||(i.current=!0,s.track({is_typing:!0})),v.current&&clearTimeout(v.current),v.current=setTimeout(()=>{i.current=!1,s.track({is_typing:!1}),v.current=null},2e3))}function b(){var B,M,F;s||!e||(console.log(`Suscribiéndose a mensajes para el contacto ${e}`),s=window.auth.sb.channel(`chat-${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_history",filter:`contact_id=eq.${e}`},z=>{console.log("Nuevo mensaje recibido:",z.new),p(z.new)}).on("presence",{event:"sync"},()=>{if(!s)return;const z=s.presenceState(),X=[];for(const ee in z){const O=z[ee][0];O.is_typing&&X.push(O.name)}x=X,f()}).subscribe(),s.track({is_typing:!1,name:((F=(M=(B=window.appInstance)==null?void 0:B.user)==null?void 0:M.user_metadata)==null?void 0:F.full_name)||"Agente"}))}function r(){s&&(console.log("Desuscribiéndose del chat actual."),window.auth.sb.removeChannel(s),s=null)}function f(){const B=document.getElementById("typing-indicator");B&&(x.length>0?B.textContent=`${x.join(", ")} está(n) escribiendo...`:B.textContent="")}function p(B,M=!1){const F=document.getElementById("chat-history");if(!F)return;const z=Date.now();if(g=g.filter(ne=>ne.expiresAt>z),B.message_type!=="human"&&!M){const ne=g.findIndex(K=>K.content===B.content&&K.expiresAt>z);if(ne!==-1&&(g.splice(ne,1),!B._localEcho))return}const X=F.querySelector("p");X&&X.textContent.includes("Inicia la conversación")&&X.remove();const O=`
        <div class="chat-bubble ${B.message_type==="human"?"self-start bg-white":"self-end bg-blue-100"} rounded-lg p-3 max-w-lg lg:max-w-xl shadow-sm space-y-2 break-words">
            ${(()=>{const ne=B.content.match(/(https?:\/\/\S+\.(?:png|jpg|jpeg|gif|webp|avif|bmp|svg))/i);if(ne){const K=ne[0],Z=B.content.replace(K,"").replace(/Imagen:|Media:|Imagen adjunta|Archivo adjunto/ig,"").trim();return`
                        <a href="${K}" target="_blank" rel="noopener noreferrer" class="block group relative">
                            <img src="${K}" class="rounded-lg max-w-xs cursor-pointer" alt="Imagen adjunta" loading="lazy">
                        </a>
                        ${Z?`<p class="text-slate-800 text-sm break-words mt-2">${Z.replace(/:$/,"")}</p>`:""}
                    `}return`<p class="text-slate-800">${B.content}</p>`})()}
            <p class="text-xs text-slate-400 text-right mt-1">${new Date(B.created_at).toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"})}</p>
        </div>`;F.insertAdjacentHTML("beforeend",O),F.scrollTop=F.scrollHeight}function C(){var K,Z,h;if(!t)return;const B=document.getElementById("info-chat-files");if(B){const _=((Z=(K=o.find(A=>A.contact_id==e))==null?void 0:K.chat_history)==null?void 0:Z.map(A=>A.content.match(/(https?:\/\/\S+\.(?:png|jpg|jpeg|gif|webp|avif|bmp|svg))/i)).filter(Boolean).map(A=>A[0]))||[];_.length>0?B.innerHTML=`
                    <h5 class="font-semibold mb-2">Archivos del Chat</h5>
                    <div class="grid grid-cols-3 gap-2">
                        ${_.map(A=>`<a href="${A}" target="_blank" class="aspect-square bg-slate-200 rounded-md overflow-hidden"><img src="${A}" class="w-full h-full object-cover"></a>`).join("")}
                    </div>`:B.innerHTML=""}document.getElementById("info-contact-name").textContent=t.full_name||"Sin nombre",document.getElementById("info-contact-phone").textContent=t.phone_number;const M=document.getElementById("info-ignore-ia-toggle");M&&(M.checked=(t.labels||[]).includes("ignorar"));const F=(h=window.appInstance)==null?void 0:h.teamInfo,z=(F==null?void 0:F.ignored_labels)||[],X=document.getElementById("info-contact-labels"),ee=t.labels||[];X.innerHTML=ee.filter(_=>_!=="ignorar"&&!z.includes(_)).map(_=>{const A=n.find(re=>re.name===_),E=a(A==null?void 0:A.color),G=d(E);return`<span class="text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full" style="background-color: ${E}; color: ${G};">${_}</span>`}).join("")||'<span class="text-xs text-slate-400">Sin etiquetas</span>';const O=document.getElementById("info-contact-razon-ia");O?t!=null&&t.razon_de_label_auto?(O.innerHTML=`<h5 class="font-semibold mb-2">Razón de la IA</h5><p class="text-sm bg-blue-50 p-3 rounded-md text-slate-700">${t.razon_de_label_auto}</p>`,O.classList.remove("hidden")):O.classList.add("hidden"):console.warn("Elemento 'info-contact-razon-ia' no encontrado en el DOM.");const ne=document.getElementById("info-manage-labels-container");ne&&(ne.innerHTML='<button id="info-manage-labels-btn" class="flex items-center gap-2 text-sm text-slate-700 hover:text-blue-600 font-semibold hover:underline mt-3"><i data-lucide="edit" class="w-4 h-4"></i> Gestionar etiquetas</button>',document.getElementById("info-manage-labels-btn").addEventListener("click",c),lucide.createIcons({root:ne}))}const y=["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#FF5722","#795548","#9E9E9E","#607D8B"];function a(B){if(typeof B=="string"&&B.startsWith("#"))return B;const M=parseInt(B,10);return!isNaN(M)&&M>=0&&M<y.length?y[M]:"#A0AEC0"}function d(B){return!B||!B.startsWith("#")||(.299*parseInt(B.substring(1,3),16)+.587*parseInt(B.substring(3,5),16)+.114*parseInt(B.substring(5,7),16))/255>.5?"#1e293b":"#ffffff"}async function w(B){const M=B.target;if(!t)return;const F=M.checked;let z=new Set(t.labels||[]);F?z.add("ignorar"):z.delete("ignorar");const X=Array.from(z);try{const{error:ee}=await window.auth.sb.from("contacts").update({labels:X}).eq("id",t.contact_id);if(ee)throw ee;t.labels=X}catch(ee){console.error("Error al actualizar la etiqueta 'ignorar':",ee),M.checked=!F}}function c(){t&&window.contacts.openLabelsModalForSingleContact(t.contact_id)}function m(B){const M=B.target.value.toLowerCase(),F=document.getElementById("chat-contacts-list");if(!F)return;const z=o.filter(X=>(X.full_name||"").toLowerCase().includes(M)||(X.phone_number||"").includes(M));F.querySelectorAll(".contact-item").forEach(X=>{const ee=X.dataset.contactId;X.style.display=z.some(O=>O.contact_id==ee)?"flex":"none"})}function T(B){if(B.clipboardData&&B.clipboardData.files&&B.clipboardData.files.length>0){const M=B.clipboardData.files[0];M.type.startsWith("image/")&&(B.preventDefault(),j(M))}}function P(B){B.preventDefault(),B.stopPropagation(),document.getElementById("chat-view-main").classList.remove("bg-blue-50"),B.dataTransfer.files&&B.dataTransfer.files[0]&&j(B.dataTransfer.files[0])}function j(B){if(!B.type.startsWith("image/")){window.showToast("Solo se pueden adjuntar imágenes.","error");return}L=B;const M=document.getElementById("chat-image-preview-container"),F=document.getElementById("chat-image-preview");F.src=URL.createObjectURL(B),M.classList.remove("hidden")}function Q(){L=null,document.getElementById("chat-file-input").value="",document.getElementById("chat-image-preview-container").classList.add("hidden"),document.getElementById("chat-image-preview").src=""}})();(function(){var We;let ae=!1,e=!1,t=[],n=[],o=new Set,s={column:"created_at",direction:"desc"},i=1;const v=50;let x=0,g=null,L=null,J=null,te=null,R=null,W=null,q=null,H=null;const k=(...l)=>console.info("[contacts-import]",...l);document.addEventListener("panel:activated",({detail:l})=>{l.panelId==="contacts"?(ae||b(),ot()):st()});function b(){console.log("Inicializando panel de contactos..."),ae=!0,at(),A(),ne(),Z(),w(),K(),r(),document.addEventListener("profile:updated",Oe)}async function r(){await C(),await y(),await Oe()}async function f(l=1){var oe,Y,se,ie;const u=(Y=(oe=window.auth.getSession())==null?void 0:oe.user)==null?void 0:Y.id;if(!u)throw new Error("No se pudo obtener el ID del usuario.");i=l;const I=(i-1)*v,S=I+v-1,N=((se=document.getElementById("contact-search-input"))==null?void 0:se.value.toLowerCase().trim())||"",$=Array.from(((ie=document.getElementById("contact-label-filter"))==null?void 0:ie.selectedOptions)||[]).map(ue=>ue.value).filter(Boolean);let D=window.auth.sb.from("contacts").select("id, full_name, phone_number, created_at, labels, razon_de_label_auto",{count:"exact"}).eq("user_id",u);$.length>0&&$[0]!==""&&(D=D.filter("labels","cs",`{${$.join(",")}}`)),N&&(D=D.or(`full_name.ilike.%${N}%,phone_number.ilike.%${N}%`));const{data:V,error:U,count:le}=await D.order(s.column,{ascending:s.direction==="asc",nullsFirst:!1}).range(I,S);if(U)throw new Error(`No se pudieron cargar contactos: ${U.message}`);return x=le||0,V||[]}async function p(){const{data:l,error:u}=await window.auth.sb.from("labels").select("*");if(u)throw new Error(`No se pudieron cargar las etiquetas: ${u.message}`);return l}async function C(){var I,S;const l=["nuevo cliente","Interesado","No responde"],u=(S=(I=window.auth.getSession())==null?void 0:I.user)==null?void 0:S.id;if(u)try{const{data:N,error:$}=await window.auth.sb.from("labels").select("name").eq("user_id",u);if($)throw $;const D=new Set(N.map(U=>U.name)),V=l.filter(U=>!D.has(U)).map(U=>({name:U,user_id:u,color:"#848484"}));V.length>0&&await window.auth.sb.from("labels").insert(V)}catch(N){console.error("Error al asegurar etiquetas base:",N)}}async function y(){var I;const l=document.getElementById("contacts-loader"),u=document.getElementById("contacts-table-body");if(!(!u||!l)){l.style.display="block",l.textContent="Cargando contactos y etiquetas...",u.innerHTML="";try{if([t,n]=await Promise.all([f(1),p()]),k("loadAndRender resolved",{contacts:t.length,labels:n.length}),F(),d(x),!t.length){const S=(I=document.getElementById("contact-search-input"))==null?void 0:I.value.trim();l.textContent=S?"No se encontraron contactos con ese término.":"Aún no tienes contactos. ¡Sincroniza para empezar!",z([]),a();return}l.style.display="none",z(t),a(),X(),lucide.createIcons()}catch(S){console.error(S),l.textContent="Error al cargar contactos. Revisa la consola."}}}function a(){var N,$;const l=document.getElementById("contacts-pagination");if(!l)return;const u=Math.ceil(x/v);if(u<=1){l.innerHTML="";return}const I=(i-1)*v+1,S=Math.min(i*v,x);l.innerHTML=`
            <span class="text-sm text-slate-600">Mostrando ${I}-${S} de ${x} contactos</span>
            <div class="flex gap-2">
                <button id="prev-page-btn" class="p-2 rounded-md hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed" ${i===1?"disabled":""}><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                <button id="next-page-btn" class="p-2 rounded-md hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed" ${i===u?"disabled":""}><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
            </div>
        `,(N=document.getElementById("prev-page-btn"))==null||N.addEventListener("click",()=>h(i-1)),($=document.getElementById("next-page-btn"))==null||$.addEventListener("click",()=>h(i+1)),lucide.createIcons()}function d(l){const u=document.getElementById("contacts-count-badge");if(u){if(typeof l!="number"){u.classList.add("hidden");return}u.textContent=l.toLocaleString("es-MX"),u.classList.toggle("hidden",l<=0)}}function w(){const l=document.getElementById("export-contacts-btn"),u=document.getElementById("import-contacts-btn"),I=document.getElementById("import-contacts-input");l&&l.addEventListener("click",S=>{S.preventDefault(),c(l)}),u&&I&&(u.addEventListener("click",S=>{S.preventDefault(),I.click()}),I.addEventListener("change",_e))}function c(l){R?T():m(l)}function m(l){T();const u=l.getBoundingClientRect(),I=document.createElement("div");I.id="contacts-export-menu",I.className="absolute bg-white border border-slate-200 rounded-xl shadow-xl w-56 py-2 z-[260]",I.innerHTML=`
            <button type="button" data-format="csv" class="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 flex items-center gap-2">
                <i data-lucide="file-text" class="w-4 h-4 text-slate-500"></i>
                <span>Exportar como CSV</span>
            </button>
            <button type="button" data-format="xlsx" class="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 flex items-center gap-2">
                <i data-lucide="table" class="w-4 h-4 text-slate-500"></i>
                <span>Exportar como Excel (.xlsx)</span>
            </button>
        `,document.body.appendChild(I);const S=I.getBoundingClientRect(),N=u.bottom+window.scrollY+8,$=window.scrollX+window.innerWidth-S.width-16;let D=u.left+window.scrollX;D>$&&(D=Math.max(window.scrollX+16,$)),I.style.top=`${N}px`,I.style.left=`${D}px`,R=I,I.querySelectorAll("button[data-format]").forEach(V=>{V.addEventListener("click",async()=>{await P(V.dataset.format)})}),W=V=>{!I.contains(V.target)&&V.target!==l&&T()},q=V=>{V.key==="Escape"&&(V.preventDefault(),T())},H=()=>T(),document.addEventListener("mousedown",W),document.addEventListener("keydown",q),window.addEventListener("resize",H),window.addEventListener("scroll",H,!0),typeof lucide<"u"&&lucide.createIcons&&lucide.createIcons({root:I})}function T(){R!=null&&R.parentElement&&R.parentElement.removeChild(R),R=null,W&&(document.removeEventListener("mousedown",W),W=null),q&&(document.removeEventListener("keydown",q),q=null),H&&(window.removeEventListener("resize",H),window.removeEventListener("scroll",H,!0),H=null)}async function P(l="csv"){var N,$,D,V,U;const u=document.getElementById("export-contacts-btn");T();const I=window.auth.getSession(),S=(N=I==null?void 0:I.user)==null?void 0:N.id;if(!S){($=window.showToast)==null||$.call(window,"No se pudo obtener tu sesión. Intenta recargar.","error");return}try{u&&(u.disabled=!0,u.classList.add("opacity-60","cursor-wait"));const{data:le,error:oe}=await window.auth.sb.from("contacts").select("full_name, phone_number, labels, razon_de_label_auto, created_at, assigned_to_id").eq("user_id",S).order("created_at",{ascending:!1});if(oe)throw oe;const Y=j(le||[]);if(!Y.length){(D=window.showToast)==null||D.call(window,"No tienes contactos para exportar.","info");return}l==="xlsx"?B(Y):Q(Y),(V=window.showToast)==null||V.call(window,"Exportación generada correctamente.","success")}catch(le){console.error("Error al exportar contactos:",le),(U=window.showToast)==null||U.call(window,`No se pudo exportar: ${le.message}`,"error")}finally{u&&(u.disabled=!1,u.classList.remove("opacity-60","cursor-wait"))}}function j(l){return l.map(u=>({Nombre:u.full_name||"",Telefono:u.phone_number||"",Etiquetas:Array.isArray(u.labels)?u.labels.join(", "):"","Motivo IA":u.razon_de_label_auto||"","Asignado a":u.assigned_to_id||"","Creado el":u.created_at?new Date(u.created_at).toLocaleString("es-MX"):""}))}function Q(l){if(!l.length)return;const u=Object.keys(l[0]),I=[u.join(","),...l.map(N=>u.map($=>xe(N[$])).join(","))],S=new Blob([I.join(`
`)],{type:"text/csv;charset=utf-8;"});M(S,`contactos_${new Date().toISOString().slice(0,10)}.csv`)}function B(l){var $;if(typeof XLSX>"u"){($=window.showToast)==null||$.call(window,"No se encontró la librería XLSX. Se generará un CSV.","info"),Q(l);return}const u=XLSX.utils.json_to_sheet(l),I=XLSX.utils.book_new();XLSX.utils.book_append_sheet(I,u,"Contactos");const S=XLSX.write(I,{bookType:"xlsx",type:"array"}),N=new Blob([S],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});M(N,`contactos_${new Date().toISOString().slice(0,10)}.xlsx`)}function M(l,u){const I=document.createElement("a"),S=URL.createObjectURL(l);I.href=S,I.download=u,document.body.appendChild(I),I.click(),document.body.removeChild(I),setTimeout(()=>URL.revokeObjectURL(S),1500)}function F(){var V;if(!te)return;const l=window.auth.getSession(),u=(V=l==null?void 0:l.user)==null?void 0:V.id;if(!u)return;const I=Array.from(te.selectedOptions||[]).map(U=>U.value),S=n.filter(U=>(U==null?void 0:U.user_id)===u).map(U=>U.name).filter(Boolean).sort((U,le)=>U.localeCompare(le,"es",{sensitivity:"base"})),$=['<option value="">Todas las etiquetas</option>',...Array.from(new Set(S)).map(U=>`<option value="${U}">${U}</option>`)].join("");te.innerHTML=$,I.forEach(U=>{const le=Array.from(te.options).find(oe=>oe.value===U);le&&(le.selected=!0)}),I.length||(te.value="");const D=te.parentElement;if(D&&(D.classList.add("relative"),!D.querySelector(".contact-label-filter-icon"))){const U=document.createElement("i");U.dataset.lucide="chevron-down",U.className="contact-label-filter-icon absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none",D.appendChild(U),typeof lucide<"u"&&lucide.createIcons&&lucide.createIcons({root:D})}}function z(l){var S,N;const u=document.getElementById("contacts-table-body");if(!u)return;const I=(N=(S=window.auth.getSession())==null?void 0:S.user)==null?void 0:N.id;u.innerHTML=l.map($=>`
            <tr data-id="${$.id}">
                <td class="p-4"><input type="checkbox" class="contact-checkbox form-checkbox rounded" data-id="${$.id}"></td>
                <td class="p-4 font-medium">${$.full_name||"Sin nombre"}</td>
                <td class="p-4 text-slate-600">${$.phone_number||"-"}</td>
                <td class="p-4 text-sm">
                    ${($.labels||[]).filter(D=>D!=="ignorar").map(D=>{const V=n.find(oe=>oe.name===D&&oe.user_id===I),U=V?G(V.color):"#848484",le=re(U);return`<span class="text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full" style="background-color: ${U}; color: ${le};">
                            ${D}
                        </span>`}).join("")||'<span class="text-slate-400">-</span>'}
                </td>
                <td class="p-4">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only peer ignore-ia-toggle" data-contact-id="${$.id}" ${($.labels||[]).includes("ignorar")?"checked":""}>
                        <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </td>
                <td class="p-4 text-center">
                    ${$.razon_de_label_auto?`
                        <div class="relative group inline-block">
                            <i data-lucide="brain-circuit" class="w-5 h-5 text-purple-500"></i>
                            <div class="absolute bottom-full mb-2 w-64 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs rounded-lg py-2 px-3 z-10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                ${$.razon_de_label_auto}
                            </div>
                        </div>
                    `:"-"}
                </td>
                <td class="p-4">
                    <button class="edit-contact-btn p-2 hover:bg-slate-200 rounded-md" data-id="${$.id}" title="Editar etiquetas">
                        <i data-lucide="edit" class="w-4 h-4 text-blue-600 pointer-events-none"></i>
                    </button>
                </td>
            </tr>
        `).join("")}function X(){const l=document.getElementById("contacts-table-body"),u=document.getElementById("select-all-contacts");!l||!u||(l.addEventListener("click",I=>{if(I.target.classList.contains("edit-contact-btn")){const S=I.target.dataset.id;o.clear(),o.add(S),me()}if(I.target.classList.contains("contact-checkbox")){const S=I.target.dataset.id;I.target.checked?o.add(S):o.delete(S),ee()}I.target.classList.contains("ignore-ia-toggle")&&O(I.target)}),u.addEventListener("change",I=>{const S=l.querySelectorAll(".contact-checkbox");o.clear(),S.forEach(N=>{N.checked=I.target.checked,I.target.checked&&o.add(N.dataset.id)}),ee()}))}function ee(){const l=document.getElementById("bulk-actions-bar"),u=document.getElementById("selected-count");o.size>0?(l.classList.remove("hidden"),u.textContent=`${o.size} seleccionado(s)`):l.classList.add("hidden")}async function O(l){const u=l.dataset.contactId,I=l.checked,S=t.find(D=>D.id==u);if(!S)return;let N=new Set(S.labels||[]);I?N.add("ignorar"):N.delete("ignorar");const $=Array.from(N);try{const{error:D}=await window.auth.sb.from("contacts").update({labels:$}).eq("id",u);if(D)throw D;S.labels=$}catch(D){console.error("Error al actualizar la etiqueta 'ignorar':",D),l.checked=!I}}function ne(){const l=document.getElementById("contact-search-input");if(!l)return;let u;l.addEventListener("input",()=>{clearTimeout(u),u=setTimeout(()=>{h(1)},300)})}function K(){if(te=document.getElementById("contact-label-filter"),!!te){if(te.dataset.initialized==="true"){F();return}te.dataset.initialized="true",te.className="w-full sm:w-60 bg-white border border-slate-200 rounded-xl text-sm px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition appearance-none",te.style.paddingRight="2.5rem",te.addEventListener("change",()=>{h(1)}),F()}}function Z(){document.querySelectorAll("#contacts thead th[data-sort]").forEach(u=>{u.addEventListener("click",()=>{const I=u.dataset.sort;s.column===I?s.direction=s.direction==="asc"?"desc":"asc":(s.column=I,s.direction="asc"),h(1),_()})})}async function h(l){const u=document.getElementById("contacts-loader");u.style.display="block";try{const I=await f(l);t=I,z(I),a(),d(x),k("page updated",{page:l,pageCount:I.length,total:x}),typeof lucide<"u"&&lucide.createIcons&&lucide.createIcons()}catch(I){console.error("Error al cambiar de página:",I)}finally{u.style.display="none"}}function _(){document.querySelectorAll("#contacts thead th[data-sort]").forEach(l=>{const u=l.querySelector(".sort-indicator");l.dataset.sort===s.column?u.innerHTML=s.direction==="asc"?'<i data-lucide="arrow-up" class="w-4 h-4"></i>':'<i data-lucide="arrow-down" class="w-4 h-4"></i>':u.innerHTML='<i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-400"></i>'}),lucide.createIcons()}function A(){const l=document.getElementById("edit-labels-modal");document.getElementById("cancel-labels-btn").addEventListener("click",()=>l.classList.add("hidden")),document.getElementById("bulk-edit-labels-btn").addEventListener("click",me),document.getElementById("new-label-form").addEventListener("submit",de),document.getElementById("save-labels-btn").addEventListener("click",fe)}const E=["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#FF5722","#795548","#9E9E9E","#607D8B","#FFFFFF"];function G(l){if(typeof l=="string"&&l.startsWith("#"))return l;const u=parseInt(l,10);return!isNaN(u)&&u>=0&&u<E.length?E[u]:"#848484"}function re(l){if(!l.startsWith("#"))return"#1e293b";const u=l.charAt(0)==="#"?l.substring(1,7):l,I=parseInt(u.substring(0,2),16),S=parseInt(u.substring(2,4),16),N=parseInt(u.substring(4,6),16),D=[I/255,S/255,N/255].map(U=>U<=.03928?U/12.92:Math.pow((U+.055)/1.055,2.4));return .2126*D[0]+.7152*D[1]+.0722*D[2]>.179?"#1e293b":"#ffffff"}async function me(){var I,S;const l=document.getElementById("edit-labels-modal"),u=document.getElementById("labels-list");l.classList.remove("hidden"),u.innerHTML='<div class="text-center text-slate-500">Cargando etiquetas...</div>';try{const N=(S=(I=window.auth.getSession())==null?void 0:I.user)==null?void 0:S.id,{data:$,error:D}=await window.auth.sb.from("labels").select("*").eq("user_id",N);if(D)throw D;n=$;const V=n.reduce((oe,Y)=>(oe.some(se=>se.name===Y.name)||oe.push(Y),oe),[]);V.sort((oe,Y)=>oe.name.localeCompare(Y.name));const U=o.size>0?t.find(oe=>oe.id==[...o][0]):{},le=new Set((U==null?void 0:U.labels)||[]);u.innerHTML=V.map(oe=>`
                <div class="flex items-center justify-between p-2 rounded-md hover:bg-slate-100">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" class="label-checkbox form-checkbox rounded" data-label-name="${oe.name}" ${le.has(oe.name)?"checked":""}>
                        <span class="w-4 h-4 rounded-full" style="background-color: ${G(oe.color)};"></span>
                        <span>${oe.name}</span>
                    </label>
                    <button class="edit-label-properties-btn p-1.5 rounded-md hover:bg-slate-200" data-label-id="${oe.id}" title="Editar propiedades de la etiqueta">
                        <i data-lucide="edit" class="w-4 h-4 pointer-events-none edit-label-icon"></i>
                    </button>
                </div>
            `).join("")}catch(N){console.error("Error al cargar etiquetas:",N),u.innerHTML='<div class="text-center text-red-500">Error al cargar etiquetas.</div>'}}(We=document.getElementById("labels-list"))==null||We.addEventListener("click",l=>{const u=l.target.closest(".edit-label-properties-btn");u&&(document.getElementById("edit-labels-modal").classList.add("hidden"),window.appInstance.switchPanel("smart-labels"),setTimeout(()=>{var I;return(I=document.querySelector(`.edit-smart-label-btn[data-id="${u.dataset.labelId}"]`))==null?void 0:I.click()},200))});async function de(l){var $,D;l.preventDefault();const u=document.getElementById("new-label-name"),I=document.getElementById("new-label-color"),S=u.value.trim(),N=(D=($=window.auth.getSession())==null?void 0:$.user)==null?void 0:D.id;if(!(!S||!N))try{const{data:V,error:U}=await window.auth.sb.from("labels").insert({name:S,color:I.value,user_id:N}).select();if(U)throw U;if(k("label creada vía formulario",V),Array.isArray(V)&&V.length){const le=V[0];n=n.filter(oe=>oe.id!==le.id),n.push(le),F()}u.value="",me()}catch(V){console.error("Error al crear etiqueta:",V.message),alert(`No se pudo crear la etiqueta. Error: ${V.message}

Revisa si la columna 'evolution_label_id' en Supabase permite valores nulos.`)}}async function fe(){var u,I,S,N;const l=document.getElementById("save-labels-btn");l.disabled=!0,l.textContent="Guardando...";try{const $=document.getElementById("new-label-name").value.trim(),D=document.getElementById("new-label-color").value,V=(I=(u=window.auth.getSession())==null?void 0:u.user)==null?void 0:I.id;let U=null;if($&&V){const{data:se,error:ie}=await window.auth.sb.from("labels").insert({name:$,color:D,user_id:V}).select().single();if(ie)throw new Error(`Error al crear la nueva etiqueta: ${ie.message}`);U=se.name,n.push(se),F(),document.getElementById("new-label-name").value=""}const le=new Set;document.querySelectorAll("#labels-list .label-checkbox:checked").forEach(se=>le.add(se.dataset.labelName)),$&&le.add($);const oe=new Set;document.querySelectorAll(".label-checkbox:not(:checked)").forEach(se=>oe.add(se.dataset.labelName));const Y=[];for(const se of o){const ie=t.find(ve=>ve.id==se);if(!ie)continue;let ue=new Set(ie.labels||[]);le.forEach(ve=>ue.add(ve)),oe.forEach(ve=>ue.delete(ve));const Be=Array.from(ue);Y.push(window.auth.sb.from("contacts").update({labels:Be}).eq("id",se))}await Promise.all(Y),(S=window.showToast)==null||S.call(window,"Etiquetas guardadas correctamente.","success"),document.getElementById("edit-labels-modal").classList.add("hidden"),Ie(le,o),await h(i),o.clear(),ee()}catch($){console.error("Error al guardar cambios:",$),(N=window.showToast)==null||N.call(window,`No se pudieron guardar los cambios: ${$.message}`,"error")}finally{l.disabled=!1,l.textContent="Guardar Cambios"}}async function Ie(l,u){var S,N;const I=(N=(S=window.auth.getSession())==null?void 0:S.user)==null?void 0:N.id;if(!(!I||l.size===0||u.size===0))try{const{data:$}=await window.auth.sb.from("followups").select("target_label").eq("user_id",I).eq("is_active",!0),D=new Set(($||[]).map(U=>U.target_label));for(const U of l)if(D.has(U))for(const le of u)fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/start-followup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contact_id:le,user_id:I,target_label:U})}).catch(oe=>console.error(`Error al activar seguimiento para ${le}:`,oe));const V=n.filter(U=>U.notify_on_assign&&l.has(U.name));for(const U of V)for(const le of u){const oe=t.find(Y=>Y.id==le);oe&&fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/notificarlabel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:I,contact_name:oe.full_name||"Sin nombre",contact_phone:oe.phone_number,assigned_label:U.name})}).catch(Y=>console.error(`Error al enviar notificación para ${le}:`,Y))}}catch($){console.error("Error en las acciones post-guardado:",$)}}function xe(l){if(l==null)return"";const u=String(l);return/[",\n]/.test(u)?'"'+u.replace(/"/g,'""')+'"':u}async function Le(l){const u=(l.name||"").toLowerCase();if(u.endsWith(".xlsx")||u.endsWith(".xls")){if(typeof XLSX>"u")throw new Error("No se pudo cargar el lector de hojas de cálculo (XLSX). Recarga la página e intenta nuevamente.");const I=await l.arrayBuffer(),S=XLSX.read(I,{type:"array"});if(!S.SheetNames.length)throw new Error("El archivo de Excel no contiene hojas válidas.");const N=S.Sheets[S.SheetNames[0]];return XLSX.utils.sheet_to_csv(N,{FS:",",RS:`
`})}return await l.text()}async function Ce(l,u){const I=new Map;for(const Y of l){const se=Y==null?void 0:Y.trim();if(!se)continue;const ie=se.toLowerCase();I.has(ie)||I.set(ie,se)}const S=Array.from(I.values());if(!S.length)return;if(k("verificando etiquetas detectadas",S),!n.length)try{n=await p()}catch(Y){throw console.error("No se pudo cargar la lista de etiquetas:",Y),new Error("No se pudo cargar la lista de etiquetas actuales.")}const N=new Map(n.filter(Y=>Y.user_id===u).map(Y=>[Y.name.toLowerCase(),Y])),$=S.map(Y=>{const se=N.get(Y.toLowerCase());return{name:Y,color:(se==null?void 0:se.color)||Te(),isNew:!se}});if(!$.length)return;const D=$.map(Y=>{const se=N.get(Y.name.toLowerCase());return{name:Y.name,color:(se==null?void 0:se.color)||Y.color||Te(),isNew:!se}});k("colores de etiquetas asignados automáticamente",D);const V=D.filter(Y=>{const se=N.get(Y.name.toLowerCase());return se?(se.color||"").toLowerCase()!==Y.color.toLowerCase():!0}).map(Y=>({user_id:u,name:Y.name,color:Y.color}));if(!V.length){D.forEach(Y=>{const se=Y.name.toLowerCase(),ie=N.get(se);ie&&(ie.color=Y.color)});return}const{data:U,error:le}=await window.auth.sb.from("labels").upsert(V,{onConflict:"user_id,name"}).select();if(le)throw le;k("etiquetas upsert",{requested:V.length,persisted:(U==null?void 0:U.length)??0});const oe=new Map((U||[]).map(Y=>[Y.name.toLowerCase(),Y]));V.forEach(Y=>{const se=Y.name.toLowerCase(),ie=oe.get(se);let ue=n.find(Be=>Be.user_id===u&&Be.name.toLowerCase()===se);ue?(ue.color=Y.color,ue.name=(ie==null?void 0:ie.name)||ue.name,ie!=null&&ie.id&&(ue.id=ie.id)):n.push({id:(ie==null?void 0:ie.id)||null,user_id:u,name:(ie==null?void 0:ie.name)||Y.name,color:Y.color}),N.set(se,{id:(ie==null?void 0:ie.id)||(ue==null?void 0:ue.id)||null,user_id:u,name:(ie==null?void 0:ie.name)||(ue==null?void 0:ue.name)||Y.name,color:Y.color})}),F()}function Te(){const l=()=>Math.floor(180+Math.random()*60),u=l().toString(16).padStart(2,"0"),I=l().toString(16).padStart(2,"0"),S=l().toString(16).padStart(2,"0");return`#${u}${I}${S}`}async function _e(l){var V,U,le,oe,Y,se,ie,ue,Be,ve;const u=l.target,I=(V=u==null?void 0:u.files)==null?void 0:V[0];if(!I)return;T();const S=[],N=[];let $=null,D=[];try{const Se=(await Le(I)).split(/\r?\n/).map(he=>he.trim()).filter(he=>he.length>0);if(k("archivo leído",{name:I.name,lineCount:Se.length}),!Se.length){(U=window.showToast)==null||U.call(window,"El archivo de contactos está vacío.","info");return}const qe=be(Se[0]).map(he=>he.trim());if($=await $e(qe),k("mapeo de columnas",{headers:qe,mapping:$}),!$){(le=window.showToast)==null||le.call(window,"Importación cancelada.","info");return}const Ee=Se.slice(1),Xe=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),ke=Xe?Xe.id:(Y=(oe=window.auth.getSession())==null?void 0:oe.user)==null?void 0:Y.id;if(k("targetUserId detectado",ke),!ke)throw new Error("No se pudo determinar el usuario destino para la importación.");const{data:rt,error:Ve}=await window.auth.sb.from("contacts").select("id, phone_number, labels, full_name, followup_status, current_followup_id, followup_step_sent, last_followup_sent_at, chatwoot_contact_id, assigned_to_id, razon_de_label_auto, created_at").eq("user_id",ke);if(Ve)throw Ve;const Ye=new Map;(rt||[]).forEach(he=>{const Ne=He(he.phone_number);Ne&&Ye.set(Ne,he)});const Fe=new Map,Ue=new Set;if(Ee.forEach((he,Ne)=>{var Ze,et;const Pe=Ne+2,je=be(he),ze=(Ze=De(je,$.phone_number))==null?void 0:Ze.trim();if(!ze){S.push({rowNumber:Pe,reason:"Sin telefono",rawPhone:ze});return}const Me=He(ze);if(!Me){S.push({rowNumber:Pe,reason:"Telefono invalido",rawPhone:ze});return}const ce=Ye.get(Me);k("fila procesada",{rowNumber:Pe,normalizedPhone:Me,existing:!!ce});const ge={user_id:ke,phone_number:Me,full_name:((et=De(je,$.full_name))==null?void 0:et.trim())||(ce==null?void 0:ce.full_name)||null};ce!=null&&ce.id&&(ge.id=ce.id);const Qe=new Set(((ce==null?void 0:ce.labels)||[]).filter(Boolean)),Ke=nt(De(je,$.labels));Ke&&Ke.map(ye=>ye.trim()).filter(ye=>ye&&ye.toLowerCase()!=="ignorar").forEach(ye=>Qe.add(ye)),ge.labels=Array.from(Qe).filter(Boolean),ge.labels.forEach(ye=>{ye.toLowerCase()!=="ignorar"&&Ue.add(ye)}),ge.created_at=(ce==null?void 0:ce.created_at)||new Date().toISOString(),ge.followup_status=(ce==null?void 0:ce.followup_status)??"idle",ge.current_followup_id=(ce==null?void 0:ce.current_followup_id)??null,ge.followup_step_sent=(ce==null?void 0:ce.followup_step_sent)??-1,ge.last_followup_sent_at=(ce==null?void 0:ce.last_followup_sent_at)??null,ge.chatwoot_contact_id=(ce==null?void 0:ce.chatwoot_contact_id)??null,ge.assigned_to_id=(ce==null?void 0:ce.assigned_to_id)??null,ge.razon_de_label_auto=(ce==null?void 0:ce.razon_de_label_auto)??null,Fe.set(Me,ge),N.push({rowNumber:Pe,phone:Me,fullName:ge.full_name||"",labels:ge.labels.join(", ")})}),k("contactsToUpsert size",Fe.size),Ue.size>0&&await Ce(Array.from(Ue),ke),D=Array.from(Fe.values()),k("payload preparado",{totalRows:Ee.length,payloadCount:D.length,skipped:S.length,sample:D.slice(0,3),phones:D.map(he=>he.phone_number)}),window.lastContactImport={stage:"beforeUpsert",totalRows:Ee.length,processedRows:N,skippedRows:S,mapping:$,finalPayload:D,targetUserId:ke},!D.length){window.lastContactImport={totalRows:Ee.length,processedRows:N,skippedRows:S,finalPayload:D},S.length&&(console.warn("Importacion de contactos sin filas validas.",{skippedRows:S,headers:qe,mapping:$}),typeof console.table=="function"&&console.table(S)),(se=window.showToast)==null||se.call(window,S.length>0?`No se detectaron contactos válidos. ${S.length} filas omitidas.`:"El archivo no contiene contactos para importar.","warning");return}const{data:we,error:Je}=await window.auth.sb.from("contacts").upsert(D,{onConflict:"user_id,phone_number"}).select("id, phone_number, user_id");if(Je)throw Je;k("upsert completado",{insertedOrUpdated:(we==null?void 0:we.length)??0,sample:(ie=we==null?void 0:we.slice)==null?void 0:ie.call(we,0,3)}),window.lastContactImport={stage:"afterUpsert",totalRows:Ee.length,processedRows:N,skippedRows:S,finalPayload:D,upserted:we,targetUserId:ke},typeof console.table=="function"&&N.length&&console.table(N),S.length&&(console.warn("Filas omitidas durante la importacion.",S),typeof console.table=="function"&&console.table(S),(ue=window.showToast)==null||ue.call(window,`${S.length} filas se omitieron. Revisa la consola para detalles.`,"info")),console.info("Resumen de la importacion de contactos",{totalRows:Ee.length,enviados:D.length,omitidos:S.length,vistaPrevia:N.slice(0,10)});const it=`${D.length} contactos importados/actualizados con exito.`;(Be=window.showToast)==null||Be.call(window,it,"success"),await y()}catch(pe){if(k("error durante importación",pe),(pe==null?void 0:pe.message)==="IMPORTACION_CANCELADA")return;const Se=(pe==null?void 0:pe.details)||(pe==null?void 0:pe.hint)||"",qe=pe!=null&&pe.message?`Error al importar: ${pe.message}`:"Error desconocido al importar contactos.",Ee=Se?`${qe} (${Se})`:qe;console.error("Error al importar contactos:",{error:pe,finalPayload:D,skippedRows:S,processedRows:N,mapping:$}),window.lastContactImport={stage:"error",error:pe,finalPayload:D,skippedRows:S,processedRows:N,mapping:$},(ve=window.showToast)==null||ve.call(window,Ee,"error")}finally{u&&(u.value="")}}function be(l){const u=[];let I="",S=!1;for(let N=0;N<l.length;N++){const $=l[N];$==='"'&&(N===0||l[N-1]!=='"')?S&&l[N+1]==='"'?(I+='"',N++):S=!S:$===","&&!S?(u.push(I.trim()),I=""):I+=$}return u.push(I.trim()),u}async function $e(l){const u=[{field:"phone_number",label:"Teléfono",required:!0,aliases:["phone_number","telefono","teléfono","tel","phone","mobile","celular","whatsapp"]},{field:"full_name",label:"Nombre",required:!1,aliases:["full_name","nombre","name","contacto"]},{field:"labels",label:"Etiquetas",required:!1,aliases:["labels","etiquetas","tags"]}];return typeof window.openColumnMappingModal=="function"?await window.openColumnMappingModal(u,l):Ae(l,u)}function Ae(l,u){const I={},S=new Set,N=l.map($=>$.toLowerCase());for(const $ of u){let D=-1;for(const V of $.aliases||[]){const U=N.indexOf(V.toLowerCase());if(U!==-1&&!S.has(U)){D=U;break}}if(D===-1&&(D=l.findIndex((V,U)=>!S.has(U))),D===-1){if($.required)return null;continue}I[$.field]=D,S.add(D)}return I}function De(l,u){return typeof u!="number"||u<0||u>=l.length?"":l[u]}function nt(l){if(!l)return null;const u=l.trim();if(!u)return null;try{const N=JSON.parse(u);if(Array.isArray(N)){const $=N.map(D=>String(D??"").trim()).filter(Boolean);if($.length)return $}}catch{}const S=u.replace(/^\[(.*)\]$/,"$1").replace(/\r?\n/g,",").split(/[;,|]/).map(N=>N.trim()).filter(Boolean);return S.length?S:null}function He(l){if(!l)return"";const u=String(l).replace(/\D+/g,"");return u.length<10?"":"+521"+u.slice(-10)}async function Oe(){var I;const l=document.getElementById("sync-contacts-btn"),u=document.getElementById("contacts-status-container");if(!(!l||!u)){l.disabled=!0;try{const S=window.auth.getSession(),N=(I=S==null?void 0:S.user)==null?void 0:I.id;if(!N)return;const{data:$,error:D}=await window.auth.sb.from("profiles").select("whatsapp_connected, sync_status").eq("id",N).single();if(D)throw D;const V=$==null?void 0:$.whatsapp_connected,U=$==null?void 0:$.sync_status;if(!V){u.innerHTML=`
                    <div class="bg-amber-100 border-l-4 border-amber-500 text-amber-800 p-4 rounded-r-lg">
                        <h4 class="font-bold">Acción requerida</h4>
                        <p class="text-sm mt-1">Debes conectar tu WhatsApp en el panel de <strong>Dashboard</strong> antes de poder sincronizar tus contactos.</p>
                    </div>`,l.disabled=!0,l.innerHTML="Sincronizar Contactos y Etiquetas";return}U==="processing"?(u.innerHTML=`
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg animate-pulse">
                        <p class="text-sm font-medium">Hay una sincronización en progreso. La tabla se actualizará automáticamente al finalizar.</p>
                    </div>`,l.disabled=!0,Ge()):(u.innerHTML="",l.disabled=!1,l.innerHTML="Sincronizar Contactos y Etiquetas")}catch(S){console.error("Error al verificar pre-requisitos de sincronización:",S),l.disabled=!1,l.innerHTML="Sincronizar Contactos y Etiquetas"}}}function at(){const l=document.getElementById("sync-contacts-btn");l&&l.addEventListener("click",async()=>{var I;if(e)return;const u=(I=window.auth.getSession())==null?void 0:I.user;if(!u){alert("Error: No se encontró sesión de usuario.");return}e=!0,l.disabled=!0,l.innerHTML='<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';try{if(!(await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/sync-labels-final",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:u.id})})).ok)throw new Error("La solicitud al webhook falló.");const $=document.getElementById("contacts-status-container");$&&($.innerHTML=`
                        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg">
                            <h4 class="font-bold">Sincronización en progreso...</h4>
                            <p class="text-sm mt-1">Esto puede tardar varios minutos dependiendo de la cantidad de contactos. Te avisaremos cuando esté listo. Puedes seguir usando la aplicación.</p>
                        </div>`),Ge()}catch(S){console.error("Error al iniciar la sincronización:",S),alert("Error al iniciar la sincronización."),l.disabled=!1,l.innerHTML="Sincronizar Contactos y Etiquetas"}finally{e=!1}})}function Ge(){var I;const l=window.auth.getSession(),u=(I=l==null?void 0:l.user)==null?void 0:I.id;!u||J||(J=setInterval(async()=>{var S;try{const{data:N,error:$}=await window.auth.sb.from("profiles").select("sync_status").eq("id",u).single();if($)throw $;const D=N==null?void 0:N.sync_status;if(D!=="processing"){clearInterval(J),J=null;const V=document.getElementById("contacts-status-container");V&&(V.innerHTML="");const U=document.getElementById("sync-contacts-btn");U&&(U.disabled=!1,U.innerHTML="Sincronizar Contactos y Etiquetas"),D==="completed"&&((S=window.showToast)==null||S.call(window,"Sincronización completada. La tabla se ha actualizado.","success"))}}catch(N){console.error("Error durante el seguimiento de la sincronización:",N),clearInterval(J),J=null;const $=document.getElementById("sync-contacts-btn");$&&($.disabled=!1,$.innerHTML="Sincronizar Contactos y Etiquetas")}},1e4))}function ot(){var u,I;if(g)return;const l=(I=(u=window.auth.getSession())==null?void 0:u.user)==null?void 0:I.id;l&&(console.log("Suscribiéndose a cambios en la tabla de Contactos..."),g=window.auth.sb.channel("public:contacts:contacts-table").on("postgres_changes",{event:"*",schema:"public",table:"contacts",filter:`user_id=eq.${l}`},S=>{console.log("Cambio recibido en Contactos:",S),clearTimeout(L),L=setTimeout(()=>{var N;(N=window.showToast)==null||N.call(window,"La lista de contactos se ha actualizado.","info"),y()},2e3)}).subscribe())}function st(){if(g){console.log("Desuscribiéndose de los cambios de Contactos.");try{window.auth.sb.removeChannel(g)}catch(l){console.error("Error al desuscribir del canal de contactos:",l)}g=null}T()}window.contacts={openLabelsModalForSingleContact:l=>{l&&(o.clear(),o.add(l),me())},logLastImport:()=>(console.info("[contacts-import] lastContactImport snapshot:",window.lastContactImport),window.lastContactImport),async verifySupabaseAccess(l=5){var u;try{const I=window.auth.getSession(),S=(u=I==null?void 0:I.user)==null?void 0:u.id;if(!S)return console.warn("[contacts-import] verifySupabaseAccess: no active session"),null;const{data:N,error:$}=await window.auth.sb.from("contacts").select("id, user_id, phone_number, created_at").eq("user_id",S).order("created_at",{ascending:!1}).limit(l);if($)throw $;return console.info("[contacts-import] verifySupabaseAccess result:",N),N}catch(I){return console.error("[contacts-import] verifySupabaseAccess error:",I),null}},async debugInsertTestContact(){var l;try{const u=window.auth.getSession(),I=(l=u==null?void 0:u.user)==null?void 0:l.id;if(!I)return console.warn("[contacts-import] debugInsertTestContact: no active session"),null;const S=Date.now(),N=`+521000${String(S).slice(-6)}`,$={user_id:I,phone_number:N,full_name:`Debug Contact ${S}`,labels:["debug"],followup_status:"idle",followup_step_sent:-1,created_at:new Date().toISOString(),razon_de_label_auto:null,assigned_to_id:null,current_followup_id:null,last_followup_sent_at:null,chatwoot_contact_id:null},{data:D,error:V}=await window.auth.sb.from("contacts").insert([$]).select("id, phone_number, created_at");if(V)throw V;return console.info("[contacts-import] debugInsertTestContact result:",D),D}catch(u){throw console.error("[contacts-import] debugInsertTestContact error:",u),u}}}})();(function(){let ae=!1,e="home",t=[],n=null,o=[],s={used:0,limit:0},i=null,v=!1,x={},g={},L={};const J={none:{name:"Ninguno / Manual",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/noun.jpg",prompt:"Create a visually appealing, well-composed, full-bleed promotional social media flyer based *only* on the user's specific instructions for style, text, and visual elements. There is no predefined base style."},"corp-moderno":{name:"Corp. Moderno",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Corporativo%20Moderno.jpg",prompt:"Create a professional, clean, full-bleed promotional social media flyer design. The background should be a smooth, edge-to-edge gradient in corporate blue tones. Use professional, high-quality photos. Typography is a modern, readable sans-serif. Leave ample clean space for text overlays."},elegancia:{name:"Elegancia Min.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Elegancia%20Minimalista.jpg",prompt:"Create an elegant, minimalist, full-bleed promotional social media flyer design. Use a clean, light-colored background (like white or soft gray), a refined serif or sans-serif font. The layout must be uncluttered with generous use of negative space. The overall feeling should be premium and sophisticated."},comida:{name:"Estilo Audaz",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Comida%20Audaz.jpg",prompt:"Create a bold, promotional, full-bleed social media flyer design. Use strong, high-contrast colors like red, yellow, and black. The typography must be large and impactful. The main subject should be presented in a powerful and appealing manner."},colorido:{name:"Colorido",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/Gemini_Generated_Image_th5h7nth5h7nth5h.png",prompt:'Create a "Modern Health Campaign" style full-bleed design. The background should feature smooth, flowing gradients of purple and blue that extend edge-to-edge. All visual and textual elements must be integrated directly into this background, utilizing clean, geometric divisions (e.g., sharp diagonal lines, large color blocks, or integrated rounded shapes). High-quality, relevant photography should be seamlessly blended into sections of this full-bleed layout. Typography is a modern, clean sans-serif, using varying weights and colors to establish clear hierarchy. The overall feel must be trustworthy, informative, and clean.'},urbano:{name:"Collage Urbano",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Collage%20Urbano.jpg",prompt:"Create a dynamic, urban collage-style, full-bleed promotional social media flyer design. Combine textures like torn paper, duct tape, and spray paint splatters. Use a mix of gritty, high-contrast photography and bold, handwritten or stencil-style fonts. The vibe should be edgy and energetic."},deporte:{name:"Estilo Dinámico",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Deporte%20Din%C3%A1mico.jpg",prompt:"Create an energetic and dynamic, full-bleed promotional social media flyer design. Use strong diagonal lines, motion blur effects, and a high-contrast color palette. Typography should be bold, modern, and convey a sense of speed and power."},premium:{name:"Brillo Premium",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Brillo%20Premium.jpg",prompt:"Create a luxurious and premium, full-bleed promotional social media flyer design. Use a dark, sophisticated color palette, often incorporating gold, silver, or metallic accents. Lighting should be elegant, creating soft highlights and shadows. The mood is exclusive and high-end."},lineas:{name:"Líneas",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/Gemini_Generated_Image_r0m7v1r0m7v1r0m7.png",prompt:'Create a "Dynamic Geometric" style design. The composition is based on a clean, bright white background that is geometrically divided by fluid, rounded shapes (circles, capsule-like diagonal forms) in various tones of blue. These shapes must extend to the very edges of the canvas. All visual and textual elements, including photography, must be seamlessly integrated as part of this unified full-bleed canvas. High-quality photography should be directly incorporated into the flow of the geometric shapes or background, forming an organic part of the overall design. Typography is modern and clean sans-serif, using bold weights for headlines and lighter weights for details.'}},te={studio:{name:"Foto de Estudio Clásica",description:"Fondo limpio y neutro.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/foto%20estudio%20clasica.png",prompt:"on a seamless, light gray background. The lighting is a soft, three-point setup, creating subtle, flattering shadows that define the product's form. Hyper-realistic, 8k, tack sharp focus."},lifestyle:{name:"Escena de Estilo de Vida",description:"Integrado en una escena realista.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/lifestyle.png",prompt:"on a rustic wooden coffee shop table, next to a steaming latte with latte art. Natural, soft window lighting is coming from the side. The scene feels candid, atmospheric, and has a shallow depth of field."},"flat-lay":{name:"Plano Cenital (Flat Lay)",description:"Vista desde arriba con accesorios.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/flat%20lay.png",prompt:"in a perfectly organized top-down flat lay composition on a clean white surface alongside a partially open laptop, a pair of stylish eyeglasses, and a small green succulent plant. The lighting is bright, even, and shadowless."},texture:{name:"Sobre Fondo Texturizado",description:"Colocado sobre mármol, madera, etc.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/fondo%20texturizado.png",prompt:"placed on a rough, dark slab of natural slate. A single, strong directional light rakes across the surface, emphasizing the fine texture of the slate and the smooth, glossy glaze of the product. Moody and tactile."},dramatic:{name:"Entorno Dramático",description:"Iluminación cinematográfica.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/entorno%20dramatico.png",prompt:"on a wet, volcanic rock with mist swirling in the background. The lighting is high-contrast and moody, with a single spotlight hitting the product, making it glow. Shot from a low-angle to make it feel monumental and epic."},abstract:{name:"Conceptual y Abstracto",description:"Ambiente surrealista y artístico.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/abstracto.png",prompt:"floating and partially submerged in crystal clear water, with vibrant clouds of blue and orange ink swirling around it. Bold, artistic lighting creates beautiful refractions through the water and on the product's surface."}},R={none:{name:"Ninguno",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/noun.jpg",prompt:""},woman:{name:"Mujer",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/quien%20lo%20usa%20mujer.png",prompt:"a woman is using the product naturally."},man:{name:"Hombre",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/quien%20los%20usa%20hombre.png",prompt:"a man is using the product naturally."}},W={none:{name:"Ninguno",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/noun.jpg",prompt:""},nature:{name:"Naturaleza",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/donde%20se%20usa%20naturaleza.png",prompt:"The scene is set in a vibrant, natural environment like a forest or a beach."},city:{name:"Urbano",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/donde%20lo%20usa%20urbano.png",prompt:"The scene is set in a dynamic, modern urban environment, like a bustling city street or a stylish cafe."},home:{name:"Hogar",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/donde%20lo%20usa%20hogar.png",prompt:"The scene is set inside a cozy, well-lit home, like a living room or kitchen."}},q={none:{name:"Ninguno",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/noun.jpg",prompt:""},day:{name:"Día",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/ambiente%20dia%20soleado.png",prompt:"The lighting is bright and clear, like a sunny morning or midday."},sunset:{name:"Atardecer",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/ambiente%20atardecer%20dorado.png",prompt:"The lighting is warm and golden, characteristic of a beautiful sunset."},night:{name:"Noche",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/ambiente%20noche.png",prompt:"The scene is set at night, with dramatic, moody lighting from artificial sources like city lights or lamps."}},H={professional:{name:"Profesional",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_tdnut4tdnut4tdnu.png",prompt:"A professional corporate headshot. The person is in business attire, with a soft, out-of-focus modern office background. Lighting is flattering and studio-quality. The expression is confident and approachable. Photorealistic, 8k, sharp focus on the eyes."},casual:{name:"Casual Urbano",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_bo3epfbo3epfbo3e.png",prompt:"A friendly, casual outdoor portrait in a vibrant urban setting, like a stylish city street with bokeh lights. The person is dressed in smart-casual clothing. The lighting is bright, natural daylight, creating a warm and inviting mood. Photorealistic, shallow depth of field."},studio:{name:"Estudio Creativo",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_b7m3uob7m3uob7m3.png",prompt:"A modern, creative studio headshot. The person is against a solid, bold-colored background (like deep teal or mustard yellow). The lighting is more dramatic and artistic, with a key light creating defined shadows. The expression is confident and creative. High-fashion style, sharp details."},nature:{name:"Naturaleza",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_h265k4h265k4h265.png",prompt:"A relaxed, natural headshot in a lush, green environment like a park or forest. The person is dressed casually. The lighting is soft, diffused sunlight filtering through leaves, creating a serene and authentic atmosphere. Photorealistic, natural look."},event:{name:"En Evento",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_amp7eiamp7eiamp7.png",prompt:"A dynamic, in-action headshot as if taken at a professional conference or networking event. The person appears engaged, perhaps speaking or listening intently. The background is blurred, showing hints of a crowd and event lighting, giving a sense of energy and professionalism. Candid style."},minimalist:{name:"Minimalista",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_761a3j761a3j761a.png",prompt:"A clean, minimalist headshot against a simple, textured, light-gray or off-white studio background. The lighting is perfectly even and soft, eliminating harsh shadows. The focus is entirely on the person's natural expression. Modern and clean aesthetic."}};document.addEventListener("panel:activated",({detail:h})=>{h.panelId==="designer-ai"&&!ae?k():h.panelId==="designer-ai"&&window.appInstance&&window.appInstance.renderUsageAndLimits()});function k(){ae=!0,document.addEventListener("usage:updated",({detail:h})=>{const{remaining:_,limit:A}=h.imageGenerations;s.used=A-_,s.limit=A;const E=document.querySelector("#flyer-image-generation-usage, #product-image-generation-usage");E&&(E.textContent=`${s.used} / ${s.limit}`),m()}),b(),p()}async function b(){var h,_;v=!0,m();try{const A=(_=(h=window.auth.getSession())==null?void 0:h.user)==null?void 0:_.id,{data:E,error:G}=await window.auth.sb.from("profiles").select("branding_settings, gallery_images").eq("id",A).single();if(o=[],E!=null&&E.gallery_images&&(o=E.gallery_images.map(re=>({id:re,src:re}))),G)throw G;i=E.branding_settings}catch(A){console.error("Error al cargar la configuración de marca:",A)}await r(),v=!1,m(),window.appInstance&&window.appInstance.renderUsageAndLimits()}function r(){return g={images:{logo:null,background:null,product:null,ref1:null,ref2:null,ref3:null},removeProductBg:!0,flyerStyle:"none",colors:["#4F46E5","#9333EA","#FFFFFF","#000000"],textInputs:{headline:"",secondary:"",terms:"",price:"",visuals:"",styleMods:""},finalPrompt:""},L={images:{main:null,opt1:null,opt2:null},mode:"product-only",productOnlyData:{environment:"studio",customPrompt:""},lifestyleData:{who:"none",whoCustom:"",where:"none",whereCustom:"",when:"none",whenCustom:""},finalPrompt:""},x={images:{ref1:null,ref2:null,ref3:null},scene:"professional",finalPrompt:""},t=[],n=null,v=!1,new Promise(async h=>{if(i){i.colors&&i.colors.length>0&&(g.colors=i.colors.slice(0,4));const _=[];i.logo_url&&_.push(ne(i.logo_url).then(A=>{A&&(g.images.logo=A)})),i.reference_images&&i.reference_images.length>0&&i.reference_images.slice(0,3).forEach((A,E)=>{_.push(ne(A).then(G=>{G&&(g.images[`ref${E+1}`]=G)}))}),await Promise.all(_)}C(),h()})}async function f(h){e=h,await r(),s={used:0,limit:0},m(),window.appInstance&&window.appInstance.renderUsageAndLimits()}function p(){var _;const h=document.getElementById("designer-ai");h&&((_=document.getElementById("close-image-viewer-btn"))==null||_.addEventListener("click",()=>{var A;(A=document.getElementById("image-viewer-modal"))==null||A.classList.add("hidden")}),h.addEventListener("click",A=>{var Te;const E=A.target,G=E.closest(".start-option-btn"),re=E.closest(".nav-btn"),me=E.closest(".generate-btn"),de=E.closest(".download-btn"),fe=E.closest(".gallery-thumbnail-wrapper"),Ie=E.closest(".mode-selector-btn");G&&f(G.dataset.tool),re&&f(re.dataset.tool),me&&w(),de&&c(n),fe&&(n=fe.querySelector("img").src,m()),Ie&&(L.mode=Ie.dataset.mode,a(),m()),A.target.closest("#view-all-gallery-btn")&&K();const Le=A.target.closest(".output-image-container .group img");Le&&Z(Le.src,"Imagen generada");const Ce=A.target.closest(".gallery-item-home");if(Ce){const _e=(Te=Ce.querySelector("img"))==null?void 0:Te.src;_e&&Z(_e,"Imagen de la galería")}}),h.addEventListener("change",A=>{const E=A.target;if(E.name==="flyer-style")g.flyerStyle=E.value;else if(E.id==="remove-bg-check")g.removeProductBg=E.checked;else if(E.closest(".color-palette-container")){const G=parseInt(E.dataset.index,10);g.colors[G]=E.value}else E.name==="environment"?L.productOnlyData.environment=E.value:E.name==="who"?L.lifestyleData.who=E.value:E.name==="where"?L.lifestyleData.where=E.value:E.name==="when"?L.lifestyleData.when=E.value:E.name==="headshot-scene"&&(x.scene=E.value);C(),m()}),h.addEventListener("input",A=>{const E=A.target;if(E.tagName!=="TEXTAREA"&&!(E.tagName==="INPUT"&&E.type==="text"))return;E.dataset.flyer_text?g.textInputs[E.dataset.flyer_text]=E.value:E.dataset.product_text?L.productOnlyData[E.dataset.product_text]=E.value:E.dataset.lifestyle_text?L.lifestyleData[E.dataset.lifestyle_text]=E.value:E.dataset.headshot_text,C();const G=h.querySelector(".prompt-display");G&&(G.textContent=e==="flyer"?g.finalPrompt:L.finalPrompt)}))}function C(){y(),a(),d()}function y(){let h=`Create a high-quality, professional, full-bleed promotional flyer for social media.
`;g.flyerStyle!=="none"?h+=`--- BASE STYLE ---
${J[g.flyerStyle].prompt}
`:g.textInputs.styleMods&&(h+=`--- CUSTOM STYLE DESCRIPTION ---
Based on the following user description, generate a rich and detailed artistic style. Elaborate on the user's ideas to create a professional and visually stunning aesthetic. User's description: '${g.textInputs.styleMods}'
`),h+=`--- COLOR PALETTE ---
The design must strictly adhere to the following color palette: ${g.colors.join(", ")}. Use these as the primary colors for backgrounds, text, and elements.
`,g.textInputs.visuals&&(h+=`--- VISUAL ELEMENTS ---
The design MUST include: ${g.textInputs.visuals}
`),h+=`--- TEXT HIERARCHY & CONTENT ---
`,g.textInputs.headline&&(h+=`Main Headline (in its original language): '${g.textInputs.headline}'. This is the most prominent text.
`),g.textInputs.secondary&&(h+=`Secondary Text (in its original language): '${g.textInputs.secondary}'. This is smaller than the headline.
`),g.textInputs.price&&(h+=`Price (in its original language): '${g.textInputs.price}'. Display this clearly but secondary to the headline.
`),g.textInputs.terms&&(h+=`Terms (in its original language): '${g.textInputs.terms}'. This text must be very small and discreet at the bottom.
`),h+=`--- FINAL INSTRUCTIONS ---
Ensure a cohesive, eye-catching composition with a clean layout and crisp text. The final image should look professionally designed and have a 1:1 square aspect ratio. The output MUST BE the design itself, filling the entire canvas. CRITICAL: DO NOT include any social media interface elements, app frames, post templates, user interface icons (like 'like', 'comment', 'share' buttons), or any elements outside of the core design.`,g.finalPrompt=h}function a(){if(L.mode==="product-only"){let h="Generate a high-quality, photorealistic image of the user's product. The final image should look like professional product photography.";h+=`

--- SCENE DESCRIPTION ---`,h+=`
- Base Scene: ${te[L.productOnlyData.environment].prompt}`,L.productOnlyData.customPrompt&&(h+=`
- Specific Details: ${L.productOnlyData.customPrompt}. These details are critical and should override the base scene if there's a conflict.`),h+=`

--- FINAL INSTRUCTIONS ---
Ensure the lighting is realistic for the described environment. The product should be the clear focus of the image. The composition must be aesthetically pleasing and professional. The final image must be a 1:1 square aspect ratio.`,L.finalPrompt=h}else{let h="Generate a high-quality, photorealistic lifestyle image featuring the user's product being used by a person in a described scene.";h+=`

--- SCENE DESCRIPTION ---`;let _=R[L.lifestyleData.who].prompt;L.lifestyleData.whoCustom&&(_+=` Specific details: ${L.lifestyleData.whoCustom}.`),_&&(h+=`
- Person: ${_}`);let A=W[L.lifestyleData.where].prompt;L.lifestyleData.whereCustom&&(A+=` Specific details: ${L.lifestyleData.whereCustom}.`),A&&(h+=`
- Location: ${A}`);let E=q[L.lifestyleData.when].prompt;L.lifestyleData.whenCustom&&(E+=` Specific details: ${L.lifestyleData.whenCustom}.`),E&&(h+=`
- Time & Ambiance: ${E}`),h+=`

--- FINAL INSTRUCTIONS ---
The person should be interacting with the product naturally. The product is the hero, but the scene must feel authentic and aspirational. The composition must be aesthetically pleasing and professional. The final image must be a 1:1 square aspect ratio.`,L.finalPrompt=h}}function d(){let h="Generate a high-quality, photorealistic headshot of the person shown in the reference images. The final image should be a professional-looking portrait.";h+=`

--- SCENE DESCRIPTION ---
${H[x.scene].prompt}`,h+=`

--- FINAL INSTRUCTIONS ---
CRITICAL: The face in the generated image MUST be a highly accurate and realistic representation of the person in the reference photos. The final image must be a 1:1 square aspect ratio.`,x.finalPrompt=h}async function w(){var G,re,me;const h=document.querySelector(".generate-btn"),_=document.querySelector(".output-image-container");if(s.used>=s.limit){window.showToast("Has alcanzado tu límite de generaciones de imágenes este mes.","error");return}h&&(h.disabled=!0,h.innerHTML='<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div> Generando...'),_&&(_.innerHTML='<div class="absolute inset-0 flex items-center justify-center"><div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500"></div></div>'),v=!0,n=null;const A=[];let E="";if(e==="flyer"){if(E=g.finalPrompt,g.images.background&&(A.push({text:"CRITICAL BACKGROUND INSTRUCTION: The following image MUST be used as the full-bleed background for the entire design. Integrate text and other elements on top of this background, but do not alter the background image itself."}),A.push({inlineData:{data:g.images.background.base64,mimeType:g.images.background.mimeType}})),g.images.product){let fe="CRITICAL PRODUCT INSTRUCTION: The following image is the product. It MUST be included in the design. Recreate it accurately. Do not distort or alter its shape or content. You can adjust its position and scale to fit the composition.";g.removeProductBg&&(fe+=" CRITICAL: You MUST remove the original background from the product image, leaving only the product itself. Do not add any new background to the product cutout."),A.push({text:fe}),A.push({inlineData:{data:g.images.product.base64,mimeType:g.images.product.mimeType}})}g.images.logo&&(A.push({text:"CRITICAL LOGO INSTRUCTION: The following image is the brand logo. It MUST be included in the design and reproduced with 100% accuracy. Do not distort, alter, or change its colors."}),A.push({inlineData:{data:g.images.logo.base64,mimeType:g.images.logo.mimeType}}));const de=[g.images.ref1,g.images.ref2,g.images.ref3].filter(Boolean);de.length>0&&(A.push({text:`--- STYLISTIC REFERENCE IMAGES (FOR INSPIRATION ONLY) ---
Analyze the following image(s) for their general design style, composition, use of color, and overall mood. CRITICAL: DO NOT copy, replicate, or include any specific elements, subjects, or text from these reference images. Use them for abstract stylistic inspiration ONLY.`}),de.forEach(fe=>{A.push({inlineData:{data:fe.base64,mimeType:fe.mimeType}})}))}else if(e==="product"){if(!L.images.main){window.showToast("La imagen principal del producto es obligatoria.","error"),v=!1,h&&(h.disabled=!1,h.innerHTML="Generar"),_.innerHTML='<div class="placeholder-icon dark-placeholder"><i data-lucide="image-down"></i><p>El resultado aparecerá aquí</p></div>',m();return}E=L.finalPrompt,A.push({text:`--- CRITICAL PRODUCT INSTRUCTIONS ---
The following image(s) show the product to be featured. This is NOT for style reference. You MUST place this exact product into the new scene described in the prompt. Recreate the product with high fidelity, paying attention to its shape, color, texture, and any logos or text on it. Use the optional images for extra detail and context.`}),A.push({inlineData:{data:L.images.main.base64,mimeType:L.images.main.mimeType}}),L.images.opt1&&(A.push({text:"Optional reference image 1 for additional detail:"}),A.push({inlineData:{data:L.images.opt1.base64,mimeType:L.images.opt1.mimeType}})),L.images.opt2&&(A.push({text:"Optional reference image 2 for additional detail:"}),A.push({inlineData:{data:L.images.opt2.base64,mimeType:L.images.opt2.mimeType}}))}else if(e==="headshot"){const de=[x.images.ref1,x.images.ref2,x.images.ref3].filter(Boolean);if(de.length===0){window.showToast("Debes subir al menos una foto de referencia.","error"),v=!1,m();return}E=x.finalPrompt,A.push({text:`--- CRITICAL FACE REFERENCE INSTRUCTIONS ---
The following image(s) are of the person to be depicted. You MUST use these images as a reference to generate a new headshot of the SAME person. The facial features, structure, and identity must match the person in these photos with high fidelity.`}),de.forEach(fe=>A.push({inlineData:{data:fe.base64,mimeType:fe.mimeType}}))}A.push({text:E});try{const de=(re=(G=window.auth.getSession())==null?void 0:G.user)==null?void 0:re.id,{data:fe,error:Ie}=await window.auth.sb.functions.invoke("gemini-proxy",{body:{userId:de,type:"image",parts:A}});if(Ie)throw Ie;window.appInstance&&await window.appInstance.renderUsageAndLimits();const xe=fe.results;if(!xe||xe.length===0)throw new Error("La IA no devolvió ninguna imagen.");const Le=xe.map(be=>({id:crypto.randomUUID(),src:be}));t.unshift(...Le),n=((me=Le[0])==null?void 0:me.src)||null;const Ce=xe.map(be=>window.auth.sb.functions.invoke("smart-worker",{body:{userId:de,b64_json:be.split(",")[1],subfolder:"ELINA"}})),_e=(await Promise.all(Ce)).map(be=>{var $e;return($e=be.data)==null?void 0:$e.cdnUrl}).filter(Boolean);if(_e.length>0){const be=_e.map(Ae=>({id:Ae,src:Ae}));o.unshift(...be);const $e=o.map(Ae=>Ae.src);await window.auth.sb.from("profiles").update({gallery_images:$e}).eq("id",de)}}catch(de){console.error("Error al generar diseño:",de),window.showToast(de.message||"Ocurrió un error al generar la imagen.","error")}finally{v=!1,m()}}function c(h){if(!h)return;const _=document.createElement("a");_.href=h;const E=h.split(";")[0].split(":")[1].split("/")[1]||"png";_.download=`elina-design-${Date.now()}.${E}`,document.body.appendChild(_),_.click(),document.body.removeChild(_)}function m(){const h=document.getElementById("designer-ai");if(!h)return;let _="";switch(e){case"flyer":_=j();break;case"product":_=Q();break;case"headshot":_=B();break;case"home":default:_=T()}h.innerHTML=_,lucide.createIcons(),e!=="home"&&X()}function T(){return`
            <div class="text-center">
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Creador de Contenido con IA</h1>
                <p class="text-slate-500 mt-2 mb-8">Elige una herramienta para empezar.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                    <button data-tool="flyer" class="start-option-btn">
                        <img src="https://creativersezone.b-cdn.net/ELINA/media%20app/Gemini_Generated_Image_dvylmddvylmddvyl.png" alt="Crear Flyer" class="start-option-img" />
                        <div class="start-option-overlay">
                            <h3 class="font-semibold text-lg">Crear Flyer para Redes Sociales</h3>
                            <p class="text-sm text-gray-300 mt-1">Para promos, anuncios y comunicados.</p>
                        </div>
                    </button>
                    <button data-tool="product" class="start-option-btn">
                        <img src="https://creativersezone.b-cdn.net/ELINA/media%20app/Gemini_Generated_Image_fexq2ufexq2ufexq.png" alt="Visualizar Producto" class="start-option-img" />
                        <div class="start-option-overlay">
                            <h3 class="font-semibold text-lg">Visualizar Producto</h3>
                            <p class="text-sm text-gray-300 mt-1">Coloca tu producto en diferentes escenarios.</p>
                        </div>
                    </button>
                    <button data-tool="headshot" class="start-option-btn">
                        <img src="https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_vsl3jdvsl3jdvsl3.png" alt="Estudio Fotográfico IA" class="start-option-img" />
                        <div class="start-option-overlay">
                            <h3 class="font-semibold text-lg">Estudio Fotográfico IA</h3>
                            <p class="text-sm text-gray-300 mt-1">Crea fotos de perfil profesionales.</p>
                        </div>
                    </button>
                </div>
                ${o.length>0?`
                    <div class="mt-12">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Tus Últimas Creaciones</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 home-gallery-container">
                            ${o.slice(0,6).map(h=>`
                                <div class="gallery-item-home aspect-square bg-slate-200 rounded-lg overflow-hidden group relative cursor-pointer">
                                    <img src="${h.src}" alt="Imagen generada" class="w-full h-full object-cover">
                                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                        <i data-lucide="zoom-in" class="w-8 h-8 text-white"></i>
                                    </div>
                                </div>
                            `).join("")}
                        </div> 
                        <button id="view-all-gallery-btn" class="primary-btn mt-6 max-w-xs mx-auto">Ver más</button>
                    </div>
                `:""}
            </div>
        `}function P(h,_,A){return`
            <nav class="main-nav mb-8">
                <button data-tool="home" class="nav-btn ${e==="home"?"active":""}"><i data-lucide="home" class="w-4 h-4 mr-2"></i>Inicio</button>
                <button data-tool="flyer" class="nav-btn ${e==="flyer"?"active":""}"><i data-lucide="layout-template" class="w-4 h-4 mr-2"></i>Flyers</button>
                <button data-tool="product" class="nav-btn ${e==="product"?"active":""}"><i data-lucide="gem" class="w-4 h-4 mr-2"></i>Producto</button>
                <button data-tool="headshot" class="nav-btn ${e==="headshot"?"active":""}"><i data-lucide="user-round" class="w-4 h-4 mr-2"></i>Estudio IA</button>
            </nav>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-slate-900">${h}</h2>
                    <p class="text-slate-500 mt-1 mb-6">${_}</p>
                    ${A}
                </div>
                <div class="lg:col-span-2 space-y-4 lg:sticky lg:top-6 self-start flex flex-col">
                    <div class="output-image-container dark-bg relative">
                        ${v?'<div class="absolute inset-0 flex items-center justify-center"><div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500"></div></div>':""} 
                        ${!v&&n?`
                            <div class="relative w-full h-full group aspect-square">
                                <img src="${n}" alt="Generated result" class="w-full h-full object-cover" />
                                <button class="download-btn">Descargar</button>
                            </div>
                        `:""}
                        ${!v&&!n?'<div class="placeholder-icon dark-placeholder"><i data-lucide="image-down"></i><p>El resultado aparecerá aquí</p></div>':""}
                    </div>
                    <div class="mt-2 bg-slate-100 rounded-lg p-3 text-center">
                         <h4 class="font-bold text-sm mb-1 text-slate-700">Uso Mensual</h4>
                         <p class="text-xs text-slate-600">Imágenes generadas: <span id="${e}-image-generation-usage" class="font-bold">0 / 0</span></p>
                    </div><button class="primary-btn !mt-4 w-full generate-btn animate-pulse-blue" ${v||s.used>=s.limit?"disabled":""}>${v?'<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div> Generando...':"Generar"}</button>
                    ${t.length>0?` 
                        <div class="pt-4 border-t">
                            <h3 class="text-sm font-medium text-slate-500 mb-2">Resultados (${t.length} opciones)</h3>
                            <div class="grid grid-cols-4 gap-2">
                               ${t.map(E=>`
                                    <div class="gallery-thumbnail-wrapper">
                                        <img src="${E.src}" alt="Generated thumbnail" class="gallery-thumbnail ${n===E.src?"active":""}" />
                                    </div>
                                `).join("")}
                            </div>
                        </div>
                    `:""}
                </div>
            </div>
        `}function j(){const h=`
            <div class="space-y-6">
                <div>
                    <label class="text-sm font-medium">1. Sube tus imágenes (Opcional)</label>
                    <div class="grid grid-cols-3 gap-4 mt-1">
                       ${M("flyer-upload-logo","Logo","(Opcional)",g.images.logo)}
                       <div>
                            ${M("flyer-upload-product","Producto","(Opcional)",g.images.product)}
                            <div class="flex items-center mt-2 justify-center" onclick="event.stopPropagation()">
                                <input type="checkbox" id="remove-bg-check" ${g.removeProductBg?"checked":""} class="form-checkbox rounded text-blue-600" />
                                <label for="remove-bg-check" class="ml-2 text-xs text-gray-500">Quitar fondo</label>
                            </div>
                       </div>
                       ${M("flyer-upload-background","Fondo","(Opcional)",g.images.background)}
                       ${M("flyer-upload-ref1","Ref. Estilo 1","(Opcional)",g.images.ref1)}
                       ${M("flyer-upload-ref2","Ref. Estilo 2","(Opcional)",g.images.ref2)}
                       ${M("flyer-upload-ref3","Ref. Estilo 3","(Opcional)",g.images.ref3)}
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                       <label class="text-sm font-medium">2. Elige un estilo base</label>
                       ${F(J,"flyer-style",g.flyerStyle)}
                    </div>
                     <div>
                        <label class="text-sm font-medium">3. Completa la información del flyer</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2 text-input-grid">
                            <div class="text-input-wrapper">
                                <label>Texto Principal</label>
                                <textarea data-flyer_text="headline" placeholder="Ej: 50% DE DESCUENTO">${g.textInputs.headline}</textarea>
                            </div>
                            <div class="text-input-wrapper">
                                <label>Texto Secundario</label>
                                <textarea data-flyer_text="secondary" placeholder="Ej: Solo esta semana">${g.textInputs.secondary}</textarea>
                            </div>
                            <div class="text-input-wrapper">
                                <label>Precio / Llamada a la acción</label>
                                <textarea data-flyer_text="price" placeholder="Ej: $99.99 o ¡Inscríbete!">${g.textInputs.price}</textarea>
                            </div>
                            <div class="text-input-wrapper">
                                <label>Términos / Info Adicional</label>
                                <textarea data-flyer_text="terms" placeholder="Ej: Válido hasta agotar existencias">${g.textInputs.terms}</textarea>
                            </div>
                             <div class="md:col-span-2 text-input-wrapper">
                                <label>Elementos Visuales a Incluir</label>
                                <textarea data-flyer_text="visuals" placeholder="Ej: mujer con laptop, íconos de tecnología, un cerebro brillante">${g.textInputs.visuals}</textarea>
                            </div>
                            <!-- INICIO: CORRECCIÓN - Mostrar campo de estilo solo si es manual -->
                            <div class="md:col-span-2 text-input-wrapper ${g.flyerStyle==="none"?"":"hidden"}">
                                <label>Describe tu Estilo Personalizado</label>
                                <textarea data-flyer_text="styleMods" placeholder="Ej: estética futurista, patrones de circuitos, colores neón">${g.textInputs.styleMods}</textarea>
                            </div>
                            <!-- FIN: CORRECCIÓN -->
                        </div>
                    </div>
                     <div>
                        <label class="text-sm font-medium">4. Define tu paleta de colores</label>
                        ${z(g.colors)}
                    </div>
                     <div class="!mt-4">
                        <label class="text-xs font-medium text-slate-500">Prompt Final (Solo para referencia)</label>
                        <pre class="prompt-display">${g.finalPrompt}</pre>
                    </div>
                </div>
            </div>
        `;return P("Creador de Flyers","Crea flyers promocionales para redes sociales.",h)}function Q(){const h=!!L.images.main,_=`
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-medium">1. Sube tu producto</label>
                    <div class="grid grid-cols-3 gap-2 mt-1">
                       ${M("product-upload-main","Imagen Principal","(Obligatorio)",L.images.main)}
                       ${M("product-upload-opt1","Opcional 1","(Detalles)",L.images.opt1)}
                       ${M("product-upload-opt2","Opcional 2","(Contexto)",L.images.opt2)}
                    </div>
                </div>
                <fieldset class="space-y-4 ${h?"fieldset-enabled":"fieldset-disabled"}">
                    <div>
                        <label class="text-sm font-medium">2. Elige un modo</label>
                        <div class="grid grid-cols-2 gap-3 mt-1">
                            <button data-mode="product-only" class="mode-selector-btn ${L.mode==="product-only"?"active":""}">
                                <img src="https://creativersezone.b-cdn.net/ELINA/media%20app/product/fondo%20texturizado.png" alt="Producto en un escenario" class="mode-selector-img" />
                                <div class="mode-selector-overlay"><h3 class="font-semibold text-base">Producto Solo</h3></div>
                            </button>
                            <button data-mode="with-human" class="mode-selector-btn ${L.mode==="with-human"?"active":""}">
                                <img src="https://creativersezone.b-cdn.net/ELINA/media%20app/product/lifestyle.png" alt="Producto con persona" class="mode-selector-img" />
                                <div class="mode-selector-overlay"><h3 class="font-semibold text-base">Con Persona</h3></div>
                            </button>
                        </div>
                    </div>
                    ${L.mode==="product-only"?`
                        <div class="space-y-4 fade-in">
                            <div>
                                <label class="text-sm font-medium">3. Elige un entorno</label>
                                ${F(te,"environment",L.productOnlyData.environment)}
                            </div>
                             <div>
                                <div class="text-input-wrapper">
                                    <label>4. Añade detalles (Opcional)</label>
                                    <textarea data-product_text="customPrompt" placeholder="Ej: con un toque de vapor saliendo, sobre una superficie reflectante">${L.productOnlyData.customPrompt}</textarea>
                                </div>
                            </div>
                        </div>
                    `:`
                         <div class="space-y-4 fade-in">
                            <div>
                                <label class="text-sm font-medium">3. Define la escena</label>
                                <div class="space-y-4 p-3 bg-slate-100 rounded-lg mt-1">
                                    <div>
                                        <h4 class="text-xs font-bold text-slate-500">QUIÉN LO USA</h4>
                                        ${F(R,"who",L.lifestyleData.who)}
                                        <div class="text-input-wrapper mt-2">
                                            <label class="hidden">Detalles de quién</label>
                                            <textarea data-lifestyle_text="whoCustom" rows="1" placeholder="Detalles (Ej: una mujer joven, sonriendo)">${L.lifestyleData.whoCustom}</textarea>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-bold text-slate-500">DÓNDE LO USA</h4>
                                        ${F(W,"where",L.lifestyleData.where)}
                                        <div class="text-input-wrapper mt-2">
                                            <label class="hidden">Detalles de dónde</label>
                                            <textarea data-lifestyle_text="whereCustom" rows="1" placeholder="Detalles (Ej: en un balcón con vistas)">${L.lifestyleData.whereCustom}</textarea>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-bold text-slate-500">CUÁNDO LO USA</h4>
                                        ${F(q,"when",L.lifestyleData.when)}
                                        <div class="text-input-wrapper mt-2">
                                            <label class="hidden">Detalles de cuándo</label>
                                            <textarea data-lifestyle_text="whenCustom" rows="1" placeholder="Detalles (Ej: la luz del sol se filtra)">${L.lifestyleData.whenCustom}</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `}
                    <div class="!mt-4"> 
                        <label class="text-xs font-medium text-slate-500">Prompt Final (Solo para referencia)</label>
                        <pre class="prompt-display">${L.finalPrompt}</pre>
                    </div>
            </div>
        `;return P("Visualizador de Producto","Coloca tu producto en diferentes escenarios profesionales.",_)}function B(){const h=`
            <div class="space-y-6">
                <div>
                    <label class="text-sm font-medium">1. Sube tus fotos de referencia (1-3)</label>
                    <p class="text-xs text-slate-500 mt-1">Sube fotos claras de tu rostro desde diferentes ángulos para obtener el mejor resultado.</p>
                    <div class="grid grid-cols-3 gap-4 mt-2">
                       ${M("headshot-upload-ref1","Foto Principal","(Obligatorio)",x.images.ref1)}
                       ${M("headshot-upload-ref2","Foto Opcional 2","",x.images.ref2)}
                       ${M("headshot-upload-ref3","Foto Opcional 3","",x.images.ref3)}
                    </div>
                </div>
                <div>
                    <label class="text-sm font-medium">2. Elige un escenario</label>
                    ${F(H,"headshot-scene",x.scene)}
                </div>
            </div>
        `;return P("Estudio Fotográfico IA","Crea fotos de perfil profesionales a partir de tus propias imágenes.",h)}function M(h,_,A,E){const G=E?`data:${E.mimeType};base64,${E.base64}`:null;return`
            <div class="image-upload-slot" data-upload-id="${h}">
                <label for="${h}" class="upload-label">
                    ${E?"":`
                        <div class="text-center text-xs text-gray-500">
                            <p class="font-semibold">${_}</p>
                            <p>${A}</p>
                        </div>
                    `}
                </label>
                ${E?`<img src="${G}" alt="Preview" class="image-preview" />`:""}
                ${E?`<button class="remove-button" data-remove-id="${h}"><i data-lucide="x" class="w-4 h-4 pointer-events-none"></i></button>`:""}
                <input id="${h}" type="file" class="hidden" accept="image/*" />
            </div>
        `}function F(h,_,A){return`
            <div class="grid grid-cols-4 gap-3 mt-2">
                ${Object.entries(h).map(([E,G])=>`
                    <div>
                        <input type="radio" id="${_}-${E}" name="${_}" value="${E}" class="hidden peer" ${A===E?"checked":""} />
                        <label for="${_}-${E}" class="style-selector-label group">
                            <img src="${G.image}" alt="${G.name}" class="style-thumbnail" />
                            <div class="style-text-overlay">${G.name}</div>
                        </label>
                    </div>
                `).join("")}
            </div>
        `}function z(h){return`
            <div class="color-palette-container">
                ${h.map((_,A)=>`
                    <div class="color-swatch-wrapper">
                        <input type="color" value="${_}" data-index="${A}" class="color-swatch-input" />
                        <span class="color-swatch-hex">${_}</span>
                    </div>
                `).join("")}
            </div>
        `}function X(){document.querySelectorAll(".image-upload-slot").forEach(h=>{var E;const _=h.dataset.uploadId,A=document.getElementById(_);(E=h.querySelector(".remove-button"))==null||E.addEventListener("click",G=>{G.preventDefault(),G.stopPropagation(),ee(null,_)}),A.addEventListener("change",G=>{var re;return ee(((re=G.target.files)==null?void 0:re[0])||null,_)}),h.addEventListener("dragover",G=>{G.preventDefault(),h.classList.add("dragging-over")}),h.addEventListener("dragleave",G=>{G.preventDefault(),h.classList.remove("dragging-over")}),h.addEventListener("drop",G=>{var re;G.preventDefault(),h.classList.remove("dragging-over"),ee(((re=G.dataTransfer.files)==null?void 0:re[0])||null,_)})})}async function ee(h,_){const E=(re=>re.startsWith("flyer-")?re.replace("flyer-upload-",""):re.startsWith("product-")?re.replace("product-upload-",""):re.startsWith("headshot-")?re.replace("headshot-upload-",""):null)(_);if(!E)return;let G=null;if(h&&h.type.startsWith("image/"))try{G={base64:await O(h),mimeType:h.type}}catch(re){console.error("Error leyendo el archivo:",re),window.showToast("Error al leer el archivo.","error")}e==="flyer"?g.images[E]=G:e==="product"?L.images[E]=G:e==="headshot"&&(x.images[E]=G),m()}function O(h){return new Promise((_,A)=>{const E=new FileReader;E.onload=()=>_(E.result.split(",")[1]),E.onerror=G=>A(G),E.readAsDataURL(h)})}async function ne(h){try{const{data:_,error:A}=await window.auth.sb.functions.invoke("image-proxy",{body:{url:h}});if(A)throw new Error(`Proxy error: ${A.message}`);if(!_||!_.base64||!_.mimeType)throw new Error("La respuesta del proxy de imagen no es válida.");return{base64:_.base64,mimeType:_.mimeType}}catch(_){return console.error(`Error al convertir la URL ${h} a Base64:`,_),null}}function K(){var A;const h=document.getElementById("full-gallery-modal"),_=document.getElementById("full-gallery-content");!h||!_||(_.innerHTML=`
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                ${o.map(E=>`
                    <div class="aspect-square bg-slate-200 rounded-lg overflow-hidden group relative">
                        <img src="${E.src}" alt="Imagen generada" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <button class="view-image-btn p-2 bg-white/80 rounded-full" data-src="${E.src}">
                                <i data-lucide="zoom-in" class="w-6 h-6 text-slate-800 pointer-events-none"></i>
                            </button>
                        </div>
                    </div>
                `).join("")}
            </div>
        `,h.classList.remove("hidden"),lucide.createIcons(),(A=document.getElementById("close-full-gallery-modal-btn"))==null||A.addEventListener("click",()=>h.classList.add("hidden"),{once:!0}),_.addEventListener("click",E=>{const G=E.target.closest(".view-image-btn");G&&Z(G.dataset.src,"Imagen de la galería")}))}function Z(h,_="Vista previa de imagen",A="imagen.png"){const E=document.getElementById("image-viewer-modal"),G=document.getElementById("image-viewer-content"),re=document.getElementById("download-image-viewer-btn");!E||!G||!h||(G.innerHTML=`<img src="${h}" alt="${_}" class="max-h-[90vh] max-w-[90vw] object-contain rounded-lg shadow-2xl">`,re&&(re.onclick=me=>{me.preventDefault();const de=document.createElement("a");de.href=h,de.download=A,document.body.appendChild(de),de.click(),document.body.removeChild(de)}),E.classList.remove("hidden"))}})();(function(){let ae=!1,e=[],t=[];const n=24;document.addEventListener("panel:activated",({detail:q})=>{q.panelId==="follow-ups"&&!ae&&(o(),ae=!0)});async function o(){console.log("Inicializando panel de Seguimientos..."),ae=!0,await s(),i()}async function s(){var k,b;const q=document.getElementById("followups-list");if(!q)return;q.innerHTML='<div id="followups-loader" class="text-center text-slate-500 p-8">Cargando secuencias...</div>';const H=q.querySelector("#followups-loader");try{const r=(b=(k=window.auth.getSession())==null?void 0:k.user)==null?void 0:b.id,[f,p]=await Promise.all([window.auth.sb.from("followups").select("*").eq("user_id",r),window.auth.sb.from("labels").select("name").eq("user_id",r)]);if(f.error)throw f.error;if(p.error)throw p.error;e=f.data,t=p.data.map(C=>C.name).sort(),v()}catch(r){console.error("Error al cargar datos de seguimientos:",r),H&&(H.textContent="Error al cargar datos.")}finally{}}function i(){var q,H,k,b,r,f,p;(q=document.getElementById("add-sequence-btn"))==null||q.addEventListener("click",()=>x(null)),(H=document.getElementById("cancel-sequence-btn"))==null||H.addEventListener("click",g),(k=document.getElementById("sequence-form"))==null||k.addEventListener("submit",te),(b=document.getElementById("delete-sequence-btn"))==null||b.addEventListener("click",R),(r=document.getElementById("add-message-btn"))==null||r.addEventListener("click",()=>L()),(f=document.getElementById("follow-ups-container"))==null||f.addEventListener("click",C=>{const y=C.target.closest(".toggle-follow-up-btn");y&&W(y);const a=C.target.closest(".edit-follow-up-btn");if(a){const d=a.dataset.id,w=e.find(c=>c.id==d);w&&x(w)}}),(p=document.getElementById("messages-container"))==null||p.addEventListener("click",C=>{C.target.closest(".remove-step-btn")&&(C.target.closest(".message-step").remove(),J()),C.target.classList.contains("upload-file-btn")&&C.target.previousElementSibling.click()})}function v(){const q=document.getElementById("followups-list");if(!q)return;const H=q.querySelector("#followups-loader");if(H&&H.classList.add("hidden"),e.length===0){q.innerHTML='<p class="text-slate-500 text-center p-8">No has creado ninguna secuencia de seguimiento.</p>';return}q.innerHTML=e.map(k=>`
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="text-lg font-bold text-slate-900">${`Secuencia para "${k.target_label}"`}</h4>
                        <p class="text-sm text-slate-500">Se activa con la etiqueta: <span class="font-semibold text-blue-600">${k.target_label}</span></p>
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer toggle-follow-up-btn" data-id="${k.id}" ${k.is_active?"checked":""}>
                            <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600" title="${k.is_active?"Secuencia Activa":"Secuencia Inactiva"}"></div>
                        </label>
                        <button class="edit-follow-up-btn text-blue-600 hover:underline font-semibold flex items-center gap-1 ml-3" data-id="${k.id}">
                            <i data-lucide="edit-2" class="w-4 h-4"></i> Editar
                        </button>
                    </div>
                </div>
            </div>
        `).join(""),lucide.createIcons()}function x(q){var r;const H=document.getElementById("sequence-modal");document.getElementById("sequence-form").reset(),document.getElementById("sequence-modal-title").textContent=q?"Editar Secuencia":"Crear Nueva Secuencia",document.getElementById("sequence-id").value=(q==null?void 0:q.id)||"";const k=document.getElementById("sequence-target-label");k.innerHTML='<option value="">-- Selecciona una etiqueta --</option>'+t.map(f=>`<option value="${f}">${f}</option>`).join(""),q&&(k.value=q.target_label),document.getElementById("sequence-is-active").checked=q?q.is_active:!0;const b=document.getElementById("messages-container");if(b.innerHTML="",((r=q==null?void 0:q.messages)==null?void 0:r.length)>0){const f=typeof q.messages=="string"?JSON.parse(q.messages):q.messages,p=Array.isArray(q.timings)?q.timings:typeof q.timings=="string"?JSON.parse(q.timings):[],C=Array.isArray(q.file_urls)?q.file_urls:typeof q.file_urls=="string"?JSON.parse(q.file_urls):[];f.forEach((y,a)=>{var d;L({message:y,delay:((d=p[a])==null?void 0:d.delay)??n,fileUrl:(C==null?void 0:C[a])??""})})}else L();document.getElementById("delete-sequence-btn").classList.toggle("hidden",!q),H.classList.remove("hidden"),lucide.createIcons()}function g(){document.getElementById("sequence-modal").classList.add("hidden")}function L(q={message:"",delay:n,fileUrl:""}){const H=document.getElementById("messages-container"),k=document.getElementById("add-message-btn");if(H.querySelectorAll(".message-step").length>=3){window.showToast("Puedes añadir un máximo de 3 mensajes por secuencia.","info");return}const r=document.getElementById("message-step-template").content.cloneNode(!0);r.querySelector(".step-message").value=q.message,r.querySelector(".step-delay").value=q.delay??n;const f=r.querySelector(".file-name-display"),p=r.querySelector(".step-image-preview");q.fileUrl&&(/\.(jpg|jpeg|png|gif|webp)$/i.test(q.fileUrl)&&(p.src=q.fileUrl,p.classList.remove("hidden")),f.textContent=q.fileUrl.split("/").pop(),f.dataset.existingUrl=q.fileUrl),r.querySelector(".step-file-input").addEventListener("change",C=>{f.textContent=C.target.files[0]?C.target.files[0].name:"Ningún archivo seleccionado",f.dataset.existingUrl=""}),H.appendChild(r),J(),H.querySelectorAll(".message-step").length>=3?k.classList.add("hidden"):k.classList.remove("hidden"),lucide.createIcons()}function J(){document.querySelectorAll(".message-step").forEach((H,k)=>{H.querySelector(".step-number").textContent=k+1});const q=document.getElementById("add-message-btn");document.querySelectorAll(".message-step").length<3&&q.classList.remove("hidden")}async function te(q){var C,y;q.preventDefault();const H=document.getElementById("save-sequence-btn");H.disabled=!0,H.textContent="Guardando...";const k=document.getElementById("sequence-id").value,b=Array.from(document.querySelectorAll(".message-step")),r=b.map(async a=>{const d=a.querySelector(".step-file-input"),w=a.querySelector(".file-name-display");return d.files[0]?await window.appInstance.uploadAsset(d.files[0],"follow-ups"):w.dataset.existingUrl?w.dataset.existingUrl:null}),f=await Promise.all(r),p={user_id:(y=(C=window.auth.getSession())==null?void 0:C.user)==null?void 0:y.id,target_label:document.getElementById("sequence-target-label").value,is_active:document.getElementById("sequence-is-active").checked,messages:b.map(a=>a.querySelector(".step-message").value),timings:b.map(a=>({delay:parseInt(a.querySelector(".step-delay").value)||n})),file_urls:f,follow_up_count:b.length};try{const a=k?window.auth.sb.from("followups").update(p).eq("id",k).select().single():window.auth.sb.from("followups").insert(p).select().single(),{data:d,error:w}=await a;if(w)throw w;if(p.is_active&&p.target_label){console.log(`Reintegrando contactos con la etiqueta: ${p.target_label}`);const{error:c}=await window.auth.sb.rpc("reassign_followup_to_contacts_with_label",{p_user_id:p.user_id,p_target_label:p.target_label,p_followup_id:d.id});c&&(console.error("Error al reintegrar contactos:",c),window.showToast("Secuencia guardada, pero hubo un error al reintegrar los contactos existentes.","warning"))}window.showToast("Secuencia guardada con éxito.","success"),g(),await s(),v()}catch(a){console.error("Error al guardar la secuencia:",a),window.showToast(`Error: ${a.message}`,"error")}finally{H.disabled=!1,H.textContent="Guardar Secuencia"}}async function R(){const q=document.getElementById("sequence-id").value;if(!(!q||!confirm("¿Estás seguro de que quieres eliminar esta secuencia?")))try{const{error:H}=await window.auth.sb.from("followups").delete().eq("id",q);if(H)throw H;window.showToast("Secuencia eliminada.","info"),g(),await s(),v()}catch(H){console.error("Error al eliminar:",H),window.showToast(`Error: ${H.message}`,"error")}}async function W(q){const H=q.dataset.id,k=q.checked;q.disabled=!0;try{const{error:b}=await window.auth.sb.from("followups").update({is_active:k}).eq("id",H);if(b)throw b;const r=e.find(f=>f.id==H);r&&(r.is_active=k)}catch(b){console.error("Error al cambiar estado:",b),q.checked=!k}finally{q.disabled=!1}}})();(function(){let ae=!1,e=[],t=[],n=[],o=null;function s(y){if(!y)return[];const a=[y.members,y.team_members,y.teamMembers,y.member_list].filter(Array.isArray);if(!a.length)return[];const d=[];for(const w of a)if(w.forEach(c=>{const m=(c==null?void 0:c.user_id)||(c==null?void 0:c.id)||(c==null?void 0:c.member_id)||(c==null?void 0:c.userId);m&&d.push({user_id:m,profiles:c.profiles||{full_name:c.full_name||c.name||null,email:c.email||null}})}),d.length)break;return d}async function i(){ae||(console.log("Inicializando panel Kanban..."),ae=!0,await v(),x(),L())}document.addEventListener("panel:activated",({detail:y})=>{y.panelId==="kanban"?(ae||i(),p()):C()});async function v(){const y=document.getElementById("kanban-loader");y&&y.classList.remove("hidden");try{const a=window.auth.getSession();if(!a)throw new Error("No hay sesión activa.");const d=a.user.id,w=await window.appInstance.loadTeamInfo(),c=window.auth.sb.from("labels").select("*").eq("user_id",d),m=window.auth.sb.from("contacts").select("id, full_name, phone_number, labels, razon_de_label_auto, assigned_to_id"),[T,P]=await Promise.all([c,m]);if(T.error)throw T.error;if(P.error)throw P.error;if(e=T.data,n=P.data,t=[],(w==null?void 0:w.user_role)==="admin"){let Q=s(w);if(Q.length){const B=Q.map(M=>M.user_id).filter(Boolean);if(B.length){const{data:M,error:F}=await window.auth.sb.from("profiles").select("id, full_name, email").in("id",B);if(F)console.warn("Error al obtener perfiles de miembros del equipo:",F),t=Q.map(z=>({...z,profiles:null}));else{const z=Object.fromEntries((M||[]).map(X=>[X.id,X]));t=Q.map(X=>({...X,profiles:z[X.user_id]||null}))}}else t=Q.map(M=>({...M,profiles:null}))}else console.warn("No se obtuvo información de miembros del equipo desde teamInfo. La asignación de asesores podría no estar disponible.")}}catch(a){console.error("Error al cargar datos para Kanban:",a),y&&(y.textContent="Error al cargar datos.")}finally{y&&y.classList.add("hidden")}}function x(){var a,d,w;const y=document.getElementById("kanban");y&&(y.addEventListener("click",c=>{c.target.id==="kanban-individual-btn"&&(g(c.target),J("_individual_"))}),y.addEventListener("change",c=>{c.target.id==="kanban-funnel-select"&&(g(c.target),J(c.target.value))}),(a=document.getElementById("kanban-board"))==null||a.addEventListener("click",c=>{const m=c.target.closest('[data-lucide="info"]');m&&q(m.closest(".kanban-card").dataset.contactId)}),(d=document.getElementById("kanban-board"))==null||d.addEventListener("change",c=>{c.target.classList.contains("assign-advisor-select")&&W(c.target.dataset.contactId,c.target.value)}),(w=document.getElementById("kanban-board"))==null||w.addEventListener("mouseover",c=>{H(c)}))}function g(y){document.querySelectorAll("#kanban-controls .kanban-control-item").forEach(d=>{d.classList.remove("bg-blue-600","text-white","border-blue-500","ring-2","ring-blue-200","ring-blue-300"),d.classList.add("border-slate-300","bg-white","text-slate-700","shadow-sm")});const a=y.closest(".kanban-control-item");a&&(a.classList.remove("border-slate-300"),a.classList.add("border-blue-500","ring-2","ring-blue-300"),a.tagName==="BUTTON"?(a.classList.add("bg-blue-600","text-white"),a.classList.remove("bg-white","text-slate-700")):a.classList.add("ring-blue-300"))}function L(){var c;const y=[...new Set(e.map(m=>m.funnel_name).filter(Boolean))].sort(),a=e.some(m=>!m.funnel_name),d=document.getElementById("kanban-controls");if(!d)return;if(d.innerHTML="",a&&(d.innerHTML+=`
                <div>
                    <h4 class="text-xs text-slate-400 uppercase font-bold mb-1 ml-1">Vista</h4>
                    <button id="kanban-individual-btn" class="kanban-control-item font-semibold py-2 px-4 rounded-lg text-sm border-2 border-slate-300 bg-white text-slate-700 hover:border-blue-400 transition-colors shadow-sm">Etiquetas Individuales</button>
                </div>
            `),y.length>0&&(d.innerHTML+=`
                <div>
                    <h4 class="text-xs text-slate-400 uppercase font-bold mb-1 ml-1">Funnels</h4>
                    <div class="kanban-control-item custom-select-wrapper rounded-lg border-2 border-slate-300 bg-white text-slate-700 shadow-sm transition-colors">
                        <select id="kanban-funnel-select" class="custom-select form-input text-sm font-semibold py-2 bg-transparent focus:outline-none">
                            <option value="" disabled>-- Seleccionar Funnel --</option>
                            ${y.map(m=>`<option value="${m}">${m}</option>`).join("")}
                        </select>
                        <i data-lucide="chevron-down" class="select-icon w-5 h-5 text-slate-500"></i>
                    </div>
                </div>
            `),d.innerHTML===""){document.getElementById("kanban-board").innerHTML='<div class="w-full text-center p-8"><p class="text-slate-500">Crea etiquetas o un funnel en "Etiquetas IA" para empezar a visualizar tus contactos.</p></div>';return}const w=document.getElementById("kanban-individual-btn");if(w)g(w),J("_individual_");else{const m=document.getElementById("kanban-funnel-select");m&&(g(m),J(m.value))}(c=document.getElementById("back-to-dashboard-btn"))==null||c.addEventListener("click",()=>{window.appInstance.switchPanel("dashboard")})}function J(y){var Q,B,M,F,z,X,ee;const a=document.getElementById("kanban-board");if(!a)return;const d=(Q=window.appInstance)==null?void 0:Q.teamInfo,w=d==null?void 0:d.user_role,c=(B=d==null?void 0:d.profiles)==null?void 0:B.full_name;let m=n;w==="advisor"&&c&&(m=n.filter(O=>(O.labels||[]).includes(c)));const T=(M=window.appInstance)==null?void 0:M.userPlan,P=((z=(F=window.appInstance)==null?void 0:F.teamInfo)==null?void 0:z.user_role)==="admin"&&((ee=(X=T==null?void 0:T.plans)==null?void 0:X.features)==null?void 0:ee.multi_user);let j;if(y==="_individual_"?j=e.filter(O=>!O.funnel_name).sort((O,ne)=>O.name.localeCompare(ne.name)):j=e.filter(O=>O.funnel_name===y).sort((O,ne)=>(O.funnel_order||0)-(ne.funnel_order||0)),j.length===0){a.innerHTML='<p class="text-slate-500 p-4">No hay etiquetas para mostrar en esta vista.</p>';return}a.innerHTML=j.map(O=>{const ne=r(O.color),K=m.filter(Z=>(Z.labels||[]).includes(O.name));return`
                <div class="kanban-column w-full sm:w-1/2 md:w-1/3 lg:w-1/4 xl:w-1/5 flex-shrink-0 p-2">
                    <div class="bg-slate-100 rounded-lg shadow-sm flex flex-col h-full">
                    <h3 class="font-bold text-slate-800 p-3 border-b-4 flex-shrink-0" style="border-color: ${ne};">${O.name} <span class="text-sm font-normal text-slate-500">${K.length}</span></h3>
                    <div class="kanban-cards p-3 space-y-3 flex-grow overflow-y-auto" data-label-id="${O.id}">
                        ${K.map(Z=>`
                            <div class="kanban-card bg-white p-3 rounded-md shadow-sm" data-contact-id="${Z.id}">
                                <div class="flex justify-between items-start relative">
                                    <p class="font-semibold text-sm">${Z.full_name||"Sin nombre"}</p>
                                    ${Z.razon_de_label_auto?`                                        
                                        <i data-lucide="info" class="w-4 h-4 text-blue-400 cursor-pointer hover:text-blue-600 z-20 group"></i>
                                        <div class="kanban-tooltip w-64 bg-slate-800 text-white text-xs rounded-lg py-2 px-3 z-50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                            ${Z.razon_de_label_auto}
                                            <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-slate-800"></div>
                                        </div>                                        
                                    `:'<i data-lucide="info" class="w-4 h-4 text-blue-400 cursor-pointer hover:text-blue-600 z-20"></i>'}
                                </div>
                                <p class="text-xs text-slate-500">${Z.phone_number}</p>
                                ${P?`
                                    <div class="mt-2 pt-2 border-t border-slate-100">
                                        <div class="custom-select-wrapper">
                                            <select class="assign-advisor-select custom-select form-input text-xs py-1" data-contact-id="${Z.id}">
                                                <option value="">Sin asignar</option>
                                                ${t.map(h=>{const _=h.profiles;return`<option value="${h.user_id}" ${Z.assigned_to_id===h.user_id?"selected":""}>
                                                        ${(_==null?void 0:_.full_name)||(_==null?void 0:_.email)||"Asesor sin nombre"}
                                                    </option>`}).join("")}
                                            </select>
                                            <i data-lucide="user-check" class="select-icon w-3 h-3 text-slate-400"></i>
                                        </div>
                                    </div>
                                `:""}
                            </div>
                        `).join("")||'<p class="text-xs text-slate-400 p-2">Sin contactos</p>'}
                    </div></div>
                </div>
            `}).join(""),window.Sortable&&te()}function te(){const y=document.getElementById("kanban-board");if(!y)return;const a=y.querySelectorAll(".kanban-cards");a.length>0&&a[0].sortable&&a.forEach(d=>d.sortable.destroy()),a.forEach(d=>{d.sortable=new Sortable(d,{group:"kanban",animation:150,onEnd:R,onMove:w=>{const c=w.dragged.dataset.contactId,m=w.to.dataset.labelId,T=n.find(j=>j.id==c),P=e.find(j=>j.id==m);return!T||!P?!1:!(T.labels||[]).includes(P.name)},ghostClass:"bg-blue-100",dragClass:"opacity-50"})})}async function R(y){const a=y.item.dataset.contactId,d=y.to.dataset.labelId,w=y.from.dataset.labelId;if(d===w)return;const c=e.find(T=>T.id==d),m=e.find(T=>T.id==w);if(!(!c||!m))try{const T=n.find(z=>z.id==a);if(!T)throw new Error("Contacto no encontrado en la caché.");const P=new Set(T.labels||[]);P.delete(m.name),P.add(c.name);const j=Array.from(P),{error:Q}=await window.auth.sb.from("contacts").update({labels:j}).eq("id",a);if(Q)throw Q;window.showToast(`Contacto movido a "${c.name}"`,"success"),T.labels=j;const B=document.getElementById("kanban-funnel-select"),M=document.getElementById("kanban-individual-btn");let F="_individual_";B&&B.closest(".kanban-control").classList.contains("ring-blue-300")&&(F=B.value),J(F)}catch(T){console.error("Error al mover la tarjeta:",T),window.showToast("Error al actualizar el contacto.","error"),y.from.appendChild(y.item)}}async function W(y,a){const d=a||null;try{const{error:w}=await window.auth.sb.from("contacts").update({assigned_to_id:d}).eq("id",y);if(w)throw w;window.showToast("Contacto asignado correctamente.","success")}catch(w){console.error("Error al asignar el contacto:",w),window.showToast("No se pudo asignar el contacto.","error")}}function q(y){const a=n.find(c=>c.id==y);if(!a)return;const d=document.getElementById("contact-info-modal"),w=document.getElementById("contact-info-modal-body");!d||!w||(w.innerHTML=`
            <div>
                <p class="text-lg font-bold">${a.full_name||"Sin nombre"}</p>
                <p class="text-sm text-slate-500">${a.phone_number}</p>
            </div>
            <div class="border-t pt-4">
                <h5 class="font-semibold mb-2">Etiquetas</h5>
                <div class="flex flex-wrap gap-2">
                    ${(a.labels||[]).filter(c=>c!=="ignorar").map(c=>{const m=e.find(j=>j.name===c),T=m?r(m.color):"#A0AEC0",P=f(T);return`<span class="text-xs font-semibold px-2.5 py-0.5 rounded-full" style="background-color: ${T}; color: ${P};">${c}</span>`}).join("")||'<span class="text-xs text-slate-400">Sin etiquetas</span>'}
                </div>
            </div>
            <div class="border-t pt-4">
                <h5 class="font-semibold mb-2">Información de IA</h5>
                <div class="flex flex-wrap gap-2">
                    ${a.razon_de_label_auto?`
                        <p class="text-sm bg-blue-50 p-3 rounded-md text-slate-700">${a.razon_de_label_auto}</p>
                    `:`
                        <p class="text-xs text-slate-400">No hay información de IA para este contacto.</p>
                    `}
                </div>
            </div>
        `,document.getElementById("contact-info-modal-labels-btn").onclick=()=>{k(),window.contacts.openLabelsModalForSingleContact(y)},document.getElementById("contact-info-modal-chat-btn").onclick=()=>{k(),window.appInstance.switchPanel("chats",{contactId:a.id})},d.classList.remove("hidden"),document.getElementById("close-contact-info-modal-btn").onclick=k,lucide.createIcons())}function H(y){const a=y.target.closest(".kanban-card");if(!a)return;const d=a.querySelector(".kanban-tooltip");if(!d)return;const w=document.getElementById("kanban-board");if(!w)return;const c=a.getBoundingClientRect(),m=w.getBoundingClientRect(),T=d.offsetHeight;c.top-m.top>T+10?(d.style.bottom="100%",d.style.top="auto"):(d.style.top="100%",d.style.bottom="auto")}function k(){document.getElementById("contact-info-modal").classList.add("hidden")}const b=["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#FF5722","#795548","#9E9E9E","#607D8B","#FFFFFF"];function r(y){if(typeof y=="string"&&y.startsWith("#"))return y;const a=parseInt(y,10);return!isNaN(a)&&a>=0&&a<b.length?b[a]:"#A0AEC0"}function f(y){if(!y||!y.startsWith("#"))return"#1e293b";const a=y.substring(1,7),d=parseInt(a.substring(0,2),16),w=parseInt(a.substring(2,4),16),c=parseInt(a.substring(4,6),16);return(.299*d+.587*w+.114*c)/255>.5?"#1e293b":"#ffffff"}function p(){var a,d;if(o)return;const y=(d=(a=window.auth.getSession())==null?void 0:a.user)==null?void 0:d.id;y&&(o=window.auth.sb.channel("public:contacts").on("postgres_changes",{event:"UPDATE",schema:"public",table:"contacts",filter:`user_id=eq.${y}`},w=>{const c=w.new,m=n.findIndex(j=>j.id===c.id);m!==-1?n[m]={...n[m],...c}:n.push(c),document.querySelector(".kanban-view-btn.bg-blue-600");const T=document.getElementById("kanban-funnel-select");let P="_individual_";T&&T.classList.contains("bg-blue-600")&&(P=T.value),J(P),window.showToast("El tablero se ha actualizado automáticamente.","info")}).subscribe())}function C(){o&&(window.auth.sb.removeChannel(o),o=null)}})();(function(){let ae=!1,e=[],t="";document.addEventListener("panel:activated",({detail:a})=>{a.panelId==="products"&&!ae&&(n(),ae=!0)});function n(){console.log("Inicializando panel de Productos..."),ae=!0,o(),i()}function o(){var a,d,w,c,m,T,P;(a=document.getElementById("download-template-btn"))==null||a.addEventListener("click",W),(d=document.getElementById("export-products-btn"))==null||d.addEventListener("click",R),(w=document.getElementById("import-csv-input"))==null||w.addEventListener("change",q),(c=document.getElementById("add-product-btn"))==null||c.addEventListener("click",p),(m=document.getElementById("cancel-product-btn"))==null||m.addEventListener("click",f),(T=document.getElementById("product-form"))==null||T.addEventListener("submit",y),(P=document.getElementById("products-table-body"))==null||P.addEventListener("click",j=>{j.target.closest(".edit-product-btn")&&C(j.target.closest(".edit-product-btn").dataset.id),j.target.closest(".delete-product-btn")&&s(j.target.closest(".delete-product-btn").dataset.id)}),document.querySelectorAll('[data-role="products-search"]').forEach(j=>{j.addEventListener("input",x)})}async function s(a){if(a&&confirm("¿Eliminar este producto de forma permanente?"))try{const{error:d}=await window.auth.sb.from("products").delete().eq("id",a);if(d)throw d;e=e.filter(w=>w.id!==a),v(),i()}catch(d){console.error("Error al eliminar el producto:",d);const w=(d==null?void 0:d.message)||"No se pudo eliminar el producto.";window.showToast?window.showToast(`Error: ${w}`,"error"):alert(w)}}async function i(){const a=document.getElementById("products-loader"),d=document.getElementById("products-table-body");if(!(!a||!d)){a.textContent="Cargando productos...",a.style.display="block",d.innerHTML="";try{const{data:w,error:c}=await window.auth.sb.from("products").select("*").order("product_name");if(c)throw c;e=Array.isArray(w)?w:[],v()}catch(w){console.error("Error al cargar productos:",w),a.textContent="No se pudieron cargar los productos. Intenta nuevamente.",a.style.display="block",window.showToast&&window.showToast("No se pudieron cargar los productos. Intenta nuevamente.","error"),H(e.length,e.length)}}}function v(){const a=document.getElementById("products-loader"),d=document.getElementById("products-table-body");if(!a||!d)return;const w=e.length,c=L(e,t);if(w===0){d.innerHTML="",a.textContent="No tienes productos. Importa un archivo CSV para empezar.",a.style.display="block",H(0,0);return}if(c.length===0){d.innerHTML="",a.textContent=t?"No se encontraron productos que coincidan con la búsqueda.":"No tienes productos. Importa un archivo CSV para empezar.",a.style.display="block",H(0,w);return}a.style.display="none",d.innerHTML=c.map(m=>`
            <tr>
                <td class="p-4 font-medium">${m.product_name}</td>
                <td class="p-4 text-slate-600">${m.sku||"-"}</td>
                <td class="p-4 text-slate-600">${J(m.price)}</td>
                <td class="p-4 text-slate-600">${te(m.stock)}</td>
                <td class="p-4">${m.media_url?`<a href="${m.media_url}" target="_blank" class="text-blue-500 hover:underline">Ver Media</a>`:"-"}</td>
                <td class="p-4">
                    <div class="flex gap-2">
                        <button class="edit-product-btn p-2 hover:bg-slate-200 rounded-md" data-id="${m.id}" title="Editar"><i data-lucide="edit" class="w-4 h-4 text-slate-600 pointer-events-none"></i></button>
                        <button class="delete-product-btn p-2 hover:bg-red-100 rounded-md" data-id="${m.id}" title="Eliminar"><i data-lucide="trash-2" class="w-4 h-4 text-red-500 pointer-events-none"></i></button>
                    </div>
                </td>
            </tr>
        `).join(""),H(c.length,w),typeof(lucide==null?void 0:lucide.createIcons)=="function"&&lucide.createIcons()}function x(a){t=a.target.value||"",g(a.target),e.length&&v()}function g(a){document.querySelectorAll('[data-role="products-search"]').forEach(d=>{d!==a&&(d.value=t)})}function L(a,d){if(!Array.isArray(a))return[];const w=(d||"").toString().trim().toLowerCase();if(!w)return a;const m=w.replace(/[^\d.,-]/g,"").replace(",",".");return a.filter(T=>{const P=(T.product_name||"").toLowerCase().includes(w),j=(T.sku||"").toLowerCase().includes(w);let Q=!1;if(T.price!==null&&T.price!==void 0&&T.price!==""){const B=Number(T.price),M=String(T.price).toLowerCase(),F=Number.isFinite(B)?B.toFixed(2):"",z=Number.isFinite(B)?B.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2}).toLowerCase():"";Q=M.includes(w)||F.toLowerCase().includes(w)||F.replace(".",",").includes(w)||z.includes(w),!Q&&m&&(Q=F.includes(m)||M.includes(m)||z.replace(/[^\d.-]/g,"").includes(m.replace(/[^\d.-]/g,"")))}return P||j||Q})}function J(a){const d=Number(a);return Number.isFinite(d)?"$"+d.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2}):"$0.00"}function te(a){if(a===-1)return"Infinita";const d=Number(a);return Number.isFinite(d)?d.toLocaleString("es-MX"):"0"}function R(){if(e.length===0){alert("No hay productos para exportar.");return}const a="product_name,description,price,media_url,stock,sku",d=e.map(m=>{const T=window.escapeCsvValue(m.description||"");return[m.product_name,T,m.price,m.media_url,m.stock,m.sku].join(",")}),w=`data:text/csv;charset=utf-8,${a}
${d.join(`
`)}`,c=document.createElement("a");c.setAttribute("href",encodeURI(w)),c.setAttribute("download","mis_productos.csv"),c.click()}function W(){const a=["nombre_producto","descripcion","precio","media_url","stock","sku"],d=[["Suero hidratante","Suero facial con ácido hialurónico para uso diario.","349.90","https://ejemplo.com/imagenes/suero.jpg","120","SKU-SERUM-01"],["Crema corporal","Crema nutritiva de rápida absorción.","189.50","","-1","SKU-CREMA-02"]],c=`data:text/csv;charset=utf-8,${[a.join(","),...d.map(P=>P.map(window.escapeCsvValue).join(","))].join(`
`)}`,m=encodeURI(c),T=document.createElement("a");T.setAttribute("href",m),T.setAttribute("download","plantilla_productos.csv"),document.body.appendChild(T),T.click(),document.body.removeChild(T)}async function q(a){var c,m,T,P,j,Q,B,M;const d=a.target.files[0];if(!d)return;let w=null;try{const F=await window.convertFileToCsvText(d),z=window.splitCsvLines(F);if(!z.length){(c=window.showToast)==null||c.call(window,"El archivo de productos está vacío.","info");return}const X=window.parseCsvRow(z[0]).map(K=>K.trim());if(!X.length){(m=window.showToast)==null||m.call(window,"No se pudieron detectar las columnas del archivo.","error");return}if(w=await window.openColumnMappingModal(b,X),!w)return;const ee=z.slice(1),O=[],ne=new Map;for(const K of ee){const Z=window.parseCsvRow(K).map(_=>(_==null?void 0:_.trim())??""),h=window.getColumnValue(Z,w.sku);h&&ne.set(h,Z)}for(const[,K]of ne){const Z=window.getColumnValue(K,w.product_name),h=window.getColumnValue(K,w.sku);if(!Z||!h)continue;const _={product_name:Z,sku:h},A=getColumnValue(K,w.description);A&&(_.description=A.replace(/^"|"$/g,"").replace(/""/g,'"'));const E=window.getColumnValue(K,w.price);if(E){const me=k(E),de=Number(me);Number.isFinite(de)&&(_.price=de)}const G=window.getColumnValue(K,w.media_url);G&&(_.media_url=G);const re=window.getColumnValue(K,w.stock);if(re){const me=re.replace(/[^\d-]/g,""),de=parseInt(me,10);Number.isNaN(de)||(_.stock=de===-1?-1:de)}O.push(_)}if(O.length===0){(T=window.showToast)==null||T.call(window,"El archivo CSV está vacío o no tiene el formato correcto.","info");return}try{const K=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),Z=K?K.id:(j=(P=window.auth.getSession())==null?void 0:P.user)==null?void 0:j.id;if(!Z)throw new Error("No se pudo determinar el usuario destino para la importación.");const h=O.map(A=>({...A,user_id:Z})),{error:_}=await window.auth.sb.from("products").upsert(h,{onConflict:"user_id,sku"});if(_)throw _;(Q=window.showToast)==null||Q.call(window,`${h.length} productos importados/actualizados con éxito.`,"success"),i()}catch(K){console.error("Error al importar CSV:",K),(B=window.showToast)==null||B.call(window,`Error al importar: ${K.message}`,"error")}}catch(F){console.error("Error general en la importación:",F),(M=window.showToast)==null||M.call(window,`Error general en la importación: ${F.message}`,"error")}finally{a.target.value=""}}function H(a,d=a){const w=Number(a),c=Number(d),m=Number.isFinite(w)?Math.max(0,Math.trunc(w)):0,T=Number.isFinite(c)?Math.max(0,Math.trunc(c)):0,P=m===1?"producto":"productos",j=m.toLocaleString("es-MX"),Q=T.toLocaleString("es-MX"),B=document.getElementById("products-count");B&&(B.textContent=m===T?`${j} ${P}`:`${j} ${P} (de ${Q})`);const M=document.getElementById("products-count-overview");M&&(M.textContent=Q)}function k(a){if(!a)return a;const d=a.replace(/[^\d.,-]/g,"").trim();if(!d)return d;const w=d.includes(","),c=d.includes(".");return w&&c?d.lastIndexOf(".")>d.lastIndexOf(",")?d.replace(/,/g,""):d.replace(/\./g,"").replace(",","."):w?d.replace(",","."):d}const b=[{field:"product_name",label:"Nombre del producto",required:!0,aliases:["product_name","nombre","name","titulo","title"]},{field:"description",label:"Descripción",required:!1,aliases:["description","descripcion","detalle","detalle_producto"]},{field:"price",label:"Precio",required:!1,aliases:["price","precio","pricing","costo","valor"]},{field:"media_url",label:"URL de imagen o media",required:!1,aliases:["media_url","imagen","url_imagen","link","link_media"]},{field:"stock",label:"Disponibilidad (stock)",required:!1,aliases:["stock","inventario","cantidad","existencias"]},{field:"sku",label:"SKU",required:!0,aliases:["sku","codigo","referencia","id_producto"]}];function r(a){const d=document.getElementById("new-product-modal"),w=document.getElementById("product-form");if(!(!d||!w)){if(w.reset(),document.getElementById("product-id").value=(a==null?void 0:a.id)||"",document.getElementById("product-modal-title").textContent=a?"Editar Producto":"Añadir Nuevo Producto",a){document.getElementById("product-name").value=a.product_name||"",document.getElementById("product-description").value=a.description||"",document.getElementById("product-sku").value=a.sku||"",document.getElementById("product-price").value=a.price||0,document.getElementById("product-infinite-stock").checked=a.stock===-1;const c=document.getElementById("product-stock");c&&(c.value=a.stock===-1?0:a.stock||0,c.disabled=a.stock===-1);const m=document.getElementById("product-image-preview");m&&a.media_url?(m.src=a.media_url,m.classList.remove("hidden")):m&&m.classList.add("hidden")}else{const c=document.getElementById("product-image-preview");c&&c.classList.add("hidden");const m=document.getElementById("product-stock");m&&(m.disabled=!1)}d.classList.remove("hidden")}}function f(){document.getElementById("new-product-modal").classList.add("hidden")}function p(){r(null)}function C(a){const d=e.find(w=>w.id==a);d&&r(d)}async function y(a){var w,c;a.preventDefault();const d=document.getElementById("save-new-product-btn");d.disabled=!0,d.textContent="Guardando...";try{let m=null;const T=document.getElementById("product-media-file").files[0];if(T){const ee=["image/jpeg","image/png","image/webp","image/gif"];if(T.size>5242880)throw new Error("El archivo es demasiado grande. El tamaño máximo permitido es de 5 MB.");if(!ee.includes(T.type))throw new Error("Formato de archivo no válido. Solo se permiten imágenes (JPG, PNG, WEBP, GIF).")}if(T&&(m=await window.appInstance.uploadAsset(T,"products"),!m))throw new Error("La subida del archivo al servidor final falló. Revisa la consola para más detalles.");const P=document.getElementById("product-infinite-stock").checked,j=document.getElementById("product-id").value,Q=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),B=(Q==null?void 0:Q.id)||((c=(w=window.auth.getSession())==null?void 0:w.user)==null?void 0:c.id),M={product_name:document.getElementById("product-name").value,description:document.getElementById("product-description").value,sku:document.getElementById("product-sku").value,price:parseFloat(document.getElementById("product-price").value),stock:P?-1:parseInt(document.getElementById("product-stock").value)};j||(M.user_id=B),m&&(M.media_url=m);const F=j?window.auth.sb.from("products").update(M).eq("id",j):window.auth.sb.from("products").insert(M),{error:z}=await F;if(z)throw z;alert(`¡Producto ${j?"actualizado":"guardado"} con éxito!`),f(),i()}catch(m){console.error("Error al guardar el producto:",m),window.showToast?window.showToast(`Error: ${m.message}`,"error"):alert(`No se pudo guardar el producto: ${m.message}`)}finally{d.disabled=!1,d.textContent="Guardar Producto"}}})();(function(){let ae=!1,e=null;document.addEventListener("panel:activated",({detail:b})=>{b.panelId==="settings"&&(ae||t())}),document.addEventListener("panel:loaded",({detail:b})=>{b.panelId==="settings"&&!ae&&t()});function t(){console.log("Inicializando panel de Configuración..."),ae=!0,e=window.auth.sb,o(),s()}async function n(){var p,C,y,a,d;const b=JSON.parse(localStorage.getItem("impersonated_user_info")||"null");if(b!=null&&b.id)return b.id;const r=(C=(p=window.appInstance)==null?void 0:p.user)==null?void 0:C.id;if(r)return r;const f=(a=(y=window.auth.getSession())==null?void 0:y.user)==null?void 0:a.id;if(f)return f;try{const{data:w,error:c}=await window.auth.sb.auth.getSession();if(c)return console.error("[Settings] Error al obtener la sesión activa desde Supabase:",c),null;if(w!=null&&w.session)return window.auth.session=w.session,((d=w.session.user)==null?void 0:d.id)||null}catch(w){console.error("[Settings] Error inesperado al resolver el usuario activo:",w)}return null}function o(){var f,p,C,y,a,d,w;(f=document.getElementById("settings-form"))==null||f.addEventListener("submit",i),(p=document.getElementById("settings-save-safe-btn"))==null||p.addEventListener("click",v),(C=document.getElementById("upload-logo-btn"))==null||C.addEventListener("click",()=>document.getElementById("logo-input").click()),(y=document.getElementById("logo-input"))==null||y.addEventListener("change",c=>R(c.target.files[0]));const b=document.getElementById("reference-image-input");b==null||b.addEventListener("change",c=>W(c.target.files)),(a=document.getElementById("add-ref-image-slot"))==null||a.addEventListener("click",()=>b.click());const r=document.getElementById("reference-images-container");r==null||r.addEventListener("click",c=>{c.target.closest(".delete-ref-image-btn")?H(c.target.closest(".delete-ref-image-btn")):c.target.closest("#add-ref-image-slot")||c.target.closest(".ref-image-item")||r.querySelectorAll(".ref-image-item").length<3&&b.click()}),(d=document.getElementById("invite-member-form"))==null||d.addEventListener("submit",c=>{c.preventDefault(),J()}),(w=document.getElementById("team-members-list"))==null||w.addEventListener("change",c=>{c.target.classList.contains("permission-toggle")&&te(c.target)})}async function s(){var b,r,f,p;try{const C=await n();if(!C)throw new Error("No se pudo determinar el usuario para cargar la configuracion.");const{data:y,error:a}=await e.from("profiles").select("work_start_hour, work_end_hour, company_description, website, social_media, branding_settings, contact_phone").eq("id",C).single();if(a&&a.code!=="PGRST116")throw a;if(!y)return;y.work_start_hour&&(document.getElementById("work-start-hour").value=`${String(y.work_start_hour).padStart(2,"0")}:00`),y.work_end_hour&&(document.getElementById("work-end-hour").value=`${String(y.work_end_hour).padStart(2,"0")}:00`),y.company_description&&(document.getElementById("company-description").value=y.company_description),y.website&&(document.getElementById("website").value=y.website),y.social_media&&(document.getElementById("social-instagram").value=y.social_media.instagram||"",document.getElementById("social-facebook").value=y.social_media.facebook||"");const d=document.getElementById("admin-phone-input");d&&y.contact_phone&&(d.value=y.contact_phone),(b=y.branding_settings)!=null&&b.logo_url&&(document.getElementById("logo-preview").src=y.branding_settings.logo_url),(r=y.branding_settings)!=null&&r.colors&&y.branding_settings.colors.forEach((c,m)=>document.getElementById(`brand-color-${m+1}`).value=c),(f=y.branding_settings)!=null&&f.reference_images&&q(y.branding_settings.reference_images);const w=(p=window.appInstance)==null?void 0:p.teamInfo;await g(w)}catch(C){console.error("Error al cargar la configuración de la empresa:",C)}}async function i(b){b.preventDefault();const r=b.target,f=r.querySelector("button[data-settings-primary]")||r.querySelector('button[type="submit"]');await x(f)}async function v(b){b.preventDefault();const r=b.currentTarget;console.log('[Settings] Boton "Guardar Seguro" presionado.'),await x(r,{toastMessage:"Guardando configuracion (modo seguro)..."})}async function x(b,r={}){var d,w;const f=document.getElementById("settings-form");if(!f){console.warn("[Settings] No se encontro el formulario de configuracion.");return}const p=b||f.querySelector('button[type="submit"]');if(!p){console.warn("[Settings] No se encontro el boton de guardado.");return}const{loadingLabel:C="Guardando...",restoreLabel:y=p.dataset.originalLabel||p.textContent||"Guardar Configuracion",toastMessage:a="Guardando configuracion..."}=r;window.showToast(a,"info",2e3),p.dataset.originalLabel=y,p.disabled=!0,p.textContent=C;try{console.log("[Settings] Iniciando guardado...");const c=document.getElementById("logo-input").files[0];let m=document.getElementById("logo-preview").src.startsWith("https")?document.getElementById("logo-preview").src:null;if(c){if(!window.appInstance)throw new Error("La instancia de la aplicacion no esta lista.");m=await window.appInstance.uploadAsset(c,"logos")}console.log("[Settings] URL del logo:",m);const T=Array.from(document.querySelectorAll("#reference-images-container .ref-image-item img")).map(Z=>Z.src.split("?")[0]),P=document.getElementById("reference-image-input").files,j=Array.from(P).map(Z=>window.appInstance.uploadAsset(Z,"reference_images")),Q=await Promise.all(j),B=[...T,...Q.filter(Boolean)];console.log("[Settings] URLs de referencia:",B);const M={logo_url:m,colors:Array.from({length:4},(Z,h)=>document.getElementById(`brand-color-${h+1}`).value),font:document.getElementById("brand-font").value,reference_images:B.slice(0,3)};console.log("[Settings] Datos de branding:",M);const F=document.getElementById("work-start-hour").value,z=document.getElementById("work-end-hour").value,X=((d=document.getElementById("admin-phone-input"))==null?void 0:d.value.trim())||null,ee={work_start_hour:F?parseInt(F.split(":")[0],10):null,work_end_hour:z?parseInt(z.split(":")[0],10):null,company_description:document.getElementById("company-description").value,website:document.getElementById("website").value,social_media:{instagram:document.getElementById("social-instagram").value,facebook:document.getElementById("social-facebook").value},branding_settings:M,contact_phone:X};console.log("[Settings] Datos a guardar:",ee);const O=await n();if(!O)throw console.error("[Settings] Error: no se pudo determinar el usuario objetivo."),new Error("No se pudo determinar el usuario objetivo para guardar la configuracion.");const{error:ne}=await e.from("profiles").update(ee).eq("id",O);if(ne)throw console.error("[Settings] Error de Supabase al guardar:",ne),new Error(ne.message);const K=(w=window.appInstance)==null?void 0:w.teamInfo;if(K&&K.user_role==="admin"){const Z=document.getElementById("see-all-chats-toggle").checked,_=document.getElementById("ignore-labels-input").value.split(",").map(E=>E.trim()).filter(E=>E),{error:A}=await e.from("teams").update({allow_all_chats_visibility:Z,ignored_labels:_}).eq("id",K.team_id);A&&console.error("[Settings] Error al guardar la configuración del equipo:",A)}console.log("[Settings] Guardado con exito."),window.showToast("Configuracion guardada con exito.","success")}catch(c){console.error("Error al guardar la configuracion:",c),window.showToast("No se pudo guardar la configuracion.","error")}finally{p.disabled=!1,p.textContent=y}}async function g(b){var a,d,w;const r=document.getElementById("team-management-panel");if(!r)return;let f=!1;if((b==null?void 0:b.user_role)==="admin"){const c=await((a=window.appInstance)==null?void 0:a.loadUserSubscription());(w=(d=c==null?void 0:c.plans)==null?void 0:d.features)!=null&&w.multi_user&&(f=!0)}if(!f){r.classList.add("hidden");return}r.classList.remove("hidden");const p=document.getElementById("team-members-list");if(!p)return;const{data:C,error:y}=await window.auth.sb.from("team_members").select("user_id, role, permissions, profiles:user_id(full_name, email)").eq("team_id",b.team_id);if(y){console.error("Error al cargar miembros del equipo:",y),p.innerHTML='<p class="text-red-500">Error al cargar miembros.</p>';return}C.length>0?p.innerHTML=C.map(c=>{var m,T;return`
                <div class="bg-white p-4 rounded-lg border">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${((m=c.profiles)==null?void 0:m.full_name)||((T=c.profiles)==null?void 0:T.email)}</p>
                            <span class="text-xs font-medium px-2 py-0.5 rounded-full ${c.role==="admin"?"bg-purple-100 text-purple-700":"bg-blue-100 text-blue-700"}">${c.role}</span>
                        </div>
                        ${c.role==="advisor"?`
                            <button class="text-xs text-slate-500 hover:underline" onclick="this.nextElementSibling.classList.toggle('hidden')">Permisos</button>
                        `:""}
                    </div>
                    ${c.role==="advisor"?`
                        <div class="hidden mt-4 pt-4 border-t border-slate-100 space-y-2">
                            <h5 class="text-sm font-semibold text-slate-600">Acceso a Paneles:</h5>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2">
                                ${L(c,"follow-ups","Seguimientos")}
                                ${L(c,"bulk-sending","Envío Masivo")}
                                ${L(c,"contacts","Contactos")}
                                ${L(c,"templates","Plantillas")}
                                ${L(c,"products","Productos")}
                                ${L(c,"designer-ai","Diseñador IA")}
                            </div>
                        </div>
                    `:""}
                </div>
            `}).join(""):p.innerHTML='<p class="text-slate-500 text-center p-4 text-sm">Aún no has invitado a nadie a tu equipo.</p>'}function L(b,r,f){var C;const p=((C=b.permissions)==null?void 0:C[r])||!1;return`
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" class="permission-toggle form-checkbox h-4 w-4 rounded text-blue-600" data-member-id="${b.user_id}" data-panel-id="${r}" ${p?"checked":""}>
                <span class="text-sm text-slate-700">${f}</span>
            </label>
        `}async function J(){const b=document.getElementById("invite-member-form"),r=document.getElementById("invite-email"),f=b.querySelector("button"),p=r.value.trim();if(!(!p||!(teamInfo!=null&&teamInfo.team_id))){f.disabled=!0,f.textContent="Enviando...";try{const{error:C}=await window.auth.sb.functions.invoke("invite-team-member",{body:{teamId:teamInfo.team_id,inviteeEmail:p,role:"advisor"}});if(C)throw new Error(C.message);window.showToast(`Invitación enviada a ${p}.`,"success"),r.value=""}catch(C){console.error("Error al invitar miembro:",C),window.showToast(C.message,"error")}finally{f.disabled=!1,f.textContent="Invitar"}}}async function te(b){const r=b.dataset.memberId,f=b.dataset.panelId,p=b.checked;if(!(!r||!f))try{const{data:C,error:y}=await e.from("team_members").select("permissions").eq("user_id",r).eq("team_id",teamInfo.team_id).single();if(y)throw y;const a=C.permissions||{};a[f]=p;const{error:d}=await e.from("team_members").update({permissions:a}).eq("user_id",r).eq("team_id",teamInfo.team_id);if(d)throw d}catch(C){console.error("Error al actualizar permisos:",C),window.showToast("No se pudo actualizar el permiso.","error"),b.checked=!p}}function R(b){if(!b)return;const r=document.getElementById("logo-preview"),f=new FileReader;f.onload=p=>{r.src=p.target.result},f.readAsDataURL(b)}async function W(b){const r=document.getElementById("reference-images-container");if(r){for(const f of b){if(r.querySelectorAll(".ref-image-item").length>=3){alert("Puedes subir un máximo de 3 imágenes de referencia.");break}if(!window.appInstance)throw new Error("La instancia de la aplicación no está lista.");const p=await window.appInstance.uploadAsset(f,"reference_images");p&&(document.getElementById("add-ref-image-slot").insertAdjacentHTML("beforebegin",k(p)),lucide.createIcons())}document.getElementById("reference-image-input").value="",r.querySelectorAll(".ref-image-item").length>=3&&(document.getElementById("add-ref-image-slot").style.display="none")}}function q(b){const r=document.getElementById("reference-images-container"),f=document.getElementById("add-ref-image-slot");r&&(r.querySelectorAll(".ref-image-item").forEach(p=>p.remove()),(b||[]).forEach(p=>{f.insertAdjacentHTML("beforebegin",k(p))}),f.style.display=(b||[]).length>=3?"none":"flex",lucide.createIcons(),lucide.createIcons())}function H(b){const r=b.closest(".ref-image-item");if(r){r.remove();const f=document.getElementById("add-ref-image-slot");f&&(f.style.display="flex")}}function k(b){return`<div class="ref-image-item relative group aspect-square bg-slate-100 rounded-lg"><img src="${b}" class="w-full h-full object-cover rounded-lg"><button type="button" class="delete-ref-image-btn absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="x" class="w-3 h-3 pointer-events-none"></i></button></div>`}})();(function(){const ae=["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#FF5722","#795548","#9E9E9E","#607D8B","#FFFFFF"];function e(r){if(typeof r=="string"&&r.startsWith("#"))return r;const f=parseInt(r,10);return!isNaN(f)&&f>=0&&f<ae.length?ae[f]:"#A0AEC0"}let t=!1,n=[];document.addEventListener("panel:activated",({detail:r})=>{r.panelId==="smart-labels"&&!t&&o()});function o(){console.log("Inicializando panel de Etiquetas Inteligentes..."),t=!0,s()}function s(){if(document.getElementById("smart-label-modal")){i(),v();return}const f=new MutationObserver(()=>{document.getElementById("smart-label-modal")&&(f.disconnect(),i(),v())});f.observe(document.body,{childList:!0,subtree:!0})}function i(){var p,C,y,a,d,w,c,m,T;const r=document.getElementById("smart-label-modal");if(!r)return;(p=r.querySelector("#cancel-smart-label-btn"))==null||p.addEventListener("click",R),(C=r.querySelector("#cancel-smart-label-btn-footer"))==null||C.addEventListener("click",R),(y=r.querySelector("#smart-label-form"))==null||y.addEventListener("submit",k),(a=r.querySelector("#delete-smart-label-btn"))==null||a.addEventListener("click",b),(d=document.getElementById("smart-label-is-automated"))==null||d.addEventListener("change",P=>{document.getElementById("ai-fields-container").classList.toggle("hidden",!P.target.checked)}),(w=document.getElementById("smart-label-ai-enhance-btn"))==null||w.addEventListener("click",P=>{P.preventDefault();const j=document.getElementById("smart-label-prompt");j.value&&window.appInstance.openAiEnhanceModal(j.value,Q=>j.value=Q)}),(c=document.getElementById("smart-label-select"))==null||c.addEventListener("change",P=>{const j=P.target.value==="_new_";document.getElementById("new-label-fields-container").classList.toggle("hidden",!j),document.getElementById("smart-label-name").required=j}),(m=document.getElementById("add-smart-label-btn"))==null||m.addEventListener("click",()=>te(null)),(T=document.getElementById("smart-labels-content"))==null||T.addEventListener("click",P=>{if(P.target.closest(".edit-smart-label-btn")){const j=P.target.closest(".edit-smart-label-btn").dataset.id,Q=n.find(B=>B.id.toString()===j);Q&&te(Q)}});const f=document.getElementById("smart-label-enable-funnel");f&&(f.addEventListener("change",P=>W(P.target.checked)),W(f.checked))}async function v(){const r=document.getElementById("smart-labels-loader"),f=document.getElementById("smart-labels-content");r.classList.remove("hidden"),f.classList.add("hidden");try{const{data:p,error:C}=await window.auth.sb.from("labels").select("*");if(C)throw C;const y=new Map;for(const a of p||[]){if(!a.name)continue;const d=y.get(a.name);(!d||!d.prompt&&a.prompt||!d.funnel_name&&a.funnel_name)&&y.set(a.name,a)}n=Array.from(y.values()),x(),g(),L(),r.classList.add("hidden"),f.classList.remove("hidden")}catch(p){console.error("Error al cargar etiquetas:",p),r.textContent="Error al cargar las etiquetas."}}function x(){const r=document.getElementById("funnels-container"),f=n.reduce((p,C)=>(C.funnel_name&&(p[C.funnel_name]||(p[C.funnel_name]=[]),p[C.funnel_name].push(C)),p),{});if(Object.keys(f).length===0){r.innerHTML='<p class="text-slate-500">No se han configurado funnels de etiquetas.</p>';return}r.innerHTML=Object.entries(f).map(([p,C])=>(C.sort((y,a)=>(y.funnel_order||0)-(a.funnel_order||0)),`
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h4 class="text-lg font-bold text-slate-900 mb-4">${p}</h4>
                    <div class="flex items-center space-x-2 overflow-x-auto pb-4">
                        ${C.map((y,a)=>`
                            ${a>0?'<i data-lucide="chevron-right" class="text-slate-400 flex-shrink-0"></i>':""}
                            <div class="flex-shrink-0 w-64">
                                ${J(y)}
                            </div>
                        `).join("")}
                    </div>
                </div>
            `)).join(""),lucide.createIcons()}function g(){const r=document.getElementById("individual-labels-container"),f=n.filter(p=>!p.funnel_name);if(f.length===0){r.innerHTML='<p class="text-slate-500 text-sm">No hay etiquetas individuales.</p>';return}r.innerHTML=f.map(p=>J(p)).join(""),lucide.createIcons()}function L(){const r=document.getElementById("funnel-names-list");if(!r)return;const f=new Set(n.map(p=>p.funnel_name).filter(Boolean));r.innerHTML=Array.from(f).map(p=>`<option value="${p}"></option>`).join("")}function J(r){var w,c;const f=r.is_automated?"bg-green-100 text-green-800":"bg-slate-100 text-slate-500",p=r.is_automated?"Automática":"Manual",a=(((c=(w=window.appInstance)==null?void 0:w.teamInfo)==null?void 0:c.ignored_labels)||[]).includes(r.name)?'<span class="text-[10px] font-semibold uppercase tracking-wide px-2 py-0.5 rounded-full bg-red-100 text-red-700">Ignorar IA</span>':"";return`
            <div class="border border-slate-200 rounded-lg p-4 space-y-3">
                <div class="flex justify-between items-start gap-3">
                    <h5 class="font-bold" style="color: ${e(r.color)}">${r.name}</h5>
                    <div class="flex flex-col items-end gap-1">
                        <span class="text-xs font-medium px-2 py-0.5 rounded-full ${f}">${p}</span>
                        ${a}
                    </div>
                </div>
                <p class="text-sm text-slate-600 h-16 overflow-y-auto">
                    <strong>Instrucción:</strong> ${r.prompt||"<em>No definida</em>"}
                </p>
                <button class="edit-smart-label-btn text-xs text-blue-600 hover:underline font-semibold flex items-center gap-1" data-id="${r.id}">
                    <i data-lucide="edit-2" class="w-3 h-3 pointer-events-none"></i> Editar
                </button>
            </div>
        `}async function te(r){var w;const f=document.getElementById("smart-label-modal");document.getElementById("smart-label-form").reset(),document.getElementById("ai-fields-container").classList.add("hidden"),document.getElementById("new-label-fields-container").classList.add("hidden"),document.getElementById("smart-label-name").required=!1;const C=document.getElementById("label-selector-container"),y=document.getElementById("smart-label-select"),a=document.getElementById("smart-label-enable-funnel");if(r){C.classList.remove("hidden"),document.getElementById("new-label-fields-container").classList.add("hidden"),document.getElementById("smart-label-name").required=!1,document.getElementById("smart-label-modal-title").textContent="Editar automatización",document.getElementById("smart-label-id").value=r.id;const{data:c,error:m}=await window.auth.sb.from("labels").select("id, name").or(`prompt.is.null,id.eq.${r.id}`);if(m)console.error("Error cargando etiquetas disponibles:",m),y.innerHTML="<option>Error al cargar</option>";else{const T=(c||[]).reduce((P,j)=>(P.some(Q=>Q.name===j.name)||P.push(j),P),[]);y.innerHTML=T.map(P=>`<option value="${P.id}">${P.name}</option>`).join(""),y.value=r.id}document.getElementById("smart-label-prompt").value=r.prompt||"",document.getElementById("smart-label-is-automated").checked=r.is_automated,document.getElementById("smart-label-notify").checked=!!r.notify_on_assign,a&&(a.checked=!!r.funnel_name,document.getElementById("smart-label-funnel-name").value=r.funnel_name||"",document.getElementById("smart-label-funnel-order").value=r.funnel_order??"",W(a.checked))}else{C.classList.remove("hidden"),document.getElementById("smart-label-modal-title").textContent="Nueva automatización de etiqueta",document.getElementById("smart-label-id").value="";const{data:c,error:m}=await window.auth.sb.from("labels").select("id, name").is("prompt",null);if(m)console.error("Error cargando etiquetas no automatizadas:",m),y.innerHTML="<option>Error al cargar</option>";else{const T=(c||[]).reduce((P,j)=>(P.some(Q=>Q.name===j.name)||P.push(j),P),[]);y.innerHTML='<option value="" disabled selected>Selecciona una etiqueta...</option>'+T.map(P=>`<option value="${P.id}">${P.name}</option>`).join("")+'<option value="_new_" class="font-bold text-blue-600">Crear nueva etiqueta...</option>'}a&&(a.checked=!1,document.getElementById("smart-label-funnel-name").value="",document.getElementById("smart-label-funnel-order").value="",W(!1))}const d=document.getElementById("smart-label-ignore-in-chats");if(d){const c=(w=window.appInstance)==null?void 0:w.teamInfo,m=(c==null?void 0:c.ignored_labels)||[];d.checked=r?m.includes(r.name):!1}a&&!r&&W(a.checked),document.getElementById("ai-fields-container").classList.toggle("hidden",!(r!=null&&r.is_automated)),document.getElementById("delete-smart-label-btn").classList.toggle("hidden",!r),f.classList.remove("hidden"),lucide.createIcons()}function R(){document.getElementById("smart-label-modal").classList.add("hidden")}function W(r){const f=document.getElementById("funnel-fields-container"),p=document.getElementById("smart-label-funnel-name"),C=document.getElementById("smart-label-funnel-order");!f||!p||!C||(f.classList.toggle("hidden",!r),p.disabled=!r,p.required=r,C.disabled=!r)}async function q(r){if(r)try{const{data:f,error:p}=await window.auth.sb.from("labels").select("id").eq("user_id",r).eq("name","ignorar").limit(1);if(p)throw p;(Array.isArray(f)?f[0]:f)||await window.auth.sb.from("labels").insert({user_id:r,name:"ignorar",color:"#64748B",is_automated:!1,notify_on_assign:!1})}catch(f){throw console.error('No se pudo asegurar la etiqueta "ignorar":',f),f}}async function H(r,f){var d;const p=(d=window.appInstance)==null?void 0:d.teamInfo;if(!p||!r)return;let C=Array.isArray(p.ignored_labels)?[...p.ignored_labels]:[];const y=C.includes(r);if(f&&!y)C.push(r);else if(!f&&y)C=C.filter(w=>w!==r);else return;const{error:a}=await window.auth.sb.from("teams").update({ignored_labels:C}).eq("id",p.team_id);if(a)throw a;window.appInstance.teamInfo={...p,ignored_labels}}async function k(r){var P,j,Q,B,M,F;r.preventDefault();const f=document.querySelector('#smart-label-modal button[type="submit"]');f&&(f.disabled=!0,f.textContent="Guardando...");let p=document.getElementById("smart-label-id").value;const C=document.getElementById("smart-label-select"),y=document.getElementById("smart-label-enable-funnel"),a=!!(y!=null&&y.checked),d=document.getElementById("smart-label-funnel-order").value,w=document.getElementById("smart-label-funnel-name").value.trim(),c=!!((P=document.getElementById("smart-label-ignore-in-chats"))!=null&&P.checked),m=(Q=(j=window.auth.getSession())==null?void 0:j.user)==null?void 0:Q.id,T=document.getElementById("smart-label-name").value.trim()||((F=(M=(B=C==null?void 0:C.selectedOptions)==null?void 0:B[0])==null?void 0:M.textContent)==null?void 0:F.trim())||"";try{const z=d?parseInt(d,10):null,X={is_automated:document.getElementById("smart-label-is-automated").checked,prompt:document.getElementById("smart-label-prompt").value,funnel_name:a&&w?w:null,funnel_order:a&&Number.isFinite(z)?z:null,notify_on_assign:document.getElementById("smart-label-notify").checked};if(c&&m&&await q(m),p){const ee=document.getElementById("smart-label-select").value;if(p!==ee){await window.auth.sb.from("labels").update({prompt:null,is_automated:!1,funnel_name:null,funnel_order:null,notify_on_assign:!1}).eq("id",p);const{error:O}=await window.auth.sb.from("labels").update(X).eq("id",ee);if(O)throw O;p=ee}else{const{error:O}=await window.auth.sb.from("labels").update(X).eq("id",p);if(O)throw O}}else{const ee=document.getElementById("smart-label-select").value;if(ee==="_new_"){const O=document.getElementById("smart-label-name").value,ne=document.getElementById("smart-label-color").value,{error:K}=await window.auth.sb.from("labels").insert({...X,user_id:m,name:O,color:ne});if(K)throw K}else{const{error:O}=await window.auth.sb.from("labels").update(X).eq("id",ee);if(O)throw O}}await H(T,c),window.showToast("Automatización guardada con éxito.","success"),R(),v()}catch(z){console.error("Error al guardar la automatización:",z),window.showToast(`Error: ${z.message}`,"error")}finally{f&&(f.disabled=!1,f.textContent="Guardar automatización")}}async function b(){const r=document.getElementById("smart-label-id").value;if(!(!r||!confirm("Â¿EstÃ¡s seguro de que quieres eliminar esta etiqueta permanentemente? Esta acciÃ³n no se puede deshacer.")))try{const{error:f}=await window.auth.sb.from("labels").delete().eq("id",r);if(f)throw f;window.showToast("Etiqueta eliminada.","info"),R(),v()}catch(f){console.error("Error al eliminar la etiqueta:",f),window.showToast(`Error al eliminar: ${f.message}`,"error")}}})();(function(){const ae=[{name:"Saludo y Presentación",content:`¡Hola %nombre%! 👋
Soy de [Nombre de tu negocio] y quería saludarte.
Estamos ayudando a [clientes/negocios/personas] como tú con [beneficio principal].
¿Te interesa que te cuente un poco más?`},{name:"Promoción Exclusiva",content:`¡Hola %nombre%! 🎉
Tenemos una promoción especial esta semana:
👉 [Nombre del producto/servicio] con un descuento exclusivo.

¿Quieres que te mande la información completa? 🚀`},{name:"Recordatorio Amistoso",content:`¡Hola %nombre%!
Solo para recordarte sobre [tema pendiente].
Si necesitas algo, no dudes en avisarme. ¡Estoy para ayudarte!`}];let e=[],t=!1;document.addEventListener("panel:activated",({detail:k})=>{k.panelId==="templates"&&(t||(n(),t=!0))});async function n(){console.log("Panel de Plantillas activado."),o(),await s(),i(),v()}function o(){const k=document.getElementById("base-templates-container");k.innerHTML=ae.map(b=>`
            <div class="bg-white p-4 rounded-lg shadow">
                <h4 class="font-bold text-slate-800">${b.name}</h4>
                <p class="text-sm text-slate-600 mt-2 h-20 overflow-hidden">${b.content}</p>
                <div class="text-right mt-4">
                    <button class="apply-template-btn text-sm bg-blue-500 text-white py-1 px-3 rounded-md" data-content="${b.content}">Usar</button>
                </div>
            </div>
        `).join("")}async function s(){try{const{data:k,error:b}=await window.auth.sb.from("message_templates").select("*");if(b)throw b;e=k}catch(k){console.error("Error al cargar plantillas personalizadas:",k)}}function i(){const k=document.getElementById("custom-templates-container");if(e.length===0){k.innerHTML='<p class="text-slate-500 text-center">Aún no has creado plantillas.</p>';return}k.innerHTML=e.map(b=>`
            <div class="bg-white p-4 rounded-lg shadow flex items-center justify-between">
                <div>
                    <h4 class="font-bold text-slate-800">${b.name}</h4>
                    <p class="text-sm text-slate-600 mt-1">${b.content}</p>
                </div>
                <div class="flex items-center gap-2">
                    <button class="ai-enhance-btn text-sm bg-purple-100 text-purple-700 py-1 px-3 rounded-md" data-template-id="${b.id}"><i data-lucide="sparkles" class="w-4 h-4 inline-block pointer-events-none"></i> Mejorar</button>
                    <button class="apply-template-btn text-sm bg-blue-500 text-white py-1 px-3 rounded-md" data-content="${b.content}">Usar</button>
                    <button class="delete-template-btn text-sm bg-red-100 text-red-700 p-2 rounded-md" data-template-id="${b.id}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                </div>
            </div>
        `).join(""),lucide.createIcons()}function v(){var k,b,r;(k=document.getElementById("add-template-btn"))==null||k.addEventListener("click",x),document.body.addEventListener("click",f=>{const p=f.target.closest(".apply-template-btn"),C=f.target.closest(".delete-template-btn"),y=f.target.closest(".ai-enhance-btn");p&&R(f.target.dataset.content),C&&te(f.target.dataset.templateId),y&&q(f.target.dataset.templateId)}),(b=document.getElementById("cancel-new-template-btn"))==null||b.addEventListener("click",L),(r=document.getElementById("new-template-form"))==null||r.addEventListener("submit",J)}async function x(){if(e.length>=5){alert("Has alcanzado el límite de 5 plantillas personalizadas.");return}g()}function g(){var r;document.getElementById("new-template-form-container").classList.remove("hidden"),document.getElementById("add-template-btn").classList.add("hidden");const k=document.getElementById("new-template-content"),b=document.getElementById("new-template-form");(r=b.querySelector(".template-actions"))==null||r.remove(),k.insertAdjacentHTML("afterend",`
            <div class="template-actions flex items-center justify-between mt-2">
                <button type="button" class="personalize-name-btn text-sm bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-md"><i data-lucide="user-plus" class="w-4 h-4 inline-block mr-1"></i>Insertar Nombre</button>
                <button type="button" class="ai-enhance-btn text-xs bg-purple-100 text-purple-700 font-semibold py-1 px-2 rounded-md hover:bg-purple-200 flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> Mejorar con IA</button>
            </div>
        `),b.querySelector(".ai-enhance-btn").addEventListener("click",()=>window.appInstance.openAiEnhanceModal(k.value,f=>{k.value=f})),b.querySelector(".personalize-name-btn").addEventListener("click",()=>W(k)),lucide.createIcons({root:b.querySelector(".template-actions")}),document.getElementById("new-template-name").value="",document.getElementById("new-template-content").value=""}function L(){var b;document.getElementById("new-template-form-container").classList.add("hidden"),document.getElementById("add-template-btn").classList.remove("hidden");const k=document.getElementById("new-template-form");k.reset(),(b=k.querySelector(".template-actions"))==null||b.remove()}async function J(k){k.preventDefault();const b=document.getElementById("new-template-name").value.trim(),r=document.getElementById("new-template-content").value.trim();if(!(!b||!r))try{const{error:f}=await window.auth.sb.from("message_templates").insert({user_id:window.auth.getSession().user.id,name:b,content:r});if(f)throw f;L(),await s(),i()}catch(f){console.error("Error al crear plantilla:",f),alert("No se pudo crear la plantilla.")}}async function te(k){if(confirm("¿Estás seguro de que quieres borrar esta plantilla?"))try{const{error:b}=await window.auth.sb.from("message_templates").delete().eq("id",k);if(b)throw b;await s(),i()}catch(b){console.error("Error al borrar plantilla:",b),alert("No se pudo borrar la plantilla.")}}function R(k){const b=document.querySelector('.nav-link[data-target="bulk-sending"]');b&&(b.click(),setTimeout(()=>{const r=document.getElementById("bulk-message");r&&(r.value=k,r.focus())},100))}function W(k){if(!k)return;const b=k.selectionStart,r=k.selectionEnd,f=k.value,p="%nombre%";k.value=f.substring(0,b)+p+f.substring(r),k.focus(),k.selectionEnd=b+p.length}function q(k){const b=e.find(r=>r.id==k);b&&window.appInstance.openAiEnhanceModal(b.content,r=>{H(b.id,r)})}async function H(k,b){await window.auth.sb.from("message_templates").update({content:b}).eq("id",k),window.appInstance.closeAiModal(),await s(),i()}})();(function(){let ae=!1,e={},t=null,n={used:0,limit:0},o=!1;document.addEventListener("panel:activated",({detail:R})=>{R.panelId==="video-ai"&&!ae&&s()});async function s(){ae=!0,await i(),v(),x(),g()}async function i(){var W;t=await window.appInstance.loadUserSubscription();const R=await window.appInstance.loadUserUsage();n={used:(R==null?void 0:R.video_generations_used)||0,limit:((W=t==null?void 0:t.plans)==null?void 0:W.video_generations_limit)||0}}function v(){e={prompt:"",imageUrls:[],model:"veo3_fast",aspectRatio:"16:9"}}function x(){const R=document.getElementById("video-ai");R&&(R.addEventListener("input",W=>{W.target.id==="video-prompt"&&(e.prompt=W.target.value),W.target.id==="video-aspect-ratio-select"&&(e.aspectRatio=W.target.value)}),R.addEventListener("click",W=>{W.target.id==="generate-video-btn"&&te()}))}function g(){var k,b;const R=document.getElementById("video-ai");if(!R)return;const W=((b=(k=t==null?void 0:t.plans)==null?void 0:k.features)==null?void 0:b.video_ai)??!1;if(R.querySelector(".grid").classList.toggle("hidden",!W),R.querySelector("#video-ai-access-denied").classList.toggle("hidden",W),!W){document.getElementById("upgrade-to-grow-from-video").onclick=()=>window.appInstance.handleUpgradeClick("grow");return}const q=R.querySelector("#video-reference-selector");q.innerHTML=Array.from({length:2}).map((r,f)=>L(`video-ref-${f}`,`Imagen ${f+1}`,e.imageUrls[f])).join("");const H=R.querySelector("#video-generation-usage-container");H.innerHTML=`
            <h4 class="font-bold text-sm mb-1">Uso Mensual</h4>
            <p class="text-xs text-slate-600">Videos generados: <span id="video-generation-usage" class="font-bold">${n.used} / ${n.limit}</span></p>
        `,J(),lucide.createIcons()}function L(R,W,q){return`
            <div class="image-upload-slot" data-upload-id="${R}">
                <label for="${R}" class="upload-label">
                    ${q?"":`<div class="text-center text-xs text-gray-500"><p class="font-semibold">${W}</p></div>`}
                </label>
                ${q?`<img src="${q}" alt="Preview" class="image-preview" />`:""}
                ${q?`<button class="remove-button" data-remove-id="${R}"><i data-lucide="x" class="w-4 h-4 pointer-events-none"></i></button>`:""}
                <input id="${R}" type="file" class="hidden" accept="image/*" />
            </div>
        `}function J(){document.querySelectorAll("#video-reference-selector .image-upload-slot").forEach(R=>{var k;const W=R.dataset.uploadId,q=document.getElementById(W),H=parseInt(W.split("-")[2],10);(k=R.querySelector(".remove-button"))==null||k.addEventListener("click",b=>{b.preventDefault(),b.stopPropagation(),e.imageUrls[H]=null,g()}),q.addEventListener("change",async b=>{var f;const r=(f=b.target.files)==null?void 0:f[0];if(r){try{const p=await window.appInstance.uploadAsset(r,"video-references");e.imageUrls[H]=p}catch{window.showToast("Error al subir la imagen.","error")}g()}})})}async function te(){var q,H;if(o)return;if(!e.prompt){window.showToast("El prompt del video no puede estar vacío.","error");return}const R=document.getElementById("generate-video-btn"),W=document.getElementById("video-result-container");o=!0,R.disabled=!0,R.textContent="Generando...",W.innerHTML='<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>';try{const k=(H=(q=window.auth.getSession())==null?void 0:q.user)==null?void 0:H.id,{data:b,error:r}=await window.auth.sb.rpc("increment_video_usage",{p_user_id:k});if(r||!b.success)throw new Error((b==null?void 0:b.message)||(r==null?void 0:r.message)||"Error al verificar el uso.");const f={prompt:e.prompt,imageUrls:e.imageUrls.filter(Boolean),model:e.model,aspectRatio:e.aspectRatio},{data:p,error:C}=await window.auth.sb.functions.invoke("kie-veo-proxy",{body:f});if(C)throw C;W.innerHTML=`
                <div class="text-center p-4">
                    <i data-lucide="check-circle" class="w-12 h-12 text-green-500 mx-auto"></i>
                    <p class="font-semibold mt-2">Tarea enviada con éxito</p>
                    <p class="text-xs text-slate-500 mt-1">Task ID: <span class="font-mono">${p.data.taskId}</span></p>
                    <p class="text-xs text-slate-400 mt-2">Recibirás el video en tu webhook o puedes consultarlo con el ID.</p>
                </div>
            `,lucide.createIcons(),n.used++,document.getElementById("video-generation-usage").textContent=`${n.used} / ${n.limit}`}catch(k){console.error("Error al generar video:",k),window.showToast(k.message||"Ocurrió un error al generar el video.","error"),W.innerHTML=`
                <div class="text-center p-4">
                    <i data-lucide="alert-triangle" class="w-12 h-12 text-red-500 mx-auto"></i>
                    <p class="font-semibold mt-2 text-red-700">Error en la Generación</p>
                    <p class="text-xs text-slate-500 mt-1">${k.message}</p>
                </div>
            `,lucide.createIcons()}finally{o=!1,R.disabled=!1,R.textContent="Generar Video"}}})();const tt=document.createElement("style");tt.textContent=".content-panel:not(.active) { display: none !important; }";document.head.appendChild(tt);document.addEventListener("DOMContentLoaded",()=>{const ae=e=>{e&&!window.appInstance&&(window.appInstance=new Re(e),window.appInstance.init())};document.addEventListener("auth:ready",({detail:e})=>ae(e.session))});(function(){if(window.openColumnMappingModal)return;const e=(t,n)=>{const o={},s=new Set,i=t.map(x=>x.toLowerCase()),v=(x=[])=>{for(const g of x){const L=i.indexOf(g.toLowerCase());if(L!==-1&&!s.has(L))return L}return-1};for(const x of n){let g=v(x.aliases);if(g===-1&&(g=t.findIndex((L,J)=>!s.has(J))),g===-1){if(x.required)return console.warn(`No se pudo asignar automáticamente la columna para "${x.label}".`),null;continue}o[x.field]=g,s.add(g)}return o};window.openColumnMappingModal=async function(t=[],n=[]){const o=n.map(J=>typeof J=="string"?J.trim():"").filter(Boolean),s=document.getElementById("column-mapping-modal"),i=document.getElementById("column-mapping-table-body"),v=document.getElementById("column-mapping-error"),x=document.getElementById("confirm-column-mapping-btn"),g=document.getElementById("cancel-column-mapping-btn"),L=document.getElementById("close-column-mapping-btn");return!s||!i||!v||!x||!g||!L?(console.warn("No se encontró el modal de mapeo de columnas. Se intentará asignar automáticamente."),e(o,t)):await new Promise(J=>{var c;const te=new Map(t.map(m=>[m.field,m]));let R=!1,W=[];i.innerHTML="";const q=(m=[])=>{const T=o.map(P=>P.toLowerCase());for(const P of m){const j=T.indexOf(P.toLowerCase());if(j!==-1)return j}return-1};t.forEach(m=>{const T=document.createElement("tr");T.innerHTML=`
                    <td class="px-4 py-3">
                        <div class="flex flex-col">
                            <span class="font-medium text-slate-700">${m.label}</span>
                            <span class="mt-1 text-xs ${m.required?"text-red-500 font-semibold":"text-slate-400"}">${m.required?"Obligatorio":"Opcional"}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <select class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">${m.required?"Selecciona una columna":"Dejar sin asignar"}</option>
                        </select>
                    </td>
                `;const P=T.querySelector("select");P.dataset.field=m.field,P.dataset.required=m.required?"true":"false",o.forEach((j,Q)=>{const B=document.createElement("option");B.value=String(Q),B.textContent=j,P.appendChild(B)}),i.appendChild(T)}),W=Array.from(i.querySelectorAll("select"));const H=new Set;W.forEach(m=>{const T=te.get(m.dataset.field),P=q((T==null?void 0:T.aliases)||[]);typeof P=="number"&&P>=0&&!H.has(String(P))&&(m.value=String(P),H.add(String(P)))});const k=()=>{const m=new Set(W.map(T=>T.value).filter(Boolean));W.forEach(T=>{Array.from(T.options).forEach(P=>{P.value&&(P.disabled=T.value!==P.value&&m.has(P.value))})})},b=m=>{v.textContent=m,v.classList.remove("hidden")},r=()=>{v.textContent="",v.classList.add("hidden")},f=m=>{m.target.classList.remove("border-red-500"),r(),k()},p=()=>{W.forEach(m=>m.removeEventListener("change",f)),x.removeEventListener("click",y),g.removeEventListener("click",a),L.removeEventListener("click",a),s.removeEventListener("click",d),document.removeEventListener("keydown",w),i.innerHTML="",r(),s.classList.add("hidden"),document.body.classList.remove("overflow-hidden")},C=m=>{R||(R=!0,p(),J(m))},y=()=>{const m={};r();for(const T of W){const P=T.dataset.field,j=te.get(P),Q=T.value;if(!Q){if(j!=null&&j.required){T.classList.add("border-red-500"),b(`Selecciona una columna para "${j.label}".`),T.focus();return}continue}m[P]=Number(Q)}C(m)},a=()=>C(null),d=m=>{m.target===s&&C(null)},w=m=>{m.key==="Escape"&&(m.preventDefault(),C(null))};W.forEach(m=>m.addEventListener("change",f)),x.addEventListener("click",y),g.addEventListener("click",a),L.addEventListener("click",a),s.addEventListener("click",d),document.addEventListener("keydown",w),document.body.classList.add("overflow-hidden"),s.classList.remove("hidden"),r(),typeof(lucide==null?void 0:lucide.createIcons)=="function"&&lucide.createIcons(),k(),(c=W[0])==null||c.focus()})},window.escapeCsvValue=function(t){if(t==null)return"";const n=String(t);return/[",\n]/.test(n)?'"'+n.replace(/"/g,'""')+'"':n},window.splitCsvLines=function(t){if(typeof t!="string")return[];let n=t;n.length&&n.charCodeAt(0)===65279&&(n=n.slice(1));const o=[];let s="",i=!1;for(let v=0;v<n.length;v++){const x=n[v];if(x==='"'){i&&n[v+1]==='"'?(s+='"',v++):(i=!i,s+=x);continue}if((x===`
`||x==="\r")&&!i){x==="\r"&&n[v+1]===`
`&&v++,o.push(s),s="";continue}s+=x}return s.length>0&&o.push(s),o.map(v=>v.trim()).filter(v=>v.length>0)},window.convertFileToCsvText=async function(t){const n=(t.name||"").toLowerCase();if(n.endsWith(".xlsx")||n.endsWith(".xls")){if(typeof XLSX>"u")throw new Error("No se pudo cargar el lector de hojas de cálculo (XLSX). Recarga la página e intenta nuevamente.");const o=await t.arrayBuffer(),s=XLSX.read(o,{type:"array"});if(!s.SheetNames.length)throw new Error("El archivo de Excel no contiene hojas válidas.");const i=s.Sheets[s.SheetNames[0]];return XLSX.utils.sheet_to_csv(i,{FS:",",RS:`
`})}return await t.text()},window.parseCsvRow=function(t){const n=[];let o="",s=!1;for(let i=0;i<t.length;i++){const v=t[i];v==='"'&&(i===0||t[i-1]!=='"')?s&&t[i+1]==='"'?(o+='"',i++):s=!s:v===","&&!s?(n.push(o.trim()),o=""):o+=v}return n.push(o.trim()),n},window.autoMapHeaders=function(t,n){const o={},s=new Set,i=t.map(v=>v.toLowerCase());for(const v of n){let x=-1;for(const g of v.aliases||[]){const L=i.indexOf(g.toLowerCase());if(L!==-1&&!s.has(L)){x=L;break}}if(x===-1&&(x=t.findIndex((g,L)=>!s.has(L))),x===-1){if(v.required)return null;continue}o[v.field]=x,s.add(x)}return o},window.getColumnValue=function(t,n){return typeof n!="number"||n<0||n>=t.length?"":t[n]},window.cleanPhone=function(t){if(!t)return"";const n=String(t).replace(/\D+/g,"");return n.length<10?"":"+521"+n.slice(-10)}})();class Re{constructor(e){this.session=e,this.switchPanel=this.switchPanel.bind(this),this.user=e.user,this.teamInfo=null,this.config={N8N_URL:"https://n8n-n8n.mcjhhb.easypanel.host",YOUTUBE_PLAYLIST_ID:"PLfA32SmdFbHBdOXaPc_tdg28Kl2CFAXnz",CHATWOOT_BASE_URL:"https://chat.elinaia.com.mx"},this.handlePromptSave=this.handlePromptSave.bind(this),this.checkWhatsappConnection=this.checkWhatsappConnection.bind(this),this.openChatwoot=this.openChatwoot.bind(this),this.openAiEnhanceModal=this.openAiEnhanceModal.bind(this)}init(){if(lucide.createIcons(),!localStorage.getItem("welcome_popup_shown")){const t=document.getElementById("welcome-modal");t&&(t.classList.remove("hidden"),document.getElementById("close-welcome-modal").addEventListener("click",()=>{t.classList.add("hidden"),localStorage.setItem("welcome_popup_shown","true")}))}this.setupEventListeners(),this.loadInitialData(),this.checkImpersonation();const e=localStorage.getItem("activePanelId")||"dashboard";this.switchPanel(e),this.listenForProfileChanges(),this.wizard=new ct(this),this.setSidebarCollapsed(localStorage.getItem("sidebarCollapsed")==="true")}setupEventListeners(){var t,n,o,s,i,v,x,g,L,J,te,R,W,q,H,k,b,r,f;document.querySelectorAll(".nav-link[data-target]").forEach(p=>{p.addEventListener("click",C=>{C.preventDefault(),this.switchPanel(p.dataset.target)})}),(t=document.getElementById("logout-btn"))==null||t.addEventListener("click",p=>{p.preventDefault(),auth.handleLogout()}),(n=document.getElementById("prompt-form"))==null||n.addEventListener("submit",this.handlePromptSave),(o=document.getElementById("main-prompt-ai-enhance-btn"))==null||o.addEventListener("click",()=>{const p=document.getElementById("ai-master-prompt");p.value&&this.openAiEnhanceModal(p.value,C=>{p.value=C})}),(s=document.getElementById("remake-prompt-btn"))==null||s.addEventListener("click",()=>{this.wizard.start(!0)}),(i=document.getElementById("main-prompt-ai-enhance-btn"))==null||i.addEventListener("click",()=>{const p=document.getElementById("ai-master-prompt");p.value&&this.openAiEnhanceModal(p.value,C=>{p.value=C})}),(v=document.getElementById("remake-prompt-btn"))==null||v.addEventListener("click",()=>{this.wizard.start(!0)}),(x=document.getElementById("request-qr-btn"))==null||x.addEventListener("click",this.checkWhatsappConnection),(g=document.getElementById("chatwoot-link"))==null||g.addEventListener("click",this.openChatwoot),(L=document.getElementById("mobile-menu-btn"))==null||L.addEventListener("click",()=>{const p=document.getElementById("main-sidebar");p==null||p.classList.add("open")}),(J=document.getElementById("prompt-help-btn"))==null||J.addEventListener("click",()=>{var p;return(p=document.getElementById("prompt-help-modal"))==null?void 0:p.classList.remove("hidden")}),(te=document.getElementById("close-prompt-help-btn"))==null||te.addEventListener("click",()=>{var p;return(p=document.getElementById("prompt-help-modal"))==null?void 0:p.classList.add("hidden")}),(R=document.getElementById("start-wizard-btn"))==null||R.addEventListener("click",()=>this.wizard.start()),(W=document.getElementById("close-sidebar-btn"))==null||W.addEventListener("click",()=>{const p=document.getElementById("main-sidebar");p==null||p.classList.remove("open")}),(q=document.getElementById("open-tutorials-btn"))==null||q.addEventListener("click",()=>this.openTutorialsModal()),this.setupYoutubeCarousel(),(H=document.getElementById("cancel-ai-btn"))==null||H.addEventListener("click",()=>this.closeAiModal()),(k=document.getElementById("generate-ai-btn"))==null||k.addEventListener("click",()=>this.handleGenerateAi());const e=document.getElementById("regenerate-ai-btn");e&&e.addEventListener("click",()=>this.handleGenerateAi(!0)),(b=document.getElementById("regenerate-ai-btn"))==null||b.addEventListener("click",()=>this.handleGenerateAi()),(r=document.getElementById("apply-ai-btn"))==null||r.addEventListener("click",()=>this.handleApplyAi()),(f=document.getElementById("toggle-sidebar-collapse-btn"))==null||f.addEventListener("click",()=>this.toggleSidebarCollapsed())}checkImpersonation(){const e=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),t=localStorage.getItem("superadmin_session_tokens");if(!e){document.body.style.paddingTop="0";return}if(!t){localStorage.removeItem("impersonated_user_info"),document.body.style.paddingTop="0";return}if(!document.getElementById("impersonation-bar")&&e){const n=document.createElement("div");n.id="impersonation-bar",n.className="fixed top-0 left-0 w-full bg-amber-500 text-black font-bold text-xs p-1 text-center z-[200] flex justify-center items-center gap-2",n.innerHTML=`
                <span>Estás viendo como <strong>${e.email}</strong>.</span>
                <button id="stop-impersonating-btn" class="bg-slate-800 text-white py-0.5 px-2 rounded hover:bg-slate-700 text-xs">Volver a Super Admin</button>
            `,document.body.prepend(n),document.body.style.paddingTop="0",document.getElementById("stop-impersonating-btn").addEventListener("click",async()=>{try{const o=JSON.parse(localStorage.getItem("superadmin_session_tokens")||"null");if(!(o!=null&&o.access_token)||!(o!=null&&o.refresh_token))throw new Error("Sesión original inválida. Por favor, inicia sesión nuevamente.");await window.auth.sb.auth.setSession(o),localStorage.removeItem("impersonated_user_info"),localStorage.removeItem("superadmin_session_tokens"),document.body.style.paddingTop="0",window.location.reload()}catch(o){console.error("Error al detener la suplantación:",o),alert("No se pudo volver a la sesión de superadmin. Por favor, cierra sesión y vuelve a entrar.")}})}}loadInitialData(){this.fetchUserProfile(),this.fetchMasterPrompt(),this.loadDashboardMetrics(),this.loadFunnelMetrics(),Promise.all([this.loadUserSubscription(),this.loadTeamInfo()]).then(([e,t])=>{this.renderUserPlanBadge(e),this.renderUpgradeButtons(e),document.addEventListener("panel:activated",()=>this.applyFeatureRestrictions(e,t))}),this.renderWhatsappConnection("initial")}openTutorialsModal(){const e="https://www.youtube.com/embed/videoseries?list=PLDs44uukbe3FIDa9CttQLh8N-Nfdpo_hG&autoplay=1",t=document.getElementById("image-viewer-modal"),n=document.getElementById("image-viewer-content");n.innerHTML=`<iframe class="w-full h-full" src="${e}" title="Tutoriales ELINA IA" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`,t.classList.remove("hidden")}toggleSidebarCollapsed(){const e=document.getElementById("main-sidebar");if(!e)return;const t=e.classList.toggle("sidebar-collapsed");this.setSidebarCollapsed(t),localStorage.setItem("sidebarCollapsed",t)}setSidebarCollapsed(e){const t=document.getElementById("main-sidebar"),n=document.getElementById("main-content-area"),o=document.getElementById("toggle-sidebar-collapse-btn");if(!t||!n||!o)return;e?(t.classList.add("sidebar-collapsed"),n.classList.add("lg:ml-20"),n.classList.remove("lg:ml-64"),o.style.left="4.5rem"):(t.classList.remove("sidebar-collapsed"),n.classList.remove("lg:ml-20"),n.classList.add("lg:ml-64"),o.style.left="15.5rem");const s=o.querySelector("i");s&&s.setAttribute("data-lucide",e?"chevron-right":"chevron-left"),lucide.createIcons({nodes:[s]})}switchPanel(e,t={}){const n=document.getElementById("main-sidebar"),o=document.getElementById("main-content-area"),s=document.getElementById("toggle-sidebar-collapse-btn");document.querySelectorAll(".content-panel").forEach(g=>g.classList.remove("active"));const i=document.getElementById(e);if(i){if(e==="kanban")n.classList.add("hidden"),s.style.display="none",o.classList.remove("lg:ml-64","lg:ml-20","ml-0"),o.classList.add("lg:ml-0");else{n.classList.remove("hidden"),s.style.display="";const g=n.classList.contains("sidebar-collapsed");o.classList.remove("lg:ml-0"),o.classList.toggle("lg:ml-20",g),o.classList.toggle("lg:ml-64",!g)}i.classList.add("active"),localStorage.setItem("activePanelId",e),document.dispatchEvent(new CustomEvent("panel:activated",{detail:{panelId:e,options:t}})),n&&n.classList.contains("open")&&n.classList.remove("open")}const v=["bg-green-500","text-white"];document.querySelectorAll(".nav-link[data-target]").forEach(g=>g.classList.remove(...v));const x=document.querySelector(`.nav-link[data-target="${e}"]`);x&&x.classList.add(...v)}listenForProfileChanges(){auth.sb.channel(`profile-changes:${this.user.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"profiles",filter:`id=eq.${this.user.id}`},e=>{const{whatsapp_connected:t,sync_status:n}=e.new;document.dispatchEvent(new CustomEvent("profile:updated",{detail:{whatsapp_connected:t,sync_status:n}}))}).subscribe()}async loadUserSubscription(){try{const{data:e,error:t}=await auth.sb.from("subscriptions").select("status, plan_id, plans:plan_id(*)").eq("user_id",this.user.id).limit(1).single();if(t&&t.code!=="PGRST116")throw t;if(e&&e.plan_id==="free_trial"&&e.status==="trialing"){const{data:n}=await auth.sb.from("profiles").select("stripe_customer_id").eq("id",this.user.id).single();if(n&&n.stripe_customer_id){const{data:o,error:s}=await auth.sb.functions.invoke("get-stripe-subscription",{body:{customerId:n.stripe_customer_id}});if(s)throw s;o&&o.planId&&(e.plan_id=o.planId,e.plans.name=o.planName,e.plans.features=o.features)}}return e}catch(e){return console.error("Error al cargar la suscripción del usuario:",e),null}}async loadTeamInfo(){try{const{data:e,error:t}=await auth.sb.rpc("get_user_team_info_with_permissions",{p_user_id:this.user.id});if(t)throw t;return e&&e.length>0&&(this.teamInfo=e[0]),this.teamInfo}catch(e){return console.error("Error al cargar la información del equipo:",e),null}}async loadUserUsage(){try{const{data:e,error:t}=await window.auth.sb.from("profiles").select("ai_enhancements_used, image_generations_used, bulk_sends_used").eq("id",this.user.id).single();if(t)throw t;return e}catch(e){return console.error("Error al cargar el uso del usuario:",e),{ai_enhancements_used:0,image_generations_used:0,bulk_sends_used:0}}}async renderUsageAndLimits(){var s;const[e,t]=await Promise.all([this.loadUserSubscription(),this.loadUserUsage()]);e?(this.renderUserPlanBadge(e),this.renderUpgradeButtons(e),this.applyFeatureRestrictions(e,this.teamInfo)):console.warn("El usuario no tiene una suscripción registrada.");const n=((s=e==null?void 0:e.plans)==null?void 0:s.image_generations_limit)||0,o=(t==null?void 0:t.image_generations_used)||0;console.log("[Uso Verificado]",{imageGenerations:{used:o,limit:n}}),document.dispatchEvent(new CustomEvent("usage:updated",{detail:{imageGenerations:{remaining:n-o,limit:n}}}))}renderUserPlanBadge(e){var v;const t=document.getElementById("user-plan-badge");if(!t||!e)return;const n=e.plan_id,o=((v=e.plans)==null?void 0:v.name)||n.replace("_"," ").replace(/\b\w/g,x=>x.toUpperCase());let s="bg-slate-200",i="text-slate-700";switch(n){case"free_trial":s="bg-blue-100",i="text-blue-800";break;case"starter":s="bg-green-100",i="text-green-800";break;case"grow":s="bg-purple-100",i="text-purple-800";break;case"business":s="bg-slate-200",i="text-slate-800";break}t.textContent=o,t.className=`inline-block text-xs font-bold px-2 py-0.5 rounded-md mt-1.5 ${s} ${i}`}applyFeatureRestrictions(e,t){if(!e||!e.plans)return;const n=e.plans.features||{},o=t==null?void 0:t.user_role,s=document.getElementById("follow-ups");if(s!=null&&s.classList.contains("active")&&s.querySelector("#follow-ups-container")){const v=s.querySelector("#follow-ups-container"),x=s.querySelector("#follow-ups-access-denied");n.follow_ups?(v&&v.classList.remove("hidden"),x&&x.classList.add("hidden")):(v&&v.classList.add("hidden"),x&&x.classList.remove("hidden"),document.getElementById("upgrade-to-grow-from-followups").onclick=()=>this.handleUpgradeClick("grow"))}const i=document.getElementById("designer-ai");if(i!=null&&i.classList.contains("active")&&i.querySelector("#designer-ai-access-denied")){const v=i.querySelector(".grid"),x=i.querySelector("#designer-ai-access-denied"),g=n.designer_ai;v&&v.classList.toggle("hidden",!g),x&&x.classList.toggle("hidden",g),g||(document.getElementById("upgrade-to-grow-from-designer").onclick=()=>this.handleUpgradeClick("grow"))}if(o==="advisor"){const v=(t==null?void 0:t.permissions)||{};document.querySelectorAll(".nav-link[data-target]").forEach(x=>{const g=x.dataset.target;g!=="dashboard"&&!v[g]&&(x.parentElement.style.display="none")})}}renderUpgradeButtons(e){const t=document.getElementById("upgrade-plan-section");if(!t||!e)return;const n=document.getElementById("upgrade-grow-btn"),o=document.getElementById("upgrade-collapsed-btn"),s=document.getElementById("upgrade-trial-btn");n&&n.classList.add("hidden"),s&&s.classList.add("hidden"),t&&t.classList.add("hidden"),o&&o.classList.add("hidden");const i=e.plan_id;i==="free_trial"?(s.classList.remove("hidden"),t.classList.remove("hidden"),s.onclick=()=>this.openPricingModal(),o.onclick=()=>this.openPricingModal()):i==="starter"&&(n.classList.remove("hidden"),t.classList.remove("hidden"),n.onclick=()=>this.handleUpgradeClick("grow"),o.onclick=()=>this.handleUpgradeClick("grow"))}async handleUpgradeClick(e){const t=document.querySelector(`.upgrade-btn[data-plan="${e}"]`)||document.getElementById(`upgrade-${e}-btn`);if(!t)return;const n=document.getElementById("pricing-modal");n&&n.classList.add("hidden");const o=t.textContent;t.disabled=!0,t.textContent="Redirigiendo a pago...";try{const{data:s,error:i}=await window.auth.sb.functions.invoke("create-checkout-session",{body:{planId:e,userId:this.user.id}});if(i)throw new Error(i.message);window.location.href=s.url}catch(s){console.error("Error al iniciar el proceso de pago:",s),window.showToast("No se pudo iniciar el proceso de pago. Por favor, intenta de nuevo.","error"),t.disabled=!1,t.textContent=o}}async fetchUserProfile(){var n,o,s;const e=document.getElementById("user-business-name"),t=document.getElementById("user-avatar");try{const{data:i,error:v}=await window.auth.sb.from("profiles").select("full_name, role, urlfoto").eq("id",this.user.id).single();if(v)throw v;const g=((n=this.teamInfo)==null?void 0:n.team_name)||i.full_name||"Mi negocio";if(e&&(e.textContent=g),t){const L=(i.urlfoto||"").trim();t.src=L||`https://ui-avatars.com/api/?background=0A3B66&color=fff&name=${encodeURIComponent(g)}`,t.alt=`Logo de ${g}`}i.role==="superadmin"&&((o=document.getElementById("superadmin-link"))==null||o.classList.remove("hidden"),(s=document.getElementById("mobile-superadmin-link"))==null||s.classList.remove("hidden"))}catch(i){console.error("Error al cargar el perfil del usuario:",i),e&&(e.textContent="Mi negocio"),t&&(t.src="https://ui-avatars.com/api/?background=0A3B66&color=fff&name=Elina")}}async fetchMasterPrompt(){try{const{data:e,error:t}=await auth.sb.from("prompts").select("prompt_content").eq("user_id",this.user.id).single();if(t&&t.code!=="PGRST116")throw t;document.getElementById("ai-master-prompt").value=(e==null?void 0:e.prompt_content)||""}catch(e){console.error("Error al cargar el prompt:",e),document.getElementById("ai-master-prompt").value="No se pudo cargar el prompt."}}async handlePromptSave(e){e.preventDefault();const t=document.getElementById("prompt-form");if(!t)return;const n=t.querySelector('button[type="submit"]'),o=document.getElementById("ai-master-prompt").value;if(n){n.disabled=!0,n.textContent="Guardando...";try{const{error:s}=await auth.sb.from("prompts").upsert({user_id:this.user.id,prompt_content:o},{onConflict:"user_id"});if(s)throw s;window.showToast("Prompt guardado con éxito.","success")}catch(s){console.error("Error al guardar el prompt:",s),window.showToast("Error al guardar el prompt. Revisa la consola.","error")}finally{n.disabled=!1,n.textContent="Guardar"}}}async uploadAsset(e,t){if(!e)return null;const n=this.user.id,o=e.name.replace(/[^a-zA-Z0-9._-]/g,"_"),s=`temp-uploads/${n}/${t}/${Date.now()}-${o}`;try{const{error:i}=await window.auth.sb.storage.from("campaign_files").upload(s,e);if(i)throw new Error(`Error en subida temporal: ${i.message}`);const{data:v}=window.auth.sb.storage.from("campaign_files").getPublicUrl(s),{data:x,error:g}=await window.auth.sb.functions.invoke("smart-worker",{body:{sourceUrl:v.publicUrl,userId:n}});if(g)throw new Error(`Error al mover a CDN: ${g.message}`);const{error:L}=await window.auth.sb.storage.from("campaign_files").remove([s]);return L&&console.warn(`[Limpieza] No se pudo borrar el archivo temporal ${s}:`,L.message),x.cdnUrl}catch(i){throw console.error("Falló el proceso completo de subida de asset:",i),i}}async loadDashboardMetrics(){try{const e=new Date,t=new Date(e);t.setDate(e.getDate()-30);const{data:n,error:o}=await auth.sb.from("daily_stats").select("stat_date, ai_responses_count, time_saved_seconds").eq("user_id",this.user.id).gte("stat_date",t.toISOString().split("T")[0]).order("stat_date",{ascending:!0});if(o)throw o;this.renderMetricsCharts(n)}catch(e){console.error("Error al cargar métricas del dashboard:",e)}}renderMetricsCharts(e){var x,g;const t=e.map(L=>new Date(L.stat_date+"T00:00:00").toLocaleDateString("es-MX",{day:"numeric",month:"short"})),n=e.map(L=>L.ai_responses_count),o=e.map(L=>Math.round(L.time_saved_seconds/60)),s={responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{color:"#94a3b8"}},x:{ticks:{color:"#94a3b8"}}},plugins:{legend:{display:!1}}},i=(x=document.getElementById("responses-chart"))==null?void 0:x.getContext("2d");i&&new Chart(i,{type:"line",data:{labels:t,datasets:[{label:"Mensajes Respondidos",data:n,borderColor:"rgb(59, 130, 246)",backgroundColor:"rgba(59, 130, 246, 0.1)",fill:!0,tension:.3}]},options:s});const v=(g=document.getElementById("time-saved-chart"))==null?void 0:g.getContext("2d");v&&new Chart(v,{type:"line",data:{labels:t,datasets:[{label:"Minutos Ahorrados",data:o,borderColor:"rgb(139, 92, 246)",backgroundColor:"rgba(139, 92, 246, 0.1)",fill:!0,tension:.3}]},options:s})}async loadFunnelMetrics(){try{const e=new Date;e.setDate(e.getDate()-30);const{data:t,error:n}=await auth.sb.from("contacts").select("labels, created_at").eq("user_id",this.user.id).gte("created_at",e.toISOString());if(n)throw n;let o=0,s=0,i=0;t.forEach(x=>{const g=new Set(x.labels||[]);o++,g.has("Interesado")&&s++,g.has("nuevo cliente")&&i++});const v=o>0?(i/o*100).toFixed(1):0;document.getElementById("funnel-leads-stat").textContent=o,document.getElementById("funnel-interested-stat").textContent=s,document.getElementById("funnel-won-stat").textContent=i,document.getElementById("funnel-conversion-stat").textContent=`${v}%`}catch(e){console.error("Error al cargar métricas del embudo:",e)}}async checkWhatsappConnection(){this.renderWhatsappConnection("loading");const e=`${this.config.N8N_URL}/webhook/generate-whatsapp-qr-Elina`;try{const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:this.user.email})});if(!t.ok)throw new Error("El servidor N8N no responde correctamente.");const n=await t.json(),o=Array.isArray(n)?n[0]:n;o!=null&&o.qr_image_data?this.renderWhatsappConnection("qr",o.qr_image_data):this.renderWhatsappConnection("connected")}catch(t){console.error("Error al solicitar QR:",t),this.renderWhatsappConnection("error")}}openChatwoot(e){e.preventDefault(),window.open(`${this.config.CHATWOOT_BASE_URL}/app/login`,"_blank")}setupYoutubeCarousel(){const e=document.getElementById("yt-player"),t=document.querySelectorAll("#yt-carousel [data-vid]"),n=this.config.YOUTUBE_PLAYLIST_ID;t.forEach(o=>{o.addEventListener("click",s=>{s.preventDefault();const i=o.dataset.vid;i&&e&&(e.src=`https://www.youtube.com/embed/${i}?list=${n}&rel=0&autoplay=1`)})})}renderWhatsappConnection(e,t=null){const n=document.getElementById("whatsapp-connection-container"),o=document.getElementById("request-qr-btn");let s="";switch(e){case"connected":s=`
                    <div class="flex flex-col items-center justify-center h-48 text-green-600">
                        <i data-lucide="check-circle" class="w-16 h-16"></i>
                        <p class="font-bold mt-2">¡Conectado!</p>
                        <p class="text-sm text-slate-500">Tu sesión de WhatsApp está activa.</p>
                    </div>`,o.style.display="none";break;case"loading":s=`
                    <div class="flex justify-center items-center h-48">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-slate-900"></div>
                    </div>`,o.style.display="block";break;case"qr":s=`<img src="data:image/png;base64,${t}" alt="Escanea para conectar WhatsApp" class="mx-auto max-w-xs rounded-lg">`,o.style.display="block";break;case"error":s=`
                    <div class="flex flex-col items-center justify-center h-48 text-red-500">
                         <i data-lucide="alert-triangle" class="w-16 h-16"></i>
                         <p class="font-bold mt-2">Error de Conexión</p>
                    </div>`,o.style.display="block";break;case"initial":default:s=`
                    <div class="flex flex-col items-center justify-center h-48 text-slate-400">
                         <i data-lucide="qr-code" class="w-16 h-16"></i>
                         <p class="font-bold mt-2">Solicita el QR para vincular</p>
                    </div>`,o.style.display="block";break}n.innerHTML=s,lucide.createIcons()}async openAiEnhanceModal(e,t,n="default"){var i;const o=document.getElementById("ai-enhance-modal");if(!o)return;const s=document.getElementById("generate-ai-btn");try{this.aiModalContext=n;const[v,x]=await Promise.all([this.loadUserSubscription(),this.loadUserUsage()]);if(!v)throw new Error("No se pudo cargar la información del plan.");const g=((i=v.plans)==null?void 0:i.ai_enhancements_limit)||0,L=(x==null?void 0:x.ai_enhancements_used)||0,J=g-L;document.getElementById("ai-uses-left").textContent=`${J}/${g}`,s.disabled=J<=0,J<=0&&window.showToast("Has alcanzado tu límite de mejoras con IA este mes.","info"),this.aiModalCallback=t,document.getElementById("ai-original-text").value=e,document.getElementById("ai-prompt-input").value="",document.getElementById("ai-result-container").innerHTML="",document.getElementById("ai-result-container").classList.add("hidden"),s.classList.remove("hidden"),document.getElementById("apply-ai-btn").classList.add("hidden"),document.getElementById("regenerate-ai-btn").classList.add("hidden"),o.classList.remove("hidden")}catch(v){window.showToast(v.message,"error");return}}closeAiModal(){document.getElementById("ai-enhance-modal").classList.add("hidden"),this.aiModalCallback=null}async handleGenerateAi(e=!1){var v;const t=e?document.getElementById("regenerate-ai-btn"):document.getElementById("generate-ai-btn"),n=document.getElementById("generate-ai-btn");t.disabled=!0,t.textContent="Generando...";const o=document.getElementById("ai-original-text").value,s=document.getElementById("ai-prompt-input").value;let i;this.aiModalContext==="designer"?i=`Eres un asistente de diseño experto. Mejora la siguiente descripción para un prompt de generación de imágenes. Sé creativo y visual.
            - NO uses placeholders como '%nombre%'.
            - Devuelve ÚNICAMENTE la descripción mejorada.
            ${s?`Considera esta instrucción adicional del usuario: '${s}'.`:""}`:i=`Eres un asistente de marketing experto en WhatsApp. Reescribe el siguiente texto para que sea más efectivo y profesional, manteniendo el tono y la intención original.
            - El único placeholder permitido es '%nombre%'. Mantenlo exactamente como está. NO inventes otros placeholders como '%empresa%'.
            - NO añadas saludos, despedidas, ni firmes con "[Tu Nombre]", etc. Devuelve ÚNICamente el texto mejorado.
            ${s?`Considera esta instrucción adicional del usuario: '${s}'.`:""}`;try{const{data:x,error:g}=await window.auth.sb.functions.invoke("openai-proxy",{body:{type:"text",prompt:i,text:o,userId:this.user.id}});if(g)throw g;const L=await this.loadUserUsage(),J=((v=(await this.loadUserSubscription()).plans)==null?void 0:v.ai_enhancements_limit)||0,te=(L==null?void 0:L.ai_enhancements_used)||0;document.getElementById("ai-uses-left").textContent=`${J-te}/${J}`;const R=document.getElementById("ai-result-container");R.textContent=x.result||"La IA no devolvió un resultado válido.",R.classList.remove("hidden"),n.classList.add("hidden"),document.getElementById("apply-ai-btn").classList.remove("hidden"),document.getElementById("regenerate-ai-btn").classList.remove("hidden")}catch(x){/limit/i.test(x.message)||window.showToast("No se pudo generar la mejora. Revisa la consola.","error")}finally{t.disabled=!1,t.textContent=e?"Reintentar":"Mejorar Texto"}}handleApplyAi(){const e=document.getElementById("ai-result-container").textContent;this.aiModalCallback&&this.aiModalCallback(e),this.closeAiModal()}}class ct{constructor(e){this.app=e,this.iti=null,this.currentStep=1,this.totalSteps=4,this.modal=document.getElementById("wizard-modal"),this.prevBtn=document.getElementById("wizard-prev-btn"),this.nextBtn=document.getElementById("wizard-next-btn"),this.finishBtn=document.getElementById("wizard-finish-btn"),this.closeBtn=document.getElementById("close-wizard-btn"),this.stepIndicator=document.getElementById("wizard-step-indicator"),this.companyForm=document.getElementById("wizard-company-form"),this.qrContainer=document.getElementById("wizard-qr-container"),this.requestQrBtn=document.getElementById("wizard-request-qr-btn"),this.syncContactsBtn=document.getElementById("wizard-sync-contacts-btn"),this.setupListeners()}setupListeners(){var e,t,n,o;this.prevBtn.addEventListener("click",()=>this.changeStep(-1)),this.nextBtn.addEventListener("click",()=>this.changeStep(1)),this.finishBtn.addEventListener("click",()=>this.finish()),this.closeBtn.addEventListener("click",()=>this.hide()),(e=this.requestQrBtn)==null||e.addEventListener("click",()=>this.app.checkWhatsappConnection(!0)),(t=this.syncContactsBtn)==null||t.addEventListener("click",()=>this.handleSyncClick()),(n=this.modal.querySelector("#wizard-upload-logo-btn"))==null||n.addEventListener("click",()=>this.modal.querySelector("#wizard-logo-input").click()),(o=this.modal.querySelector("#wizard-logo-input"))==null||o.addEventListener("change",s=>this.previewLogo(s.target.files[0]))}start(e=!1){this.currentStep=e?4:1,this.updateStepUI(),e||this.loadExistingCompanySettings(),this.modal.classList.remove("hidden"),document.body.classList.add("overflow-hidden")}hide(){this.modal.classList.add("hidden"),document.body.classList.remove("overflow-hidden")}changeStep(e){if(this.currentStep===3&&e>0){this.handleSettingsSave();return}const t=this.currentStep+e;t>=1&&t<=this.totalSteps&&(this.currentStep=t,this.updateStepUI())}updateStepUI(){this.modal.querySelectorAll(".wizard-step").forEach(t=>t.classList.add("hidden"));const e=document.getElementById(`wizard-step-${this.currentStep}`);e&&e.classList.remove("hidden"),this.prevBtn.disabled=this.currentStep===1,this.nextBtn.classList.toggle("hidden",this.currentStep>=this.totalSteps),this.finishBtn.classList.toggle("hidden",this.currentStep!==this.totalSteps),this.currentStep===3?this.nextBtn.innerHTML="Guardar y Seguir":this.nextBtn.innerHTML="Siguiente",this.stepIndicator.textContent=`Paso ${this.currentStep} de ${this.totalSteps}`}previewLogo(e){if(!e||!this.modal)return;const t=this.modal.querySelector("#wizard-logo-preview"),n=new FileReader;n.onload=o=>{t.src=o.target.result},n.readAsDataURL(e)}async loadExistingCompanySettings(){var e,t;try{if(!this.companyForm)return;const{data:n,error:o}=await window.auth.sb.from("profiles").select("work_start_hour, work_end_hour, company_description, website, social_media, branding_settings, contact_phone").single();if(o&&o.code!=="PGRST116")throw o;if(!n)return;n.work_start_hour&&(this.companyForm.querySelector("#wizard-work-start-hour").value=`${String(n.work_start_hour).padStart(2,"0")}:00`),n.work_end_hour&&(this.companyForm.querySelector("#wizard-work-end-hour").value=`${String(n.work_end_hour).padStart(2,"0")}:00`),n.company_description&&(this.companyForm.querySelector("#wizard-company-description").value=n.company_description),n.website&&(this.companyForm.querySelector("#wizard-website").value=n.website),n.social_media&&(this.companyForm.querySelector("#wizard-social-instagram").value=n.social_media.instagram||"",this.companyForm.querySelector("#wizard-social-facebook").value=n.social_media.facebook||""),(e=n.branding_settings)!=null&&e.logo_url&&(this.companyForm.querySelector("#wizard-logo-preview").src=n.branding_settings.logo_url),(t=n.branding_settings)!=null&&t.colors&&n.branding_settings.colors.forEach((s,i)=>{const v=this.companyForm.querySelector(`#wizard-brand-color-${i+1}`);v&&(v.value=s)}),n.contact_phone&&this.iti&&this.iti.setNumber(n.contact_phone)}catch(n){console.error("Error al precargar datos de la empresa en el wizard:",n)}}async handleSettingsSave(){var e;this.nextBtn.disabled=!0,this.nextBtn.innerHTML='<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';try{const t=this.companyForm.querySelector("#wizard-logo-input").files[0];let n=(e=this.companyForm.querySelector("#wizard-logo-preview"))==null?void 0:e.src;t&&(n=await this.app.uploadAsset(t,"logos"));const o={logo_url:n.startsWith("https")?n:null,colors:Array.from({length:4},(L,J)=>this.companyForm.querySelector(`#wizard-brand-color-${J+1}`).value)},s=this.companyForm.querySelector("#wizard-work-start-hour").value,i=this.companyForm.querySelector("#wizard-work-end-hour").value,v=this.companyForm.querySelector("#wizard-admin-phone-input").value.trim()||null,x={work_start_hour:s?parseInt(s.split(":")[0]):null,work_end_hour:i?parseInt(i.split(":")[0]):null,company_description:this.companyForm.querySelector("#wizard-company-description").value,website:this.companyForm.querySelector("#wizard-website").value,social_media:{instagram:this.companyForm.querySelector("#wizard-social-instagram").value,facebook:this.companyForm.querySelector("#wizard-social-facebook").value},contact_phone:v,branding_settings:o},{error:g}=await window.auth.sb.from("profiles").update(x).eq("id",this.app.user.id);if(g)throw g;window.showToast("Información de la empresa guardada.","success"),this.currentStep++,this.updateStepUI()}catch(t){console.error("Error al guardar configuración desde el wizard:",t),window.showToast("No se pudo guardar la información de la empresa.","error")}finally{this.nextBtn.disabled=!1,this.nextBtn.innerHTML="Guardar y Seguir"}}async handleSyncClick(){const e=this.syncContactsBtn;if(!e||e.disabled)return;const t=e.innerHTML;e.disabled=!0,e.innerHTML='<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>';try{const n=this.app.user.id;if(!(await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/sync-labels-final",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:n})})).ok)throw new Error("La solicitud al webhook de sincronización falló.");window.showToast("Sincronización iniciada. Esto puede tardar unos minutos.","info"),setTimeout(()=>{e.disabled=!1,e.innerHTML=t},6e4)}catch(n){console.error("Error al iniciar la sincronización desde el wizard:",n),window.showToast("No se pudo iniciar la sincronización.","error"),e.disabled=!1,e.innerHTML=t}}async finish(){this.modal.querySelectorAll(".wizard-step").forEach(e=>e.classList.add("hidden")),document.getElementById("wizard-step-5").classList.remove("hidden"),document.getElementById("wizard-loading").classList.remove("hidden"),document.getElementById("wizard-success").classList.add("hidden"),this.prevBtn.parentElement.classList.add("hidden");try{const e=new FormData(this.qaForm),t=Object.fromEntries(e.entries()),n=this.buildPromptFromAnswers(t),o='Eres un experto en crear prompts para asistentes de IA de WhatsApp. A partir de la siguiente información proporcionada por un usuario, reestructura y mejora el texto para crear un "system prompt" claro, conciso y poderoso. El prompt final debe ser fácil de entender para un modelo de lenguaje grande (como GPT) y debe guiarlo para que actúe como el asistente perfecto para ese negocio. Mantén el idioma original de las respuestas. Devuelve ÚNICAMENTE el prompt mejorado, sin saludos ni explicaciones adicionales.',{data:s,error:i}=await window.auth.sb.functions.invoke("openai-proxy",{body:{type:"text",prompt:o,text:n,userId:this.app.user.id}});if(i)throw i;const v=s.result,x=document.getElementById("ai-master-prompt");x.value=v,await this.app.handlePromptSave(new Event("submit",{cancelable:!0})),document.getElementById("wizard-loading").classList.add("hidden"),document.getElementById("wizard-success").classList.remove("hidden"),setTimeout(()=>this.hide(),4e3)}catch(e){console.error("Error al finalizar el wizard:",e),window.showToast("No se pudo generar el prompt. Inténtalo de nuevo.","error"),this.currentStep=4,this.updateStepUI(),this.prevBtn.parentElement.classList.remove("hidden")}}buildPromptFromAnswers(e){let t=`Eres un asistente de ventas y atención al cliente para WhatsApp.

`;return e.negocio&&(t+=`**Información del Negocio:**
- Nombre y Actividad: ${e.negocio}
`),e.cliente&&(t+=`- Cliente Ideal: ${e.cliente}
`),e.problema&&(t+=`- Problema que resuelve: ${e.problema}
`),e.diferenciador&&(t+=`- Diferenciador clave: ${e.diferenciador}
`),(e.negocio||e.cliente||e.problema||e.diferenciador)&&(t+=`
`),t+=`**Reglas de Comportamiento y Tono:**
`,t+=`- Tono de Comunicación: Debes ser ${e.tono||"amigable y profesional"}.
`,e.no_hacer&&(t+=`- Prohibiciones: NUNCA debes ${e.no_hacer}.
`),t+=`
`,t+=`**Procesos y Objetivos:**
`,e.precios&&(t+=`- Gestión de Precios: Cuando te pregunten por precios, debes ${e.precios}.
`),e.info_prospecto&&(t+=`- Calificación de Prospectos: Tu objetivo es obtener la siguiente información de nuevos clientes: ${e.info_prospecto}.
`),t+=`
`,e.info_adicional&&(t+=`**Información Adicional Importante:**
`,t+=`- ${e.info_adicional}

`),t+=`**Instrucciones Finales:**
`,t+=`- Sé siempre breve y claro en tus respuestas.
`,t+=`- Utiliza emojis para hacer la conversación más amigable.
`,t+="- Si no sabes una respuesta, indica que no tienes esa información y que un humano se pondrá en contacto.",t}}Re.prototype.renderWhatsappConnection=function(ae,e=null,t=null){const n={el:document.getElementById("whatsapp-connection-container"),btn:document.getElementById("request-qr-btn")},o={el:document.getElementById("wizard-qr-container"),btn:document.getElementById("wizard-request-qr-btn")},s=[n];o.el&&!document.getElementById("wizard-modal").classList.contains("hidden")&&s.push(o),s.forEach(i=>{if(!i.el)return;let v="";switch(ae){case"connected":v='<div class="flex flex-col items-center justify-center text-green-600 py-4"><i data-lucide="check-circle" class="w-16 h-16"></i><p class="font-bold mt-2">¡Conectado!</p></div>',i.btn&&(i.btn.style.display="none");break;case"loading":v='<div class="flex justify-center items-center min-h-[200px]"><div class="animate-spin rounded-full h-16 w-16 border-b-2 border-slate-900"></div></div>',i.btn&&(i.btn.style.display="block");break;case"qr":v=`<img src="data:image/png;base64,${e}" alt="Escanea para conectar WhatsApp" class="mx-auto max-w-full h-auto rounded-lg">`,i.btn&&(i.btn.style.display="block");break;case"error":v='<div class="flex flex-col items-center justify-center text-red-500 py-4"><i data-lucide="alert-triangle" class="w-16 h-16"></i><p class="font-bold mt-2">Error de Conexión</p></div>',i.btn&&(i.btn.style.display="block");break;case"initial":default:v='<div class="flex flex-col items-center justify-center text-slate-400 py-4"><i data-lucide="qr-code" class="w-16 h-16"></i><p class="font-bold mt-2">Solicita el QR para vincular</p></div>',i.btn&&(i.btn.style.display="block");break}i.el.innerHTML=v}),lucide.createIcons()};Re.prototype.checkWhatsappConnection=async function(ae=!1,e=null){const t=document.getElementById("wizard-modal"),o=t&&!t.classList.contains("hidden")?"wizard-qr-container":null;this.renderWhatsappConnection("loading",null,o);const s=`${this.config.N8N_URL}/webhook/generate-whatsapp-qr-Elina`;try{const i=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:this.user.email})});if(!i.ok)throw new Error("El servidor N8N no responde correctamente.");const v=await i.json(),x=Array.isArray(v)?v[0]:v,g=x!=null&&x.qr_image_data?"qr":"connected";this.renderWhatsappConnection(g,x==null?void 0:x.qr_image_data,o)}catch(i){console.error("Error al solicitar QR:",i),this.renderWhatsappConnection("error",null,o)}};
