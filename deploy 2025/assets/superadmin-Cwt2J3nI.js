import"./auth-COsaJi3Q.js";let x=!1,m=[],f=null,v=null,w=!0,h=!0;const B=new Set;function b(e,a){return!e||e.code!=="PGRST205"?!1:a?(e.message||"").toLowerCase().includes(a.toLowerCase()):!0}function q(e){if(!e)return!1;if(b(e))return!0;const a=(e.message||"").toLowerCase();return a.includes("is_active")||a.includes("column")}function y(e,a){var o;B.has(e)||(B.add(e),console.warn(`[superadmin] ${a}`),(o=window.showToast)==null||o.call(window,a,"warning"))}document.addEventListener("auth:ready",async({detail:e})=>{if(!e||!e.session){window.location.href="/";return}if(x)return;const{data:a,error:o}=await window.auth.sb.from("profiles").select("role").eq("id",e.session.user.id).single();if(o||!a||a.role!=="superadmin"){alert("Acceso denegado. No tienes permisos de superadministrador."),window.location.href="/dashboard.html";return}x=!0,document.getElementById("loader").classList.add("hidden"),document.getElementById("app-container").classList.remove("hidden"),P()});function P(){var e;T(),S(),D(),A(),(e=window.lucide)!=null&&e.createIcons&&window.lucide.createIcons()}function A(){var n;document.getElementById("plans-container").addEventListener("submit",t=>{t.target.classList.contains("plan-form")&&(t.preventDefault(),C(t.target))}),(n=document.getElementById("mobile-menu-btn"))==null||n.addEventListener("click",()=>{const t=document.getElementById("main-sidebar");t==null||t.classList.toggle("hidden")}),document.getElementById("user-search").addEventListener("input",t=>{const l=t.target.value.toLowerCase();document.querySelectorAll("#users-table-body tr").forEach(r=>{const i=r.dataset.email.toLowerCase();r.style.display=i.includes(l)?"":"none"})}),document.getElementById("users-table-body").addEventListener("click",t=>{if(t.target.closest(".change-plan-btn")){const l=t.target.closest(".change-plan-btn");F(l.dataset.userId,l.dataset.userEmail,l.dataset.currentPlan)}if(t.target.closest(".impersonate-btn")){const l=t.target.closest(".impersonate-btn");t.stopPropagation(),j(l.dataset.userId)}}),document.getElementById("cancel-change-plan-btn").addEventListener("click",()=>{document.getElementById("change-plan-modal").classList.add("hidden")}),document.getElementById("confirm-change-plan-btn").addEventListener("click",M);const e=document.getElementById("prompts-form"),a=document.getElementById("prompts-user-select");e&&a&&(e.addEventListener("submit",z),e.addEventListener("input",E),a.addEventListener("change",async t=>{f=t.target.value||null,await I(f)}));const o=document.getElementById("escalations-form"),s=document.getElementById("escalations-user-select");o&&s&&(o.addEventListener("submit",O),s.addEventListener("change",async t=>{v=t.target.value||null,await $(v)}))}async function T(){const e=document.getElementById("plans-container"),{data:a,error:o}=await window.auth.sb.from("plans").select("*");if(o){e.innerHTML='<p class="text-red-400">Error al cargar planes.</p>';return}e.innerHTML=a.map(s=>{var n,t,l,r,i,u,d,c,p,_;return`
        <form class="plan-form bg-slate-800 p-6 rounded-lg border border-slate-700 space-y-4" data-plan-id="${s.id}">
            <h3 class="text-2xl font-bold text-cyan-400">${s.name} (${s.id})</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-slate-400">Stripe Product ID</label>
                    <input type="text" value="${s.stripe_product_id||""}" class="stripe-product-id mt-1 w-full bg-slate-700 border-slate-600 rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-400">Límite Envíos Masivos/mes</label>
                    <input type="number" value="${s.bulk_sends_limit||0}" class="limit-bulk-sends mt-1 w-full bg-slate-700 border-slate-600 rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-400">Límite Mejoras IA/mes</label>
                    <input type="number" value="${s.ai_enhancements_limit||0}" class="limit-ai-enhancements mt-1 w-full bg-slate-700 border-slate-600 rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-400">Límite Imágenes IA/mes</label>
                    <input type="number" value="${s.image_generations_limit||0}" class="limit-image-generations mt-1 w-full bg-slate-700 border-slate-600 rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-400">Límite Videos IA/mes</label>
                    <input type="number" value="${s.video_generations_limit||0}" class="limit-video-generations mt-1 w-full bg-slate-700 border-slate-600 rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-400">Video IA Activo</label>
                    <select class="features-video-ai mt-1 w-full bg-slate-700 border-slate-600 rounded p-2">
                        <option value="true" ${(n=s.features)!=null&&n.video_ai?"selected":""}>Sí</option>
                        <option value="false" ${(t=s.features)!=null&&t.video_ai?"":"selected"}>No</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-400">Límite Videos IA/mes</label>
                    <input type="number" value="${s.video_generations_limit||0}" class="limit-video-generations mt-1 w-full bg-slate-700 border-slate-600 rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-400">Video IA Activo</label>
                    <select class="features-video-ai mt-1 w-full bg-slate-700 border-slate-600 rounded p-2">
                        <option value="true" ${(l=s.features)!=null&&l.video_ai?"selected":""}>Sí</option>
                        <option value="false" ${(r=s.features)!=null&&r.video_ai?"":"selected"}>No</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-400">Límite de Plantillas</label>
                    <input type="number" value="${s.templates_limit||0}" class="limit-templates mt-1 w-full bg-slate-700 border-slate-600 rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-400">Seguimientos Activos</label>
                    <select class="features-follow-ups mt-1 w-full bg-slate-700 border-slate-600 rounded p-2">
                        <option value="true" ${(i=s.features)!=null&&i.follow_ups?"selected":""}>Sí</option>
                        <option value="false" ${(u=s.features)!=null&&u.follow_ups?"":"selected"}>No</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-400">Diseñador IA Activo</label>
                    <select class="features-designer-ai mt-1 w-full bg-slate-700 border-slate-600 rounded p-2">
                        <option value="true" ${(d=s.features)!=null&&d.designer_ai?"selected":""}>Sí</option>
                        <option value="false" ${(c=s.features)!=null&&c.designer_ai?"":"selected"}>No</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-400">Multi-Usuario (Plan Business)</label>
                    <select class="features-multi-user mt-1 w-full bg-slate-700 border-slate-600 rounded p-2">
                        <option value="true" ${(p=s.features)!=null&&p.multi_user?"selected":""}>Sí</option>
                        <option value="false" ${(_=s.features)!=null&&_.multi_user?"":"selected"}>No</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500">Guardar Cambios</button>
        </form>
    `}).join("")}async function C(e){const a=e.dataset.planId,o={stripe_product_id:e.querySelector(".stripe-product-id").value.trim()||null,bulk_sends_limit:parseInt(e.querySelector(".limit-bulk-sends").value)||0,ai_enhancements_limit:parseInt(e.querySelector(".limit-ai-enhancements").value)||0,image_generations_limit:parseInt(e.querySelector(".limit-image-generations").value)||0,video_generations_limit:parseInt(e.querySelector(".limit-video-generations").value)||0,templates_limit:parseInt(e.querySelector(".limit-templates").value)||0,features:{follow_ups:e.querySelector(".features-follow-ups").value==="true",designer_ai:e.querySelector(".features-designer-ai").value==="true",video_ai:e.querySelector(".features-video-ai").value==="true",multi_user:e.querySelector(".features-multi-user").value==="true"}},{error:s}=await window.auth.sb.from("plans").update(o).eq("id",a);alert(s?`Error al guardar el plan ${a}: ${s.message}`:`Plan ${a} actualizado con éxito.`)}async function S(){const e=document.getElementById("users-table-body"),a=document.getElementById("users-loader"),{data:o,error:s}=await window.auth.sb.rpc("get_all_admin_users");if(s){console.error("Error al cargar usuarios:",s),a&&(a.querySelector("td").textContent=`Error al cargar usuarios: ${s.message}`);return}return a&&(a.style.display="none"),m=o??[],U(),e.innerHTML=m.map(n=>{const t={plan_id:n.plan_id||"free_trial",status:n.status||"inactive"};return`
            <tr data-email="${n.email}">
                <td class="p-4">${n.email}</td>
                <td class="p-4"><span class="font-semibold">${t.plan_id}</span></td>
                <td class="p-4"><span class="px-2 py-1 text-xs rounded-full ${t.status==="active"||t.status==="trialing"?"bg-green-500/20 text-green-300":"bg-red-500/20 text-red-300"}">${t.status}</span></td>
                <td class="p-4">
                    <button class="change-plan-btn bg-slate-600 text-white text-sm font-bold py-1 px-3 rounded hover:bg-slate-500"
                            data-user-id="${n.id}"
                            data-user-email="${n.email}"
                            data-current-plan="${t.plan_id}">
                        Cambiar Plan
                    </button>
                    <button class="impersonate-btn bg-amber-600 text-white text-sm font-bold py-1 px-3 rounded hover:bg-amber-500 ml-2"
                            data-user-id="${n.id}"
                            title="Iniciar sesión como este usuario">
                        Suplantar
                    </button>
                </td>
            </tr>
        `}).join(""),lucide.createIcons(),m}async function F(e,a,o){document.getElementById("modal-user-id").value=e,document.getElementById("modal-user-email").textContent=a;const s=document.getElementById("modal-plan-select"),{data:n,error:t}=await window.auth.sb.from("plans").select("id, name");t?(console.error("Error cargando planes para el modal:",t),s.innerHTML='<option value="">Error al cargar</option>'):s.innerHTML=n.map(l=>`<option value="${l.id}">${l.name}</option>`).join(""),s.value=o,document.getElementById("modal-override-payment").checked=!1,document.getElementById("change-plan-modal").classList.remove("hidden")}async function M(){const e=document.getElementById("modal-user-id").value,a=document.getElementById("modal-plan-select").value;if(!document.getElementById("modal-override-payment").checked){alert('Funcionalidad de pago con Stripe aún no implementada. Marca la casilla "Forzar cambio" para asignar el plan manually.');return}const s=document.getElementById("confirm-change-plan-btn");s.disabled=!0,s.textContent="Guardando...";try{if(a==="business"){const{error:n}=await window.auth.sb.rpc("create_business_team_for_user",{p_user_id:e});if(n)throw new Error(`Error al crear el equipo y asignar el plan: ${n.message}`)}else{let n="active",t;if(a==="free_trial"){n="trialing";const r=new Date;r.setDate(r.getDate()+7),t=r.toISOString()}else t=new Date().toISOString();const{error:l}=await window.auth.sb.from("subscriptions").upsert({user_id:e,plan_id:a,status:n,trial_ends_at:t,stripe_subscription_id:null},{onConflict:"user_id"});if(l)throw l}alert("Plan del usuario actualizado con éxito."),document.getElementById("change-plan-modal").classList.add("hidden"),S()}catch(n){alert(`Error al cambiar el plan: ${n.message}`)}finally{s.disabled=!1,s.textContent="Guardar Cambio"}}async function j(e){var a,o;if(!(!e||!confirm("¿Estás seguro de que quieres iniciar sesión como este usuario? Tu sesión actual de superadmin se guardará.")))try{const{data:{session:s},error:n}=await window.auth.sb.auth.getSession();if(n)throw n;if(!(s!=null&&s.access_token)||!(s!=null&&s.refresh_token))throw new Error("No se pudo recuperar la sesión del superadmin.");localStorage.setItem("superadmin_session_tokens",JSON.stringify({access_token:s.access_token,refresh_token:s.refresh_token}));const{data:t,error:l}=await window.auth.invokeFunction("impersonate-user",{body:{userId:e}});if(l)throw l;if(!((a=t==null?void 0:t.session)!=null&&a.access_token)||!((o=t==null?void 0:t.session)!=null&&o.refresh_token))throw new Error("La función de suplantación no devolvió credenciales válidas.");await window.auth.sb.auth.setSession({access_token:t.session.access_token,refresh_token:t.session.refresh_token}),localStorage.setItem("impersonated_user_info",JSON.stringify({id:t.targetUserId,email:t.targetUserEmail})),window.location.href="/dashboard.html"}catch(s){alert(`Error al suplantar usuario: ${s.message}`)}}function D(){E()}function U(){const e=document.getElementById("prompts-user-select"),a=document.getElementById("escalations-user-select"),o=m.length>0,s=o?['<option value="">Selecciona un usuario...</option>',...m.map(n=>`<option value="${n.id}">${n.email}</option>`)].join(""):'<option value="">No hay usuarios disponibles</option>';if(e){const n=e.value;e.innerHTML=s,n&&m.some(t=>t.id===n)?e.value=n:o&&(e.value=m[0].id),f=e.value||null,I(f)}if(a){const n=a.value;a.innerHTML=s,n&&m.some(t=>t.id===n)?a.value=n:o&&(a.value=m[0].id),v=a.value||null,$(v)}}function k(){var l,r,i,u,d,c;const e=((l=document.getElementById("promo-title"))==null?void 0:l.value.trim())??"",a=((r=document.getElementById("promo-copy"))==null?void 0:r.value.trim())??"",o=((i=document.getElementById("promo-objections"))==null?void 0:i.value.trim())??"",s=((u=document.getElementById("promo-hooks"))==null?void 0:u.value.trim())??"",n=((d=document.getElementById("promo-expiry"))==null?void 0:d.value)||null,t=((c=document.getElementById("promo-is-active"))==null?void 0:c.checked)??!0;return{title:e,is_active:t,prompt:{promotion:a||null,objections:o||null,hooks:s||null,expiry:n}}}function E(){const e=document.getElementById("promo-json");if(!e)return;const a=k();e.value=JSON.stringify(a,null,2)}function g(e){const a=document.getElementById("prompts-form");a&&a.querySelectorAll("input, textarea, button").forEach(o=>{o.disabled=e})}function L(e){const a=document.getElementById("escalations-form");a&&a.querySelectorAll("input, textarea, button").forEach(o=>{o.disabled=e})}async function N(e){if(!w)return null;const a="id,user_id,title,prompt,is_active,updated_at",o=window.auth.sb,s=()=>o.from("sales_prompts").select(a).eq("user_id",e).eq("is_active",!0).order("updated_at",{ascending:!1}).limit(1);let{data:n,error:t}=await s();if(t&&q(t)&&({data:n,error:t}=await o.from("sales_prompts_active").select("id,user_id,title,prompt,updated_at").eq("user_id",e).limit(1)),t&&b(t,"sales_prompts_active"))return w=!1,g(!0),y("sales_prompts","El contexto de ventas requiere la migración que crea la tabla/view de sales_prompts."),null;if(t)throw t;return(n==null?void 0:n[0])??null}async function I(e){var i,u,d,c,p;const a=document.getElementById("promo-title"),o=document.getElementById("promo-copy"),s=document.getElementById("promo-objections"),n=document.getElementById("promo-hooks"),t=document.getElementById("promo-expiry"),l=document.getElementById("promo-is-active");if(!e||!a){g(!0),a&&(a.value=""),o&&(o.value=""),s&&(s.value=""),n&&(n.value=""),t&&(t.value=""),l&&(l.checked=!0),E();return}g(!0);let r=null;try{r=await N(e)}catch(_){console.error("Error al cargar contexto de ventas:",_),(i=window.showToast)==null||i.call(window,"Error al cargar contexto de ventas","error")}a.value=(r==null?void 0:r.title)??"",o.value=((u=r==null?void 0:r.prompt)==null?void 0:u.promotion)??"",s.value=((d=r==null?void 0:r.prompt)==null?void 0:d.objections)??"",n.value=((c=r==null?void 0:r.prompt)==null?void 0:c.hooks)??"",t.value=((p=r==null?void 0:r.prompt)==null?void 0:p.expiry)??"",l&&(l.checked=(r==null?void 0:r.is_active)??!0),w&&g(!1),E()}async function z(e){var o,s,n;if(e.preventDefault(),!f){(o=window.showToast)==null||o.call(window,"Selecciona un usuario primero","error");return}const a=k();try{g(!0);const{error:t}=await window.auth.sb.from("sales_prompts").update({is_active:!1}).eq("user_id",f);if(t){if(b(t,"sales_prompts")){w=!1,y("sales_prompts","El contexto de ventas requiere la migración que crea la tabla sales_prompts.");return}throw t}const{error:l}=await window.auth.sb.from("sales_prompts").insert({user_id:f,title:a.title||"Contexto sin título",prompt:a.prompt,is_active:a.is_active});if(l){if(b(l,"sales_prompts")){w=!1,y("sales_prompts","El contexto de ventas requiere la migración que crea la tabla sales_prompts.");return}console.error("Error guardando contexto:",l),(s=window.showToast)==null||s.call(window,`Error: ${l.message}`,"error");return}((n=window.showToast)==null?void 0:n.call(window,"Contexto actualizado","success"))??alert("Contexto actualizado"),await I(f)}finally{g(!1)}}function H(e){return e?e.split(",").map(a=>a.trim()).filter(Boolean):[]}async function $(e){var l;const a=document.getElementById("escalation-phone"),o=document.getElementById("escalation-email"),s=document.getElementById("escalation-labels");if(!e||!a){a&&(a.value=""),o&&(o.value=""),s&&(s.value="");return}if(!h){a.value="",o.value="",s.value="";return}const{data:n,error:t}=await window.auth.sb.from("escalation_settings").select("*").eq("user_id",e).single();if(t){if(b(t,"escalation_settings")){h=!1,L(!0),y("escalations","Las alertas requieren la migración que crea la tabla escalation_settings."),a.value="",o.value="",s.value="";return}if(t.code!=="PGRST116"){console.error("Error al cargar alertas:",t),(l=window.showToast)==null||l.call(window,"Error al cargar alertas","error");return}}a.value=(n==null?void 0:n.notify_phone)??"",o.value=(n==null?void 0:n.notify_email)??"",s.value=Array.isArray(n==null?void 0:n.alert_labels)?n.alert_labels.join(","):""}async function O(e){var l,r,i,u,d,c,p;if(e.preventDefault(),!v){(l=window.showToast)==null||l.call(window,"Selecciona un usuario primero","error");return}if(!h){(r=window.showToast)==null||r.call(window,"Las alertas no están disponibles hasta ejecutar la migración correspondiente.","warning");return}const a=((i=document.getElementById("escalation-phone"))==null?void 0:i.value.trim())||null,o=((u=document.getElementById("escalation-email"))==null?void 0:u.value.trim())||null,s=((d=document.getElementById("escalation-labels"))==null?void 0:d.value)??"",n=H(s),{error:t}=await window.auth.sb.from("escalation_settings").upsert({user_id:v,notify_phone:a,notify_email:o,alert_labels:n});if(t){if(b(t,"escalation_settings")){h=!1,L(!0),y("escalations","Las alertas requieren la migración que crea la tabla escalation_settings.");return}console.error("Error guardando alertas:",t),(c=window.showToast)==null||c.call(window,`Error: ${t.message}`,"error");return}((p=window.showToast)==null?void 0:p.call(window,"Alertas actualizadas","success"))??alert("Alertas actualizadas")}
