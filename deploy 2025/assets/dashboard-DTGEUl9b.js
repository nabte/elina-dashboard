import"./auth-PYTeCFgn.js";class Kt{constructor(){this.file=null,this.iti=null,this.init(),this.insertPlaceholder=this.insertPlaceholder.bind(this),this.openAiModalForBulk=this.openAiModalForBulk.bind(this),this.handleTestSend=this.handleTestSend.bind(this)}init(){document.addEventListener("panel:activated",({detail:e})=>{e.panelId==="bulk-sending"&&this.onPanelActivated()})}onPanelActivated(){console.log("Panel de Envío Masivo activado."),this.checkPrerequisites(),this.setupEventListeners(),this.populateLabelSelectors(),this.initializeScheduleDefaults(),document.addEventListener("profile:updated",()=>this.checkPrerequisites())}async checkPrerequisites(){var p,b,_;const e=document.getElementById("bulk-submit-btn"),t=document.getElementById("bulk-stop-btn");if(!e)return;const n=(b=(p=window.auth.getSession())==null?void 0:p.user)==null?void 0:b.id;if(!n){console.error("No se encontró el ID de usuario para verificar el estado de la campaña.");return}try{const[B,A,N]=await Promise.all([window.auth.sb.from("profiles").select("active_campaign_id, whatsapp_connected").eq("id",n).single(),window.appInstance.loadUserUsage(),window.appInstance.loadUserSubscription()]);if(B.error)throw B.error;const H=B.data,U=A,X=N,Ee=((_=X==null?void 0:X.plans)==null?void 0:_.bulk_sends_limit)||0,me=(U==null?void 0:U.bulk_sends_used)||0;console.log(`[Bulk Sending] Usage: ${me} / ${Ee}`),t&&(H.active_campaign_id?t.classList.remove("hidden"):t.classList.add("hidden")),H.whatsapp_connected?H.active_campaign_id?(e.disabled=!0,e.querySelector(".button-text").textContent="Campaña en progreso..."):me>=Ee?(e.disabled=!0,e.querySelector(".button-text").textContent="Límite de envíos alcanzado"):(e.disabled=!1,e.querySelector(".button-text").textContent="Enviar Campaña"):(e.disabled=!0,e.querySelector(".button-text").textContent="Conecta WhatsApp primero")}catch(B){console.error("Error al verificar pre-requisitos de envío masivo:",B),e.disabled=!0,e.querySelector(".button-text").textContent="Error al verificar"}}setupEventListeners(){var b,_,B,A;const e=document.getElementById("bulk-send-form");if(!e||e.dataset.listenersAttached==="true")return;e.dataset.listenersAttached="true",e.addEventListener("submit",this.handleBulkSend.bind(this));const t=document.getElementById("file-drop-zone"),n=document.getElementById("bulk-file-input"),p=document.getElementById("remove-file-btn");t.addEventListener("click",()=>n.click()),t.addEventListener("dragover",N=>{N.preventDefault(),t.classList.add("border-blue-500","bg-blue-50")}),t.addEventListener("dragleave",()=>t.classList.remove("border-blue-500","bg-blue-50")),t.addEventListener("drop",N=>{N.preventDefault(),t.classList.remove("border-blue-500","bg-blue-50"),N.dataTransfer.files.length&&this.handleFileSelect(N.dataTransfer.files[0])}),n.addEventListener("change",N=>{N.target.files.length&&this.handleFileSelect(N.target.files[0])}),p.addEventListener("click",()=>this.removeFile()),(b=document.getElementById("personalize-name-btn"))==null||b.addEventListener("click",this.insertPlaceholder),(_=document.getElementById("bulk-test-btn"))==null||_.addEventListener("click",this.handleTestSend),(B=document.getElementById("bulk-stop-btn"))==null||B.addEventListener("click",this.handleStopCampaign.bind(this)),(A=document.getElementById("bulk-ai-enhance-btn"))==null||A.addEventListener("click",this.openAiModalForBulk)}async handleFileSelect(e){var n;if(e.size>26214400){confirm("Ups, el archivo es muy grande (máximo 25MB). Te recomendamos esta web para reducir el peso de tu archivo.")&&window.open("https://www.iloveimg.com/compress-image","_blank"),this.removeFile();return}this.showUploadProgress(0,"Optimizando archivo...");try{const p=await this.optimizeFile(e);this.file=p;const b=document.getElementById("file-preview"),_=document.getElementById("file-image-preview");document.getElementById("file-name").textContent=p.name,p.type.startsWith("image/")?(_.src=URL.createObjectURL(p),_.classList.remove("hidden")):_.classList.add("hidden"),b.classList.remove("hidden"),document.getElementById("file-drop-zone").classList.add("hidden"),this.hideUploadProgress(),lucide.createIcons()}catch(p){console.error("Error al optimizar archivo:",p),(n=window.showToast)==null||n.call(window,"Error al procesar el archivo. Se usará el archivo original.","warning"),this.file=e,this.hideUploadProgress()}}showUploadProgress(e,t=""){let n=document.getElementById("file-upload-progress");if(!n){n=document.createElement("div"),n.id="file-upload-progress",n.className="mt-4",n.innerHTML=`
                <div class="bg-slate-100 rounded-lg p-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-slate-700" id="upload-progress-text">${t||"Subiendo..."}</span>
                        <span class="text-sm text-slate-500" id="upload-progress-percent">0%</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2">
                        <div id="upload-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            `;const B=document.getElementById("file-preview");B&&B.appendChild(n)}const p=document.getElementById("upload-progress-bar"),b=document.getElementById("upload-progress-percent"),_=document.getElementById("upload-progress-text");p&&(p.style.width=`${e}%`),b&&(b.textContent=`${e}%`),_&&t&&(_.textContent=t),n.classList.remove("hidden")}hideUploadProgress(){const e=document.getElementById("file-upload-progress");e&&e.classList.add("hidden")}async optimizeFile(e){return e.type.startsWith("image/")?await this.compressImage(e):(e.type.startsWith("video/"),e)}async compressImage(e,t=1920,n=1920,p=.85){return new Promise((b,_)=>{const B=new FileReader;B.onload=A=>{const N=new Image;N.onload=()=>{const H=document.createElement("canvas");let U=N.width,X=N.height;if(U>t||X>n){const me=Math.min(t/U,n/X);U=U*me,X=X*me}H.width=U,H.height=X,H.getContext("2d").drawImage(N,0,0,U,X),H.toBlob(me=>{if(!me){_(new Error("Error al comprimir la imagen"));return}const W=e.name,ue=W.substring(0,W.lastIndexOf("."))||W,te=e.type==="image/jpeg"?"jpg":e.type==="image/png"?"png":e.type==="image/webp"?"webp":"jpg",re=`${ue}.${te}`,ne=new File([me],re,{type:e.type,lastModified:Date.now()});b(ne)},e.type,p)},N.onerror=_,N.src=A.target.result},B.onerror=_,B.readAsDataURL(e)})}removeFile(){this.file=null,document.getElementById("bulk-file-input").value="",document.getElementById("file-preview").classList.add("hidden"),document.getElementById("file-image-preview").classList.add("hidden"),document.getElementById("file-drop-zone").classList.remove("hidden")}async populateLabelSelectors(){const e=document.getElementById("include-labels"),t=document.getElementById("exclude-labels");try{const{data:n,error:p}=await window.auth.sb.from("labels").select("name");if(p)throw p;const b=[...new Set(n.map(_=>_.name))].sort();e.innerHTML='<option value="todos">Todos los contactos</option>',b.forEach(_=>e.innerHTML+=`<option value="${_}">${_}</option>`),t.innerHTML='<option value="ninguno">Ninguno</option>',b.forEach(_=>t.innerHTML+=`<option value="${_}">${_}</option>`)}catch(n){console.error("Error al cargar etiquetas para selectores:",n),e.innerHTML="<option>Error al cargar</option>",t.innerHTML="<option>Error al cargar</option>"}}initializeScheduleDefaults(){const e=document.getElementById("bulk-schedule-date");if(e){const t=new Date,n=t.getTimezoneOffset()*6e4,p=new Date(t.getTime()-n).toISOString().split("T")[0];e.min=p}}insertPlaceholder(){const e=document.getElementById("bulk-message"),t=e.selectionStart,n=e.selectionEnd,p=e.value,b="%nombre%";e.value=p.substring(0,t)+b+p.substring(n),e.focus(),e.selectionEnd=t+b.length}openAiModalForBulk(){const e=document.getElementById("bulk-message"),t=e.value;if(!t){alert("Primero escribe un mensaje para poder mejorarlo.");return}window.appInstance.openAiEnhanceModal(t,n=>{e.value=n})}async handleBulkSend(e){var p,b,_;e.preventDefault();const t=e.target.querySelector('button[type="submit"]');t.disabled=!0;const n=t.querySelector(".button-text");n.textContent="Preparando...",t.querySelector(".loading-spinner").classList.remove("hidden");try{const B=window.auth.getSession().user.id,{error:A}=await window.auth.sb.from("profiles").update({active_campaign_id:`campaign_${Date.now()}`}).eq("id",B);if(A)throw new Error(`No se pudo actualizar el estado: ${A.message}`);let N=null;if(this.file){if(n.textContent="Subiendo archivo...",!window.appInstance)throw new Error("La instancia de la aplicación no está lista.");this.showUploadProgress(0,"Subiendo archivo...");try{N=await window.appInstance.uploadAsset(this.file,"bulk-campaigns",be=>{this.showUploadProgress(be,"Subiendo archivo...")}),this.showUploadProgress(100,"Archivo subido correctamente"),setTimeout(()=>this.hideUploadProgress(),1e3)}catch(be){throw this.hideUploadProgress(),be}}const H=document.getElementById("bulk-schedule-date"),U=document.getElementById("bulk-schedule-time"),X=((p=H==null?void 0:H.value)==null?void 0:p.trim())||"",Ee=((b=U==null?void 0:U.value)==null?void 0:b.trim())||"";let me=null,W=null;if(X||Ee){if(!X||!Ee)throw new Error("Si quieres programar la campaña debes seleccionar fecha y hora.");const be=new Date(`${X}T${Ee}`);if(Number.isNaN(be.getTime()))throw new Error("La fecha y hora seleccionadas no son válidas.");if(be.getTime()<=Date.now())throw new Error("Programa la campaña en una fecha y hora futura.");me=be.toISOString();try{W=Intl.DateTimeFormat().resolvedOptions().timeZone}catch{W=null}}n.textContent=me?"Programando campaña...":"Enviando campaña...";const ue={userId:B,message:document.getElementById("bulk-message").value,includeTag:document.getElementById("include-labels").value,excludeTag:document.getElementById("exclude-labels").value,fileUrl:N,scheduledAt:me,scheduledTimezone:W,scheduledDate:X||null,scheduledTime:Ee||null};if(!(await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/masivos-elina",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ue)})).ok)throw new Error("El servidor de automatización (n8n) no respondió correctamente.");alert(me?"¡Campaña programada! La enviaremos automáticamente en la fecha y hora seleccionadas.":"¡Campaña enviada! El proceso se ejecutará en segundo plano. Puedes cerrar esta ventana.");const ne=document.getElementById("bulk-stop-btn");ne&&(ne.classList.remove("hidden"),(_=window.lucide)!=null&&_.createIcons&&window.lucide.createIcons({root:ne})),e.target.reset(),this.removeFile(),H&&(H.value=""),U&&(U.value="")}catch(B){console.error("Error al enviar la campaña:",B),alert(`Error al enviar la campaña: ${B.message}`);try{const A=window.auth.getSession().user.id;await window.auth.sb.from("profiles").update({active_campaign_id:null}).eq("id",A)}catch(A){console.error("Error al limpiar active_campaign_id:",A)}}finally{t.disabled=!1,n.textContent="Enviar Campaña",t.querySelector(".loading-spinner").classList.add("hidden")}}async handleStopCampaign(){var b,_,B,A,N,H;const e=document.getElementById("bulk-stop-btn"),t=document.getElementById("bulk-submit-btn");if(!e||!await((b=window.appModal)==null?void 0:b.confirm("¿Estás seguro de que quieres detener la campaña en progreso? El flujo de n8n se detendrá en la siguiente iteración.","Detener Campaña")))return;e.disabled=!0;const p=((_=e.querySelector("span"))==null?void 0:_.textContent)||"Detener Campaña";e.querySelector("span")&&(e.querySelector("span").textContent="Deteniendo...");try{const U=(A=(B=window.auth.getSession())==null?void 0:B.user)==null?void 0:A.id;if(!U)throw new Error("No se pudo obtener el ID de usuario");const{data:X}=await window.auth.sb.from("profiles").select("active_campaign_id").eq("id",U).single(),{error:Ee}=await window.auth.sb.from("profiles").update({active_campaign_id:null}).eq("id",U);if(Ee)throw Ee;try{if(X!=null&&X.active_campaign_id){const{data:me}=await window.auth.sb.from("campaign_state").select("campaign_id").eq("user_id",U).order("created_at",{ascending:!1}).limit(1).single();if(me!=null&&me.campaign_id){const W="https://n8n-n8n.mcjhhb.easypanel.host",ue=me.campaign_id;try{await fetch(`${W}/api/v1/executions/${ue}`,{method:"DELETE",headers:{"Content-Type":"application/json"}})}catch{console.log("No se pudo cancelar la ejecución directamente, pero el workflow se detendrá automáticamente")}}}}catch(me){console.log("Error al intentar cancelar ejecución:",me)}if(e.classList.add("hidden"),t){t.disabled=!1;const me=t.querySelector(".button-text");me&&(me.textContent="Enviar Campaña")}(N=window.showToast)==null||N.call(window,"Campaña detenida. El flujo se detendrá en la siguiente iteración.","success")}catch(U){console.error("Error al detener la campaña:",U),(H=window.showToast)==null||H.call(window,"Error al detener la campaña: "+(U.message||"Error desconocido"),"error")}finally{e.disabled=!1,e.querySelector("span")&&(e.querySelector("span").textContent=p)}}handleTestSend(){if(document.getElementById("test-send-modal").classList.remove("hidden"),!this.iti){const t=document.querySelector("#test-phone-input");this.iti=window.intlTelInput(t,{utilsScript:"https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",initialCountry:"mx",separateDialCode:!0}),document.getElementById("cancel-test-send-btn").addEventListener("click",()=>this.closeTestModal()),document.getElementById("confirm-test-send-btn").addEventListener("click",()=>this.executeTestSend())}}closeTestModal(){document.getElementById("test-send-modal").classList.add("hidden"),document.getElementById("test-phone-error").classList.add("hidden")}async executeTestSend(){if(!this.iti.isValidNumber()){document.getElementById("test-phone-error").classList.remove("hidden");return}document.getElementById("test-phone-error").classList.add("hidden");const e=this.iti.getNumber(),t=document.getElementById("confirm-test-send-btn");t.disabled=!0,t.textContent="Enviando...";try{const n=window.auth.getSession().user.id,p=document.getElementById("bulk-message").value.replace("%nombre%","Prueba");let b=null;if(this.file){if(!window.appInstance)throw new Error("La instancia de la aplicación no está lista.");this.showUploadProgress(0,"Subiendo archivo...");try{b=await window.appInstance.uploadAsset(this.file,"bulk-tests",N=>{this.showUploadProgress(N,"Subiendo archivo...")}),this.showUploadProgress(100,"Archivo subido correctamente"),setTimeout(()=>this.hideUploadProgress(),1e3)}catch(N){throw this.hideUploadProgress(),N}}if(!(await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/masivos-test-elina",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:n,testNumber:e,message:p,fileUrl:b})})).ok)throw new Error("El servidor no respondió correctamente.");alert(`Mensaje de prueba enviado a ${e}.`)}catch(n){console.error("Error en envío de prueba:",n),alert(`Error al enviar la prueba: ${n.message}`)}finally{t.disabled=!1,t.textContent="Enviar Prueba",this.closeTestModal()}}}new Kt;(function(){let z=!1,e=null,t=null,n=[],p=[],b=[],_=[],B=[],A="contacts",N=null,H=null;function U(C){var ee,de,Le;const T=(ee=window.appInstance)==null?void 0:ee.teamInfo;if((T==null?void 0:T.user_role)!=="advisor")return null;const R=((de=T==null?void 0:T.permissions)==null?void 0:de.label_filters)||((Le=T==null?void 0:T.permissions)==null?void 0:Le.labelFilters),K=R==null?void 0:R[C];return!Array.isArray(K)||K.length===0?null:K.filter(Boolean)}let X=null,Ee={current:!1},me={current:null},W=[],ue=[],te=null,re=null;document.addEventListener("panel:activated",({detail:C})=>{var T;C.panelId==="chats"?(z||ne(),(T=C.options)!=null&&T.contactId&&setTimeout(()=>D(C.options.contactId),200)):E()});async function ne(){var R,K,ee;console.log("Inicializando panel de Chats..."),z=!0,be(),(R=window.lucide)!=null&&R.createIcons&&lucide.createIcons();const C=(ee=(K=window.auth.getSession())==null?void 0:K.user)==null?void 0:ee.id;n=await window.auth.sb.from("labels").select("*").eq("user_id",C).then(de=>de.data||[]),await qe(),await Y();const T=document.querySelector("#chat-contacts-list .contact-item, #chat-contacts-list .group-item");T&&T.click()}function be(){var de,Le,Te,De,xe,Me,ze,He,Fe,We,Ze,ot,dt,gt,lt,pt,wt,ht;(de=document.getElementById("chat-contacts-list"))==null||de.addEventListener("click",Ke=>{const ut=Ke.target.closest(".contact-item"),Ye=Ke.target.closest(".group-item");if(ut){document.querySelectorAll(".contact-item, .group-item").forEach(Xe=>{Xe&&Xe.classList&&Xe.classList.remove("bg-slate-200")}),ut&&ut.classList&&ut.classList.add("bg-slate-200");const ct=ut.dataset.contactId;ut.dataset.contactName,ut.dataset.contactPhone,A="contacts",D(ct)}else if(Ye){document.querySelectorAll(".contact-item, .group-item").forEach(Xe=>{Xe&&Xe.classList&&Xe.classList.remove("bg-slate-200")}),Ye&&Ye.classList&&Ye.classList.add("bg-slate-200");const ct=Ye.dataset.groupId;Ye.dataset.groupName,A="groups",c(ct)}}),(Le=document.getElementById("toggle-contacts-btn"))==null||Le.addEventListener("click",()=>Ie()),(Te=document.getElementById("toggle-groups-btn"))==null||Te.addEventListener("click",()=>_e()),(De=document.getElementById("sync-groups-btn"))==null||De.addEventListener("click",ae),(xe=document.getElementById("chat-input-form"))==null||xe.addEventListener("submit",r);const C=document.getElementById("chat-message-input");C==null||C.addEventListener("input",i),C==null||C.addEventListener("keydown",Ke=>{Ke.key==="Enter"&&!Ke.shiftKey&&(Ke.preventDefault(),r(Ke))}),(Me=document.getElementById("chat-contact-info-toggle"))==null||Me.addEventListener("click",()=>ce()),(ze=document.getElementById("info-ignore-ia-toggle"))==null||ze.addEventListener("change",O),(He=document.getElementById("info-group-ai-toggle"))==null||He.addEventListener("change",m),(Fe=document.getElementById("info-manage-labels-btn"))==null||Fe.addEventListener("click",Be),(We=document.getElementById("chat-search-input"))==null||We.addEventListener("input",L),(Ze=document.getElementById("resume-conversation-btn"))==null||Ze.addEventListener("click",s),document.getElementById("chat-contact-info-panel");const T=document.getElementById("chat-info-overlay");T&&T.addEventListener("click",()=>ce(!1));const R=document.getElementById("back-to-chats-btn");R&&R.addEventListener("click",()=>ce(!1)),(ot=document.getElementById("chat-attach-file-btn"))==null||ot.addEventListener("click",()=>{var Ke;(Ke=document.getElementById("chat-file-input"))==null||Ke.click()}),(dt=document.getElementById("chat-file-input"))==null||dt.addEventListener("change",Ke=>{Ke.target.files&&Ke.target.files[0]&&j(Ke.target.files[0])}),(gt=document.getElementById("chat-remove-image-btn"))==null||gt.addEventListener("click",se);const K=document.getElementById("chat-view-main");K&&K.classList&&(K.addEventListener("dragover",Ke=>{Ke.preventDefault(),Ke.stopPropagation(),K&&K.classList&&K.classList.add("bg-blue-50")}),C.addEventListener("paste",F),K.addEventListener("paste",F),K.addEventListener("dragleave",Ke=>{Ke.preventDefault(),Ke.stopPropagation(),K&&K.classList&&K.classList.remove("bg-blue-50")}),K.addEventListener("drop",P)),(lt=document.getElementById("new-chat-btn"))==null||lt.addEventListener("click",fe),(pt=document.getElementById("close-new-chat-modal"))==null||pt.addEventListener("click",ge),(wt=document.getElementById("cancel-new-chat"))==null||wt.addEventListener("click",ge),(ht=document.getElementById("confirm-new-chat"))==null||ht.addEventListener("click",Oe),document.querySelectorAll('input[name="chat-option"]').forEach(Ke=>{Ke.addEventListener("change",Ce)});const ee=document.getElementById("existing-contact-search");ee&&(ee.addEventListener("input",je),ee.addEventListener("focus",je),ee.addEventListener("blur",Ke=>{setTimeout(()=>{const ut=document.getElementById("existing-contact-results");ut&&ut.classList.add("hidden")},200)}))}function ce(C=null){const T=document.getElementById("chat-contact-info-panel");document.getElementById("chat-view-main");const R=document.getElementById("chat-info-overlay");if(!T||!T.classList)return;const K=C===null?!T.classList.contains("open"):!C;T.classList.toggle("hidden",!K),T.classList.toggle("open",K),R&&R.classList&&R.classList.toggle("hidden",!K)}async function Y(){var K,ee;const C=document.getElementById("chat-contacts-list"),T=document.getElementById("contacts-list-loader"),R=document.getElementById("groups-list-loader");if(!(!C||!T)){T&&T.classList&&T.classList.remove("hidden"),R&&R.classList&&R.classList.add("hidden"),T&&(T.textContent="Cargando conversaciones..."),C.innerHTML="";try{const{data:de,error:Le}=await window.auth.sb.rpc("get_recent_contacts").order("last_message_at",{ascending:!1});if(Le)throw Le;const Te=(K=window.appInstance)==null?void 0:K.teamInfo,De=Te==null?void 0:Te.user_role,xe=(ee=Te==null?void 0:Te.profiles)==null?void 0:ee.full_name,Me=Te==null?void 0:Te.allow_all_chats_visibility;let ze=de;if(De==="advisor"){const Fe=U("chats");Fe?ze=de.filter(We=>(We.labels||[]).some(Ze=>Fe.includes(Ze))):xe&&!Me&&(ze=de.filter(We=>(We.labels||[]).includes(xe)))}p=ze;const He=document.getElementById("chat-search-input");He&&He.value.trim()&&L({target:He}),ze.length===0?T&&(T.textContent="No hay conversaciones recientes."):(T&&T.classList&&T.classList.add("hidden"),C.innerHTML=ze.map(Fe=>`
                    <div class="contact-item p-3 flex items-center gap-3 cursor-pointer hover:bg-slate-100 rounded-lg transition-colors"
                         data-contact-id="${Fe.contact_id}" 
                         data-contact-name="${Fe.full_name}"
                         data-contact-phone="${Fe.phone_number}">
                        <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0">
                            ${(Fe.full_name||"?").charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <p class="font-bold truncate">${Fe.full_name||Fe.phone_number}</p>
                            <p class="text-sm text-slate-500 truncate">${(Fe.last_message_content||"").substring(0,40)}...</p>
                        </div>
                    </div>
                `).join(""))}catch(de){console.error("Error al cargar lista de contactos para chat:",de),T.textContent="Error al cargar contactos."}}}function Ie(){A="contacts",N=null,H=null;const C=document.getElementById("toggle-contacts-btn"),T=document.getElementById("toggle-groups-btn"),R=document.getElementById("sync-groups-btn");C&&C.classList&&(C.classList.add("bg-white","text-blue-600","shadow-sm"),C.classList.remove("text-slate-600","hover:bg-slate-50")),T&&T.classList&&(T.classList.remove("bg-white","text-blue-600","shadow-sm"),T.classList.add("text-slate-600","hover:bg-slate-50")),R&&R.classList&&R.classList.add("hidden");const K=document.getElementById("chat-search-input");K&&(K.placeholder="Buscar contacto..."),Y()}function _e(){A="groups",e=null,t=null;const C=document.getElementById("toggle-contacts-btn"),T=document.getElementById("toggle-groups-btn"),R=document.getElementById("sync-groups-btn");T&&T.classList&&(T.classList.add("bg-white","text-blue-600","shadow-sm"),T.classList.remove("text-slate-600","hover:bg-slate-50")),C&&C.classList&&(C.classList.remove("bg-white","text-blue-600","shadow-sm"),C.classList.add("text-slate-600","hover:bg-slate-50")),R&&R.classList&&R.classList.remove("hidden");const K=document.getElementById("chat-search-input");K&&(K.placeholder="Buscar grupo..."),oe()}async function oe(){var K;const C=document.getElementById("chat-contacts-list"),T=document.getElementById("contacts-list-loader"),R=document.getElementById("groups-list-loader");if(!(!C||!R)){T&&T.classList&&T.classList.add("hidden"),R&&R.classList&&R.classList.remove("hidden"),R&&(R.textContent="Cargando grupos..."),C.innerHTML="";try{const{data:ee,error:de}=await window.auth.sb.rpc("get_recent_groups");if(de)throw de;B=ee||[],B.length===0?R&&(R.textContent="No hay grupos disponibles."):(R&&R.classList&&R.classList.add("hidden"),C.innerHTML=B.map(Le=>`
                    <div class="group-item p-3 flex items-center gap-3 cursor-pointer hover:bg-slate-100 rounded-lg transition-colors"
                         data-group-id="${Le.group_id}" 
                         data-group-name="${Le.group_name}">
                        <div class="w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center flex-shrink-0">
                            <i data-lucide="users" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <p class="font-bold truncate">${Le.group_name||"Grupo sin nombre"}</p>
                            <p class="text-sm text-slate-500 truncate">
                                ${Le.participant_count||0} participantes
                                ${Le.last_message_content?" • "+Le.last_message_content.substring(0,30)+"...":""}
                            </p>
                        </div>
                    </div>
                `).join(""),(K=window.lucide)!=null&&K.createIcons&&lucide.createIcons({root:C}))}catch(ee){console.error("Error al cargar lista de grupos:",ee),R.textContent="Error al cargar grupos."}}}async function ae(){var K,ee,de,Le;const C=document.getElementById("sync-groups-btn"),T=document.getElementById("sync-groups-text"),R=C==null?void 0:C.querySelector('i[data-lucide="refresh-cw"]');if(!C){console.error("Botón de sincronización no encontrado");return}C.disabled=!0,T&&(T.textContent="Sincronizando..."),R&&window.lucide&&R.classList.add("animate-spin");try{const Te=(ee=(K=window.auth.getSession())==null?void 0:K.user)==null?void 0:ee.id;if(!Te)throw new Error("Usuario no autenticado");console.log("Iniciando sincronización de grupos para usuario:",Te);const De={body:{user_id:Te}};console.log("Enviando request a n8n:",De);const xe=await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/sync-groups",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(De)});if(console.log("Respuesta de n8n:",{status:xe.status,statusText:xe.statusText,headers:Object.fromEntries(xe.headers.entries())}),!xe.ok){const ze=await xe.text();console.error("Error response body:",ze);let He;try{He=JSON.parse(ze)}catch{He={message:ze||"Error desconocido"}}throw new Error(He.message||`Error ${xe.status}: ${xe.statusText}`)}const Me=await xe.json();console.log("Resultado de sincronización:",Me),(de=window.showToast)==null||de.call(window,"Grupos sincronizados correctamente","success"),setTimeout(()=>{oe()},1e3)}catch(Te){console.error("Error al sincronizar grupos:",Te),console.error("Stack trace:",Te.stack),(Le=window.showToast)==null||Le.call(window,`Error al sincronizar: ${Te.message}`,"error")}finally{C.disabled=!1,T&&(T.textContent="Sincronizar Grupos"),R&&window.lucide&&R.classList.remove("animate-spin")}}async function D(C){var Te,De;e=C,te=null,E();const{data:T,error:R}=await window.auth.sb.from("contacts").select("*").eq("id",C).single();if(R){console.error("Error buscando contacto:",R);return}t={contact_id:T.id,...T};const K=document.getElementById("chat-history"),ee=document.getElementById("chat-header-name"),de=document.getElementById("chat-view-placeholder"),Le=document.getElementById("chat-view-main");if(!(!K||!ee||!de||!Le)){de&&de.classList&&de.classList.add("hidden"),Le&&Le.classList&&(Le.classList.remove("hidden"),Le.classList.add("flex")),(Te=window.lucide)!=null&&Te.createIcons&&lucide.createIcons({root:Le}),ee.textContent=t.full_name||t.phone_number,K.innerHTML='<p class="text-center text-slate-400">Cargando mensajes...</p>';try{const{data:xe,error:Me}=await window.auth.sb.from("chat_history").select("message_type, content, created_at").eq("contact_id",C).order("created_at",{ascending:!0});if(Me)throw Me;xe.length===0?K.innerHTML='<p class="text-center text-slate-400">Inicia la conversación.</p>':(K.innerHTML="",xe.forEach(ze=>x(ze,!0)),setTimeout(()=>K.scrollTop=K.scrollHeight,0)),(De=window.lucide)!=null&&De.createIcons&&lucide.createIcons({root:K}),G(),y(),g(C),l(C)}catch(xe){console.error("Error al cargar historial de chat:",xe),K.innerHTML='<p class="text-center text-red-500">Error al cargar mensajes.</p>'}}}async function c(C){var De,xe;N=C,e=null,te=null,E();const{data:T,error:R}=await window.auth.sb.from("whatsapp_groups").select("*").eq("id",C).single();if(R){console.error("Error buscando grupo:",R);return}H=T;const K=document.getElementById("chat-history"),ee=document.getElementById("chat-header-name");document.getElementById("chat-group-info");const de=document.getElementById("chat-view-placeholder"),Le=document.getElementById("chat-view-main");if(!K||!ee||!de||!Le)return;de&&de.classList&&de.classList.add("hidden"),Le&&Le.classList&&(Le.classList.remove("hidden"),Le.classList.add("flex")),(De=window.lucide)!=null&&De.createIcons&&lucide.createIcons({root:Le}),ee.textContent=H.group_name||"Grupo sin nombre";const Te=document.getElementById("chat-group-info");Te&&(Te.textContent=`${H.participant_count||0} participantes`,Te.classList&&Te.classList.remove("hidden")),K.innerHTML='<p class="text-center text-slate-400">Cargando mensajes...</p>';try{const{data:Me,error:ze}=await window.auth.sb.from("group_chat_history").select("message_type, content, sender_name, sender_jid, created_at").eq("group_id",C).order("created_at",{ascending:!0});if(ze)throw ze;Me.length===0?K.innerHTML='<p class="text-center text-slate-400">No hay mensajes en este grupo.</p>':(K.innerHTML="",Me.forEach(He=>S(He,!0)),setTimeout(()=>K.scrollTop=K.scrollHeight,0)),(xe=window.lucide)!=null&&xe.createIcons&&lucide.createIcons({root:K}),d(),o()}catch(Me){console.error("Error al cargar historial de grupo:",Me),K.innerHTML='<p class="text-center text-red-500">Error al cargar mensajes del grupo.</p>'}}function o(){var De;if(!H)return;const C=document.getElementById("info-contact-name"),T=document.getElementById("info-contact-phone"),R=document.getElementById("info-contact-labels"),K=document.getElementById("info-manage-labels-container"),ee=document.getElementById("info-contact-razon-ia"),de=document.getElementById("info-chat-files");C&&(C.textContent=H.group_name||"Grupo sin nombre"),T&&(T.textContent=`${H.participant_count||0} participantes`),R&&(R.innerHTML='<span class="text-xs text-slate-400">Las etiquetas no están disponibles para grupos</span>'),K&&(K.innerHTML=""),ee&&(ee.innerHTML="",ee.classList&&ee.classList.add("hidden")),de&&(de.innerHTML="");const Le=document.getElementById("info-ignore-ia-toggle"),Te=document.getElementById("info-group-ai-toggle");if(Le&&Le.parentElement&&(Le.parentElement.style.display="none"),Te)Te.checked=H.ai_enabled!==!1,Te.parentElement&&Te.parentElement.parentElement&&(Te.parentElement.parentElement.style.display="block");else{const xe=document.createElement("div");xe.className="mt-4 pt-4 border-t",xe.innerHTML=`
                <label class="relative inline-flex items-center cursor-pointer">
                    <input 
                        type="checkbox" 
                        id="info-group-ai-toggle" 
                        class="sr-only peer"
                        ${H.ai_enabled!==!1?"checked":""}
                    >
                    <div class="relative w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    <span class="ml-3 text-sm font-medium text-slate-700">IA Habilitada</span>
                </label>
                <p class="text-xs text-slate-500 mt-1">
                    Permite que la IA responda automáticamente a mensajes de este grupo
                </p>
            `;const Me=document.getElementById("chat-contact-info-panel");if(Me){const ze=Me.querySelector(".mt-4.pt-4.border-t");ze&&ze.nextSibling?Me.insertBefore(xe,ze.nextSibling):Me.appendChild(xe),(De=document.getElementById("info-group-ai-toggle"))==null||De.addEventListener("change",m)}}}async function m(C){var K,ee;const T=C.target;if(!N||!H)return;const R=T.checked;try{const{error:de}=await window.auth.sb.from("whatsapp_groups").update({ai_enabled:R}).eq("id",N);if(de)throw de;H.ai_enabled=R,(K=window.showToast)==null||K.call(window,R?"IA habilitada para este grupo":"IA deshabilitada para este grupo","success")}catch(de){console.error("Error al actualizar ai_enabled:",de),T.checked=!R,(ee=window.showToast)==null||ee.call(window,"Error al actualizar configuración","error")}}async function g(C){if(!C)return;const T=typeof C=="string"?parseInt(C,10):C;if(!T||isNaN(T)){console.warn("checkConversationState: contactId inválido:",C);return}try{const{data:R,error:K}=await window.auth.sb.from("conversation_states").select("*").eq("contact_id",T).maybeSingle();if(K){K.code!=="PGRST116"&&K.code!=="42P01"&&console.error("Error al verificar estado de conversación:",K);return}R!=null&&R.is_paused?k(R):f()}catch(R){(R==null?void 0:R.status)!==406&&(R==null?void 0:R.statusCode)!==406&&console.error("Error al verificar estado de pausa:",R)}}function k(C){var Te;const T=document.getElementById("conversation-paused-banner"),R=document.getElementById("pause-reason-text"),K=document.getElementById("chat-message-input"),ee=document.getElementById("chat-send-btn");if(!T||!T.classList)return;T.classList.remove("hidden");const Le={human_request:"Solicitud de atención humana",purchase_intent:"Intención de compra detectada",urgent_attention:"Atención urgente requerida",sensitive_label:"Etiqueta sensible asignada",custom_keyword:"Palabra clave crítica detectada"}[C.pause_reason]||C.pause_reason||"Requiere atención";R&&(R.textContent=`(${Le})`),K&&(K.disabled=!0,K.placeholder="Conversación pausada - Requiere atención humana"),ee&&(ee.disabled=!0),(Te=window.lucide)!=null&&Te.createIcons&&lucide.createIcons({root:T})}function f(){const C=document.getElementById("conversation-paused-banner"),T=document.getElementById("chat-message-input"),R=document.getElementById("chat-send-btn");C&&C.classList&&C.classList.add("hidden"),T&&(T.disabled=!1,T.placeholder="Escribe un mensaje..."),R&&(R.disabled=!1)}let u=null;function l(C){C&&(u&&(window.auth.sb.removeChannel(u),u=null),u=window.auth.sb.channel(`conversation-state-${C}`).on("postgres_changes",{event:"*",schema:"public",table:"conversation_states",filter:`contact_id=eq.${C}`},T=>{var R;console.log("Estado de conversación actualizado:",T),(R=T.new)!=null&&R.is_paused?k(T.new):f()}).subscribe())}async function s(){var T,R,K,ee,de;if(!e)return;const C=document.getElementById("resume-conversation-btn");C&&(C.disabled=!0,C.innerHTML='<div class="animate-spin rounded-full h-4 h-4 border-b-2 border-white"></div>');try{const Le=(R=(T=window.auth.getSession())==null?void 0:T.user)==null?void 0:R.id;if(!Le)throw new Error("Usuario no autenticado");const{data:Te,error:De}=await window.auth.sb.rpc("resume_conversation",{p_contact_id:e,p_resumed_by:Le});if(De)throw De;(K=window.showToast)==null||K.call(window,"Conversación reanudada. La IA puede responder nuevamente.","success"),f()}catch(Le){console.error("Error al reanudar conversación:",Le),(ee=window.showToast)==null||ee.call(window,"Error al reanudar la conversación: "+Le.message,"error")}finally{C&&(C.disabled=!1,C.innerHTML='<i data-lucide="play" class="w-4 h-4"></i> Reanudar',(de=window.lucide)!=null&&de.createIcons&&lucide.createIcons({root:C}))}}async function r(C){var Te,De;C.preventDefault();const T=C.target.closest("form");if(!T)return;const R=document.getElementById("chat-message-input");let K=R.value.trim();if(!K&&!re)return;if(A==="groups"&&N)return w(C,K,re);if(!e)return;const ee=T.querySelector('button[type="submit"]');ee.disabled=!0;const de=ee.innerHTML;let Le=K;R.value="";try{const xe=(De=(Te=window.auth.getSession())==null?void 0:Te.user)==null?void 0:De.id;if(!t)throw new Error("Contacto no encontrado");let Me=null;if(re){if(ee.innerHTML='<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>',Me=await window.appInstance.uploadAsset(re,"chat-files"),!Me)throw new Error("No se pudo subir el archivo.");K||(K="Imagen adjunta")}re&&(ee.innerHTML=de),Le=Me?`${K} ${Me}`:K;const He=await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/manual-send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:xe,contact_id:e,contact_name:t.full_name,phone_number:t.phone_number,message:K,media_url:Me})});if(!He.ok){const ot=await a(He),dt=(ot==null?void 0:ot.message)||await He.text();throw new Error(dt||"El servidor no pudo enviar el mensaje.")}const{data:Fe,error:We}=await window.auth.sb.from("chat_history").insert({user_id:xe,contact_id:e,message_type:"ai",content:Le}).select().limit(1);if(We)throw new Error(`Error guardando el mensaje: ${We.message}`);const Ze=Array.isArray(Fe)?Fe[0]:Fe;x({...Ze||{},message_type:"ai",content:Le,created_at:(Ze==null?void 0:Ze.created_at)||new Date().toISOString(),_localEcho:!0}),ue.push({content:K,expiresAt:Date.now()+5e3})}catch(xe){console.error("Error al enviar mensaje:",xe),window.showToast(`Error al enviar mensaje: ${xe.message}`,"error"),R.value=K}finally{ee.disabled=!1,ee.innerHTML=de,se()}}async function w(C,T,R){var De,xe,Me,ze,He;C.preventDefault();const K=C.target.closest("form");if(!K)return;const ee=document.getElementById("chat-message-input"),de=K.querySelector('button[type="submit"]');de.disabled=!0;const Le=de.innerHTML;let Te=T;ee.value="";try{const Fe=(xe=(De=window.auth.getSession())==null?void 0:De.user)==null?void 0:xe.id;if(!H)throw new Error("Grupo no encontrado");let We=null;if(R){if(de.innerHTML='<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>',We=await window.appInstance.uploadAsset(R,"chat-files"),!We)throw new Error("No se pudo subir el archivo.");T||(T="Imagen adjunta")}if(Te=We?`${T} ${We}`:T,!(await window.auth.sb.from("profiles").select("evolution_instance_name, evolution_api_key").eq("id",Fe).single()).data)throw new Error("No se pudo obtener la configuración de Evolution API");const dt=await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/manual-send-group",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:Fe,group_id:N,group_jid:H.group_jid,message:T,media_url:We})});if(!dt.ok){const wt=await a(dt),ht=(wt==null?void 0:wt.message)||await dt.text();throw new Error(ht||"El servidor no pudo enviar el mensaje.")}const{data:gt,error:lt}=await window.auth.sb.from("group_chat_history").insert({user_id:Fe,group_id:N,message_type:"ai",content:Te,sender_jid:null,sender_name:((He=(ze=(Me=window.appInstance)==null?void 0:Me.user)==null?void 0:ze.user_metadata)==null?void 0:He.full_name)||"Tú",is_from_me:!0}).select().limit(1);if(lt)throw new Error(`Error guardando el mensaje: ${lt.message}`);const pt=Array.isArray(gt)?gt[0]:gt;S({...pt||{},message_type:"ai",content:Te,created_at:(pt==null?void 0:pt.created_at)||new Date().toISOString()})}catch(Fe){console.error("Error al enviar mensaje al grupo:",Fe),window.showToast(`Error al enviar mensaje: ${Fe.message}`,"error"),ee.value=T}finally{de.disabled=!1,de.innerHTML=Le,se()}}async function a(C){try{return await C.json()}catch{return null}}function i(){X&&(Ee.current||(Ee.current=!0,X.track({is_typing:!0})),me.current&&clearTimeout(me.current),me.current=setTimeout(()=>{Ee.current=!1,X.track({is_typing:!1}),me.current=null},2e3))}function y(){var C,T,R;X||!e||(console.log(`Suscribiéndose a mensajes para el contacto ${e}`),X=window.auth.sb.channel(`chat-${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_history",filter:`contact_id=eq.${e}`},K=>{console.log("Nuevo mensaje recibido:",K.new),x(K.new)}).on("presence",{event:"sync"},()=>{if(!X)return;const K=X.presenceState(),ee=[];for(const de in K){const Le=K[de][0];Le.is_typing&&ee.push(Le.name)}W=ee,h()}).subscribe(),X.track({is_typing:!1,name:((R=(T=(C=window.appInstance)==null?void 0:C.user)==null?void 0:T.user_metadata)==null?void 0:R.full_name)||"Agente"}))}function d(){X||!N||(console.log(`Suscribiéndose a mensajes para el grupo ${N}`),X=window.auth.sb.channel(`group-chat-${N}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"group_chat_history",filter:`group_id=eq.${N}`},C=>{console.log("Nuevo mensaje de grupo recibido:",C.new),S(C.new)}).subscribe())}function E(){X&&(console.log("Desuscribiéndose del chat actual."),window.auth.sb.removeChannel(X),X=null),u&&(window.auth.sb.removeChannel(u),u=null)}function h(){const C=document.getElementById("typing-indicator");C&&(W.length>0?C.textContent=`${W.join(", ")} está(n) escribiendo...`:C.textContent="")}function x(C,T=!1){const R=document.getElementById("chat-history");if(!R)return;const K=Date.now(),ee=typeof(C==null?void 0:C.content)=="string"?C.content:"";if(ue=ue.filter(De=>De.expiresAt>K),C.message_type!=="human"&&!T){const De=ue.findIndex(xe=>xe.content===ee&&xe.expiresAt>K);if(De!==-1&&(ue.splice(De,1),!C._localEcho))return}const de=R.querySelector("p");de&&de.textContent.includes("Inicia la conversación")&&de.remove(),$(C.created_at);const Te=`
        <div class="chat-bubble ${C.message_type==="human"?"self-start bg-white":"self-end bg-blue-100"} rounded-lg p-3 max-w-lg lg:max-w-xl shadow-sm space-y-2 break-words">
            ${(()=>{const De=ee.match(/(https?:\/\/\S+\.(?:png|jpg|jpeg|gif|webp|avif|bmp|svg))/i);if(De){const Me=De[0],ze=ee.replace(Me,"").replace(/Imagen:|Media:|Imagen adjunta|Archivo adjunto/ig,"").trim();return`
                        <a href="${Me}" target="_blank" rel="noopener noreferrer" class="block group relative">
                            <img src="${Me}" class="rounded-lg max-w-xs cursor-pointer" alt="Imagen adjunta" loading="lazy">
                        </a>
                        ${ze?`<p class="text-slate-800 text-sm break-words mt-2">${ze.replace(/:$/,"")}</p>`:""}
                    `}return`<p class="text-slate-800">${ee.trim()||"[Mensaje sin contenido]"}</p>`})()}
            <p class="text-xs text-slate-400 text-right mt-1">${new Date(C.created_at).toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"})}</p>
        </div>`;R.insertAdjacentHTML("beforeend",Te),R.scrollTop=R.scrollHeight}function S(C,T=!1){const R=document.getElementById("chat-history");if(!R)return;const K=R.querySelector("p");K&&K.textContent.includes("No hay mensajes")&&K.remove(),$(C.created_at);const ee=C.message_type==="human",de=C.sender_name||"Usuario",Le=`
        <div class="chat-bubble ${ee?"self-start bg-white":"self-end bg-blue-100"} rounded-lg p-3 max-w-lg lg:max-w-xl shadow-sm space-y-2 break-words">
            ${ee?`<p class="text-xs font-semibold text-blue-600 mb-1">${de}</p>`:""}
            ${(()=>{const Te=typeof(C==null?void 0:C.content)=="string"?C.content:"",De=Te.match(/(https?:\/\/\S+\.(?:png|jpg|jpeg|gif|webp|avif|bmp|svg))/i);if(De){const Me=De[0],ze=Te.replace(Me,"").replace(/Imagen:|Media:|Imagen adjunta|Archivo adjunto/ig,"").trim();return`
                        <a href="${Me}" target="_blank" rel="noopener noreferrer" class="block group relative">
                            <img src="${Me}" class="rounded-lg max-w-xs cursor-pointer" alt="Imagen adjunta" loading="lazy">
                        </a>
                        ${ze?`<p class="text-slate-800 text-sm break-words mt-2">${ze.replace(/:$/,"")}</p>`:""}
                    `}return`<p class="text-slate-800">${Te.trim()||"[Mensaje sin contenido]"}</p>`})()}
            <p class="text-xs text-slate-400 text-right mt-1">${new Date(C.created_at).toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"})}</p>
        </div>`;R.insertAdjacentHTML("beforeend",Le),R.scrollTop=R.scrollHeight}function $(C){const T=document.getElementById("chat-history");if(!T||!C)return;const R=new Date(C),K=`${R.getFullYear()}-${String(R.getMonth()+1).padStart(2,"0")}-${String(R.getDate()).padStart(2,"0")}`;if(te===K)return;te=K;const ee=R.toLocaleDateString("es-MX",{day:"numeric",month:"long",year:"numeric"});T.insertAdjacentHTML("beforeend",`
            <div class="my-4 flex justify-center">
                <span class="text-xs text-slate-400 bg-white/90 px-3 py-1 rounded-full shadow-sm">${ee}</span>
            </div>
        `)}function G(){var Me,ze;if(!t)return;const C=document.getElementById("info-group-ai-toggle");C&&C.parentElement&&C.parentElement.parentElement&&(C.parentElement.parentElement.style.display="none");const T=document.getElementById("info-ignore-ia-toggle");T&&T.parentElement&&(T.parentElement.style.display="block");const R=document.getElementById("info-chat-files");if(R){const He=(((Me=p.find(Fe=>Fe.contact_id==e))==null?void 0:Me.chat_history)||[]).map(Fe=>{const Ze=(typeof(Fe==null?void 0:Fe.content)=="string"?Fe.content:"").match(/(https?:\/\/\S+\.(?:png|jpg|jpeg|gif|webp|avif|bmp|svg))/i);return Ze?Ze[0]:null}).filter(Boolean);He.length>0?R.innerHTML=`
                    <h5 class="font-semibold mb-2">Archivos del Chat</h5>
                    <div class="grid grid-cols-3 gap-2">
                        ${He.map(Fe=>`<a href="${Fe}" target="_blank" class="aspect-square bg-slate-200 rounded-md overflow-hidden"><img src="${Fe}" class="w-full h-full object-cover"></a>`).join("")}
                    </div>`:R.innerHTML=""}document.getElementById("info-contact-name").textContent=t.full_name||"Sin nombre",document.getElementById("info-contact-phone").textContent=t.phone_number;const K=He=>He?He.trim().toLowerCase():"";if(T){T.setAttribute("data-contact-id",t.contact_id||t.id||"");const He=(t.labels||[]).some(Fe=>K(Fe)==="ignorar");T.checked=He}const ee=(ze=window.appInstance)==null?void 0:ze.teamInfo,de=(ee==null?void 0:ee.ignored_labels)||[],Le=document.getElementById("info-contact-labels"),Te=t.labels||[];Le.innerHTML=Te.filter(He=>He!=="ignorar"&&!de.includes(He)).map(He=>{const Fe=n.find(ot=>ot.name===He),We=V(Fe==null?void 0:Fe.color),Ze=pe(We);return`<span class="text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full" style="background-color: ${We}; color: ${Ze};">${He}</span>`}).join("")||'<span class="text-xs text-slate-400">Sin etiquetas</span>';const De=document.getElementById("info-contact-razon-ia");De?t!=null&&t.razon_de_label_auto?(De.innerHTML=`<h5 class="font-semibold mb-2">Razón de la IA</h5><p class="text-sm bg-blue-50 p-3 rounded-md text-slate-700">${t.razon_de_label_auto}</p>`,De.classList&&De.classList.remove("hidden")):De.classList&&De.classList.add("hidden"):console.warn("Elemento 'info-contact-razon-ia' no encontrado en el DOM.");const xe=document.getElementById("info-manage-labels-container");xe&&(xe.innerHTML='<button id="info-manage-labels-btn" class="flex items-center gap-2 text-sm text-slate-700 hover:text-blue-600 font-semibold hover:underline mt-3"><i data-lucide="edit" class="w-4 h-4"></i> Gestionar etiquetas</button>',document.getElementById("info-manage-labels-btn").addEventListener("click",Be),lucide.createIcons({root:xe}))}const Z=["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#FF5722","#795548","#9E9E9E","#607D8B"];function V(C){if(typeof C=="string"&&C.startsWith("#"))return C;const T=parseInt(C,10);return!isNaN(T)&&T>=0&&T<Z.length?Z[T]:"#A0AEC0"}function pe(C){return!C||!C.startsWith("#")||(.299*parseInt(C.substring(1,3),16)+.587*parseInt(C.substring(3,5),16)+.114*parseInt(C.substring(5,7),16))/255>.5?"#1e293b":"#ffffff"}function we(C){return C?C.trim().toLowerCase():""}async function ie(C){if(!C)return"Ignorar";try{const{data:T,error:R}=await window.auth.sb.from("labels").select("name").eq("user_id",C).limit(100);if(R)throw R;const K=Array.isArray(T)?T.find(ee=>ee.name&&we(ee.name)==="ignorar"):null;return(K==null?void 0:K.name)||"Ignorar"}catch(T){return console.error("Error al obtener nombre canónico de 'ignorar':",T),"Ignorar"}}async function O(C){var Te,De;const T=C.target;if(!t)return;const R=T.checked,K=(De=(Te=window.auth.getSession())==null?void 0:Te.user)==null?void 0:De.id,ee=new Set(t.labels||[]),de=Array.from(ee);if(ee.clear(),de.forEach(xe=>{we(xe)!=="ignorar"&&ee.add(xe)}),R){const xe=await ie(K);ee.add(xe)}const Le=Array.from(ee);try{const{error:xe}=await window.auth.sb.from("contacts").update({labels:Le}).eq("id",t.contact_id);if(xe)throw xe;t.labels=Le;const{data:Me,error:ze}=await window.auth.sb.from("contacts").select("*").eq("id",t.contact_id).single();if(!ze&&Me){t={contact_id:Me.id,...Me};const He=(Me.labels||[]).some(Fe=>we(Fe)==="ignorar");T.checked=He}}catch(xe){console.error("Error al actualizar la etiqueta 'ignorar':",xe),T.checked=!R}}function Be(){t&&window.contacts.openLabelsModalForSingleContact(t.contact_id)}async function qe(){var C,T;try{const R=(T=(C=window.auth.getSession())==null?void 0:C.user)==null?void 0:T.id;if(!R)return;const{data:K,error:ee}=await window.auth.sb.from("contacts").select("id, full_name, phone_number").eq("user_id",R);if(ee)throw ee;_=(K||[]).map(de=>({id:de.id,full_name:de.full_name,phone_number:de.phone_number}))}catch(R){console.error("Error al cargar contactos para búsqueda:",R),_=[]}}function L(C){const T=C.target.value.trim().toLowerCase(),R=document.getElementById("chat-contacts-list");if(!R)return;if(!T){R.querySelectorAll(".contact-item").forEach(Me=>{Me.style.display="flex"});const xe=document.getElementById("chat-search-results");xe&&xe.remove();return}R.querySelectorAll(".contact-item").forEach(xe=>{xe.style.display="none"});const K=p.filter(xe=>(xe.full_name||"").toLowerCase().includes(T)||(xe.phone_number||"").includes(T)),ee=_.filter(xe=>{const Me=(xe.full_name||"").toLowerCase().includes(T),ze=(xe.phone_number||"").includes(T);return Me||ze}),de=new Set(K.map(xe=>xe.contact_id));ee.filter(xe=>de.has(xe.id));const Le=ee.filter(xe=>!de.has(xe.id)),Te=document.getElementById("chat-search-results");Te&&Te.remove();const De=document.createElement("div");De.id="chat-search-results",De.className="p-2 space-y-2",K.forEach(xe=>{const Me=document.createElement("div");Me.className="contact-item p-3 flex items-center gap-3 cursor-pointer hover:bg-slate-100 rounded-lg transition-colors",Me.setAttribute("data-contact-id",xe.contact_id),Me.setAttribute("data-contact-name",xe.full_name||""),Me.setAttribute("data-contact-phone",xe.phone_number||"");const ze=xe.full_name||xe.phone_number||"Sin nombre";Me.innerHTML=`
                <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0">
                    ${ze.charAt(0).toUpperCase()}
                </div>
                <div class="flex-1 overflow-hidden">
                    <p class="font-bold truncate">${Ae(ze)}</p>
                    <p class="text-sm text-slate-500 truncate">${Ae(xe.phone_number||"")}</p>
                </div>
            `,Me.addEventListener("click",()=>{D(xe.contact_id)}),De.appendChild(Me)}),Le.forEach(xe=>{const Me=document.createElement("div");Me.className="contact-item p-3 flex items-center gap-3 cursor-pointer hover:bg-blue-50 rounded-lg transition-colors border border-blue-200",Me.setAttribute("data-contact-id",xe.id),Me.setAttribute("data-contact-name",xe.full_name||""),Me.setAttribute("data-contact-phone",xe.phone_number||"");const ze=xe.full_name||xe.phone_number||"Sin nombre";Me.innerHTML=`
                <div class="w-10 h-10 bg-slate-400 text-white rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0">
                    ${ze.charAt(0).toUpperCase()}
                </div>
                <div class="flex-1 overflow-hidden">
                    <p class="font-bold truncate">${Ae(ze)}</p>
                    <p class="text-sm text-slate-500 truncate">${Ae(xe.phone_number||"")}</p>
                </div>
                <span class="text-xs text-blue-600 font-semibold">Nuevo</span>
            `,Me.addEventListener("click",async()=>{await D(xe.id),await Y()}),De.appendChild(Me)}),K.length===0&&Le.length===0&&(De.innerHTML=`
                <div class="p-4 text-center text-slate-500">
                    <p>No se encontraron contactos</p>
                </div>
            `),R.insertBefore(De,R.firstChild)}function F(C){if(C.clipboardData&&C.clipboardData.files&&C.clipboardData.files.length>0){const T=C.clipboardData.files[0];T.type.startsWith("image/")&&(C.preventDefault(),j(T))}}function P(C){C.preventDefault(),C.stopPropagation();const T=document.getElementById("chat-view-main");T&&T.classList&&T.classList.remove("bg-blue-50"),C.dataTransfer.files&&C.dataTransfer.files[0]&&j(C.dataTransfer.files[0])}function j(C){if(!C.type.startsWith("image/")){window.showToast("Solo se pueden adjuntar imágenes.","error");return}re=C;const T=document.getElementById("chat-image-preview-container"),R=document.getElementById("chat-image-preview");R&&(R.src=URL.createObjectURL(C)),T&&T.classList&&T.classList.remove("hidden")}function se(){re=null;const C=document.getElementById("chat-file-input");C&&(C.value="");const T=document.getElementById("chat-image-preview-container");T&&T.classList&&T.classList.add("hidden");const R=document.getElementById("chat-image-preview");R&&(R.src="")}async function fe(){const C=document.getElementById("new-chat-modal");!C||!C.classList||(C.classList.remove("hidden"),ye(),await Ue(),document.querySelectorAll('input[name="chat-option"]').forEach(T=>{T.removeEventListener("change",Ce),T.addEventListener("change",Ce)}),lucide.createIcons())}function ge(){const C=document.getElementById("new-chat-modal");C&&C.classList&&C.classList.add("hidden"),ye()}function ye(){const C=document.getElementById("existing-contact-select"),T=document.getElementById("existing-contact-search"),R=document.getElementById("existing-contact-results"),K=document.getElementById("new-contact-phone"),ee=document.getElementById("new-contact-name"),de=document.querySelector('input[name="chat-option"][value="existing"]');C&&(C.value=""),T&&(T.value=""),R&&(R.classList&&R.classList.add("hidden"),R.innerHTML=""),K&&(K.value=""),ee&&(ee.value=""),de&&(de.checked=!0),Ce()}function Ce(){var K;const C=(K=document.querySelector('input[name="chat-option"]:checked'))==null?void 0:K.value,T=document.getElementById("existing-contact-container"),R=document.getElementById("new-contact-container");C==="new"?(T&&T.classList&&T.classList.add("hidden"),R&&R.classList&&R.classList.remove("hidden")):(T&&T.classList&&T.classList.remove("hidden"),R&&R.classList&&R.classList.add("hidden"))}async function Ue(){var C,T;try{const R=(T=(C=window.auth.getSession())==null?void 0:C.user)==null?void 0:T.id;if(!R)return;const{data:K,error:ee}=await window.auth.sb.from("contacts").select("id, full_name, phone_number").eq("user_id",R).order("full_name",{ascending:!0});if(ee)throw ee;b=K||[];const de=document.getElementById("existing-contact-search");de&&de.value.trim()&&je()}catch(R){console.error("Error al cargar contactos:",R)}}function je(){const C=document.getElementById("existing-contact-search"),T=document.getElementById("existing-contact-results"),R=document.getElementById("existing-contact-select");if(!C||!T||!R)return;const K=C.value.trim().toLowerCase();if(!K){T&&T.classList&&T.classList.add("hidden"),T&&(T.innerHTML=""),R&&(R.value="");return}const ee=b.filter(de=>{const Le=(de.full_name||"").toLowerCase(),Te=(de.phone_number||"").toLowerCase();return Le.includes(K)||Te.includes(K)});if(T.innerHTML="",ee.length===0){T&&(T.innerHTML='<div class="p-3 text-sm text-slate-500 text-center">No se encontraron contactos</div>'),T&&T.classList&&T.classList.remove("hidden"),R&&(R.value="");return}ee.forEach(de=>{const Le=de.full_name||de.phone_number||"Sin nombre",Te=document.createElement("div");Te.className="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-100 last:border-b-0",Te.innerHTML=`
                <div class="font-medium text-slate-800">${Ae(Le)}</div>
                <div class="text-xs text-slate-500">${Ae(de.phone_number)}</div>
            `,Te.addEventListener("click",()=>{R&&(R.value=de.id),C&&(C.value=Le),T&&T.classList&&T.classList.add("hidden")}),T.appendChild(Te)}),T&&T.classList&&T.classList.remove("hidden")}function Ae(C){const T=document.createElement("div");return T.textContent=C,T.innerHTML}async function Oe(){var R,K,ee,de,Le,Te,De,xe,Me;const C=(R=document.querySelector('input[name="chat-option"]:checked'))==null?void 0:R.value;let T=null;if(C==="existing"){const ze=document.getElementById("existing-contact-select");if(T=ze==null?void 0:ze.value,!T){(K=window.showToast)==null||K.call(window,"Por favor busca y selecciona un contacto.","error");return}}else{const ze=document.getElementById("new-contact-phone"),He=document.getElementById("new-contact-name"),Fe=(ee=ze==null?void 0:ze.value)==null?void 0:ee.trim(),We=(de=He==null?void 0:He.value)==null?void 0:de.trim();if(!Fe){(Le=window.showToast)==null||Le.call(window,"Por favor ingresa un número de teléfono.","error");return}try{const Ze=window.cleanPhone?window.cleanPhone(Fe):Fe;if(!Ze){(Te=window.showToast)==null||Te.call(window,"Número de teléfono inválido. Debe tener al menos 10 dígitos.","error");return}const ot=(xe=(De=window.auth.getSession())==null?void 0:De.user)==null?void 0:xe.id;if(!ot)throw new Error("No se pudo determinar el usuario actual.");const{data:dt,error:gt}=await window.auth.sb.from("contacts").select("id").eq("user_id",ot).eq("phone_number",Ze).single();if(gt&&gt.code!=="PGRST116")throw gt;if(dt)T=dt.id;else{const{data:lt,error:pt}=await window.auth.sb.from("contacts").insert({user_id:ot,phone_number:Ze,full_name:We||null}).select("id").single();if(pt)throw pt;T=lt.id}}catch(Ze){console.error("Error al crear/buscar contacto:",Ze),(Me=window.showToast)==null||Me.call(window,"Error al procesar el contacto. Intenta nuevamente.","error");return}}ge(),T&&(await D(T),await Y())}})();(function(){var Rt;let z=!1,e=!1,t=[],n=[],p=new Set,b={column:"created_at",direction:"desc"},_=1;const B=50;let A=0,N=null,H=null,U=null,X=null,Ee=null,me=null,W=null,ue=null;const te=(...v)=>console.info("[contacts-import]",...v);function re(v){var Q,J,he;const I=(Q=window.appInstance)==null?void 0:Q.teamInfo;if((I==null?void 0:I.user_role)!=="advisor")return null;const q=((J=I==null?void 0:I.permissions)==null?void 0:J.label_filters)||((he=I==null?void 0:I.permissions)==null?void 0:he.labelFilters),M=q==null?void 0:q[v];return!Array.isArray(M)||M.length===0?null:M.filter(Boolean)}const ne=v=>v==null?"":String(v).trim().toLowerCase();function be(v,I){return ne(v)===ne(I)}function ce(v,I){const q=ne(I);return q?(v||[]).some(M=>ne(M)===q):!1}function Y(v,I){const q=ne(I);return q?(v||[]).filter(M=>ne(M)!==q):v||[]}function Ie(){const v=document.getElementById("contact-label-filter");return v?Array.from(v.selectedOptions||[]).map(I=>I.value):[]}function _e(v,I){const q=ne(v);if(!q)return null;const M=n.find(Q=>ne(Q==null?void 0:Q.name)===q&&(!(Q!=null&&Q.user_id)||!I||Q.user_id===I));return M||n.find(Q=>ne(Q==null?void 0:Q.name)===q)||null}document.addEventListener("panel:activated",({detail:v})=>{v.panelId==="contacts"?(z||oe(),dt()):gt()});function oe(){console.log("Inicializando panel de contactos..."),z=!0,Ze(),P(),O(),qe(),f(),Be(),V(),G(),ae(),document.addEventListener("profile:updated",We)}async function ae(){await o(),await m(),await We()}async function D(v=1){var ke,Pe,Ne,Re;const I=(Pe=(ke=window.auth.getSession())==null?void 0:ke.user)==null?void 0:Pe.id;if(!I)throw new Error("No se pudo obtener el ID del usuario.");_=v;const q=((Ne=document.getElementById("contact-search-input"))==null?void 0:Ne.value.trim())||"",M=Array.from(((Re=document.getElementById("contact-label-filter"))==null?void 0:Re.selectedOptions)||[]).map(Je=>Je.value).filter(Boolean),Q=re("contacts");if(M.length>0&&M[0]!=="")try{const{data:Je,error:et}=await window.auth.sb.rpc("get_filtered_contacts",{p_user_id:I,p_label_filter:M.length>0?M:null,p_search_term:q||null,p_sort_column:b.column,p_sort_direction:b.direction,p_page_number:v,p_page_size:B,p_restricted_labels:Q||null});if(et)throw et;const Ge=Je==null?void 0:Je[0];return Ge?(A=Ge.total_count||0,Ge.contacts||[]):(A=0,[])}catch(Je){console.error("[contacts] Error en get_filtered_contacts, usando método alternativo:",Je)}const J=(_-1)*B,he=J+B-1;let ve=window.auth.sb.from("contacts").select("id, full_name, phone_number, created_at, labels, razon_de_label_auto",{count:"exact"}).eq("user_id",I);q&&(ve=ve.or(`full_name.ilike.%${q}%,phone_number.ilike.%${q}%`)),Q&&(ve=ve.overlaps("labels",Q));const{data:le,error:$e,count:Se}=await ve.order(b.column,{ascending:b.direction==="asc",nullsFirst:!1}).range(J,he);if($e)throw new Error(`No se pudieron cargar contactos: ${$e.message}`);return A=Se||0,le||[]}async function c(){const{data:v,error:I}=await window.auth.sb.from("labels").select("*");if(I)throw new Error(`No se pudieron cargar las etiquetas: ${I.message}`);return v}async function o(){var q,M;const v=["Nuevo cliente","Interesado","No responde"],I=(M=(q=window.auth.getSession())==null?void 0:q.user)==null?void 0:M.id;if(I)try{const{data:Q,error:J}=await window.auth.sb.from("labels").select("name").eq("user_id",I);if(J)throw J;const he=new Set(Q.map(le=>ne(le.name))),ve=v.filter(le=>!he.has(ne(le))).map(le=>({name:le,user_id:I,color:"#848484"}));ve.length>0&&await window.auth.sb.from("labels").insert(ve)}catch(Q){console.error("Error al asegurar etiquetas base:",Q)}}async function m(){var q;const v=document.getElementById("contacts-loader"),I=document.getElementById("contacts-table-body");if(!(!I||!v)){v.style.display="block",v.textContent="Cargando contactos y etiquetas...",I.innerHTML="";try{if([t,n]=await Promise.all([D(1),c()]),te("loadAndRender resolved",{contacts:t.length,labels:n.length}),d(),k(A),!t.length){const M=(q=document.getElementById("contact-search-input"))==null?void 0:q.value.trim();v.textContent=M?"No se encontraron contactos con ese término.":"Aún no tienes contactos. ¡Sincroniza para empezar!",E([]),g();return}v.style.display="none",E(t),g(),h(),lucide.createIcons()}catch(M){console.error(M),v.textContent="Error al cargar contactos. Revisa la consola."}}}function g(){var Q,J;const v=document.getElementById("contacts-pagination");if(!v)return;const I=Math.ceil(A/B);if(I<=1){v.innerHTML="";return}const q=(_-1)*B+1,M=Math.min(_*B,A);v.innerHTML=`
            <span class="text-sm text-slate-600">Mostrando ${q}-${M} de ${A} contactos</span>
            <div class="flex gap-2">
                <button id="prev-page-btn" class="p-2 rounded-md hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed" ${_===1?"disabled":""}><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                <button id="next-page-btn" class="p-2 rounded-md hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed" ${_===I?"disabled":""}><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
            </div>
        `,(Q=document.getElementById("prev-page-btn"))==null||Q.addEventListener("click",()=>L(_-1)),(J=document.getElementById("next-page-btn"))==null||J.addEventListener("click",()=>L(_+1)),lucide.createIcons()}function k(v){const I=document.getElementById("contacts-count-badge");if(I){if(typeof v!="number"){I.classList.add("hidden");return}I.textContent=v.toLocaleString("es-MX"),I.classList.toggle("hidden",v<=0)}}function f(){const v=document.getElementById("export-contacts-btn"),I=document.getElementById("import-contacts-btn"),q=document.getElementById("import-contacts-input");v&&v.addEventListener("click",Q=>{Q.preventDefault(),u(v)}),I&&q&&(I.addEventListener("click",Q=>{Q.preventDefault(),q.click()}),q.addEventListener("change",T));const M=document.getElementById("import-numbers-label-btn");M&&M.addEventListener("click",Q=>{Q.preventDefault(),pt()})}function u(v){Ee?s():l(v)}function l(v){s();const I=v.getBoundingClientRect(),q=document.createElement("div");q.id="contacts-export-menu",q.className="absolute bg-white border border-slate-200 rounded-xl shadow-xl w-56 py-2 z-[260]",q.innerHTML=`
            <button type="button" data-format="csv" class="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 flex items-center gap-2">
                <i data-lucide="file-text" class="w-4 h-4 text-slate-500"></i>
                <span>Exportar como CSV</span>
            </button>
            <button type="button" data-format="xlsx" class="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 flex items-center gap-2">
                <i data-lucide="table" class="w-4 h-4 text-slate-500"></i>
                <span>Exportar como Excel (.xlsx)</span>
            </button>
        `,document.body.appendChild(q);const M=q.getBoundingClientRect(),Q=I.bottom+window.scrollY+8,J=window.scrollX+window.innerWidth-M.width-16;let he=I.left+window.scrollX;he>J&&(he=Math.max(window.scrollX+16,J)),q.style.top=`${Q}px`,q.style.left=`${he}px`,Ee=q,q.querySelectorAll("button[data-format]").forEach(ve=>{ve.addEventListener("click",async()=>{await r(ve.dataset.format)})}),me=ve=>{!q.contains(ve.target)&&ve.target!==v&&s()},W=ve=>{ve.key==="Escape"&&(ve.preventDefault(),s())},ue=()=>s(),document.addEventListener("mousedown",me),document.addEventListener("keydown",W),window.addEventListener("resize",ue),window.addEventListener("scroll",ue,!0),typeof lucide<"u"&&lucide.createIcons&&lucide.createIcons({root:q})}function s(){Ee!=null&&Ee.parentElement&&Ee.parentElement.removeChild(Ee),Ee=null,me&&(document.removeEventListener("mousedown",me),me=null),W&&(document.removeEventListener("keydown",W),W=null),ue&&(window.removeEventListener("resize",ue),window.removeEventListener("scroll",ue,!0),ue=null)}async function r(v="csv"){var Q,J,he,ve,le;const I=document.getElementById("export-contacts-btn");s();const q=window.auth.getSession(),M=(Q=q==null?void 0:q.user)==null?void 0:Q.id;if(!M){(J=window.showToast)==null||J.call(window,"No se pudo obtener tu sesión. Intenta recargar.","error");return}try{I&&(I.disabled=!0,I.classList.add("opacity-60","cursor-wait"));const{data:$e,error:Se}=await window.auth.sb.from("contacts").select("full_name, phone_number, labels, razon_de_label_auto, created_at, assigned_to_id").eq("user_id",M).order("created_at",{ascending:!1});if(Se)throw Se;const ke=w($e||[]);if(!ke.length){(he=window.showToast)==null||he.call(window,"No tienes contactos para exportar.","info");return}v==="xlsx"?i(ke):a(ke),(ve=window.showToast)==null||ve.call(window,"Exportación generada correctamente.","success")}catch($e){console.error("Error al exportar contactos:",$e),(le=window.showToast)==null||le.call(window,`No se pudo exportar: ${$e.message}`,"error")}finally{I&&(I.disabled=!1,I.classList.remove("opacity-60","cursor-wait"))}}function w(v){return v.map(I=>({Nombre:I.full_name||"",Telefono:I.phone_number||"",Etiquetas:Array.isArray(I.labels)?I.labels.join(", "):"","Motivo IA":I.razon_de_label_auto||"","Asignado a":I.assigned_to_id||"","Creado el":I.created_at?new Date(I.created_at).toLocaleString("es-MX"):""}))}function a(v){if(!v.length)return;const I=Object.keys(v[0]),q=[I.join(","),...v.map(Q=>I.map(J=>je(Q[J])).join(","))],M=new Blob([q.join(`
`)],{type:"text/csv;charset=utf-8;"});y(M,`contactos_${new Date().toISOString().slice(0,10)}.csv`)}function i(v){var J;if(typeof XLSX>"u"){(J=window.showToast)==null||J.call(window,"No se encontró la librería XLSX. Se generará un CSV.","info"),a(v);return}const I=XLSX.utils.json_to_sheet(v),q=XLSX.utils.book_new();XLSX.utils.book_append_sheet(q,I,"Contactos");const M=XLSX.write(q,{bookType:"xlsx",type:"array"}),Q=new Blob([M],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});y(Q,`contactos_${new Date().toISOString().slice(0,10)}.xlsx`)}function y(v,I){const q=document.createElement("a"),M=URL.createObjectURL(v);q.href=M,q.download=I,document.body.appendChild(q),q.click(),document.body.removeChild(q),setTimeout(()=>URL.revokeObjectURL(M),1500)}function d(){var ve;if(!X)return;const v=window.auth.getSession(),I=(ve=v==null?void 0:v.user)==null?void 0:ve.id;if(!I)return;const q=Array.from(X.selectedOptions||[]).map(le=>le.value),M=n.filter(le=>(le==null?void 0:le.user_id)===I).map(le=>le.name).filter(Boolean).sort((le,$e)=>le.localeCompare($e,"es",{sensitivity:"base"})),J=['<option value="">Todas las etiquetas</option>',...Array.from(new Set(M)).map(le=>`<option value="${le}">${le}</option>`)].join("");X.innerHTML=J,q.forEach(le=>{const $e=Array.from(X.options).find(Se=>Se.value===le);$e&&($e.selected=!0)}),q.length||(X.value="");const he=X.parentElement;if(he&&(he.classList.add("relative"),!he.querySelector(".contact-label-filter-icon"))){const le=document.createElement("i");le.dataset.lucide="chevron-down",le.className="contact-label-filter-icon absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none",he.appendChild(le),typeof lucide<"u"&&lucide.createIcons&&lucide.createIcons({root:he})}}function E(v){var M,Q;const I=document.getElementById("contacts-table-body");if(!I)return;const q=(Q=(M=window.auth.getSession())==null?void 0:M.user)==null?void 0:Q.id;I.innerHTML=v.map(J=>{const he=(()=>{const le=Y(J.labels,"ignorar");return le.length?le.map($e=>{const Se=_e($e,q),ke=Se?se(Se.color):"#848484",Pe=fe(ke),Ne=((Se==null?void 0:Se.name)||$e||"").trim()||$e;return`<span class="text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full" style="background-color: ${ke}; color: ${Pe};">
                        ${Ne}
                    </span>`}).join(""):'<span class="text-slate-400">-</span>'})(),ve=ce(J.labels,"ignorar");return`
                <tr data-id="${J.id}">
                    <td class="p-4"><input type="checkbox" class="contact-checkbox form-checkbox rounded" data-id="${J.id}"></td>
                    <td class="p-4 font-medium">
                        <div class="contact-name-editable flex items-center gap-2 group" data-contact-id="${J.id}" data-original-name="${J.full_name||""}">
                            <span class="contact-name-display cursor-pointer hover:text-blue-600 hover:underline">${J.full_name||"Sin nombre"}</span>
                            <i data-lucide="edit-2" class="w-3 h-3 text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer"></i>
                            <input type="text" class="contact-name-input hidden border border-blue-500 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" value="${J.full_name||""}" data-contact-id="${J.id}">
                        </div>
                    </td>
                    <td class="p-4 text-slate-600">${J.phone_number||"-"}</td>
                    <td class="p-4 text-sm">
                        ${he}
                    </td>
                    <td class="p-4">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer ignore-ia-toggle" data-contact-id="${J.id}" ${ve?"checked":""}>
                            <div class="relative w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </td>
                    <td class="p-4 text-center">
                        ${J.razon_de_label_auto?`
                            <div class="relative group inline-block">
                                <i data-lucide="brain-circuit" class="w-5 h-5 text-purple-500"></i>
                                <div class="absolute bottom-full mb-2 w-64 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs rounded-lg py-2 px-3 z-10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                    ${J.razon_de_label_auto}
                                </div>
                            </div>
                        `:"-"}
                    </td>
                    <td class="p-4">
                        <button class="edit-contact-btn p-2 hover:bg-slate-200 rounded-md" data-id="${J.id}" title="Editar etiquetas">
                            <i data-lucide="edit" class="w-4 h-4 text-blue-600 pointer-events-none"></i>
                        </button>
                    </td>
                </tr>
            `}).join("")}function h(){const v=document.getElementById("contacts-table-body"),I=document.getElementById("select-all-contacts");!v||!I||(v.addEventListener("click",q=>{var J;const M=q.target.closest(".contact-name-display"),Q=q.target.closest('[data-lucide="edit-2"]');if(M||Q){q.stopPropagation();const he=(J=M||Q)==null?void 0:J.closest(".contact-name-editable");if(he){const ve=he.querySelector(".contact-name-display"),le=he.querySelector(".contact-name-input");ve&&le&&(ve.classList.add("hidden"),le.classList.remove("hidden"),le.focus(),le.select())}return}if(q.target.classList.contains("edit-contact-btn")||q.target.closest(".edit-contact-btn")){const ve=(q.target.closest(".edit-contact-btn")||q.target).dataset.id;p.clear(),p.add(ve),ge();return}if(q.target.classList.contains("contact-checkbox")){const he=q.target.dataset.id;q.target.checked?p.add(he):p.delete(he),x();return}if(q.target.classList.contains("ignore-ia-toggle")){$(q.target);return}}),v.addEventListener("blur",q=>{const M=q.target.closest(".contact-name-input");M&&document.activeElement!==M&&Me(M)},!0),v.addEventListener("keydown",q=>{const M=q.target.closest(".contact-name-input");M&&(q.key==="Enter"?(q.preventDefault(),Me(M)):q.key==="Escape"&&(q.preventDefault(),ze(M)))},!0),I.addEventListener("change",q=>{const M=v.querySelectorAll(".contact-checkbox");p.clear(),M.forEach(Q=>{Q.checked=q.target.checked,q.target.checked&&p.add(Q.dataset.id)}),x()}))}function x(){const v=document.getElementById("bulk-actions-bar"),I=document.getElementById("selected-count"),q=document.getElementById("bulk-ignore-selected-btn"),M=document.getElementById("bulk-unignore-selected-btn");p.size>0?(v.classList.remove("hidden"),I.textContent=`${p.size} seleccionado(s)`,q&&(q.disabled=!1),M&&(M.disabled=!1)):(v.classList.add("hidden"),q&&(q.disabled=!0),M&&(M.disabled=!0))}async function S(v){if(!v)return"Ignorar";try{const{data:I,error:q}=await window.auth.sb.from("labels").select("name").eq("user_id",v).limit(100);if(q)throw q;const M=Array.isArray(I)?I.find(Q=>Q.name&&ne(Q.name)==="ignorar"):null;return(M==null?void 0:M.name)||"Ignorar"}catch(I){return console.error("Error al obtener nombre canónico de 'ignorar':",I),"Ignorar"}}async function $(v){var le,$e;const I=v.dataset.contactId,q=v.checked,M=t.find(Se=>Se.id==I);if(!M)return;const Q=($e=(le=window.auth.getSession())==null?void 0:le.user)==null?void 0:$e.id,J=new Set(M.labels||[]),he=Array.from(J);if(J.clear(),he.forEach(Se=>{ne(Se)!=="ignorar"&&J.add(Se)}),q){const Se=await S(Q);J.add(Se)}const ve=Array.from(J);try{const{error:Se}=await window.auth.sb.from("contacts").update({labels:ve}).eq("id",I);if(Se)throw Se;M.labels=ve}catch(Se){console.error("Error al actualizar la etiqueta 'ignorar':",Se),v.checked=!q}}function G(){const v=document.getElementById("bulk-ignore-selected-btn"),I=document.getElementById("bulk-unignore-selected-btn");v&&(v.disabled=!0,v.addEventListener("click",()=>Z(!0))),I&&(I.disabled=!0,I.addEventListener("click",()=>Z(!1)))}async function Z(v){var he,ve,le,$e,Se;if(!p.size){(he=window.showToast)==null||he.call(window,"Selecciona al menos un contacto.","info");return}const I=v?document.getElementById("bulk-ignore-selected-btn"):document.getElementById("bulk-unignore-selected-btn");I&&(I.disabled=!0);const q=Array.from(p);let M=0;const Q=(le=(ve=window.auth.getSession())==null?void 0:ve.user)==null?void 0:le.id,J=await S(Q);try{for(const ke of q){const Pe=t.find(tt=>tt.id==ke);if(!Pe)continue;const Ne=new Set(Pe.labels||[]),Re=Array.from(Ne).some(tt=>be(tt,"ignorar"));if(v&&Re){M+=1;continue}if(!v&&!Re){M+=1;continue}const Je=Array.from(Ne);Ne.clear(),Je.forEach(tt=>{ne(tt)!=="ignorar"&&Ne.add(tt)}),v&&Ne.add(J);const et=Array.from(Ne),{error:Ge}=await window.auth.sb.from("contacts").update({labels:et}).eq("id",ke);if(Ge)throw Ge;Pe.labels=et,M+=1}await L(_),p.clear(),x(),($e=window.showToast)==null||$e.call(window,v?"Se marcó la etiqueta ignorar en los contactos seleccionados.":"Se quitó la etiqueta ignorar de los contactos seleccionados.","success")}catch(ke){console.error("Error al aplicar la acción masiva de ignorar:",ke),(Se=window.showToast)==null||Se.call(window,"No se pudo actualizar la etiqueta ignorar en todos los contactos seleccionados.","error")}finally{I&&(I.disabled=!1)}}function V(){const v=document.getElementById("ignore-all-visible-btn"),I=document.getElementById("unignore-all-visible-btn");v==null||v.addEventListener("click",()=>ie(!0)),I==null||I.addEventListener("click",()=>ie(!1))}function pe(v,I,q){if(!v)return;const M=v.querySelector("span");M&&(I?(v.dataset.originalLabel||(v.dataset.originalLabel=M.textContent||""),M.textContent=q,v.disabled=!0,v.classList.add("opacity-60","pointer-events-none")):(M.textContent=v.dataset.originalLabel||M.textContent,delete v.dataset.originalLabel,v.disabled=!1,v.classList.remove("opacity-60","pointer-events-none")))}function we(v){var Q;const I=v.filter(J=>J&&J.trim().length>0),q=(Q=document.getElementById("contact-search-input"))==null?void 0:Q.value.trim(),M=[];return I.length&&M.push(`etiqueta${I.length>1?"s":""}: ${I.join(", ")}`),q&&M.push(`búsqueda "${q}"`),M.length?`(${M.join(" · ")})`:"(todos los contactos)"}async function ie(v){var J,he,ve,le,$e,Se,ke,Pe,Ne;const I=v?document.getElementById("ignore-all-visible-btn"):document.getElementById("unignore-all-visible-btn");if(!I)return;const q=(he=(J=window.auth.getSession())==null?void 0:J.user)==null?void 0:he.id;if(!q){(ve=window.showToast)==null||ve.call(window,"No se pudo determinar el usuario actual.","error");return}const M=Ie(),Q=we(M);pe(I,!0,v?"Desactivando...":"Activando...");try{let Re=M.length>0&&M[0]!==""?M:null;if(!v){const xt=await S(q);(!Re||Re.length===0)&&(Re=[xt])}const Je=((le=document.getElementById("contact-search-input"))==null?void 0:le.value.trim())||null;console.log("[contacts] Bulk ignore:",{action:v?"DESACTIVAR (agregar ignorar)":"ACTIVAR (quitar ignorar)",labelFilter:Re,searchTerm:Je});const{data:et,error:Ge}=await window.auth.sb.rpc("bulk_update_ignore_label",{p_user_id:q,p_should_ignore:v,p_label_filter:Re,p_search_term:Je});if(Ge)throw console.error("[contacts] Error en bulk_update_ignore_label:",Ge),Ge;const tt=(($e=et==null?void 0:et[0])==null?void 0:$e.updated_count)||0;if(console.log("[contacts] Resultado:",{updatedCount:tt,data:et}),await L(_),tt===0){v?(Se=window.showToast)==null||Se.call(window,`No se encontraron contactos para desactivar. Los contactos ${Q} ya tienen la etiqueta "ignorar".`,"info"):(ke=window.showToast)==null||ke.call(window,`No se encontraron contactos para activar. Los contactos ${Q} no tienen la etiqueta "ignorar".`,"info");return}const rt=v?"desactivamos":"reactivamos";(Pe=window.showToast)==null||Pe.call(window,`Listo: ${rt} la IA en ${tt} contacto(s) ${Q}.`,"success")}catch(Re){console.error("[contacts] Acción global ignorar:",Re),(Ne=window.showToast)==null||Ne.call(window,"No pudimos aplicar la acción a todos los contactos.","error")}finally{pe(I,!1)}}function O(){const v=document.getElementById("contact-search-input");if(!v)return;let I;v.addEventListener("input",()=>{clearTimeout(I),I=setTimeout(()=>{L(1)},300)})}function Be(){if(X=document.getElementById("contact-label-filter"),!!X){if(X.dataset.initialized==="true"){d();return}X.dataset.initialized="true",X.className="w-full sm:w-60 bg-white border border-slate-200 rounded-xl text-sm px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition appearance-none",X.style.paddingRight="2.5rem",X.addEventListener("change",()=>{L(1)}),d()}}function qe(){document.querySelectorAll("#contacts thead th[data-sort]").forEach(I=>{I.addEventListener("click",()=>{const q=I.dataset.sort;b.column===q?b.direction=b.direction==="asc"?"desc":"asc":(b.column=q,b.direction="asc"),L(1),F()})})}async function L(v){const I=document.getElementById("contacts-loader");I.style.display="block";try{const q=await D(v);t=q,E(q),g(),k(A),te("page updated",{page:v,pageCount:q.length,total:A}),typeof lucide<"u"&&lucide.createIcons&&lucide.createIcons()}catch(q){console.error("Error al cambiar de página:",q)}finally{I.style.display="none"}}function F(){document.querySelectorAll("#contacts thead th[data-sort]").forEach(v=>{const I=v.querySelector(".sort-indicator");v.dataset.sort===b.column?I.innerHTML=b.direction==="asc"?'<i data-lucide="arrow-up" class="w-4 h-4"></i>':'<i data-lucide="arrow-down" class="w-4 h-4"></i>':I.innerHTML='<i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-400"></i>'}),lucide.createIcons()}function P(){const v=document.getElementById("edit-labels-modal");document.getElementById("cancel-labels-btn").addEventListener("click",()=>v.classList.add("hidden")),document.getElementById("bulk-edit-labels-btn").addEventListener("click",ge),document.getElementById("new-label-form").addEventListener("submit",ye),document.getElementById("save-labels-btn").addEventListener("click",Ce)}const j=["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#FF5722","#795548","#9E9E9E","#607D8B","#FFFFFF"];function se(v){if(typeof v=="string"&&v.startsWith("#"))return v;const I=parseInt(v,10);return!isNaN(I)&&I>=0&&I<j.length?j[I]:"#848484"}function fe(v){if(!v.startsWith("#"))return"#1e293b";const I=v.charAt(0)==="#"?v.substring(1,7):v,q=parseInt(I.substring(0,2),16),M=parseInt(I.substring(2,4),16),Q=parseInt(I.substring(4,6),16),he=[q/255,M/255,Q/255].map(le=>le<=.03928?le/12.92:Math.pow((le+.055)/1.055,2.4));return .2126*he[0]+.7152*he[1]+.0722*he[2]>.179?"#1e293b":"#ffffff"}async function ge(){var q,M;const v=document.getElementById("edit-labels-modal"),I=document.getElementById("labels-list");v.classList.remove("hidden"),I.innerHTML='<div class="text-center text-slate-500">Cargando etiquetas...</div>';try{const Q=(M=(q=window.auth.getSession())==null?void 0:q.user)==null?void 0:M.id,{data:J,error:he}=await window.auth.sb.from("labels").select("*").eq("user_id",Q);if(he)throw he;n=J;const ve=n.reduce((Se,ke)=>(Se.some(Pe=>Pe.name===ke.name)||Se.push(ke),Se),[]);ve.sort((Se,ke)=>Se.name.localeCompare(ke.name));const le=p.size>0?t.find(Se=>Se.id==[...p][0]):{},$e=new Set(((le==null?void 0:le.labels)||[]).map(ne));I.innerHTML=ve.map(Se=>`
                <div class="flex items-center justify-between p-2 rounded-md hover:bg-slate-100">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" class="label-checkbox form-checkbox rounded" data-label-name="${Se.name}" ${$e.has(ne(Se.name))?"checked":""}>
                        <span class="w-4 h-4 rounded-full" style="background-color: ${se(Se.color)};"></span>
                        <span>${Se.name}</span>
                    </label>
                    <button class="edit-label-properties-btn p-1.5 rounded-md hover:bg-slate-200" data-label-id="${Se.id}" title="Editar propiedades de la etiqueta">
                        <i data-lucide="edit" class="w-4 h-4 pointer-events-none edit-label-icon"></i>
                    </button>
                </div>
            `).join("")}catch(Q){console.error("Error al cargar etiquetas:",Q),I.innerHTML='<div class="text-center text-red-500">Error al cargar etiquetas.</div>'}}(Rt=document.getElementById("labels-list"))==null||Rt.addEventListener("click",v=>{const I=v.target.closest(".edit-label-properties-btn");I&&(document.getElementById("edit-labels-modal").classList.add("hidden"),window.appInstance.switchPanel("smart-labels"),setTimeout(()=>{var q;return(q=document.querySelector(`.edit-smart-label-btn[data-id="${I.dataset.labelId}"]`))==null?void 0:q.click()},200))});async function ye(v){var J,he,ve;v.preventDefault();const I=document.getElementById("new-label-name"),q=document.getElementById("new-label-color"),M=I.value.trim(),Q=(he=(J=window.auth.getSession())==null?void 0:J.user)==null?void 0:he.id;if(!(!M||!Q))try{const le=M.charAt(0).toUpperCase()+M.slice(1).toLowerCase();if(n.find(Pe=>Pe.user_id===Q&&ne(Pe.name)===ne(le))){(ve=window.showToast)==null||ve.call(window,"Esta etiqueta ya existe (puede tener diferente capitalización).","info"),I.value="",ge();return}const{data:Se,error:ke}=await window.auth.sb.from("labels").insert({name:le,color:q.value,user_id:Q}).select();if(ke)throw ke;if(te("label creada vía formulario",Se),Array.isArray(Se)&&Se.length){const Pe=Se[0];n=n.filter(Ne=>Ne.id!==Pe.id),n.push(Pe),d()}I.value="",ge()}catch(le){console.error("Error al crear etiqueta:",le.message),alert(`No se pudo crear la etiqueta. Error: ${le.message}

Revisa si la columna 'evolution_label_id' en Supabase permite valores nulos.`)}}async function Ce(){var I,q,M,Q;const v=document.getElementById("save-labels-btn");v.disabled=!0,v.textContent="Guardando...";try{const J=document.getElementById("new-label-name").value.trim(),he=document.getElementById("new-label-color").value,ve=(q=(I=window.auth.getSession())==null?void 0:I.user)==null?void 0:q.id;let le=null;if(J&&ve){const Pe=J.trim().charAt(0).toUpperCase()+J.trim().slice(1).toLowerCase(),Ne=n.find(Re=>Re.user_id===ve&&ne(Re.name)===ne(Pe));if(Ne)le=Ne.name;else{const{data:Re,error:Je}=await window.auth.sb.from("labels").insert({name:Pe,color:he,user_id:ve}).select().single();if(Je)throw new Error(`Error al crear la nueva etiqueta: ${Je.message}`);le=Re.name,n.push(Re)}n.push(newLabel),d(),document.getElementById("new-label-name").value=""}const $e=new Set;document.querySelectorAll("#labels-list .label-checkbox:checked").forEach(Pe=>$e.add(Pe.dataset.labelName)),J&&$e.add(J);const Se=new Set;document.querySelectorAll(".label-checkbox:not(:checked)").forEach(Pe=>Se.add(Pe.dataset.labelName));const ke=[];for(const Pe of p){const Ne=t.find(et=>et.id==Pe);if(!Ne)continue;let Re=new Set(Ne.labels||[]);$e.forEach(et=>Re.add(et)),Se.forEach(et=>Re.delete(et));const Je=Array.from(Re);ke.push(window.auth.sb.from("contacts").update({labels:Je}).eq("id",Pe))}await Promise.all(ke),(M=window.showToast)==null||M.call(window,"Etiquetas guardadas correctamente.","success"),document.getElementById("edit-labels-modal").classList.add("hidden"),Ue($e,p),await L(_),p.clear(),x()}catch(J){console.error("Error al guardar cambios:",J),(Q=window.showToast)==null||Q.call(window,`No se pudieron guardar los cambios: ${J.message}`,"error")}finally{v.disabled=!1,v.textContent="Guardar Cambios"}}async function Ue(v,I){var M,Q;const q=(Q=(M=window.auth.getSession())==null?void 0:M.user)==null?void 0:Q.id;if(!(!q||v.size===0||I.size===0))try{const{data:J}=await window.auth.sb.from("followups").select("target_label").eq("user_id",q).eq("is_active",!0),he=new Set((J||[]).map(le=>le.target_label));for(const le of v)if(he.has(le))for(const $e of I)fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/start-followup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contact_id:$e,user_id:q,target_label:le})}).catch(Se=>console.error(`Error al activar seguimiento para ${$e}:`,Se));const ve=n.filter(le=>le.notify_on_assign&&v.has(le.name));for(const le of ve)for(const $e of I){const Se=t.find(ke=>ke.id==$e);Se&&fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/notificarlabel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:q,contact_name:Se.full_name||"Sin nombre",contact_phone:Se.phone_number,assigned_label:le.name})}).catch(ke=>console.error(`Error al enviar notificación para ${$e}:`,ke))}}catch(J){console.error("Error en las acciones post-guardado:",J)}}function je(v){if(v==null)return"";const I=String(v);return/[",\n]/.test(I)?'"'+I.replace(/"/g,'""')+'"':I}async function Ae(v){const I=(v.name||"").toLowerCase();if(I.endsWith(".xlsx")||I.endsWith(".xls")){if(typeof XLSX>"u")throw new Error("No se pudo cargar el lector de hojas de cálculo (XLSX). Recarga la página e intenta nuevamente.");const q=await v.arrayBuffer(),M=XLSX.read(q,{type:"array"});if(!M.SheetNames.length)throw new Error("El archivo de Excel no contiene hojas válidas.");const Q=M.Sheets[M.SheetNames[0]];return XLSX.utils.sheet_to_csv(Q,{FS:",",RS:`
`})}return await v.text()}async function Oe(v,I){if(!v||!v.length||!I)return;const q=new Map;for(const ke of v){const Pe=ke==null?void 0:ke.trim();if(!Pe)continue;const Ne=Pe.charAt(0).toUpperCase()+Pe.slice(1).toLowerCase(),Re=Ne.toLowerCase();q.has(Re)||q.set(Re,Ne)}const M=Array.from(q.values());if(!M.length)return;te("verificando etiquetas detectadas",M);const Q=await Promise.all(M.map(async ke=>{try{const{data:Pe,error:Ne}=await window.auth.sb.rpc("get_canonical_label_name",{p_user_id:I,p_label_name:ke});if(Ne)throw Ne;return Pe||ke}catch(Pe){return console.warn(`Error al obtener nombre canónico para "${ke}":`,Pe),ke}}));if(!n.length)try{n=await c()}catch(ke){throw console.error("No se pudo cargar la lista de etiquetas:",ke),new Error("No se pudo cargar la lista de etiquetas actuales.")}const J=new Map(n.filter(ke=>ke.user_id===I).map(ke=>[ke.name.toLowerCase(),ke])),he=Q.map(ke=>{const Pe=J.get(ke.toLowerCase());return{name:ke,color:(Pe==null?void 0:Pe.color)||C(),isNew:!Pe}});if(!he.length)return;te("colores de etiquetas asignados automáticamente",he);const ve=he.filter(ke=>{const Pe=J.get(ke.name.toLowerCase());return Pe?(Pe.color||"").toLowerCase()!==ke.color.toLowerCase():!0}).map(ke=>({user_id:I,name:ke.name,color:ke.color}));if(!ve.length){he.forEach(ke=>{const Pe=ke.name.toLowerCase(),Ne=J.get(Pe);Ne&&(Ne.color=ke.color)});return}const{data:le,error:$e}=await window.auth.sb.from("labels").upsert(ve,{onConflict:"user_id,name"}).select();if($e)throw console.warn("Error en upsert inicial, intentando con nombres canónicos:",$e),$e;te("etiquetas upsert",{requested:ve.length,persisted:(le==null?void 0:le.length)??0});const Se=new Map((le||[]).map(ke=>[ke.name.toLowerCase(),ke]));he.forEach(ke=>{const Pe=ke.name.toLowerCase(),Ne=Se.get(Pe);let Re=n.find(Je=>Je.user_id===I&&Je.name.toLowerCase()===Pe);Re?(Re.color=ke.color,Re.name=(Ne==null?void 0:Ne.name)||Re.name,Ne!=null&&Ne.id&&(Re.id=Ne.id)):Ne&&n.push({id:Ne.id,user_id:I,name:Ne.name,color:Ne.color||ke.color}),J.set(Pe,{id:(Ne==null?void 0:Ne.id)||(Re==null?void 0:Re.id)||null,user_id:I,name:(Ne==null?void 0:Ne.name)||(Re==null?void 0:Re.name)||ke.name,color:ke.color})}),d()}function C(){const v=()=>Math.floor(180+Math.random()*60),I=v().toString(16).padStart(2,"0"),q=v().toString(16).padStart(2,"0"),M=v().toString(16).padStart(2,"0");return`#${I}${q}${M}`}async function T(v){var ve,le,$e,Se,ke,Pe,Ne,Re,Je,et;const I=v.target,q=(ve=I==null?void 0:I.files)==null?void 0:ve[0];if(!q)return;s();const M=[],Q=[];let J=null,he=[];try{let Ge=await Fe().catch(()=>null);if(Ge)try{const{data:Qe,error:nt}=await window.auth.sb.from("apps").select("id").eq("id",Ge).single();(nt||!Qe)&&(console.warn("[contacts-import] app_id no válido, se omitirá:",Ge),Ge=null)}catch(Qe){console.warn("[contacts-import] Error al validar app_id:",Qe),Ge=null}const rt=(await Ae(q)).split(/\r?\n/).map(Qe=>Qe.trim()).filter(Qe=>Qe.length>0);if(te("archivo leído",{name:q.name,lineCount:rt.length}),!rt.length){(le=window.showToast)==null||le.call(window,"El archivo de contactos está vacío.","info");return}const xt=R(rt[0]).map(Qe=>Qe.trim());if(J=await K(xt),te("mapeo de columnas",{headers:xt,mapping:J}),!J){($e=window.showToast)==null||$e.call(window,"Importación cancelada.","info");return}const _t=rt.slice(1),Pt=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),Ve=Pt?Pt.id:(ke=(Se=window.auth.getSession())==null?void 0:Se.user)==null?void 0:ke.id;if(te("targetUserId detectado",Ve),!Ve)throw new Error("No se pudo determinar el usuario destino para la importación.");const{data:mt,error:at}=await window.auth.sb.from("contacts").select("id, phone_number, labels, full_name, followup_status, current_followup_id, followup_step_sent, last_followup_sent_at, chatwoot_contact_id, assigned_to_id, razon_de_label_auto, created_at").eq("user_id",Ve);if(at)throw at;const st=new Map;(mt||[]).forEach(Qe=>{const nt=Te(Qe.phone_number);nt&&(Array.isArray(Qe.labels)||(Qe.labels=Qe.labels?[Qe.labels]:[]),st.set(nt,Qe))});const yt=new Map,vt=new Set;if(_t.forEach((Qe,nt)=>{var Gt,Qt;const St=nt+2,Dt=R(Qe),kt=(Gt=de(Dt,J.phone_number))==null?void 0:Gt.trim();if(!kt){M.push({rowNumber:St,reason:"Sin telefono",rawPhone:kt});return}const ft=Te(kt);if(!ft){M.push({rowNumber:St,reason:"Telefono invalido",rawPhone:kt});return}const it=st.get(ft);te("fila procesada",{rowNumber:St,normalizedPhone:ft,existing:!!it});const It={user_id:Ve,phone_number:ft};Ge&&(It.app_id=Ge);const Ct=(Qt=de(Dt,J.full_name))==null?void 0:Qt.trim();it!=null&&it.full_name&&!xe(it.full_name)?xe(Ct)?It.full_name=it.full_name:Ct?It.full_name=Ct:It.full_name=it.full_name:Ct&&!xe(Ct)&&(It.full_name=Ct);const Ut=new Set;it!=null&&it.labels&&(Array.isArray(it.labels)?it.labels:[it.labels]).filter(Boolean).map(Nt=>String(Nt).trim()).filter(Nt=>Nt.length>0).forEach(Nt=>Ut.add(Nt));const Ot=Le(de(Dt,J.labels));Ot&&Ot.map(Et=>String(Et).trim()).filter(Et=>Et&&Et.length>0&&Et.toLowerCase()!=="ignorar").forEach(Et=>Ut.add(Et));const Mt=Array.from(Ut).filter(Boolean);It.labels=Mt.length>0?Mt:(it==null?void 0:it.labels)||[],(Mt.length?Mt:[]).forEach(Et=>{Et.toLowerCase()!=="ignorar"&&vt.add(Et)}),yt.set(ft,De(It)),Q.push({rowNumber:St,phone:ft,fullName:It.full_name||"",labels:Mt.join(", ")})}),te("contactsToUpsert size",yt.size),vt.size>0&&await Oe(Array.from(vt),Ve),he=Array.from(yt.values()),te("payload preparado",{totalRows:_t.length,payloadCount:he.length,skipped:M.length,sample:he.slice(0,3),phones:he.map(Qe=>Qe.phone_number)}),window.lastContactImport={stage:"beforeUpsert",totalRows:_t.length,processedRows:Q,skippedRows:M,mapping:J,finalPayload:he,targetUserId:Ve},!he.length){window.lastContactImport={totalRows:_t.length,processedRows:Q,skippedRows:M,finalPayload:he},M.length&&(console.warn("Importacion de contactos sin filas validas.",{skippedRows:M,headers:xt,mapping:J}),typeof console.table=="function"&&console.table(M)),(Pe=window.showToast)==null||Pe.call(window,M.length>0?`No se detectaron contactos válidos. ${M.length} filas omitidas.`:"El archivo no contiene contactos para importar.","warning");return}const{data:bt,error:Lt}=await window.auth.sb.from("contacts").upsert(he,{onConflict:"user_id,phone_number"}).select("id, phone_number, user_id");if(Lt)throw Lt;te("upsert completado",{insertedOrUpdated:(bt==null?void 0:bt.length)??0,sample:(Ne=bt==null?void 0:bt.slice)==null?void 0:Ne.call(bt,0,3)}),window.lastContactImport={stage:"afterUpsert",totalRows:_t.length,processedRows:Q,skippedRows:M,finalPayload:he,upserted:bt,targetUserId:Ve},typeof console.table=="function"&&Q.length&&console.table(Q),M.length&&(console.warn("Filas omitidas durante la importacion.",M),typeof console.table=="function"&&console.table(M),(Re=window.showToast)==null||Re.call(window,`${M.length} filas se omitieron. Revisa la consola para detalles.`,"info")),console.info("Resumen de la importacion de contactos",{totalRows:_t.length,enviados:he.length,omitidos:M.length,vistaPrevia:Q.slice(0,10)});const Bt=`${he.length} contactos importados/actualizados con exito.`;(Je=window.showToast)==null||Je.call(window,Bt,"success"),await m()}catch(Ge){if(te("error durante importación",Ge),(Ge==null?void 0:Ge.message)==="IMPORTACION_CANCELADA")return;const tt=(Ge==null?void 0:Ge.details)||(Ge==null?void 0:Ge.hint)||"",rt=Ge!=null&&Ge.message?`Error al importar: ${Ge.message}`:"Error desconocido al importar contactos.",xt=tt?`${rt} (${tt})`:rt;console.error("Error al importar contactos:",{error:Ge,finalPayload:he,skippedRows:M,processedRows:Q,mapping:J}),window.lastContactImport={stage:"error",error:Ge,finalPayload:he,skippedRows:M,processedRows:Q,mapping:J},(et=window.showToast)==null||et.call(window,xt,"error")}finally{I&&(I.value="")}}function R(v){const I=[];let q="",M=!1;for(let Q=0;Q<v.length;Q++){const J=v[Q];J==='"'&&(Q===0||v[Q-1]!=='"')?M&&v[Q+1]==='"'?(q+='"',Q++):M=!M:J===","&&!M?(I.push(q.trim()),q=""):q+=J}return I.push(q.trim()),I}async function K(v){const I=[{field:"phone_number",label:"Teléfono",required:!0,aliases:["phone_number","telefono","teléfono","tel","phone","mobile","celular","whatsapp"]},{field:"full_name",label:"Nombre",required:!1,aliases:["full_name","nombre","name","contacto"]},{field:"labels",label:"Etiquetas",required:!1,aliases:["labels","etiquetas","tags"]}];return typeof window.openColumnMappingModal=="function"?await window.openColumnMappingModal(I,v):ee(v,I)}function ee(v,I){const q={},M=new Set,Q=v.map(J=>J.toLowerCase());for(const J of I){let he=-1;for(const ve of J.aliases||[]){const le=Q.indexOf(ve.toLowerCase());if(le!==-1&&!M.has(le)){he=le;break}}if(he===-1&&(he=v.findIndex((ve,le)=>!M.has(le))),he===-1){if(J.required)return null;continue}q[J.field]=he,M.add(he)}return q}function de(v,I){return typeof I!="number"||I<0||I>=v.length?"":v[I]}function Le(v){if(!v)return null;const I=v.trim();if(!I)return null;try{const Q=JSON.parse(I);if(Array.isArray(Q)){const J=Q.map(he=>String(he??"").trim()).filter(Boolean);if(J.length)return J}}catch{}const M=I.replace(/^\[(.*)\]$/,"$1").replace(/\r?\n/g,",").split(/[;,|]/).map(Q=>Q.trim()).filter(Boolean);return M.length?M:null}function Te(v){if(!v)return"";const I=String(v).replace(/\D+/g,"");return I.length<10?"":"+521"+I.slice(-10)}function De(v){const I={};return Object.entries(v||{}).forEach(([q,M])=>{M!==void 0&&(Array.isArray(M)&&M.length===0&&q==="labels"||(I[q]=M))}),I}function xe(v){if(!v)return!0;const I=v.trim().toLowerCase();return["sin nombre","sin-nombre","sin_nombre","sinnombre","n/a","na","none","null",""].includes(I)}async function Me(v){var he,ve,le;const I=v.dataset.contactId,q=v.value.trim(),M=v.closest(".contact-name-editable"),Q=M==null?void 0:M.querySelector(".contact-name-display"),J=(M==null?void 0:M.dataset.originalName)||"";if(I){if(xe(q)){v.value=J||"",ze(v),(he=window.showToast)==null||he.call(window,'El nombre no puede estar vacío o ser "sin nombre".',"warning");return}try{const{error:$e}=await window.auth.sb.from("contacts").update({full_name:q}).eq("id",I);if($e)throw $e;Q&&(Q.textContent=q,M.dataset.originalName=q);const Se=t.find(ke=>ke.id===I);Se&&(Se.full_name=q),v.classList.add("hidden"),Q==null||Q.classList.remove("hidden"),(ve=window.showToast)==null||ve.call(window,"Nombre actualizado correctamente.","success")}catch($e){console.error("Error al actualizar nombre:",$e),(le=window.showToast)==null||le.call(window,`Error al actualizar nombre: ${$e.message}`,"error"),ze(v)}}}function ze(v){const I=v.closest(".contact-name-editable"),q=I==null?void 0:I.querySelector(".contact-name-display"),M=(I==null?void 0:I.dataset.originalName)||"";v.value=M,v.classList.add("hidden"),q==null||q.classList.remove("hidden")}function He(){var I,q,M;const v=(I=window.appInstance)==null?void 0:I.teamInfo;return(v==null?void 0:v.active_app_id)||(v==null?void 0:v.app_id)||(v==null?void 0:v.default_app_id)||((M=(q=v==null?void 0:v.apps)==null?void 0:q[0])==null?void 0:M.id)||(v==null?void 0:v.team_id)||null}async function Fe(){var q;const v=He();if(v)return v;if((q=window.appInstance)!=null&&q.loadTeamInfo){try{await window.appInstance.loadTeamInfo()}catch(Q){console.warn("[contacts-import] No se pudo refrescar teamInfo:",Q)}const M=He();if(M)return M}return localStorage.getItem("active_app_id")||null}async function We(){var q;const v=document.getElementById("sync-contacts-btn"),I=document.getElementById("contacts-status-container");if(!(!v||!I)){v.disabled=!0;try{const M=window.auth.getSession(),Q=(q=M==null?void 0:M.user)==null?void 0:q.id;if(!Q)return;const{data:J,error:he}=await window.auth.sb.from("profiles").select("whatsapp_connected, sync_status").eq("id",Q).single();if(he)throw he;const ve=J==null?void 0:J.whatsapp_connected,le=J==null?void 0:J.sync_status;if(!ve){I.innerHTML=`
                    <div class="bg-amber-100 border-l-4 border-amber-500 text-amber-800 p-4 rounded-r-lg">
                        <h4 class="font-bold">Acción requerida</h4>
                        <p class="text-sm mt-1">Debes conectar tu WhatsApp en el panel de <strong>Dashboard</strong> antes de poder sincronizar tus contactos.</p>
                    </div>`,v.disabled=!0,v.innerHTML="Sincronizar Contactos y Etiquetas";return}le==="processing"?(I.innerHTML=`
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg animate-pulse">
                        <p class="text-sm font-medium">Hay una sincronización en progreso. La tabla se actualizará automáticamente al finalizar.</p>
                    </div>`,v.disabled=!0,ot()):(I.innerHTML="",v.disabled=!1,v.innerHTML="Sincronizar Contactos y Etiquetas")}catch(M){console.error("Error al verificar pre-requisitos de sincronización:",M),v.disabled=!1,v.innerHTML="Sincronizar Contactos y Etiquetas"}}}function Ze(){const v=document.getElementById("sync-contacts-btn");v&&v.addEventListener("click",async()=>{var q;if(e)return;const I=(q=window.auth.getSession())==null?void 0:q.user;if(!I){alert("Error: No se encontró sesión de usuario.");return}e=!0,v.disabled=!0,v.innerHTML='<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';try{const{data:M,error:Q}=await window.auth.invokeFunction("sync-contacts",{body:{user_id:I.id}});if(Q)throw new Error(Q.message||"Error al iniciar la sincronización.");const J=document.getElementById("contacts-status-container");J&&(J.innerHTML=`
                        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg">
                            <h4 class="font-bold">Sincronización en progreso...</h4>
                            <p class="text-sm mt-1">Esto puede tardar varios minutos dependiendo de la cantidad de contactos. Te avisaremos cuando esté listo. Puedes seguir usando la aplicación.</p>
                        </div>`),ot()}catch(M){console.error("Error al iniciar la sincronización:",M),alert("Error al iniciar la sincronización."),v.disabled=!1,v.innerHTML="Sincronizar Contactos y Etiquetas"}finally{e=!1}})}function ot(){var q;const v=window.auth.getSession(),I=(q=v==null?void 0:v.user)==null?void 0:q.id;!I||U||(U=setInterval(async()=>{var M;try{const{data:Q,error:J}=await window.auth.sb.from("profiles").select("sync_status").eq("id",I).single();if(J)throw J;const he=Q==null?void 0:Q.sync_status;if(he!=="processing"){clearInterval(U),U=null;const ve=document.getElementById("contacts-status-container");ve&&(ve.innerHTML="");const le=document.getElementById("sync-contacts-btn");le&&(le.disabled=!1,le.innerHTML="Sincronizar Contactos y Etiquetas"),he==="completed"&&((M=window.showToast)==null||M.call(window,"Sincronización completada. La tabla se ha actualizado.","success"))}}catch(Q){console.error("Error durante el seguimiento de la sincronización:",Q),clearInterval(U),U=null;const J=document.getElementById("sync-contacts-btn");J&&(J.disabled=!1,J.innerHTML="Sincronizar Contactos y Etiquetas")}},1e4))}function dt(){var I,q;if(N)return;const v=(q=(I=window.auth.getSession())==null?void 0:I.user)==null?void 0:q.id;v&&(console.log("Suscribiéndose a cambios en la tabla de Contactos..."),N=window.auth.sb.channel("public:contacts:contacts-table").on("postgres_changes",{event:"*",schema:"public",table:"contacts",filter:`user_id=eq.${v}`},M=>{console.log("Cambio recibido en Contactos:",M),clearTimeout(H),H=setTimeout(()=>{var Q;(Q=window.showToast)==null||Q.call(window,"La lista de contactos se ha actualizado.","info"),m()},2e3)}).subscribe())}function gt(){if(N){console.log("Desuscribiéndose de los cambios de Contactos.");try{window.auth.sb.removeChannel(N)}catch(v){console.error("Error al desuscribir del canal de contactos:",v)}N=null}s()}window.contacts={openLabelsModalForSingleContact:v=>{v&&(p.clear(),p.add(v),ge())},logLastImport:()=>(console.info("[contacts-import] lastContactImport snapshot:",window.lastContactImport),window.lastContactImport),async verifySupabaseAccess(v=5){var I;try{const q=window.auth.getSession(),M=(I=q==null?void 0:q.user)==null?void 0:I.id;if(!M)return console.warn("[contacts-import] verifySupabaseAccess: no active session"),null;const{data:Q,error:J}=await window.auth.sb.from("contacts").select("id, user_id, phone_number, created_at").eq("user_id",M).order("created_at",{ascending:!1}).limit(v);if(J)throw J;return console.info("[contacts-import] verifySupabaseAccess result:",Q),Q}catch(q){return console.error("[contacts-import] verifySupabaseAccess error:",q),null}},async debugInsertTestContact(){var v;try{const I=window.auth.getSession(),q=(v=I==null?void 0:I.user)==null?void 0:v.id;if(!q)return console.warn("[contacts-import] debugInsertTestContact: no active session"),null;const M=Date.now(),Q=`+521000${String(M).slice(-6)}`,J={user_id:q,phone_number:Q,full_name:`Debug Contact ${M}`,labels:["debug"],followup_status:"idle",followup_step_sent:-1,created_at:new Date().toISOString(),razon_de_label_auto:null,assigned_to_id:null,current_followup_id:null,last_followup_sent_at:null,chatwoot_contact_id:null},{data:he,error:ve}=await window.auth.sb.from("contacts").insert([J]).select("id, phone_number, created_at");if(ve)throw ve;return console.info("[contacts-import] debugInsertTestContact result:",he),he}catch(I){throw console.error("[contacts-import] debugInsertTestContact error:",I),I}}};let lt=null;async function pt(){const v=document.getElementById("import-numbers-label-modal");!v||!v.classList||(v.classList.remove("hidden"),ht(),await Ke(),ut(),typeof lucide<"u"&&lucide.createIcons&&lucide.createIcons())}function wt(){const v=document.getElementById("import-numbers-label-modal");v&&v.classList&&v.classList.add("hidden"),ht()}function ht(){lt=null;const v=document.getElementById("numbers-file-input"),I=document.getElementById("numbers-file-preview"),q=document.getElementById("label-name-input"),M=document.getElementById("label-select"),Q=document.getElementById("new-label-input-container"),J=document.getElementById("import-numbers-progress"),he=document.getElementById("import-numbers-results"),ve=document.getElementById("confirm-import-numbers");v&&(v.value=""),I&&I.classList&&I.classList.add("hidden"),q&&(q.value=""),M&&(M.value=""),Q&&Q.classList&&Q.classList.add("hidden"),J&&J.classList&&J.classList.add("hidden"),he&&he.classList&&he.classList.add("hidden"),ve&&(ve.disabled=!1)}async function Ke(){var I,q;const v=document.getElementById("label-select");if(v)try{const M=(q=(I=window.auth.getSession())==null?void 0:I.user)==null?void 0:q.id;if(!M)return;const{data:Q,error:J}=await window.auth.sb.from("labels").select("*").eq("user_id",M);if(J)throw J;for(;v.children.length>2;)v.removeChild(v.lastChild);const he=(Q||[]).reduce((ve,le)=>(ve.some($e=>$e.name===le.name)||ve.push(le),ve),[]);he.sort((ve,le)=>ve.name.localeCompare(le.name)),he.forEach(ve=>{const le=document.createElement("option");le.value=ve.name,le.textContent=ve.name,v.appendChild(le)})}catch(M){console.error("Error al cargar etiquetas:",M)}}function ut(){const v=document.getElementById("numbers-file-drop-zone"),I=document.getElementById("numbers-file-input"),q=document.getElementById("remove-numbers-file"),M=document.getElementById("close-import-numbers-modal"),Q=document.getElementById("cancel-import-numbers"),J=document.getElementById("confirm-import-numbers"),he=document.getElementById("label-select"),ve=document.getElementById("new-label-input-container"),le=document.getElementById("label-name-input");v&&I&&(v.addEventListener("click",()=>I.click()),v.addEventListener("dragover",$e=>{$e.preventDefault(),v.classList.add("border-blue-500","bg-blue-50")}),v.addEventListener("dragleave",()=>{v.classList.remove("border-blue-500","bg-blue-50")}),v.addEventListener("drop",$e=>{$e.preventDefault(),v.classList.remove("border-blue-500","bg-blue-50"),$e.dataTransfer.files.length&&Ye($e.dataTransfer.files[0])})),I&&I.addEventListener("change",$e=>{$e.target.files.length&&Ye($e.target.files[0])}),q&&q.addEventListener("click",()=>{lt=null;const $e=document.getElementById("numbers-file-input"),Se=document.getElementById("numbers-file-preview");$e&&($e.value=""),Se&&Se.classList&&Se.classList.add("hidden")}),he&&ve&&le&&he.addEventListener("change",$e=>{const Se=$e.target.value;Se==="__new__"?(ve&&ve.classList&&ve.classList.remove("hidden"),le&&(le.required=!0,le.value="")):(ve&&ve.classList&&ve.classList.add("hidden"),le&&(le.required=!1,le.value=""))}),M&&M.addEventListener("click",wt),Q&&Q.addEventListener("click",wt),J&&J.addEventListener("click",ct)}async function Ye(v){var I,q,M;try{const Q=(I=v.name.split(".").pop())==null?void 0:I.toLowerCase();let J=[],he=[];if(["csv","xlsx","xls"].includes(Q)){const Pe=(await Ae(v)).split(/\r?\n/).map(Ne=>Ne.trim()).filter(Ne=>Ne.length>0);he=Pe;for(const Ne of Pe){const Re=Ne.split(",").map(Je=>Je.trim());for(const Je of Re){const et=Je.replace(/\D/g,"");et.length>=10&&J.push(et)}}}else{const Pe=(await v.text()).split(/\r?\n/).map(Ne=>Ne.trim()).filter(Ne=>Ne.length>0);he=Pe,J=Pe.map(Ne=>Ne.replace(/\D/g,"")).filter(Ne=>Ne.length>=10)}const ve=[...new Set(J)];lt={file:v,numbers:ve,rawLines:he};const le=document.getElementById("numbers-file-preview"),$e=document.getElementById("numbers-file-name"),Se=document.getElementById("numbers-count");le&&le.classList&&le.classList.remove("hidden"),$e&&($e.textContent=v.name),Se&&(Se.textContent=`${ve.length} números únicos detectados`),(q=window.showToast)==null||q.call(window,`Se detectaron ${ve.length} números válidos en el archivo.`,"success")}catch(Q){console.error("Error al leer archivo:",Q),(M=window.showToast)==null||M.call(window,"Error al leer el archivo. Asegúrate de que sea un archivo válido (TXT, CSV, XLSX, XLS).","error")}}async function ct(){var he,ve,le,$e,Se,ke,Pe,Ne;const v=document.getElementById("label-select"),I=document.getElementById("label-name-input");let q="";if(v&&v.value?v.value==="__new__"?q=((he=I==null?void 0:I.value)==null?void 0:he.trim())||"":q=v.value.trim():q=((ve=I==null?void 0:I.value)==null?void 0:ve.trim())||"",!q){(le=window.showToast)==null||le.call(window,"Por favor selecciona una etiqueta existente o crea una nueva.","error");return}if(!lt||!lt.numbers||lt.numbers.length===0){($e=window.showToast)==null||$e.call(window,"Por favor selecciona un archivo con números válidos.","error");return}const M=document.getElementById("confirm-import-numbers"),Q=document.getElementById("import-numbers-progress"),J=document.getElementById("import-numbers-results");M&&(M.disabled=!0);try{const Re=(ke=(Se=window.auth.getSession())==null?void 0:Se.user)==null?void 0:ke.id;if(!Re)throw new Error("No se pudo determinar el usuario actual.");Q&&Q.classList&&Q.classList.remove("hidden"),Xe(0,"Preparando importación..."),await Oe([q],Re),Xe(10,"Etiqueta configurada"),Xe(20,"Buscando contactos existentes...");const{data:Je,error:et}=await window.auth.sb.from("contacts").select("id, phone_number, labels, full_name").eq("user_id",Re);if(et)throw et;const Ge=new Map;(Je||[]).forEach(Ve=>{const mt=Te(Ve.phone_number);mt&&(Array.isArray(Ve.labels)||(Ve.labels=Ve.labels?[Ve.labels]:[]),Ve.labels=[...Ve.labels],Ge.set(mt,Ve))}),Xe(30,"Procesando números...");const tt=[],rt=[];let xt=0;const _t=lt.numbers.length;for(let Ve=0;Ve<lt.numbers.length;Ve++){const mt=lt.numbers[Ve],at=Te(mt);if(!at){xt++;continue}const st=Ge.get(at),yt=new Set;st!=null&&st.labels&&(Array.isArray(st.labels)?st.labels:[st.labels]).filter(Boolean).map(nt=>String(nt).trim()).filter(nt=>nt.length>0).forEach(nt=>{yt.add(nt)}),yt.add(q);const vt=Array.from(yt);if(st){const Qe=st.labels?st.labels.length:0,nt=vt.length;if(nt<Qe){console.warn(`[import-numbers] Advertencia: Se detectó pérdida de etiquetas para ${at}. Originales: ${Qe}, Merge: ${nt}`);const St=new Set([...st.labels,q]);rt.push({id:st.id,labels:Array.from(St),originalLabels:st.labels})}else rt.push({id:st.id,labels:vt})}else tt.push({user_id:Re,phone_number:at,labels:[q],followup_status:"idle",followup_step_sent:-1});const bt=30+(Ve+1)/_t*55,Lt=Ve+1,Bt=_t-Lt;Xe(bt,`Procesando números: ${Lt} de ${_t} (${Bt} restantes)...`)}const Pt=tt.length+rt.length;if(Xe(85,`Guardando ${Pt} contactos...`),tt.length>0){Xe(87,`Insertando ${tt.length} contactos nuevos...`);const Ve=100,mt=Math.ceil(tt.length/Ve);for(let at=0;at<mt;at++){const st=at*Ve,yt=Math.min(st+Ve,tt.length),vt=tt.slice(st,yt),bt=87+(at+1)/mt*5;Xe(bt,`Insertando lote ${at+1} de ${mt} (${yt} de ${tt.length} contactos)...`);const Lt=vt.map(ft=>ft.phone_number),{data:Bt,error:Qe}=await window.auth.sb.from("contacts").select("id, phone_number, labels, full_name").eq("user_id",Re).in("phone_number",Lt),nt=new Map;Bt&&!Qe&&Bt.forEach(ft=>{nt.set(ft.phone_number,ft)});const St=vt.map(ft=>{const it=nt.get(ft.phone_number);if(it){const It=Array.isArray(it.labels)?it.labels:[],Ct=[...new Set([...It,q])];return{...ft,labels:Ct,full_name:it.full_name||ft.full_name||null}}return ft}),{data:Dt,error:kt}=await window.auth.sb.from("contacts").upsert(St,{onConflict:"user_id,phone_number",ignoreDuplicates:!1}).select("id, phone_number, labels, full_name");if(kt)throw console.error("[import-numbers] Error en upsert:",kt),new Error(`Error al guardar contactos: ${kt.message}`)}}if(rt.length>0){Xe(92,`Actualizando ${rt.length} contactos existentes...`);const Ve=100,mt=Math.ceil(rt.length/Ve);for(let at=0;at<mt;at++){const st=at*Ve,yt=Math.min(st+Ve,rt.length),vt=rt.slice(st,yt),bt=92+(at+1)/mt*6;Xe(bt,`Actualizando lote ${at+1} de ${mt} (${yt} de ${rt.length} contactos)...`);const Lt=vt.map(Qe=>{const nt=Qe.labels||[];return window.auth.sb.from("contacts").update({labels:nt}).eq("id",Qe.id)}),Bt=await Promise.all(Lt);for(let Qe=0;Qe<Bt.length;Qe++){const{error:nt}=Bt[Qe];if(nt)throw console.error(`[import-numbers] Error al actualizar contacto ${vt[Qe].id}:`,nt),new Error(`Error al actualizar contacto: ${nt.message}`)}}}if(Xe(100,"¡Importación completada!"),J&&J.classList){J.classList.remove("hidden");const Ve=document.getElementById("result-new-contacts"),mt=document.getElementById("result-updated-contacts"),at=document.getElementById("result-skipped-contacts");Ve&&(Ve.textContent=`• Contactos nuevos: ${tt.length}`),mt&&(mt.textContent=`• Contactos actualizados: ${rt.length}`),at&&(at.textContent=`• Números omitidos: ${xt}`)}(Pe=window.showToast)==null||Pe.call(window,`Importación completada: ${tt.length} nuevos, ${rt.length} actualizados.`,"success"),setTimeout(()=>{wt(),typeof m=="function"&&m()},2e3)}catch(Re){console.error("Error al importar números:",Re),(Ne=window.showToast)==null||Ne.call(window,`Error al importar números: ${Re.message}`,"error"),M&&(M.disabled=!1)}}function Xe(v,I){const q=document.getElementById("import-progress-bar"),M=document.getElementById("import-progress-percent"),Q=document.getElementById("import-progress-text");q&&(q.style.width=`${v}%`),M&&(M.textContent=`${Math.round(v)}%`),Q&&(Q.textContent=I)}})();(function(){let z=!1,e=null,t=[];const n={panel:"smart-promotions",grid:"smart-promos-grid",empty:"smart-promos-empty",activeCount:"smart-promos-active-count",scheduledCount:"smart-promos-scheduled-count",todayCount:"smart-promos-today-count",modal:"smart-promo-modal",modalTitle:"smart-promo-modal-title",form:"smart-promo-form",title:"smart-promo-title",description:"smart-promo-description",benefits:"smart-promo-benefits",cta:"smart-promo-cta",images:"smart-promo-images",autoInsert:"smart-promo-auto",startAt:"smart-promo-start",endAt:"smart-promo-end",noSchedule:"smart-promo-no-schedule",active:"smart-promo-active",maxMentions:"smart-promo-max-mentions",aiBtn:"smart-promo-ai-btn",refreshBtn:"smart-promos-refresh",newBtn:"smart-promos-new-btn",emptyBtn:"smart-promos-empty-btn"};document.addEventListener("panel:activated",async({detail:c})=>{c.panelId===n.panel&&(z||(p(),z=!0),await b())});function p(){var m,g,k,f,u,l,s;(m=document.getElementById(n.refreshBtn))==null||m.addEventListener("click",()=>b()),(g=document.getElementById(n.newBtn))==null||g.addEventListener("click",()=>Ee()),(k=document.getElementById(n.emptyBtn))==null||k.addEventListener("click",()=>Ee()),(f=document.querySelectorAll("#smart-promo-modal [data-modal-close]"))==null||f.forEach(r=>{r.addEventListener("click",()=>me())}),(u=document.getElementById(n.noSchedule))==null||u.addEventListener("change",W),(l=document.getElementById(n.aiBtn))==null||l.addEventListener("click",Ie);const c=document.getElementById(n.form);c&&c.addEventListener("submit",ue);const o=document.getElementById(n.modal);o&&o.addEventListener("click",r=>{r.target.dataset.modalClose!==void 0&&me()}),(s=document.getElementById(n.grid))==null||s.addEventListener("click",be)}async function b(){var c,o,m;try{const{data:g,error:k}=await window.auth.sb.from("smart_promotions").select("*").order("created_at",{ascending:!1});if(k){if(k.code==="PGRST205"||(c=k.message)!=null&&c.includes("Could not find the table")){console.error("[smart-promotions] La tabla smart_promotions no existe. Ejecuta la migración SQL primero."),(o=window.showToast)==null||o.call(window,"La tabla de promociones no está configurada. Contacta al administrador.","error");return}throw k}t=g||[],_()}catch(g){console.error("[smart-promotions] Error al cargar promos:",g);const k=g.message||"Error desconocido";(m=window.showToast)==null||m.call(window,`No se pudieron cargar las promos: ${k}`,"error")}}function _(){var m;const c=document.getElementById(n.grid),o=document.getElementById(n.empty);!c||!o||(t.length?(o.classList.add("hidden"),c.innerHTML=t.map(A).join("")):(c.innerHTML="",o.classList.remove("hidden")),B(),(m=window.lucide)!=null&&m.createIcons&&window.lucide.createIcons({root:c||document}))}async function B(){var c;try{const o=window.auth.getSession();if(!((c=o==null?void 0:o.user)!=null&&c.id)){const k=new Date,f=t.filter(N).length,u=t.filter(s=>H(s,k)).length,l=t.filter(s=>s.last_triggered_at&&U(s.last_triggered_at,k)).length;document.getElementById(n.activeCount).textContent=f,document.getElementById(n.scheduledCount).textContent=u,document.getElementById(n.todayCount).textContent=l;return}const{data:m,error:g}=await window.auth.sb.rpc("get_smart_promotions_stats",{p_user_id:o.user.id});if(g){console.warn("[smart-promotions] Error al obtener estadísticas, usando cálculo local:",g);const k=new Date,f=t.filter(N).length,u=t.filter(s=>H(s,k)).length,l=t.filter(s=>s.last_triggered_at&&U(s.last_triggered_at,k)).length;document.getElementById(n.activeCount).textContent=f,document.getElementById(n.scheduledCount).textContent=u,document.getElementById(n.todayCount).textContent=l;return}m&&(document.getElementById(n.activeCount).textContent=m.active_count||0,document.getElementById(n.scheduledCount).textContent=m.scheduled_count||0,document.getElementById(n.todayCount).textContent=m.today_count||0)}catch(o){console.error("[smart-promotions] Error al actualizar estadísticas:",o);const m=new Date,g=t.filter(N).length,k=t.filter(u=>H(u,m)).length,f=t.filter(u=>u.last_triggered_at&&U(u.last_triggered_at,m)).length;document.getElementById(n.activeCount).textContent=g,document.getElementById(n.scheduledCount).textContent=k,document.getElementById(n.todayCount).textContent=f}}function A(c){const o=N(c),m=H(c),g=o?"Activa":m?"Programada":"Inactiva",k=o?"bg-green-100 text-green-700":m?"bg-amber-100 text-amber-700":"bg-slate-200 text-slate-700",f=(c.image_urls||[]).slice(0,3).map(u=>`<span class="text-xs bg-slate-100 px-2 py-0.5 rounded-full truncate" title="${u}">Imagen</span>`).join("");return`
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-5 flex flex-col gap-4" data-id="${c.id}">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${k}">${g}</span>
                        <h3 class="text-xl font-semibold mt-2 text-slate-900">${c.title}</h3>
                        <p class="text-sm text-slate-600 mt-1">${c.description||"Sin descripción"}</p>
                    </div>
                    <div class="text-right text-xs text-slate-500 leading-5">
                        ${X(c)}
                        <div>Auto: ${c.auto_insert?"Sí":"No"}</div>
                        <div>Menciones hoy máx.: ${c.max_mentions_per_day||3}</div>
                    </div>
                </div>
                ${c.benefits?`<div class="text-sm text-slate-500 border-l-4 border-slate-200 pl-3">${c.benefits}</div>`:""}
                ${f?`<div class="flex flex-wrap gap-2">${f}</div>`:""}
                <div class="flex flex-wrap gap-2 mt-2">
                    <button class="promo-action inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-200 text-sm text-slate-600 hover:bg-slate-100" data-action="edit" data-id="${c.id}">
                        <i data-lucide="edit-3" class="w-4 h-4"></i> Editar
                    </button>
                    <button class="promo-action inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-200 text-sm text-slate-600 hover:bg-slate-100" data-action="clone" data-id="${c.id}">
                        <i data-lucide="copy" class="w-4 h-4"></i> Duplicar
                    </button>
                    <button class="promo-action inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-200 text-sm text-slate-600 hover:bg-slate-100" data-action="toggle" data-id="${c.id}">
                        <i data-lucide="${c.is_active?"pause":"play"}" class="w-4 h-4"></i> ${c.is_active?"Pausar":"Activar"}
                    </button>
                    <button class="promo-action inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-red-200 text-sm text-red-600 hover:bg-red-50" data-action="delete" data-id="${c.id}">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Eliminar
                    </button>
                </div>
            </div>
        `}function N(c){if(!c.is_active)return!1;if(c.no_schedule)return!0;const o=new Date,m=!c.start_at||new Date(c.start_at)<=o,g=!c.end_at||new Date(c.end_at)>=o;return m&&g}function H(c,o=new Date){return c.no_schedule||!c.start_at?!1:new Date(c.start_at)>o}function U(c,o){const m=new Date(c);return m.getUTCFullYear()===o.getUTCFullYear()&&m.getUTCMonth()===o.getUTCMonth()&&m.getUTCDate()===o.getUTCDate()}function X(c){if(c.no_schedule)return'<span class="text-xs font-semibold text-blue-500">Sin horario definido</span>';if(!c.start_at&&!c.end_at)return'<span class="text-xs text-slate-500">Sin fechas</span>';const o={dateStyle:"medium",timeStyle:"short"},m=c.start_at?new Date(c.start_at).toLocaleString("es-MX",o):"Inmediato",g=c.end_at?new Date(c.end_at).toLocaleString("es-MX",o):"Sin fin";return`<div>${m} → ${g}</div>`}function Ee(c=null,o=!1){e=c&&!o?c.id:null,document.getElementById(n.modalTitle).textContent=c&&!o?"Editar Promo":"Nueva Promo",document.getElementById(n.title).value=c?`${c.title}${o?" (copia)":""}`:"",document.getElementById(n.description).value=(c==null?void 0:c.description)||"",document.getElementById(n.benefits).value=(c==null?void 0:c.benefits)||"",document.getElementById(n.cta).value=(c==null?void 0:c.call_to_action)||"",document.getElementById(n.images).value=((c==null?void 0:c.image_urls)||[]).join(", "),document.getElementById(n.autoInsert).checked=(c==null?void 0:c.auto_insert)??!0,document.getElementById(n.noSchedule).checked=(c==null?void 0:c.no_schedule)??!1,document.getElementById(n.active).checked=(c==null?void 0:c.is_active)??!0,document.getElementById(n.maxMentions).value=(c==null?void 0:c.max_mentions_per_day)??3,document.getElementById(n.startAt).value=c!=null&&c.start_at?ne(c.start_at):"",document.getElementById(n.endAt).value=c!=null&&c.end_at?ne(c.end_at):"",W(),oe((c==null?void 0:c.image_urls)||[]);const m=document.getElementById(n.modal);m&&(m.classList.remove("hidden"),m.classList.add("flex"))}function me(){var m;const c=document.getElementById(n.modal);c&&(c.classList.add("hidden"),c.classList.remove("flex")),(m=document.getElementById(n.form))==null||m.reset();const o=document.getElementById("smart-promo-images-container");o&&(o.innerHTML=""),e=null}function W(){var o;const c=(o=document.getElementById(n.noSchedule))==null?void 0:o.checked;["startAt","endAt"].forEach(m=>{const g=document.getElementById(n[m]);g&&(g.disabled=c,c&&(g.value=""))})}async function ue(c){var m,g,k,f,u,l;c.preventDefault();const o=te();try{if(!e){const s=window.auth.getSession();if(!((m=s==null?void 0:s.user)!=null&&m.id))throw new Error("No se pudo obtener el usuario actual");o.user_id=s.user.id}if(e){const{error:s}=await window.auth.sb.from("smart_promotions").update(o).eq("id",e);if(s)throw s.code==="PGRST205"||(g=s.message)!=null&&g.includes("Could not find the table")?new Error("La tabla smart_promotions no existe. Ejecuta la migración SQL primero."):s;(k=window.showToast)==null||k.call(window,"Promo actualizada","success")}else{const{error:s}=await window.auth.sb.from("smart_promotions").insert(o);if(s)throw s.code==="PGRST205"||(f=s.message)!=null&&f.includes("Could not find the table")?new Error("La tabla smart_promotions no existe. Ejecuta la migración SQL primero."):s;(u=window.showToast)==null||u.call(window,"Promo creada","success")}me(),await b()}catch(s){console.error("[smart-promotions] Error guardando promo:",s);const r=s.message||"Error desconocido";(l=window.showToast)==null||l.call(window,`No se pudo guardar la promo: ${r}`,"error")}}function te(){const c=document.getElementById("smart-promo-images-container");let o=[];if(c){const g=c.querySelectorAll("[data-image-url]");o=Array.from(g).map(k=>k.dataset.imageUrl).filter(Boolean)}const m=document.getElementById(n.images).value.trim();if(m&&o.length===0)o=m.split(",").map(g=>g.trim()).filter(Boolean);else if(m&&o.length>0){const g=m.split(",").map(k=>k.trim()).filter(Boolean);o=[...new Set([...o,...g])]}return{title:document.getElementById(n.title).value.trim(),description:document.getElementById(n.description).value.trim(),benefits:document.getElementById(n.benefits).value.trim()||null,call_to_action:document.getElementById(n.cta).value.trim()||null,image_urls:o,auto_insert:document.getElementById(n.autoInsert).checked,no_schedule:document.getElementById(n.noSchedule).checked,is_active:document.getElementById(n.active).checked,start_at:document.getElementById(n.noSchedule).checked?null:re(document.getElementById(n.startAt).value),end_at:document.getElementById(n.noSchedule).checked?null:re(document.getElementById(n.endAt).value),max_mentions_per_day:parseInt(document.getElementById(n.maxMentions).value||"3",10)}}function re(c){if(!c)return null;const o=new Date(c);return isNaN(o.getTime())?null:o.toISOString()}function ne(c){const o=new Date(c);if(isNaN(o.getTime()))return"";const m=g=>String(g).padStart(2,"0");return`${o.getFullYear()}-${m(o.getMonth()+1)}-${m(o.getDate())}T${m(o.getHours())}:${m(o.getMinutes())}`}function be(c){const o=c.target.closest(".promo-action");if(!o)return;const{action:m,id:g}=o.dataset;if(!m||!g)return;const k=t.find(f=>f.id===g);if(k)switch(m){case"edit":Ee(k);break;case"clone":Ee(k,!0);break;case"toggle":ce(k);break;case"delete":Y(k);break}}async function ce(c){var o,m;try{const{error:g}=await window.auth.sb.from("smart_promotions").update({is_active:!c.is_active}).eq("id",c.id);if(g)throw g;(o=window.showToast)==null||o.call(window,c.is_active?"Promo pausada":"Promo activada","success"),await b()}catch(g){console.error("[smart-promotions] Error al cambiar estado:",g),(m=window.showToast)==null||m.call(window,"No se pudo actualizar el estado.","error")}}async function Y(c){var o,m;if(confirm(`¿Eliminar la promo "${c.title}"?`))try{const{error:g}=await window.auth.sb.from("smart_promotions").delete().eq("id",c.id);if(g)throw g;(o=window.showToast)==null||o.call(window,"Promo eliminada","success"),await b()}catch(g){console.error("[smart-promotions] Error al eliminar:",g),(m=window.showToast)==null||m.call(window,"No se pudo eliminar la promo.","error")}}function Ie(){var k,f;const c=document.getElementById(n.description).value.trim(),o=document.getElementById(n.benefits).value.trim(),g=`${document.getElementById(n.title).value.trim()}

${c}

Beneficios:
${o}`;if(!((k=window.appInstance)!=null&&k.openAiEnhanceModal)){(f=window.showToast)==null||f.call(window,"La mejora con IA no está disponible en este momento.","info");return}window.appInstance.openAiEnhanceModal(g,u=>{document.getElementById(n.description).value=u})}async function _e(c,o="smart-promotions"){var g;if(!c)throw new Error("No se proporcionó ningún archivo");const m=window.auth.getSession();if(!((g=m==null?void 0:m.user)!=null&&g.id))throw new Error("No se pudo obtener el usuario actual");try{const k=await new Promise((l,s)=>{const r=new FileReader;r.onload=()=>{const w=r.result,a=w.includes(",")?w.split(",")[1]:w;l(a)},r.onerror=s,r.readAsDataURL(c)}),{data:f,error:u}=await window.auth.invokeFunction("smart-worker",{body:{userId:m.user.id,b64_json:k,subfolder:o}});if(u)throw new Error(u.message||"Error al subir la imagen");if(!(f!=null&&f.cdnUrl))throw new Error("La función no devolvió una URL de CDN");return f.cdnUrl}catch(k){throw console.error("[smart-promotions] Error al subir imagen:",k),k}}window.uploadImageToBunny=_e;function oe(c){var m;const o=document.getElementById("smart-promo-images-container");if(o){if(o.innerHTML="",c.forEach((g,k)=>{if(!g)return;const f=ae(g,k);o.insertAdjacentHTML("beforeend",f)}),c.length<10){const g=document.createElement("div");g.className="image-upload-slot border-2 border-dashed border-slate-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 transition-colors",g.innerHTML=`
                <i data-lucide="upload" class="w-6 h-6 mx-auto mb-2 text-slate-400"></i>
                <p class="text-sm text-slate-500">Subir imagen</p>
                <input type="file" accept="image/*" class="hidden" id="smart-promo-image-input" />
            `,g.addEventListener("click",()=>{var f;(f=document.getElementById("smart-promo-image-input"))==null||f.click()}),o.appendChild(g);const k=document.getElementById("smart-promo-image-input");k&&k.addEventListener("change",D)}(m=window.lucide)!=null&&m.createIcons&&window.lucide.createIcons({root:o})}}function ae(c,o){return`
            <div class="relative group" data-image-url="${c}">
                <img src="${c}" alt="Imagen ${o+1}" 
                     class="w-full h-32 object-cover rounded-lg border border-slate-200" />
                <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1.5 opacity-0 group-hover:opacity-100 transition-opacity remove-image-btn"
                        data-url="${c}">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        `}async function D(c){var k,f,u,l,s,r,w,a;const o=(k=c.target.files)==null?void 0:k[0];if(!o)return;if(!o.type.startsWith("image/")){(f=window.showToast)==null||f.call(window,"Por favor selecciona un archivo de imagen válido","error");return}if(o.size>10*1024*1024){(u=window.showToast)==null||u.call(window,"La imagen es demasiado grande. Máximo 10MB","error");return}const m=document.getElementById("smart-promo-images-container");if(!m)return;const g=`loading-${Date.now()}`;m.insertAdjacentHTML("beforeend",`
            <div id="${g}" class="border-2 border-dashed border-blue-300 rounded-lg p-4 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                <p class="text-sm text-slate-500 mt-2">Subiendo...</p>
            </div>
        `);try{const i=await _e(o,"smart-promotions");(l=document.getElementById(g))==null||l.remove();const y=ae(i,m.querySelectorAll("[data-image-url]").length);m.insertAdjacentHTML("beforeend",y);const d=m.querySelector(`[data-url="${i}"]`);d&&d.addEventListener("click",()=>{const E=d.closest("[data-image-url]");E==null||E.remove()}),(s=window.lucide)!=null&&s.createIcons&&window.lucide.createIcons({root:m}),(r=window.showToast)==null||r.call(window,"Imagen subida correctamente","success")}catch(i){(w=document.getElementById(g))==null||w.remove(),console.error("[smart-promotions] Error al subir imagen:",i),(a=window.showToast)==null||a.call(window,`Error al subir imagen: ${i.message}`,"error")}c.target.value=""}document.addEventListener("click",c=>{if(c.target.closest(".remove-image-btn")){const m=c.target.closest(".remove-image-btn").closest("[data-image-url]");m==null||m.remove()}})})();(function(){let z=!1,e=!0,t=null;document.addEventListener("panel:activated",async({detail:f})=>{f.panelId==="sales-context"&&(z||(n(),z=!0),await re())});function n(){var u,l,s,r;const f=document.getElementById("sales-context-form");f==null||f.addEventListener("submit",ne),f==null||f.addEventListener("input",A),(u=document.getElementById("sales-context-clear"))==null||u.addEventListener("click",()=>{f==null||f.reset();const w=document.getElementById("sales-context-active");w&&(w.checked=!0),H()}),(l=document.getElementById("add-objection-btn"))==null||l.addEventListener("click",()=>{Ee()}),document.addEventListener("click",w=>{var a;w.target.closest(".remove-objection-btn")&&((a=w.target.closest(".bg-white"))==null||a.remove())}),(s=document.getElementById("sales-context-load-defaults"))==null||s.addEventListener("click",p),(r=document.getElementById("add-critical-rule-btn"))==null||r.addEventListener("click",k),document.addEventListener("click",w=>{w.target.closest(".delete-critical-rule-btn")&&oe(w.target.closest(".delete-critical-rule-btn")),w.target.closest(".toggle-critical-rule")&&_e(w.target.closest(".toggle-critical-rule"))})}function p(){var f;H(),(f=window.showToast)==null||f.call(window,"Objeciones comunes cargadas. Puedes editarlas o generar respuestas automáticas con el botón 🤖.","success")}async function b(f,u){var E,h,x,S,$,G,Z,V,pe,we;const l=f.querySelector(".generate-response-btn"),s=l.innerHTML,r=f.querySelector(".objection-display"),w=f.querySelector(".objection-edit"),a=f.querySelector(".response-text"),i=f.querySelector(".response-input"),y=f.querySelector(".edit-objection-btn"),d=f.querySelector(".save-objection-btn");r&&w&&(r.classList.remove("hidden"),w.classList.add("hidden"),y&&y.classList.remove("hidden"),d&&d.classList.add("hidden"));try{l.disabled=!0,l.innerHTML='<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>',(E=window.lucide)!=null&&E.createIcons&&window.lucide.createIcons({root:f});const ie=_();if(!ie)throw new Error("No se pudo obtener el usuario");const[O,Be]=await Promise.all([window.auth.sb.from("prompts").select("prompt_content").eq("user_id",ie).single(),window.auth.sb.from("profiles").select("company_description, website, social_media").eq("id",ie).single()]),qe=((h=O.data)==null?void 0:h.prompt_content)||"",L=((x=Be.data)==null?void 0:x.company_description)||"",F=((S=Be.data)==null?void 0:S.website)||"",P=(($=Be.data)==null?void 0:$.social_media)||{};if(!qe&&!L){(G=window.showToast)==null||G.call(window,"Necesitas configurar tu prompt general o la descripción de tu empresa en Configuración","warning");return}let j=`Objeción del cliente: "${u}"

`;qe&&(j+=`Prompt general de la empresa:
${qe}

`),L&&(j+=`Información de la empresa:
${L}

`),F&&(j+=`Sitio web: ${F}
`),(P.instagram||P.facebook)&&(j+="Redes sociales: ",P.instagram&&(j+=`Instagram: ${P.instagram} `),P.facebook&&(j+=`Facebook: ${P.facebook}`),j+=`

`),j+="Tarea: Genera una respuesta profesional y personalizada para esta objeción, usando la información de la empresa. La respuesta debe ser concisa (2-3 oraciones) y explicar cómo debe responder la IA cuando detecte esta objeción.";const{data:se,error:fe}=await window.auth.sb.functions.invoke("openai-proxy",{body:{prompt:j,systemInstruction:"Eres un asistente experto en ventas. Genera respuestas concisas y profesionales para objeciones comunes, basándote en la información de la empresa proporcionada. La respuesta debe ser de 2-3 oraciones máximo.",model:"gpt-4o-mini"}});if(fe)throw fe;const ge=((Z=se==null?void 0:se.content)==null?void 0:Z.trim())||"";if(!ge)throw new Error("No se pudo generar la respuesta");a&&(a.textContent=ge),i&&(i.value=ge),r&&w&&(r.classList.remove("hidden"),w.classList.add("hidden")),(V=window.showToast)==null||V.call(window,"Respuesta generada correctamente. Puedes editarla haciendo clic en el ícono de lápiz.","success")}catch(ie){console.error("[sales-context] Error al generar respuesta:",ie),(pe=window.showToast)==null||pe.call(window,"Error al generar la respuesta: "+(ie.message||"Error desconocido"),"error")}finally{l.disabled=!1,l.innerHTML=s,(we=window.lucide)!=null&&we.createIcons&&window.lucide.createIcons({root:f})}}const _=()=>{var f,u;return(u=(f=window.auth.getSession())==null?void 0:f.user)==null?void 0:u.id},B=()=>{var r,w;const f=((r=document.getElementById("sales-context-active"))==null?void 0:r.checked)??!0,u=((w=document.getElementById("sales-context-auto-generate"))==null?void 0:w.checked)??!0,l=document.querySelectorAll("#objections-list .objection-card"),s=Array.from(l).map(a=>{var d,E,h,x;const i=((E=(d=a.querySelector(".objection-text"))==null?void 0:d.textContent)==null?void 0:E.trim())||"",y=((x=(h=a.querySelector(".response-text"))==null?void 0:h.textContent)==null?void 0:x.trim())||"";return{objection:i,response:y}}).filter(a=>a.objection&&a.response);return{title:"Contexto de Ventas",is_active:f,auto_generate_responses:u,prompt:{detected_objections:s.length>0?s:null}}};function A(){}function N(f){var l;const u=document.getElementById("sales-context-form");u&&(u.querySelectorAll('input, textarea, button[type="submit"], button[type="button"]').forEach(s=>{s.disabled=f}),f||(l=document.getElementById("sales-context-clear"))==null||l.removeAttribute("disabled"))}function H(){if(!document.getElementById("sales-context-detected-objections"))return;U([{objection:'"Es muy caro"',response:"Preguntar si el precio es el único problema o si hay dudas técnicas"},{objection:'"Déjame pensarlo"',response:"Preguntar qué duda específica tiene para poder ayudarlo"},{objection:'"Lo consultaré con mi socio/esposa"',response:"Ofrecer un resumen corto de 3 puntos para compartir"}])}function U(f){var a,i;const u=document.getElementById("sales-context-detected-objections");if(!u)return;const l=f&&Array.isArray(f)&&f.length>0?f:[{objection:'"Es muy caro"',response:"Preguntar si el precio es el único problema o si hay dudas técnicas"},{objection:'"Déjame pensarlo"',response:"Preguntar qué duda específica tiene para poder ayudarlo"},{objection:'"Lo consultaré con mi socio/esposa"',response:"Ofrecer un resumen corto de 3 puntos para compartir"}],s=((a=u.querySelector("#add-objection-btn"))==null?void 0:a.outerHTML)||"";u.innerHTML="";const r=document.createElement("p");r.className="text-sm text-slate-600 mb-3",r.innerHTML='<i data-lucide="info" class="w-4 h-4 inline mr-2"></i>La IA detectará automáticamente estas objeciones. Puedes editarlas haciendo clic en el ícono de lápiz ✏️.',u.appendChild(r);const w=document.createElement("div");if(w.id="objections-list",w.className="space-y-2",u.appendChild(w),l.forEach((y,d)=>{const E=X(y.objection,y.response,d);w.appendChild(E)}),s)u.insertAdjacentHTML("beforeend",s);else{const y=document.createElement("button");y.type="button",y.id="add-objection-btn",y.className="mt-3 text-sm text-blue-600 hover:text-blue-700 font-semibold flex items-center gap-2",y.innerHTML='<i data-lucide="plus" class="w-4 h-4"></i> Agregar objeción personalizada',y.addEventListener("click",Ee),u.appendChild(y)}(i=window.lucide)!=null&&i.createIcons&&window.lucide.createIcons({root:u})}function X(f,u,l){const s=document.createElement("div");s.className="flex items-start gap-2 bg-white p-3 rounded-lg border border-slate-200 objection-card",s.dataset.index=l,s.innerHTML=`
            <div class="flex-1">
                <div class="objection-display">
                    <p class="text-sm font-semibold text-slate-700 objection-text">${f}</p>
                    <p class="text-xs text-slate-500 mt-1 response-text">${u}</p>
                </div>
                <div class="objection-edit hidden">
                    <input type="text" class="objection-input w-full text-sm font-semibold text-slate-700 border border-slate-300 rounded px-2 py-1 mb-2" value="${f}" placeholder="Objeción (ej: 'Es muy caro')">
                    <textarea class="response-input w-full text-xs text-slate-500 border border-slate-300 rounded px-2 py-1" rows="2" placeholder="Cómo debe responder la IA">${u}</textarea>
                </div>
            </div>
            <div class="flex gap-1">
                <button type="button" class="text-purple-500 hover:text-purple-700 generate-response-btn" title="Generar respuesta para mi empresa">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                </button>
                <button type="button" class="text-blue-500 hover:text-blue-700 edit-objection-btn" title="Editar">
                    <i data-lucide="pencil" class="w-4 h-4"></i>
                </button>
                <button type="button" class="text-green-500 hover:text-green-700 save-objection-btn hidden" title="Guardar">
                    <i data-lucide="check" class="w-4 h-4"></i>
                </button>
                <button type="button" class="text-red-500 hover:text-red-700 remove-objection-btn" title="Eliminar">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        `;const r=s.querySelector(".generate-response-btn"),w=s.querySelector(".edit-objection-btn"),a=s.querySelector(".save-objection-btn"),i=s.querySelector(".remove-objection-btn"),y=s.querySelector(".objection-display"),d=s.querySelector(".objection-edit"),E=s.querySelector(".objection-input"),h=s.querySelector(".response-input");return r.addEventListener("click",async()=>{var S,$;const x=(($=(S=s.querySelector(".objection-text"))==null?void 0:S.textContent)==null?void 0:$.trim())||f;await b(s,x)}),w.addEventListener("click",()=>{y.classList.add("hidden"),d.classList.remove("hidden"),w.classList.add("hidden"),a.classList.remove("hidden"),E.focus()}),a.addEventListener("click",()=>{var $,G;const x=E.value.trim(),S=h.value.trim();if(!x||!S){($=window.showToast)==null||$.call(window,"La objeción y la respuesta no pueden estar vacías","error");return}s.querySelector(".objection-text").textContent=x,s.querySelector(".response-text").textContent=S,y.classList.remove("hidden"),d.classList.add("hidden"),w.classList.remove("hidden"),a.classList.add("hidden"),(G=window.lucide)!=null&&G.createIcons&&window.lucide.createIcons({root:s})}),i.addEventListener("click",async()=>{var S;await((S=window.appModal)==null?void 0:S.confirm("¿Eliminar esta objeción?","Eliminar Objeción"))&&s.remove()}),[E,h].forEach(x=>{x.addEventListener("keydown",S=>{S.key==="Enter"&&S.ctrlKey&&a.click()})}),s}function Ee(){var r,w;const f=document.getElementById("sales-context-detected-objections");if(!f)return;let u=document.getElementById("objections-list");if(!u){u=document.createElement("div"),u.id="objections-list",u.className="space-y-2";const a=f.querySelector("#add-objection-btn");f.insertBefore(u,a||f.lastElementChild)}const l=X("Nueva objeción","Escribe cómo debe responder la IA...",Date.now());u.appendChild(l);const s=l.querySelector(".edit-objection-btn");s&&s.click(),(r=window.lucide)!=null&&r.createIcons&&window.lucide.createIcons({root:f}),(w=window.showToast)==null||w.call(window,"Nueva objeción agregada. Edítala y guarda.","success")}const me=(f,u)=>!f||f.code!=="PGRST205"?!1:u?(f.message||"").toLowerCase().includes(u.toLowerCase()):!0,W=f=>{if(!f)return!1;if(me(f))return!0;const u=(f.message||"").toLowerCase();return u.includes("is_active")||u.includes("column")};function ue(f){var u;e=!1,N(!0),console.warn("[sales-context]",f),(u=window.showToast)==null||u.call(window,f,"warning")}async function te(f){if(!e)return null;const u=window.auth.sb,l="id,user_id,title,prompt,is_active,updated_at",s=()=>u.from("sales_prompts").select(l).eq("user_id",f).eq("is_active",!0).order("updated_at",{ascending:!1}).limit(1);let{data:r,error:w}=await s();if(w&&W(w)&&({data:r,error:w}=await u.from("sales_prompts_active").select("id,user_id,title,prompt,updated_at").eq("user_id",f).limit(1)),w&&me(w,"sales_prompts_active"))return ue("El contexto comercial requiere la migración que crea sales_prompts."),null;if(w)throw w;return(r==null?void 0:r[0])??null}async function re(){var u,l;const f=_();if(f&&e){N(!0);try{t=await te(f);const s=document.getElementById("sales-context-active"),r=document.getElementById("sales-context-auto-generate");if(!t)s&&(s.checked=!0),r&&(r.checked=!0),H();else{s&&(s.checked=t.is_active??!0),r&&(r.checked=t.auto_generate_responses??!0);const w=(u=t.prompt)==null?void 0:u.detected_objections;w&&Array.isArray(w)&&w.length>0?U(w):H()}await be(f)}catch(s){console.error("[sales-context] No se pudo cargar el contexto:",s),(l=window.showToast)==null||l.call(window,"No pudimos cargar tu contexto comercial.","error")}finally{e&&N(!1)}}}async function ne(f){var s,r,w;if(f.preventDefault(),!e)return;const u=_();if(!u){(s=window.showToast)==null||s.call(window,"Inicia sesión nuevamente para guardar tu contexto.","error");return}const l=B();N(!0);try{const{error:a}=await window.auth.sb.from("sales_prompts").update({is_active:!1}).eq("user_id",u);if(a){if(me(a,"sales_prompts")){ue("El contexto comercial requiere la tabla sales_prompts.");return}throw a}const{error:i}=await window.auth.sb.from("sales_prompts").insert({user_id:u,title:l.title||"Contexto sin título",prompt:l.prompt,is_active:l.is_active,auto_generate_responses:l.auto_generate_responses});if(i){if(me(i,"sales_prompts")){ue("El contexto comercial requiere la tabla sales_prompts.");return}throw i}(r=window.showToast)==null||r.call(window,"Contexto comercial guardado","success"),await re()}catch(a){console.error("[sales-context] Error al guardar:",a),(w=window.showToast)==null||w.call(window,a.message||"No pudimos guardar tu contexto comercial.","error")}finally{e&&N(!1)}}async function be(f){try{const{data:u,error:l}=await window.auth.sb.from("critical_rules").select("*").eq("user_id",f).order("is_predefined",{ascending:!1}).order("priority",{ascending:!0});if(l){console.error("[sales-context] Error al cargar críticos:",l);return}const s=(u||[]).filter(w=>w.is_predefined),r=(u||[]).filter(w=>!w.is_predefined);ce(s),Y(r)}catch(u){console.error("[sales-context] Error al cargar críticos:",u)}}function ce(f){const u=document.getElementById("predefined-critical-rules");if(!u)return;const l=[{rule_name:"Solicitud de Humano",detection_type:"human_request",is_active:!0},{rule_name:"Intención de Compra",detection_type:"purchase_intent",is_active:!0},{rule_name:"Atención Urgente",detection_type:"urgent_attention",is_active:!0}];u.innerHTML=l.map(s=>{const r=f.find(i=>i.detection_type===s.detection_type),w=r?r.is_active:s.is_active,a=r?r.id:null;return`
                <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-slate-200" data-rule-id="${a||""}" data-detection-type="${s.detection_type}">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" class="toggle-critical-rule h-4 w-4 rounded text-blue-600" ${w?"checked":""} data-rule-id="${a||""}" data-detection-type="${s.detection_type}">
                        <div>
                            <p class="text-sm font-semibold text-slate-700">${s.rule_name}</p>
                            <p class="text-xs text-slate-500">Detecta cuando un cliente ${s.detection_type==="human_request"?"quiere hablar con un humano":s.detection_type==="purchase_intent"?"muestra intención de compra":"requiere atención urgente"}</p>
                        </div>
                    </div>
                </div>
            `}).join("")}function Y(f){var l;const u=document.getElementById("custom-critical-rules");if(u){if(!f||f.length===0){u.innerHTML='<p class="text-sm text-slate-500 text-center py-4">No has agregado críticos personalizados aún.</p>';return}u.innerHTML=f.map(s=>Ie(s)).join(""),(l=window.lucide)!=null&&l.createIcons&&window.lucide.createIcons({root:u})}}function Ie(f){const u=f.rule_type==="pattern"?"Patrón (regex)":"Palabra clave";return`
            <div class="bg-white p-3 rounded-lg border border-slate-200 critical-rule-card" data-rule-id="${f.id}">
                <div class="flex items-start justify-between gap-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <input type="checkbox" class="toggle-critical-rule h-4 w-4 rounded text-blue-600" ${f.is_active?"checked":""} data-rule-id="${f.id}">
                            <p class="text-sm font-semibold text-slate-700">${f.rule_name}</p>
                            <span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-700">${u}</span>
                        </div>
                        <p class="text-xs text-slate-600 font-mono bg-slate-50 p-2 rounded mt-1">${f.pattern_or_keyword}</p>
                        <p class="text-xs text-slate-500 mt-1">Tipo: ${f.detection_type}</p>
                    </div>
                    <button type="button" class="delete-critical-rule-btn text-red-500 hover:text-red-700" data-rule-id="${f.id}" title="Eliminar">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        `}async function _e(f){var w,a;const u=f.dataset.ruleId,l=f.dataset.detectionType,s=f.checked,r=_();if(r)try{if(u){const{error:i}=await window.auth.sb.from("critical_rules").update({is_active:s}).eq("id",u).eq("user_id",r);if(i)throw i}else if(l){const{error:i}=await window.auth.sb.rpc("initialize_default_critical_rules",{p_user_id:r});if(i)throw i;const{error:y}=await window.auth.sb.from("critical_rules").update({is_active:s}).eq("user_id",r).eq("detection_type",l).eq("is_predefined",!0);if(y)throw y}(w=window.showToast)==null||w.call(window,"Configuración de crítico actualizada","success")}catch(i){console.error("[sales-context] Error al actualizar crítico:",i),(a=window.showToast)==null||a.call(window,"No se pudo actualizar el crítico","error"),f.checked=!s}}async function oe(f){var r,w,a,i;const u=f.dataset.ruleId;if(!u||!await((r=window.appModal)==null?void 0:r.confirm("¿Eliminar este crítico personalizado?","Eliminar Crítico")))return;const s=_();if(s)try{const{error:y}=await window.auth.sb.from("critical_rules").delete().eq("id",u).eq("user_id",s).eq("is_predefined",!1);if(y)throw y;(w=f.closest(".critical-rule-card"))==null||w.remove(),(a=window.showToast)==null||a.call(window,"Crítico eliminado","success");const d=document.getElementById("custom-critical-rules");d&&d.querySelectorAll(".critical-rule-card").length===0&&(d.innerHTML='<p class="text-sm text-slate-500 text-center py-4">No has agregado críticos personalizados aún.</p>')}catch(y){console.error("[sales-context] Error al eliminar crítico:",y),(i=window.showToast)==null||i.call(window,"No se pudo eliminar el crítico","error")}}function ae(){const f=document.getElementById("critical-rule-ai-modal");!f||!f.classList||(c(),f.classList.remove("hidden"),o(),typeof lucide<"u"&&lucide.createIcons&&lucide.createIcons())}function D(){const f=document.getElementById("critical-rule-ai-modal");f&&f.classList&&f.classList.add("hidden"),c()}function c(){const f=document.getElementById("critical-rule-name-input"),u=document.getElementById("critical-rule-description-input"),l=document.getElementById("critical-rule-pattern-input"),s=document.getElementById("ai-pattern-result-container"),r=document.getElementById("save-critical-rule-ai"),w=document.getElementById("ai-pattern-explanation"),a=document.getElementById("ai-generated-pattern");f&&(f.value=""),u&&(u.value=""),l&&(l.value=""),s&&s.classList&&s.classList.add("hidden"),r&&(r.disabled=!0),w&&(w.textContent=""),a&&(a.textContent="")}function o(){const f=document.getElementById("close-critical-rule-ai-modal"),u=document.getElementById("cancel-critical-rule-ai"),l=document.getElementById("optimize-pattern-ai-btn"),s=document.getElementById("save-critical-rule-ai"),r=document.getElementById("critical-rule-pattern-input"),w=document.getElementById("critical-rule-name-input");f&&(f.onclick=D),u&&(u.onclick=D),l&&(l.onclick=m),s&&(s.onclick=g);const a=()=>{var E,h;const i=((E=w==null?void 0:w.value)==null?void 0:E.trim())||"",y=((h=r==null?void 0:r.value)==null?void 0:h.trim())||"",d=i.length>0&&y.length>0;s&&(s.disabled=!d,d?(s.classList.remove("opacity-50","cursor-not-allowed"),s.classList.add("hover:bg-green-700")):(s.classList.add("opacity-50","cursor-not-allowed"),s.classList.remove("hover:bg-green-700")))};a(),w&&w.addEventListener("input",a),r&&r.addEventListener("input",a)}async function m(){var d,E,h,x,S,$,G,Z,V,pe,we,ie;const f=document.getElementById("critical-rule-description-input"),u=document.getElementById("critical-rule-name-input"),l=document.getElementById("optimize-pattern-ai-btn"),s=document.getElementById("ai-pattern-result-container"),r=document.getElementById("ai-pattern-explanation"),w=document.getElementById("ai-generated-pattern"),a=document.getElementById("critical-rule-pattern-input"),i=document.getElementById("save-critical-rule-ai");if(!f||!f.value.trim()){(d=window.showToast)==null||d.call(window,"Por favor describe qué quieres detectar antes de optimizar con IA.","warning");return}const y=_();if(!y){(E=window.showToast)==null||E.call(window,"No se pudo obtener el usuario actual.","error");return}l&&(l.disabled=!0,l.innerHTML='<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>');try{const[O,Be,qe]=await Promise.all([window.auth.sb.from("prompts").select("prompt_content").eq("user_id",y).single(),window.auth.sb.from("profiles").select("company_description, website, social_media").eq("id",y).single(),window.auth.sb.from("settings").select("*").eq("user_id",y).single()]),L=((h=O.data)==null?void 0:h.prompt_content)||"",F=((x=Be.data)==null?void 0:x.company_description)||"",P=((S=Be.data)==null?void 0:S.website)||"",j=(($=Be.data)==null?void 0:$.social_media)||{},se=qe.data||{},fe=((G=u==null?void 0:u.value)==null?void 0:G.trim())||"Regla personalizada",ge=f.value.trim();let ye=`Necesito crear una expresión regular para detectar mensajes críticos en conversaciones de WhatsApp.

`;ye+=`Nombre de la regla: "${fe}"

`,ye+=`Descripción de lo que quiero detectar: "${ge}"

`,L&&(ye+=`Contexto del negocio (prompt general):
${L}

`),F&&(ye+=`Descripción de la empresa:
${F}

`),P&&(ye+=`Sitio web: ${P}
`),(se.product_catalog||se.service_catalog)&&(ye+=`Catálogo de productos/servicios: ${JSON.stringify(se.product_catalog||se.service_catalog||{})}

`),ye+=`
Tarea: Genera una expresión regular (regex) en JavaScript que detecte mensajes relacionados con: "${ge}". `,ye+="La expresión regular debe ser flexible para capturar variaciones naturales del lenguaje (con y sin acentos, diferentes formas de escribir, etc.). ",ye+=`Debe ser case-insensitive y capturar variaciones comunes en español mexicano.

`,ye+="Responde SOLO con la expresión regular, sin explicaciones adicionales. Ejemplo de formato: (palabra1|palabra2).*(palabra3|palabra4)";const Ce=`Eres un experto en expresiones regulares y procesamiento de lenguaje natural en español mexicano. 
Genera expresiones regulares optimizadas para detectar patrones en conversaciones de WhatsApp.
Las expresiones deben:
- Ser flexibles para capturar variaciones naturales del lenguaje
- Incluir variaciones con y sin acentos
- Ser case-insensitive
- Capturar diferentes formas de escribir palabras comunes
- Usar grupos de captura y alternativas (|) cuando sea apropiado
- Incluir .* para permitir palabras intermedias cuando sea necesario

Responde SOLO con la expresión regular, sin código adicional, sin explicaciones, sin markdown, sin backticks.`,{data:Ue,error:je}=await window.auth.sb.functions.invoke("openai-proxy",{body:{prompt:ye,systemInstruction:Ce,model:"gpt-4o-mini"}});if(je)throw je;const Oe=(((Z=Ue==null?void 0:Ue.content)==null?void 0:Z.trim())||"").replace(/```[a-z]*\n?/g,"").replace(/```/g,"").replace(/^regex[:=]\s*/i,"").trim();if(!Oe)throw new Error("No se pudo generar el patrón");if(s&&s.classList&&s.classList.remove("hidden"),r&&(r.textContent=`Basándome en tu descripción "${ge}", la IA generó este patrón para detectar mensajes relacionados:`),w&&(w.textContent=Oe),a&&(a.value=Oe,a.dispatchEvent(new Event("input",{bubbles:!0}))),i&&u){const C=((V=u.value)==null?void 0:V.trim().length)>0,T=Oe.length>0,R=C&&T;i.disabled=!R,R?(i.classList.remove("opacity-50","cursor-not-allowed"),i.classList.add("hover:bg-green-700")):(i.classList.add("opacity-50","cursor-not-allowed"),i.classList.remove("hover:bg-green-700")),!C&&T&&((pe=window.showToast)==null||pe.call(window,"Patrón generado. Por favor ingresa un nombre para el crítico.","info"))}(we=window.showToast)==null||we.call(window,"Patrón generado por IA correctamente. Puedes editarlo si lo necesitas.","success")}catch(O){console.error("[sales-context] Error al generar patrón con IA:",O),(ie=window.showToast)==null||ie.call(window,"Error al generar patrón con IA: "+(O.message||"Error desconocido"),"error")}finally{l&&(l.disabled=!1,l.innerHTML='<i data-lucide="sparkles" class="w-5 h-5"></i><span>Optimizar por IA</span>',typeof lucide<"u"&&lucide.createIcons&&lucide.createIcons({root:l}))}}async function g(){var i,y,d,E,h,x,S,$,G,Z;const f=_();if(!f){(i=window.showToast)==null||i.call(window,"No se pudo obtener el usuario actual.","error");return}const u=document.getElementById("critical-rule-name-input"),l=document.getElementById("critical-rule-pattern-input"),s=document.getElementById("save-critical-rule-ai"),r=(y=u==null?void 0:u.value)==null?void 0:y.trim(),w=(d=l==null?void 0:l.value)==null?void 0:d.trim();if(!r||r.length===0){(E=window.showToast)==null||E.call(window,"Por favor ingresa un nombre para el crítico.","error"),s&&(s.disabled=!1,s.textContent="Guardar");return}if(!w||w.length===0){(h=window.showToast)==null||h.call(window,"Por favor genera o ingresa un patrón antes de guardar.","error"),s&&(s.disabled=!1,s.textContent="Guardar");return}const a="custom";s&&(s.disabled=!0,s.textContent="Guardando...");try{try{new RegExp(w,"i")}catch{(x=window.showToast)==null||x.call(window,"El patrón ingresado no es una expresión regular válida. Por favor corrígelo.","error"),s&&(s.disabled=!1,s.textContent="Guardar");return}const{data:V,error:pe}=await window.auth.sb.from("critical_rules").insert({user_id:f,rule_name:r,rule_type:"pattern",pattern_or_keyword:w,detection_type:a,is_active:!0,is_predefined:!1,priority:100});if(pe)throw pe;await be(f),(S=window.showToast)==null||S.call(window,"✅ Crítico guardado exitosamente","success"),D()}catch(V){console.error("[sales-context] Error al guardar crítico:",V);const pe=V.message||"Error desconocido";($=window.showToast)==null||$.call(window,"❌ Error al guardar: "+pe,"error"),s&&(s.disabled=!1,s.textContent="Guardar",s.classList.remove("opacity-50","cursor-not-allowed"))}finally{const V=document.getElementById("critical-rule-ai-modal");if(V&&!V.classList.contains("hidden")&&s){const pe=document.getElementById("critical-rule-name-input"),we=document.getElementById("critical-rule-pattern-input"),ie=((G=pe==null?void 0:pe.value)==null?void 0:G.trim().length)>0,O=((Z=we==null?void 0:we.value)==null?void 0:Z.trim().length)>0;s.disabled=!(ie&&O),s.textContent="Guardar"}}}async function k(){ae()}})();(function(){let z=!1,e="home",t=[],n=null,p=[],b={used:0,limit:0},_=null,B=!1;const A={provider:"gemini",model:"google/nano-banana",aspectRatio:"auto",outputFormat:"png"};window.designerAiSettings=A;let N=!1,H={},U={},X={};const Ee={none:{name:"Ninguno / Manual",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/noun.jpg",prompt:"Create a visually appealing, well-composed, full-bleed promotional social media flyer based *only* on the user's specific instructions for style, text, and visual elements. There is no predefined base style."},"corp-moderno":{name:"Corp. Moderno",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Corporativo%20Moderno.jpg",prompt:"Create a professional, clean, full-bleed promotional social media flyer design. The background should be a smooth, edge-to-edge gradient in corporate blue tones. Use professional, high-quality photos. Typography is a modern, readable sans-serif. Leave ample clean space for text overlays."},elegancia:{name:"Elegancia Min.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Elegancia%20Minimalista.jpg",prompt:"Create an elegant, minimalist, full-bleed promotional social media flyer design. Use a clean, light-colored background (like white or soft gray), a refined serif or sans-serif font. The layout must be uncluttered with generous use of negative space. The overall feeling should be premium and sophisticated."},comida:{name:"Estilo Audaz",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Comida%20Audaz.jpg",prompt:"Create a bold, promotional, full-bleed social media flyer design. Use strong, high-contrast colors like red, yellow, and black. The typography must be large and impactful. The main subject should be presented in a powerful and appealing manner."},colorido:{name:"Colorido",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/Gemini_Generated_Image_th5h7nth5h7nth5h.png",prompt:'Create a "Modern Health Campaign" style full-bleed design. The background should feature smooth, flowing gradients of purple and blue that extend edge-to-edge. All visual and textual elements must be integrated directly into this background, utilizing clean, geometric divisions (e.g., sharp diagonal lines, large color blocks, or integrated rounded shapes). High-quality, relevant photography should be seamlessly blended into sections of this full-bleed layout. Typography is a modern, clean sans-serif, using varying weights and colors to establish clear hierarchy. The overall feel must be trustworthy, informative, and clean.'},urbano:{name:"Collage Urbano",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Collage%20Urbano.jpg",prompt:"Create a dynamic, urban collage-style, full-bleed promotional social media flyer design. Combine textures like torn paper, duct tape, and spray paint splatters. Use a mix of gritty, high-contrast photography and bold, handwritten or stencil-style fonts. The vibe should be edgy and energetic."},deporte:{name:"Estilo Dinámico",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Deporte%20Din%C3%A1mico.jpg",prompt:"Create an energetic and dynamic, full-bleed promotional social media flyer design. Use strong diagonal lines, motion blur effects, and a high-contrast color palette. Typography should be bold, modern, and convey a sense of speed and power."},premium:{name:"Brillo Premium",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Brillo%20Premium.jpg",prompt:"Create a luxurious and premium, full-bleed promotional social media flyer design. Use a dark, sophisticated color palette, often incorporating gold, silver, or metallic accents. Lighting should be elegant, creating soft highlights and shadows. The mood is exclusive and high-end."},lineas:{name:"Líneas",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/Gemini_Generated_Image_r0m7v1r0m7v1r0m7.png",prompt:'Create a "Dynamic Geometric" style design. The composition is based on a clean, bright white background that is geometrically divided by fluid, rounded shapes (circles, capsule-like diagonal forms) in various tones of blue. These shapes must extend to the very edges of the canvas. All visual and textual elements, including photography, must be seamlessly integrated as part of this unified full-bleed canvas. High-quality photography should be directly incorporated into the flow of the geometric shapes or background, forming an organic part of the overall design. Typography is modern and clean sans-serif, using bold weights for headlines and lighter weights for details.'}},me={studio:{name:"Foto de Estudio Clásica",description:"Fondo limpio y neutro.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/foto%20estudio%20clasica.png",prompt:"on a seamless, light gray background. The lighting is a soft, three-point setup, creating subtle, flattering shadows that define the product's form. Hyper-realistic, 8k, tack sharp focus."},lifestyle:{name:"Escena de Estilo de Vida",description:"Integrado en una escena realista.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/lifestyle.png",prompt:"on a rustic wooden coffee shop table, next to a steaming latte with latte art. Natural, soft window lighting is coming from the side. The scene feels candid, atmospheric, and has a shallow depth of field."},"flat-lay":{name:"Plano Cenital (Flat Lay)",description:"Vista desde arriba con accesorios.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/flat%20lay.png",prompt:"in a perfectly organized top-down flat lay composition on a clean white surface alongside a partially open laptop, a pair of stylish eyeglasses, and a small green succulent plant. The lighting is bright, even, and shadowless."},texture:{name:"Sobre Fondo Texturizado",description:"Colocado sobre mármol, madera, etc.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/fondo%20texturizado.png",prompt:"placed on a rough, dark slab of natural slate. A single, strong directional light rakes across the surface, emphasizing the fine texture of the slate and the smooth, glossy glaze of the product. Moody and tactile."},dramatic:{name:"Entorno Dramático",description:"Iluminación cinematográfica.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/entorno%20dramatico.png",prompt:"on a wet, volcanic rock with mist swirling in the background. The lighting is high-contrast and moody, with a single spotlight hitting the product, making it glow. Shot from a low-angle to make it feel monumental and epic."},abstract:{name:"Conceptual y Abstracto",description:"Ambiente surrealista y artístico.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/abstracto.png",prompt:"floating and partially submerged in crystal clear water, with vibrant clouds of blue and orange ink swirling around it. Bold, artistic lighting creates beautiful refractions through the water and on the product's surface."}},W={none:{name:"Ninguno",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/noun.jpg",prompt:""},woman:{name:"Mujer",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/quien%20lo%20usa%20mujer.png",prompt:"a woman is using the product naturally."},man:{name:"Hombre",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/quien%20los%20usa%20hombre.png",prompt:"a man is using the product naturally."}},ue={none:{name:"Ninguno",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/noun.jpg",prompt:""},nature:{name:"Naturaleza",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/donde%20se%20usa%20naturaleza.png",prompt:"The scene is set in a vibrant, natural environment like a forest or a beach."},city:{name:"Urbano",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/donde%20lo%20usa%20urbano.png",prompt:"The scene is set in a dynamic, modern urban environment, like a bustling city street or a stylish cafe."},home:{name:"Hogar",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/donde%20lo%20usa%20hogar.png",prompt:"The scene is set inside a cozy, well-lit home, like a living room or kitchen."}},te={none:{name:"Ninguno",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/noun.jpg",prompt:""},day:{name:"Día",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/ambiente%20dia%20soleado.png",prompt:"The lighting is bright and clear, like a sunny morning or midday."},sunset:{name:"Atardecer",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/ambiente%20atardecer%20dorado.png",prompt:"The lighting is warm and golden, characteristic of a beautiful sunset."},night:{name:"Noche",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/ambiente%20noche.png",prompt:"The scene is set at night, with dramatic, moody lighting from artificial sources like city lights or lamps."}},re={professional:{name:"Profesional",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_tdnut4tdnut4tdnu.png",prompt:"A professional corporate headshot. The person is in business attire, with a soft, out-of-focus modern office background. Lighting is flattering and studio-quality. The expression is confident and approachable. Photorealistic, 8k, sharp focus on the eyes."},casual:{name:"Casual Urbano",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_bo3epfbo3epfbo3e.png",prompt:"A friendly, casual outdoor portrait in a vibrant urban setting, like a stylish city street with bokeh lights. The person is dressed in smart-casual clothing. The lighting is bright, natural daylight, creating a warm and inviting mood. Photorealistic, shallow depth of field."},studio:{name:"Estudio Creativo",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_b7m3uob7m3uob7m3.png",prompt:"A modern, creative studio headshot. The person is against a solid, bold-colored background (like deep teal or mustard yellow). The lighting is more dramatic and artistic, with a key light creating defined shadows. The expression is confident and creative. High-fashion style, sharp details."},nature:{name:"Naturaleza",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_h265k4h265k4h265.png",prompt:"A relaxed, natural headshot in a lush, green environment like a park or forest. The person is dressed casually. The lighting is soft, diffused sunlight filtering through leaves, creating a serene and authentic atmosphere. Photorealistic, natural look."},event:{name:"En Evento",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_amp7eiamp7eiamp7.png",prompt:"A dynamic, in-action headshot as if taken at a professional conference or networking event. The person appears engaged, perhaps speaking or listening intently. The background is blurred, showing hints of a crowd and event lighting, giving a sense of energy and professionalism. Candid style."},minimalist:{name:"Minimalista",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_761a3j761a3j761a.png",prompt:"A clean, minimalist headshot against a simple, textured, light-gray or off-white studio background. The lighting is perfectly even and soft, eliminating harsh shadows. The focus is entirely on the person's natural expression. Modern and clean aesthetic."}};document.addEventListener("panel:activated",({detail:L})=>{L.panelId==="designer-ai"&&!z?ne():L.panelId==="designer-ai"&&window.appInstance&&window.appInstance.renderUsageAndLimits()});function ne(){z=!0,document.addEventListener("usage:updated",({detail:L})=>{const F=L==null?void 0:L.imageGenerations;if(!F)return;const P=typeof F.limit=="number"?F.limit:0,j=typeof F.remaining=="number"?F.remaining:0;b.limit=P,b.used=Math.max(0,P-j),m(),d()}),be(),k()}async function be(){var L,F;B=!0,d();try{const P=(F=(L=window.auth.getSession())==null?void 0:L.user)==null?void 0:F.id,{data:j,error:se}=await window.auth.sb.from("profiles").select("branding_settings, gallery_images").eq("id",P).single();if(p=[],j!=null&&j.gallery_images&&(p=j.gallery_images.map(fe=>({id:fe,src:fe}))),se)throw se;await ce(),_=j.branding_settings,await Y()}catch(P){console.error("Error al generar diseño:",P),window.showToast(P.message||"Ocurrio un error al generar la imagen.","error")}finally{B=!1,d(),m()}}async function ce(){var L;try{if(!window.appInstance)return;const F=typeof window.appInstance.loadUserSubscription=="function"?window.appInstance.loadUserSubscription():Promise.resolve(null),P=typeof window.appInstance.loadUserUsage=="function"?window.appInstance.loadUserUsage():Promise.resolve(null),[j,se]=await Promise.all([F,P]);j&&se&&(b.limit=((L=j==null?void 0:j.plans)==null?void 0:L.image_generations_limit)??0,b.used=(se==null?void 0:se.image_generations_used)??0)}catch(F){console.warn("No se pudo cargar el uso de imagenes:",F)}}async function Y(){if(Ie(),!_){_e();return}Array.isArray(_.colors)&&_.colors.length>0&&(U.colors=_.colors.slice(0,4));const L=[];_.logo_url&&L.push(O(_.logo_url).then(F=>{F&&(U.images.logo=F)})),Array.isArray(_.reference_images)&&_.reference_images.slice(0,3).forEach((F,P)=>{L.push(O(F).then(j=>{if(j){const se=`ref${P+1}`;U.images[se]=j}}))}),L.length>0&&await Promise.allSettled(L),_e()}function Ie(){const L=Array.isArray(_==null?void 0:_.colors)&&_.colors.length>0?_.colors.slice(0,4):["#4F46E5","#9333EA","#FFFFFF","#000000"];U={images:{logo:null,product:null,background:null,ref1:null,ref2:null,ref3:null},removeProductBg:!0,flyerStyle:"none",colors:L,textInputs:{headline:"",secondary:"",terms:"",price:"",visuals:"",styleMods:""},finalPrompt:""},X={images:{main:null,opt1:null,opt2:null},mode:"product-only",productOnlyData:{environment:"studio",customPrompt:""},lifestyleData:{who:"none",whoCustom:"",where:"none",whereCustom:"",when:"none",whenCustom:""},finalPrompt:""},H={images:{ref1:null,ref2:null,ref3:null},scene:"professional",finalPrompt:""},t=[],n=null,_e()}function _e(){D(),c(),o()}function oe(L){return typeof L=="string"?L.trim():""}function ae(L){return L.filter(Boolean).map(F=>F.toUpperCase()).join(", ")}function D(){const L=[];L.push("Design a polished promotional flyer suitable for social media. Use clear hierarchy and professional layout.");const F=Ee[U.flyerStyle];if(F&&L.push(`Base style guidance: ${F.prompt}`),U.flyerStyle==="none"){const ye=oe(U.textInputs.styleMods);ye&&L.push(`Custom style instructions: ${ye}`)}const P=oe(U.textInputs.headline);P&&L.push(`Headline: ${P}`);const j=oe(U.textInputs.secondary);j&&L.push(`Secondary text: ${j}`);const se=oe(U.textInputs.price);se&&L.push(`Call to action or price: ${se}`);const fe=oe(U.textInputs.terms);fe&&L.push(`Small print: ${fe}`);const ge=oe(U.textInputs.visuals);ge&&L.push(`Visual elements to include: ${ge}`),U.colors&&U.colors.length&&L.push(`Brand colour palette: ${ae(U.colors)}`),U.removeProductBg&&L.push("If a product reference is used, remove its original background."),U.finalPrompt=L.join(`

`).trim()}function c(){const L=[];if(L.push("Create a photorealistic marketing render of the product with dramatic lighting and professional composition."),X.mode==="product-only"){const F=me[X.productOnlyData.environment];F&&L.push(`Environment: ${F.prompt}`);const P=oe(X.productOnlyData.customPrompt);P&&L.push(`Extra instructions: ${P}`)}else{const F=W[X.lifestyleData.who];F!=null&&F.prompt&&L.push(`Subject: ${F.prompt}`);const P=ue[X.lifestyleData.where];P!=null&&P.prompt&&L.push(`Location: ${P.prompt}`);const j=te[X.lifestyleData.when];j!=null&&j.prompt&&L.push(`Mood or time: ${j.prompt}`);const se=oe(X.lifestyleData.whoCustom);se&&L.push(`Subject details: ${se}`);const fe=oe(X.lifestyleData.whereCustom);fe&&L.push(`Location details: ${fe}`);const ge=oe(X.lifestyleData.whenCustom);ge&&L.push(`Mood details: ${ge}`)}X.finalPrompt=L.join(`

`).trim()}function o(){const L=[];L.push("Generate a professional portrait that preserves the subject identity with realistic lighting and skin texture.");const F=re[H.scene];F!=null&&F.prompt&&L.push(`Scene: ${F.prompt}`),L.push("Deliver a sharp, flattering headshot suitable for corporate branding."),H.finalPrompt=L.join(`

`).trim()}function m(){const L=document.getElementById("designer-ai");if(!L)return;const F=L.querySelector(`#${e}-image-generation-usage`);F&&(F.textContent=`${b.used} / ${b.limit}`)}function g(){const L=document.getElementById("designer-ai");if(!L)return;const F=L.querySelector('[data-role="prompt-display"]');if(F&&(e==="flyer"?F.textContent=U.finalPrompt:e==="product"?F.textContent=X.finalPrompt:e==="headshot"&&(F.textContent=H.finalPrompt)),e==="flyer"){const P=L.querySelector("[data-flyer-style-manual]");P&&P.classList.toggle("hidden",U.flyerStyle!=="none")}m()}function k(){N||(N=!0,document.addEventListener("click",f),document.addEventListener("input",u),document.addEventListener("change",l))}function f(L){const F=document.getElementById("designer-ai");if(!F)return;const P=L.target.closest("[data-tool]");if(P&&F.contains(P)){L.preventDefault(),s(P.dataset.tool);return}if(L.target.closest("#view-all-gallery-btn")){L.preventDefault(),Be();return}const j=L.target.closest(".gallery-item-home");if(j){const ge=j.dataset.imageSrc;if(ge){const ye=`imagen-${Date.now()}.png`;qe(ge,"Imagen generada",ye)}return}const se=L.target.closest(".gallery-thumbnail");if(se){n=se.getAttribute("src"),g(),d();return}if(L.target.closest(".generate-btn")){L.preventDefault(),r();return}if(L.target.closest(".download-btn")){L.preventDefault(),n&&y(n);return}const fe=L.target.closest("[data-mode]");if(fe&&F.contains(fe)){const ge=fe.dataset.mode;ge&&ge!==X.mode&&(X.mode=ge,c(),d())}}function u(L){const F=document.getElementById("designer-ai");if(!F||!F.contains(L.target))return;const P=L.target;if(P.matches("textarea[data-flyer_text]")){const j=P.getAttribute("data-flyer_text");j&&(U.textInputs[j]=P.value,D(),g());return}if(P.matches("textarea[data-product_text]")){X.productOnlyData.customPrompt=P.value,c(),g();return}if(P.matches("textarea[data-lifestyle_text]")){const j=P.getAttribute("data-lifestyle_text");j&&(X.lifestyleData[j]=P.value,c(),g());return}if(P.matches('input[type="color"][data-index]')){const j=Number(P.getAttribute("data-index"));Number.isNaN(j)||(U.colors[j]=P.value,D(),g())}}function l(L){const F=document.getElementById("designer-ai");if(!F||!F.contains(L.target))return;const P=L.target;if(P.matches("#remove-bg-check")){U.removeProductBg=P.checked,D(),g();return}if(P.matches('input[name="flyer-style"]')){U.flyerStyle=P.value,D(),g();return}if(P.matches('input[name="environment"]')){X.productOnlyData.environment=P.value,c(),g();return}if(P.matches('input[name="who"]')){X.lifestyleData.who=P.value,c(),g();return}if(P.matches('input[name="where"]')){X.lifestyleData.where=P.value,c(),g();return}if(P.matches('input[name="when"]')){X.lifestyleData.when=P.value,c(),g();return}if(P.matches('input[name="headshot-scene"]')){H.scene=P.value,o(),g();return}}function s(L){!L||L===e||(e=L,B=!0,d(),Y().finally(()=>{B=!1,d(),g()}))}async function r(){var F,P;if(B)return;if(b.limit>0&&b.used>=b.limit){window.showToast("Has alcanzado tu límite de generaciones.","error");return}const L=i();if(!L){window.showToast("El prompt está vacío o incompleto.","error");return}B=!0,d();try{const j=(P=(F=window.auth.getSession())==null?void 0:F.user)==null?void 0:P.id;if(!j)throw new Error("No se pudo determinar el usuario actual.");let se=null;try{const{data:ye,error:Ce}=await window.auth.sb.rpc("check_account_access",{p_user_id:j});if(Ce&&Ce.code!=="PGRST202")throw new Error("Error al verificar el acceso de tu cuenta.");Ce||(se=ye)}catch(ye){if(ye.code!=="PGRST202")throw new Error("Error al verificar el acceso de tu cuenta.")}if(se&&se.blocked)throw new Error(se.reason||"Tu cuenta está bloqueada. Por favor, contacta con soporte.");const{data:fe,error:ge}=await window.auth.sb.rpc("increment_image_usage",{p_user_id:j});if(ge||!(fe!=null&&fe.success))throw new Error((fe==null?void 0:fe.message)||(ge==null?void 0:ge.message)||"Error al verificar el uso.");await w(j,L,fe)}catch(j){console.error("Designer AI generation error:",j);const se=(j==null?void 0:j.message)||"Ocurrió un error al generar la imagen.";window.showToast(se,"error")}finally{B=!1,d()}}async function w(L,F,P){var je;const j=a(F),{data:se,error:fe}=await window.auth.invokeFunction("gemini-proxy",{body:{userId:L,type:"image",parts:j}});if(fe)throw fe;const ge=Array.isArray(se==null?void 0:se.results)?se.results:[];if(ge.length===0)throw new Error("La IA no devolvió ninguna imagen.");const ye=ge.map(Ae=>{var Oe;return{id:((Oe=crypto==null?void 0:crypto.randomUUID)==null?void 0:Oe.call(crypto))??`${Date.now()}-${Math.random()}`,src:Ae}});t.unshift(...ye),n=((je=ye[0])==null?void 0:je.src)||n;const Ue=(await Promise.allSettled(ge.map(Ae=>window.auth.invokeFunction("smart-worker",{body:{userId:L,b64_json:Ae.includes(",")?Ae.split(",")[1]:Ae,subfolder:"ELINA"}})))).filter(Ae=>Ae.status==="fulfilled").map(Ae=>{var Oe,C;return(C=(Oe=Ae.value)==null?void 0:Oe.data)==null?void 0:C.cdnUrl}).filter(Boolean);if(Ue.length){const Ae=Ue.map(Oe=>({id:Oe,src:Oe}));p.unshift(...Ae);try{const Oe=p.map(C=>C.src);await window.auth.sb.from("profiles").update({gallery_images:Oe}).eq("id",L)}catch(Oe){console.error("No se pudo guardar la galería en el perfil:",Oe)}}b.used=P.used||b.used+1,m(),window.showToast("Imágenes generadas correctamente.","success")}function a(L){const F=[],P=A.aspectRatio;let j=L;P&&P!=="auto"&&(j=`${L}

Render the image using a ${P} aspect ratio.`);const se=(fe,ge)=>{!ge||!ge.base64||!ge.mimeType||(fe&&F.push({text:fe}),F.push({inlineData:{data:ge.base64,mimeType:ge.mimeType}}))};if(e==="flyer"){const fe=U.images||{};if(se("BACKGROUND IMAGE: Usa esta imagen como fondo completo sin distorsionarla.",fe.background),fe.product){const ge=U.removeProductBg?"PRODUCT IMAGE: Incluye este producto en el diseno y elimina su fondo original.":"PRODUCT IMAGE: Incluye este producto en el diseno respetando su fondo.";se(ge,fe.product)}se("LOGO IMAGE: Manten la integridad del logo.",fe.logo),["ref1","ref2","ref3"].forEach(ge=>{se("STYLE REFERENCE: Utiliza esta imagen como inspiracion visual.",fe[ge])})}else if(e==="product"){const fe=X.images||{};se("PRIMARY PRODUCT IMAGE: Manten la fidelidad del producto.",fe.main),se("SECONDARY IMAGE 1: Usa esta referencia solo para detalles adicionales.",fe.opt1),se("SECONDARY IMAGE 2: Usa esta referencia solo para detalles adicionales.",fe.opt2)}else if(e==="headshot"){const fe=H.images||{};["ref1","ref2","ref3"].forEach(ge=>{se("FACE REFERENCE: Preserva la identidad de la persona.",fe[ge])})}return F.push({text:j}),F}function i(){return e==="flyer"?U.finalPrompt:e==="product"?X.finalPrompt:e==="headshot"?H.finalPrompt:null}function y(L){if(!L)return;const F=document.createElement("a");F.href=L;const j=L.split(";")[0].split(":")[1].split("/")[1]||"png";F.download=`elina-design-${Date.now()}.${j}`,document.body.appendChild(F),F.click(),document.body.removeChild(F)}function d(){const L=document.getElementById("designer-ai");if(!L)return;let F="";switch(e){case"flyer":F=x();break;case"product":F=S();break;case"headshot":F=$();break;case"home":default:F=E()}L.innerHTML=F,lucide.createIcons(),e!=="home"&&pe();const P=L.querySelector("#image-provider-select");if(P){const fe=A.provider||"gemini",ge=A.kieModel||"google/imagen4-fast";let ye=fe;fe==="kie"&&(ge==="google/imagen4-fast"?ye="kie":ge==="flux-2/pro-text-to-image"?ye="kie-flux-text":ge==="flux-2/pro-image-to-image"&&(ye="kie-flux-image")),P.value=ye,P.addEventListener("change",je=>{const Ae=je.target.value;Ae==="gemini"?A.provider="gemini":Ae==="kie"?(A.provider="kie",A.kieModel="google/imagen4-fast"):Ae==="kie-flux-text"?(A.provider="kie-flux-text",A.kieModel="flux-2/pro-text-to-image"):Ae==="kie-flux-image"&&(A.provider="kie-flux-image",A.kieModel="flux-2/pro-image-to-image");const Oe=L.querySelector("#kie-model-settings"),C=L.querySelector("#flux-resolution-setting");Oe&&Oe.classList.toggle("hidden",Ae==="gemini"),C&&C.classList.toggle("hidden",Ae!=="kie-flux-text"&&Ae!=="kie-flux-image")});const Ce=L.querySelector("#kie-model-settings"),Ue=L.querySelector("#flux-resolution-setting");Ce&&Ce.classList.toggle("hidden",ye==="gemini"),Ue&&Ue.classList.toggle("hidden",ye!=="kie-flux-text"&&ye!=="kie-flux-image")}const j=L.querySelector("#kie-resolution-select");j&&(j.value=A.resolution||"1K",j.addEventListener("change",fe=>{A.resolution=fe.target.value}));const se=L.querySelector("#image-aspect-ratio-select");se&&(se.value=A.aspectRatio,se.addEventListener("change",fe=>{A.aspectRatio=fe.target.value,document.dispatchEvent(new CustomEvent("designer-ai:aspect-ratio-changed",{detail:{aspectRatio:A.aspectRatio}}))})),g()}function E(){return`
            <div class="text-center">
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Creador de Contenido con IA</h1>
                <p class="text-slate-500 mt-2 mb-8">Elige una herramienta para empezar.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                    <button data-tool="flyer" class="start-option-btn">
                        <img src="https://creativersezone.b-cdn.net/ELINA/media%20app/Gemini_Generated_Image_dvylmddvylmddvyl.png" alt="Crear Flyer" class="start-option-img" />
                        <div class="start-option-overlay">
                            <h3 class="font-semibold text-lg">Crear Flyer para Redes Sociales</h3>
                            <p class="text-sm text-gray-300 mt-1">Para promos, anuncios y comunicados.</p>
                        </div>
                    </button>
                    <button data-tool="product" class="start-option-btn">
                        <img src="https://creativersezone.b-cdn.net/ELINA/media%20app/Gemini_Generated_Image_fexq2ufexq2ufexq.png" alt="Visualizar Producto" class="start-option-img" />
                        <div class="start-option-overlay">
                            <h3 class="font-semibold text-lg">Visualizar Producto</h3>
                            <p class="text-sm text-gray-300 mt-1">Coloca tu producto en diferentes escenarios.</p>
                        </div>
                    </button>
                    <button data-tool="headshot" class="start-option-btn">
                        <img src="https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_vsl3jdvsl3jdvsl3.png" alt="Estudio Fotografico IA" class="start-option-img" />
                        <div class="start-option-overlay">
                            <h3 class="font-semibold text-lg">Estudio Fotografico IA</h3>
                            <p class="text-sm text-gray-300 mt-1">Crea fotos de perfil profesionales.</p>
                        </div>
                    </button>
                </div>
                ${p.length>0?`
                    <div class="mt-12">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Tus Últimas Creaciones</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 home-gallery-container">
                            ${p.slice(0,6).map(L=>`
                                <div class="gallery-item-home aspect-square bg-slate-200 rounded-lg overflow-hidden group relative cursor-pointer" data-image-src="${L.src}" data-image-id="${L.id||L.src}">
                                    <img src="${L.src}" alt="Imagen generada" class="w-full h-full object-cover">
                                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                        <i data-lucide="zoom-in" class="w-8 h-8 text-white"></i>
                                    </div>
                                </div>
                            `).join("")}
                        </div> 
                        <button id="view-all-gallery-btn" class="mt-6 inline-flex items-center justify-center gap-2 px-5 py-2.5 rounded-lg bg-blue-500 hover:bg-blue-400 text-white font-semibold shadow-md transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300 mx-auto">
                            Ver más
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                `:""}
            </div>
        `}function h(L,F,P){return`
            <nav class="main-nav mb-8">
                <button data-tool="home" class="nav-btn ${e==="home"?"active":""}"><i data-lucide="home" class="w-4 h-4 mr-2"></i>Inicio</button>
                <button data-tool="flyer" class="nav-btn ${e==="flyer"?"active":""}"><i data-lucide="layout-template" class="w-4 h-4 mr-2"></i>Flyers</button>
                <button data-tool="product" class="nav-btn ${e==="product"?"active":""}"><i data-lucide="gem" class="w-4 h-4 mr-2"></i>Producto</button>
                <button data-tool="headshot" class="nav-btn ${e==="headshot"?"active":""}"><i data-lucide="user-round" class="w-4 h-4 mr-2"></i>Estudio IA</button>
            </nav>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-slate-900">${L}</h2>
                    <p class="text-slate-500 mt-1 mb-6">${F}</p>
                    ${P}
                </div>
                <div class="lg:col-span-2 space-y-4 lg:sticky lg:top-6 self-start flex flex-col">
                    <div class="output-image-container dark-bg relative">
                        ${B?'<div class="absolute inset-0 flex items-center justify-center"><div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500"></div></div>':""} 
                        ${!B&&n?`
                            <div class="relative w-full h-full group aspect-square">
                                <img src="${n}" alt="Generated result" class="w-full h-full object-cover" />
                                <button class="download-btn">Descargar</button>
                            </div>
                        `:""}
                        ${!B&&!n?'<div class="placeholder-icon dark-placeholder"><i data-lucide="image-down"></i><p>El resultado aparecerá aquí</p></div>':""}
                    </div>
                    <div class="bg-slate-100 rounded-lg p-3 text-left space-y-2">
                        <div>
                            <label class="text-xs font-semibold text-slate-600 block mb-1">Proveedor de IA</label>
                            <select id="image-provider-select" class="form-input w-full text-sm mb-2" disabled>
                                <option value="gemini" selected>Gemini (Google)</option>
                            </select>
                            <p class="text-[10px] text-slate-500 mt-1">Usando Gemini para generación de imágenes</p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-slate-600 block mb-1">Relación de aspecto</label>
                            <select id="image-aspect-ratio-select" class="form-input w-full text-sm">
                                <option value="auto">Auto (sin forzar)</option>
                                <option value="1:1">1:1 (Cuadrada)</option>
                                <option value="16:9">16:9 (Horizontal)</option>
                                <option value="9:16">9:16 (Vertical)</option>
                                <option value="4:5">4:5</option>
                                <option value="5:4">5:4</option>
                                <option value="3:2">3:2</option>
                                <option value="2:3">2:3</option>
                                <option value="4:3">4:3</option>
                                <option value="3:4">3:4</option>
                                <option value="21:9">21:9</option>
                            </select>
                        </div>
                        <p class="text-[11px] text-slate-500">Esta configuración ajusta el prompt enviado para respetar el formato final.</p>
                    </div>
                    <div class="mt-2 bg-slate-100 rounded-lg p-3 text-center">
                         <h4 class="font-bold text-sm mb-1 text-slate-700">Uso Mensual</h4>
                         <p class="text-xs text-slate-600">Imágenes generadas: <span id="${e}-image-generation-usage" class="font-bold">0 / 0</span></p>
                    </div><button class="primary-btn !mt-4 w-full generate-btn animate-pulse-blue" ${B||b.limit>0&&b.used>=b.limit?"disabled":""}>${B?'<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div> Generando...':"Generar"}</button>
                    ${t.length>0?` 
                        <div class="pt-4 border-t">
                            <h3 class="text-sm font-medium text-slate-500 mb-2">Resultados (${t.length} opciones)</h3>
                            <div class="grid grid-cols-4 gap-2">
                               ${t.map(j=>`
                                    <div class="gallery-thumbnail-wrapper">
                                        <img src="${j.src}" alt="Generated thumbnail" class="gallery-thumbnail ${n===j.src?"active":""}" />
                                    </div>
                                `).join("")}
                            </div>
                        </div>
                    `:""}
                </div>
            </div>
        `}function x(){const L=`
            <div class="space-y-6">
                <div>
                    <label class="text-sm font-medium">1. Sube tus imágenes (Opcional)</label>
                    <div class="grid grid-cols-3 gap-4 mt-1">
                       ${G("flyer-upload-logo","Logo","(Opcional)",U.images.logo)}
                       <div>
                            ${G("flyer-upload-product","Producto","(Opcional)",U.images.product)}
                            <div class="flex items-center mt-2 justify-center" onclick="event.stopPropagation()">
                                <input type="checkbox" id="remove-bg-check" ${U.removeProductBg?"checked":""} class="form-checkbox rounded text-blue-600" />
                                <label for="remove-bg-check" class="ml-2 text-xs text-gray-500">Quitar fondo</label>
                            </div>
                       </div>
                       ${G("flyer-upload-background","Fondo","(Opcional)",U.images.background)}
                       ${G("flyer-upload-ref1","Ref. Estilo 1","(Opcional)",U.images.ref1)}
                       ${G("flyer-upload-ref2","Ref. Estilo 2","(Opcional)",U.images.ref2)}
                       ${G("flyer-upload-ref3","Ref. Estilo 3","(Opcional)",U.images.ref3)}
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                       <label class="text-sm font-medium">2. Elige un estilo base</label>
                       ${Z(Ee,"flyer-style",U.flyerStyle)}
                    </div>
                     <div>
                        <label class="text-sm font-medium">3. Completa la información del flyer</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2 text-input-grid">
                            <div class="text-input-wrapper">
                                <label>Texto Principal</label>
                                <textarea data-flyer_text="headline" placeholder="Ej: 50% DE DESCUENTO">${U.textInputs.headline}</textarea>
                            </div>
                            <div class="text-input-wrapper">
                                <label>Texto Secundario</label>
                                <textarea data-flyer_text="secondary" placeholder="Ej: Solo esta semana">${U.textInputs.secondary}</textarea>
                            </div>
                            <div class="text-input-wrapper">
                                <label>Precio / Llamada a la acción</label>
                                <textarea data-flyer_text="price" placeholder="Ej: $99.99 o ¡Inscríbete!">${U.textInputs.price}</textarea>
                            </div>
                            <div class="text-input-wrapper">
                                <label>Términos / Info Adicional</label>
                                <textarea data-flyer_text="terms" placeholder="Ej: Válido hasta agotar existencias">${U.textInputs.terms}</textarea>
                            </div>
                             <div class="md:col-span-2 text-input-wrapper">
                                <label>Elementos Visuales a Incluir</label>
                                <textarea data-flyer_text="visuals" placeholder="Ej: mujer con laptop, íconos de tecnología, un cerebro brillante">${U.textInputs.visuals}</textarea>
                            </div>
                            <!-- INICIO: CORRECCIÓN - Mostrar campo de estilo solo si es manual -->
                            <div class="md:col-span-2 text-input-wrapper ${U.flyerStyle==="none"?"":"hidden"}" data-flyer-style-manual>
                                <label>Describe tu Estilo Personalizado</label>
                                <textarea data-flyer_text="styleMods" placeholder="Ej: estética futurista, patrones de circuitos, colores neón">${U.textInputs.styleMods}</textarea>
                            </div>
                            <!-- FIN: CORRECCIÓN -->
                        </div>
                    </div>
                     <div>
                        <label class="text-sm font-medium">4. Define tu paleta de colores</label>
                        ${V(U.colors)}
                    </div>
                     <div class="!mt-4">
                        <label class="text-xs font-medium text-slate-500">Prompt Final (Solo para referencia)</label>
                        <pre class="prompt-display" data-role="prompt-display">${U.finalPrompt}</pre>
                    </div>
                </div>
            </div>
        `;return h("Creador de Flyers","Crea flyers promocionales para redes sociales.",L)}function S(){const L=!!X.images.main,F=`
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-medium">1. Sube tu producto</label>
                    <div class="grid grid-cols-3 gap-2 mt-1">
                       ${G("product-upload-main","Imagen Principal","(Obligatorio)",X.images.main)}
                       ${G("product-upload-opt1","Opcional 1","(Detalles)",X.images.opt1)}
                       ${G("product-upload-opt2","Opcional 2","(Contexto)",X.images.opt2)}
                    </div>
                </div>
                <fieldset class="space-y-4 ${L?"fieldset-enabled":"fieldset-disabled"}">
                    <div>
                        <label class="text-sm font-medium">2. Elige un modo</label>
                        <div class="grid grid-cols-2 gap-3 mt-1">
                            <button data-mode="product-only" class="mode-selector-btn ${X.mode==="product-only"?"active":""}">
                                <img src="https://creativersezone.b-cdn.net/ELINA/media%20app/product/fondo%20texturizado.png" alt="Producto en un escenario" class="mode-selector-img" />
                                <div class="mode-selector-overlay"><h3 class="font-semibold text-base">Producto Solo</h3></div>
                            </button>
                            <button data-mode="with-human" class="mode-selector-btn ${X.mode==="with-human"?"active":""}">
                                <img src="https://creativersezone.b-cdn.net/ELINA/media%20app/product/lifestyle.png" alt="Producto con persona" class="mode-selector-img" />
                                <div class="mode-selector-overlay"><h3 class="font-semibold text-base">Con Persona</h3></div>
                            </button>
                        </div>
                    </div>
                    ${X.mode==="product-only"?`
                        <div class="space-y-4 fade-in">
                            <div>
                                <label class="text-sm font-medium">3. Elige un entorno</label>
                                ${Z(me,"environment",X.productOnlyData.environment)}
                            </div>
                             <div>
                                <div class="text-input-wrapper">
                                    <label>4. AÃ±ade detalles (Opcional)</label>
                                    <textarea data-product_text="customPrompt" placeholder="Ej: con un toque de vapor saliendo, sobre una superficie reflectante">${X.productOnlyData.customPrompt}</textarea>
                                </div>
                            </div>
                        </div>
                    `:`
                         <div class="space-y-4 fade-in">
                            <div>
                                <label class="text-sm font-medium">3. Define la escena</label>
                                <div class="space-y-4 p-3 bg-slate-100 rounded-lg mt-1">
                                    <div>
                                        <h4 class="text-xs font-bold text-slate-500">QUIÃN LO USA</h4>
                                        ${Z(W,"who",X.lifestyleData.who)}
                                        <div class="text-input-wrapper mt-2">
                                            <label class="hidden">Detalles de quiÃ©n</label>
                                            <textarea data-lifestyle_text="whoCustom" rows="1" placeholder="Detalles (Ej: una mujer joven, sonriendo)">${X.lifestyleData.whoCustom}</textarea>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-bold text-slate-500">DÃNDE LO USA</h4>
                                        ${Z(ue,"where",X.lifestyleData.where)}
                                        <div class="text-input-wrapper mt-2">
                                            <label class="hidden">Detalles de dÃ³nde</label>
                                            <textarea data-lifestyle_text="whereCustom" rows="1" placeholder="Detalles (Ej: en un balcÃ³n con vistas)">${X.lifestyleData.whereCustom}</textarea>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-bold text-slate-500">CUÃNDO LO USA</h4>
                                        ${Z(te,"when",X.lifestyleData.when)}
                                        <div class="text-input-wrapper mt-2">
                                            <label class="hidden">Detalles de cuÃ¡ndo</label>
                                            <textarea data-lifestyle_text="whenCustom" rows="1" placeholder="Detalles (Ej: la luz del sol se filtra)">${X.lifestyleData.whenCustom}</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `}
                    <div class="!mt-4"> 
                        <label class="text-xs font-medium text-slate-500">Prompt Final (Solo para referencia)</label>
                        <pre class="prompt-display" data-role="prompt-display">${X.finalPrompt}</pre>
                    </div>
            </div>
        `;return h("Visualizador de Producto","Coloca tu producto en diferentes escenarios profesionales.",F)}function $(){const L=`
            <div class="space-y-6">
                <div>
                    <label class="text-sm font-medium">1. Sube tus fotos de referencia (1-3)</label>
                    <p class="text-xs text-slate-500 mt-1">Sube fotos claras de tu rostro desde diferentes Ã¡ngulos para obtener el mejor resultado.</p>
                    <div class="grid grid-cols-3 gap-4 mt-2">
                       ${G("headshot-upload-ref1","Foto Principal","(Obligatorio)",H.images.ref1)}
                       ${G("headshot-upload-ref2","Foto Opcional 2","",H.images.ref2)}
                       ${G("headshot-upload-ref3","Foto Opcional 3","",H.images.ref3)}
                    </div>
                </div>
                <div>
                    <label class="text-sm font-medium">2. Elige un escenario</label>
                    ${Z(re,"headshot-scene",H.scene)}
                </div>
            </div>
        `;return h("Estudio FotogrÃ¡fico IA","Crea fotos de perfil profesionales a partir de tus propias imÃ¡genes.",L)}function G(L,F,P,j){const se=j?`data:${j.mimeType};base64,${j.base64}`:null;return`
            <div class="image-upload-slot" data-upload-id="${L}">
                <label for="${L}" class="upload-label">
                    ${j?"":`
                        <div class="text-center text-xs text-gray-500">
                            <p class="font-semibold">${F}</p>
                            <p>${P}</p>
                        </div>
                    `}
                </label>
                ${j?`<img src="${se}" alt="Preview" class="image-preview" />`:""}
                ${j?`<button class="remove-button" data-remove-id="${L}"><i data-lucide="x" class="w-4 h-4 pointer-events-none"></i></button>`:""}
                <input id="${L}" type="file" class="hidden" accept="image/*" />
            </div>
        `}function Z(L,F,P){return`
            <div class="grid grid-cols-4 gap-3 mt-2">
                ${Object.entries(L).map(([j,se])=>`
                    <div>
                        <input type="radio" id="${F}-${j}" name="${F}" value="${j}" class="hidden peer" ${P===j?"checked":""} />
                        <label for="${F}-${j}" class="style-selector-label group">
                            <img src="${se.image}" alt="${se.name}" class="style-thumbnail" />
                            <div class="style-text-overlay">${se.name}</div>
                        </label>
                    </div>
                `).join("")}
            </div>
        `}function V(L){return`
            <div class="color-palette-container">
                ${L.map((F,P)=>`
                    <div class="color-swatch-wrapper">
                        <input type="color" value="${F}" data-index="${P}" class="color-swatch-input" />
                        <span class="color-swatch-hex">${F}</span>
                    </div>
                `).join("")}
            </div>
        `}function pe(){document.querySelectorAll(".image-upload-slot").forEach(L=>{var j;const F=L.dataset.uploadId,P=document.getElementById(F);(j=L.querySelector(".remove-button"))==null||j.addEventListener("click",se=>{se.preventDefault(),se.stopPropagation(),we(null,F)}),P.addEventListener("change",se=>{var fe;return we(((fe=se.target.files)==null?void 0:fe[0])||null,F)}),L.addEventListener("dragover",se=>{se.preventDefault(),L.classList.add("dragging-over")}),L.addEventListener("dragleave",se=>{se.preventDefault(),L.classList.remove("dragging-over")}),L.addEventListener("drop",se=>{var fe;se.preventDefault(),L.classList.remove("dragging-over"),we(((fe=se.dataTransfer.files)==null?void 0:fe[0])||null,F)})})}async function we(L,F){const j=(fe=>fe.startsWith("flyer-")?fe.replace("flyer-upload-",""):fe.startsWith("product-")?fe.replace("product-upload-",""):fe.startsWith("headshot-")?fe.replace("headshot-upload-",""):null)(F);if(!j)return;let se=null;if(L&&L.type.startsWith("image/"))try{se={base64:await ie(L),mimeType:L.type}}catch(fe){console.error("Error leyendo el archivo:",fe),window.showToast("Error al leer el archivo.","error")}e==="flyer"?U.images[j]=se:e==="product"?X.images[j]=se:e==="headshot"&&(H.images[j]=se),d()}function ie(L){return new Promise((F,P)=>{const j=new FileReader;j.onload=()=>F(j.result.split(",")[1]),j.onerror=se=>P(se),j.readAsDataURL(L)})}async function O(L){if(!L||typeof L!="string"||L.trim()==="")return console.warn("urlToImageFile: URL inválida o vacía:",L),null;try{new URL(L)}catch{return console.warn("urlToImageFile: URL no tiene formato válido:",L),null}try{const{data:F,error:P}=await window.auth.invokeFunction("image-proxy",{body:{url:L.trim()}});if(P){if(P.status===400||P.statusCode===400)console.warn("image-proxy: Error 400 - URL inválida o parámetros incorrectos:",L);else throw new Error(`Proxy error: ${P.message||"Error desconocido"}`);return null}return!F||!F.base64||!F.mimeType?(console.warn("image-proxy: Respuesta inválida - falta base64 o mimeType"),null):{base64:F.base64,mimeType:F.mimeType}}catch(F){return console.error(`Error al convertir la URL ${L} a Base64:`,F),null}}function Be(){var P;const L=document.getElementById("full-gallery-modal"),F=document.getElementById("full-gallery-content");!L||!F||(F.innerHTML=`
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                ${p.map(j=>`
                    <div class="aspect-square bg-slate-200 rounded-lg overflow-hidden group relative">
                        <img src="${j.src}" alt="Imagen generada" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <button class="view-image-btn p-2 bg-white/80 rounded-full" data-src="${j.src}">
                                <i data-lucide="zoom-in" class="w-6 h-6 text-slate-800 pointer-events-none"></i>
                            </button>
                        </div>
                    </div>
                `).join("")}
            </div>
        `,L.classList.remove("hidden"),lucide.createIcons(),(P=document.getElementById("close-full-gallery-modal-btn"))==null||P.addEventListener("click",()=>L.classList.add("hidden"),{once:!0}),F.addEventListener("click",j=>{const se=j.target.closest(".view-image-btn");se&&qe(se.dataset.src,"Imagen de la galerÃ­a")}))}function qe(L,F="Vista previa de imagen",P="imagen.png"){var ye;const j=document.getElementById("image-viewer-modal"),se=document.getElementById("image-viewer-content"),fe=document.getElementById("download-image-viewer-btn"),ge=document.getElementById("close-image-viewer-btn");!j||!se||!L||(se.innerHTML=`<img src="${L}" alt="${F}" class="max-h-[80vh] max-w-[85vw] object-contain rounded-lg shadow-2xl">`,fe&&(fe.onclick=Ce=>{var Ue,je;Ce.preventDefault(),Ce.stopPropagation();try{const Ae=document.createElement("a");Ae.href=L,Ae.download=P,Ae.target="_blank",Ae.rel="noopener noreferrer",document.body.appendChild(Ae),Ae.click(),setTimeout(()=>{document.body.removeChild(Ae)},100),(Ue=window.showToast)==null||Ue.call(window,'Descarga iniciada. Si no funciona, haz clic derecho en la imagen y "Guardar como"',"success")}catch(Ae){console.error("Error al descargar imagen:",Ae),window.open(L,"_blank"),(je=window.showToast)==null||je.call(window,"Abre la imagen en una nueva pestaña y guárdala desde ahí","info")}}),ge&&(ge.onclick=Ce=>{Ce.preventDefault(),Ce.stopPropagation(),j.classList.add("hidden")}),j.onclick=Ce=>{Ce.target===j&&j.classList.add("hidden")},j.classList.remove("hidden"),(ye=window.lucide)!=null&&ye.createIcons&&window.lucide.createIcons({root:j}))}})();(function(){let z=!1,e=[],t=[];const n=24;document.addEventListener("panel:activated",({detail:W})=>{W.panelId==="follow-ups"&&!z&&(p(),z=!0)});async function p(){console.log("Inicializando panel de Seguimientos..."),z=!0,await b(),_()}async function b(){var te,re;const W=document.getElementById("followups-list");if(!W)return;W.innerHTML='<div id="followups-loader" class="text-center text-slate-500 p-8">Cargando secuencias...</div>';const ue=W.querySelector("#followups-loader");try{const ne=(re=(te=window.auth.getSession())==null?void 0:te.user)==null?void 0:re.id,[be,ce]=await Promise.all([window.auth.sb.from("followups").select("*").eq("user_id",ne),window.auth.sb.from("labels").select("name").eq("user_id",ne)]);if(be.error)throw be.error;if(ce.error)throw ce.error;e=be.data,t=ce.data.map(Y=>Y.name).sort(),B()}catch(ne){console.error("Error al cargar datos de seguimientos:",ne),ue&&(ue.textContent="Error al cargar datos.")}finally{}}function _(){var W,ue,te,re,ne,be,ce;(W=document.getElementById("add-sequence-btn"))==null||W.addEventListener("click",()=>A(null)),(ue=document.getElementById("cancel-sequence-btn"))==null||ue.addEventListener("click",N),(te=document.getElementById("sequence-form"))==null||te.addEventListener("submit",X),(re=document.getElementById("delete-sequence-btn"))==null||re.addEventListener("click",Ee),(ne=document.getElementById("add-message-btn"))==null||ne.addEventListener("click",()=>H()),(be=document.getElementById("follow-ups-container"))==null||be.addEventListener("click",Y=>{const Ie=Y.target.closest(".toggle-follow-up-btn");Ie&&me(Ie);const _e=Y.target.closest(".edit-follow-up-btn");if(_e){const oe=_e.dataset.id,ae=e.find(D=>D.id==oe);ae&&A(ae)}}),(ce=document.getElementById("messages-container"))==null||ce.addEventListener("click",Y=>{Y.target.closest(".remove-step-btn")&&(Y.target.closest(".message-step").remove(),U()),Y.target.classList.contains("upload-file-btn")&&Y.target.previousElementSibling.click()})}function B(){const W=document.getElementById("followups-list");if(!W)return;const ue=W.querySelector("#followups-loader");if(ue&&ue.classList.add("hidden"),e.length===0){W.innerHTML='<p class="text-slate-500 text-center p-8">No has creado ninguna secuencia de seguimiento.</p>';return}W.innerHTML=e.map(te=>`
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="text-lg font-bold text-slate-900">${`Secuencia para "${te.target_label}"`}</h4>
                        <p class="text-sm text-slate-500">Se activa con la etiqueta: <span class="font-semibold text-blue-600">${te.target_label}</span></p>
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer toggle-follow-up-btn" data-id="${te.id}" ${te.is_active?"checked":""}>
                            <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600" title="${te.is_active?"Secuencia Activa":"Secuencia Inactiva"}"></div>
                        </label>
                        <button class="edit-follow-up-btn text-blue-600 hover:underline font-semibold flex items-center gap-1 ml-3" data-id="${te.id}">
                            <i data-lucide="edit-2" class="w-4 h-4"></i> Editar
                        </button>
                    </div>
                </div>
            </div>
        `).join(""),lucide.createIcons()}function A(W){var ne;const ue=document.getElementById("sequence-modal");document.getElementById("sequence-form").reset(),document.getElementById("sequence-modal-title").textContent=W?"Editar Secuencia":"Crear Nueva Secuencia",document.getElementById("sequence-id").value=(W==null?void 0:W.id)||"";const te=document.getElementById("sequence-target-label");te.innerHTML='<option value="">-- Selecciona una etiqueta --</option>'+t.map(be=>`<option value="${be}">${be}</option>`).join(""),W&&(te.value=W.target_label),document.getElementById("sequence-is-active").checked=W?W.is_active:!0;const re=document.getElementById("messages-container");if(re.innerHTML="",((ne=W==null?void 0:W.messages)==null?void 0:ne.length)>0){const be=typeof W.messages=="string"?JSON.parse(W.messages):W.messages,ce=Array.isArray(W.timings)?W.timings:typeof W.timings=="string"?JSON.parse(W.timings):[],Y=Array.isArray(W.file_urls)?W.file_urls:typeof W.file_urls=="string"?JSON.parse(W.file_urls):[];be.forEach((Ie,_e)=>{var oe;H({message:Ie,delay:((oe=ce[_e])==null?void 0:oe.delay)??n,fileUrl:(Y==null?void 0:Y[_e])??""})})}else H();document.getElementById("delete-sequence-btn").classList.toggle("hidden",!W),ue.classList.remove("hidden"),lucide.createIcons()}function N(){document.getElementById("sequence-modal").classList.add("hidden")}function H(W={message:"",delay:n,fileUrl:""}){const ue=document.getElementById("messages-container"),te=document.getElementById("add-message-btn");if(ue.querySelectorAll(".message-step").length>=3){window.showToast("Puedes añadir un máximo de 3 mensajes por secuencia.","info");return}const ne=document.getElementById("message-step-template").content.cloneNode(!0);ne.querySelector(".step-message").value=W.message,ne.querySelector(".step-delay").value=W.delay??n;const be=ne.querySelector(".file-name-display"),ce=ne.querySelector(".step-image-preview");W.fileUrl&&(/\.(jpg|jpeg|png|gif|webp)$/i.test(W.fileUrl)&&(ce.src=W.fileUrl,ce.classList.remove("hidden")),be.textContent=W.fileUrl.split("/").pop(),be.dataset.existingUrl=W.fileUrl),ne.querySelector(".step-file-input").addEventListener("change",Y=>{be.textContent=Y.target.files[0]?Y.target.files[0].name:"Ningún archivo seleccionado",be.dataset.existingUrl=""}),ue.appendChild(ne),U(),ue.querySelectorAll(".message-step").length>=3?te.classList.add("hidden"):te.classList.remove("hidden"),lucide.createIcons()}function U(){document.querySelectorAll(".message-step").forEach((ue,te)=>{ue.querySelector(".step-number").textContent=te+1});const W=document.getElementById("add-message-btn");document.querySelectorAll(".message-step").length<3&&W.classList.remove("hidden")}async function X(W){var Y,Ie;W.preventDefault();const ue=document.getElementById("save-sequence-btn");ue.disabled=!0,ue.textContent="Guardando...";const te=document.getElementById("sequence-id").value,re=Array.from(document.querySelectorAll(".message-step")),ne=re.map(async _e=>{const oe=_e.querySelector(".step-file-input"),ae=_e.querySelector(".file-name-display");return oe.files[0]?await window.appInstance.uploadAsset(oe.files[0],"follow-ups"):ae.dataset.existingUrl?ae.dataset.existingUrl:null}),be=await Promise.all(ne),ce={user_id:(Ie=(Y=window.auth.getSession())==null?void 0:Y.user)==null?void 0:Ie.id,target_label:document.getElementById("sequence-target-label").value,is_active:document.getElementById("sequence-is-active").checked,messages:re.map(_e=>_e.querySelector(".step-message").value),timings:re.map(_e=>({delay:parseInt(_e.querySelector(".step-delay").value)||n})),file_urls:be,follow_up_count:re.length};try{const _e=te?window.auth.sb.from("followups").update(ce).eq("id",te).select().single():window.auth.sb.from("followups").insert(ce).select().single(),{data:oe,error:ae}=await _e;if(ae)throw ae;if(ce.is_active&&ce.target_label){console.log(`Reintegrando contactos con la etiqueta: ${ce.target_label}`);const{error:D}=await window.auth.sb.rpc("reassign_followup_to_contacts_with_label",{p_user_id:ce.user_id,p_target_label:ce.target_label,p_followup_id:oe.id});D&&(console.error("Error al reintegrar contactos:",D),window.showToast("Secuencia guardada, pero hubo un error al reintegrar los contactos existentes.","warning"))}window.showToast("Secuencia guardada con éxito.","success"),N(),await b(),B()}catch(_e){console.error("Error al guardar la secuencia:",_e),window.showToast(`Error: ${_e.message}`,"error")}finally{ue.disabled=!1,ue.textContent="Guardar Secuencia"}}async function Ee(){const W=document.getElementById("sequence-id").value;if(!(!W||!confirm("¿Estás seguro de que quieres eliminar esta secuencia?")))try{const{error:ue}=await window.auth.sb.from("followups").delete().eq("id",W);if(ue)throw ue;window.showToast("Secuencia eliminada.","info"),N(),await b(),B()}catch(ue){console.error("Error al eliminar:",ue),window.showToast(`Error: ${ue.message}`,"error")}}async function me(W){const ue=W.dataset.id,te=W.checked;W.disabled=!0;try{const{error:re}=await window.auth.sb.from("followups").update({is_active:te}).eq("id",ue);if(re)throw re;const ne=e.find(be=>be.id==ue);ne&&(ne.is_active=te)}catch(re){console.error("Error al cambiar estado:",re),W.checked=!te}finally{W.disabled=!1}}})();(function(){let z=!1,e=[],t=[],n=[],p="_individual_",b=null;function _(oe){var o,m,g;const ae=(o=window.appInstance)==null?void 0:o.teamInfo;if((ae==null?void 0:ae.user_role)!=="advisor")return null;const D=((m=ae==null?void 0:ae.permissions)==null?void 0:m.label_filters)||((g=ae==null?void 0:ae.permissions)==null?void 0:g.labelFilters),c=D==null?void 0:D[oe];return!Array.isArray(c)||c.length===0?null:c.filter(Boolean)}function B(oe){if(!oe)return[];const ae=[oe.members,oe.team_members,oe.teamMembers,oe.member_list].filter(Array.isArray);if(!ae.length)return[];const D=[];for(const c of ae)if(c.forEach(o=>{const m=(o==null?void 0:o.user_id)||(o==null?void 0:o.id)||(o==null?void 0:o.member_id)||(o==null?void 0:o.userId);m&&D.push({user_id:m,profiles:o.profiles||{full_name:o.full_name||o.name||null,email:o.email||null}})}),D.length)break;return D}async function A(){z||(console.log("Inicializando panel Kanban..."),z=!0,await N(),H(),X())}document.addEventListener("panel:activated",({detail:oe})=>{oe.panelId==="kanban"?(z||A(),Ie()):_e()});async function N(){const oe=document.getElementById("kanban-loader");oe&&oe.classList.remove("hidden");try{const ae=window.auth.getSession();if(!ae)throw new Error("No hay sesión activa.");const D=ae.user.id,c=await window.appInstance.loadTeamInfo(),o=window.auth.sb.from("labels").select("*").eq("user_id",D),m=window.auth.sb.from("contacts").select("id, full_name, phone_number, labels, razon_de_label_auto, assigned_to_id"),[g,k]=await Promise.all([o,m]);if(g.error)throw g.error;if(k.error)throw k.error;if(e=g.data,n=k.data,t=[],(c==null?void 0:c.user_role)==="admin"){let u=B(c);if(u.length){const l=u.map(s=>s.user_id).filter(Boolean);if(l.length){const{data:s,error:r}=await window.auth.sb.from("profiles").select("id, full_name, email").in("id",l);if(r)console.warn("Error al obtener perfiles de miembros del equipo:",r),t=u.map(w=>({...w,profiles:null}));else{const w=Object.fromEntries((s||[]).map(a=>[a.id,a]));t=u.map(a=>({...a,profiles:w[a.user_id]||null}))}}else t=u.map(s=>({...s,profiles:null}))}else console.warn("No se obtuvo información de miembros del equipo desde teamInfo. La asignación de asesores podría no estar disponible.")}}catch(ae){console.error("Error al cargar datos para Kanban:",ae),oe&&(oe.textContent="Error al cargar datos.")}finally{oe&&oe.classList.add("hidden")}}function H(){var ae,D,c;const oe=document.getElementById("kanban");oe&&(oe.addEventListener("click",o=>{o.target.id==="kanban-individual-btn"&&(U(o.target),p="_individual_",Ee(p))}),oe.addEventListener("change",o=>{o.target.id==="kanban-funnel-select"&&(U(o.target),p=o.target.value||"_individual_",Ee(p))}),(ae=document.getElementById("kanban-board"))==null||ae.addEventListener("click",o=>{const m=o.target.closest('[data-lucide="info"]');m&&te(m.closest(".kanban-card").dataset.contactId)}),(D=document.getElementById("kanban-board"))==null||D.addEventListener("change",o=>{o.target.classList.contains("assign-advisor-select")&&ue(o.target.dataset.contactId,o.target.value)}),(c=document.getElementById("kanban-board"))==null||c.addEventListener("mouseover",o=>{re(o)}))}function U(oe){document.querySelectorAll("#kanban-controls .kanban-control-item").forEach(D=>{D.classList.remove("bg-blue-600","text-white","border-blue-500","ring-2","ring-blue-200","ring-blue-300"),D.classList.add("border-slate-300","bg-white","text-slate-700","shadow-sm")});const ae=oe.closest(".kanban-control-item");ae&&(ae.classList.remove("border-slate-300"),ae.classList.add("border-blue-500","ring-2","ring-blue-300"),ae.tagName==="BUTTON"?(ae.classList.add("bg-blue-600","text-white"),ae.classList.remove("bg-white","text-slate-700")):ae.classList.add("ring-blue-300"))}function X(){var o;const oe=[...new Set(e.map(m=>m.funnel_name).filter(Boolean))].sort(),ae=e.some(m=>!m.funnel_name),D=document.getElementById("kanban-controls");if(!D)return;if(D.innerHTML="",ae&&(D.innerHTML+=`
                <div>
                    <h4 class="text-xs text-slate-400 uppercase font-bold mb-1 ml-1">Vista</h4>
                    <button id="kanban-individual-btn" class="kanban-control-item font-semibold py-2 px-4 rounded-lg text-sm border-2 border-slate-300 bg-white text-slate-700 hover:border-blue-400 transition-colors shadow-sm">Etiquetas Individuales</button>
                </div>
            `),oe.length>0&&(D.innerHTML+=`
                <div>
                    <h4 class="text-xs text-slate-400 uppercase font-bold mb-1 ml-1">Funnels</h4>
                    <div class="kanban-control-item custom-select-wrapper rounded-lg border-2 border-slate-300 bg-white text-slate-700 shadow-sm transition-colors">
                        <select id="kanban-funnel-select" class="custom-select form-input text-sm font-semibold py-2 bg-transparent focus:outline-none">
                            <option value="" disabled>-- Seleccionar Funnel --</option>
                            ${oe.map(m=>`<option value="${m}">${m}</option>`).join("")}
                        </select>
                        <i data-lucide="chevron-down" class="select-icon w-5 h-5 text-slate-500"></i>
                    </div>
                </div>
            `),D.innerHTML===""){document.getElementById("kanban-board").innerHTML='<div class="w-full text-center p-8"><p class="text-slate-500">Crea etiquetas o un funnel en "Etiquetas IA" para empezar a visualizar tus contactos.</p></div>';return}const c=document.getElementById("kanban-individual-btn");if(c)U(c),p="_individual_",Ee(p);else{const m=document.getElementById("kanban-funnel-select");m&&(U(m),p=m.value||"_individual_",Ee(m.value))}(o=document.getElementById("back-to-dashboard-btn"))==null||o.addEventListener("click",()=>{window.appInstance.switchPanel("dashboard")})}function Ee(oe){var s,r,w,a,i,y,d;const ae=document.getElementById("kanban-board");if(!ae)return;const D=typeof oe=="string"&&oe.length?oe:"_individual_";p=D;const c=(s=window.appInstance)==null?void 0:s.teamInfo,o=c==null?void 0:c.user_role,m=(r=c==null?void 0:c.profiles)==null?void 0:r.full_name;let g=n,k=null;o==="advisor"&&(k=_("contacts"),k?g=n.filter(E=>(E.labels||[]).some(h=>k.includes(h))):m&&(g=n.filter(E=>(E.labels||[]).includes(m))));const f=(w=window.appInstance)==null?void 0:w.userPlan,u=((i=(a=window.appInstance)==null?void 0:a.teamInfo)==null?void 0:i.user_role)==="admin"&&((d=(y=f==null?void 0:f.plans)==null?void 0:y.features)==null?void 0:d.multi_user);let l;if(D==="_individual_"?l=e.filter(E=>!E.funnel_name).sort((E,h)=>E.name.localeCompare(h.name)):l=e.filter(E=>E.funnel_name===D).sort((E,h)=>(E.funnel_order||0)-(h.funnel_order||0)),k&&(l=l.filter(E=>k.includes(E.name))),l.length===0){ae.innerHTML='<p class="text-slate-500 p-4">No hay etiquetas para mostrar en esta vista.</p>';return}ae.innerHTML=l.map(E=>{const h=ce(E.color),x=g.filter(G=>(G.labels||[]).includes(E.name)).sort((G,Z)=>{const V=(G.labels||[]).length;return(Z.labels||[]).length-V}),S=x.length>10,$=S?"max-h-[600px]":"";return`
                <div class="kanban-column w-full sm:w-1/2 md:w-1/3 lg:w-1/4 xl:w-1/5 flex-shrink-0 p-2">
                    <div class="bg-slate-100 rounded-lg shadow-sm flex flex-col h-full">
                    <h3 class="font-bold text-slate-800 p-3 border-b-4 flex-shrink-0" style="border-color: ${h};">${E.name} <span class="text-sm font-normal text-slate-500">${x.length}</span></h3>
                    <div class="kanban-cards p-3 space-y-3 flex-grow overflow-y-auto ${$}" data-label-id="${E.id}" style="${S?"max-height: 600px;":""}">
                        ${x.map(G=>`
                            <div class="kanban-card bg-white p-3 rounded-md shadow-sm" data-contact-id="${G.id}">
                                <div class="flex justify-between items-start relative">
                                    <p class="font-semibold text-sm">${G.full_name||"Sin nombre"}</p>
                                    ${G.razon_de_label_auto?`                                        
                                        <i data-lucide="info" class="w-4 h-4 text-blue-400 cursor-pointer hover:text-blue-600 z-20 group"></i>
                                        <div class="kanban-tooltip w-64 bg-slate-800 text-white text-xs rounded-lg py-2 px-3 z-50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                            ${G.razon_de_label_auto}
                                            <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-slate-800"></div>
                                        </div>                                        
                                    `:'<i data-lucide="info" class="w-4 h-4 text-blue-400 cursor-pointer hover:text-blue-600 z-20"></i>'}
                                </div>
                                <p class="text-xs text-slate-500">${G.phone_number}</p>
                                ${u?`
                                    <div class="mt-2 pt-2 border-t border-slate-100">
                                        <div class="custom-select-wrapper">
                                            <select class="assign-advisor-select custom-select form-input text-xs py-1" data-contact-id="${G.id}">
                                                <option value="">Sin asignar</option>
                                                ${t.map(Z=>{const V=Z.profiles;return`<option value="${Z.user_id}" ${G.assigned_to_id===Z.user_id?"selected":""}>
                                                        ${(V==null?void 0:V.full_name)||(V==null?void 0:V.email)||"Asesor sin nombre"}
                                                    </option>`}).join("")}
                                            </select>
                                            <i data-lucide="user-check" class="select-icon w-3 h-3 text-slate-400"></i>
                                        </div>
                                    </div>
                                `:""}
                            </div>
                        `).join("")||'<p class="text-xs text-slate-400 p-2">Sin contactos</p>'}
                    </div></div>
                </div>
            `}).join(""),window.Sortable&&me()}function me(){const oe=document.getElementById("kanban-board");if(!oe)return;const ae=oe.querySelectorAll(".kanban-cards");ae.length>0&&ae[0].sortable&&ae.forEach(D=>D.sortable.destroy()),ae.forEach(D=>{D.sortable=new Sortable(D,{group:"kanban",animation:150,onEnd:W,onMove:c=>{const o=c.dragged.dataset.contactId,m=c.to.dataset.labelId,g=n.find(f=>f.id==o),k=e.find(f=>f.id==m);return!g||!k?!1:!(g.labels||[]).includes(k.name)},ghostClass:"bg-blue-100",dragClass:"opacity-50"})})}async function W(oe){const ae=oe.item.dataset.contactId,D=oe.to.dataset.labelId,c=oe.from.dataset.labelId;if(D===c)return;const o=e.find(g=>g.id==D),m=e.find(g=>g.id==c);if(!(!o||!m))try{const g=n.find(l=>l.id==ae);if(!g)throw new Error("Contacto no encontrado en la caché.");const k=new Set(g.labels||[]);k.delete(m.name),k.add(o.name);const f=Array.from(k),{error:u}=await window.auth.sb.from("contacts").update({labels:f}).eq("id",ae);if(u)throw u;window.showToast(`Contacto movido a "${o.name}"`,"success"),g.labels=f,Ee(p)}catch(g){console.error("Error al mover la tarjeta:",g),window.showToast("Error al actualizar el contacto.","error"),oe.from.appendChild(oe.item)}}async function ue(oe,ae){const D=ae||null;try{const{error:c}=await window.auth.sb.from("contacts").update({assigned_to_id:D}).eq("id",oe);if(c)throw c;window.showToast("Contacto asignado correctamente.","success")}catch(c){console.error("Error al asignar el contacto:",c),window.showToast("No se pudo asignar el contacto.","error")}}function te(oe){const ae=n.find(o=>o.id==oe);if(!ae)return;const D=document.getElementById("contact-info-modal"),c=document.getElementById("contact-info-modal-body");!D||!c||(c.innerHTML=`
            <div>
                <p class="text-lg font-bold">${ae.full_name||"Sin nombre"}</p>
                <p class="text-sm text-slate-500">${ae.phone_number}</p>
            </div>
            <div class="border-t pt-4">
                <h5 class="font-semibold mb-2">Etiquetas</h5>
                <div class="flex flex-wrap gap-2">
                    ${(ae.labels||[]).filter(o=>o!=="ignorar").map(o=>{const m=e.find(f=>f.name===o),g=m?ce(m.color):"#A0AEC0",k=Y(g);return`<span class="text-xs font-semibold px-2.5 py-0.5 rounded-full" style="background-color: ${g}; color: ${k};">${o}</span>`}).join("")||'<span class="text-xs text-slate-400">Sin etiquetas</span>'}
                </div>
            </div>
            <div class="border-t pt-4">
                <h5 class="font-semibold mb-2">Información de IA</h5>
                <div class="flex flex-wrap gap-2">
                    ${ae.razon_de_label_auto?`
                        <p class="text-sm bg-blue-50 p-3 rounded-md text-slate-700">${ae.razon_de_label_auto}</p>
                    `:`
                        <p class="text-xs text-slate-400">No hay información de IA para este contacto.</p>
                    `}
                </div>
            </div>
        `,document.getElementById("contact-info-modal-labels-btn").onclick=()=>{ne(),window.contacts.openLabelsModalForSingleContact(oe)},document.getElementById("contact-info-modal-chat-btn").onclick=()=>{ne(),window.appInstance.switchPanel("chats",{contactId:ae.id})},D.classList.remove("hidden"),document.getElementById("close-contact-info-modal-btn").onclick=ne,lucide.createIcons())}function re(oe){const ae=oe.target.closest(".kanban-card");if(!ae)return;const D=ae.querySelector(".kanban-tooltip");if(!D)return;const c=document.getElementById("kanban-board");if(!c)return;const o=ae.getBoundingClientRect(),m=c.getBoundingClientRect(),g=D.offsetHeight;o.top-m.top>g+10?(D.style.bottom="100%",D.style.top="auto"):(D.style.top="100%",D.style.bottom="auto")}function ne(){document.getElementById("contact-info-modal").classList.add("hidden")}const be=["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#FF5722","#795548","#9E9E9E","#607D8B","#FFFFFF"];function ce(oe){if(typeof oe=="string"&&oe.startsWith("#"))return oe;const ae=parseInt(oe,10);return!isNaN(ae)&&ae>=0&&ae<be.length?be[ae]:"#A0AEC0"}function Y(oe){if(!oe||!oe.startsWith("#"))return"#1e293b";const ae=oe.substring(1,7),D=parseInt(ae.substring(0,2),16),c=parseInt(ae.substring(2,4),16),o=parseInt(ae.substring(4,6),16);return(.299*D+.587*c+.114*o)/255>.5?"#1e293b":"#ffffff"}function Ie(){var ae,D;if(b)return;const oe=(D=(ae=window.auth.getSession())==null?void 0:ae.user)==null?void 0:D.id;oe&&(b=window.auth.sb.channel("public:contacts").on("postgres_changes",{event:"UPDATE",schema:"public",table:"contacts",filter:`user_id=eq.${oe}`},c=>{const o=c.new,m=n.findIndex(g=>g.id===o.id);m!==-1?n[m]={...n[m],...o}:n.push(o),Ee(p),window.showToast("El tablero se ha actualizado automáticamente.","info")}).subscribe())}function _e(){b&&(window.auth.sb.removeChannel(b),b=null)}})();(function(){let z=!1,e=[],t="",n="",p="",b=[];document.addEventListener("panel:activated",({detail:r})=>{r.panelId==="products"&&!z&&(_(),z=!0)});function _(){console.log("Inicializando panel de Productos..."),z=!0,A(),f(),H()}function B(r){if(!r||typeof r!="string")return!1;const w=r.trim();if(!w)return!1;const a=[".jpg",".jpeg",".png",".gif",".webp",".svg",".bmp",".mp4",".webm",".ogg",".mov",".avi",".mkv",".flv",".wmv"],i=w.toLowerCase();return a.some(y=>i.endsWith(y))}function A(){var w,a,i,y,d,E,h,x,S,$,G,Z;(w=document.getElementById("download-template-btn"))==null||w.addEventListener("click",re),(a=document.getElementById("export-products-btn"))==null||a.addEventListener("click",te),(i=document.getElementById("import-csv-input"))==null||i.addEventListener("change",ne),(y=document.getElementById("add-product-btn"))==null||y.addEventListener("click",D),(d=document.getElementById("cancel-product-btn"))==null||d.addEventListener("click",ae),(E=document.getElementById("product-form"))==null||E.addEventListener("submit",m),(h=document.getElementById("product-description-ai-enhance-btn"))==null||h.addEventListener("click",o),document.querySelectorAll('input[name="product-type"]').forEach(V=>{V.addEventListener("change",pe=>{const we=document.getElementById("product-service-duration-container"),ie=document.getElementById("product-service-duration"),O=document.getElementById("product-stock-container");pe.target.value==="service"?(we==null||we.classList.remove("hidden"),ie==null||ie.setAttribute("required","required"),O==null||O.classList.add("hidden")):(we==null||we.classList.add("hidden"),ie==null||ie.removeAttribute("required"),ie.value="",O==null||O.classList.remove("hidden"))})}),(x=document.getElementById("products-table-body"))==null||x.addEventListener("click",V=>{V.target.closest(".edit-product-btn")&&c(V.target.closest(".edit-product-btn").dataset.id),V.target.closest(".delete-product-btn")&&N(V.target.closest(".delete-product-btn").dataset.id)}),document.querySelectorAll('[data-role="products-search"]').forEach(V=>{V.addEventListener("input",X)}),(S=document.getElementById("product-label-filter"))==null||S.addEventListener("change",g),($=document.getElementById("product-status-filter"))==null||$.addEventListener("change",k),(G=document.getElementById("deactivate-all-visible-btn"))==null||G.addEventListener("click",()=>l(!1)),(Z=document.getElementById("activate-all-visible-btn"))==null||Z.addEventListener("click",()=>l(!0))}async function N(r){var a,i;if(!(!r||!await((a=window.appModal)==null?void 0:a.confirm("¿Eliminar este producto de forma permanente?","Confirmar eliminación"))))try{const{error:y}=await window.auth.sb.from("products").delete().eq("id",r);if(y)throw y;e=e.filter(d=>d.id!==r),U(),H()}catch(y){console.error("Error al eliminar el producto:",y);const d=(y==null?void 0:y.message)||"No se pudo eliminar el producto.";(i=window.showToast)==null||i.call(window,`Error: ${d}`,"error")}}async function H(){const r=document.getElementById("products-loader"),w=document.getElementById("products-table-body");if(!(!r||!w)){r.textContent="Cargando productos...",r.style.display="block",w.innerHTML="";try{const{data:a,error:i}=await window.auth.sb.from("products").select("*").order("product_name");if(i)throw i;e=Array.isArray(a)?a:[],await f(),U()}catch(a){console.error("Error al cargar productos:",a),r.textContent="No se pudieron cargar los productos. Intenta nuevamente.",r.style.display="block",window.showToast&&window.showToast("No se pudieron cargar los productos. Intenta nuevamente.","error"),be(e.length,e.length)}}}function U(){const r=document.getElementById("products-loader"),w=document.getElementById("products-table-body");if(!r||!w)return;const a=e.length,i=me(e,t,n,p);if(a===0){w.innerHTML="",r.textContent="No tienes productos. Importa un archivo CSV para empezar.",r.style.display="block",be(0,0);return}if(i.length===0){w.innerHTML="",r.textContent=t?"No se encontraron productos que coincidan con la búsqueda.":"No tienes productos. Importa un archivo CSV para empezar.",r.style.display="block",be(0,a);return}r.style.display="none",w.innerHTML=i.map(y=>{const d=y.is_active!==!1,E=d?'<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">Activo</span>':'<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">Inactivo</span>',h=y.labels&&Array.isArray(y.labels)&&y.labels.length>0?y.labels.map(x=>`<span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-800 mr-1">${s(x)}</span>`).join(""):'<span class="text-slate-400 text-xs">Sin etiquetas</span>';return`
            <tr class="${d?"":"opacity-60"}">
                <td class="p-4 font-medium">${s(y.product_name)}</td>
                <td class="p-4 text-slate-600">${s(y.sku||"-")}</td>
                <td class="p-4 text-slate-600">${W(y.price)}</td>
                <td class="p-4 text-slate-600">${ue(y.stock)}</td>
                <td class="p-4">${E}</td>
                <td class="p-4">${h}</td>
                <td class="p-4">${y.media_url?`<a href="${s(y.media_url)}" target="_blank" class="text-blue-500 hover:underline">Ver Media</a>`:"-"}</td>
                <td class="p-4">
                    <div class="flex gap-2">
                        <button class="edit-product-btn p-2 hover:bg-slate-200 rounded-md" data-id="${y.id}" title="Editar"><i data-lucide="edit" class="w-4 h-4 text-slate-600 pointer-events-none"></i></button>
                        <button class="delete-product-btn p-2 hover:bg-red-100 rounded-md" data-id="${y.id}" title="Eliminar"><i data-lucide="trash-2" class="w-4 h-4 text-red-500 pointer-events-none"></i></button>
                    </div>
                </td>
            </tr>
        `}).join(""),be(i.length,a),typeof(lucide==null?void 0:lucide.createIcons)=="function"&&lucide.createIcons()}function X(r){t=r.target.value||"",Ee(r.target),e.length&&U()}function Ee(r){document.querySelectorAll('[data-role="products-search"]').forEach(w=>{w!==r&&(w.value=t)})}function me(r,w,a,i){if(!Array.isArray(r))return[];let y=r;const d=(w||"").toString().trim().toLowerCase();if(d&&(y=y.filter(E=>{const h=(E.product_name||"").toLowerCase().includes(d),x=(E.sku||"").toLowerCase().includes(d),S=(E.description||"").toLowerCase().includes(d);let $=!1;if(E.price!==null&&E.price!==void 0&&E.price!==""){const G=Number(E.price),Z=String(E.price).toLowerCase(),V=Number.isFinite(G)?G.toFixed(2):"",pe=Number.isFinite(G)?G.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2}).toLowerCase():"";$=Z.includes(d)||V.toLowerCase().includes(d)||V.replace(".",",").includes(d)||pe.includes(d)}return h||x||S||$})),a&&a.trim()!==""&&(y=y.filter(E=>{const h=E.labels||[];return Array.isArray(h)&&h.some(x=>x&&x.toString().toLowerCase()===a.toLowerCase())})),i&&i!==""){const E=i==="true";y=y.filter(h=>h.is_active!==!1===E)}return y}function W(r){const w=Number(r);return Number.isFinite(w)?"$"+w.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2}):"$0.00"}function ue(r){if(r===-1)return"Infinita";const w=Number(r);return Number.isFinite(w)?w.toLocaleString("es-MX"):"0"}function te(){var y;if(e.length===0){(y=window.showToast)==null||y.call(window,"No hay productos para exportar.","info");return}const r="product_name,description,price,media_url,stock,sku",w=e.map(d=>{const E=window.escapeCsvValue(d.description||"");return[d.product_name,E,d.price,d.media_url,d.stock,d.sku].join(",")}),a=`data:text/csv;charset=utf-8,${r}
${w.join(`
`)}`,i=document.createElement("a");i.setAttribute("href",encodeURI(a)),i.setAttribute("download","mis_productos.csv"),i.click()}function re(){const r=["nombre_producto","descripcion","precio","media_url","stock","sku"],w=[["Suero hidratante","Suero facial con ácido hialurónico para uso diario.","349.90","https://ejemplo.com/imagenes/suero.jpg","120","SKU-SERUM-01"],["Crema corporal","Crema nutritiva de rápida absorción.","189.50","","-1","SKU-CREMA-02"]],i=`data:text/csv;charset=utf-8,${[r.join(","),...w.map(E=>E.map(window.escapeCsvValue).join(","))].join(`
`)}`,y=encodeURI(i),d=document.createElement("a");d.setAttribute("href",y),d.setAttribute("download","plantilla_productos.csv"),document.body.appendChild(d),d.click(),document.body.removeChild(d)}async function ne(r){var i,y,d,E,h,x,S,$;const w=r.target.files[0];if(!w)return;let a=null;try{const G=await window.convertFileToCsvText(w),Z=window.splitCsvLines(G);if(!Z.length){(i=window.showToast)==null||i.call(window,"El archivo de productos está vacío.","info");return}const V=window.parseCsvRow(Z[0]).map(O=>O.trim());if(!V.length){(y=window.showToast)==null||y.call(window,"No se pudieron detectar las columnas del archivo.","error");return}if(a=await window.openColumnMappingModal(_e,V),!a)return;const pe=Z.slice(1),we=[],ie=new Map;for(const O of pe){const Be=window.parseCsvRow(O).map(L=>(L==null?void 0:L.trim())??""),qe=window.getColumnValue(Be,a.sku);qe&&ie.set(qe,Be)}for(const[,O]of ie){const Be=window.getColumnValue(O,a.product_name),qe=window.getColumnValue(O,a.sku);if(!Be||!qe)continue;const L={product_name:Be,sku:qe,_fieldsFromFile:new Set(["product_name","sku"])};if(a.description!==void 0&&a.description!==null){const F=window.getColumnValue(O,a.description);F?L.description=F.replace(/^"|"$/g,"").replace(/""/g,'"'):L.description=null,L._fieldsFromFile.add("description")}if(a.price!==void 0&&a.price!==null){const F=window.getColumnValue(O,a.price);if(F){const P=Ie(F),j=Number(P);Number.isFinite(j)&&(L.price=j,L._fieldsFromFile.add("price"))}}if(a.media_url!==void 0&&a.media_url!==null){const F=window.getColumnValue(O,a.media_url);F&&B(F)&&(L.media_url=F,L._fieldsFromFile.add("media_url"))}if(a.stock!==void 0&&a.stock!==null){const F=window.getColumnValue(O,a.stock);if(F){const P=F.replace(/[^\d-]/g,""),j=parseInt(P,10);Number.isNaN(j)||(L.stock=j===-1?-1:j,L._fieldsFromFile.add("stock"))}}we.push(L)}if(we.length===0){(d=window.showToast)==null||d.call(window,"El archivo CSV está vacío o no tiene el formato correcto.","info");return}try{const O=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),Be=O?O.id:(h=(E=window.auth.getSession())==null?void 0:E.user)==null?void 0:h.id;if(!Be)throw new Error("No se pudo determinar el usuario destino para la importación.");const qe=await Y().catch(()=>null);let L=null;if(qe)try{const{data:ye,error:Ce}=await window.auth.sb.from("apps").select("id").eq("id",qe).single();!Ce&&ye?L=qe:console.warn("[products-import] app_id no encontrado en tabla apps:",qe)}catch(ye){console.warn("[products-import] Error al verificar app_id:",ye)}const F=we.map(ye=>ye.sku).filter(Boolean),{data:P,error:j}=await window.auth.sb.from("products").select("sku, product_name, description, price, media_url, stock, app_id").eq("user_id",Be).in("sku",F);j&&console.warn("[products-import] Error al obtener productos existentes:",j);const se=new Map;(P||[]).forEach(ye=>{se.set(ye.sku,ye)});const fe=we.map(ye=>{const Ce=se.get(ye.sku),Ue=ye._fieldsFromFile||new Set,je=Ce?{product_name:Ce.product_name,description:Ce.description,price:Ce.price,media_url:Ce.media_url,stock:Ce.stock,app_id:Ce.app_id}:{};if(Ue.has("product_name")&&(je.product_name=ye.product_name),Ue.has("description")&&(je.description=ye.description!==void 0?ye.description:null),Ue.has("price")&&(je.price=ye.price),Ue.has("media_url")){const Ae=ye.media_url;Ae&&B(Ae)?je.media_url=Ae:Ce!=null&&Ce.media_url&&B(Ce.media_url)?je.media_url=Ce.media_url:je.media_url=null}return Ue.has("stock")&&(je.stock=ye.stock),je.sku=ye.sku,je.user_id=Be,L?je.app_id=L:Ce!=null&&Ce.app_id&&(je.app_id=Ce.app_id),je}),{error:ge}=await window.auth.sb.from("products").upsert(fe,{onConflict:"user_id,sku"});if(ge)throw ge;(x=window.showToast)==null||x.call(window,`${fe.length} productos importados/actualizados con éxito.`,"success"),H()}catch(O){console.error("Error al importar CSV:",O),(S=window.showToast)==null||S.call(window,`Error al importar: ${O.message}`,"error")}}catch(G){console.error("Error general en la importación:",G),($=window.showToast)==null||$.call(window,`Error general en la importación: ${G.message}`,"error")}finally{r.target.value=""}}function be(r,w=r){const a=Number(r),i=Number(w),y=Number.isFinite(a)?Math.max(0,Math.trunc(a)):0,d=Number.isFinite(i)?Math.max(0,Math.trunc(i)):0,E=y===1?"producto":"productos",h=y.toLocaleString("es-MX"),x=d.toLocaleString("es-MX"),S=document.getElementById("products-count");S&&(S.textContent=y===d?`${h} ${E}`:`${h} ${E} (de ${x})`);const $=document.getElementById("products-count-overview");$&&($.textContent=x)}function ce(){var w,a,i;const r=(w=window.appInstance)==null?void 0:w.teamInfo;return(r==null?void 0:r.active_app_id)||(r==null?void 0:r.app_id)||(r==null?void 0:r.default_app_id)||((i=(a=r==null?void 0:r.apps)==null?void 0:a[0])==null?void 0:i.id)||(r==null?void 0:r.team_id)||null}async function Y(){var w;const r=ce();if(r)return r;if((w=window.appInstance)!=null&&w.loadTeamInfo){try{await window.appInstance.loadTeamInfo()}catch(i){console.warn("[products-import] No se pudo refrescar teamInfo:",i)}const a=ce();if(a)return a}return localStorage.getItem("active_app_id")||null}function Ie(r){if(!r)return r;const w=r.replace(/[^\d.,-]/g,"").trim();if(!w)return w;const a=w.includes(","),i=w.includes(".");return a&&i?w.lastIndexOf(".")>w.lastIndexOf(",")?w.replace(/,/g,""):w.replace(/\./g,"").replace(",","."):a?w.replace(",","."):w}const _e=[{field:"product_name",label:"Nombre del producto",required:!0,aliases:["product_name","nombre","name","titulo","title"]},{field:"description",label:"Descripción",required:!1,aliases:["description","descripcion","detalle","detalle_producto"]},{field:"price",label:"Precio",required:!1,aliases:["price","precio","pricing","costo","valor"]},{field:"media_url",label:"URL de imagen o media",required:!1,aliases:["media_url","imagen","url_imagen","link","link_media"]},{field:"stock",label:"Disponibilidad (stock)",required:!1,aliases:["stock","inventario","cantidad","existencias"]},{field:"sku",label:"SKU",required:!0,aliases:["sku","codigo","referencia","id_producto"]}];function oe(r){const w=document.getElementById("new-product-modal"),a=document.getElementById("product-form");if(!w||!a)return;a.reset(),document.getElementById("product-id").value=(r==null?void 0:r.id)||"",document.getElementById("product-modal-title").textContent=r?"Editar Producto":"Añadir Nuevo Producto";const i=document.getElementById("product-type-physical"),y=document.getElementById("product-type-service"),d=document.getElementById("product-service-duration-container"),E=document.getElementById("product-service-duration"),h=document.getElementById("product-stock-container");if(i&&(i.checked=!0),y&&(y.checked=!1),d&&d.classList.add("hidden"),h&&h.classList.remove("hidden"),E&&(E.removeAttribute("required"),E.value=""),r){document.getElementById("product-name").value=r.product_name||"",document.getElementById("product-description").value=r.description||"",document.getElementById("product-sku").value=r.sku||"",document.getElementById("product-price").value=r.price||0,document.getElementById("product-labels").value=(r.labels||[]).join(", "),document.getElementById("product-infinite-stock").checked=r.stock===-1,(r.product_type||"physical")==="service"?(y&&(y.checked=!0),i&&(i.checked=!1),d&&d.classList.remove("hidden"),h&&h.classList.add("hidden"),E&&(E.setAttribute("required","required"),E.value=r.service_duration_minutes||"")):(i&&(i.checked=!0),y&&(y.checked=!1),d&&d.classList.add("hidden"),h&&h.classList.remove("hidden"),E&&(E.removeAttribute("required"),E.value=""));const S=document.getElementById("product-stock");S&&(S.value=r.stock===-1?0:r.stock||0,S.disabled=r.stock===-1);const $=document.getElementById("product-image-preview");$&&r.media_url?($.src=r.media_url,$.classList.remove("hidden")):$&&$.classList.add("hidden")}else{const x=document.getElementById("product-image-preview");x&&x.classList.add("hidden");const S=document.getElementById("product-stock");S&&(S.disabled=!1)}w.classList.remove("hidden")}function ae(){document.getElementById("new-product-modal").classList.add("hidden")}function D(){oe(null)}function c(r){const w=e.find(a=>a.id==r);w&&oe(w)}function o(){var y,d,E;const r=document.getElementById("product-description");if(!r)return;const w=r.value.trim(),a=((y=document.getElementById("product-name"))==null?void 0:y.value.trim())||"",i=a?`Producto: ${a}

Descripción actual:
${w||"Sin descripción"}`:w||"Sin descripción";if(!((d=window.appInstance)!=null&&d.openAiEnhanceModal)){(E=window.showToast)==null||E.call(window,"La mejora con IA no está disponible en este momento.","info");return}window.appInstance.openAiEnhanceModal(i,h=>{r.value=h})}async function m(r){var a,i,y,d,E;r.preventDefault();const w=document.getElementById("save-new-product-btn");w.disabled=!0,w.textContent="Guardando...";try{let h=null;const x=document.getElementById("product-media-file").files[0];if(x){const F=["image/jpeg","image/png","image/webp","image/gif"];if(x.size>5242880)throw new Error("El archivo es demasiado grande. El tamaño máximo permitido es de 5 MB.");if(!F.includes(x.type))throw new Error("Formato de archivo no válido. Solo se permiten imágenes (JPG, PNG, WEBP, GIF).")}if(x&&(h=await window.appInstance.uploadAsset(x,"products"),!h))throw new Error("La subida del archivo al servidor final falló. Revisa la consola para más detalles.");const S=document.getElementById("product-infinite-stock").checked,$=document.getElementById("product-id").value,G=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),Z=(G==null?void 0:G.id)||((i=(a=window.auth.getSession())==null?void 0:a.user)==null?void 0:i.id),V=((y=document.getElementById("product-labels"))==null?void 0:y.value.trim())||"",pe=V?V.split(",").map(L=>L.trim()).filter(L=>L.length>0):[],we=document.querySelector('input[name="product-type"]:checked'),ie=(we==null?void 0:we.value)||"physical";if(ie==="service"){const L=document.getElementById("product-service-duration"),F=parseInt(L==null?void 0:L.value);if(!F||F<15)throw new Error("Los servicios deben tener una duración mínima de 15 minutos");if(F%15!==0)throw new Error("La duración debe ser un múltiplo de 15 minutos")}const O={product_name:document.getElementById("product-name").value,description:document.getElementById("product-description").value,sku:document.getElementById("product-sku").value,price:parseFloat(document.getElementById("product-price").value),stock:S?-1:parseInt(document.getElementById("product-stock").value),labels:pe,product_type:ie};ie==="service"?O.service_duration_minutes=parseInt(document.getElementById("product-service-duration").value):O.service_duration_minutes=null,$||(O.user_id=Z),h&&(O.media_url=h);const Be=$?window.auth.sb.from("products").update(O).eq("id",$):window.auth.sb.from("products").insert(O),{error:qe}=await Be;if(qe)throw qe;(d=window.showToast)==null||d.call(window,`¡Producto ${$?"actualizado":"guardado"} con éxito!`,"success"),ae(),H()}catch(h){console.error("Error al guardar el producto:",h),(E=window.showToast)==null||E.call(window,`Error: ${h.message}`,"error")}finally{w.disabled=!1,w.textContent="Guardar Producto"}}function g(r){n=r.target.value||"",U()}function k(r){p=r.target.value||"",U()}async function f(){try{const r=new Set;e.forEach(w=>{w.labels&&Array.isArray(w.labels)&&w.labels.forEach(a=>{a&&a.trim()&&r.add(a.trim())})}),b=Array.from(r).sort(),u()}catch(r){console.error("Error al cargar etiquetas:",r)}}function u(){const r=document.getElementById("product-label-filter");if(!r)return;const w=r.value;r.innerHTML='<option value="">Todas las etiquetas</option>',b.forEach(a=>{const i=document.createElement("option");i.value=a,i.textContent=a,r.appendChild(i)}),w&&(r.value=w)}async function l(r){var S,$,G,Z,V,pe,we,ie;const w=r?document.getElementById("activate-all-visible-btn"):document.getElementById("deactivate-all-visible-btn");if(!w)return;const a=($=(S=window.auth.getSession())==null?void 0:S.user)==null?void 0:$.id;if(!a){(G=window.showToast)==null||G.call(window,"No se pudo determinar el usuario actual.","error");return}const i=n&&n.trim()!==""?[n]:null,y=t&&t.trim()!==""?t.trim():null;let d=null;p&&p!==""?d=p==="true":d=!r;const E=r?"activar":"desactivar";if(!(await((Z=window.appModal)==null?void 0:Z.confirm(`¿${E.charAt(0).toUpperCase()+E.slice(1)} todos los productos visibles según los filtros actuales?`,"Confirmar acción masiva"))||!1))return;w.disabled=!0;const x=w.innerHTML;w.innerHTML=r?'<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i><span>Activando...</span>':'<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i><span>Desactivando...</span>',typeof(lucide==null?void 0:lucide.createIcons)=="function"&&lucide.createIcons();try{const{data:O,error:Be}=await window.auth.sb.rpc("bulk_update_products_status",{p_user_id:a,p_is_active:r,p_label_filter:i,p_search_term:y,p_current_status_filter:d});if(Be)throw Be;const qe=((V=O==null?void 0:O[0])==null?void 0:V.updated_count)||0;await H(),await f(),qe===0?(pe=window.showToast)==null||pe.call(window,`No se encontraron productos para ${E} con los filtros actuales.`,"info"):(we=window.showToast)==null||we.call(window,`Se ${r?"activaron":"desactivaron"} ${qe} producto(s) exitosamente.`,"success")}catch(O){console.error("Error al actualizar estado de productos:",O),(ie=window.showToast)==null||ie.call(window,`Error al ${E} productos: ${O.message||"Error desconocido"}`,"error")}finally{w.disabled=!1,w.innerHTML=x,typeof(lucide==null?void 0:lucide.createIcons)=="function"&&lucide.createIcons()}}function s(r){if(!r)return"";const w=document.createElement("div");return w.textContent=r,w.innerHTML}})();(function(){let z=!1,e=[],t=null,n=[],p=[];async function b(){var o;try{const m=await B();if(!m)return!1;try{const{data:g,error:k}=await window.auth.sb.from("profiles").select("quotes_enabled").eq("id",m).single();return k?k.code==="42703"||k.code==="PGRST204"?(console.warn("[Quotes] quotes_enabled no existe, usando valor por defecto (false)"),!1):(console.error("[Quotes] Error al verificar quotes_enabled:",k),!1):(g==null?void 0:g.quotes_enabled)||!1}catch(g){if(g.code==="42703"||g.code==="PGRST204"||(o=g.message)!=null&&o.includes("does not exist"))return console.warn("[Quotes] quotes_enabled no disponible, usando valor por defecto"),!1;throw g}}catch(m){return console.error("[Quotes] Error al verificar quotes_enabled:",m),!1}}document.addEventListener("panel:activated",async({detail:o})=>{if(o.panelId==="quotes"){if(!await b()){const g=document.getElementById("quotes");if(g){g.innerHTML=`
                        <div class="flex flex-col items-center justify-center min-h-[400px] text-center p-8">
                            <i data-lucide="lock" class="w-16 h-16 text-slate-400 mb-4"></i>
                            <h3 class="text-xl font-semibold text-slate-700 mb-2">Cotizaciones Deshabilitadas</h3>
                            <p class="text-slate-500 mb-4">Habilita la sección de cotizaciones en Configuración para usar esta funcionalidad.</p>
                            <button id="quotes-enable-btn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors">
                                Ir a Configuración
                            </button>
                        </div>
                    `,window.lucide&&window.lucide.createIcons();const k=document.getElementById("quotes-enable-btn");k&&k.addEventListener("click",()=>{var f;if(typeof window.switchPanel=="function")window.switchPanel("settings");else if((f=window.appInstance)!=null&&f.switchPanel)window.appInstance.switchPanel("settings");else{const u=document.querySelector('.nav-link[data-target="settings"]');u?u.click():(console.error("[Quotes] No se pudo navegar a settings"),window.showToast&&window.showToast("Error: No se pudo navegar a Configuración","error"))}})}return}if(z)A();else{if(!window.auth||!window.auth.sb){console.warn("[Quotes] window.auth no está disponible aún, reintentando..."),setTimeout(()=>{window.auth&&window.auth.sb?(_(),z=!0):console.error("[Quotes] No se pudo inicializar: window.auth no disponible")},500);return}_(),z=!0}}});async function _(){console.log("[Quotes] Inicializando módulo de cotizaciones...");try{await Promise.all([A(),N(),H()]),X(),console.log("[Quotes] Módulo inicializado correctamente")}catch(o){console.error("[Quotes] Error al inicializar:",o)}}async function B(){return typeof window.getUserId=="function"?await window.getUserId():(console.warn("[Quotes] window.getUserId no está disponible"),null)}async function A(){try{const o=await B();if(!o){console.error("[Quotes] No se pudo obtener user_id");return}console.log("[Quotes] Cargando cotizaciones para user_id:",o);const{data:m,error:g}=await window.auth.sb.from("quotes").select(`
                *,
                contacts:contact_id (
                    id,
                    full_name,
                    phone_number
                )
            `).eq("user_id",o).order("created_at",{ascending:!1});if(g)throw console.error("[Quotes] Error en consulta:",g),g;e=m||[],console.log("[Quotes] Cotizaciones cargadas:",e.length),e.length>0?console.log("[Quotes] Primera cotización:",{id:e[0].id,pdf_url:e[0].pdf_url?"Sí":"No",status:e[0].status,total:e[0].total}):console.log("[Quotes] No hay cotizaciones en Supabase. Las cotizaciones antiguas pueden estar solo en Bunny.net."),U()}catch(o){console.error("[Quotes] Error al cargar cotizaciones:",o),window.showToast&&window.showToast("Error al cargar cotizaciones: "+(o.message||"Error desconocido"),"error")}}async function N(){try{const o=await B();if(!o)return;const{data:m,error:g}=await window.auth.sb.from("products").select("id, product_name, price, description, media_url, stock").eq("user_id",o).order("product_name");if(g)throw g;n=m||[]}catch(o){console.error("Error al cargar productos:",o)}}async function H(){try{const o=await B();if(!o)return;const{data:m,error:g}=await window.auth.sb.from("contacts").select("id, full_name, phone_number").eq("user_id",o).order("full_name");if(g)throw g;p=m||[]}catch(o){console.error("Error al cargar contactos:",o)}}function U(){const o=document.getElementById("quotes-table-body");if(!o){console.warn("[Quotes] No se encontró el elemento quotes-table-body");return}if(console.log("[Quotes] Renderizando tabla con",e.length,"cotizaciones"),e.length===0){o.innerHTML=`
            <tr>
                <td colspan="6" class="text-center py-8 text-slate-500">
                    No hay cotizaciones aún. Crea tu primera cotización haciendo clic en "Nueva Cotización".
                </td>
            </tr>
        `;return}const m=g=>{if(!g)return"";const k=document.createElement("div");return k.textContent=g,k.innerHTML};o.innerHTML=e.map(g=>{const k=g.contacts||{},f={draft:"bg-slate-100 text-slate-700",sent:"bg-blue-100 text-blue-700",accepted:"bg-green-100 text-green-700",rejected:"bg-red-100 text-red-700",expired:"bg-orange-100 text-orange-700"},u={draft:"Borrador",sent:"Enviada",accepted:"Aceptada",rejected:"Rechazada",expired:"Expirada"},l=m(g.id||""),s=m(k.full_name||"Sin nombre"),r=g.created_at?new Date(g.created_at).toLocaleDateString("es-ES"):"N/A",w=parseFloat(g.total||0).toFixed(2),a=g.status||"draft";return`
            <tr class="hover:bg-slate-50 transition-colors">
                <td class="px-4 py-3 font-mono text-sm">${l}</td>
                <td class="px-4 py-3">${s}</td>
                <td class="px-4 py-3">${r}</td>
                <td class="px-4 py-3 font-semibold">$${w}</td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${f[a]||f.draft}">
                        ${u[a]||"Borrador"}
                    </span>
                </td>
                <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                        <button onclick="viewQuote('${l}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded" title="Ver">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                        </button>
                        <button onclick="editQuote('${l}')" class="p-2 text-green-600 hover:bg-green-50 rounded" title="Editar">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </button>
                        <button onclick="downloadQuote('${l}')" class="p-2 text-purple-600 hover:bg-purple-50 rounded" title="Descargar PDF">
                            <i data-lucide="download" class="w-4 h-4"></i>
                        </button>
                        <button onclick="sendQuoteWhatsApp('${l}')" class="p-2 text-green-600 hover:bg-green-50 rounded" title="Enviar por WhatsApp">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `}).join(""),window.lucide&&window.lucide.createIcons()}function X(){console.log("[Quotes] Configurando event listeners...");const o=document.getElementById("new-quote-btn"),m=document.getElementById("create-quote-btn"),g=document.getElementById("cancel-quote-btn"),k=document.getElementById("cancel-quote-btn-bottom"),f=document.getElementById("save-quote-btn"),u=document.getElementById("quote-modal"),l=document.getElementById("quote-search"),s=document.getElementById("quote-status-filter"),r=document.getElementById("quote-settings-btn");o?o.addEventListener("click",()=>{console.log("[Quotes] Botón Nueva Cotización clickeado"),Ee()}):console.warn("[Quotes] No se encontró el botón new-quote-btn"),r?r.addEventListener("click",()=>{console.log("[Quotes] Botón Personalizar PDF clickeado"),oe()}):console.warn("[Quotes] No se encontró el botón quote-settings-btn"),m&&m.addEventListener("click",()=>Y()),g&&g.addEventListener("click",()=>ue()),k&&k.addEventListener("click",()=>ue()),f&&f.addEventListener("click",()=>Ie()),u&&u.addEventListener("click",S=>{S.target.id==="quote-modal"&&ue()}),l&&l.addEventListener("input",_e),s&&s.addEventListener("change",_e);const w=document.getElementById("close-quote-settings-btn"),a=document.getElementById("cancel-quote-settings-btn"),i=document.getElementById("save-quote-settings-btn"),y=document.getElementById("quote-settings-modal"),d=document.getElementById("quote-logo-url");w&&w.addEventListener("click",()=>ae()),a&&a.addEventListener("click",()=>ae()),i&&i.addEventListener("click",()=>c()),y&&y.addEventListener("click",S=>{S.target.id==="quote-settings-modal"&&ae()}),d&&d.addEventListener("input",()=>{const S=document.getElementById("quote-logo-preview"),$=document.getElementById("quote-logo-preview-img");d.value?($.src=d.value,S.classList.remove("hidden")):S.classList.add("hidden")});const E=document.getElementById("quote-discount"),h=document.getElementById("quote-tax"),x=document.getElementById("quote-prices-include-tax");E&&E.addEventListener("input",ce),h&&h.addEventListener("input",ce),x&&x.addEventListener("change",ce)}async function Ee(o=null){var y;console.log("[Quotes] Abriendo modal de cotización, quoteId:",o),t=o?e.find(d=>d.id===o):null;const m=document.getElementById("quote-modal");if(!m){console.error("[Quotes] No se encontró el elemento quote-modal en el DOM"),window.showToast&&window.showToast("Error: No se encontró el modal de cotización","error");return}console.log("[Quotes] Modal encontrado, removiendo clase hidden");const g=document.getElementById("quote-modal-title"),k=document.getElementById("quote-items-container"),f=document.getElementById("quote-notes"),u=document.getElementById("quote-valid-until");g&&(g.textContent=t?"Editar Cotización":"Nueva Cotización");const l=document.getElementById("quote-contact-search"),s=document.getElementById("quote-contact-id"),r=document.getElementById("quote-contact-results");if(l&&s&&r){if(p.length===0&&(console.warn("[Quotes] No hay contactos cargados, recargando..."),await H()),t&&t.contact_id){const d=p.find(E=>E.id===t.contact_id);d&&(l.value=d.full_name||d.phone_number||"",s.value=d.id)}else l.value="",s.value="";me(l,s,r),console.log("[Quotes] Buscador de contactos configurado:",p.length)}else console.warn("[Quotes] No se encontraron elementos del buscador de contactos");if(n.length===0&&(console.warn("[Quotes] No hay productos cargados, recargando..."),await N()),console.log("[Quotes] Productos disponibles:",n.length),t){f&&(f.value=t.notes||""),u&&t.valid_until&&(u.value=new Date(t.valid_until).toISOString().split("T")[0]);const d=document.getElementById("quote-discount"),E=document.getElementById("quote-tax"),h=document.getElementById("quote-prices-include-tax");if(d&&t.discount!==void 0){const $=((y=t.items)==null?void 0:y.reduce((G,Z)=>G+(Z.subtotal||0),0))||0;$>0&&t.discount_percent!==void 0?d.value=t.discount_percent:$>0?d.value=(t.discount/$*100).toFixed(2):d.value=0}E&&(E.value=t.tax_percent||t.tax_percent||16),h&&(h.checked=t.prices_include_tax||!1),te(t.items||[]),ce();const x=document.getElementById("create-quote-btn"),S=document.getElementById("save-quote-btn");x&&x.classList.add("hidden"),S&&S.classList.remove("hidden")}else{k&&(k.innerHTML='<p class="text-slate-500 text-center py-4">No hay productos agregados</p>'),f&&(f.value=""),u&&(u.value="");const d=document.getElementById("quote-discount"),E=document.getElementById("quote-tax"),h=document.getElementById("quote-prices-include-tax");d&&(d.value=0),E&&(E.value=16),h&&(h.checked=!1);const x=document.getElementById("create-quote-btn"),S=document.getElementById("save-quote-btn");x&&x.classList.remove("hidden"),S&&S.classList.add("hidden")}m.parentElement!==document.body&&(console.log("[Quotes] Moviendo modal al body"),document.body.appendChild(m)),m.classList.remove("hidden"),m.style.setProperty("display","flex","important"),m.style.setProperty("visibility","visible","important"),m.style.setProperty("opacity","1","important"),m.style.setProperty("z-index","9999","important"),m.style.setProperty("position","fixed","important"),document.body.style.overflow="hidden",console.log("[Quotes] Modal abierto, clases:",m.className);const w=window.getComputedStyle(m);console.log("[Quotes] Estilos aplicados:",{display:w.display,visibility:w.visibility,opacity:w.opacity,zIndex:w.zIndex,position:w.position,width:w.width,height:w.height,top:w.top,left:w.left,right:w.right,bottom:w.bottom});const a=m.getBoundingClientRect();console.log("[Quotes] Posición del modal:",{top:a.top,left:a.left,width:a.width,height:a.height,visible:a.width>0&&a.height>0});const i=document.elementsFromPoint(window.innerWidth/2,window.innerHeight/2);console.log("[Quotes] Elementos en el centro de la pantalla:",i.slice(0,5).map(d=>({tag:d.tagName,id:d.id,classes:d.className,zIndex:window.getComputedStyle(d).zIndex}))),k||console.warn("[Quotes] No se encontró quote-items-container"),window.lucide&&setTimeout(()=>{window.lucide.createIcons()},100)}function me(o,m,g){let k;o.addEventListener("input",f=>{clearTimeout(k);const u=f.target.value.trim().toLowerCase();if(u.length===0){g.classList.add("hidden"),m.value="";return}k=setTimeout(()=>{const l=p.filter(s=>{const r=(s.full_name||"").toLowerCase(),w=(s.phone_number||"").toLowerCase();return r.includes(u)||w.includes(u)}).slice(0,10);l.length>0?(g.innerHTML=l.map(s=>`
                        <div class="px-4 py-2 hover:bg-slate-100 cursor-pointer border-b border-slate-200 last:border-b-0" 
                             data-contact-id="${s.id}"
                             onclick="selectContact(${s.id}, '${W(s.full_name||s.phone_number||"")}')">
                            <div class="font-medium">${W(s.full_name||"Sin nombre")}</div>
                            ${s.phone_number?`<div class="text-sm text-slate-500">${W(s.phone_number)}</div>`:""}
                        </div>
                    `).join(""),g.classList.remove("hidden")):(g.innerHTML='<div class="px-4 py-2 text-slate-500 text-center">No se encontraron contactos</div>',g.classList.remove("hidden"))},200)}),document.addEventListener("click",f=>{!o.contains(f.target)&&!g.contains(f.target)&&g.classList.add("hidden")})}window.selectContact=function(o,m){const g=document.getElementById("quote-contact-search"),k=document.getElementById("quote-contact-id"),f=document.getElementById("quote-contact-results");g&&k&&f&&(g.value=m,k.value=o,f.classList.add("hidden"))};function W(o){if(!o)return"";const m=document.createElement("div");return m.textContent=o,m.innerHTML}function ue(){const o=document.getElementById("quote-modal");o&&(o.style.removeProperty("display"),o.style.removeProperty("visibility"),o.style.removeProperty("opacity"),o.style.removeProperty("z-index"),o.style.removeProperty("position"),o.classList.add("hidden"),document.body.style.overflow=""),t=null}function te(o){const m=document.getElementById("quote-items-container");m&&(m.innerHTML=o.map((g,k)=>{var f;return`
        <div class="quote-item bg-slate-50 p-4 rounded-lg border border-slate-200" data-index="${k}">
            <div class="grid grid-cols-12 gap-4 items-center">
                <div class="col-span-5">
                    <div class="relative">
                        <input type="text" 
                               class="quote-product-search w-full px-3 py-2 border border-slate-300 rounded-lg" 
                               placeholder="Buscar producto..."
                               data-item-index="${k}"
                               value="${g.product_id&&((f=n.find(u=>u.id===g.product_id))==null?void 0:f.product_name)||""}"
                               autocomplete="off">
                        <input type="hidden" class="quote-product-id" data-item-index="${k}" value="${g.product_id||""}">
                        <div class="quote-product-results hidden absolute z-50 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg max-h-60 overflow-y-auto" data-item-index="${k}">
                            <!-- Los resultados se mostrarán aquí -->
                        </div>
                    </div>
                </div>
                <div class="col-span-2">
                    <input type="number" min="1" step="1" 
                           class="quote-quantity w-full px-3 py-2 border border-slate-300 rounded-lg"
                           value="${g.quantity||1}"
                           onchange="updateQuoteItem(${k}, 'quantity', this.value)">
                </div>
                <div class="col-span-2">
                    <input type="number" min="0" step="0.01"
                           class="quote-price w-full px-3 py-2 border border-slate-300 rounded-lg"
                           value="${g.price||0}"
                           onchange="updateQuoteItem(${k}, 'price', this.value)">
                </div>
                <div class="col-span-2 font-semibold text-right">
                    $${((g.quantity||1)*(g.price||0)).toFixed(2)}
                </div>
                <div class="col-span-1">
                    <button onclick="removeQuoteItem(${k})" 
                            class="p-2 text-red-600 hover:bg-red-50 rounded">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    `}).join("")||'<p class="text-slate-500 text-center py-4">No hay productos agregados</p>',ce(),window.lucide&&window.lucide.createIcons(),re())}function re(){document.querySelectorAll(".quote-product-search").forEach(m=>{const g=parseInt(m.getAttribute("data-item-index")),k=document.querySelector(`.quote-product-results[data-item-index="${g}"]`),f=document.querySelector(`.quote-product-id[data-item-index="${g}"]`);k&&f&&ne(m,f,k,g)})}function ne(o,m,g,k){let f;o.addEventListener("input",u=>{clearTimeout(f);const l=u.target.value.trim().toLowerCase();if(l.length===0){g.classList.add("hidden"),m.value="",updateQuoteItem(k,"product_id",""),updateQuoteItem(k,"price","0");return}f=setTimeout(()=>{const s=n.filter(r=>{const w=(r.product_name||"").toLowerCase(),a=(r.sku||"").toLowerCase(),i=(r.description||"").toLowerCase();return w.includes(l)||a.includes(l)||i.includes(l)}).slice(0,10);s.length>0?(g.innerHTML=s.map(r=>`
                        <div class="px-4 py-2 hover:bg-slate-100 cursor-pointer border-b border-slate-200 last:border-b-0" 
                             onclick="selectProduct(${k}, ${r.id}, '${W(r.product_name||"")}', ${parseFloat(r.price||0)})">
                            <div class="font-medium">${W(r.product_name||"Sin nombre")}</div>
                            <div class="text-sm text-slate-500">
                                ${r.sku?`SKU: ${W(r.sku)} • `:""}
                                $${parseFloat(r.price||0).toFixed(2)}
                            </div>
                        </div>
                    `).join(""),g.classList.remove("hidden")):(g.innerHTML='<div class="px-4 py-2 text-slate-500 text-center">No se encontraron productos</div>',g.classList.remove("hidden"))},200)}),document.addEventListener("click",u=>{!o.contains(u.target)&&!g.contains(u.target)&&g.classList.add("hidden")})}window.selectProduct=function(o,m,g,k){const f=document.querySelector(`.quote-product-search[data-item-index="${o}"]`),u=document.querySelector(`.quote-product-id[data-item-index="${o}"]`),l=document.querySelector(`.quote-product-results[data-item-index="${o}"]`);f&&u&&l&&(f.value=g,u.value=m,l.classList.add("hidden"),updateQuoteItem(o,"product_id",m),updateQuoteItem(o,"price",k))},window.addQuoteItem=function(){const o=be();o.push({product_id:null,product_name:"",quantity:1,price:0,subtotal:0}),te(o),ce()},window.updateQuoteItem=function(o,m,g){const k=be();if(k[o]){if(m==="product_id"){const f=n.find(u=>u.id===parseInt(g));f&&(k[o].product_id=f.id,k[o].product_name=f.product_name,k[o].price=parseFloat(f.price||0),k[o].description=f.description,k[o].image_url=f.media_url)}else(m==="quantity"||m==="price")&&(k[o][m]=parseFloat(g)||0);k[o].subtotal=(k[o].quantity||1)*(k[o].price||0),te(k),ce()}},window.removeQuoteItem=function(o){const m=be();m.splice(o,1),te(m),ce()};function be(){const o=document.getElementById("quote-items-container");if(!o)return[];const m=[];return o.querySelectorAll(".quote-item").forEach((g,k)=>{const f=g.querySelector(".quote-product-id"),u=g.querySelector(".quote-product-search"),l=g.querySelector(".quote-quantity"),s=g.querySelector(".quote-price");if(f&&f.value){const r=n.find(w=>w.id===parseInt(f.value));m.push({product_id:parseInt(f.value),product_name:(r==null?void 0:r.product_name)||(u==null?void 0:u.value)||"",quantity:parseFloat((l==null?void 0:l.value)||1),price:parseFloat((s==null?void 0:s.value)||0),subtotal:parseFloat((l==null?void 0:l.value)||1)*parseFloat((s==null?void 0:s.value)||0),description:r==null?void 0:r.description,image_url:r==null?void 0:r.media_url})}}),m}function ce(){var d,E,h;const m=be().reduce((x,S)=>x+S.subtotal,0),g=parseFloat(((d=document.getElementById("quote-discount"))==null?void 0:d.value)||0),k=m*(g/100),f=parseFloat(((E=document.getElementById("quote-tax"))==null?void 0:E.value)||16),u=((h=document.getElementById("quote-prices-include-tax"))==null?void 0:h.checked)||!1,l=m-k;let s=0;if(u){const x=l/(1+f/100);s=l-x}else s=l*(f/100);const r=l+(u?0:s),w=document.getElementById("quote-subtotal"),a=document.getElementById("quote-discount-display"),i=document.getElementById("quote-tax-display"),y=document.getElementById("quote-total");w&&(w.textContent=`$${m.toFixed(2)}`),a&&(a.textContent=`-$${k.toFixed(2)}`),i&&(i.textContent=`$${s.toFixed(2)}`),y&&(y.textContent=`$${r.toFixed(2)}`)}async function Y(){var k,f,u,l,s;const o=document.getElementById("create-quote-btn"),m=document.getElementById("save-quote-btn"),g=t?m:o;if(g&&g.disabled){console.log("[Quotes] Creación de cotización ya en proceso, ignorando clic duplicado");return}try{if(g){g.disabled=!0;const V=g.textContent;g.textContent="Creando...",setTimeout(()=>{g.disabled&&(g.disabled=!1,g.textContent=V)},1e4)}const r=document.getElementById("quote-contact-id"),w=be();if(!r||!r.value){window.showToast("Selecciona un contacto","error"),g&&(g.disabled=!1,g.textContent=t?"Guardar Cambios":"Crear Cotización");return}if(w.length===0){window.showToast("Agrega al menos un producto","error"),g&&(g.disabled=!1,g.textContent=t?"Guardar Cambios":"Crear Cotización");return}const a=await B();if(!a){window.showToast("Error: No se pudo obtener el ID de usuario","error"),g&&(g.disabled=!1,g.textContent=t?"Guardar Cambios":"Crear Cotización");return}const i=w.reduce((V,pe)=>V+pe.subtotal,0),y=parseFloat(((k=document.getElementById("quote-discount"))==null?void 0:k.value)||0),d=parseFloat(((f=document.getElementById("quote-tax"))==null?void 0:f.value)||16),E=((u=document.getElementById("quote-prices-include-tax"))==null?void 0:u.checked)||!1,h=i*(y/100),x=i-h;let S=0;if(E){const V=x/(1+d/100);S=x-V}else S=x*(d/100);const $=x+(E?0:S),{data:G,error:Z}=await window.auth.invokeFunction("create-quote",{body:{user_id:a,contact_id:parseInt(r.value),items:w,discount:h,discount_percent:y,tax:S,tax_percent:d,prices_include_tax:E,subtotal:i,total:$,valid_until:((l=document.getElementById("quote-valid-until"))==null?void 0:l.value)||null,notes:((s=document.getElementById("quote-notes"))==null?void 0:s.value)||""}});if(Z)throw Z;g&&(g.disabled=!1,g.textContent=t?"Guardar Cambios":"Crear Cotización"),window.showToast("Cotización creada exitosamente","success"),ue(),await A(),G&&G.quote&&G.quote.id&&setTimeout(()=>{viewQuote(G.quote.id)},300)}catch(r){console.error("Error al crear cotización:",r),g&&(g.disabled=!1,g.textContent=t?"Guardar Cambios":"Crear Cotización"),window.showToast("Error al crear cotización: "+(r.message||"Error desconocido"),"error")}}async function Ie(){var i,y,d,E,h,x,S;const o=document.getElementById("save-quote-btn");if(o&&o.disabled){console.log("[Quotes] Guardado de cotización ya en proceso, ignorando clic duplicado");return}if(!t||!t.id){console.warn("[Quotes] No hay cotización en edición, creando nueva"),Y();return}const m=await B();if(!m){window.showToast("Error: No se pudo obtener el ID de usuario","error"),o&&(o.disabled=!1,o.textContent="Guardar Cambios");return}const g=be(),k=g.reduce(($,G)=>$+G.subtotal,0),f=parseFloat(((i=document.getElementById("quote-discount"))==null?void 0:i.value)||0),u=parseFloat(((y=document.getElementById("quote-tax"))==null?void 0:y.value)||16),l=((d=document.getElementById("quote-prices-include-tax"))==null?void 0:d.checked)||!1,s=k*(f/100),r=k-s;let w=0;if(l){const $=r/(1+u/100);w=r-$}else w=r*(u/100);const a=r+(l?0:w);if(o){o.disabled=!0;const $=o.textContent;o.textContent="Guardando...",setTimeout(()=>{o.disabled&&(o.disabled=!1,o.textContent=$)},1e4)}try{const{error:$}=await window.auth.sb.from("quotes").update({items:g,subtotal:k,discount:s,discount_percent:f,tax:w,tax_percent:u,prices_include_tax:l,total:a,notes:((E=document.getElementById("quote-notes"))==null?void 0:E.value)||"",valid_until:((h=document.getElementById("quote-valid-until"))==null?void 0:h.value)||null,updated_at:new Date().toISOString()}).eq("id",t.id).eq("user_id",m);if($)throw $;const{data:G,error:Z}=await window.auth.invokeFunction("generate-quote-pdf",{body:{quote_id:t.id,user_id:m,contact_id:t.contact_id,items:g,subtotal:k,discount:s,discount_percent:f,tax:w,tax_percent:u,prices_include_tax:l,total:a,valid_until:((x=document.getElementById("quote-valid-until"))==null?void 0:x.value)||null,notes:((S=document.getElementById("quote-notes"))==null?void 0:S.value)||""}});o&&(o.disabled=!1,o.textContent="Guardar Cambios"),Z?console.warn("Error al regenerar PDF:",Z):G!=null&&G.pdf_url&&await window.auth.sb.from("quotes").update({pdf_url:G.pdf_url}).eq("id",t.id).eq("user_id",m),window.showToast("Cotización actualizada exitosamente","success"),ue(),A()}catch($){console.error("Error al guardar cotización:",$),o&&(o.disabled=!1,o.textContent="Guardar Cambios"),window.showToast("Error al guardar cotización: "+($.message||"Error desconocido"),"error")}}window.viewQuote=function(o){const m=e.find(g=>g.id===o);if(!m||!m.pdf_url){window.showToast("No hay PDF disponible para esta cotización","error");return}window.open(m.pdf_url,"_blank")},window.editQuote=function(o){Ee(o)},window.downloadQuote=async function(o){const m=e.find(g=>g.id===o);if(!m||!m.pdf_url){window.showToast("No hay PDF disponible para esta cotización","error");return}try{const k=await(await fetch(m.pdf_url)).blob(),f=window.URL.createObjectURL(k),u=document.createElement("a");u.href=f,u.download=`cotizacion-${m.id}.pdf`,document.body.appendChild(u),u.click(),document.body.removeChild(u),window.URL.revokeObjectURL(f)}catch(g){console.error("Error al descargar PDF:",g),window.open(m.pdf_url,"_blank","noopener,noreferrer")}},window.sendQuoteWhatsApp=async function(o){const m=e.find(f=>f.id===o);if(!m||!m.pdf_url){window.showToast("No hay PDF disponible para esta cotización","error");return}const g=m.contacts||{},k=g.id||m.contact_id;if(k)try{const f=await B();if(!f){window.showToast("Error: No se pudo obtener el usuario","error");return}const{data:u,error:l}=await window.auth.sb.from("chat_history").select("contact_id").eq("contact_id",k).eq("user_id",f).limit(1).maybeSingle();if(window.appInstance&&window.appInstance.switchPanel)window.appInstance.switchPanel("chats",{contactId:k}),window.showToast("Abriendo chat con el contacto...","info");else{const s=document.querySelector('.nav-link[data-target="chats"]');s&&(s.click(),setTimeout(()=>{if(window.loadChatForContact)window.loadChatForContact(k);else{const r=document.getElementById("chat-search-input");r&&g.phone_number&&(r.value=g.phone_number,r.dispatchEvent(new Event("input")))}},500))}}catch(f){console.error("[Quotes] Error al abrir chat:",f),window.downloadQuote(o)}else window.downloadQuote(o),window.showToast("PDF descargado. No hay contacto asignado a esta cotización.","info")};function _e(){var f,u;const o=((f=document.getElementById("quote-search"))==null?void 0:f.value.toLowerCase())||"",m=((u=document.getElementById("quote-status-filter"))==null?void 0:u.value)||"all",g=e.filter(l=>{var w;const s=l.id.toLowerCase().includes(o)||(((w=l.contacts)==null?void 0:w.full_name)||"").toLowerCase().includes(o),r=m==="all"||l.status===m;return s&&r}),k=e;e=g,U(),e=k}function oe(){console.log("[Quotes] Abriendo modal de configuración");const o=document.getElementById("quote-settings-modal");if(!o){console.error("[Quotes] No se encontró el elemento quote-settings-modal en el DOM"),window.showToast&&window.showToast("Error: No se encontró el modal de configuración","error");return}console.log("[Quotes] Modal de configuración encontrado, removiendo clase hidden");const m=document.getElementById("close-quote-settings-btn"),g=document.getElementById("cancel-quote-settings-btn");m&&!m.dataset.listenerAttached&&(m.addEventListener("click",()=>ae()),m.dataset.listenerAttached="true"),g&&!g.dataset.listenerAttached&&(g.addEventListener("click",()=>ae()),g.dataset.listenerAttached="true"),D(),o.parentElement!==document.body&&(console.log("[Quotes] Moviendo modal de configuración al body"),document.body.appendChild(o)),o.classList.remove("hidden"),o.style.setProperty("display","flex","important"),o.style.setProperty("visibility","visible","important"),o.style.setProperty("opacity","1","important"),o.style.setProperty("z-index","9999","important"),o.style.setProperty("position","fixed","important"),document.body.style.overflow="hidden",console.log("[Quotes] Modal de configuración abierto, clases:",o.className);const k=window.getComputedStyle(o);console.log("[Quotes] Estilos aplicados:",{display:k.display,visibility:k.visibility,opacity:k.opacity,zIndex:k.zIndex,position:k.position,width:k.width,height:k.height});const f=o.getBoundingClientRect();console.log("[Quotes] Posición del modal de configuración:",{top:f.top,left:f.left,width:f.width,height:f.height,visible:f.width>0&&f.height>0}),window.lucide&&setTimeout(()=>{window.lucide.createIcons()},100)}function ae(){const o=document.getElementById("quote-settings-modal");o&&(o.style.removeProperty("display"),o.style.removeProperty("visibility"),o.style.removeProperty("opacity"),o.style.removeProperty("z-index"),o.style.removeProperty("position"),o.classList.add("hidden"),document.body.style.overflow="",console.log("[Quotes] Modal de configuración cerrado"))}async function D(){var o,m;try{const g=await B();if(!g)return;const k=window.setValue||((E,h,x=!1)=>{const S=document.getElementById(E);if(!S){console.warn(`[Quotes] Elemento no encontrado: ${E}`);return}x?S.checked=h:S.value=h||""}),{data:f,error:u}=await window.auth.sb.from("profiles").select("organization_id, work_start_hour, work_end_hour, business_address, business_phone, contact_phone, website, branding_settings").eq("id",g).single();u&&u.code!=="PGRST116"&&console.error("[Quotes] Error al cargar perfil:",u);let l=null;if(f&&f.organization_id){const{data:E,error:h}=await window.auth.sb.from("organizations").select("name, address, phone, company_email, website").eq("id",f.organization_id).single();!h&&E&&(l=E,console.log("[Quotes] Datos de organización cargados:",E))}const{data:s,error:r}=await window.auth.sb.from("quote_settings").select("*").eq("user_id",g).maybeSingle();r&&r.code!=="PGRST116"&&console.error("[Quotes] Error al cargar configuración de cotizaciones:",r);let w="";if((f==null?void 0:f.work_start_hour)!==null&&(f==null?void 0:f.work_end_hour)!==null){const E=String(f.work_start_hour).padStart(2,"0"),h=String(f.work_end_hour).padStart(2,"0");w=`${E}:00 - ${h}:00`}const a=(f==null?void 0:f.branding_settings)||{},i=((o=a.colors)==null?void 0:o[0])||"#000000",y=((m=a.colors)==null?void 0:m[1])||"#666666",d={company_name:(l==null?void 0:l.name)||(s==null?void 0:s.company_name)||"",company_address:(l==null?void 0:l.address)||(f==null?void 0:f.business_address)||(s==null?void 0:s.company_address)||"",company_phone:(l==null?void 0:l.phone)||(f==null?void 0:f.business_phone)||(f==null?void 0:f.contact_phone)||(s==null?void 0:s.company_phone)||"",company_email:(l==null?void 0:l.company_email)||(s==null?void 0:s.company_email)||"",company_website:(f==null?void 0:f.website)||(l==null?void 0:l.website)||(s==null?void 0:s.company_website)||"",company_logo_url:a.logo_url||(s==null?void 0:s.company_logo_url)||"",business_hours:w||(s==null?void 0:s.business_hours)||"",company_type:(s==null?void 0:s.company_type)||"business",tax_id:(s==null?void 0:s.tax_id)||"",footer_text:(s==null?void 0:s.footer_text)||"",show_logo:(s==null?void 0:s.show_logo)!==!1,show_address:(s==null?void 0:s.show_address)!==!1,show_phone:(s==null?void 0:s.show_phone)!==!1,show_email:(s==null?void 0:s.show_email)!==!1,show_website:(s==null?void 0:s.show_website)===!0,show_tax_id:(s==null?void 0:s.show_tax_id)===!0,show_business_hours:(s==null?void 0:s.show_business_hours)!==!1,primary_color:i||(s==null?void 0:s.primary_color)||"#000000",secondary_color:y||(s==null?void 0:s.secondary_color)||"#666666"};if(console.log("[Quotes] Datos de configuración cargados:",{profileData:f,organizationData:l,quoteSettings:s,finalData:d}),k("quote-company-name",d.company_name),k("quote-company-type",d.company_type),k("quote-company-address",d.company_address),k("quote-company-phone",d.company_phone),k("quote-company-email",d.company_email),k("quote-company-website",d.company_website),k("quote-tax-id",d.tax_id),k("quote-business-hours",d.business_hours),k("quote-logo-url",d.company_logo_url),k("quote-footer-text",d.footer_text),k("quote-show-logo",d.show_logo,!0),k("quote-show-address",d.show_address,!0),k("quote-show-phone",d.show_phone,!0),k("quote-show-email",d.show_email,!0),k("quote-show-website",d.show_website,!0),k("quote-show-tax-id",d.show_tax_id,!0),k("quote-show-hours",d.show_business_hours,!0),k("quote-primary-color",d.primary_color),k("quote-secondary-color",d.secondary_color),d.company_logo_url){const E=document.getElementById("quote-logo-preview"),h=document.getElementById("quote-logo-preview-img");E&&h&&(h.src=d.company_logo_url,E.classList.remove("hidden"))}console.log("[Quotes] Configuración aplicada correctamente")}catch(g){console.error("[Quotes] Error al cargar configuración:",g)}}async function c(){try{const o=await B();if(!o){window.showToast("Error: No se pudo obtener el ID de usuario","error");return}const m=document.getElementById("quote-company-name").value;if(!m){window.showToast("El nombre de la empresa es requerido","error");return}const{data:g,error:k}=await window.auth.sb.from("profiles").select("organization_id").eq("id",o).single();if(k&&console.error("[Quotes] Error al obtener perfil:",k),g&&g.organization_id){const l={name:m,address:document.getElementById("quote-company-address").value||null,phone:document.getElementById("quote-company-phone").value||null,company_email:document.getElementById("quote-company-email").value||null,website:document.getElementById("quote-company-website").value||null,logo_url:document.getElementById("quote-logo-url").value||null},{error:s}=await window.auth.sb.from("organizations").update(l).eq("id",g.organization_id);s?console.warn("[Quotes] Error al actualizar organización:",s):console.log("[Quotes] Datos de organización actualizados")}const f={user_id:o,company_type:document.getElementById("quote-company-type").value,tax_id:document.getElementById("quote-tax-id").value,business_hours:document.getElementById("quote-business-hours").value,footer_text:document.getElementById("quote-footer-text").value,show_logo:document.getElementById("quote-show-logo").checked,show_address:document.getElementById("quote-show-address").checked,show_phone:document.getElementById("quote-show-phone").checked,show_email:document.getElementById("quote-show-email").checked,show_website:document.getElementById("quote-show-website").checked,show_tax_id:document.getElementById("quote-show-tax-id").checked,show_business_hours:document.getElementById("quote-show-hours").checked,primary_color:document.getElementById("quote-primary-color").value,secondary_color:document.getElementById("quote-secondary-color").value},{error:u}=await window.auth.sb.from("quote_settings").upsert(f,{onConflict:"user_id"});if(u)throw u;window.showToast("Configuración guardada exitosamente","success"),ae()}catch(o){console.error("[Quotes] Error al guardar configuración:",o),window.showToast("Error al guardar configuración: "+(o.message||"Error desconocido"),"error")}}document.addEventListener("DOMContentLoaded",()=>{const o=document.getElementById("quote-discount"),m=document.getElementById("quote-tax"),g=document.getElementById("quote-prices-include-tax");o&&o.addEventListener("input",ce),m&&m.addEventListener("input",ce),g&&g.addEventListener("change",ce)})})();(function(){let z=!1,e=null,t=[];document.addEventListener("panel:activated",({detail:a})=>{a.panelId==="settings"&&(z||n())}),document.addEventListener("panel:loaded",({detail:a})=>{a.panelId==="settings"&&!z&&n()});function n(){console.log("[Settings] Inicializando panel de Configuración..."),z=!0,e=window.auth.sb,b(),_(),setTimeout(()=>{const a=document.getElementById("invite-member-btn");console.log("[Settings] Verificación post-carga - Botón invite-member-btn existe:",!!a),a?a.hasAttribute("data-invite-listener-attached")?console.log("[Settings] ✓ Listener principal ya está configurado"):(console.log("[Settings] ⚠️ Listener principal no encontrado, agregando listener de fallback..."),a.addEventListener("click",async i=>{console.log("[Settings] [LISTENER FALLBACK] Botón clickeado"),i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation(),await ce()},{capture:!0,passive:!1}),a.setAttribute("data-invite-listener-attached","true")):console.warn("[Settings] ⚠️ Botón invite-member-btn aún no existe después de 1 segundo")},1e3),setTimeout(()=>{const a=document.getElementById("invite-member-btn");a&&!a.hasAttribute("data-invite-listener-attached")&&(console.log("[Settings] [LISTENER FALLBACK 2] Configurando listener después de 2 segundos..."),a.addEventListener("click",async i=>{console.log("[Settings] [LISTENER FALLBACK 2] Botón clickeado"),i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation(),await ce()},{capture:!0,passive:!1}),a.setAttribute("data-invite-listener-attached","true"))},2e3)}async function p(){return typeof window.getUserId=="function"?await window.getUserId():(console.warn("[Settings] window.getUserId no está disponible"),null)}function b(){var pe,we,ie,O,Be,qe,L,F;(pe=document.getElementById("settings-form"))==null||pe.addEventListener("submit",B,{capture:!1}),(we=document.getElementById("settings-save-safe-btn"))==null||we.addEventListener("click",A),(ie=document.getElementById("upload-logo-btn"))==null||ie.addEventListener("click",()=>document.getElementById("logo-input").click()),(O=document.getElementById("logo-input"))==null||O.addEventListener("change",P=>oe(P.target.files[0]));const a=document.getElementById("reference-image-input");a==null||a.addEventListener("change",P=>ae(P.target.files)),(Be=document.getElementById("add-ref-image-slot"))==null||Be.addEventListener("click",()=>a.click());const i=document.getElementById("reference-images-container");i==null||i.addEventListener("click",P=>{P.target.closest(".delete-ref-image-btn")?c(P.target.closest(".delete-ref-image-btn")):P.target.closest("#add-ref-image-slot")||P.target.closest(".ref-image-item")||i.querySelectorAll(".ref-image-item").length<3&&a.click()});const y=document.getElementById("invite-member-btn"),d=document.getElementById("invite-member-form"),E=(P,j="initial")=>{if(!P)return console.warn(`[Settings] Botón #invite-member-btn no encontrado (${j})`),!1;if(P.hasAttribute("data-invite-listener-attached"))return console.log(`[Settings] Listener ya está adjunto al botón (${j}), omitiendo...`),!0;console.log(`[Settings] ✓ Configurando listener de botón de invitación (${j})`);const se=async fe=>{console.log("[Settings] ========== BOTÓN DE INVITAR CLICKEADO =========="),console.log("[Settings] Evento capturado:",{target:fe.target.id,currentTarget:fe.currentTarget.id,type:fe.type,bubbles:fe.bubbles}),fe.preventDefault(),fe.stopPropagation(),fe.stopImmediatePropagation();const ge=document.getElementById("invite-member-form");if(ge){const ye=ge.closest("form");if(ye&&ye!==ge){console.warn("[Settings] Formulario de invitación está dentro de otro formulario. Previniendo submit del padre.");const Ce=new Event("submit",{bubbles:!1,cancelable:!0});ye.dispatchEvent(Ce),Ce.defaultPrevented&&console.log("[Settings] Submit del formulario padre prevenido")}}await ce()};return P.addEventListener("click",se,{capture:!0,passive:!1}),P.setAttribute("data-invite-listener-attached","true"),console.log(`[Settings] ✓ Listener adjunto exitosamente (${j})`),!0};if(E(y,"initial")||(setTimeout(()=>{const P=document.getElementById("invite-member-btn");E(P,"delayed-500ms")},500),setTimeout(()=>{const P=document.getElementById("invite-member-btn");E(P,"delayed-2s")},2e3)),d){d.addEventListener("submit",j=>{console.log("[Settings] ⚠️ Formulario de invitar SUBMITTED (prevenido)"),j.preventDefault(),j.stopPropagation(),j.stopImmediatePropagation()},{capture:!0,passive:!1});const P=document.getElementById("invite-email");P&&P.addEventListener("keydown",j=>{j.key==="Enter"&&(console.log("[Settings] Enter presionado en input de email"),j.preventDefault(),j.stopPropagation(),j.stopImmediatePropagation(),ce())},{capture:!0})}else console.warn("[Settings] Formulario #invite-member-form no encontrado al configurar listeners.");(qe=document.getElementById("team-members-list"))==null||qe.addEventListener("change",P=>{P.target.classList.contains("permission-toggle")?Y(P.target):P.target.classList.contains("label-filter-select")&&Ie(P.target)});const h=document.getElementById("appointments-enabled"),x=document.getElementById("appointments-enabled-general"),S=document.getElementById("appointments-config");console.log("[Settings] Inicializando listeners de citas:"),console.log("[Settings] - appointments-enabled encontrado:",!!h),console.log("[Settings] - appointments-enabled-general encontrado:",!!x),console.log("[Settings] - appointments-config encontrado:",!!S);const $=(P,j)=>{P&&j&&P.checked!==j.checked&&(j.checked=P.checked)};h==null||h.addEventListener("change",async P=>{console.log("[Settings] Toggle de citas cambiado:",P.target.checked);const j=document.getElementById("appointments-config");if(console.log("[Settings] Elemento appointments-config encontrado:",!!j),j?P.target.checked?(j.classList.remove("hidden"),j.style.display="",console.log("[Settings] Sección de configuración mostrada. Clases:",j.className)):(j.classList.add("hidden"),console.log("[Settings] Sección de configuración ocultada")):console.error("[Settings] ERROR: No se encontró el elemento appointments-config"),$(P.target,x),G(P.target.checked),P.target.checked){const se=await p();se&&(await k(se),await f(se))}}),x==null||x.addEventListener("change",async P=>{console.log("[Settings] Toggle general de citas cambiado:",P.target.checked),$(P.target,h);const j=document.getElementById("appointments-config");if(console.log("[Settings] Elemento appointments-config encontrado:",!!j),j?P.target.checked?(j.classList.remove("hidden"),j.style.display="",console.log("[Settings] Sección de configuración mostrada. Clases:",j.className)):(j.classList.add("hidden"),console.log("[Settings] Sección de configuración ocultada")):console.error("[Settings] ERROR: No se encontró el elemento appointments-config"),G(P.target.checked),P.target.checked){const se=await p();se&&(await k(se),await f(se))}});function G(P){const j=document.getElementById("appointments-menu-item");if(j)if(P)j.classList.remove("hidden");else{j.classList.add("hidden");const se=document.querySelector(".content-panel.active");if(se&&se.id==="appointments"){const fe=document.querySelector('[data-target="dashboard"]');fe&&fe.click()}}}window.updateAppointmentsMenuVisibility=G;const Z=document.getElementById("reminders-enabled");Z==null||Z.addEventListener("change",P=>{const j=document.getElementById("reminders-config");j&&j.classList.toggle("hidden",!P.target.checked)});const V=document.getElementById("reminder-days-enabled");V==null||V.addEventListener("change",P=>{const j=document.getElementById("reminder-days-config");j&&j.classList.toggle("hidden",!P.target.checked)}),(L=document.getElementById("add-appointment-type-btn"))==null||L.addEventListener("click",()=>{s()}),(F=document.getElementById("appointment-types-container"))==null||F.addEventListener("click",P=>{P.target.classList.contains("delete-appointment-type-btn")&&r(P.target.closest(".appointment-type-item"))})}async function _(){var a,i,y,d;try{const E=await p();if(!E)throw new Error("No se pudo determinar el usuario para cargar la configuracion.");let{data:h,error:x}=await e.from("profiles").select("work_start_hour, work_end_hour, company_description, website, social_media, branding_settings, contact_phone, business_address, business_phone, pickup_location, has_shipping_system, organization_id, quotes_enabled").eq("id",E).single();if(x&&(x.code==="42703"||x.code==="PGRST204")){console.warn("[Settings] quotes_enabled no existe en la base de datos, usando valor por defecto (false)");const{data:pe,error:we}=await e.from("profiles").select("work_start_hour, work_end_hour, company_description, website, social_media, branding_settings, contact_phone, business_address, business_phone, pickup_location, has_shipping_system, organization_id").eq("id",E).single();if(we&&we.code!=="PGRST116")throw we;h=pe,x=null}else if(x&&x.code!=="PGRST116")throw x;if(!h)return;const S=h.quotes_enabled||!1;if(h.organization_id){const{data:pe,error:we}=await e.from("organizations").select("name").eq("id",h.organization_id).single();if(!we&&pe&&pe.name){const ie=document.getElementById("company-name");ie&&(ie.value=pe.name)}}h.work_start_hour&&(document.getElementById("work-start-hour").value=`${String(h.work_start_hour).padStart(2,"0")}:00`),h.work_end_hour&&(document.getElementById("work-end-hour").value=`${String(h.work_end_hour).padStart(2,"0")}:00`),h.company_description&&(document.getElementById("company-description").value=h.company_description),h.website&&(document.getElementById("website").value=h.website);const $=document.getElementById("quotes-enabled");$&&($.checked=S),h.social_media&&(document.getElementById("social-instagram").value=h.social_media.instagram||"",document.getElementById("social-facebook").value=h.social_media.facebook||"");const G=document.getElementById("admin-phone-input");G&&h.contact_phone&&(G.value=h.contact_phone),h.business_address&&(document.getElementById("business-address").value=h.business_address),h.business_phone&&(document.getElementById("business-phone").value=h.business_phone),h.pickup_location&&(document.getElementById("pickup-location").value=h.pickup_location);const Z=document.getElementById("has-shipping-system");Z&&(Z.checked=h.has_shipping_system||!1),(a=h.branding_settings)!=null&&a.logo_url&&(document.getElementById("logo-preview").src=h.branding_settings.logo_url),(i=h.branding_settings)!=null&&i.colors&&h.branding_settings.colors.forEach((pe,we)=>document.getElementById(`brand-color-${we+1}`).value=pe),(y=h.branding_settings)!=null&&y.reference_images&&D(h.branding_settings.reference_images);const V=(d=window.appInstance)==null?void 0:d.teamInfo;await U(V),await g(E)}catch(E){console.error("Error al cargar la configuración de la empresa:",E)}}async function B(a){const i=document.getElementById("invite-member-form");if(i&&(a.target===i||i.contains(a.target))){console.log("[Settings] Submit del formulario de invitación ignorado en handleSettingsSave");return}const y=a.submitter||a.target&&a.target.closest("button");if(y&&y.id==="invite-member-btn"){console.log("[Settings] Click en botón de invitar ignorado en handleSettingsSave");return}a.preventDefault();const d=a.target,E=d.querySelector("button[data-settings-primary]")||d.querySelector('button[type="submit"]');await N(E)}async function A(a){a.preventDefault();const i=a.currentTarget;console.log('[Settings] Boton "Guardar Seguro" presionado.'),await N(i,{toastMessage:"Guardando configuracion (modo seguro)..."})}async function N(a,i={}){var S,$,G,Z,V,pe,we,ie,O,Be;const y=document.getElementById("settings-form");if(!y){console.warn("[Settings] No se encontro el formulario de configuracion.");return}const d=a||y.querySelector('button[type="submit"]');if(!d){console.warn("[Settings] No se encontro el boton de guardado.");return}const{loadingLabel:E="Guardando...",restoreLabel:h=d.dataset.originalLabel||d.textContent||"Guardar Configuracion",toastMessage:x="Guardando configuracion..."}=i;window.showToast(x,"info",2e3),d.dataset.originalLabel=h,d.disabled=!0,d.textContent=E;try{console.log("[Settings] Iniciando guardado...");const qe=document.getElementById("logo-input"),L=document.getElementById("logo-preview"),F=(S=qe==null?void 0:qe.files)==null?void 0:S[0];let P=($=L==null?void 0:L.src)!=null&&$.startsWith("https")?L.src:null;if(F){if(!window.appInstance)throw new Error("La instancia de la aplicacion no esta lista.");P=await window.appInstance.uploadAsset(F,"logos")}console.log("[Settings] URL del logo:",P);const j=document.querySelector("#reference-images-container"),se=j?Array.from(j.querySelectorAll(".ref-image-item img")).map(Ye=>Ye.src.split("?")[0]):[],fe=document.getElementById("reference-image-input"),ge=(fe==null?void 0:fe.files)||[],ye=Array.from(ge).map(Ye=>window.appInstance.uploadAsset(Ye,"reference_images")),Ce=await Promise.all(ye),Ue=[...se,...Ce.filter(Boolean)];console.log("[Settings] URLs de referencia:",Ue);const je=document.getElementById("brand-font"),Ae={logo_url:P,colors:Array.from({length:4},(Ye,ct)=>{const Xe=document.getElementById(`brand-color-${ct+1}`);return(Xe==null?void 0:Xe.value)||"#000000"}),font:(je==null?void 0:je.value)||"Arial",reference_images:Ue.slice(0,3)};console.log("[Settings] Datos de branding:",Ae);const Oe=document.getElementById("work-start-hour"),C=document.getElementById("work-end-hour"),T=document.getElementById("company-description"),R=document.getElementById("website"),K=document.getElementById("social-instagram"),ee=document.getElementById("social-facebook"),de=document.getElementById("admin-phone-input"),Le=document.getElementById("business-address"),Te=document.getElementById("business-phone"),De=document.getElementById("pickup-location"),xe=document.getElementById("has-shipping-system"),Me=(Oe==null?void 0:Oe.value)||"",ze=(C==null?void 0:C.value)||"",He=((G=de==null?void 0:de.value)==null?void 0:G.trim())||null,Fe=await p();if(!Fe)throw console.error("[Settings] Error: no se pudo determinar el usuario objetivo."),new Error("No se pudo determinar el usuario objetivo para guardar la configuracion.");const{data:We,error:Ze}=await e.from("profiles").select("organization_id").eq("id",Fe).single();Ze&&console.error("[Settings] Error al obtener perfil:",Ze),console.log("[Settings] Perfil obtenido:",{hasProfile:!!We,organizationId:We==null?void 0:We.organization_id});const ot=document.getElementById("company-name"),dt=(Z=ot==null?void 0:ot.value)==null?void 0:Z.trim();if(ot&&dt)try{let Ye=We==null?void 0:We.organization_id;if(Ye){const{error:ct}=await e.from("organizations").update({name:dt}).eq("id",Ye);if(ct)throw console.error("[Settings] Error al actualizar nombre de empresa:",ct),ct.code!=="PGRST204"&&ct.code!=="42501"&&((V=window.showToast)==null||V.call(window,"Error al guardar el nombre de empresa. Verifica tus permisos.","error")),ct;console.log("[Settings] ✓ Nombre de empresa actualizado exitosamente en organizations")}else{console.log("[Settings] No hay organization_id, creando nueva organización usando RPC...");const{data:ct,error:Xe}=await e.rpc("create_user_organization",{p_organization_name:dt});if(Xe)throw console.error("[Settings] Error al crear organización:",Xe),new Error("No se pudo crear la organización: "+(Xe.message||"Error desconocido"));Ye=ct,console.log("[Settings] ✓ Organización creada y vinculada:",Ye)}}catch(Ye){console.error("[Settings] Excepción al guardar nombre de empresa:",Ye),(pe=window.showToast)==null||pe.call(window,"Error al guardar el nombre de empresa. Los demás datos se guardaron correctamente.","warning")}else ot&&!dt&&console.warn("[Settings] El campo nombre de empresa está vacío, no se guarda");const gt=document.getElementById("quotes-enabled"),lt=gt?gt.checked:!1,pt={work_start_hour:Me?parseInt(Me.split(":")[0],10):null,work_end_hour:ze?parseInt(ze.split(":")[0],10):null,company_description:(T==null?void 0:T.value)||"",website:(R==null?void 0:R.value)||"",social_media:{instagram:(K==null?void 0:K.value)||"",facebook:(ee==null?void 0:ee.value)||""},branding_settings:Ae,contact_phone:He,business_address:((we=Le==null?void 0:Le.value)==null?void 0:we.trim())||null,business_phone:((ie=Te==null?void 0:Te.value)==null?void 0:ie.trim())||null,pickup_location:((O=De==null?void 0:De.value)==null?void 0:O.trim())||null,has_shipping_system:(xe==null?void 0:xe.checked)||!1};let wt={...pt,quotes_enabled:lt},{error:ht}=await e.from("profiles").update(wt).eq("id",Fe);const Ke=ht&&(ht.code==="42703"||ht.code==="PGRST204");if(Ke&&(console.warn("[Settings] quotes_enabled no existe en la base de datos, guardando sin esa columna"),{error:ht}=await e.from("profiles").update(pt).eq("id",Fe)),console.log("[Settings] Datos a guardar:",Ke?pt:wt),ht)throw console.error("[Settings] Error de Supabase al guardar:",ht),new Error(ht.message);const ut=(Be=window.appInstance)==null?void 0:Be.teamInfo;if(ut&&ut.user_role==="admin"&&ut.team_id){const Ye=document.getElementById("see-all-chats-toggle"),ct=document.getElementById("ignore-labels-input"),Xe=(Ye==null?void 0:Ye.checked)??!1,v=((ct==null?void 0:ct.value)||"").split(",").map(I=>I.trim()).filter(I=>I);try{const{error:I}=await e.from("teams").update({allow_all_chats_visibility:Xe,ignored_labels:v}).eq("id",ut.team_id)}catch{}}try{await w(Fe)}catch(Ye){console.error("[Settings] Error al guardar configuración de citas:",Ye)}console.log("[Settings] Guardado con exito."),window.showToast("Configuracion guardada con exito.","success")}catch(qe){console.error("Error al guardar la configuracion:",qe),window.showToast("No se pudo guardar la configuracion.","error")}finally{d.disabled=!1,d.textContent=h}}async function H(a){var E,h,x,S,$;const i=(a==null?void 0:a.owner_id)||((E=a==null?void 0:a.profiles)==null?void 0:E.id)||((x=(h=window.appInstance)==null?void 0:h.user)==null?void 0:x.id)||(($=(S=window.auth.getSession())==null?void 0:S.user)==null?void 0:$.id);if(!i){t=[];return}const{data:y,error:d}=await window.auth.sb.from("labels").select("name").eq("user_id",i).order("name",{ascending:!0});if(d){console.error("[Settings] Error al cargar etiquetas del equipo:",d),t=[];return}t=(y||[]).map(G=>G.name).filter(Boolean)}async function U(a){var V,pe,we,ie;const i=document.getElementById("team-management-panel");if(!i)return;let y=!1;if((a==null?void 0:a.user_role)==="admin"){const O=await((V=window.appInstance)==null?void 0:V.loadUserSubscription());(we=(pe=O==null?void 0:O.plans)==null?void 0:pe.features)!=null&&we.multi_user&&(y=!0)}if(!y){i.classList.add("hidden");return}i.classList.remove("hidden"),await H(a);const d=document.getElementById("team-members-list");if(!d)return;const{data:E,error:h}=await window.auth.sb.from("team_members").select("user_id, role, permissions").eq("team_id",a.team_id);h&&console.error("Error al cargar miembros del equipo:",h),console.log("[Settings] 🔍 Cargando invitaciones para el equipo:",a.team_id);const{data:x,error:S}=await window.auth.sb.from("team_invitations").select("id, email, role, status, created_at, expires_at").eq("team_id",a.team_id).in("status",["pending","sent","failed"]).order("created_at",{ascending:!1});if(S?(console.error("[Settings] ❌ Error al cargar invitaciones:",S),console.error("[Settings] Código de error:",S.code),console.error("[Settings] Mensaje:",S.message),console.error("[Settings] Detalles completos:",JSON.stringify(S,null,2)),(S.code==="42501"||(ie=S.message)!=null&&ie.includes("permission denied"))&&console.warn("[Settings] ⚠️ Error de permisos al cargar invitaciones. Verifica las políticas RLS.")):(console.log("[Settings] ✅ Invitaciones cargadas exitosamente:",(x==null?void 0:x.length)||0),x&&x.length>0&&console.log("[Settings] 📋 Lista de invitaciones:",x.map(O=>({email:O.email,status:O.status,role:O.role})))),(!E||E.length===0)&&(!x||x.length===0)){d.innerHTML='<p class="text-slate-500 text-sm">Aún no has invitado vendedores.</p>';return}let $={};if(E&&E.length>0){const O=E.map(L=>L.user_id),{data:Be,error:qe}=await window.auth.sb.from("profiles").select("id, full_name, email").in("id",O);!qe&&Be&&Be.forEach(L=>{$[L.id]=L})}const G=(E||[]).map(O=>{var L,F;const Be=$[O.user_id]||{},qe=O.user_id===((F=(L=window.appInstance)==null?void 0:L.user)==null?void 0:F.id);return`
                <div class="bg-white p-4 rounded-lg border">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <p class="font-semibold">${Be.full_name||Be.email||"Usuario sin nombre"}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs font-medium px-2 py-0.5 rounded-full ${O.role==="admin"?"bg-purple-100 text-purple-700":"bg-blue-100 text-blue-700"}">${O.role}</span>
                                <span class="text-xs text-green-600">✓ Conectado</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            ${O.role==="advisor"?`
                                <button class="text-xs text-slate-600 hover:text-slate-800 hover:underline font-medium" onclick="this.nextElementSibling.classList.toggle('hidden')">Permisos</button>
                            `:""}
                            ${qe?"":`
                                <button 
                                    class="delete-member-btn text-xs bg-red-600 text-white px-3 py-1.5 rounded-lg hover:bg-red-700 font-medium whitespace-nowrap" 
                                    data-user-id="${O.user_id}"
                                    data-user-name="${Be.full_name||Be.email||"Usuario"}"
                                    title="Eliminar usuario del equipo y del sistema"
                                >
                                    Eliminar
                                </button>
                            `}
                        </div>
                    </div>
                    ${O.role==="advisor"?`
                        <div class="hidden mt-4 pt-4 border-t border-slate-100 space-y-4">
                            <div>
                                <h5 class="text-sm font-semibold text-slate-600">Acceso a Paneles:</h5>
                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2">
                                    ${re(O,"follow-ups","Seguimientos")}
                                    ${re(O,"bulk-sending","Envío Masivo")}
                                    ${re(O,"contacts","Contactos")}
                                    ${re(O,"templates","Plantillas")}
                                    ${re(O,"products","Productos")}
                                    ${re(O,"designer-ai","Diseñador IA")}
                                </div>
                            </div>
                            ${ne(O)}
                        </div>
                    `:""}
                </div>
            `}).join(""),Z=(x||[]).map(O=>{const Be=O.status==="sent"?"bg-yellow-100 text-yellow-700":O.status==="failed"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-700",qe=O.status==="sent"?"Enviado":O.status==="failed"?"Fallido":"Pendiente",L=new Date(O.expires_at),F=L<new Date;return`
                <div class="bg-slate-50 p-4 rounded-lg border border-dashed">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <p class="font-semibold">${O.email}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs font-medium px-2 py-0.5 rounded-full ${O.role==="admin"?"bg-purple-100 text-purple-700":"bg-blue-100 text-blue-700"}">${O.role}</span>
                                <span class="text-xs font-medium px-2 py-0.5 rounded-full ${Be}">${qe}</span>
                                ${F?'<span class="text-xs text-red-600">Expirado</span>':""}
                            </div>
                            <p class="text-xs text-slate-500 mt-2">
                                Invitado el ${new Date(O.created_at).toLocaleDateString("es-MX")}
                                ${F?"":`• Expira el ${L.toLocaleDateString("es-MX")}`}
                            </p>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <button 
                                class="resend-invitation-btn text-xs bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 font-medium whitespace-nowrap" 
                                data-invitation-id="${O.id}"
                                data-invitation-email="${O.email}"
                                data-invitation-role="${O.role}"
                                title="Reenviar invitación por correo"
                            >
                                Reenviar
                            </button>
                            <button 
                                class="delete-invitation-btn text-xs bg-red-600 text-white px-3 py-1.5 rounded-lg hover:bg-red-700 font-medium whitespace-nowrap" 
                                data-invitation-id="${O.id}"
                                data-invitation-email="${O.email}"
                                title="Eliminar esta invitación"
                            >
                                Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `}).join("");d.innerHTML=G+Z,d.querySelectorAll(".delete-member-btn").forEach(O=>{O.addEventListener("click",async Be=>{const qe=O.getAttribute("data-user-id"),L=O.getAttribute("data-user-name");await X(qe,L,a.team_id)})}),d.querySelectorAll(".resend-invitation-btn").forEach(O=>{O.addEventListener("click",async Be=>{O.getAttribute("data-invitation-id");const qe=O.getAttribute("data-invitation-email"),L=O.getAttribute("data-invitation-role");await Ee(qe,L,a.team_id)})}),d.querySelectorAll(".delete-invitation-btn").forEach(O=>{O.addEventListener("click",async Be=>{const qe=O.getAttribute("data-invitation-id"),L=O.getAttribute("data-invitation-email");await me(qe,L,a.team_id)})}),y&&(a==null?void 0:a.user_role)==="admin"&&setTimeout(async()=>{await W()},100)}async function X(a,i,y){var h,x,S,$,G;const d=`¿Estás seguro de que deseas eliminar a ${i}?

Esta acción:
- Eliminará al usuario del equipo
- Eliminará su cuenta del sistema de autenticación
- Eliminará su perfil y datos

Esta acción NO se puede deshacer.`;if(await((x=(h=window.appModal)==null?void 0:h.confirm)==null?void 0:x.call(h,d,"Eliminar Usuario")))try{console.log("[Settings] 🗑️ Eliminando miembro del equipo:",{userId:a,userName:i,teamId:y});const Z=await window.auth.invokeFunction("delete-team-member",{body:{userId:a,teamId:y}}),{data:V,error:pe}=Z||{};if(pe)throw console.error("[Settings] ❌ Error al eliminar miembro:",pe),new Error(pe.message||"No se pudo eliminar el usuario");console.log("[Settings] ✅ Usuario eliminado exitosamente"),(S=window.showToast)==null||S.call(window,`Usuario ${i} eliminado exitosamente del equipo y del sistema.`,"success");const we=($=window.appInstance)==null?void 0:$.teamInfo;we&&await U(we)}catch(Z){console.error("[Settings] ❌ Error al eliminar miembro:",Z);const V=Z.message||"No se pudo eliminar el usuario. Intenta de nuevo.";(G=window.showToast)==null||G.call(window,V,"error")}}async function Ee(a,i,y){var d,E,h;try{console.log("[Settings] 📧 Reenviando invitación a:",a),document.querySelectorAll(`.resend-invitation-btn[data-invitation-email="${a}"]`).forEach(V=>{V.disabled=!0,V.textContent="Enviando..."});const S=await window.auth.invokeFunction("invite-team-member",{body:{teamId:y,inviteeEmail:a,role:i||"advisor"}}),{data:$,error:G}=S||{};if(G)throw console.error("[Settings] ❌ Error al reenviar invitación:",G),new Error(G.message||"No se pudo reenviar la invitación");console.log("[Settings] ✅ Invitación reenviada exitosamente"),(d=window.showToast)==null||d.call(window,`Invitación reenviada exitosamente a ${a}.`,"success");const Z=(E=window.appInstance)==null?void 0:E.teamInfo;Z&&await U(Z)}catch(x){console.error("[Settings] ❌ Error al reenviar invitación:",x);const S=x.message||"No se pudo reenviar la invitación. Intenta de nuevo.";(h=window.showToast)==null||h.call(window,S,"error"),document.querySelectorAll(`.resend-invitation-btn[data-invitation-email="${a}"]`).forEach(G=>{G.disabled=!1,G.textContent="Reenviar"})}}async function me(a,i,y){var h,x,S,$,G;const d=`¿Estás seguro de que deseas eliminar la invitación para ${i}?

Esta acción eliminará la invitación pendiente. El usuario no podrá usar el enlace anterior.`;if(await((x=(h=window.appModal)==null?void 0:h.confirm)==null?void 0:x.call(h,d,"Eliminar Invitación")))try{console.log("[Settings] 🗑️ Eliminando invitación:",{invitationId:a,invitationEmail:i,teamId:y});const{error:Z}=await window.auth.sb.from("team_invitations").delete().eq("id",a).eq("team_id",y);if(Z)throw console.error("[Settings] ❌ Error al eliminar invitación:",Z),new Error(Z.message||"No se pudo eliminar la invitación");console.log("[Settings] ✅ Invitación eliminada exitosamente"),(S=window.showToast)==null||S.call(window,`Invitación para ${i} eliminada exitosamente.`,"success");const V=($=window.appInstance)==null?void 0:$.teamInfo;V&&await U(V)}catch(Z){console.error("[Settings] ❌ Error al eliminar invitación:",Z);const V=Z.message||"No se pudo eliminar la invitación. Intenta de nuevo.";(G=window.showToast)==null||G.call(window,V,"error")}}async function W(a){var $,G;const{data:i}=await window.auth.sb.from("profiles").select("organization_id").eq("id",(G=($=window.appInstance)==null?void 0:$.user)==null?void 0:G.id).single();if(!(i!=null&&i.organization_id)){console.warn("[Settings] No se encontró organization_id para el usuario actual");return}const{data:y,error:d}=await window.auth.sb.from("organization_permissions").select("*").eq("organization_id",i.organization_id).eq("role","advisor");if(d){console.error("[Settings] Error al cargar permisos:",d);return}const E={};(y||[]).forEach(Z=>{E[Z.resource]={can_view:Z.can_view,can_modify:Z.can_modify}});const x=`
            <div class="mt-8 bg-white p-6 rounded-lg border">
                <h4 class="font-semibold mb-2 text-lg">Permisos Granulares para Asesores</h4>
                <p class="text-sm text-slate-600 mb-6">Define qué pueden ver y modificar los asesores en tu organización. Los cambios se aplican a todos los asesores.</p>
                
                <div class="space-y-6">
                    ${[{id:"qr_number",name:"Número QR",description:"Número de WhatsApp vinculado a la organización"},{id:"ai_prompt",name:"Prompt de IA",description:"Configuración del prompt principal de la IA"},{id:"images",name:"Imágenes de Referencia",description:"Imágenes de referencia para generación de IA"},{id:"branding",name:"Branding",description:"Logo, colores y tipografía de la organización"},{id:"settings",name:"Configuración General",description:"Configuración de horarios, descripción, etc."},{id:"contacts",name:"Contactos",description:"Ver y gestionar contactos"},{id:"chats",name:"Chats",description:"Ver y responder chats"},{id:"products",name:"Productos",description:"Ver y gestionar productos"},{id:"templates",name:"Plantillas",description:"Ver y crear plantillas de mensajes"},{id:"follow-ups",name:"Seguimientos",description:"Ver y gestionar seguimientos automáticos"},{id:"kanban",name:"Kanban",description:"Ver y gestionar tablero Kanban"},{id:"designer-ai",name:"Diseñador IA",description:"Generar imágenes con IA"}].map(Z=>{const V=E[Z.id]||{can_view:!1,can_modify:!1};return`
                            <div class="border border-slate-200 rounded-lg p-4">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex-1">
                                        <h5 class="font-semibold text-slate-800">${Z.name}</h5>
                                        <p class="text-xs text-slate-500 mt-1">${Z.description}</p>
                                    </div>
                                </div>
                                <div class="flex gap-6 mt-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            class="org-permission-toggle form-checkbox h-5 w-5 rounded text-blue-600" 
                                            data-resource="${Z.id}" 
                                            data-action="view"
                                            ${V.can_view?"checked":""}
                                        >
                                        <span class="text-sm font-medium text-slate-700">Puede Ver</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            class="org-permission-toggle form-checkbox h-5 w-5 rounded text-blue-600" 
                                            data-resource="${Z.id}" 
                                            data-action="modify"
                                            ${V.can_modify?"checked":""}
                                            ${V.can_view?"":"disabled"}
                                        >
                                        <span class="text-sm font-medium text-slate-700">Puede Modificar</span>
                                    </label>
                                </div>
                            </div>
                        `}).join("")}
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button 
                        id="save-org-permissions-btn" 
                        class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700"
                    >
                        Guardar Permisos
                    </button>
                </div>
            </div>
        `;let S=document.getElementById("organization-permissions-container");if(!S){const Z=document.getElementById("team-management-panel");if(Z)S=document.createElement("div"),S.id="organization-permissions-container",Z.appendChild(S);else{console.warn("[Settings] No se encontró el panel de gestión de equipo");return}}S.innerHTML=x,ue(i.organization_id)}function ue(a){document.querySelectorAll(".org-permission-toggle").forEach(y=>{y.addEventListener("change",d=>{const E=d.target.dataset.resource,h=d.target.dataset.action;if(h==="view"&&!d.target.checked){const x=document.querySelector(`.org-permission-toggle[data-resource="${E}"][data-action="modify"]`);x&&(x.checked=!1,x.disabled=!0)}if(h==="view"&&d.target.checked){const x=document.querySelector(`.org-permission-toggle[data-resource="${E}"][data-action="modify"]`);x&&(x.disabled=!1)}})});const i=document.getElementById("save-org-permissions-btn");i&&i.addEventListener("click",async()=>{await te(a)})}async function te(a){var d,E,h;const i=document.getElementById("save-org-permissions-btn");if(!i)return;const y=i.textContent;i.disabled=!0,i.textContent="Guardando...";try{const x=[];document.querySelectorAll(".org-permission-toggle").forEach($=>{const G=$.dataset.resource,Z=$.dataset.action,V=$.checked;let pe=x.find(we=>we.resource===G);pe||(pe={organization_id:a,role:"advisor",resource:G,can_view:!1,can_modify:!1},x.push(pe)),Z==="view"?pe.can_view=V:Z==="modify"&&(pe.can_modify=V)});for(const $ of x){const{error:G}=await window.auth.sb.from("organization_permissions").upsert({organization_id:$.organization_id,role:$.role,resource:$.resource,can_view:$.can_view,can_modify:$.can_modify},{onConflict:"organization_id,role,resource"});if(G)throw console.error("[Settings] Error al guardar permiso:",G),G}(d=window.showToast)==null||d.call(window,"Permisos guardados exitosamente","success");const S=(E=window.appInstance)==null?void 0:E.teamInfo;S&&await U(S)}catch(x){console.error("[Settings] Error al guardar permisos:",x),(h=window.showToast)==null||h.call(window,"Error al guardar permisos. Intenta de nuevo.","error")}finally{i.disabled=!1,i.textContent=y}}function re(a,i,y){var E;const d=((E=a.permissions)==null?void 0:E[i])||!1;return`
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" class="permission-toggle form-checkbox h-4 w-4 rounded text-blue-600" data-member-id="${a.user_id}" data-panel-id="${i}" ${d?"checked":""}>
                <span class="text-sm text-slate-700">${y}</span>
            </label>
        `}function ne(a){var E;const i=((E=a.permissions)==null?void 0:E.label_filters)||{},y=Array.isArray(i.contacts)?i.contacts:[],d=Array.isArray(i.chats)?i.chats:[];return`
            <div class="space-y-2">
                <h5 class="text-sm font-semibold text-slate-600">Etiquetas permitidas</h5>
                <p class="text-xs text-slate-500">Solo verá contactos y chats que tengan las etiquetas seleccionadas.</p>
                <div class="grid gap-3 md:grid-cols-2">
                    ${be(a,"contacts","Contactos y Kanban",y)}
                    ${be(a,"chats","Chats",d)}
                </div>
            </div>
        `}function be(a,i,y,d){const E=new Set([...t||[],...d||[]]);if(!E.size)return`
                <div class="text-sm text-slate-500 border border-dashed border-slate-200 rounded-lg p-3">
                    Crea etiquetas desde el panel de Contactos para asignarlas a tus vendedores.
                </div>
            `;const h=Array.from(E).filter(Boolean).sort((x,S)=>x.localeCompare(S,"es",{sensitivity:"base"})).map(x=>`<option value="${x}" ${d!=null&&d.includes(x)?"selected":""}>${x}</option>`).join("");return`
            <label class="flex flex-col gap-1 text-sm text-slate-600">
                <span>${y}</span>
                <select multiple size="4" class="label-filter-select border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" data-member-id="${a.user_id}" data-scope="${i}">
                    ${h}
                </select>
            </label>
        `}async function ce(){var $,G,Z,V,pe,we,ie,O,Be,qe,L,F,P,j,se,fe;console.log("[Settings] ========== handleInviteMember INICIADO ==========");const a=performance.now(),i=document.getElementById("invite-email"),y=document.getElementById("invite-member-btn");if(console.log("[Settings] 🔍 Buscando elementos de invitación:",{emailInput:!!i,button:!!y,emailInputId:i==null?void 0:i.id,buttonId:y==null?void 0:y.id}),!i||!y){console.error("[Settings] ❌ No se encontraron los elementos necesarios:",{emailInput:!!i,button:!!y}),($=window.showToast)==null||$.call(window,"Error: No se pudo encontrar el campo de correo o el botón de invitación. Recarga la página.","error");return}console.log("[Settings] ✅ Elementos encontrados correctamente");const d=i.value.trim();if(console.log("[Settings] 📧 Email ingresado:",d),!d){console.warn("[Settings] ⚠️ Email vacío"),(G=window.showToast)==null||G.call(window,"Por favor ingresa un correo electrónico","error"),i.focus();return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(d)){console.warn("[Settings] ⚠️ Email con formato inválido:",d),(Z=window.showToast)==null||Z.call(window,"Por favor ingresa un correo electrónico válido","error"),i.focus();return}const h=(V=window.appInstance)==null?void 0:V.teamInfo;if(console.log("[Settings] 👥 teamInfo:",h),!h){console.error("[Settings] ❌ teamInfo no disponible en appInstance"),(pe=window.showToast)==null||pe.call(window,"Error: No se pudo obtener la información del equipo. Recarga la página.","error");return}if((h==null?void 0:h.user_role)!=="admin"){console.error("[Settings] ❌ Usuario no es admin. Rol actual:",h==null?void 0:h.user_role),(we=window.showToast)==null||we.call(window,"Solo los administradores pueden invitar miembros.","error");return}console.log("[Settings] 🔍 Verificando plan del usuario...");let x;try{x=await((ie=window.appInstance)==null?void 0:ie.loadUserSubscription()),console.log("[Settings] 📦 Plan del usuario:",x)}catch(ge){console.error("[Settings] ❌ Error al verificar plan:",ge),(O=window.showToast)==null||O.call(window,"Error al verificar tu plan. Intenta de nuevo.","error");return}if(!((qe=(Be=x==null?void 0:x.plans)==null?void 0:Be.features)!=null&&qe.multi_user)){console.error("[Settings] ❌ Plan no incluye multi_user. Plan:",x),(L=window.showToast)==null||L.call(window,"Tu plan no incluye la función de múltiples usuarios.","error");return}if(!(h!=null&&h.team_id)){console.error("[Settings] ❌ team_id no disponible. teamInfo:",h),(F=window.showToast)==null||F.call(window,"Error: No se pudo obtener el ID del equipo. Recarga la página.","error");return}console.log("[Settings] ✅ Validaciones pasadas. Invitando a:",d,"al equipo:",h.team_id);const S=y.textContent;y.disabled=!0,y.textContent="Enviando...",y.style.opacity="0.6",y.style.cursor="not-allowed";try{if(console.log("[Settings] ===== INICIANDO LLAMADA A EDGE FUNCTION ====="),console.log("[Settings] 🔧 Verificando disponibilidad de invokeFunction..."),console.log("[Settings]   - window.auth existe:",!!window.auth),console.log("[Settings]   - window.auth.invokeFunction existe:",!!((P=window.auth)!=null&&P.invokeFunction)),!window.auth)throw new Error("window.auth no está disponible. Verifica que auth.js esté cargado antes que settings.js.");if(!window.auth.invokeFunction)throw new Error("window.auth.invokeFunction no está disponible. Verifica que auth.js esté cargado correctamente.");const ge={teamId:h.team_id,inviteeEmail:d,role:"advisor"};console.log("[Settings] 📤 Datos a enviar a edge function:",ge),console.log("[Settings] 📡 URL de edge function:",`${window.location.origin.includes("localhost")?"http://localhost:54321":"https://mytvwfbijlgbihlegmfg.supabase.co"}/functions/v1/invite-team-member`);const ye=performance.now(),Ce=await window.auth.invokeFunction("invite-team-member",{body:ge}),Ue=performance.now();console.log("[Settings] ⏱️ Tiempo de respuesta de edge function:",(Ue-ye).toFixed(2),"ms"),console.log("[Settings] 📥 Respuesta completa de invokeFunction:",Ce);const{data:je,error:Ae}=Ce||{};if(console.log("[Settings] 📊 Data extraída:",je),console.log("[Settings] ⚠️ Error extraído:",Ae),Ae){console.error("[Settings] ❌ Error en la respuesta de la edge function:",Ae),console.error("[Settings] Detalles del error:",JSON.stringify(Ae,null,2));let T="No se pudo enviar la invitación.";throw Ae.message?T=Ae.message:typeof Ae=="string"&&(T=Ae),Ae.details&&typeof Ae.details=="string"&&Ae.details.includes("correo")&&(T+=" "+Ae.details),new Error(T)}if(!je)throw new Error("La edge function no retornó datos. Verifica los logs de la función.");console.log("[Settings] ✅ Invitación procesada exitosamente"),console.log("[Settings] 📋 Datos de respuesta:",JSON.stringify(je,null,2));const Oe=je.message||`Invitación enviada a ${d}.`;(j=window.showToast)==null||j.call(window,Oe,"success"),i.value="",i.focus(),console.log("[Settings] 🔄 Recargando panel de gestión de equipo...");const C=(se=window.appInstance)==null?void 0:se.teamInfo;if(C)try{await U(C),console.log("[Settings] ✅ Panel de gestión de equipo recargado")}catch(T){console.error("[Settings] ⚠️ Error al recargar panel (no crítico):",T)}}catch(ge){console.error("[Settings] ❌ Error al invitar miembro:",ge),console.error("[Settings] Stack trace:",ge.stack);let ye="No se pudo enviar la invitación.";ge.message?ye=ge.message:typeof ge=="string"&&(ye=ge),ye.includes("invokeFunction")?ye+=" Verifica que auth.js esté cargado correctamente.":(ye.includes("network")||ye.includes("fetch"))&&(ye+=" Verifica tu conexión a internet."),(fe=window.showToast)==null||fe.call(window,ye,"error")}finally{y.disabled=!1,y.textContent=S,y.style.opacity="1",y.style.cursor="pointer";const ge=performance.now();console.log("[Settings] ⏱️ Tiempo total de handleInviteMember:",(ge-a).toFixed(2),"ms"),console.log("[Settings] ========== handleInviteMember FINALIZADO ==========")}}async function Y(a){const i=a.dataset.memberId,y=a.dataset.panelId,d=a.checked;if(!(!i||!y))try{const{data:E,error:h}=await e.from("team_members").select("permissions").eq("user_id",i).eq("team_id",teamInfo.team_id).single();if(h)throw h;const x=_e(E.permissions);x[y]=d;const{error:S}=await e.from("team_members").update({permissions:x}).eq("user_id",i).eq("team_id",teamInfo.team_id);if(S)throw S}catch(E){console.error("Error al actualizar permisos:",E),window.showToast("No se pudo actualizar el permiso.","error"),a.checked=!d}}async function Ie(a){const i=a.dataset.memberId,y=a.dataset.scope;if(!i||!y)return;const d=Array.from(a.selectedOptions).map(E=>E.value).filter(Boolean);try{const{data:E,error:h}=await e.from("team_members").select("permissions").eq("user_id",i).eq("team_id",teamInfo.team_id).single();if(h)throw h;const x=_e(E.permissions);x.label_filters[y]=d;const{error:S}=await e.from("team_members").update({permissions:x}).eq("user_id",i).eq("team_id",teamInfo.team_id);if(S)throw S}catch(E){console.error("[Settings] Error al actualizar etiquetas permitidas:",E),window.showToast("No se pudo actualizar el acceso por etiquetas.","error"),await U(teamInfo)}}function _e(a){const i=a&&typeof a=="object"?{...a}:{},y=i.label_filters&&typeof i.label_filters=="object"?{...i.label_filters}:{};return Array.isArray(y.contacts)||(y.contacts=[]),Array.isArray(y.chats)||(y.chats=[]),i.label_filters=y,i}function oe(a){if(!a)return;const i=document.getElementById("logo-preview"),y=new FileReader;y.onload=d=>{i.src=d.target.result},y.readAsDataURL(a)}async function ae(a){var y;const i=document.getElementById("reference-images-container");if(i){for(const d of a){if(i.querySelectorAll(".ref-image-item").length>=3){(y=window.showToast)==null||y.call(window,"Puedes subir un máximo de 3 imágenes de referencia.","warning");break}if(!window.appInstance)throw new Error("La instancia de la aplicación no está lista.");const E=await window.appInstance.uploadAsset(d,"reference_images");E&&(document.getElementById("add-ref-image-slot").insertAdjacentHTML("beforebegin",o(E)),lucide.createIcons())}document.getElementById("reference-image-input").value="",i.querySelectorAll(".ref-image-item").length>=3&&(document.getElementById("add-ref-image-slot").style.display="none")}}function D(a){const i=document.getElementById("reference-images-container"),y=document.getElementById("add-ref-image-slot");i&&(i.querySelectorAll(".ref-image-item").forEach(d=>d.remove()),(a||[]).forEach(d=>{y.insertAdjacentHTML("beforebegin",o(d))}),y.style.display=(a||[]).length>=3?"none":"flex",lucide.createIcons(),lucide.createIcons())}function c(a){const i=a.closest(".ref-image-item");if(i){i.remove();const y=document.getElementById("add-ref-image-slot");y&&(y.style.display="flex")}}function o(a){return`<div class="ref-image-item relative group aspect-square bg-slate-100 rounded-lg"><img src="${a}" class="w-full h-full object-cover rounded-lg"><button type="button" class="delete-ref-image-btn absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="x" class="w-3 h-3 pointer-events-none"></i></button></div>`}const m=[{value:0,name:"Domingo"},{value:1,name:"Lunes"},{value:2,name:"Martes"},{value:3,name:"Miércoles"},{value:4,name:"Jueves"},{value:5,name:"Viernes"},{value:6,name:"Sábado"}];async function g(a){try{const{data:i,error:y}=await e.from("appointment_settings").select("*").eq("user_id",a).maybeSingle(),d=document.getElementById("appointments-enabled"),E=document.getElementById("appointments-config");if(y&&y.code!=="PGRST116"){console.error("[Settings] Error al cargar configuración de citas:",y);return}if(i){const ie=document.getElementById("appointments-enabled-general");d&&(d.checked=i.is_enabled),ie&&(ie.checked=i.is_enabled),E?i.is_enabled?(E.classList.remove("hidden"),E.style.display="",console.log("[Settings] Configuración cargada: citas activadas, mostrando sección")):(E.classList.add("hidden"),console.log("[Settings] Configuración cargada: citas desactivadas, ocultando sección")):console.debug("[Settings] appointments-config no encontrado (puede ser normal si el panel no está activo)"),window.updateAppointmentsMenuVisibility&&window.updateAppointmentsMenuVisibility(i.is_enabled);const O=document.getElementById("appointment-timezone");O&&(O.value=i.timezone||"America/Mexico_City");const Be=document.getElementById("appointment-default-duration");Be&&(Be.value=i.default_duration_minutes||60);const qe=document.getElementById("appointment-buffer-time");qe&&(qe.value=i.buffer_time_minutes||0);const L=document.getElementById("appointment-advance-days");L&&(L.value=i.advance_booking_days||30);const F=document.getElementById("appointment-max-per-day");F&&(F.value=i.max_appointments_per_day||"")}else{const ie=document.getElementById("appointments-enabled-general");d&&(d.checked=!1),ie&&(ie.checked=!1),E&&E.classList.add("hidden"),window.updateAppointmentsMenuVisibility&&window.updateAppointmentsMenuVisibility(!1)}const h=document.getElementById("business-type");h&&(i!=null&&i.business_type)?h.value=i.business_type:h&&(h.value="both");const x=document.getElementById("reminders-enabled"),S=document.getElementById("reminders-config");x&&(x.checked=(i==null?void 0:i.reminders_enabled)||!1,S&&S.classList.toggle("hidden",!(i!=null&&i.reminders_enabled)));const $=document.getElementById("reminder-24h-enabled");$&&($.checked=(i==null?void 0:i.reminder_24h_enabled)!==!1);const G=document.getElementById("reminder-2h-enabled");G&&(G.checked=(i==null?void 0:i.reminder_2h_enabled)!==!1);const Z=document.getElementById("reminder-days-enabled"),V=document.getElementById("reminder-days-config");Z&&(Z.checked=!!(i!=null&&i.reminder_days_before),V&&V.classList.toggle("hidden",!Z.checked));const pe=document.getElementById("reminder-days-before");pe&&(pe.value=(i==null?void 0:i.reminder_days_before)||1);const we=document.getElementById("reminder-message-template");if(we&&(i!=null&&i.reminder_message_template)&&(we.value=i.reminder_message_template),i!=null&&i.is_enabled){const{data:ie}=await e.from("appointment_hours").select("id").eq("user_id",a).limit(1);(!ie||ie.length===0)&&await k(a),await f(a)}else{const ie=document.getElementById("appointment-hours-container");ie&&(ie.innerHTML="")}await u(a)}catch(i){console.error("[Settings] Error al cargar configuración de citas:",i)}}async function k(a){try{const{data:i}=await e.from("appointment_hours").select("id").eq("user_id",a).limit(1);if(i&&i.length>0)return;const{data:y}=await e.from("profiles").select("work_start_hour, work_end_hour").eq("id",a).single(),d=(y==null?void 0:y.work_start_hour)||9,E=(y==null?void 0:y.work_end_hour)||18,h=`${String(d).padStart(2,"0")}:00`,x=`${String(E).padStart(2,"0")}:00`,S=[];for(let $=0;$<=6;$++)S.push({user_id:a,day_of_week:$,is_available:$>=1&&$<=5,start_time:h,end_time:x});S.length>0&&(await e.from("appointment_hours").insert(S),console.log("[Settings] Horarios por defecto creados (todos los días, Lunes-Viernes activos)"))}catch(i){console.error("[Settings] Error al inicializar horarios por defecto:",i)}}async function f(a){try{const{data:i,error:y}=await e.from("appointment_hours").select("*").eq("user_id",a).order("day_of_week");if(y){console.error("[Settings] Error al cargar horarios:",y);return}const d=document.getElementById("appointment-hours-container"),E=document.getElementById("appointment-hours-empty");if(!d)return;d.innerHTML="";let h=!1;m.forEach(x=>{const S=i==null?void 0:i.find(Z=>Z.day_of_week===x.value),$=(S==null?void 0:S.is_available)||!1;$&&(h=!0);const G=`
                    <div class="flex items-center gap-4 p-3 bg-white border border-slate-200 rounded-lg hover:border-green-300 hover:shadow-sm transition-all">
                        <div class="w-28 flex-shrink-0">
                            <label class="block text-sm font-semibold text-slate-700">${x.name}</label>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <input type="checkbox" 
                                   class="day-available-toggle h-5 w-5 rounded text-green-600 focus:ring-green-500 focus:ring-2" 
                                   data-day="${x.value}"
                                   ${$?"checked":""}>
                            <label class="text-sm font-medium text-slate-700 cursor-pointer">Disponible</label>
                        </div>
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            <input type="time" 
                                   class="day-start-time form-input border-slate-300 rounded-lg text-sm min-w-[160px]" 
                                   data-day="${x.value}"
                                   value="${(S==null?void 0:S.start_time)||"09:00"}"
                                   ${$?"":"disabled"}>
                            <span class="text-slate-400 font-medium">-</span>
                            <input type="time" 
                                   class="day-end-time form-input border-slate-300 rounded-lg text-sm min-w-[160px]" 
                                   data-day="${x.value}"
                                   value="${(S==null?void 0:S.end_time)||"18:00"}"
                                   ${$?"":"disabled"}>
                        </div>
                    </div>
                `;d.insertAdjacentHTML("beforeend",G)}),E&&(h?E.classList.add("hidden"):E.classList.remove("hidden")),d.querySelectorAll(".day-available-toggle").forEach(x=>{x.addEventListener("change",S=>{const $=S.target.dataset.day,G=d.querySelector(`.day-start-time[data-day="${$}"]`),Z=d.querySelector(`.day-end-time[data-day="${$}"]`);G&&(G.disabled=!S.target.checked),Z&&(Z.disabled=!S.target.checked);const V=d.querySelectorAll(".day-available-toggle:checked");E&&(V.length>0?E.classList.add("hidden"):E.classList.remove("hidden"))})}),typeof lucide<"u"&&lucide.createIcons()}catch(i){console.error("[Settings] Error al cargar horarios:",i)}}async function u(a){try{const{data:i,error:y}=await e.from("appointment_types").select("*").eq("user_id",a).order("created_at");if(y){console.error("[Settings] Error al cargar tipos de citas:",y);return}const d=document.getElementById("appointment-types-container");if(!d)return;d.innerHTML="",(i||[]).forEach(E=>{d.insertAdjacentHTML("beforeend",l(E))})}catch(i){console.error("[Settings] Error al cargar tipos de citas:",i)}}function l(a){return`
            <div class="appointment-type-item bg-white p-4 rounded-lg border" data-type-id="${a.id||"new"}">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Nombre</label>
                        <input type="text" 
                               class="appointment-type-name form-input border-slate-300 rounded-lg text-sm w-full" 
                               value="${a.name||""}" 
                               placeholder="Ej: Consulta inicial">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Duración (minutos)</label>
                        <input type="number" 
                               class="appointment-type-duration form-input border-slate-300 rounded-lg text-sm w-full" 
                               value="${a.duration_minutes||60}" 
                               min="15" 
                               step="15">
                    </div>
                    <div class="flex items-end">
                        <button type="button" 
                                class="delete-appointment-type-btn bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 text-sm">
                            Eliminar
                        </button>
                    </div>
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Descripción (opcional)</label>
                    <input type="text" 
                           class="appointment-type-description form-input border-slate-300 rounded-lg text-sm w-full" 
                           value="${a.description||""}" 
                           placeholder="Descripción del tipo de cita">
                </div>
            </div>
        `}function s(){const a=document.getElementById("appointment-types-container");if(!a)return;const i={id:"new_"+Date.now(),name:"",duration_minutes:60,description:""};a.insertAdjacentHTML("beforeend",l(i))}function r(a){a&&a.remove()}async function w(a){var i,y;try{const d=document.getElementById("appointments-enabled"),E=document.getElementById("appointments-enabled-general");if(!((d==null?void 0:d.checked)||(E==null?void 0:E.checked)||!1)){const ge=document.getElementById("business-type"),ye=(ge==null?void 0:ge.value)||"both";await e.from("appointment_settings").upsert({user_id:a,is_enabled:!1,business_type:ye},{onConflict:"user_id"}),window.updateAppointmentsMenuVisibility&&window.updateAppointmentsMenuVisibility(!1);return}const x=document.getElementById("appointment-max-per-day"),S=(i=x==null?void 0:x.value)==null?void 0:i.trim(),$=document.getElementById("appointment-timezone"),G=document.getElementById("appointment-default-duration"),Z=document.getElementById("appointment-buffer-time"),V=document.getElementById("appointment-advance-days"),pe={user_id:a,is_enabled:!0,calendar_type:"internal",timezone:($==null?void 0:$.value)||"America/Mexico_City",default_duration_minutes:G&&parseInt(G.value)||60,buffer_time_minutes:Z&&parseInt(Z.value)||0,advance_booking_days:V&&parseInt(V.value)||30,max_appointments_per_day:S?parseInt(S):null},we=document.getElementById("business-type");we&&(pe.business_type=we.value||"both");const ie=document.getElementById("reminders-enabled");ie&&(pe.reminders_enabled=ie.checked||!1);const O=document.getElementById("reminder-24h-enabled");O&&(pe.reminder_24h_enabled=O.checked);const Be=document.getElementById("reminder-2h-enabled");Be&&(pe.reminder_2h_enabled=Be.checked);const qe=document.getElementById("reminder-days-enabled"),L=document.getElementById("reminder-days-before");qe&&L&&(qe.checked?pe.reminder_days_before=parseInt(L.value)||1:pe.reminder_days_before=null);const F=document.getElementById("reminder-message-template");if(F){const ge=(y=F.value)==null?void 0:y.trim();pe.reminder_message_template=ge||null}await e.from("appointment_settings").upsert(pe,{onConflict:"user_id"}),window.updateAppointmentsMenuVisibility&&window.updateAppointmentsMenuVisibility(!0);const P=document.getElementById("appointment-hours-container"),j=[];m.forEach(ge=>{const ye=P==null?void 0:P.querySelector(`.day-available-toggle[data-day="${ge.value}"]`),Ce=P==null?void 0:P.querySelector(`.day-start-time[data-day="${ge.value}"]`),Ue=P==null?void 0:P.querySelector(`.day-end-time[data-day="${ge.value}"]`);ye&&Ce&&Ue&&j.push({user_id:a,day_of_week:ge.value,is_available:ye.checked,start_time:Ce.value||"09:00",end_time:Ue.value||"18:00"})}),await e.from("appointment_hours").delete().eq("user_id",a),j.length>0&&await e.from("appointment_hours").insert(j);const se=document.getElementById("appointment-types-container"),fe=[];se==null||se.querySelectorAll(".appointment-type-item").forEach(ge=>{var Ae,Oe,C,T,R;const ye=ge.dataset.typeId,Ce=(Oe=(Ae=ge.querySelector(".appointment-type-name"))==null?void 0:Ae.value)==null?void 0:Oe.trim(),Ue=parseInt((C=ge.querySelector(".appointment-type-duration"))==null?void 0:C.value)||60,je=((R=(T=ge.querySelector(".appointment-type-description"))==null?void 0:T.value)==null?void 0:R.trim())||null;Ce&&(ye.startsWith("new_")?fe.push({user_id:a,name:Ce,duration_minutes:Ue,description:je,is_active:!0}):e.from("appointment_types").update({name:Ce,duration_minutes:Ue,description:je,is_active:!0}).eq("id",ye).eq("user_id",a))}),fe.length>0&&await e.from("appointment_types").insert(fe),console.log("[Settings] Configuración de citas guardada exitosamente")}catch(d){throw console.error("[Settings] Error al guardar configuración de citas:",d),d}}})();(function(){const z=["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#FF5722","#795548","#9E9E9E","#607D8B","#FFFFFF"];function e(D){if(typeof D=="string"&&D.startsWith("#"))return D;const c=parseInt(D,10);return!isNaN(c)&&c>=0&&c<z.length?z[c]:"#A0AEC0"}let t=!1,n=[],p=!1,b=!1,_=null;document.addEventListener("panel:activated",({detail:D})=>{D.panelId==="smart-labels"&&!t&&B()});function B(){console.log("Inicializando panel de Etiquetas Inteligentes..."),A(),N(),W(),t=!0}function A(){p||(document.addEventListener("click",U),p=!0)}function N(){H()||_||(_=new MutationObserver(()=>{H()&&(_.disconnect(),_=null)}),_.observe(document.body,{childList:!0,subtree:!0}))}function H(){var k,f,u,l;if(b)return!0;const D=document.getElementById("smart-label-modal");if(!D)return!1;(k=D.querySelector("#cancel-smart-label-btn"))==null||k.addEventListener("click",ce),(f=D.querySelector("#cancel-smart-label-btn-footer"))==null||f.addEventListener("click",ce),(u=D.querySelector("#smart-label-form"))==null||u.addEventListener("submit",oe),(l=D.querySelector("#delete-smart-label-btn"))==null||l.addEventListener("click",ae);const c=document.getElementById("smart-label-is-automated");c==null||c.addEventListener("change",X);const o=document.getElementById("smart-label-ai-enhance-btn");o==null||o.addEventListener("click",Ee);const m=document.getElementById("smart-label-select");m==null||m.addEventListener("change",me);const g=document.getElementById("smart-label-enable-funnel");return g==null||g.addEventListener("change",s=>Y(s.target.checked)),b=!0,!0}function U(D){if(D.target.closest("#add-smart-label-btn")){D.preventDefault(),be(null);return}const o=D.target.closest(".edit-smart-label-btn");if(o){D.preventDefault();const m=o.dataset.id,g=n.find(k=>{var f;return((f=k.id)==null?void 0:f.toString())===m});g&&be(g)}}function X(D){var c;(c=document.getElementById("ai-fields-container"))==null||c.classList.toggle("hidden",!D.target.checked)}function Ee(D){D.preventDefault();const c=document.getElementById("smart-label-prompt");c!=null&&c.value&&window.appInstance.openAiEnhanceModal(c.value,o=>c.value=o)}function me(D){var g;const c=D==null?void 0:D.target;if(!c)return;const o=c.value==="_new_";(g=document.getElementById("new-label-fields-container"))==null||g.classList.toggle("hidden",!o);const m=document.getElementById("smart-label-name");m&&(m.required=o)}async function W(){const D=document.getElementById("smart-labels-loader"),c=document.getElementById("smart-labels-content");D.classList.remove("hidden"),c.classList.add("hidden");try{const{data:o,error:m}=await window.auth.sb.from("labels").select("*");if(m)throw m;const g=new Map;for(const k of o||[]){if(!k.name)continue;const f=g.get(k.name);(!f||!f.prompt&&k.prompt||!f.funnel_name&&k.funnel_name)&&g.set(k.name,k)}n=Array.from(g.values()),ue(),te(),re(),D.classList.add("hidden"),c.classList.remove("hidden")}catch(o){console.error("Error al cargar etiquetas:",o),D.textContent="Error al cargar las etiquetas."}}function ue(){const D=document.getElementById("funnels-container"),c=n.reduce((o,m)=>(m.funnel_name&&(o[m.funnel_name]||(o[m.funnel_name]=[]),o[m.funnel_name].push(m)),o),{});if(Object.keys(c).length===0){D.innerHTML='<p class="text-slate-500">No se han configurado funnels de etiquetas.</p>';return}D.innerHTML=Object.entries(c).map(([o,m])=>(m.sort((g,k)=>(g.funnel_order||0)-(k.funnel_order||0)),`
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h4 class="text-lg font-bold text-slate-900 mb-4">${o}</h4>
                    <div class="flex items-center space-x-2 overflow-x-auto pb-4">
                        ${m.map((g,k)=>`
                            ${k>0?'<i data-lucide="chevron-right" class="text-slate-400 flex-shrink-0"></i>':""}
                            <div class="flex-shrink-0 w-64">
                                ${ne(g)}
                            </div>
                        `).join("")}
                    </div>
                </div>
            `)).join(""),lucide.createIcons()}function te(){const D=document.getElementById("individual-labels-container"),c=n.filter(o=>!o.funnel_name);if(c.length===0){D.innerHTML='<p class="text-slate-500 text-sm">No hay etiquetas individuales.</p>';return}D.innerHTML=c.map(o=>ne(o)).join(""),lucide.createIcons()}function re(){const D=document.getElementById("funnel-names-list");if(!D)return;const c=new Set(n.map(o=>o.funnel_name).filter(Boolean));D.innerHTML=Array.from(c).map(o=>`<option value="${o}"></option>`).join("")}function ne(D){var u,l;const c=D.is_automated?"bg-green-100 text-green-800":"bg-slate-100 text-slate-500",o=D.is_automated?"Automática":"Manual",k=(((l=(u=window.appInstance)==null?void 0:u.teamInfo)==null?void 0:l.ignored_labels)||[]).includes(D.name)?'<span class="text-[10px] font-semibold uppercase tracking-wide px-2 py-0.5 rounded-full bg-red-100 text-red-700">Ignorar IA</span>':"";return`
            <div class="border border-slate-200 rounded-lg p-4 space-y-3">
                <div class="flex justify-between items-start gap-3">
                    <h5 class="font-bold" style="color: ${e(D.color)}">${D.name}</h5>
                    <div class="flex flex-col items-end gap-1">
                        <span class="text-xs font-medium px-2 py-0.5 rounded-full ${c}">${o}</span>
                        ${k}
                    </div>
                </div>
                <p class="text-sm text-slate-600 h-16 overflow-y-auto">
                    <strong>Instrucción:</strong> ${D.prompt||"<em>No definida</em>"}
                </p>
                <button class="edit-smart-label-btn text-xs text-blue-600 hover:underline font-semibold flex items-center gap-1" data-id="${D.id}">
                    <i data-lucide="edit-2" class="w-3 h-3 pointer-events-none"></i> Editar
                </button>
            </div>
        `}async function be(D,c=0){var r,w,a,i;const o=document.getElementById("smart-label-modal"),m=document.getElementById("smart-label-form");if(!o||!m){c<10?setTimeout(()=>be(D,c+1),50):console.warn("El modal de automatizaciones IA no está disponible después de varios intentos.");return}b||H(),m.reset(),document.getElementById("ai-fields-container").classList.add("hidden"),document.getElementById("new-label-fields-container").classList.add("hidden"),document.getElementById("smart-label-name").required=!1;const g=document.getElementById("label-selector-container"),k=document.getElementById("smart-label-select"),f=document.getElementById("smart-label-enable-funnel"),u=document.getElementById("smart-label-is-automated"),l=document.getElementById("smart-label-notify");if(!k||!g){console.warn("No se encontró el selector de etiquetas para automatizaciones."),c<10&&setTimeout(()=>be(D,c+1),50);return}if(D){g.classList.remove("hidden"),document.getElementById("new-label-fields-container").classList.add("hidden"),document.getElementById("smart-label-name").required=!1,document.getElementById("smart-label-modal-title").textContent="Editar automatización",document.getElementById("smart-label-id").value=D.id;const{data:y,error:d}=await window.auth.sb.from("labels").select("id, name").or(`prompt.is.null,id.eq.${D.id}`);if(d)console.error("Error cargando etiquetas disponibles:",d),k.innerHTML="<option>Error al cargar</option>";else{const E=(y||[]).reduce((h,x)=>(h.some(S=>S.name===x.name)||h.push(x),h),[]);k.innerHTML=E.map(h=>`<option value="${h.id}">${h.name}</option>`).join(""),k.value=D.id}document.getElementById("smart-label-prompt").value=D.prompt||"",u&&(u.checked=!!D.is_automated,X({target:u})),l&&(l.checked=!!D.notify_on_assign),f&&(f.checked=!!D.funnel_name,document.getElementById("smart-label-funnel-name").value=D.funnel_name||"",document.getElementById("smart-label-funnel-order").value=D.funnel_order??"",Y(f.checked))}else{g.classList.remove("hidden"),document.getElementById("smart-label-modal-title").textContent="Nueva automatización de etiqueta",document.getElementById("smart-label-id").value="";const{data:y,error:d}=await window.auth.sb.from("labels").select("id, name").is("prompt",null);if(d)console.error("Error cargando etiquetas no automatizadas:",d),k.innerHTML="<option>Error al cargar</option>";else{const E=(y||[]).reduce((h,x)=>(h.some(S=>S.name===x.name)||h.push(x),h),[]);k.innerHTML='<option value="" disabled selected>Selecciona una etiqueta...</option>'+E.map(h=>`<option value="${h.id}">${h.name}</option>`).join("")+'<option value="_new_" class="font-bold text-blue-600">Crear nueva etiqueta...</option>'}f&&(f.checked=!1,document.getElementById("smart-label-funnel-name").value="",document.getElementById("smart-label-funnel-order").value="",Y(!1)),u&&(u.checked=!1,X({target:u})),l&&(l.checked=!1)}me({target:k});const s=document.getElementById("smart-label-ignore-in-chats");if(s){const y=(r=window.appInstance)==null?void 0:r.teamInfo,d=(y==null?void 0:y.ignored_labels)||[],E=(D==null?void 0:D.name)||((i=(a=(w=k.selectedOptions)==null?void 0:w[0])==null?void 0:a.textContent)==null?void 0:i.trim())||"";s.checked=!!E&&d.includes(E)}o.classList.remove("hidden"),lucide.createIcons()}function ce(){document.getElementById("smart-label-modal").classList.add("hidden")}function Y(D){const c=document.getElementById("funnel-fields-container"),o=document.getElementById("smart-label-funnel-name"),m=document.getElementById("smart-label-funnel-order");!c||!o||!m||(c.classList.toggle("hidden",!D),o.disabled=!D,o.required=D,m.disabled=!D)}async function Ie(D){if(D)try{const{data:c,error:o}=await window.auth.sb.from("labels").select("id, name").eq("user_id",D).limit(100);if(o)throw o;(Array.isArray(c)?c.find(g=>g.name&&g.name.toLowerCase().trim()==="ignorar"):null)||await window.auth.sb.from("labels").insert({user_id:D,name:"Ignorar",color:"#64748B",is_automated:!1,notify_on_assign:!1})}catch(c){throw console.error('No se pudo asegurar la etiqueta "ignorar":',c),c}}async function _e(D,c){var f;const o=(f=window.appInstance)==null?void 0:f.teamInfo;if(!o||!D)return;let m=Array.isArray(o.ignored_labels)?[...o.ignored_labels]:[];const g=m.includes(D);if(c&&!g)m.push(D);else if(!c&&g)m=m.filter(u=>u!==D);else return;const{error:k}=await window.auth.sb.from("teams").update({ignored_labels:m}).eq("id",o.team_id);if(k)throw k;window.appInstance.teamInfo={...o,ignored_labels}}async function oe(D){var w,a,i,y,d,E;D.preventDefault();const c=document.querySelector('#smart-label-modal button[type="submit"]');c&&(c.disabled=!0,c.textContent="Guardando...");let o=document.getElementById("smart-label-id").value;const m=document.getElementById("smart-label-select"),g=document.getElementById("smart-label-enable-funnel"),k=!!(g!=null&&g.checked),f=document.getElementById("smart-label-funnel-order").value,u=document.getElementById("smart-label-funnel-name").value.trim(),l=!!((w=document.getElementById("smart-label-ignore-in-chats"))!=null&&w.checked),s=(i=(a=window.auth.getSession())==null?void 0:a.user)==null?void 0:i.id,r=document.getElementById("smart-label-name").value.trim()||((E=(d=(y=m==null?void 0:m.selectedOptions)==null?void 0:y[0])==null?void 0:d.textContent)==null?void 0:E.trim())||"";try{const h=f?parseInt(f,10):null,x={is_automated:document.getElementById("smart-label-is-automated").checked,prompt:document.getElementById("smart-label-prompt").value,funnel_name:k&&u?u:null,funnel_order:k&&Number.isFinite(h)?h:null,notify_on_assign:document.getElementById("smart-label-notify").checked};if(l&&s&&await Ie(s),o){const S=document.getElementById("smart-label-select").value;if(o!==S){await window.auth.sb.from("labels").update({prompt:null,is_automated:!1,funnel_name:null,funnel_order:null,notify_on_assign:!1}).eq("id",o);const{error:$}=await window.auth.sb.from("labels").update(x).eq("id",S);if($)throw $;o=S}else{const{error:$}=await window.auth.sb.from("labels").update(x).eq("id",o);if($)throw $}}else{const S=document.getElementById("smart-label-select").value;if(S==="_new_"){const $=document.getElementById("smart-label-name").value.trim(),G=$.charAt(0).toUpperCase()+$.slice(1).toLowerCase(),Z=document.getElementById("smart-label-color").value,{data:V}=await window.auth.sb.from("labels").select("id, name").eq("user_id",s),pe=V==null?void 0:V.find(ie=>ie.name.toLowerCase().trim()===G.toLowerCase().trim());if(pe)throw new Error(`La etiqueta "${pe.name}" ya existe.`);const{error:we}=await window.auth.sb.from("labels").insert({...x,user_id:s,name:G,color:Z});if(we)throw we}else{const{error:$}=await window.auth.sb.from("labels").update(x).eq("id",S);if($)throw $}}await _e(r,l),window.showToast("Automatización guardada con éxito.","success"),ce(),W()}catch(h){console.error("Error al guardar la automatización:",h),window.showToast(`Error: ${h.message}`,"error")}finally{c&&(c.disabled=!1,c.textContent="Guardar automatización")}}async function ae(){const D=document.getElementById("smart-label-id").value;if(!(!D||!confirm("¿Estás seguro de que quieres eliminar esta etiqueta permanentemente? Esta acción no se puede deshacer.")))try{const{error:c}=await window.auth.sb.from("labels").delete().eq("id",D);if(c)throw c;window.showToast("Etiqueta eliminada.","info"),ce(),W()}catch(c){console.error("Error al eliminar la etiqueta:",c),window.showToast(`Error al eliminar: ${c.message}`,"error")}}})();(function(){const z=[{name:"Saludo y Presentación",content:`¡Hola %nombre%! 👋
Soy de [Nombre de tu negocio] y quería saludarte.
Estamos ayudando a [clientes/negocios/personas] como tú con [beneficio principal].
¿Te interesa que te cuente un poco más?`},{name:"Promoción Exclusiva",content:`¡Hola %nombre%! 🎉
Tenemos una promoción especial esta semana:
👉 [Nombre del producto/servicio] con un descuento exclusivo.

¿Quieres que te mande la información completa? 🚀`},{name:"Recordatorio Amistoso",content:`¡Hola %nombre%!
Solo para recordarte sobre [tema pendiente].
Si necesitas algo, no dudes en avisarme. ¡Estoy para ayudarte!`}];let e=[],t=!1;document.addEventListener("panel:activated",({detail:te})=>{te.panelId==="templates"&&(t||(n(),t=!0))});async function n(){console.log("Panel de Plantillas activado."),p(),await b(),_(),B()}function p(){const te=document.getElementById("base-templates-container");te.innerHTML=z.map(re=>`
            <div class="bg-white p-4 rounded-lg shadow">
                <h4 class="font-bold text-slate-800">${re.name}</h4>
                <p class="text-sm text-slate-600 mt-2 h-20 overflow-hidden">${re.content}</p>
                <div class="text-right mt-4">
                    <button class="apply-template-btn text-sm bg-blue-500 text-white py-1 px-3 rounded-md" data-content="${re.content}">Usar</button>
                </div>
            </div>
        `).join("")}async function b(){try{const{data:te,error:re}=await window.auth.sb.from("message_templates").select("*");if(re)throw re;e=te}catch(te){console.error("Error al cargar plantillas personalizadas:",te)}}function _(){const te=document.getElementById("custom-templates-container");if(e.length===0){te.innerHTML='<p class="text-slate-500 text-center">Aún no has creado plantillas.</p>';return}te.innerHTML=e.map(re=>`
            <div class="bg-white p-4 rounded-lg shadow flex items-center justify-between">
                <div>
                    <h4 class="font-bold text-slate-800">${re.name}</h4>
                    <p class="text-sm text-slate-600 mt-1">${re.content}</p>
                </div>
                <div class="flex items-center gap-2">
                    <button class="ai-enhance-btn text-sm bg-purple-100 text-purple-700 py-1 px-3 rounded-md" data-template-id="${re.id}"><i data-lucide="sparkles" class="w-4 h-4 inline-block pointer-events-none"></i> Mejorar</button>
                    <button class="apply-template-btn text-sm bg-blue-500 text-white py-1 px-3 rounded-md" data-content="${re.content}">Usar</button>
                    <button class="delete-template-btn text-sm bg-red-100 text-red-700 p-2 rounded-md" data-template-id="${re.id}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                </div>
            </div>
        `).join(""),lucide.createIcons()}function B(){var te,re,ne;(te=document.getElementById("add-template-btn"))==null||te.addEventListener("click",A),document.body.addEventListener("click",be=>{const ce=be.target.closest(".apply-template-btn"),Y=be.target.closest(".delete-template-btn"),Ie=be.target.closest(".ai-enhance-btn");ce&&Ee(be.target.dataset.content),Y&&X(be.target.dataset.templateId),Ie&&W(be.target.dataset.templateId)}),(re=document.getElementById("cancel-new-template-btn"))==null||re.addEventListener("click",H),(ne=document.getElementById("new-template-form"))==null||ne.addEventListener("submit",U)}async function A(){if(e.length>=5){alert("Has alcanzado el límite de 5 plantillas personalizadas.");return}N()}function N(){var ne;document.getElementById("new-template-form-container").classList.remove("hidden"),document.getElementById("add-template-btn").classList.add("hidden");const te=document.getElementById("new-template-content"),re=document.getElementById("new-template-form");(ne=re.querySelector(".template-actions"))==null||ne.remove(),te.insertAdjacentHTML("afterend",`
            <div class="template-actions flex items-center justify-between mt-2">
                <button type="button" class="personalize-name-btn text-sm bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-md"><i data-lucide="user-plus" class="w-4 h-4 inline-block mr-1"></i>Insertar Nombre</button>
                <button type="button" class="ai-enhance-btn text-xs bg-purple-100 text-purple-700 font-semibold py-1 px-2 rounded-md hover:bg-purple-200 flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> Mejorar con IA</button>
            </div>
        `),re.querySelector(".ai-enhance-btn").addEventListener("click",()=>window.appInstance.openAiEnhanceModal(te.value,be=>{te.value=be})),re.querySelector(".personalize-name-btn").addEventListener("click",()=>me(te)),lucide.createIcons({root:re.querySelector(".template-actions")}),document.getElementById("new-template-name").value="",document.getElementById("new-template-content").value=""}function H(){var re;document.getElementById("new-template-form-container").classList.add("hidden"),document.getElementById("add-template-btn").classList.remove("hidden");const te=document.getElementById("new-template-form");te.reset(),(re=te.querySelector(".template-actions"))==null||re.remove()}async function U(te){te.preventDefault();const re=document.getElementById("new-template-name").value.trim(),ne=document.getElementById("new-template-content").value.trim();if(!(!re||!ne))try{const{error:be}=await window.auth.sb.from("message_templates").insert({user_id:window.auth.getSession().user.id,name:re,content:ne});if(be)throw be;H(),await b(),_()}catch(be){console.error("Error al crear plantilla:",be),alert("No se pudo crear la plantilla.")}}async function X(te){if(confirm("¿Estás seguro de que quieres borrar esta plantilla?"))try{const{error:re}=await window.auth.sb.from("message_templates").delete().eq("id",te);if(re)throw re;await b(),_()}catch(re){console.error("Error al borrar plantilla:",re),alert("No se pudo borrar la plantilla.")}}function Ee(te){const re=document.querySelector('.nav-link[data-target="bulk-sending"]');re&&(re.click(),setTimeout(()=>{const ne=document.getElementById("bulk-message");ne&&(ne.value=te,ne.focus())},100))}function me(te){if(!te)return;const re=te.selectionStart,ne=te.selectionEnd,be=te.value,ce="%nombre%";te.value=be.substring(0,re)+ce+be.substring(ne),te.focus(),te.selectionEnd=re+ce.length}function W(te){const re=e.find(ne=>ne.id==te);re&&window.appInstance.openAiEnhanceModal(re.content,ne=>{ue(re.id,ne)})}async function ue(te,re){await window.auth.sb.from("message_templates").update({content:re}).eq("id",te),window.appInstance.closeAiModal(),await b(),_()}})();(function(){let z=!1,e={},t=null,n={used:0,limit:0},p=!1;const b=5e3,_=40;document.addEventListener("panel:activated",({detail:Y})=>{Y.panelId==="video-ai"&&!z&&B()});async function B(){z=!0,await A(),N(),H(),U()}async function A(){var Ie;t=await window.appInstance.loadUserSubscription();const Y=await window.appInstance.loadUserUsage();n={used:(Y==null?void 0:Y.video_generations_used)||0,limit:((Ie=t==null?void 0:t.plans)==null?void 0:Ie.video_generations_limit)||0}}function N(){e={actionsPrompt:"",textPrompt:"",audioType:"",imageUrls:[],model:"veo3_fast",aspectRatio:"Auto",callBackUrl:"",seed:null,generationType:"auto"}}function H(){const Y=document.getElementById("video-ai");Y&&(Y.addEventListener("input",Ie=>{Ie.target.id==="video-actions-prompt"&&(e.actionsPrompt=Ie.target.value),Ie.target.id==="video-text-prompt"&&(e.textPrompt=Ie.target.value),Ie.target.id==="video-audio-type"&&(e.audioType=Ie.target.value),Ie.target.id==="video-aspect-ratio-select"&&(e.aspectRatio=Ie.target.value)}),Y.addEventListener("click",Ie=>{Ie.target.id==="generate-video-btn"&&W()}))}function U(){var m,g;const Y=document.getElementById("video-ai");if(!Y)return;const Ie=((g=(m=t==null?void 0:t.plans)==null?void 0:m.features)==null?void 0:g.video_ai)??!1;if(Y.querySelector(".grid").classList.toggle("hidden",!Ie),Y.querySelector("#video-ai-access-denied").classList.toggle("hidden",Ie),!Ie){document.getElementById("upgrade-to-grow-from-video").onclick=()=>window.appInstance.handleUpgradeClick("grow");return}const _e=Y.querySelector("#video-reference-selector");_e&&(_e.innerHTML=Array.from({length:2}).map((k,f)=>X(`video-ref-${f}`,f===0?"Primer Frame":"Último Frame",e.imageUrls[f])).join(""));const oe=Y.querySelector("#video-actions-prompt"),ae=Y.querySelector("#video-text-prompt"),D=Y.querySelector("#video-audio-type"),c=Y.querySelector("#video-aspect-ratio-select");oe&&(oe.value=e.actionsPrompt||""),ae&&(ae.value=e.textPrompt||""),D&&(D.value=e.audioType||""),c&&(c.value=e.aspectRatio||"Auto");const o=Y.querySelector("#video-generation-usage-container");o&&(o.innerHTML=`
                <h4 class="font-bold text-sm mb-1">Uso Mensual</h4>
                <p class="text-xs text-slate-600">Videos generados: <span id="video-generation-usage" class="font-bold">${n.used} / ${n.limit}</span></p>
            `),Ee(),lucide.createIcons()}function X(Y,Ie,_e){return`
            <div class="image-upload-slot" data-upload-id="${Y}">
                <label for="${Y}" class="upload-label">
                    ${_e?"":`<div class="text-center text-xs text-gray-500"><p class="font-semibold">${Ie}</p></div>`}
                </label>
                ${_e?`<img src="${_e}" alt="Preview" class="image-preview" />`:""}
                ${_e?`<button class="remove-button" data-remove-id="${Y}"><i data-lucide="x" class="w-4 h-4 pointer-events-none"></i></button>`:""}
                <input id="${Y}" type="file" class="hidden" accept="image/*" />
            </div>
        `}function Ee(){document.querySelectorAll("#video-reference-selector .image-upload-slot").forEach(Y=>{var ae;const Ie=Y.dataset.uploadId,_e=document.getElementById(Ie),oe=parseInt(Ie.split("-")[2],10);(ae=Y.querySelector(".remove-button"))==null||ae.addEventListener("click",D=>{D.preventDefault(),D.stopPropagation(),e.imageUrls[oe]=null,U()}),_e.addEventListener("change",async D=>{var o;const c=(o=D.target.files)==null?void 0:o[0];if(c){try{const m=await window.appInstance.uploadAsset(c,"video-references");e.imageUrls[oe]=m}catch{window.showToast("Error al subir la imagen.","error")}U()}})})}function me(){var Ie,_e,oe;const Y=[];return(Ie=e.actionsPrompt)!=null&&Ie.trim()&&Y.push(`Acciones: ${e.actionsPrompt.trim()}`),(_e=e.textPrompt)!=null&&_e.trim()&&Y.push(e.textPrompt.trim()),(oe=e.audioType)!=null&&oe.trim()&&Y.push(`Audio de fondo: ${e.audioType.trim()}`),Y.join(". ")}async function W(){var oe,ae,D;if(p)return;const Y=me();if(!Y||Y.trim().length===0){window.showToast("Debes completar al menos una sección (acciones, texto o audio).","error");return}if(n.limit>0&&n.used>=n.limit){window.showToast("Has alcanzado tu limite de generaciones de video.","error");return}const Ie=document.getElementById("generate-video-btn"),_e=document.getElementById("video-result-container");p=!0,Ie.disabled=!0,Ie.textContent="Generando...",_e.innerHTML='<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>';try{const c=(ae=(oe=window.auth.getSession())==null?void 0:oe.user)==null?void 0:ae.id;if(!c)throw new Error("No se pudo determinar el usuario actual.");let o=null;try{const{data:y,error:d}=await window.auth.sb.rpc("check_account_access",{p_user_id:c});if(d&&d.code!=="PGRST202")throw new Error("Error al verificar el acceso de tu cuenta.");d||(o=y)}catch(y){if(y.code!=="PGRST202")throw new Error("Error al verificar el acceso de tu cuenta.")}if(o&&o.blocked)throw new Error(o.reason||"Tu cuenta está bloqueada. Por favor, contacta con soporte.");const{data:m,error:g}=await window.auth.sb.rpc("increment_video_usage",{p_user_id:c});if(g||!(m!=null&&m.success))throw new Error((m==null?void 0:m.message)||(g==null?void 0:g.message)||"Error al verificar el uso.");const k=e.imageUrls.filter(Boolean);let f="TEXT_2_VIDEO";k.length>=1&&(f="FIRST_AND_LAST_FRAMES_2_VIDEO");const u={prompt:Y,model:"veo3_fast",aspectRatio:e.aspectRatio||"Auto",generationType:f,enableTranslation:!0,imageUrls:k.length?k:void 0,callBackUrl:e.callBackUrl||void 0,seeds:e.seed||void 0},{data:l,error:s}=await window.auth.invokeFunction("kie-veo-proxy",{body:u});if(s)throw s;const r=(D=l==null?void 0:l.data)==null?void 0:D.taskId;if(!r)throw new Error("La API de Kie.ai no devolvio un identificador de tarea.");_e.innerHTML=`
                <div class="text-center p-4">
                    <p class="font-semibold">Tarea enviada. Esperando resultados...</p>
                    <p class="text-xs text-slate-500 mt-1">ID: <span class="font-mono">${r}</span></p>
                </div>
            `;const w=await ue(r),a=te(w);if(!a)throw new Error("La tarea finalizo sin devolver el video.");const i=await re(a,c);n.used=m.used||n.used+1,be(),_e.innerHTML=`
                <div class="space-y-3">
                    <video class="w-full rounded-lg shadow-lg" controls playsinline src="${i}"></video>
                    <div class="flex flex-col items-center gap-2 text-sm text-slate-600">
                        <span class="font-semibold">Video generado con audio (KIE Veo 3.1 Fast)</span>
                        <a class="text-indigo-600 hover:underline" href="${i}" target="_blank" rel="noopener">Abrir en nueva pestaña</a>
                    </div>
                </div>
            `,lucide.createIcons(),window.showToast("Video generado correctamente.","success")}catch(c){console.error("Error al generar video:",c);const o=(c==null?void 0:c.message)||"Ocurrio un error al generar el video.";window.showToast(o,"error"),be();const m=document.getElementById("video-result-container");m.innerHTML=`
                <div class="text-center p-4">
                    <i data-lucide="alert-triangle" class="w-12 h-12 text-red-500 mx-auto"></i>
                    <p class="font-semibold mt-2 text-red-700">Error en la generacion</p>
                    <p class="text-xs text-slate-500 mt-1">${o}</p>
                </div>
            `,lucide.createIcons()}finally{p=!1,Ie.disabled=!1,Ie.textContent="Generar Video"}}async function ue(Y,Ie=_,_e=b){let oe=0;for(;oe<Ie;){oe+=1;try{const{data:ae,error:D}=await window.auth.invokeFunction("kie-task-status",{body:{taskId:Y}});if(D)throw new Error(D.message||"Error consultando el estado de la tarea.");const c=ae==null?void 0:ae.data,o=c==null?void 0:c.state;if(o==="success")return c;if(o==="fail"){const m=(c==null?void 0:c.failMsg)||"La generacion de video fallo.";throw new Error(m)}await ce(_e)}catch(ae){if(console.error("Error al consultar el estado de la tarea de video:",ae),oe>=Ie)throw ae;await ce(_e)}}throw new Error("La generacion de video esta tardando mas de lo esperado. Intenta nuevamente.")}function te(Y){if(!Y)return null;if(Array.isArray(Y.resultUrls)&&Y.resultUrls.length>0)return Y.resultUrls[0];if(Y.videoUrl)return Y.videoUrl;const Ie=typeof Y.resultJson=="string"?Y.resultJson:null;if(Ie)try{const _e=JSON.parse(Ie);if(Array.isArray(_e.resultUrls)&&_e.resultUrls.length>0)return _e.resultUrls[0];if(_e.videoUrl)return _e.videoUrl}catch(_e){console.error("No se pudo interpretar el resultJson de Veo 3.1:",_e)}return null}async function re(Y,Ie){const _e=await fetch(Y);if(!_e.ok)throw new Error(`No se pudo descargar el video generado (status ${_e.status}).`);const oe=await _e.blob(),ae=ne(oe.type),D=`veo-video-${Date.now()}.${ae}`,c=new File([oe],D,{type:oe.type||"video/mp4"}),o=await window.appInstance.uploadAsset(c,"video-results");try{await window.auth.sb.from("profiles").update({last_video_generated_url:o}).eq("id",Ie)}catch(m){console.warn("No se pudo registrar el último video generado en el perfil:",m)}return o}function ne(Y){return Y?Y.includes("webm")?"webm":Y.includes("mov")?"mov":Y.includes("gif")?"gif":"mp4":"mp4"}function be(){const Y=document.getElementById("video-generation-usage");Y&&(Y.textContent=`${n.used} / ${n.limit}`)}function ce(Y){return new Promise(Ie=>setTimeout(Ie,Y))}})();(function(){let z=!1,e=null,t="month",n=new Date,p=[];document.addEventListener("panel:activated",({detail:u})=>{u.panelId==="appointments"&&(z||_(),N(t==="month"?"month":"week"),A())}),document.addEventListener("panel:loaded",({detail:u})=>{u.panelId==="appointments"&&!z&&(_(),A())});function b(u){if(!u)return"";let l,s;if(typeof u=="string"){const a=u.split(":");l=parseInt(a[0]),s=a[1]||"00"}else l=u.getHours(),s=String(u.getMinutes()).padStart(2,"0");const r=l===0?12:l>12?l-12:l,w=l>=12?"PM":"AM";return`${r}:${s} ${w}`}function _(){console.log("[Appointments] Inicializando panel de citas..."),z=!0,e=window.auth.sb,B()}function B(){var w,a,i,y,d,E,h,x,S,$,G,Z,V,pe,we,ie,O,Be,qe,L,F,P,j,se,fe,ge,ye,Ce,Ue,je,Ae,Oe,C,T,R,K;(w=document.getElementById("refresh-appointments-btn"))==null||w.addEventListener("click",()=>{A()}),(a=document.getElementById("appointments-filter-status"))==null||a.addEventListener("change",()=>{A()}),(i=document.getElementById("appointments-filter-date"))==null||i.addEventListener("change",()=>{A()}),(y=document.getElementById("calendar-view-month-btn"))==null||y.addEventListener("click",()=>{N("month")}),(d=document.getElementById("calendar-view-week-btn"))==null||d.addEventListener("click",()=>{N("week")}),(E=document.getElementById("calendar-view-month-btn-week"))==null||E.addEventListener("click",()=>{N("month")}),(h=document.getElementById("calendar-view-week-btn-week"))==null||h.addEventListener("click",()=>{N("week")}),(x=document.getElementById("new-appointment-btn-week"))==null||x.addEventListener("click",()=>{me()}),(S=document.getElementById("appointments-filter-status-week"))==null||S.addEventListener("change",ee=>{const de=document.getElementById("appointments-filter-status");de&&(de.value=ee.target.value),A()}),($=document.getElementById("calendar-prev-month"))==null||$.addEventListener("click",()=>{H(-1)}),(G=document.getElementById("calendar-next-month"))==null||G.addEventListener("click",()=>{H(1)}),(Z=document.getElementById("calendar-prev-week"))==null||Z.addEventListener("click",()=>{H(-1)}),(V=document.getElementById("calendar-next-week"))==null||V.addEventListener("click",()=>{H(1)}),(pe=document.getElementById("new-appointment-btn"))==null||pe.addEventListener("click",()=>{me()}),(we=document.getElementById("open-new-appointment-modal-btn"))==null||we.addEventListener("click",()=>{me()}),(ie=document.getElementById("cancel-appointment-btn"))==null||ie.addEventListener("click",()=>{W()}),(O=document.getElementById("close-new-appointment-modal-btn"))==null||O.addEventListener("click",()=>{W()}),(Be=document.getElementById("save-appointment-btn"))==null||Be.addEventListener("click",()=>{ae()});const u=document.getElementById("appointment-start-date"),l=document.getElementById("appointment-date-wrapper");u&&l&&(l.addEventListener("click",ee=>{var de;ee.preventDefault(),ee.stopPropagation(),u.focus(),(de=u.showPicker)==null||de.call(u)}),u.addEventListener("change",async ee=>{const de=ee.target.value;_e("appointment-start-date","appointment-date-display"),de&&await ce(de,"new")}),u.addEventListener("focus",()=>{}),u.addEventListener("blur",()=>{_e("appointment-start-date","appointment-date-display")})),(qe=document.getElementById("appointment-service-select"))==null||qe.addEventListener("change",async ee=>{ee.target.value;const de=ee.target.options[ee.target.selectedIndex];de==null||de.dataset.duration;const Le=document.getElementById("appointment-start-date");Le!=null&&Le.value&&await ce(Le.value,"new"),oe()}),(L=document.getElementById("appointment-contact-select"))==null||L.addEventListener("change",()=>{oe()}),(F=document.getElementById("appointment-clear-time-btn"))==null||F.addEventListener("click",()=>{Ie("new");const ee=document.getElementById("appointment-start-date");ee!=null&&ee.value&&ce(ee.value,"new")}),(P=document.getElementById("close-appointment-details-modal-btn"))==null||P.addEventListener("click",()=>{te()}),(j=document.getElementById("cancel-appointment-details-btn"))==null||j.addEventListener("click",()=>{te()}),(se=document.getElementById("save-appointment-details-btn"))==null||se.addEventListener("click",()=>{ne()}),(fe=document.getElementById("delete-appointment-btn"))==null||fe.addEventListener("click",()=>{be()});const s=document.getElementById("appointment-details-start-date"),r=document.getElementById("appointment-details-date-wrapper");s&&r&&(r.addEventListener("click",ee=>{var de;ee.preventDefault(),ee.stopPropagation(),s.focus(),(de=s.showPicker)==null||de.call(s)}),s.addEventListener("change",async ee=>{const de=ee.target.value;_e("appointment-details-start-date","appointment-details-date-display"),de&&await ce(de,"details")}),s.addEventListener("focus",()=>{}),s.addEventListener("blur",()=>{_e("appointment-details-start-date","appointment-details-date-display")})),(ge=document.getElementById("appointment-details-service-select"))==null||ge.addEventListener("change",async ee=>{ee.target.value;const de=ee.target.options[ee.target.selectedIndex];de==null||de.dataset.duration;const Le=document.getElementById("appointment-details-start-date");Le!=null&&Le.value&&await ce(Le.value,"details"),re()}),(ye=document.getElementById("appointment-details-contact-select"))==null||ye.addEventListener("change",()=>{re()}),(Ce=document.getElementById("appointment-details-clear-time-btn"))==null||Ce.addEventListener("click",()=>{Ie("details");const ee=document.getElementById("appointment-details-start-date");ee!=null&&ee.value&&ce(ee.value,"details")}),(Ue=document.getElementById("appointments-config-btn"))==null||Ue.addEventListener("click",()=>{D()}),(je=document.getElementById("appointments-config-btn-week"))==null||je.addEventListener("click",()=>{D()}),(Ae=document.getElementById("close-appointments-config-modal-btn"))==null||Ae.addEventListener("click",()=>{c()}),(Oe=document.getElementById("cancel-appointments-config-btn"))==null||Oe.addEventListener("click",()=>{c()}),(C=document.getElementById("save-appointments-config-btn"))==null||C.addEventListener("click",()=>{f()}),(T=document.getElementById("refresh-hours-btn"))==null||T.addEventListener("click",async()=>{const ee=await window.getUserId();ee&&await g(ee)}),(R=document.getElementById("open-full-settings-btn"))==null||R.addEventListener("click",()=>{c();const ee=document.querySelector('[data-target="settings"]');ee&&ee.click()}),(K=document.getElementById("open-products-btn"))==null||K.addEventListener("click",()=>{c();const ee=document.querySelector('[data-target="products"]');ee&&ee.click()})}async function A(){var u,l,s,r;try{const w=document.getElementById("appointments-container"),a=document.getElementById("appointments-loader"),i=document.getElementById("appointments-list"),y=document.getElementById("appointments-empty");if(!w||!a||!i||!y)return;a.classList.remove("hidden"),i.classList.add("hidden"),y.classList.add("hidden");const d=await window.getUserId();if(!d)throw new Error("No se pudo obtener el ID del usuario");const E=((u=document.getElementById("appointments-filter-status"))==null?void 0:u.value)||"all",h=(l=document.getElementById("appointments-filter-date"))==null?void 0:l.value;let x=e.from("meetings").select(`
                    *,
                    contacts:contact_id (
                        id,
                        full_name,
                        phone_number
                    ),
                    appointment_types:appointment_type_id (
                        id,
                        name,
                        duration_minutes
                    ),
                    products:product_id (
                        id,
                        product_name,
                        service_duration_minutes
                    )
                `).eq("user_id",d).order("start_time",{ascending:!0});if(E!=="all"&&(x=x.eq("status",E)),h){const V=new Date(h);V.setHours(0,0,0,0);const pe=new Date(h);pe.setHours(23,59,59,999),x=x.gte("start_time",V.toISOString()).lte("start_time",pe.toISOString())}let{data:S,error:$}=await x;if($&&$.code==="PGRST200"&&((s=$.message)!=null&&s.includes("product_id"))){console.warn("[Appointments] Relación con productos no disponible, cargando sin productos"),x=e.from("meetings").select(`
                        *,
                        contacts:contact_id (
                            id,
                            full_name,
                            phone_number
                        ),
                        appointment_types:appointment_type_id (
                            id,
                            name,
                            duration_minutes
                        )
                    `).eq("user_id",d).order("start_time",{ascending:!0});const V=await x;S=V.data,$=V.error}if($)throw $;a.classList.add("hidden");const G=[],Z=new Set;if(S)for(const V of S)V&&V.id&&!Z.has(V.id)&&(Z.add(V.id),G.push(V));if(p=G,console.log("[Appointments] Citas cargadas:",p.length,"citas (después de eliminar duplicados)"),!S||S.length===0){y.classList.remove("hidden"),U();return}U(),console.log("[Appointments] Calendario renderizado con",p.length,"citas")}catch(w){console.error("[Appointments] Error al cargar citas:",w);const a=document.getElementById("appointments-loader");a&&(a.innerHTML=`
                    <div class="text-center text-red-500 p-8">
                        <i data-lucide="alert-circle" class="w-8 h-8 mx-auto mb-2"></i>
                        <p>Error al cargar las citas. Intenta nuevamente.</p>
                    </div>
                `,lucide.createIcons()),(r=window.showToast)==null||r.call(window,"Error al cargar las citas","error")}}function N(u){t=u;const l=document.getElementById("calendar-view-month-btn"),s=document.getElementById("calendar-view-week-btn");l&&s&&(u==="month"?(l.classList.remove("text-slate-700","hover:text-slate-900"),l.classList.add("bg-green-600","text-white","shadow-sm"),s.classList.remove("bg-green-600","text-white","shadow-sm"),s.classList.add("text-slate-700","hover:text-slate-900")):(s.classList.remove("text-slate-700","hover:text-slate-900"),s.classList.add("bg-green-600","text-white","shadow-sm"),l.classList.remove("bg-green-600","text-white","shadow-sm"),l.classList.add("text-slate-700","hover:text-slate-900"))),U()}function H(u){t==="month"?n.setMonth(n.getMonth()+u):n.setDate(n.getDate()+u*7),U()}function U(){const u=document.getElementById("calendar-month-view"),l=document.getElementById("calendar-week-view"),s=document.getElementById("appointments-empty"),r=document.getElementById("appointments-loader");r&&r.classList.add("hidden"),s&&s.classList.add("hidden"),t==="month"?(u&&u.classList.remove("hidden"),l&&l.classList.add("hidden"),X()):(l&&l.classList.remove("hidden"),u&&u.classList.add("hidden"),Ee())}function X(){const u=document.getElementById("calendar-month-grid"),l=document.getElementById("calendar-month-title");if(!u||!l)return;const s=n.getFullYear(),r=n.getMonth();l.textContent=n.toLocaleDateString("es-ES",{month:"long",year:"numeric"});const w=new Date(s,r,1),a=new Date(s,r+1,0),i=w.getDay(),y=a.getDate(),d=new Date;d.setHours(0,0,0,0);let h=["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"].map(x=>`<div class="text-center font-semibold text-slate-700 py-2 text-sm">${x}</div>`).join("");for(let x=0;x<i;x++)h+='<div class="aspect-square"></div>';for(let x=1;x<=y;x++){const S=new Date(s,r,x),$=S.toISOString().split("T")[0],G=S<d,Z=$===d.toISOString().split("T")[0],V=new Set,pe=p.filter(O=>{if(!O||!O.start_time||!O.id||V.has(O.id))return!1;V.add(O.id);try{return new Date(O.start_time).toISOString().split("T")[0]===$}catch(Be){return console.warn("[Appointments] Error al procesar fecha de cita:",Be,O),!1}});let we="aspect-square border border-slate-300 rounded-lg p-1.5 overflow-y-auto relative transition-all duration-200",ie=!1;G?we+=" bg-slate-100 opacity-50 cursor-not-allowed":Z?(we+=" bg-green-50 border-green-500 border-2 cursor-pointer hover:bg-green-100 hover:shadow-md",ie=!0):(we+=" bg-white hover:bg-slate-50 hover:border-green-400 hover:shadow-sm cursor-pointer",ie=!0),h+=`
                <div class="${we}" ${ie?`data-calendar-day data-date="${$}"`:""}>
                    <div class="flex items-center justify-between mb-0.5">
                        <div class="text-xs font-semibold ${Z?"text-green-700":"text-slate-700"}">${x}</div>
                        ${ie?`<button class="calendar-add-btn w-4 h-4 rounded-full bg-green-600 text-white text-[10px] flex items-center justify-center hover:bg-green-700 transition" data-date="${$}" title="Agregar cita">
                            <i data-lucide="plus" class="w-2.5 h-2.5"></i>
                        </button>`:""}
                    </div>
                    <div class="space-y-0.5">
                        ${pe.slice(0,3).map(O=>{var je,Ae,Oe,C,T;if(!O)return"";const Be=new Date(O.start_time),qe=b(Be),L=((je=O.summary)==null?void 0:je.includes("Cita vía Elina IA"))||((Ae=O.summary)==null?void 0:Ae.includes("Elina IA"))||((Oe=O.metadata)==null?void 0:Oe.created_by_ai)===!0||((C=O.metadata)==null?void 0:C.source)==="ai",F={pending:"bg-yellow-100 text-yellow-800 border-yellow-300",confirmed:"bg-green-100 text-green-800 border-green-300",completed:"bg-blue-100 text-blue-800 border-blue-300",cancelled:"bg-red-100 text-red-800 border-red-300"},P=O.confirmation_status||"draft",se={draft:"📝",pending:"⏳",confirmed:"✅",cancelled:"❌"}[P]||"",ge=L?"bg-pink-100 text-pink-800 border-pink-300":F[O.status]||"bg-slate-100 border-slate-300",ye=O.summary||((T=O.products)==null?void 0:T.product_name)||"Cita",Ce=ye.length>15?ye.substring(0,15)+"...":ye;return`
                                <div class="text-[10px] p-0.5 rounded border ${ge} truncate font-medium cursor-pointer hover:opacity-80 transition-opacity" title="${qe} ${ye} - ${P==="draft"?"Borrador":P==="pending"?"Esperando confirmación":P==="confirmed"?"Confirmado":"Cancelado"}" data-appointment-id="${O.id||""}">
                                    ${se} ${qe} ${Ce}
                                </div>
                            `}).filter(O=>O).join("")}
                        ${pe.length>3?`<div class="text-[10px] text-slate-500">+${pe.length-3}</div>`:""}
                    </div>
                </div>
            `}u.innerHTML=h,lucide.createIcons(),u.querySelectorAll("[data-calendar-day]").forEach(x=>{x.addEventListener("click",S=>{if(S.target.closest(".calendar-add-btn"))return;const $=x.dataset.date;$&&me($,null)})}),u.querySelectorAll(".calendar-add-btn").forEach(x=>{x.addEventListener("click",S=>{S.stopPropagation();const $=x.dataset.date;$&&me($,null)})}),u.querySelectorAll("[data-appointment-id]").forEach(x=>{x.addEventListener("click",S=>{S.stopPropagation();const $=x.dataset.appointmentId;$&&ue($)})})}function Ee(){const u=document.getElementById("calendar-week-grid"),l=document.getElementById("calendar-week-title");if(!u||!l)return;const s=new Date(n),r=s.getDay(),w=s.getDate()-r+(r===0?-6:1),a=new Date(s.setDate(w));a.setHours(0,0,0,0);const i=new Date(a);i.setDate(a.getDate()+6),l.textContent=`${a.toLocaleDateString("es-ES",{day:"numeric",month:"short"})} - ${i.toLocaleDateString("es-ES",{day:"numeric",month:"short",year:"numeric"})}`;const y=[];for(let h=8;h<=20;h++)y.push(h);const d=["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"];let E='<div class="font-semibold text-slate-600 py-2 border-b">Hora</div>';for(let h=0;h<7;h++){const x=new Date(a);x.setDate(a.getDate()+h);const S=x.toISOString().split("T")[0]===new Date().toISOString().split("T")[0];E+=`
                <div class="font-semibold text-slate-600 py-2 border-b text-center ${S?"bg-green-50":""}">
                    <div>${d[h]}</div>
                    <div class="text-lg ${S?"text-green-700":"text-slate-700"}">${x.getDate()}</div>
                </div>
            `}y.forEach(h=>{E+=`<div class="text-xs text-slate-500 py-2 border-r border-b">${h.toString().padStart(2,"0")}:00</div>`;for(let x=0;x<7;x++){const S=new Date(a);S.setDate(a.getDate()+x),S.setHours(h,0,0,0);const $=new Set,G=p.filter(ie=>{if(!ie||!ie.start_time||!ie.end_time||!ie.id||$.has(ie.id))return!1;$.add(ie.id);try{const O=new Date(ie.start_time),Be=new Date(ie.end_time);return O<=S&&Be>S}catch(O){return console.warn("[Appointments] Error al procesar fecha/hora de cita:",O,ie),!1}});let Z="min-h-[60px] border-r border-b p-1 relative";const V=S<new Date,pe=S.toISOString().split("T")[0],we=`${h.toString().padStart(2,"0")}:00`;V?Z+=" bg-slate-50 opacity-60":Z+=" bg-white hover:bg-green-50 cursor-pointer group",E+=`
                    <div class="${Z}" ${V?"":`data-calendar-slot data-date="${pe}" data-time="${we}"`}>
                        ${G.map(ie=>{var ye,Ce,Ue,je,Ae;if(!ie)return"";const O=new Date(ie.start_time),Be=((ye=ie.summary)==null?void 0:ye.includes("Cita vía Elina IA"))||((Ce=ie.summary)==null?void 0:Ce.includes("Elina IA"))||((Ue=ie.metadata)==null?void 0:Ue.created_by_ai)===!0||((je=ie.metadata)==null?void 0:je.source)==="ai",qe={pending:"bg-yellow-100 text-yellow-800 border-yellow-300",confirmed:"bg-green-100 text-green-800 border-green-300",completed:"bg-blue-100 text-blue-800 border-blue-300",cancelled:"bg-red-100 text-red-800 border-red-300"},L=ie.confirmation_status||"draft",P={draft:"📝",pending:"⏳",confirmed:"✅",cancelled:"❌"}[L]||"",se=Be?"bg-pink-100 text-pink-800 border-pink-300":qe[ie.status]||"bg-slate-100",fe=ie.summary||((Ae=ie.products)==null?void 0:Ae.product_name)||"Cita";return`
                                <div class="text-xs p-1 rounded border ${se} mb-1 cursor-pointer hover:opacity-80 transition-opacity" title="${fe} - ${L==="draft"?"Borrador":L==="pending"?"Esperando confirmación":L==="confirmed"?"Confirmado":"Cancelado"}" data-appointment-id="${ie.id||""}">
                                    ${P} ${b(O)} ${fe}
                                    </div>
                            `}).filter(ie=>ie).join("")}
                        ${!V&&G.length===0?`
                            <div class="opacity-0 group-hover:opacity-100 transition absolute inset-0 flex items-center justify-center pointer-events-none">
                                <button class="calendar-slot-add-btn w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center hover:bg-green-700 shadow-lg pointer-events-auto" data-date="${pe}" data-time="${we}" title="Agregar cita a las ${we}">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                                </div>
                        `:""}
                    </div>
                `}}),u.innerHTML=E,lucide.createIcons(),u.addEventListener("click",h=>{const x=h.target.closest("[data-calendar-slot]");if(x&&!x.classList.contains("opacity-60")){const S=x.dataset.date,$=x.dataset.time;S&&$&&me(S,$)}}),u.querySelectorAll(".calendar-slot-add-btn").forEach(h=>{h.addEventListener("click",x=>{x.stopPropagation();const S=h.dataset.date,$=h.dataset.time;S&&$&&me(S,$)})}),u.querySelectorAll("[data-appointment-id]").forEach(h=>{h.addEventListener("click",x=>{x.stopPropagation();const S=h.dataset.appointmentId;S&&ue(S)})})}async function me(u=null,l=null){var d;const s=document.getElementById("new-appointment-modal");if(!s)return;const r=await window.getUserId();if(!r){(d=window.showToast)==null||d.call(window,"No se pudo obtener el ID del usuario","error");return}try{const{data:E,error:h}=await e.from("contacts").select("id, full_name, phone_number").eq("user_id",r).order("full_name",{ascending:!0}),x=document.getElementById("appointment-contact-select");x&&(x.innerHTML='<option value="">Sin contacto</option>',E&&!h&&E.forEach(S=>{const $=document.createElement("option");$.value=S.id,$.textContent=`${S.full_name||"Sin nombre"}${S.phone_number?` (${S.phone_number})`:""}`,x.appendChild($)}))}catch(E){console.error("[Appointments] Error al cargar contactos:",E)}try{const{data:E,error:h}=await e.from("products").select("id, product_name, service_duration_minutes").eq("user_id",r).eq("product_type","service").order("product_name",{ascending:!0}),x=document.getElementById("appointment-service-select");x&&(x.innerHTML='<option value="">Sin servicio</option>',E&&!h&&E.forEach(S=>{const $=document.createElement("option");$.value=S.id,$.textContent=`${S.product_name} (${S.service_duration_minutes} min)`,$.dataset.duration=S.service_duration_minutes,x.appendChild($)}))}catch(E){console.error("[Appointments] Error al cargar servicios:",E)}let w;if(u)w=u;else{const E=new Date;E.setDate(E.getDate()+1),w=E.toISOString().split("T")[0]}const a=w,i=l||null,y=document.getElementById("appointment-start-date");if(y){const E=new Date().toISOString().split("T")[0];y.setAttribute("min",E),y.value=a,_e("appointment-start-date","appointment-date-display")}if(document.getElementById("appointment-end-date").value=a,Ie("new"),document.getElementById("appointment-start-time").value="",document.getElementById("appointment-end-time").value="",i){const[E,h]=i.split(":"),x=new Date;x.setHours(parseInt(E)+1,parseInt(h),0,0);const S=x.toTimeString().slice(0,5);Y(i,S,"new")}else u&&await ce(a,"new");document.getElementById("appointment-title").value="",document.getElementById("appointment-contact-select").value="",document.getElementById("appointment-service-select").value="",document.getElementById("appointment-status").value="confirmed",document.getElementById("appointment-notes").value="",s.classList.remove("hidden"),typeof lucide<"u"&&lucide.createIcons()}function W(){const u=document.getElementById("new-appointment-modal");u&&u.classList.add("hidden")}async function ue(u){var h,x,S,$,G,Z;const l=document.getElementById("appointment-details-modal");if(!l)return;let s=p.find(V=>V.id===u);if(!s){console.log("[Appointments] Cita no encontrada en appointmentsData, cargando desde la base de datos...",u);const V=await window.getUserId();if(!V){(h=window.showToast)==null||h.call(window,"No se pudo obtener el ID del usuario","error");return}try{const{data:pe,error:we}=await e.from("meetings").select(`
                        *,
                        contacts:contact_id (
                            id,
                            full_name,
                            phone_number
                        ),
                        products:product_id (
                            id,
                            product_name,
                            service_duration_minutes
                        )
                    `).eq("id",u).eq("user_id",V).single();if(we){console.error("[Appointments] Error al cargar cita desde la base de datos:",we),(x=window.showToast)==null||x.call(window,"No se encontró la cita en la base de datos","error");return}if(!pe){(S=window.showToast)==null||S.call(window,"No se encontró la cita","error");return}s=pe,console.log("[Appointments] Cita cargada exitosamente desde la base de datos:",s);const ie=p.findIndex(O=>O.id===u);ie>=0?p[ie]=s:p.push(s)}catch(pe){console.error("[Appointments] Error al cargar cita:",pe),($=window.showToast)==null||$.call(window,"Error al cargar la cita. Intenta nuevamente.","error");return}}if(!s){(G=window.showToast)==null||G.call(window,"No se encontró la cita","error");return}const r=await window.getUserId();if(!r){(Z=window.showToast)==null||Z.call(window,"No se pudo obtener el ID del usuario","error");return}try{const{data:V,error:pe}=await e.from("contacts").select("id, full_name, phone_number").eq("user_id",r).order("full_name",{ascending:!0}),we=document.getElementById("appointment-details-contact-select");we&&(we.innerHTML='<option value="">Sin contacto</option>',V&&!pe&&V.forEach(ie=>{const O=document.createElement("option");O.value=ie.id,O.textContent=`${ie.full_name||"Sin nombre"}${ie.phone_number?` (${ie.phone_number})`:""}`,s.contact_id&&ie.id===s.contact_id&&(O.selected=!0),we.appendChild(O)}))}catch(V){console.error("[Appointments] Error al cargar contactos:",V)}try{const{data:V,error:pe}=await e.from("products").select("id, product_name, service_duration_minutes").eq("user_id",r).eq("product_type","service").order("product_name",{ascending:!0}),we=document.getElementById("appointment-details-service-select");we&&(we.innerHTML='<option value="">Sin servicio</option>',V&&!pe&&V.forEach(ie=>{const O=document.createElement("option");O.value=ie.id,O.textContent=`${ie.product_name} (${ie.service_duration_minutes} min)`,O.dataset.duration=ie.service_duration_minutes,s.product_id&&ie.id===s.product_id&&(O.selected=!0),we.appendChild(O)}))}catch(V){console.error("[Appointments] Error al cargar servicios:",V)}document.getElementById("appointment-details-id").value=s.id,document.getElementById("appointment-details-title").value=s.summary||"";const w=new Date(s.start_time),a=new Date(s.end_time),i=w.toISOString().split("T")[0],y=w.toTimeString().slice(0,5),d=a.toTimeString().slice(0,5),E=document.getElementById("appointment-details-start-date");if(E){const V=new Date().toISOString().split("T")[0];E.setAttribute("min",V),E.value=i,_e("appointment-details-start-date","appointment-details-date-display")}document.getElementById("appointment-details-end-date").value=a.toISOString().split("T")[0],Y(y,d,"details"),document.getElementById("appointment-details-status").value=s.status||"confirmed",document.getElementById("appointment-details-notes").value=s.notes||"",l.classList.remove("hidden"),lucide.createIcons()}function te(){const u=document.getElementById("appointment-details-modal");u&&u.classList.add("hidden")}function re(){var i,y;const u=document.getElementById("appointment-details-title"),l=document.getElementById("appointment-details-service-select"),s=document.getElementById("appointment-details-contact-select");if(!u||!l||!s)return;const r=u.value.trim(),w=l.value,a=s.value;if(w&&a){const d=l.options[l.selectedIndex],E=((i=d==null?void 0:d.textContent)==null?void 0:i.split(" (")[0])||"Servicio",h=s.options[s.selectedIndex],x=((y=h==null?void 0:h.textContent)==null?void 0:y.split(" (")[0])||"Contacto";(!r||r.includes(" - ")||r==="")&&(u.value=`${E} - ${x}`)}}async function ne(){var Z,V,pe,we,ie,O,Be,qe;const u=await window.getUserId();if(!u){(Z=window.showToast)==null||Z.call(window,"No se pudo obtener el ID del usuario","error");return}const l=document.getElementById("appointment-details-id").value;if(!l){(V=window.showToast)==null||V.call(window,"No se encontró el ID de la cita","error");return}const s=document.getElementById("appointment-details-title").value,r=document.getElementById("appointment-details-start-date").value,w=document.getElementById("appointment-details-start-time").value,a=document.getElementById("appointment-details-end-date").value,i=document.getElementById("appointment-details-end-time").value,y=document.getElementById("appointment-details-contact-select").value,d=document.getElementById("appointment-details-service-select").value,E=document.getElementById("appointment-details-status").value,h=document.getElementById("appointment-details-notes").value;if(!s||!r||!w||!a||!i){(pe=window.showToast)==null||pe.call(window,"Por favor completa todos los campos requeridos","error");return}const x=new Date(`${r}T${w}`),S=new Date(`${a}T${i}`);if(S<=x){(we=window.showToast)==null||we.call(window,"La fecha/hora de fin debe ser posterior a la de inicio","error");return}const $=document.getElementById("save-appointment-details-btn"),G=$.textContent;$.disabled=!0,$.textContent="Guardando...";try{const{data:L,error:F}=await e.from("appointment_settings").select("max_appointments_per_day, buffer_time_minutes").eq("user_id",u).eq("is_enabled",!0).maybeSingle(),P=L;if(!F&&P){if(P.max_appointments_per_day){const ye=r,Ce=new Date(ye);Ce.setHours(0,0,0,0);const Ue=new Date(ye);Ue.setHours(23,59,59,999);const{count:je}=await e.from("meetings").select("*",{count:"exact",head:!0}).eq("user_id",u).neq("id",l).gte("start_time",Ce.toISOString()).lte("start_time",Ue.toISOString()).in("status",["confirmed","pending"]);if(je>=P.max_appointments_per_day){(ie=window.showToast)==null||ie.call(window,`Has alcanzado el límite de ${P.max_appointments_per_day} citas por día.`,"error"),$.disabled=!1,$.textContent=G;return}}const j=P.buffer_time_minutes||0,se=new Date(x);se.setMinutes(se.getMinutes()-j);const fe=new Date(S);fe.setMinutes(fe.getMinutes()+j);const{data:ge}=await e.from("meetings").select("id, summary, start_time, end_time").eq("user_id",u).neq("id",l).in("status",["confirmed","pending"]);if(ge&&ge.filter(Ce=>{const Ue=new Date(Ce.start_time),je=new Date(Ce.end_time);return x<je&&S>Ue||x>=Ue&&x<new Date(Ue.getTime()+j*6e4)||S>je&&S<=new Date(je.getTime()+j*6e4)}).length>0){(O=window.showToast)==null||O.call(window,"Este horario entra en conflicto con una cita existente o está muy cerca de otra (buffer time).","error"),$.disabled=!1,$.textContent=G;return}}}catch(L){console.warn("[Appointments] Error en validación previa:",L)}try{const{data:L,error:F}=await e.from("meetings").update({contact_id:y||null,product_id:d||null,summary:s,start_time:x.toISOString(),end_time:S.toISOString(),status:E,notes:h||null}).eq("id",l).eq("user_id",u).select().single();if(F)throw F;console.log("[Appointments] Cita actualizada exitosamente:",L),(Be=window.showToast)==null||Be.call(window,"Cita actualizada exitosamente","success"),te(),await A(),console.log("[Appointments] Citas recargadas después de actualizar. Total:",p.length)}catch(L){console.error("[Appointments] Error al actualizar cita:",L),(qe=window.showToast)==null||qe.call(window,"Error al actualizar la cita. Intenta nuevamente.","error")}finally{$.disabled=!1,$.textContent=G}}async function be(){var i,y,d,E,h,x;const u=document.getElementById("appointment-details-id").value;if(!u){(i=window.showToast)==null||i.call(window,"No se encontró el ID de la cita","error");return}const l=p.find(S=>S.id===u);if(!l){(y=window.showToast)==null||y.call(window,"No se encontró la cita","error");return}if(!(await((d=window.appModal)==null?void 0:d.confirm(`¿Estás seguro de que deseas eliminar la cita "${l.summary||"Sin título"}"?`,"Confirmar eliminación"))||!1))return;const r=await window.getUserId();if(!r){(E=window.showToast)==null||E.call(window,"No se pudo obtener el ID del usuario","error");return}const w=document.getElementById("delete-appointment-btn"),a=w.textContent;w.disabled=!0,w.textContent="Eliminando...";try{const{error:S}=await e.from("meetings").delete().eq("id",u).eq("user_id",r);if(S)throw S;(h=window.showToast)==null||h.call(window,"Cita eliminada exitosamente","success"),te(),A()}catch(S){console.error("[Appointments] Error al eliminar cita:",S),(x=window.showToast)==null||x.call(window,"Error al eliminar la cita. Intenta nuevamente.","error")}finally{w.disabled=!1,w.textContent=a}}async function ce(u,l="new"){const s=await window.getUserId();if(!s||!u)return;const r=l==="details"?"appointment-details-":"appointment-",w=document.getElementById(`${r}time-slots-container`),a=document.getElementById(`${r}time-slots`);if(document.getElementById(`${r}selected-time-info`),!w||!a)return;const i=document.getElementById(`${r}service-select`),y=i==null?void 0:i.options[i==null?void 0:i.selectedIndex],d=y!=null&&y.dataset.duration?parseInt(y.dataset.duration):null;try{const{data:E}=await e.from("appointment_hours").select("id").eq("user_id",s).limit(1);(!E||E.length===0)&&(console.log("[Appointments] No hay horarios configurados, inicializando horarios por defecto..."),await k(s));const{data:h,error:x}=await e.rpc("get_available_slots",{p_user_id:s,p_date:u,p_appointment_type_id:null,p_duration_minutes:d});if(x){console.error("[Appointments] Error al cargar slots:",x),w.classList.add("hidden");return}const S=(h==null?void 0:h.available_slots)||[];if(S.length===0){const $=(h==null?void 0:h.error)||"No hay horarios disponibles";let G="";$.includes("No hours configured")||$.includes("Appointment system not enabled")?G=`
                        <div class="col-span-full p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex items-start gap-3">
                                <i data-lucide="alert-circle" class="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"></i>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-yellow-800 mb-2">No hay horarios configurados</p>
                                    <p class="text-xs text-yellow-700 mb-3">Para poder agendar citas, necesitas configurar tus horarios de atención.</p>
                                    <div class="bg-white p-3 rounded border border-yellow-300">
                                        <p class="text-xs font-semibold text-yellow-900 mb-1">📋 Cómo configurar tus horarios:</p>
                                        <ol class="text-xs text-yellow-800 space-y-1 ml-4 list-decimal">
                                            <li>Ve al panel de <strong>Configuración</strong> (ícono de engranaje en el menú lateral)</li>
                                            <li>Baja hasta la sección <strong>"Sistema de Citas y Calendario"</strong></li>
                                            <li>Activa el toggle <strong>"Activar sistema de citas"</strong> (esto mostrará las opciones de configuración)</li>
                                            <li>Dentro de la sección que aparece, baja hasta <strong>"Horarios de Atención"</strong></li>
                                            <li>Activa los días que atiendes marcando el checkbox <strong>"Disponible"</strong> para cada día</li>
                                            <li>Configura la hora de inicio y fin para cada día activado</li>
                                            <li>Haz clic en <strong>"Guardar Seguro"</strong> al final de la página</li>
                                        </ol>
                                        </div>
                                            </div>
                                    </div>
                                        </div>
                    `:$.includes("Maximum appointments")?G=`
                        <div class="col-span-full p-4 bg-red-50 border border-red-200 rounded-lg">
                            <div class="flex items-start gap-3">
                                <i data-lucide="alert-circle" class="w-5 h-5 text-red-600 mt-0.5 flex-shrink-0"></i>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-red-800 mb-1">Límite de citas alcanzado</p>
                                    <p class="text-xs text-red-700">Ya has alcanzado el número máximo de citas permitidas para este día.</p>
                                        </div>
                                </div>
                            </div>
                    `:G=`
                        <div class="col-span-full p-4 bg-slate-50 border border-slate-200 rounded-lg">
                            <div class="flex items-start gap-3">
                                <i data-lucide="calendar-x" class="w-5 h-5 text-slate-600 mt-0.5 flex-shrink-0"></i>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-slate-800 mb-1">No hay horarios disponibles</p>
                                    <p class="text-xs text-slate-700">No hay slots disponibles para esta fecha. Intenta con otra fecha o verifica tu configuración de horarios en <strong>Configuración → Sistema de Citas y Calendario</strong>.</p>
                        </div>
                        </div>
                    </div>
                    `,a.innerHTML=G,w.classList.remove("hidden"),typeof lucide<"u"&&lucide.createIcons();return}a.innerHTML=S.map($=>{const G=$.start||$.start_time,Z=$.end||$.end_time,V=b(G);return`
                    <button type="button" 
                            class="time-slot-btn px-4 py-2.5 text-sm font-semibold rounded-xl border-2 border-slate-200 bg-white text-slate-700 hover:bg-green-50 hover:border-green-500 hover:text-green-700 active:scale-95 transition-all duration-200 shadow-sm hover:shadow-md"
                            data-start="${G}"
                            data-end="${Z}"
                            data-duration="${$.duration_minutes||60}">
                        ${V}
                    </button>
                `}).join(""),a.querySelectorAll(".time-slot-btn").forEach($=>{$.addEventListener("click",()=>{Y($.dataset.start,$.dataset.end,l)})}),w.classList.remove("hidden")}catch(E){console.error("[Appointments] Error al cargar slots disponibles:",E),w.classList.add("hidden")}}function Y(u,l,s="new"){const r=s==="details"?"appointment-details-":"appointment-",w=document.getElementById(`${r}start-date`),a=document.getElementById(`${r}start-time`),i=document.getElementById(`${r}end-date`),y=document.getElementById(`${r}end-time`);document.getElementById(`${r}time-slots-container`);const d=document.getElementById(`${r}selected-time-info`);if(!w||!a||!i||!y)return;a.value=u,y.value=l,i.value=w.value,d&&d.classList.add("hidden");const E=document.getElementById(`${r}time-slots`);E&&E.querySelectorAll(".time-slot-btn").forEach(h=>{h.classList.remove("bg-green-600","text-white","border-green-600","shadow-lg"),h.classList.add("bg-white","text-slate-700","border-slate-200"),h.dataset.start===u&&(h.classList.remove("bg-white","text-slate-700","border-slate-200"),h.classList.add("bg-green-600","text-white","border-green-600","shadow-lg"))})}function Ie(u="new"){const l=u==="details"?"appointment-details-":"appointment-",s=document.getElementById(`${l}start-time`),r=document.getElementById(`${l}end-time`),w=document.getElementById(`${l}selected-time-info`),a=document.getElementById(`${l}time-slots-container`),i=document.getElementById(`${l}time-slots`);s&&(s.value=""),r&&(r.value=""),w&&w.classList.add("hidden"),a&&a.classList.remove("hidden"),i&&i.querySelectorAll(".time-slot-btn").forEach(y=>{y.classList.remove("bg-green-600","text-white","border-green-600","shadow-lg"),y.classList.add("bg-white","text-slate-700","border-slate-200")})}function _e(u,l){const s=document.getElementById(u),r=document.getElementById(l);if(!s||!r)return;const w=s.value;if(w){const a=new Date(w+"T00:00:00"),i=a.getDate(),d=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"][a.getMonth()],E=a.getFullYear();r.textContent=`${i} ${d} ${E}`,r.classList.remove("text-slate-400"),r.classList.add("text-black"),r.style.color="#000000",r.style.opacity="1",r.style.visibility="visible"}else r.textContent="Selecciona una fecha",r.classList.remove("text-black"),r.classList.add("text-slate-400"),r.style.opacity="1"}function oe(){var i,y;const u=document.getElementById("appointment-title"),l=document.getElementById("appointment-service-select"),s=document.getElementById("appointment-contact-select");if(!u||!l||!s)return;const r=u.value.trim(),w=l.value,a=s.value;if(w&&a){const d=l.options[l.selectedIndex],E=((i=d==null?void 0:d.textContent)==null?void 0:i.split(" (")[0])||"Servicio",h=s.options[s.selectedIndex],x=((y=h==null?void 0:h.textContent)==null?void 0:y.split(" (")[0])||"Contacto";(!r||r.includes(" - ")||r==="")&&(u.value=`${E} - ${x}`)}}async function ae(){var G,Z,V,pe,we,ie,O;const u=await window.getUserId();if(!u){(G=window.showToast)==null||G.call(window,"No se pudo obtener el ID del usuario","error");return}const l=document.getElementById("appointment-title").value,s=document.getElementById("appointment-start-date").value,r=document.getElementById("appointment-start-time").value,w=document.getElementById("appointment-end-date").value,a=document.getElementById("appointment-end-time").value,i=document.getElementById("appointment-contact-select").value,y=document.getElementById("appointment-service-select").value,d=document.getElementById("appointment-status").value,E=document.getElementById("appointment-notes").value;if(!l||!s||!r||!w||!a){(Z=window.showToast)==null||Z.call(window,"Por favor completa todos los campos requeridos","error");return}const h=new Date(`${s}T${r}`),x=new Date(`${w}T${a}`);if(x<=h){(V=window.showToast)==null||V.call(window,"La fecha/hora de fin debe ser posterior a la de inicio","error");return}const S=document.getElementById("save-appointment-btn"),$=S.textContent;S.disabled=!0,S.textContent="Guardando...";try{const{data:Be,error:qe}=await e.from("appointment_settings").select("max_appointments_per_day, buffer_time_minutes").eq("user_id",u).eq("is_enabled",!0).maybeSingle(),L=Be;if(!qe&&L){if(L.max_appointments_per_day){const fe=s,ge=new Date(fe);ge.setHours(0,0,0,0);const ye=new Date(fe);ye.setHours(23,59,59,999);const{count:Ce}=await e.from("meetings").select("*",{count:"exact",head:!0}).eq("user_id",u).gte("start_time",ge.toISOString()).lte("start_time",ye.toISOString()).in("status",["confirmed","pending"]);if(Ce>=L.max_appointments_per_day){(pe=window.showToast)==null||pe.call(window,`Has alcanzado el límite de ${L.max_appointments_per_day} citas por día.`,"error"),S.disabled=!1,S.textContent=$;return}}const F=L.buffer_time_minutes||0,P=new Date(h);P.setMinutes(P.getMinutes()-F);const j=new Date(x);j.setMinutes(j.getMinutes()+F);const{data:se}=await e.from("meetings").select("id, summary, start_time, end_time").eq("user_id",u).in("status",["confirmed","pending"]);if(se&&se.filter(ge=>{const ye=new Date(ge.start_time),Ce=new Date(ge.end_time);return h<Ce&&x>ye||h>=ye&&h<new Date(ye.getTime()+F*6e4)||x>Ce&&x<=new Date(Ce.getTime()+F*6e4)}).length>0){(we=window.showToast)==null||we.call(window,"Este horario entra en conflicto con una cita existente o está muy cerca de otra (buffer time).","error"),S.disabled=!1,S.textContent=$;return}}}catch(Be){console.warn("[Appointments] Error en validación previa:",Be)}if(i)try{const{data:Be,error:qe}=await e.from("contacts").select("id, full_name, phone_number").eq("id",i).single();if(!qe&&Be&&!Be.phone_number){const L=Be.full_name||"el contacto seleccionado";if(!confirm(`Advertencia: ${L} no tiene un número de teléfono registrado. Los recordatorios automáticos no se podrán enviar. ¿Deseas continuar de todas formas?`)){S.disabled=!1,S.textContent=$;return}}}catch(Be){console.warn("[Appointments] Error al verificar teléfono del contacto:",Be)}try{const{data:Be,error:qe}=await e.from("meetings").insert({user_id:u,contact_id:i||null,product_id:y||null,summary:l,start_time:h.toISOString(),end_time:x.toISOString(),status:d,notes:E||null,reminder_sent:!1,confirmation_status:"draft"}).select().single();if(qe)throw qe;console.log("[Appointments] Cita creada exitosamente:",Be),(ie=window.showToast)==null||ie.call(window,"Cita creada exitosamente","success"),W(),await A(),console.log("[Appointments] Citas recargadas después de crear nueva cita. Total:",p.length)}catch(Be){console.error("[Appointments] Error al crear cita:",Be),(O=window.showToast)==null||O.call(window,"Error al crear la cita. Intenta nuevamente.","error")}finally{S.disabled=!1,S.textContent=$}}async function D(){const u=document.getElementById("appointments-quick-config-modal");u&&(u.classList.remove("hidden"),await o())}function c(){const u=document.getElementById("appointments-quick-config-modal");u&&u.classList.add("hidden")}async function o(){var l;const u=await window.getUserId();if(u)try{const{data:s,error:r}=await e.from("appointment_settings").select("*").eq("user_id",u).maybeSingle();if(r&&r.code!=="PGRST116")throw r;if(s){const w=document.getElementById("quick-config-buffer-time"),a=document.getElementById("quick-config-max-per-day"),i=document.getElementById("quick-config-default-duration"),y=document.getElementById("quick-config-timezone");w&&(w.value=s.buffer_time_minutes||0),a&&(a.value=s.max_appointments_per_day||""),i&&(i.value=s.default_duration_minutes||60),y&&(y.value=s.timezone||"America/Mexico_City")}await m(u),await g(u)}catch(s){console.error("[Appointments] Error al cargar configuración rápida:",s),(l=window.showToast)==null||l.call(window,"Error al cargar la configuración","error")}}async function m(u){try{const{data:l,error:s}=await e.from("products").select("id, product_name, service_duration_minutes").eq("user_id",u).eq("product_type","service").not("service_duration_minutes","is",null);if(s)throw s;const{data:r,error:w}=await e.from("appointment_types").select("id, name, duration_minutes").eq("user_id",u).eq("is_active",!0).not("duration_minutes","is",null);if(w)throw w;const{data:a}=await e.from("appointment_settings").select("default_duration_minutes").eq("user_id",u).maybeSingle(),i=(a==null?void 0:a.default_duration_minutes)||60,y=[];l&&l.length>0&&l.forEach(h=>{h.service_duration_minutes&&y.push(h.service_duration_minutes)}),r&&r.length>0&&r.forEach(h=>{h.duration_minutes&&!y.includes(h.duration_minutes)&&y.push(h.duration_minutes)}),y.includes(i)||y.push(i);let d=15;if(y.length>0){const h=(x,S)=>{const $=(G,Z)=>Z===0?G:$(Z,G%Z);return x*S/$(x,S)};d=y[0];for(let x=1;x<y.length;x++)d=h(d,y[x]);d=Math.max(d,15)}const E=document.getElementById("quick-config-services-list");E&&(l&&l.length>0?E.innerHTML=l.map(h=>`
                        <div class="flex items-center justify-between py-1.5 px-2 bg-white rounded border border-slate-200 mb-1">
                            <span class="text-xs text-slate-700">${h.product_name}</span>
                            <span class="text-xs font-semibold text-slate-600">${h.service_duration_minutes} min</span>
                        </div>
                    `).join(""):E.innerHTML='<p class="text-xs text-slate-500 text-center py-2">No hay servicios configurados. Crea servicios en el panel de Productos.</p>')}catch(l){console.error("[Appointments] Error al cargar servicios:",l)}}async function g(u){try{const{data:l,error:s}=await e.from("appointment_hours").select("*").eq("user_id",u).order("day_of_week",{ascending:!0});if(s)throw s;const r=document.getElementById("quick-config-hours-container");if(!r)return;const w=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"],a={};l&&l.length>0&&l.forEach(i=>{a[i.day_of_week]=i}),r.innerHTML=w.map((i,y)=>{const d=a[y],E=(d==null?void 0:d.is_available)||y>=1&&y<=5,h=(d==null?void 0:d.start_time)||"09:00",x=(d==null?void 0:d.end_time)||"18:00";return`
                    <div class="flex items-center gap-3 p-2 bg-slate-50 rounded border border-slate-200">
                        <label class="flex items-center gap-2 cursor-pointer flex-1">
                            <input type="checkbox" class="hour-available-checkbox" data-day="${y}" ${E?"checked":""}>
                            <span class="text-sm font-medium text-slate-700 w-20">${i}</span>
                        </label>
                        <input type="time" class="hour-start-time form-input text-xs min-w-[160px]" data-day="${y}" value="${h}" ${E?"":"disabled"}>
                        <span class="text-xs text-slate-500">-</span>
                        <input type="time" class="hour-end-time form-input text-xs min-w-[160px]" data-day="${y}" value="${x}" ${E?"":"disabled"}>
                </div>
            `}).join(""),r.querySelectorAll(".hour-available-checkbox").forEach(i=>{i.addEventListener("change",y=>{const d=y.target.dataset.day,E=r.querySelector(`.hour-start-time[data-day="${d}"]`),h=r.querySelector(`.hour-end-time[data-day="${d}"]`);E&&(E.disabled=!y.target.checked),h&&(h.disabled=!y.target.checked)})}),typeof lucide<"u"&&lucide.createIcons({root:r})}catch(l){console.error("[Appointments] Error al cargar horarios:",l)}}async function k(u){try{const{data:l}=await e.from("appointment_hours").select("id").eq("user_id",u).limit(1);if(l&&l.length>0)return;const{data:s}=await e.from("appointment_settings").select("is_enabled").eq("user_id",u).maybeSingle();if(!s||!s.is_enabled){console.log("[Appointments] Sistema de citas no habilitado, no se inicializan horarios");return}const{data:r}=await e.from("profiles").select("work_start_hour, work_end_hour").eq("id",u).single(),w=(r==null?void 0:r.work_start_hour)||9,a=(r==null?void 0:r.work_end_hour)||18,i=`${String(w).padStart(2,"0")}:00`,y=`${String(a).padStart(2,"0")}:00`,d=[];for(let E=0;E<=6;E++)d.push({user_id:u,day_of_week:E,is_available:E>=1&&E<=5,start_time:i,end_time:y});d.length>0&&(await e.from("appointment_hours").insert(d),console.log("[Appointments] Horarios por defecto creados automáticamente (todos los días, Lunes-Viernes activos)"))}catch(l){console.error("[Appointments] Error al inicializar horarios por defecto:",l)}}async function f(){var r,w,a,i,y,d;const u=await window.getUserId();if(!u)return;const l=document.getElementById("save-appointments-config-btn"),s=l==null?void 0:l.textContent;l&&(l.disabled=!0,l.textContent="Guardando...");try{const E=parseInt((r=document.getElementById("quick-config-buffer-time"))==null?void 0:r.value)||0,h=(w=document.getElementById("quick-config-max-per-day"))!=null&&w.value?parseInt(document.getElementById("quick-config-max-per-day").value):null,x=parseInt((a=document.getElementById("quick-config-default-duration"))==null?void 0:a.value)||60,S=((i=document.getElementById("quick-config-timezone"))==null?void 0:i.value)||"America/Mexico_City",{error:$}=await e.from("appointment_settings").upsert({user_id:u,buffer_time_minutes:E,max_appointments_per_day:h,default_duration_minutes:x,timezone:S},{onConflict:"user_id"});if($)throw $;const G=document.querySelectorAll(".hour-available-checkbox"),Z=[];if(G.forEach(V=>{const pe=parseInt(V.dataset.day),we=document.querySelector(`.hour-start-time[data-day="${pe}"]`),ie=document.querySelector(`.hour-end-time[data-day="${pe}"]`);we&&ie&&Z.push({user_id:u,day_of_week:pe,is_available:V.checked,start_time:we.value||"09:00",end_time:ie.value||"18:00"})}),Z.length>0){await e.from("appointment_hours").delete().eq("user_id",u);const{error:V}=await e.from("appointment_hours").insert(Z);if(V)throw V}(y=window.showToast)==null||y.call(window,"Configuración guardada exitosamente","success"),c(),A()}catch(E){console.error("[Appointments] Error al guardar configuración:",E),(d=window.showToast)==null||d.call(window,"Error al guardar la configuración","error")}finally{l&&(l.disabled=!1,l.textContent=s)}}})();let Tt=[];document.addEventListener("panel:activated",async z=>{(z.detail.panelId==="auto-responses"||z.detail.tabId==="auto-responses")&&await Yt()});async function Yt(){const z=document.getElementById("auto-responses-content");if(!z)return;const e=await window.getUserId();if(!e){z.innerHTML='<p class="text-red-500">Error: No se pudo obtener el ID del usuario</p>';return}await Ft(e),At(z)}async function Ft(z){var e;try{const{data:t,error:n}=await window.auth.sb.from("auto_responses").select("*").eq("user_id",z).order("created_at",{ascending:!1});if(n)throw n;Tt=t||[],await en(z);const{data:p,error:b}=await window.auth.sb.from("auto_responses").select("*").eq("user_id",z).order("created_at",{ascending:!1});if(b)throw b;Tt=p||[]}catch(t){console.error("[Auto Responses] Error al cargar:",t),(e=window.showToast)==null||e.call(window,"Error al cargar respuestas automáticas","error")}}const Zt=[{trigger_text:"Hola, vi tu anuncio en Facebook",response_text:"¡Hola! Gracias por contactarnos. Estamos aquí para ayudarte. ¿En qué podemos asistirte hoy?",is_active:!1,match_type:"contains"},{trigger_text:"Información",response_text:"Con gusto te proporcionamos información. ¿Sobre qué producto o servicio te gustaría saber más?",is_active:!1,match_type:"contains"},{trigger_text:"Precio",response_text:"Nuestros precios varían según el producto. ¿Podrías decirme qué producto te interesa para darte un precio exacto?",is_active:!1,match_type:"contains"}];async function en(z){try{const e=new Set(Tt.map(n=>n.trigger_text.toLowerCase().trim())),t=[];for(const n of Zt){const p=n.trigger_text.toLowerCase().trim();e.has(p)||t.push(n)}if(t.length>0){const n=t.map(b=>({user_id:z,trigger_text:b.trigger_text,response_text:b.response_text,is_active:b.is_active,match_type:b.match_type})),{error:p}=await window.auth.sb.from("auto_responses").insert(n);p?console.error("[Auto Responses] Error al crear ejemplos por defecto:",p):console.log(`[Auto Responses] ${t.length} respuesta(s) por defecto creada(s)`)}}catch(e){console.error("[Auto Responses] Error al asegurar ejemplos predeterminados:",e)}}function At(z){z.innerHTML=`
        <div class="space-y-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl sm:text-3xl font-bold">Respuestas Programadas</h2>
                    <p class="text-slate-500 mt-1">Responde automáticamente cuando detecte estos mensajes</p>
                </div>
                <button id="add-auto-response-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> Agregar Respuesta
                </button>
            </div>

            <div id="auto-responses-list" class="space-y-4">
                ${Tt.map((e,t)=>tn(e)).join("")}
            </div>

            <div id="new-auto-response-form" class="hidden bg-white rounded-xl shadow-md p-6">
                <h3 class="text-xl font-bold mb-4">Nueva Respuesta Automática</h3>
                <form id="auto-response-form" class="space-y-4">
                    <div>
                        <label class="block font-medium mb-2">Espero este texto:</label>
                        <input type="text" id="trigger-text-input" class="form-input w-full" placeholder="Ej: Hola, vi tu anuncio" required>
                        <p class="text-xs text-slate-500 mt-1">El sistema buscará este texto en los mensajes entrantes</p>
                    </div>
                    <div>
                        <label class="block font-medium mb-2">Envío este texto:</label>
                        <textarea id="response-text-input" rows="4" class="form-input w-full" placeholder="Ej: ¡Hola! Gracias por contactarnos..." required></textarea>
                    </div>
                    <div>
                        <label class="block font-medium mb-2">Tipo de respuesta:</label>
                        <select id="media-type-input" class="form-input w-full">
                            <option value="text" selected>Solo texto</option>
                            <option value="image">Imagen</option>
                            <option value="video">Video</option>
                        </select>
                        <p class="text-xs text-slate-500 mt-1">Selecciona el tipo de contenido a enviar</p>
                    </div>
                    <div id="media-upload-container" class="hidden">
                        <label class="block font-medium mb-2">Archivo multimedia:</label>
                        <input type="file" id="media-file-input" class="form-input w-full" accept="image/*,video/*">
                        <p class="text-xs text-slate-500 mt-1">Sube una imagen o video</p>
                        <div id="media-preview" class="mt-2 hidden">
                            <div class="flex items-center gap-2 p-2 bg-slate-50 rounded">
                                <span id="media-preview-text" class="text-sm text-slate-600"></span>
                                <button type="button" id="remove-media-btn" class="text-red-500 hover:text-red-700">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        <div id="media-upload-progress" class="mt-2 hidden">
                            <div class="w-full bg-slate-200 rounded-full h-2">
                                <div id="media-progress-bar" class="bg-green-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">Subiendo archivo...</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="is-active-input" class="sr-only peer">
                            <div class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            <span class="ml-3 text-sm font-medium text-slate-700">Activar automáticamente</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <select id="match-type-input" class="form-input">
                                <option value="exact">Coincidencia exacta</option>
                                <option value="contains" selected>Contiene el texto</option>
                            </select>
                            <button type="button" id="help-match-type-btn" class="text-blue-500 hover:text-blue-700 p-1.5 rounded-full hover:bg-blue-50 transition-colors" title="¿Cómo funciona?">
                                <i data-lucide="help-circle" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" id="cancel-auto-response-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                        <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    `,window.lucide&&lucide.createIcons(),nn()}function tn(z,e){return z._editing===!0?`
            <div class="bg-white rounded-xl shadow-md p-6 border-2 border-blue-500" data-response-id="${z.id}">
                <h4 class="text-lg font-bold mb-4 text-blue-600">Editando Respuesta</h4>
                <form class="edit-auto-response-form space-y-4" data-response-id="${z.id}">
                    <div>
                        <label class="block font-medium mb-2">Espero este texto:</label>
                        <input type="text" class="edit-trigger-text form-input w-full" value="${zt(z.trigger_text)}" required>
                        <p class="text-xs text-slate-500 mt-1">El sistema buscará este texto en los mensajes entrantes</p>
                    </div>
                    <div>
                        <label class="block font-medium mb-2">Envío este texto:</label>
                        <textarea class="edit-response-text form-input w-full" rows="4" required>${zt(z.response_text)}</textarea>
                    </div>
                    <div>
                        <label class="block font-medium mb-2">Tipo de respuesta:</label>
                        <select class="edit-media-type form-input w-full" data-response-id="${z.id}">
                            <option value="text" ${z.media_type==="text"||!z.media_type?"selected":""}>Solo texto</option>
                            <option value="image" ${z.media_type==="image"?"selected":""}>Imagen</option>
                            <option value="video" ${z.media_type==="video"?"selected":""}>Video</option>
                        </select>
                    </div>
                    <div class="edit-media-upload-container ${z.media_type&&z.media_type!=="text"?"":"hidden"}">
                        <label class="block font-medium mb-2">Archivo multimedia:</label>
                        <input type="file" class="edit-media-file-input form-input w-full" data-response-id="${z.id}" accept="image/*,video/*">
                        ${z.media_url?`
                            <div class="mt-2 p-2 bg-slate-50 rounded">
                                <p class="text-xs text-slate-600">Archivo actual: <a href="${z.media_url}" target="_blank" class="text-blue-500 hover:underline">Ver archivo</a></p>
                            </div>
                        `:""}
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="edit-is-active sr-only peer" ${z.is_active?"checked":""}>
                            <div class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            <span class="ml-3 text-sm font-medium text-slate-700">Activar automáticamente</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <select class="edit-match-type form-input">
                                <option value="exact" ${z.match_type==="exact"?"selected":""}>Coincidencia exacta</option>
                                <option value="contains" ${z.match_type==="contains"?"selected":""}>Contiene el texto</option>
                            </select>
                            <button type="button" class="help-match-type-btn text-blue-500 hover:text-blue-700 p-1.5 rounded-full hover:bg-blue-50 transition-colors" title="¿Cómo funciona?">
                                <i data-lucide="help-circle" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 pt-2">
                        <button type="button" class="cancel-edit-btn bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg" data-response-id="${z.id}">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        `:`
        <div class="bg-white rounded-xl shadow-md p-6" data-response-id="${z.id}">
            <div class="flex items-start justify-between gap-4">
                <div class="flex-1 space-y-3">
                    <div class="flex items-center gap-3">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" ${z.is_active?"checked":""} 
                                   onchange="toggleAutoResponse(${z.id}, this.checked)">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            <span class="ml-3 text-sm font-medium text-slate-700">${z.is_active?"Activa":"Inactiva"}</span>
                        </label>
                        <span class="text-xs text-slate-500 px-2 py-1 bg-slate-100 rounded">
                            ${z.match_type==="exact"?"Coincidencia exacta":"Contiene"}
                        </span>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-600 mb-1">Espero este texto:</p>
                        <p class="text-slate-800 bg-slate-50 p-2 rounded">${zt(z.trigger_text)}</p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-600 mb-1">Envío este texto:</p>
                        <p class="text-slate-800 bg-slate-50 p-2 rounded">${zt(z.response_text)}</p>
                    </div>
                    ${z.media_type&&z.media_type!=="text"?`
                    <div>
                        <p class="text-sm font-semibold text-slate-600 mb-1">Tipo de media:</p>
                        <p class="text-slate-800 bg-slate-50 p-2 rounded">${z.media_type==="image"?"Imagen":z.media_type==="video"?"Video":z.media_type}</p>
                        ${z.media_url?`<a href="${z.media_url}" target="_blank" class="text-blue-500 hover:underline text-xs">Ver archivo</a>`:""}
                    </div>
                    `:""}
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="editAutoResponse(${z.id})" class="text-blue-500 hover:text-blue-700 p-2" title="Editar">
                        <i data-lucide="edit-2" class="w-5 h-5"></i>
                    </button>
                    <button onclick="deleteAutoResponse(${z.id})" class="text-red-500 hover:text-red-700 p-2" title="Eliminar">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    `}function nn(){var t,n,p,b,_;(t=document.getElementById("add-auto-response-btn"))==null||t.addEventListener("click",()=>{const B=document.getElementById("new-auto-response-form");B&&(B.classList.remove("hidden"),B.scrollIntoView({behavior:"smooth",block:"nearest"}))}),(n=document.getElementById("cancel-auto-response-btn"))==null||n.addEventListener("click",()=>{const B=document.getElementById("new-auto-response-form");B&&(B.classList.add("hidden"),B.reset())}),(p=document.getElementById("auto-response-form"))==null||p.addEventListener("submit",async B=>{B.preventDefault(),await on()}),document.addEventListener("submit",async B=>{if(B.target.classList.contains("edit-auto-response-form")){B.preventDefault();const A=parseInt(B.target.dataset.responseId);await sn(A)}}),document.addEventListener("click",B=>{if(B.target.closest(".cancel-edit-btn")){const A=B.target.closest(".cancel-edit-btn"),N=parseInt(A.dataset.responseId);an(N)}});const z=document.getElementById("media-type-input"),e=document.getElementById("media-upload-container");z&&e&&z.addEventListener("change",B=>{B.target.value!=="text"?e.classList.remove("hidden"):e.classList.add("hidden")}),document.addEventListener("change",B=>{var A;if(B.target.classList.contains("edit-media-type")){const N=(A=B.target.closest(".edit-auto-response-form"))==null?void 0:A.querySelector(".edit-media-upload-container");N&&(B.target.value!=="text"?N.classList.remove("hidden"):N.classList.add("hidden"))}}),(b=document.getElementById("remove-media-btn"))==null||b.addEventListener("click",()=>{document.getElementById("media-file-input").value="",document.getElementById("media-preview").classList.add("hidden")}),(_=document.getElementById("help-match-type-btn"))==null||_.addEventListener("click",()=>{Vt()}),document.addEventListener("click",B=>{B.target.closest(".help-match-type-btn")&&Vt()})}function Vt(){const z=document.createElement("div");z.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",z.innerHTML=`
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold text-slate-800">¿Cómo funcionan los tipos de coincidencia?</h3>
                    <button class="close-help-modal text-slate-400 hover:text-slate-600 p-1">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- Coincidencia Exacta -->
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                        <h4 class="font-bold text-lg text-blue-800 mb-3 flex items-center gap-2">
                            <i data-lucide="check-circle" class="w-5 h-5"></i>
                            Coincidencia Exacta
                        </h4>
                        <p class="text-slate-700 mb-3">
                            El mensaje del usuario debe ser <strong>exactamente igual</strong> al texto configurado (ignora mayúsculas/minúsculas y espacios al inicio/final).
                        </p>
                        <div class="bg-white rounded p-3 space-y-2 text-sm">
                            <div class="flex items-start gap-2">
                                <span class="text-green-600 font-bold">✅</span>
                                <div>
                                    <strong>Texto configurado:</strong> <code class="bg-slate-100 px-2 py-1 rounded">Hola</code><br>
                                    <strong>Mensaje:</strong> <code class="bg-slate-100 px-2 py-1 rounded">Hola</code> → <span class="text-green-600 font-semibold">Coincide</span>
                                </div>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-green-600 font-bold">✅</span>
                                <div>
                                    <strong>Texto configurado:</strong> <code class="bg-slate-100 px-2 py-1 rounded">Hola</code><br>
                                    <strong>Mensaje:</strong> <code class="bg-slate-100 px-2 py-1 rounded">hola</code> → <span class="text-green-600 font-semibold">Coincide</span> (ignora mayúsculas)
                                </div>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-red-600 font-bold">❌</span>
                                <div>
                                    <strong>Texto configurado:</strong> <code class="bg-slate-100 px-2 py-1 rounded">Hola</code><br>
                                    <strong>Mensaje:</strong> <code class="bg-slate-100 px-2 py-1 rounded">Hola, cómo estás?</code> → <span class="text-red-600 font-semibold">NO coincide</span> (tiene texto adicional)
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mt-2">
                            <strong>Cuándo usar:</strong> Para comandos específicos como "Sí", "No", "Cancelar", "Hola"
                        </p>
                    </div>

                    <!-- Contiene el texto -->
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                        <h4 class="font-bold text-lg text-green-800 mb-3 flex items-center gap-2">
                            <i data-lucide="search" class="w-5 h-5"></i>
                            Contiene el texto ⭐ <span class="text-sm font-normal text-green-700">(Recomendado)</span>
                        </h4>
                        <p class="text-slate-700 mb-3">
                            El mensaje del usuario debe <strong>contener</strong> el texto configurado en cualquier parte (ignora mayúsculas/minúsculas).
                        </p>
                        <div class="bg-white rounded p-3 space-y-2 text-sm">
                            <div class="flex items-start gap-2">
                                <span class="text-green-600 font-bold">✅</span>
                                <div>
                                    <strong>Texto configurado:</strong> <code class="bg-slate-100 px-2 py-1 rounded">vi tu anuncio</code><br>
                                    <strong>Mensaje:</strong> <code class="bg-slate-100 px-2 py-1 rounded">Hola, vi tu anuncio en Facebook</code> → <span class="text-green-600 font-semibold">Coincide</span>
                                </div>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-green-600 font-bold">✅</span>
                                <div>
                                    <strong>Texto configurado:</strong> <code class="bg-slate-100 px-2 py-1 rounded">vi tu anuncio</code><br>
                                    <strong>Mensaje:</strong> <code class="bg-slate-100 px-2 py-1 rounded">Vi tu anuncio</code> → <span class="text-green-600 font-semibold">Coincide</span>
                                </div>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-green-600 font-bold">✅</span>
                                <div>
                                    <strong>Texto configurado:</strong> <code class="bg-slate-100 px-2 py-1 rounded">vi tu anuncio</code><br>
                                    <strong>Mensaje:</strong> <code class="bg-slate-100 px-2 py-1 rounded">Hola vi tu anuncio</code> → <span class="text-green-600 font-semibold">Coincide</span>
                                </div>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-red-600 font-bold">❌</span>
                                <div>
                                    <strong>Texto configurado:</strong> <code class="bg-slate-100 px-2 py-1 rounded">vi tu anuncio</code><br>
                                    <strong>Mensaje:</strong> <code class="bg-slate-100 px-2 py-1 rounded">Hola, cómo estás?</code> → <span class="text-red-600 font-semibold">NO coincide</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mt-2">
                            <strong>Cuándo usar:</strong> Para la mayoría de casos. Es más flexible y captura variaciones naturales del mensaje.
                        </p>
                    </div>

                    <!-- Consejo -->
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                        <h4 class="font-bold text-lg text-yellow-800 mb-2 flex items-center gap-2">
                            <i data-lucide="lightbulb" class="w-5 h-5"></i>
                            💡 Consejo
                        </h4>
                        <p class="text-slate-700">
                            Usa <strong>"Contiene el texto"</strong> para la mayoría de casos. Es más flexible y captura variaciones naturales del mensaje que los usuarios pueden escribir.
                        </p>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button class="close-help-modal bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">
                        Entendido
                    </button>
                </div>
            </div>
        </div>
    `,document.body.appendChild(z),window.lucide&&lucide.createIcons();const e=()=>{z.remove()};z.querySelectorAll(".close-help-modal").forEach(t=>{t.addEventListener("click",e)}),z.addEventListener("click",t=>{t.target===z&&e()})}async function Wt(z,e,t){if(!z)return null;try{const n=z.name.replace(/[^a-zA-Z0-9._-]/g,"_"),p=`temp-uploads/${e}/auto-responses/${Date.now()}-${n}`,{error:b}=await window.auth.sb.storage.from("campaign_files").upload(p,z,{onUploadProgress:N=>{if(t){const H=Math.round(N.loaded/N.total*50);t(H)}}});if(b)throw new Error(`Error en subida: ${b.message}`);t&&t(60);const{data:_}=window.auth.sb.storage.from("campaign_files").getPublicUrl(p);t&&t(70);const{data:B,error:A}=await window.auth.invokeFunction("smart-worker",{body:{sourceUrl:_.publicUrl,userId:e,fileName:n,folder:"auto-responses"}});if(A)throw new Error(`Error al mover a CDN: ${A.message}`);return t&&t(90),await window.auth.sb.storage.from("campaign_files").remove([p]),t&&t(100),(B==null?void 0:B.cdnUrl)||null}catch(n){throw console.error("[Auto Responses] Error al subir archivo:",n),n}}async function on(){var B,A,N,H,U,X,Ee,me;const z=await window.getUserId();if(!z)return;const e=document.getElementById("trigger-text-input").value.trim(),t=document.getElementById("response-text-input").value.trim(),n=document.getElementById("is-active-input").checked,p=document.getElementById("match-type-input").value,b=document.getElementById("media-type-input").value,_=document.getElementById("media-file-input").files[0];if(!e||!t){(B=window.showToast)==null||B.call(window,"Por favor completa todos los campos","error");return}if(b!=="text"&&!_){(A=window.showToast)==null||A.call(window,"Por favor selecciona un archivo para el tipo de media seleccionado","error");return}try{let W=null;if(_){const re=document.getElementById("media-upload-progress"),ne=document.getElementById("media-progress-bar");re&&ne&&(re.classList.remove("hidden"),ne.style.width="0%");try{if(W=await Wt(_,z,be=>{ne&&(ne.style.width=`${be}%`)}),re&&re.classList.add("hidden"),!W)throw new Error("No se pudo obtener la URL del archivo")}catch(be){throw re&&re.classList.add("hidden"),be}}const{error:ue}=await window.auth.sb.from("auto_responses").insert({user_id:z,trigger_text:e,response_text:t,is_active:n,match_type:p,media_type:b,media_url:W});if(ue)throw ue;(N=window.showToast)==null||N.call(window,"Respuesta automática guardada correctamente","success"),await Ft(z);const te=document.getElementById("auto-responses-content");te&&At(te),(H=document.getElementById("new-auto-response-form"))==null||H.classList.add("hidden"),(U=document.getElementById("auto-response-form"))==null||U.reset(),(X=document.getElementById("media-upload-container"))==null||X.classList.add("hidden"),(Ee=document.getElementById("media-preview"))==null||Ee.classList.add("hidden")}catch(W){console.error("[Auto Responses] Error al guardar:",W),(me=window.showToast)==null||me.call(window,`Error al guardar: ${W.message}`,"error")}}window.toggleAutoResponse=async function(z,e){var t,n;try{const{error:p}=await window.auth.sb.from("auto_responses").update({is_active:e}).eq("id",z);if(p)throw p;(t=window.showToast)==null||t.call(window,e?"Respuesta automática activada":"Respuesta automática desactivada","success")}catch(p){console.error("[Auto Responses] Error al actualizar:",p),(n=window.showToast)==null||n.call(window,"Error al actualizar la respuesta automática","error")}};window.editAutoResponse=function(z){const e=Tt.find(t=>t.id===z);if(e){e._editing=!0;const t=document.getElementById("auto-responses-content");t&&At(t),window.lucide&&lucide.createIcons()}};function an(z){const e=Tt.find(t=>t.id===z);if(e){delete e._editing;const t=document.getElementById("auto-responses-content");t&&At(t),window.lucide&&lucide.createIcons()}}async function sn(z){var H,U,X,Ee,me;const e=document.querySelector(`.edit-auto-response-form[data-response-id="${z}"]`);if(!e)return;const t=e.querySelector(".edit-trigger-text").value.trim(),n=e.querySelector(".edit-response-text").value.trim(),p=e.querySelector(".edit-is-active").checked,b=e.querySelector(".edit-match-type").value,_=e.querySelector(".edit-media-type").value,B=e.querySelector(".edit-media-file-input"),A=B==null?void 0:B.files[0];if(!t||!n){(H=window.showToast)==null||H.call(window,"Por favor completa todos los campos","error");return}const N=Tt.find(W=>W.id===z);if(_!=="text"&&!A&&!(N!=null&&N.media_url)){(U=window.showToast)==null||U.call(window,"Por favor selecciona un archivo para el tipo de media seleccionado","error");return}try{const W=await window.getUserId();if(!W)return;let ue=(N==null?void 0:N.media_url)||null;if(A){const ne=e.querySelector(".media-upload-progress"),be=e.querySelector(".media-progress-bar");ne&&be&&(ne.classList.remove("hidden"),be.style.width="0%");try{if(ue=await Wt(A,W,ce=>{be&&(be.style.width=`${ce}%`)}),ne&&ne.classList.add("hidden"),!ue)throw new Error("No se pudo obtener la URL del archivo")}catch(ce){throw ne&&ne.classList.add("hidden"),ce}}if(_==="text"&&(ue=null),!Tt.find(ne=>ne.id===z)||!z||z==="new"){const{data:ne,error:be}=await window.auth.sb.from("auto_responses").insert({user_id:W,trigger_text:t,response_text:n,is_active:p,match_type:b,media_type:_,media_url:ue}).select().single();if(be)throw be;(X=window.showToast)==null||X.call(window,"Respuesta automática guardada correctamente","success")}else{const ne={trigger_text:t,response_text:n,is_active:p,match_type:b,media_type:_};(A||_==="text")&&(ne.media_url=ue);const{error:be}=await window.auth.sb.from("auto_responses").update(ne).eq("id",z);if(be)throw be;(Ee=window.showToast)==null||Ee.call(window,"Respuesta automática actualizada correctamente","success")}await Ft(W);const re=document.getElementById("auto-responses-content");re&&At(re)}catch(W){console.error("[Auto Responses] Error al actualizar:",W),(me=window.showToast)==null||me.call(window,`Error al guardar: ${W.message}`,"error")}}window.deleteAutoResponse=async function(z){var e,t;if(confirm("¿Estás seguro de que quieres eliminar esta respuesta automática?"))try{const{error:n}=await window.auth.sb.from("auto_responses").delete().eq("id",z);if(n)throw n;(e=window.showToast)==null||e.call(window,"Respuesta automática eliminada","success");const p=await window.getUserId();if(p){await Ft(p);const b=document.getElementById("auto-responses-content");b&&At(b)}}catch(n){console.error("[Auto Responses] Error al eliminar:",n),(t=window.showToast)==null||t.call(window,"Error al eliminar la respuesta automática","error")}};function zt(z){const e=document.createElement("div");return e.textContent=z,e.innerHTML}let $t="",qt=[];const rn=[/integr(ar|ación)/i,/conectar? con/i,/API|webhook|endpoint/i,/base de datos|database/i,/CRM|ERP|sistema externo/i,/cambiar? el? flujo/i,/antes de|después de/i,/automátic(o|amente)/i,/cálculo|calcular/i,/descuento automático/i,/logo|marca|branding/i,/tabla|formato diferente/i,/detectar cuando|detecte si/i,/reporte|resumen|estadísticas/i,/pago|cobro|transacción/i,/memoriz(ar|e) más/i,/recuerd(e|a) siempre/i,/otro idioma|traducir/i,/Instagram|Facebook|Telegram|Email/i,/múltiples canales/i];document.addEventListener("panel:activated",async z=>{(z.detail.panelId==="prompt-training"||z.detail.tabId==="prompt-training")&&await ln()});async function ln(){const z=document.getElementById("prompt-training-content");if(!z)return;const e=await window.getUserId();if(!e){z.innerHTML='<p class="text-red-500">Error: No se pudo obtener el ID del usuario</p>';return}await cn(e),await dn(),un(z)}async function cn(z){try{const{data:e,error:t}=await window.auth.sb.from("prompts").select("prompt_content").eq("user_id",z).single();if(t&&t.code!=="PGRST116")throw t;$t=(e==null?void 0:e.prompt_content)||""}catch(e){console.error("[Prompt Training] Error al cargar prompt:",e),$t=""}}async function dn(){}function un(z){z.innerHTML=`
        <div class="space-y-6">
            <div class="mb-6">
                <h2 class="text-2xl sm:text-3xl font-bold">Entrenamiento de Prompt</h2>
                <p class="text-slate-500 mt-1">Mejora y prueba el comportamiento de tu IA como en GPTs</p>
            </div>

            <!-- Vista dividida (Split View) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[calc(100vh-250px)]">
                <!-- Panel izquierdo: Editor de Prompt -->
                <div class="flex flex-col bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-bold mb-4">Editor de Prompt</h3>
                    
                    <div class="flex-1 flex flex-col space-y-4">
                        <div class="flex-1">
                            <label class="block font-medium mb-2">Prompt Actual:</label>
                            <textarea 
                                id="prompt-editor" 
                                rows="12" 
                                class="form-textarea w-full h-full resize-none font-mono text-sm"
                                placeholder="Tu prompt aparecerá aquí...">${Xt($t)}</textarea>
                        </div>
                        
                        <div>
                            <label class="block font-medium mb-2">Mejora esto:</label>
                            <textarea 
                                id="improvement-input" 
                                rows="3" 
                                class="form-textarea w-full"
                                placeholder="Ej: 'Quiero que conteste de forma más amigable' o 'Ahora contesta así cuando...'"></textarea>
                        </div>
                        
                        <div class="flex gap-2">
                            <button id="improve-prompt-btn" class="flex-1 bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2">
                                <i data-lucide="sparkles" class="w-4 h-4"></i> Mejorar con IA
                            </button>
                            <button id="upload-example-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                                <i data-lucide="upload" class="w-4 h-4"></i> Subir Ejemplo
                            </button>
                        </div>
                        
                        <div class="flex gap-2">
                            <button id="save-prompt-btn" class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">
                                Guardar Prompt
                            </button>
                            <button id="reset-prompt-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">
                                Restaurar Original
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Panel derecho: Chat de Simulación -->
                <div class="flex flex-col bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-bold mb-4">Chat de Simulación</h3>
                    
                    <div class="flex-1 flex flex-col space-y-4">
                        <!-- Área de mensajes -->
                        <div id="simulation-chat-messages" class="flex-1 overflow-y-auto space-y-4 p-4 bg-slate-50 rounded-lg min-h-[300px]">
                            <div class="text-center text-slate-500 text-sm">
                                <p>Inicia una conversación de prueba para ver cómo respondería tu IA</p>
                            </div>
                        </div>
                        
                        <!-- Input de mensaje -->
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="simulation-message-input" 
                                class="form-input flex-1" 
                                placeholder="Escribe un mensaje de prueba..."
                                onkeypress="if(event.key === 'Enter') window.sendSimulationMessage()">
                            <button 
                                id="send-simulation-btn" 
                                class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700"
                                onclick="window.sendSimulationMessage()">
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </button>
                        </div>
                        
                        <!-- Alerta de límite detectado -->
                        <div id="limit-alert" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5"></i>
                                <div class="flex-1">
                                    <p class="font-semibold text-yellow-800 mb-1">Límite del Sistema Detectado</p>
                                    <p class="text-sm text-yellow-700 mb-3">Lo siento, esto requiere desarrollo adicional. El sistema actual no puede realizar esta acción solo modificando el prompt.</p>
                                    <button 
                                        id="send-suggestion-btn" 
                                        class="bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-700 text-sm">
                                        Enviar como Sugerencia al Desarrollador
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Input oculto para subir archivos -->
        <input type="file" id="example-file-input" class="hidden" accept="image/*,.txt,.pdf">
    `,window.lucide&&lucide.createIcons(),mn()}function mn(){var z,e,t,n,p,b;(z=document.getElementById("improve-prompt-btn"))==null||z.addEventListener("click",async()=>{await pn()}),(e=document.getElementById("upload-example-btn"))==null||e.addEventListener("click",()=>{var _;(_=document.getElementById("example-file-input"))==null||_.click()}),(t=document.getElementById("example-file-input"))==null||t.addEventListener("change",async _=>{var A;const B=(A=_.target.files)==null?void 0:A[0];B&&await fn(B)}),(n=document.getElementById("save-prompt-btn"))==null||n.addEventListener("click",async()=>{await gn()}),(p=document.getElementById("reset-prompt-btn"))==null||p.addEventListener("click",async()=>{await hn()}),(b=document.getElementById("send-suggestion-btn"))==null||b.addEventListener("click",async()=>{await vn()})}async function pn(){var t,n,p,b,_,B,A,N,H,U,X,Ee;const z=document.getElementById("improvement-input").value.trim(),e=document.getElementById("prompt-editor").value;if(!z){(t=window.showToast)==null||t.call(window,"Por favor, describe cómo quieres mejorar el prompt","error");return}if(!e){(n=window.showToast)==null||n.call(window,"No hay un prompt para mejorar","error");return}try{(p=window.showToast)==null||p.call(window,"Mejorando prompt con IA...","info");const me=((_=(b=window.auth)==null?void 0:b.sb)==null?void 0:_.supabaseUrl)||"https://mytvwfbijlgbihlegmfg.supabase.co",W=((A=(B=window.auth)==null?void 0:B.sb)==null?void 0:A.supabaseKey)||((U=(H=(N=window.auth)==null?void 0:N.sb)==null?void 0:H.supabase)==null?void 0:U.supabaseKey)||"",ue=await fetch(`${me}/functions/v1/openai-proxy`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${W}`,apikey:W},body:JSON.stringify({prompt:`Prompt actual:

${e}

Instrucciones de mejora: ${z}

Mejora el prompt siguiendo estas instrucciones. Devuelve SOLO el prompt mejorado, sin explicaciones adicionales.`,systemInstruction:"Eres un experto en optimización de prompts para asistentes de IA conversacionales. Tu tarea es mejorar prompts basándote en las instrucciones del usuario, manteniendo la esencia original, mejorando la claridad, efectividad y estructura. Los prompts deben ser específicos, accionables y optimizados para agentes de IA que responden mensajes de WhatsApp.",model:"gpt-4o-mini"})});if(!ue.ok){const ne=await ue.json().catch(()=>({}));throw new Error(ne.error||"Error al mejorar el prompt")}const re=(await ue.json()).content||"";if(re)document.getElementById("prompt-editor").value=re,(X=window.showToast)==null||X.call(window,"Prompt mejorado exitosamente","success"),document.getElementById("improvement-input").value="";else throw new Error("No se recibió una respuesta válida")}catch(me){console.error("[Prompt Training] Error al mejorar prompt:",me),(Ee=window.showToast)==null||Ee.call(window,`Error al mejorar el prompt: ${me.message}`,"error")}}async function fn(z){var e,t,n;try{if(z.type.startsWith("image/")){const p=new FileReader;p.onload=async b=>{var B;const _=b.target.result;(B=window.showToast)==null||B.call(window,"Imagen procesada. Usa el campo de mejora para describir qué quieres cambiar.","info")},p.readAsDataURL(z)}else if(z.type==="text/plain"){const p=await z.text();document.getElementById("improvement-input").value=`Ejemplo de texto:

${p}

Quiero que el prompt haga que la IA responda de forma similar a este ejemplo.`,(e=window.showToast)==null||e.call(window,"Ejemplo de texto cargado","success")}else(t=window.showToast)==null||t.call(window,"Formato de archivo no soportado. Usa imágenes o archivos de texto.","error")}catch(p){console.error("[Prompt Training] Error al procesar archivo:",p),(n=window.showToast)==null||n.call(window,"Error al procesar el archivo","error")}}async function gn(){var t,n,p;const z=await window.getUserId();if(!z)return;const e=document.getElementById("prompt-editor").value.trim();if(!e){(t=window.showToast)==null||t.call(window,"El prompt no puede estar vacío","error");return}try{const{data:b}=await auth.sb.from("prompts").select("id").eq("user_id",z).maybeSingle();if(b){const{error:_}=await window.auth.sb.from("prompts").update({prompt_content:e}).eq("user_id",z);if(_)throw _}else{const{error:_}=await window.auth.sb.from("prompts").insert({user_id:z,prompt_content:e});if(_)throw _}$t=e,(n=window.showToast)==null||n.call(window,"Prompt guardado exitosamente","success")}catch(b){console.error("[Prompt Training] Error al guardar prompt:",b),(p=window.showToast)==null||p.call(window,"Error al guardar el prompt","error")}}async function hn(){var z;confirm("¿Estás seguro de que quieres restaurar el prompt original? Se perderán los cambios no guardados.")&&(document.getElementById("prompt-editor").value=$t,(z=window.showToast)==null||z.call(window,"Prompt restaurado","info"))}window.sendSimulationMessage=async function(){var n,p;const z=document.getElementById("simulation-message-input"),e=z.value.trim();if(!e)return;if(jt("user",e),z.value="",(n=document.getElementById("limit-alert"))==null||n.classList.add("hidden"),bn(e)){(p=document.getElementById("limit-alert"))==null||p.classList.remove("hidden"),jt("assistant","⚠️ Lo siento, esta solicitud requiere desarrollo adicional. El sistema actual no puede realizar esta acción solo modificando el prompt.");return}try{const b=document.getElementById("prompt-editor").value||$t,_=await wn(e,b);jt("assistant",_)}catch(b){console.error("[Prompt Training] Error al simular respuesta:",b),jt("assistant","❌ Error al generar respuesta. Verifica tu configuración.")}};function bn(z){return rn.some(e=>e.test(z))}async function wn(z,e){try{const t=await window.getUserId();if(!t)throw new Error("No se pudo obtener el ID del usuario");const{data:n,error:p}=await window.auth.sb.from("profiles").select("evolution_instance_name, evolution_api_key").eq("id",t).single();if(p||!n)throw new Error("No se pudo obtener el perfil del usuario. Verifica tu configuración.");if(!n.evolution_instance_name||!n.evolution_api_key)throw new Error("Configuración incompleta. Verifica que tu instancia de Evolution API esté configurada.");const{error:b}=await window.auth.sb.from("prompts").upsert({user_id:t,prompt_content:e||$t,updated_at:new Date().toISOString()},{onConflict:"user_id"});b&&console.warn("[Prompt Training] No se pudo actualizar el prompt temporalmente:",b);const _=`521SIM${t.slice(0,8)}@s.whatsapp.net`,B={event:"messages.upsert",instance:n.evolution_instance_name,apikey:n.evolution_api_key,isSimulation:!0,simulationUserId:t,data:{key:{remoteJid:_,remoteJidAlt:_,fromMe:!1,id:`SIM_${Date.now()}`,participant:"",addressingMode:"standard"},pushName:"Usuario de Simulación",status:"DELIVERY_ACK",message:{conversation:z},date_time:new Date().toISOString()}},A=await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/elina-simulacion",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({isSimulation:!0,simulationUserId:t,data:{key:{remoteJid:_},message:{conversation:z}}})});if(!A.ok){const H=await A.text();throw console.error("[Prompt Training] Error del webhook:",H),new Error(`Error al procesar mensaje: ${A.status}`)}let N;try{const H=await A.json();if(H.success&&H.response)N=H.response,H.context_used&&console.log("[Prompt Training] Contexto usado:",H.context_used);else throw new Error("El workflow no retornó una respuesta válida")}catch(H){console.warn("[Prompt Training] Error al obtener respuesta del workflow:",H),N=await yn(z,e)}return qt.push({role:"user",content:z}),qt.push({role:"assistant",content:N}),qt.length>10&&(qt=qt.slice(-10)),N}catch(t){throw console.error("[Prompt Training] Error en simulación:",t),t}}async function yn(z,e){return`⚠️ Error: No se pudo obtener la respuesta del workflow de simulación.

El mensaje fue: "${z}"

Verifica que el workflow "Elina V4 Simulación" esté activo y configurado correctamente.`}function jt(z,e){const t=document.getElementById("simulation-chat-messages");if(!t)return;const n=t.querySelector(".text-center");n&&n.remove();const p=document.createElement("div");p.className=`flex ${z==="user"?"justify-end":"justify-start"}`,p.innerHTML=`
        <div class="max-w-[80%] ${z==="user"?"bg-green-500 text-white":"bg-white border border-slate-200"} rounded-lg p-3">
            <p class="text-sm whitespace-pre-wrap">${Xt(e)}</p>
        </div>
    `,t.appendChild(p),t.scrollTop=t.scrollHeight}async function vn(){var t,n,p,b;const z=((t=qt.filter(_=>_.role==="user").pop())==null?void 0:t.content)||"",e=qt.slice(-6).map(_=>`${_.role}: ${_.content}`).join(`
`);try{if((await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/developer-suggestion",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:await window.getUserId(),conversationContext:e,triggerMessage:z,timestamp:new Date().toISOString()})})).ok)(n=window.showToast)==null||n.call(window,"Sugerencia enviada al desarrollador","success"),(p=document.getElementById("limit-alert"))==null||p.classList.add("hidden");else throw new Error("Error al enviar sugerencia")}catch(_){console.error("[Prompt Training] Error al enviar sugerencia:",_),(b=window.showToast)==null||b.call(window,"Error al enviar la sugerencia","error")}}function Xt(z){const e=document.createElement("div");return e.textContent=z,e.innerHTML}const Jt=document.createElement("style");Jt.textContent=".content-panel:not(.active) { display: none !important; }";document.head.appendChild(Jt);document.addEventListener("DOMContentLoaded",()=>{const z=e=>{e&&!window.appInstance&&(window.appInstance=new Ht(e),window.appInstance.init(),window.switchPanel=(t,n)=>window.appInstance.switchPanel(t,n))};document.addEventListener("auth:ready",({detail:e})=>z(e.session))});(function(){if(window.openColumnMappingModal)return;const e=(t,n)=>{const p={},b=new Set,_=t.map(A=>A.toLowerCase()),B=(A=[])=>{for(const N of A){const H=_.indexOf(N.toLowerCase());if(H!==-1&&!b.has(H))return H}return-1};for(const A of n){let N=B(A.aliases);if(N===-1&&(N=t.findIndex((H,U)=>!b.has(U))),N===-1){if(A.required)return console.warn(`No se pudo asignar automáticamente la columna para "${A.label}".`),null;continue}p[A.field]=N,b.add(N)}return p};window.openColumnMappingModal=async function(t=[],n=[]){const p=n.map(U=>typeof U=="string"?U.trim():"").filter(Boolean),b=document.getElementById("column-mapping-modal"),_=document.getElementById("column-mapping-table-body"),B=document.getElementById("column-mapping-error"),A=document.getElementById("confirm-column-mapping-btn"),N=document.getElementById("cancel-column-mapping-btn"),H=document.getElementById("close-column-mapping-btn");return!b||!_||!B||!A||!N||!H?(console.warn("No se encontró el modal de mapeo de columnas. Se intentará asignar automáticamente."),e(p,t)):await new Promise(U=>{var D;const X=new Map(t.map(c=>[c.field,c]));let Ee=!1,me=[];_.innerHTML="";const W=(c=[])=>{const o=p.map(m=>m.toLowerCase());for(const m of c){const g=o.indexOf(m.toLowerCase());if(g!==-1)return g}return-1};t.forEach(c=>{const o=document.createElement("tr");o.innerHTML=`
                    <td class="px-4 py-3">
                        <div class="flex flex-col">
                            <span class="font-medium text-slate-700">${c.label}</span>
                            <span class="mt-1 text-xs ${c.required?"text-red-500 font-semibold":"text-slate-400"}">${c.required?"Obligatorio":"Opcional"}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <select class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">${c.required?"Selecciona una columna":"Dejar sin asignar"}</option>
                        </select>
                    </td>
                `;const m=o.querySelector("select");m.dataset.field=c.field,m.dataset.required=c.required?"true":"false",p.forEach((g,k)=>{const f=document.createElement("option");f.value=String(k),f.textContent=g,m.appendChild(f)}),_.appendChild(o)}),me=Array.from(_.querySelectorAll("select"));const ue=new Set;me.forEach(c=>{const o=X.get(c.dataset.field),m=W((o==null?void 0:o.aliases)||[]);typeof m=="number"&&m>=0&&!ue.has(String(m))&&(c.value=String(m),ue.add(String(m)))});const te=()=>{const c=new Set(me.map(o=>o.value).filter(Boolean));me.forEach(o=>{Array.from(o.options).forEach(m=>{m.value&&(m.disabled=o.value!==m.value&&c.has(m.value))})})},re=c=>{B.textContent=c,B.classList.remove("hidden")},ne=()=>{B.textContent="",B.classList.add("hidden")},be=c=>{c.target.classList.remove("border-red-500"),ne(),te()},ce=()=>{me.forEach(c=>c.removeEventListener("change",be)),A.removeEventListener("click",Ie),N.removeEventListener("click",_e),H.removeEventListener("click",_e),b.removeEventListener("click",oe),document.removeEventListener("keydown",ae),_.innerHTML="",ne(),b.classList.add("hidden"),document.body.classList.remove("overflow-hidden")},Y=c=>{Ee||(Ee=!0,ce(),U(c))},Ie=()=>{const c={};ne();for(const o of me){const m=o.dataset.field,g=X.get(m),k=o.value;if(!k){if(g!=null&&g.required){o.classList.add("border-red-500"),re(`Selecciona una columna para "${g.label}".`),o.focus();return}continue}c[m]=Number(k)}Y(c)},_e=()=>Y(null),oe=c=>{c.target===b&&Y(null)},ae=c=>{c.key==="Escape"&&(c.preventDefault(),Y(null))};me.forEach(c=>c.addEventListener("change",be)),A.addEventListener("click",Ie),N.addEventListener("click",_e),H.addEventListener("click",_e),b.addEventListener("click",oe),document.addEventListener("keydown",ae),document.body.classList.add("overflow-hidden"),b.classList.remove("hidden"),ne(),typeof(lucide==null?void 0:lucide.createIcons)=="function"&&lucide.createIcons(),te(),(D=me[0])==null||D.focus()})},window.escapeCsvValue=function(t){if(t==null)return"";const n=String(t);return/[",\n]/.test(n)?'"'+n.replace(/"/g,'""')+'"':n},window.splitCsvLines=function(t){if(typeof t!="string")return[];let n=t;n.length&&n.charCodeAt(0)===65279&&(n=n.slice(1));const p=[];let b="",_=!1;for(let B=0;B<n.length;B++){const A=n[B];if(A==='"'){_&&n[B+1]==='"'?(b+='"',B++):(_=!_,b+=A);continue}if((A===`
`||A==="\r")&&!_){A==="\r"&&n[B+1]===`
`&&B++,p.push(b),b="";continue}b+=A}return b.length>0&&p.push(b),p.map(B=>B.trim()).filter(B=>B.length>0)},window.convertFileToCsvText=async function(t){const n=(t.name||"").toLowerCase();if(n.endsWith(".xlsx")||n.endsWith(".xls")){if(typeof XLSX>"u")throw new Error("No se pudo cargar el lector de hojas de cálculo (XLSX). Recarga la página e intenta nuevamente.");const p=await t.arrayBuffer(),b=XLSX.read(p,{type:"array"});if(!b.SheetNames.length)throw new Error("El archivo de Excel no contiene hojas válidas.");const _=b.Sheets[b.SheetNames[0]];return XLSX.utils.sheet_to_csv(_,{FS:",",RS:`
`})}return await t.text()},window.parseCsvRow=function(t){const n=[];let p="",b=!1;for(let _=0;_<t.length;_++){const B=t[_];B==='"'&&(_===0||t[_-1]!=='"')?b&&t[_+1]==='"'?(p+='"',_++):b=!b:B===","&&!b?(n.push(p.trim()),p=""):p+=B}return n.push(p.trim()),n},window.autoMapHeaders=function(t,n){const p={},b=new Set,_=t.map(B=>B.toLowerCase());for(const B of n){let A=-1;for(const N of B.aliases||[]){const H=_.indexOf(N.toLowerCase());if(H!==-1&&!b.has(H)){A=H;break}}if(A===-1&&(A=t.findIndex((N,H)=>!b.has(H))),A===-1){if(B.required)return null;continue}p[B.field]=A,b.add(A)}return p},window.getColumnValue=function(t,n){return typeof n!="number"||n<0||n>=t.length?"":t[n]},window.cleanPhone=function(t){if(!t)return"";const n=String(t).replace(/\D+/g,"");return n.length<10?"":"+521"+n.slice(-10)}})();class Ht{constructor(e){this.session=e,this.switchPanel=this.switchPanel.bind(this),this.user=e.user,this.teamInfo=null,this.config={N8N_URL:"https://n8n-n8n.mcjhhb.easypanel.host",YOUTUBE_PLAYLIST_ID:"PLfA32SmdFbHBdOXaPc_tdg28Kl2CFAXnz",CHATWOOT_BASE_URL:"https://chat.elinaia.com.mx"},this.handlePromptSave=this.handlePromptSave.bind(this),this.checkWhatsappConnection=this.checkWhatsappConnection.bind(this),this.openChatwoot=this.openChatwoot.bind(this),this.openAiEnhanceModal=this.openAiEnhanceModal.bind(this)}init(){if(lucide.createIcons(),this.processInvitationFromURL(),!localStorage.getItem("welcome_popup_shown")){const t=document.getElementById("welcome-modal");t&&(t.classList.remove("hidden"),document.getElementById("close-welcome-modal").addEventListener("click",()=>{t.classList.add("hidden"),localStorage.setItem("welcome_popup_shown","true")}))}this.setupEventListeners(),this.loadInitialData(),this.checkImpersonation();const e=localStorage.getItem("activePanelId")||"dashboard";this.switchPanel(e),this.listenForProfileChanges(),this.wizard=new En(this),this.setSidebarCollapsed(localStorage.getItem("sidebarCollapsed")==="true"),this.checkAppointmentsEnabled()}async checkAppointmentsEnabled(){try{const e=await window.getUserId();if(!e)return;const{data:t,error:n}=await auth.sb.from("appointment_settings").select("is_enabled").eq("user_id",e).maybeSingle();if(n&&n.code!=="PGRST116"){console.error("[App] Error al verificar estado de citas:",n);return}const p=(t==null?void 0:t.is_enabled)||!1,b=document.getElementById("appointments-menu-item");b&&(p?b.classList.remove("hidden"):b.classList.add("hidden"))}catch(e){console.error("[App] Error al verificar estado de citas:",e)}}setupEventListeners(){var n,p,b,_,B,A,N,H,U,X,Ee,me,W,ue,te,re,ne,be;document.querySelectorAll(".nav-link[data-target]").forEach(ce=>{ce.addEventListener("click",Y=>{Y.preventDefault(),this.switchPanel(ce.dataset.target)})}),document.querySelectorAll(".nav-link[data-group]").forEach(ce=>{ce.addEventListener("click",Y=>{Y.preventDefault();const Ie=ce.dataset.group,_e=ce.dataset.groupDefault||this.getDefaultTabForGroup(Ie);_e&&this.switchPanel(_e,{groupId:Ie,tabId:_e})})}),document.querySelectorAll(".group-tab[data-target]").forEach(ce=>{ce.addEventListener("click",Y=>{var oe;Y.preventDefault();const Ie=ce.dataset.target,_e=(oe=ce.closest("[data-group-container]"))==null?void 0:oe.dataset.groupContainer;Ie&&_e&&this.switchPanel(Ie,{groupId:_e,tabId:ce.dataset.tab})})}),(n=document.getElementById("logout-btn"))==null||n.addEventListener("click",ce=>{ce.preventDefault(),auth.handleLogout()}),(p=document.getElementById("prompt-form"))==null||p.addEventListener("submit",this.handlePromptSave),(b=document.getElementById("main-prompt-ai-enhance-btn"))==null||b.addEventListener("click",()=>{const ce=document.getElementById("ai-master-prompt");ce.value&&this.openAiEnhanceModal(ce.value,Y=>{ce.value=Y},"behavior_prompt")}),(_=document.getElementById("remake-prompt-btn"))==null||_.addEventListener("click",()=>{this.wizard.start(!0)}),(B=document.getElementById("request-qr-btn"))==null||B.addEventListener("click",this.checkWhatsappConnection),(A=document.getElementById("chatwoot-link"))==null||A.addEventListener("click",this.openChatwoot),(N=document.getElementById("mobile-menu-btn"))==null||N.addEventListener("click",()=>{const ce=document.getElementById("main-sidebar");ce==null||ce.classList.add("open")}),(H=document.getElementById("prompt-help-btn"))==null||H.addEventListener("click",()=>{var ce;return(ce=document.getElementById("prompt-help-modal"))==null?void 0:ce.classList.remove("hidden")}),(U=document.getElementById("close-prompt-help-btn"))==null||U.addEventListener("click",()=>{var ce;return(ce=document.getElementById("prompt-help-modal"))==null?void 0:ce.classList.add("hidden")}),(X=document.getElementById("start-wizard-btn"))==null||X.addEventListener("click",()=>this.wizard.start()),(Ee=document.getElementById("close-sidebar-btn"))==null||Ee.addEventListener("click",()=>{const ce=document.getElementById("main-sidebar");ce==null||ce.classList.remove("open")}),(me=document.getElementById("open-tutorials-btn"))==null||me.addEventListener("click",()=>this.openTutorialsModal()),this.setupYoutubeCarousel(),(W=document.getElementById("cancel-ai-btn"))==null||W.addEventListener("click",()=>this.closeAiModal()),(ue=document.getElementById("generate-ai-btn"))==null||ue.addEventListener("click",()=>this.handleGenerateAi());const e=document.getElementById("regenerate-ai-btn");e&&e.addEventListener("click",()=>this.handleGenerateAi(!0)),(te=document.getElementById("regenerate-ai-btn"))==null||te.addEventListener("click",()=>this.handleGenerateAi()),(re=document.getElementById("apply-ai-btn"))==null||re.addEventListener("click",()=>this.handleApplyAi()),(ne=document.getElementById("toggle-sidebar-collapse-btn"))==null||ne.addEventListener("click",()=>this.toggleSidebarCollapsed()),(be=document.getElementById("cancel-pricing-modal-btn"))==null||be.addEventListener("click",()=>this.closePricingModal());const t=document.getElementById("pricing-modal");t&&t.addEventListener("click",ce=>{const Y=ce.target.closest(".upgrade-btn");if(Y){ce.preventDefault();const Ie=Y.dataset.plan;Ie&&this.handleUpgradeClick(Ie)}})}checkImpersonation(){const e=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),t=localStorage.getItem("superadmin_session_tokens");if(!e){document.body.style.paddingTop="0";return}if(!t){localStorage.removeItem("impersonated_user_info"),document.body.style.paddingTop="0";return}if(!document.getElementById("impersonation-bar")&&e){const n=document.createElement("div");n.id="impersonation-bar",n.className="fixed top-0 left-0 w-full bg-amber-500 text-black font-bold text-xs p-1 text-center z-[200] flex justify-center items-center gap-2",n.innerHTML=`
                <span>Estás viendo como <strong>${e.email}</strong>.</span>
                <button id="stop-impersonating-btn" class="bg-slate-800 text-white py-0.5 px-2 rounded hover:bg-slate-700 text-xs">Volver a Super Admin</button>
            `,document.body.prepend(n),document.body.style.paddingTop="0",document.getElementById("stop-impersonating-btn").addEventListener("click",async()=>{try{const p=JSON.parse(localStorage.getItem("superadmin_session_tokens")||"null");if(!(p!=null&&p.access_token)||!(p!=null&&p.refresh_token))throw new Error("Sesión original inválida. Por favor, inicia sesión nuevamente.");await window.auth.sb.auth.setSession(p),localStorage.removeItem("impersonated_user_info"),localStorage.removeItem("superadmin_session_tokens"),document.body.style.paddingTop="0",window.location.reload()}catch(p){console.error("Error al detener la suplantación:",p),alert("No se pudo volver a la sesión de superadmin. Por favor, cierra sesión y vuelve a entrar.")}})}}loadInitialData(){this.fetchUserProfile(),this.fetchMasterPrompt(),this.loadDashboardMetrics(),this.loadFunnelMetrics(),Promise.all([this.loadUserSubscription(),this.loadTeamInfo()]).then(([e,t])=>{this.renderUserPlanBadge(e),this.renderUpgradeButtons(e),document.addEventListener("panel:activated",()=>this.applyFeatureRestrictions(e,t))}),this.renderWhatsappConnection("initial")}openTutorialsModal(){const e="https://www.youtube.com/embed/videoseries?list=PLDs44uukbe3FIDa9CttQLh8N-Nfdpo_hG&autoplay=1",t=document.getElementById("image-viewer-modal"),n=document.getElementById("image-viewer-content");n.innerHTML=`<iframe class="w-full h-full" src="${e}" title="Tutoriales ELINA IA" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`,t.classList.remove("hidden")}toggleSidebarCollapsed(){const e=document.getElementById("main-sidebar");if(!e)return;const t=e.classList.toggle("sidebar-collapsed");this.setSidebarCollapsed(t),localStorage.setItem("sidebarCollapsed",t)}setSidebarCollapsed(e){const t=document.getElementById("main-sidebar"),n=document.getElementById("main-content-area"),p=document.getElementById("toggle-sidebar-collapse-btn");if(!t||!n||!p)return;e?(t.classList.add("sidebar-collapsed"),n.classList.add("lg:ml-20"),n.classList.remove("lg:ml-64"),p.style.left="4.5rem"):(t.classList.remove("sidebar-collapsed"),n.classList.remove("lg:ml-20"),n.classList.add("lg:ml-64"),p.style.left="15.5rem");const b=p.querySelector("i");b&&b.setAttribute("data-lucide",e?"chevron-right":"chevron-left"),lucide.createIcons({nodes:[b]})}switchPanel(e,t={}){const n=document.getElementById("main-sidebar"),p=document.getElementById("main-content-area"),b=document.getElementById("toggle-sidebar-collapse-btn");document.querySelectorAll(".content-panel").forEach(Ee=>Ee.classList.remove("active"));const _=document.querySelector(".group-tabs-container");_&&_.remove();const B=document.getElementById(e),A=document.querySelector(`.nav-link[data-target="${e}"]`),N=t.groupId||(A==null?void 0:A.dataset.group),H=t.tabId||(A==null?void 0:A.dataset.tab),U={campaigns:{tabs:[{id:"bulk-sending",label:"Envío Masivo",default:!0},{id:"follow-ups",label:"Seguimientos"},{id:"auto-responses",label:"Respuestas Programadas"},{id:"templates",label:"Plantillas"}]},clients:{tabs:[{id:"contacts",label:"Contactos",default:!0},{id:"kanban",label:"Kanban"},{id:"quotes",label:"Cotizaciones"}]},"ai-behavior":{tabs:[{id:"prompt-training",label:"Entrenamiento de Prompt",default:!0},{id:"smart-promotions",label:"Promos Inteligentes"},{id:"sales-context",label:"Contexto de Ventas"}]},marketing:{tabs:[{id:"designer-ai",label:"Diseñador Gráfico IA",default:!0},{id:"video-ai",label:"Video IA"},{id:"community-manager",label:"Community Manager"}]}};if(N&&U[N]&&B&&this.createGroupTabs(N,U[N],H||e,B),B){if(e==="kanban")n.classList.add("hidden"),b.style.display="none",p.classList.remove("lg:ml-64","lg:ml-20","ml-0"),p.classList.add("lg:ml-0");else{n.classList.remove("hidden"),b.style.display="";const Ee=n.classList.contains("sidebar-collapsed");p.classList.remove("lg:ml-0"),p.classList.toggle("lg:ml-20",Ee),p.classList.toggle("lg:ml-64",!Ee)}B.classList.add("active"),localStorage.setItem("activePanelId",e),N&&localStorage.setItem(`activeGroup_${N}`,H||e),document.dispatchEvent(new CustomEvent("panel:activated",{detail:{panelId:e,options:t,groupId:N,tabId:H}})),n&&n.classList.contains("open")&&n.classList.remove("open")}const X=["bg-green-500","text-white"];if(document.querySelectorAll(".nav-link[data-target]").forEach(Ee=>Ee.classList.remove(...X)),document.querySelectorAll(".nav-link[data-group]").forEach(Ee=>Ee.classList.remove(...X)),N){const Ee=document.querySelector(`.nav-link[data-group="${N}"]`);Ee&&Ee.classList.add(...X)}else A&&A.classList.add(...X);if(N&&B){const Ee=B.querySelector(".group-tabs-container");Ee&&Ee.querySelectorAll(".group-tab").forEach(me=>{me.classList.remove("active"),me.dataset.tab===(H||e)&&me.classList.add("active")})}}getDefaultTabForGroup(e){return{campaigns:"bulk-sending",clients:"contacts","ai-behavior":"prompt-training",marketing:"designer-ai"}[e]||null}createGroupTabs(e,t,n,p){const b=p.querySelector(".group-tabs-container");b&&b.remove();const _=document.createElement("div");_.className="group-tabs-container mb-6";const B=document.createElement("div");B.className="group-tabs",t.tabs.forEach(A=>{const N=document.createElement("button");N.className=`group-tab ${A.id===n?"active":""}`,N.textContent=A.label,N.dataset.tab=A.id,N.dataset.target=A.id,N.addEventListener("click",H=>{H.preventDefault(),this.switchPanel(A.id,{groupId:e,tabId:A.id})}),B.appendChild(N)}),_.appendChild(B),p.insertBefore(_,p.firstChild)}listenForProfileChanges(){auth.sb.channel(`profile-changes:${this.user.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"profiles",filter:`id=eq.${this.user.id}`},e=>{const{whatsapp_connected:t,sync_status:n}=e.new;document.dispatchEvent(new CustomEvent("profile:updated",{detail:{whatsapp_connected:t,sync_status:n}}))}).subscribe()}async loadUserSubscription(){try{let e=null;try{const{data:p,error:b}=await auth.sb.rpc("check_account_access",{p_user_id:this.user.id});b&&b.code!=="PGRST202"?console.error("Error al verificar acceso de cuenta:",b):b||(e=p)}catch(p){p.code!=="PGRST202"&&console.error("Error al verificar acceso de cuenta:",p)}if(e&&e.blocked)return window.showToast(e.reason||"Tu cuenta está bloqueada. Por favor, contacta con soporte.","error"),{blocked:!0,reason:e.reason,status:e.status,plan_id:e.plan_id};const{data:t,error:n}=await auth.sb.from("subscriptions").select("status, plan_id, plans:plan_id(*)").eq("user_id",this.user.id).limit(1).single();if(n&&n.code!=="PGRST116")throw n;if(t&&t.plan_id==="free_trial"&&t.status==="trialing"){const{data:p}=await auth.sb.from("profiles").select("stripe_customer_id").eq("id",this.user.id).single();if(p&&p.stripe_customer_id){const{data:b,error:_}=await window.auth.invokeFunction("get-stripe-subscription",{body:{customerId:p.stripe_customer_id}});if(_)throw _;b&&b.planId&&(t.plan_id=b.planId,t.plans.name=b.planName,t.plans.features=b.features)}}try{const{data:p,error:b}=await auth.sb.rpc("check_account_access",{p_user_id:this.user.id});!b&&p&&p.blocked&&(t.blocked=!0,t.blockedReason=p.reason,window.showToast(p.reason||"Tu cuenta está bloqueada. Por favor, contacta con soporte.","error"))}catch(p){p.code!=="PGRST202"&&console.warn("Error al verificar acceso de cuenta:",p)}return t}catch(e){return console.error("Error al cargar la suscripción del usuario:",e),null}}async loadTeamInfo(){try{const{data:e,error:t}=await auth.sb.rpc("get_user_team_info_with_permissions",{p_user_id:this.user.id});if(t)throw t;return e&&e.length>0&&(this.teamInfo=e[0]),this.teamInfo}catch(e){return console.error("Error al cargar la información del equipo:",e),null}}async processInvitationFromURL(){var e,t,n,p,b,_;try{const B=new URLSearchParams(window.location.search),A=B.get("invitation");if(!A)return;console.log("[App] Procesando invitación desde URL:",A);const{data:N,error:H}=await auth.sb.from("team_invitations").select("id, team_id, email, role, status, expires_at").eq("id",A).eq("status","pending").single();if(H||!N){console.warn("[App] Invitación no encontrada o ya procesada:",H),B.delete("invitation"),window.history.replaceState({},"",`${window.location.pathname}${B.toString()?"?"+B.toString():""}`);return}if(new Date(N.expires_at)<new Date){console.warn("[App] Invitación expirada"),(e=window.showToast)==null||e.call(window,"Esta invitación ha expirado. Contacta al administrador para una nueva invitación.","error"),B.delete("invitation"),window.history.replaceState({},"",`${window.location.pathname}${B.toString()?"?"+B.toString():""}`);return}if(this.user.email.toLowerCase()!==N.email.toLowerCase()){console.warn("[App] Email del usuario no coincide con la invitación"),(t=window.showToast)==null||t.call(window,"El correo de esta invitación no coincide con tu cuenta. Por favor, inicia sesión con el correo correcto.","error"),B.delete("invitation"),window.history.replaceState({},"",`${window.location.pathname}${B.toString()?"?"+B.toString():""}`);return}const{data:X}=await auth.sb.from("team_members").select("*").eq("team_id",N.team_id).eq("user_id",this.user.id).single();if(X)console.log("[App] Usuario ya es miembro del equipo, marcando invitación como aceptada"),await auth.sb.from("team_invitations").update({status:"accepted",accepted_at:new Date().toISOString()}).eq("id",A),(n=window.showToast)==null||n.call(window,"¡Bienvenido al equipo! Ya eres miembro.","success");else{console.log("[App] Agregando usuario al equipo");const{error:Ee}=await auth.sb.from("team_members").insert({team_id:N.team_id,user_id:this.user.id,role:N.role,permissions:N.role==="advisor"?{chats:!0,"follow-ups":!0,kanban:!0,contacts:!1,label_filters:{}}:{}});if(Ee){console.error("[App] Error al agregar usuario al equipo:",Ee),(p=window.showToast)==null||p.call(window,"Error al procesar la invitación. Por favor, contacta al administrador.","error");return}await auth.sb.from("team_invitations").update({status:"accepted",accepted_at:new Date().toISOString()}).eq("id",A),await this.loadTeamInfo(),(b=window.showToast)==null||b.call(window,"¡Bienvenido al equipo! Has sido agregado exitosamente.","success")}B.delete("invitation"),window.history.replaceState({},"",`${window.location.pathname}${B.toString()?"?"+B.toString():""}`)}catch(B){console.error("[App] Error al procesar invitación:",B),(_=window.showToast)==null||_.call(window,"Error al procesar la invitación. Por favor, contacta al administrador.","error")}}async loadUserUsage(){try{const{data:e,error:t}=await window.auth.sb.from("profiles").select("ai_enhancements_used, image_generations_used, bulk_sends_used").eq("id",this.user.id).single();if(t)throw t;return e}catch(e){return console.error("Error al cargar el uso del usuario:",e),{ai_enhancements_used:0,image_generations_used:0,bulk_sends_used:0}}}async renderUsageAndLimits(){var b;const[e,t]=await Promise.all([this.loadUserSubscription(),this.loadUserUsage()]);e?(this.renderUserPlanBadge(e),this.renderUpgradeButtons(e),this.applyFeatureRestrictions(e,this.teamInfo)):console.warn("El usuario no tiene una suscripción registrada.");const n=((b=e==null?void 0:e.plans)==null?void 0:b.image_generations_limit)||0,p=(t==null?void 0:t.image_generations_used)||0;console.log("[Uso Verificado]",{imageGenerations:{used:p,limit:n}}),document.dispatchEvent(new CustomEvent("usage:updated",{detail:{imageGenerations:{remaining:n-p,limit:n}}}))}renderUserPlanBadge(e){var B;const t=document.getElementById("user-plan-badge");if(!t||!e)return;const n=e.plan_id,p=((B=e.plans)==null?void 0:B.name)||n.replace("_"," ").replace(/\b\w/g,A=>A.toUpperCase());let b="bg-slate-200",_="text-slate-700";switch(n){case"free_trial":b="bg-blue-100",_="text-blue-800";break;case"starter":b="bg-green-100",_="text-green-800";break;case"grow":b="bg-purple-100",_="text-purple-800";break;case"business":b="bg-slate-200",_="text-slate-800";break}t.textContent=p,t.className=`inline-block text-xs font-bold px-2 py-0.5 rounded-md mt-1.5 ${b} ${_}`}applyFeatureRestrictions(e,t){if(!e||!e.plans)return;const n=e.plans.features||{},p=t==null?void 0:t.user_role,b=document.getElementById("follow-ups");if(b!=null&&b.classList.contains("active")&&b.querySelector("#follow-ups-container")){const B=b.querySelector("#follow-ups-container"),A=b.querySelector("#follow-ups-access-denied");n.follow_ups?(B&&B.classList.remove("hidden"),A&&A.classList.add("hidden")):(B&&B.classList.add("hidden"),A&&A.classList.remove("hidden"),document.getElementById("upgrade-to-grow-from-followups").onclick=()=>this.handleUpgradeClick("grow"))}const _=document.getElementById("designer-ai");if(_!=null&&_.classList.contains("active")&&_.querySelector("#designer-ai-access-denied")){const B=_.querySelector(".grid"),A=_.querySelector("#designer-ai-access-denied"),N=n.designer_ai;B&&B.classList.toggle("hidden",!N),A&&A.classList.toggle("hidden",N),N||(document.getElementById("upgrade-to-grow-from-designer").onclick=()=>this.handleUpgradeClick("grow"))}if(p==="advisor"){const B=(t==null?void 0:t.permissions)||{};document.querySelectorAll(".nav-link[data-target]").forEach(A=>{const N=A.dataset.target;N!=="dashboard"&&!B[N]&&(A.parentElement.style.display="none")})}}renderUpgradeButtons(e){const t=document.getElementById("upgrade-plan-section");if(!t||!e)return;const n=document.getElementById("upgrade-grow-btn"),p=document.getElementById("upgrade-collapsed-btn"),b=document.getElementById("upgrade-trial-btn");n&&n.classList.add("hidden"),b&&b.classList.add("hidden"),t&&t.classList.add("hidden"),p&&p.classList.add("hidden");const _=e.plan_id;_==="free_trial"?(b.classList.remove("hidden"),t.classList.remove("hidden"),b.onclick=()=>this.openPricingModal(),p.onclick=()=>this.openPricingModal()):_==="starter"&&(n.classList.remove("hidden"),t.classList.remove("hidden"),n.onclick=()=>this.handleUpgradeClick("grow"),p.onclick=()=>this.handleUpgradeClick("grow"))}openPricingModal(){const e=document.getElementById("pricing-modal");e&&e.classList.remove("hidden")}closePricingModal(){const e=document.getElementById("pricing-modal");e&&e.classList.add("hidden")}async handleUpgradeClick(e){const t=document.querySelector(`.upgrade-btn[data-plan="${e}"]`)||document.getElementById(`upgrade-${e}-btn`);if(!t)return;const n=document.getElementById("pricing-modal");n&&n.classList.add("hidden");const p=t.textContent;t.disabled=!0,t.textContent="Redirigiendo a pago...";try{const{data:b,error:_}=await window.auth.invokeFunction("create-checkout-session",{body:{planId:e,userId:this.user.id}});if(_)throw new Error(_.message);window.location.href=b.url}catch(b){console.error("Error al iniciar el proceso de pago:",b),window.showToast("No se pudo iniciar el proceso de pago. Por favor, intenta de nuevo.","error"),t.disabled=!1,t.textContent=p}}async fetchUserProfile(){var n,p,b;const e=document.getElementById("user-business-name"),t=document.getElementById("user-avatar");try{const{data:_,error:B}=await window.auth.sb.from("profiles").select("full_name, role, urlfoto").eq("id",this.user.id).single();if(B)throw B;const N=((n=this.teamInfo)==null?void 0:n.team_name)||_.full_name||"Mi negocio";if(e&&(e.textContent=N),t){const H=(_.urlfoto||"").trim();t.src=H||`https://ui-avatars.com/api/?background=0A3B66&color=fff&name=${encodeURIComponent(N)}`,t.alt=`Logo de ${N}`}_.role==="superadmin"&&((p=document.getElementById("superadmin-link"))==null||p.classList.remove("hidden"),(b=document.getElementById("mobile-superadmin-link"))==null||b.classList.remove("hidden"))}catch(_){console.error("Error al cargar el perfil del usuario:",_),e&&(e.textContent="Mi negocio"),t&&(t.src="https://ui-avatars.com/api/?background=0A3B66&color=fff&name=Elina")}}async fetchMasterPrompt(){try{const{data:e,error:t}=await auth.sb.from("prompts").select("prompt_content").eq("user_id",this.user.id).single();if(t&&t.code!=="PGRST116")throw t;document.getElementById("ai-master-prompt").value=(e==null?void 0:e.prompt_content)||""}catch(e){console.error("Error al cargar el prompt:",e),document.getElementById("ai-master-prompt").value="No se pudo cargar el prompt."}}async handlePromptSave(e){e.preventDefault();const t=document.getElementById("prompt-form");if(!t)return;const n=t.querySelector('button[type="submit"]'),p=document.getElementById("ai-master-prompt").value;if(n){n.disabled=!0,n.textContent="Guardando...";try{const{error:b}=await auth.sb.from("prompts").upsert({user_id:this.user.id,prompt_content:p},{onConflict:"user_id"});if(b)throw b;window.showToast("Prompt guardado con éxito.","success")}catch(b){console.error("Error al guardar el prompt:",b),window.showToast("Error al guardar el prompt. Revisa la consola.","error")}finally{n.disabled=!1,n.textContent="Guardar"}}}async uploadAsset(e,t,n){if(!e)return null;const p=this.user.id,b=e.name,_=b.lastIndexOf("."),B=_>0?b.substring(_):"",N=(_>0?b.substring(0,_):b).replace(/[^a-zA-Z0-9._-]/g,"_")+B,H=`temp-uploads/${p}/${t}/${Date.now()}-${N}`;try{n&&n(10);const{error:U}=await window.auth.sb.storage.from("campaign_files").upload(H,e,{onUploadProgress:ue=>{if(n){const te=10+ue.loaded/ue.total*50;n(Math.min(te,60))}}});if(U)throw new Error(`Error en subida temporal: ${U.message}`);n&&n(60);const{data:X}=window.auth.sb.storage.from("campaign_files").getPublicUrl(H);n&&n(70);const{data:Ee,error:me}=await window.auth.invokeFunction("smart-worker",{body:{sourceUrl:X.publicUrl,userId:p,fileName:N,folder:t}});if(me)throw new Error(`Error al mover a CDN: ${me.message}`);n&&n(90);const{error:W}=await window.auth.sb.storage.from("campaign_files").remove([H]);return W&&console.warn(`[Limpieza] No se pudo borrar el archivo temporal ${H}:`,W.message),n&&n(100),Ee.cdnUrl}catch(U){throw console.error("Falló el proceso completo de subida de asset:",U),U}}async loadDashboardMetrics(){try{const e=new Date,t=new Date(e);t.setDate(e.getDate()-30);const{data:n,error:p}=await auth.sb.from("daily_stats").select("stat_date, ai_responses_count, time_saved_seconds").eq("user_id",this.user.id).gte("stat_date",t.toISOString().split("T")[0]).order("stat_date",{ascending:!0});if(p)throw p;this.renderMetricsCharts(n)}catch(e){console.error("Error al cargar métricas del dashboard:",e)}}renderMetricsCharts(e){var A,N;const t=e.map(H=>new Date(H.stat_date+"T00:00:00").toLocaleDateString("es-MX",{day:"numeric",month:"short"})),n=e.map(H=>H.ai_responses_count),p=e.map(H=>Math.round(H.time_saved_seconds/60)),b={responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{color:"#94a3b8"}},x:{ticks:{color:"#94a3b8"}}},plugins:{legend:{display:!1}}},_=(A=document.getElementById("responses-chart"))==null?void 0:A.getContext("2d");_&&new Chart(_,{type:"line",data:{labels:t,datasets:[{label:"Mensajes Respondidos",data:n,borderColor:"rgb(59, 130, 246)",backgroundColor:"rgba(59, 130, 246, 0.1)",fill:!0,tension:.3}]},options:b});const B=(N=document.getElementById("time-saved-chart"))==null?void 0:N.getContext("2d");B&&new Chart(B,{type:"line",data:{labels:t,datasets:[{label:"Minutos Ahorrados",data:p,borderColor:"rgb(139, 92, 246)",backgroundColor:"rgba(139, 92, 246, 0.1)",fill:!0,tension:.3}]},options:b})}async loadFunnelMetrics(){try{const e=new Date;e.setDate(e.getDate()-30);const{data:t,error:n}=await auth.sb.from("contacts").select("labels, created_at").eq("user_id",this.user.id).gte("created_at",e.toISOString());if(n)throw n;let p=0,b=0,_=0;t.forEach(A=>{const N=new Set(A.labels||[]);p++,N.has("Interesado")&&b++,N.has("nuevo cliente")&&_++});const B=p>0?(_/p*100).toFixed(1):0;document.getElementById("funnel-leads-stat").textContent=p,document.getElementById("funnel-interested-stat").textContent=b,document.getElementById("funnel-won-stat").textContent=_,document.getElementById("funnel-conversion-stat").textContent=`${B}%`}catch(e){console.error("Error al cargar métricas del embudo:",e)}}async checkWhatsappConnection(){this.renderWhatsappConnection("loading");const e=`${this.config.N8N_URL}/webhook/generate-whatsapp-qr-Elina`;try{const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:this.user.email})});if(!t.ok)throw new Error("El servidor N8N no responde correctamente.");const n=await t.text(),p=n.trim();if(!p){this.renderWhatsappConnection("connected");return}let b;try{b=JSON.parse(p)}catch(B){console.warn("Respuesta QR inesperada, se esperaba JSON.",B,n),this.renderWhatsappConnection("error");return}const _=Array.isArray(b)?b[0]:b;_!=null&&_.qr_image_data?this.renderWhatsappConnection("qr",_.qr_image_data):this.renderWhatsappConnection("connected")}catch(t){console.error("Error al solicitar QR:",t),this.renderWhatsappConnection("error")}}openChatwoot(e){e.preventDefault(),window.open(`${this.config.CHATWOOT_BASE_URL}/app/login`,"_blank")}setupYoutubeCarousel(){const e=document.getElementById("yt-player"),t=document.querySelectorAll("#yt-carousel [data-vid]"),n=this.config.YOUTUBE_PLAYLIST_ID;t.forEach(p=>{p.addEventListener("click",b=>{b.preventDefault();const _=p.dataset.vid;_&&e&&(e.src=`https://www.youtube.com/embed/${_}?list=${n}&rel=0&autoplay=1`)})})}renderWhatsappConnection(e,t=null){const n=document.getElementById("whatsapp-connection-container"),p=document.getElementById("request-qr-btn");let b="";switch(e){case"connected":b=`
                    <div class="flex flex-col items-center justify-center h-48 text-green-600">
                        <i data-lucide="check-circle" class="w-16 h-16"></i>
                        <p class="font-bold mt-2">¡Conectado!</p>
                        <p class="text-sm text-slate-500">Tu sesión de WhatsApp está activa.</p>
                    </div>`,p.style.display="none";break;case"loading":b=`
                    <div class="flex justify-center items-center h-48">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-slate-900"></div>
                    </div>`,p.style.display="block";break;case"qr":b=`<img src="data:image/png;base64,${t}" alt="Escanea para conectar WhatsApp" class="mx-auto max-w-xs rounded-lg">`,p.style.display="block";break;case"error":b=`
                    <div class="flex flex-col items-center justify-center h-48 text-red-500">
                         <i data-lucide="alert-triangle" class="w-16 h-16"></i>
                         <p class="font-bold mt-2">Error de Conexión</p>
                    </div>`,p.style.display="block";break;case"initial":default:b=`
                    <div class="flex flex-col items-center justify-center h-48 text-slate-400">
                         <i data-lucide="qr-code" class="w-16 h-16"></i>
                         <p class="font-bold mt-2">Solicita el QR para vincular</p>
                    </div>`,p.style.display="block";break}n.innerHTML=b,lucide.createIcons()}async openAiEnhanceModal(e,t,n="default"){var _;const p=document.getElementById("ai-enhance-modal");if(!p)return;const b=document.getElementById("generate-ai-btn");try{this.aiModalContext=n;const[B,A]=await Promise.all([this.loadUserSubscription(),this.loadUserUsage()]);if(!B)throw new Error("No se pudo cargar la información del plan.");const N=((_=B.plans)==null?void 0:_.ai_enhancements_limit)||0,H=(A==null?void 0:A.ai_enhancements_used)||0,U=N-H;document.getElementById("ai-uses-left").textContent=`${U}/${N}`,b.disabled=U<=0,U<=0&&window.showToast("Has alcanzado tu límite de mejoras con IA este mes.","info"),this.aiModalCallback=t,document.getElementById("ai-original-text").value=e,document.getElementById("ai-prompt-input").value="",document.getElementById("ai-result-container").innerHTML="",document.getElementById("ai-result-container").classList.add("hidden"),b.classList.remove("hidden"),document.getElementById("apply-ai-btn").classList.add("hidden"),document.getElementById("regenerate-ai-btn").classList.add("hidden"),p.classList.remove("hidden")}catch(B){window.showToast(B.message,"error");return}}closeAiModal(){document.getElementById("ai-enhance-modal").classList.add("hidden"),this.aiModalCallback=null}async handleGenerateAi(e=!1){var B;const t=e?document.getElementById("regenerate-ai-btn"):document.getElementById("generate-ai-btn"),n=document.getElementById("generate-ai-btn");t.disabled=!0,t.textContent="Generando...";const p=document.getElementById("ai-original-text").value,b=document.getElementById("ai-prompt-input").value;let _;this.aiModalContext==="designer"?_=`Eres un asistente de diseño experto. Mejora la siguiente descripción para un prompt de generación de imágenes. Sé creativo y visual.
            - NO uses placeholders como '%nombre%'.
            - Devuelve ÚNICAMENTE la descripción mejorada.
            ${b?`Considera esta instrucción adicional del usuario: '${b}'.`:""}`:this.aiModalContext==="behavior_prompt"?_=`Eres un experto en optimización de prompts de comportamiento para asistentes de IA conversacionales.

Tu tarea es MEJORAR el prompt de comportamiento proporcionado, NO reemplazarlo completamente.

**REGLAS CRÍTICAS:**
1. DEBES mantener TODA la estructura original del prompt (secciones, formato, ejemplos, etc.)
2. DEBES conservar TODO el contenido existente (identidad, reglas, procesos, ejemplos)
3. SOLO debes hacer mejoras incrementales basadas en las instrucciones del usuario
4. NO elimines secciones, ejemplos o información importante
5. NO cambies el formato o estructura a menos que el usuario lo solicite explícitamente
6. Si el usuario pide algo específico, incorpóralo sin eliminar el resto del contenido
7. Mantén la misma extensión y nivel de detalle del prompt original
8. Conserva todos los ejemplos (FEW-SHOT_LEARNING) y casos de uso

**INSTRUCCIONES DEL USUARIO:**
${b?`El usuario quiere: "${b}"`:"Mejora general del prompt manteniendo todo el contenido."}

**PROMPT ORIGINAL A MEJORAR:**
[El prompt completo se enviará a continuación]

**IMPORTANTE:** 
- Devuelve el prompt COMPLETO mejorado, no solo las partes que cambiaste
- Mantén todas las secciones: CORE_IDENTITY, KNOWLEDGE_BASE, RULES, PROCESS, OUTPUT_FORMAT, FEW-SHOT_LEARNING
- Si agregas algo nuevo, intégralo en la sección correspondiente sin eliminar lo existente
- Si el prompt original tiene 1000 palabras, el mejorado debe tener al menos 900-1100 palabras
- Si el usuario solo pide un cambio pequeño, haz ese cambio específico pero mantén TODO lo demás intacto
- NUNCA devuelvas solo un resumen o versión corta del prompt original
- El resultado debe ser un prompt completo y funcional, no un resumen`:_=`Eres un asistente de marketing experto en WhatsApp. Reescribe el siguiente texto para que sea más efectivo y profesional, manteniendo el tono y la intención original.
            - El único placeholder permitido es '%nombre%'. Mantenlo exactamente como está. NO inventes otros placeholders como '%empresa%'.
            - NO añadas saludos, despedidas, ni firmes con "[Tu Nombre]", etc. Devuelve ÚNICamente el texto mejorado.
            ${b?`Considera esta instrucción adicional del usuario: '${b}'.`:""}`;try{let A=null;try{const{data:W,error:ue}=await window.auth.sb.rpc("check_account_access",{p_user_id:this.user.id});if(ue&&ue.code!=="PGRST202")throw new Error("Error al verificar el acceso de tu cuenta.");ue||(A=W)}catch(W){if(W.code!=="PGRST202")throw new Error("Error al verificar el acceso de tu cuenta.")}if(A&&A.blocked)throw new Error(A.reason||"Tu cuenta está bloqueada. Por favor, contacta con soporte.");const{data:N,error:H}=await window.auth.invokeFunction("openai-proxy",{body:{type:"text",prompt:_,text:p,userId:this.user.id}});if(H)throw H;const U=await this.loadUserUsage(),X=((B=(await this.loadUserSubscription()).plans)==null?void 0:B.ai_enhancements_limit)||0,Ee=(U==null?void 0:U.ai_enhancements_used)||0;document.getElementById("ai-uses-left").textContent=`${X-Ee}/${X}`;const me=document.getElementById("ai-result-container");me.textContent=N.result||"La IA no devolvió un resultado válido.",me.classList.remove("hidden"),n.classList.add("hidden"),document.getElementById("apply-ai-btn").classList.remove("hidden"),document.getElementById("regenerate-ai-btn").classList.remove("hidden")}catch(A){/limit/i.test(A.message)||window.showToast("No se pudo generar la mejora. Revisa la consola.","error")}finally{t.disabled=!1,t.textContent=e?"Reintentar":"Mejorar Texto"}}handleApplyAi(){const e=document.getElementById("ai-result-container").textContent;this.aiModalCallback&&this.aiModalCallback(e),this.closeAiModal()}}class En{constructor(e){var t;this.app=e,this.iti=null,this.currentStep=1,this.totalSteps=4,this.modal=document.getElementById("wizard-modal"),this.prevBtn=document.getElementById("wizard-prev-btn"),this.nextBtn=document.getElementById("wizard-next-btn"),this.finishBtn=document.getElementById("wizard-finish-btn"),this.closeBtn=document.getElementById("close-wizard-btn"),this.stepIndicator=document.getElementById("wizard-step-indicator"),this.companyForm=document.getElementById("wizard-company-form"),this.qaForm=((t=this.modal)==null?void 0:t.querySelector("#wizard-qa-form"))||null,this.qrContainer=document.getElementById("wizard-qr-container"),this.requestQrBtn=document.getElementById("wizard-request-qr-btn"),this.syncContactsBtn=document.getElementById("wizard-sync-contacts-btn"),this.companySnapshot=null,this.setupListeners()}setupListeners(){var n,p,b,_;this.prevBtn.addEventListener("click",()=>this.changeStep(-1)),this.nextBtn.addEventListener("click",()=>this.changeStep(1)),this.finishBtn.addEventListener("click",()=>this.finish()),this.closeBtn.addEventListener("click",()=>this.hide()),(n=this.requestQrBtn)==null||n.addEventListener("click",()=>this.app.checkWhatsappConnection(!0)),(p=this.syncContactsBtn)==null||p.addEventListener("click",()=>this.handleSyncClick()),(b=this.modal.querySelector("#wizard-upload-logo-btn"))==null||b.addEventListener("click",()=>this.modal.querySelector("#wizard-logo-input").click()),(_=this.modal.querySelector("#wizard-logo-input"))==null||_.addEventListener("change",B=>this.previewLogo(B.target.files[0]));const e=this.modal.querySelector("#wizard-appointments-enabled"),t=this.modal.querySelector("#wizard-appointments-config");e&&t&&e.addEventListener("change",B=>{B.target.checked?t.classList.remove("hidden"):t.classList.add("hidden")})}start(e=!1){this.currentStep=e?4:1,this.updateStepUI(),e||this.loadExistingCompanySettings(),this.modal.classList.remove("hidden"),document.body.classList.add("overflow-hidden")}hide(){this.modal.classList.add("hidden"),document.body.classList.remove("overflow-hidden")}changeStep(e){if(this.currentStep===3&&e>0){this.handleSettingsSave();return}const t=this.currentStep+e;t>=1&&t<=this.totalSteps&&(this.currentStep=t,this.updateStepUI())}updateStepUI(){this.modal.querySelectorAll(".wizard-step").forEach(t=>t.classList.add("hidden"));const e=document.getElementById(`wizard-step-${this.currentStep}`);e&&e.classList.remove("hidden"),this.prevBtn.disabled=this.currentStep===1,this.nextBtn.classList.toggle("hidden",this.currentStep>=this.totalSteps),this.finishBtn.classList.toggle("hidden",this.currentStep!==this.totalSteps),this.currentStep===3?this.nextBtn.innerHTML="Guardar y Seguir":this.nextBtn.innerHTML="Siguiente",this.stepIndicator.textContent=`Paso ${this.currentStep} de ${this.totalSteps}`}previewLogo(e){if(!e||!this.modal)return;const t=this.modal.querySelector("#wizard-logo-preview"),n=new FileReader;n.onload=p=>{t.src=p.target.result},n.readAsDataURL(e)}async loadExistingCompanySettings(){var e,t;try{if(!this.companyForm)return;const{data:n,error:p}=await window.auth.sb.from("profiles").select("work_start_hour, work_end_hour, company_description, website, social_media, branding_settings, contact_phone, organization_id").single();if(p&&p.code!=="PGRST116")throw p;if(!n)return;if(n.organization_id){const{data:b,error:_}=await window.auth.sb.from("organizations").select("name").eq("id",n.organization_id).single();if(!_&&b&&b.name){const B=this.companyForm.querySelector("#wizard-company-name");B&&(B.value=b.name)}}this.companySnapshot={work_start_hour:n.work_start_hour??null,work_end_hour:n.work_end_hour??null,company_description:n.company_description??"",website:n.website??"",social_media:n.social_media??{},branding_settings:n.branding_settings??{},contact_phone:n.contact_phone??null},n.work_start_hour&&(this.companyForm.querySelector("#wizard-work-start-hour").value=`${String(n.work_start_hour).padStart(2,"0")}:00`),n.work_end_hour&&(this.companyForm.querySelector("#wizard-work-end-hour").value=`${String(n.work_end_hour).padStart(2,"0")}:00`),n.company_description&&(this.companyForm.querySelector("#wizard-company-description").value=n.company_description),n.website&&(this.companyForm.querySelector("#wizard-website").value=n.website),n.social_media&&(this.companyForm.querySelector("#wizard-social-instagram").value=n.social_media.instagram||"",this.companyForm.querySelector("#wizard-social-facebook").value=n.social_media.facebook||""),(e=n.branding_settings)!=null&&e.logo_url&&(this.companyForm.querySelector("#wizard-logo-preview").src=n.branding_settings.logo_url),(t=n.branding_settings)!=null&&t.colors&&n.branding_settings.colors.forEach((b,_)=>{const B=this.companyForm.querySelector(`#wizard-brand-color-${_+1}`);B&&(B.value=b)}),n.contact_phone&&this.iti&&this.iti.setNumber(n.contact_phone);try{const{data:b,error:_}=await window.auth.sb.from("appointment_settings").select("business_type, is_enabled, timezone, default_duration_minutes, buffer_time_minutes, advance_booking_days").eq("user_id",this.app.user.id).maybeSingle();if(!_&&b){const B=this.companyForm.querySelector("#wizard-business-type");B&&b.business_type?B.value=b.business_type:B&&(B.value="both");const A=this.companyForm.querySelector("#wizard-appointments-enabled");if(A){A.checked=b.is_enabled||!1;const N=this.companyForm.querySelector("#wizard-appointments-config");N&&(b.is_enabled?N.classList.remove("hidden"):N.classList.add("hidden"))}if(b.is_enabled){const N=this.companyForm.querySelector("#wizard-appointment-timezone");N&&b.timezone&&(N.value=b.timezone);const H=this.companyForm.querySelector("#wizard-appointment-default-duration");H&&b.default_duration_minutes&&(H.value=b.default_duration_minutes)}}else _&&_.code!=="PGRST116"&&console.warn("[Wizard] Error al cargar configuración de citas:",_)}catch(b){console.warn("[Wizard] Error al cargar appointment_settings:",b)}}catch(n){console.error("Error al precargar datos de la empresa en el wizard:",n)}}async handleSettingsSave(){var e,t,n,p,b,_;this.nextBtn.disabled=!0,this.nextBtn.innerHTML='<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';try{const B=this.companyForm.querySelector("#wizard-logo-input").files[0];let A=(e=this.companyForm.querySelector("#wizard-logo-preview"))==null?void 0:e.src;B&&(A=await this.app.uploadAsset(B,"logos"));const N={logo_url:A.startsWith("https")?A:null,colors:Array.from({length:4},(Y,Ie)=>this.companyForm.querySelector(`#wizard-brand-color-${Ie+1}`).value)},H=this.companyForm.querySelector("#wizard-work-start-hour").value,U=this.companyForm.querySelector("#wizard-work-end-hour").value,X=this.companyForm.querySelector("#wizard-admin-phone-input").value.trim()||null,Ee=((t=this.companyForm.querySelector("#wizard-company-name"))==null?void 0:t.value.trim())||null,{data:me,error:W}=await window.auth.sb.from("profiles").select("organization_id").eq("id",this.app.user.id).single();if(W&&console.error("[Wizard] Error al obtener perfil:",W),Ee&&me&&me.organization_id){const{error:Y}=await window.auth.sb.from("organizations").update({name:Ee}).eq("id",me.organization_id);Y?console.warn("[Wizard] Error al actualizar nombre de empresa:",Y):console.log("[Wizard] Nombre de empresa actualizado en organizations")}const ue={work_start_hour:H?parseInt(H.split(":")[0]):null,work_end_hour:U?parseInt(U.split(":")[0]):null,company_description:this.companyForm.querySelector("#wizard-company-description").value,website:this.companyForm.querySelector("#wizard-website").value,social_media:{instagram:this.companyForm.querySelector("#wizard-social-instagram").value,facebook:this.companyForm.querySelector("#wizard-social-facebook").value},contact_phone:X,branding_settings:N},{error:te}=await window.auth.sb.from("profiles").update(ue).eq("id",this.app.user.id);if(te)throw te;const re=((n=this.companyForm.querySelector("#wizard-business-type"))==null?void 0:n.value)||"both",ne={user_id:this.app.user.id,business_type:re};if(((p=this.companyForm.querySelector("#wizard-appointments-enabled"))==null?void 0:p.checked)||!1){const Y=((b=this.companyForm.querySelector("#wizard-appointment-timezone"))==null?void 0:b.value)||"America/Mexico_City",Ie=parseInt((_=this.companyForm.querySelector("#wizard-appointment-default-duration"))==null?void 0:_.value)||60;ne.is_enabled=!0,ne.calendar_type="internal",ne.timezone=Y,ne.default_duration_minutes=Ie,ne.buffer_time_minutes=0,ne.advance_booking_days=30}else ne.is_enabled=!1;const{error:ce}=await window.auth.sb.from("appointment_settings").upsert(ne,{onConflict:"user_id"});ce?console.warn("[Wizard] Error al guardar configuración de citas:",ce):console.log("[Wizard] Configuración de citas y tipo de negocio guardada"),this.companySnapshot={...ue,branding_settings:N},window.showToast("Información de la empresa guardada.","success"),this.currentStep++,this.updateStepUI()}catch(B){console.error("Error al guardar configuración desde el wizard:",B),window.showToast("No se pudo guardar la información de la empresa.","error")}finally{this.nextBtn.disabled=!1,this.nextBtn.innerHTML="Guardar y Seguir"}}async handleSyncClick(){const e=this.syncContactsBtn;if(!e||e.disabled)return;const t=e.innerHTML;e.disabled=!0,e.innerHTML='<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>';try{const n=this.app.user.id;if(!(await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/sync-labels-final",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:n})})).ok)throw new Error("La solicitud al webhook de sincronización falló.");window.showToast("Sincronización iniciada. Esto puede tardar unos minutos.","info"),setTimeout(()=>{e.disabled=!1,e.innerHTML=t},6e4)}catch(n){console.error("Error al iniciar la sincronización desde el wizard:",n),window.showToast("No se pudo iniciar la sincronización.","error"),e.disabled=!1,e.innerHTML=t}}async finish(){var e;this.modal.querySelectorAll(".wizard-step").forEach(t=>t.classList.add("hidden")),document.getElementById("wizard-step-5").classList.remove("hidden"),document.getElementById("wizard-loading").classList.remove("hidden"),document.getElementById("wizard-success").classList.add("hidden"),this.prevBtn.parentElement.classList.add("hidden");try{const t=this.qaForm||((e=this.modal)==null?void 0:e.querySelector("#wizard-qa-form"));if(!t)throw new Error("No se encontro el formulario de preguntas del wizard.");const n=new FormData(t),p=Object.fromEntries(n.entries()),b=this.buildPromptFromAnswers(p),_=document.getElementById("ai-master-prompt");_.value=b,await this.app.handlePromptSave(new Event("submit",{cancelable:!0})),document.getElementById("wizard-loading").classList.add("hidden"),document.getElementById("wizard-success").classList.remove("hidden"),setTimeout(()=>this.hide(),4e3)}catch(t){console.error("Error al finalizar el wizard:",t),window.showToast("No se pudo generar el prompt. Inténtalo de nuevo.","error"),this.currentStep=4,this.updateStepUI(),this.prevBtn.parentElement.classList.remove("hidden")}}buildPromptFromAnswers(e){var s,r;const t=w=>(w||"").trim(),n=t(e.negocio);t(e.cliente);const p=t(e.problema),b=t(e.diferenciador),_=t(e.tono)||"amigable, profesional y proactivo",B=t(e.no_hacer),A=t(e.precios),N=t(e.info_prospecto),H=t(e.info_adicional),U=this.companySnapshot||{};t(U.company_description);const X=t(U.website),Ee=t(U.contact_phone),me=t((s=U.social_media)==null?void 0:s.instagram),W=t((r=U.social_media)==null?void 0:r.facebook),ue=typeof U.work_start_hour=="number"?U.work_start_hour:null,te=typeof U.work_end_hour=="number"?U.work_end_hour:null,re=n?`Eres el asistente principal de WhatsApp para ${n}.`:"Eres un asistente virtual de WhatsApp enfocado en ventas, soporte y retencion.",ne=p?`Tu objetivo es resolver la necesidad principal del cliente: ${p}.`:"Tu objetivo es guiar, asesorar y convertir conversaciones de WhatsApp en oportunidades de negocio.",be=`Tu tono debe ser ${_}.`,ce=H?"Basa tus respuestas en el contexto proporcionado por el negocio y en los datos que recibas en la conversacion. Si algo no esta en el contexto, puedes apoyarte en tu conocimiento general, pero debes indicarlo explicitamente.":"Debes basar TODAS tus respuestas unicamente en la informacion proporcionada por el usuario y en los datos recopilados durante la conversacion. Si no tienes un dato, solicita confirmacion.",Y=["Redacta mensajes breves, claros y pensados para WhatsApp; separa ideas con lineas en blanco.",`Manten el tono descrito en CORE_IDENTITY en cada mensaje (${_}).`];N?Y.push(`Cuando hables con nuevos prospectos, intenta obtener: ${N}.`):Y.push("Cuando recibas un posible prospecto, formula preguntas para conocer necesidad, presupuesto y forma de contacto."),A&&Y.push(`Sigue estas pautas cuando consulten precios: ${A}.`),ue!==null&&te!==null&&Y.push(`Respeta el horario de atencion: ${ue}:00 a ${te}:00 hora local. Si escriben fuera de horario, agenda seguimiento.`),Ee&&Y.push(`Cuando sea necesario escalar, ofrece el numero directo ${Ee} o agenda una llamada.`);const Ie=["No inventes precios, promociones ni compromisos si no fueron confirmados.","No compartas informacion confidencial o interna que el negocio no haya autorizado.","No olvides indicar cuando necesitas que un humano continúe la conversacion."];B&&B.split(/[\n.;]+/g).map(a=>t(a)).filter(Boolean).forEach(a=>{const i=a.toLowerCase().startsWith("no")?a:`No ${a}`;Ie.push(i)});const _e=["Analizar: identifica la intencion principal del mensaje (venta, soporte, seguimiento o small talk).","Consultar: repasa la base de conocimiento interna del negocio y la informacion recopilada en la conversacion."];A?_e.push("Formular: responde siguiendo las reglas de tono, precios y objetivos del negocio. Ofrece valor y menciona diferenciales cuando sea oportuno."):_e.push("Formular: responde siguiendo las reglas de tono y objetivos del negocio. Ofrece valor y menciona diferenciales cuando sea oportuno."),_e.push("Verificar: antes de enviar, confirma que cumples todas las reglas DO y DON'T, y agrega una pregunta de seguimiento cuando corresponda.");const oe=["Usa texto plano con parrafos de maximo 2 oraciones cada uno. Separa parrafos con una linea en blanco.","Incluye bullets simples (-) solo cuando enumeres opciones o pasos.","Cierra con una pregunta o un siguiente paso claro para mantener la conversacion viva.","Utiliza emojis solo cuando aporten cercania sin afectar la claridad."],ae="Hola, vi su anuncio y quiero saber en que pueden ayudarme.",D=[];D.push("Hola, gracias por escribirnos. "+(n||"Estamos aqui para ayudarte a obtener resultados concretos.")),b&&D.push(`Nos destacamos porque ${b}.`),D.push(N?`Te parece si me cuentas ${N.toLowerCase()}?`:"Te parece si me cuentas que servicio buscas y que objetivo tienes?");const c=D.join(" "),o="Cuanto cuesta su servicio principal?",m=[];A?m.push(A):m.push("Nuestros precios varian segun el alcance. Prefiero entender tu caso para darte una propuesta justa."),m.push(N?`Podrias compartir ${N.toLowerCase()}?`:"Me cuentas que necesitas y en que plazo para prepararte una propuesta?");const g=m.join(" "),k="Necesito un descuento grande, hazlo ya.",f="Claro, te doy 50% de descuento ahora mismo.",u=B?`Quiero apoyarte, pero ${B}. Puedo revisar alternativas con nuestro equipo si me das tus datos.`:"Quiero apoyarte, pero no puedo aprobar descuentos sin validar internamente. Puedo llevar tu caso con un asesor si me compartes tus datos.",l=[];if(l.push("# INICIO DE INSTRUCCIONES DE SISTEMA"),l.push(""),l.push("## 1. CORE_IDENTITY (Identidad y Rol)"),l.push(`**Rol:** ${re}`),l.push(`**Proposito Principal:** ${ne}`),l.push(`**Personalidad/Tono:** ${be}`),l.push(""),l.push("## 2. KNOWLEDGE_BASE (Base de Conocimiento)"),l.push(`**Alcance:** ${ce}`),X||me||W){const w=[];X&&w.push(`Sitio web: ${X}`),me&&w.push(`Instagram: ${me}`),W&&w.push(`Facebook: ${W}`),l.push(`**Fuentes de referencia disponibles:** ${w.join(" | ")}`)}return l.push(""),l.push("## 3. RULES (Reglas y Restricciones)"),l.push("**Reglas Obligatorias (DO):**"),Y.forEach(w=>l.push(`* ${w}`)),l.push("**Restricciones (DON'T):**"),Ie.forEach(w=>l.push(`* ${w}`)),l.push(""),l.push("## 4. PROCESS (Pasos a Seguir)"),l.push("**Al recibir una consulta del usuario, sigue estos pasos:**"),_e.forEach((w,a)=>l.push(`${a+1}. ${w}`)),l.push(""),l.push("## 5. OUTPUT_FORMAT (Formato de Salida)"),l.push("**Estructura de Respuesta:**"),oe.forEach(w=>l.push(`* ${w}`)),l.push(""),l.push("## 6. FEW-SHOT_LEARNING (Ejemplos de Comportamiento)"),l.push("**Ejemplo 1 (Bueno):**"),l.push(`* **Usuario:** "${ae}"`),l.push(`* **Asistente:** "${c}"`),l.push(""),l.push("**Ejemplo 2 (Bueno):**"),l.push(`* **Usuario:** "${o}"`),l.push(`* **Asistente:** "${g}"`),l.push(""),l.push("**Ejemplo 3 (Malo - Que evitar):**"),l.push(`* **Usuario:** "${k}"`),l.push(`* **Asistente (Incorrecto):** "${f}"`),l.push(`* **Asistente (Correcto):** "${u}"`),l.push(""),l.push("## 7. CONTEXT_AWARENESS (Conciencia de Contexto)"),l.push("**Reglas de Memoria Conversacional:**"),l.push(""),l.push("1. **NO REPITAS PREGUNTAS:**"),l.push("   - Si el cliente ya mencionó una cantidad, NO preguntes de nuevo"),l.push("   - Si el cliente ya mencionó una marca, NO preguntes de nuevo"),l.push("   - Si el cliente ya mencionó un modelo, NO preguntes de nuevo"),l.push('   - Si el cliente ya mencionó un producto, NO preguntes "¿qué producto necesitas?"'),l.push(""),l.push("2. **REVISA EL HISTORIAL COMPLETO:**"),l.push("   - Antes de hacer cualquier pregunta, revisa TODO el historial de la conversación"),l.push("   - Identifica qué información YA tienes"),l.push("   - Identifica qué información FALTA"),l.push("   - Usa la información del historial para evitar redundancias"),l.push(""),l.push("3. **PREGUNTA SOLO LO NECESARIO:**"),l.push("   - Si tienes producto + cantidad + marca → Procede directamente"),l.push("   - Si falta información crítica → Pregunta SOLO por lo que falta"),l.push("   - Si tienes suficiente → Ofrece agregar al carrito o generar cotización"),l.push(""),l.push("4. **CONFIRMACIÓN INTELIGENTE:**"),l.push("   - En lugar de preguntar de nuevo, confirma lo que entendiste:"),l.push('   - ❌ "¿Cuántas piezas necesitas?" (si ya lo dijo)'),l.push('   - ✅ "Perfecto, 3 piezas de CE285A para HP. ¿Algo más?"'),l.push(""),l.push("5. **PROACTIVIDAD:**"),l.push("   - Si detectas intención de compra clara, ofrece directamente:"),l.push('   - "¿Quieres que prepare tu cotización ahora?"'),l.push('   - "¿Te agrego esto a tu pedido?"'),l.push(""),l.push("6. **MENSAJES CONCISOS:**"),l.push("   - Evita escribir párrafos largos cuando una frase corta es suficiente"),l.push('   - Si el cliente pregunta "precio", responde directamente con el precio, no con un párrafo explicativo'),l.push("   - Mantén las respuestas relevantes y al punto"),l.join(`
`)}}Ht.prototype.renderWhatsappConnection=function(z,e=null,t=null){const n={el:document.getElementById("whatsapp-connection-container"),btn:document.getElementById("request-qr-btn")},p={el:document.getElementById("wizard-qr-container"),btn:document.getElementById("wizard-request-qr-btn")},b=[n];p.el&&!document.getElementById("wizard-modal").classList.contains("hidden")&&b.push(p),b.forEach(_=>{if(!_.el)return;let B="";switch(z){case"connected":B='<div class="flex flex-col items-center justify-center text-green-600 py-4"><i data-lucide="check-circle" class="w-16 h-16"></i><p class="font-bold mt-2">¡Conectado!</p></div>',_.btn&&(_.btn.style.display="none");break;case"loading":B='<div class="flex justify-center items-center min-h-[200px]"><div class="animate-spin rounded-full h-16 w-16 border-b-2 border-slate-900"></div></div>',_.btn&&(_.btn.style.display="block");break;case"qr":B=`<img src="data:image/png;base64,${e}" alt="Escanea para conectar WhatsApp" class="mx-auto max-w-full h-auto rounded-lg">`,_.btn&&(_.btn.style.display="block");break;case"error":B='<div class="flex flex-col items-center justify-center text-red-500 py-4"><i data-lucide="alert-triangle" class="w-16 h-16"></i><p class="font-bold mt-2">Error de Conexión</p></div>',_.btn&&(_.btn.style.display="block");break;case"initial":default:B='<div class="flex flex-col items-center justify-center text-slate-400 py-4"><i data-lucide="qr-code" class="w-16 h-16"></i><p class="font-bold mt-2">Solicita el QR para vincular</p></div>',_.btn&&(_.btn.style.display="block");break}_.el.innerHTML=B}),lucide.createIcons()};Ht.prototype.checkWhatsappConnection=async function(z=!1,e=null){const t=document.getElementById("wizard-modal"),p=t&&!t.classList.contains("hidden")?"wizard-qr-container":null;this.renderWhatsappConnection("loading",null,p);const b=`${this.config.N8N_URL}/webhook/generate-whatsapp-qr-Elina`;try{const _=await fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:this.user.email})});if(!_.ok)throw new Error("El servidor N8N no responde correctamente.");const B=await _.text(),A=B.trim();if(!A){this.renderWhatsappConnection("connected",null,p);return}let N;try{N=JSON.parse(A)}catch(X){console.warn("Respuesta QR inesperada, se esperaba JSON.",X,B),this.renderWhatsappConnection("error",null,p);return}const H=Array.isArray(N)?N[0]:N,U=H!=null&&H.qr_image_data?"qr":"connected";this.renderWhatsappConnection(U,H==null?void 0:H.qr_image_data,p)}catch(_){console.error("Error al solicitar QR:",_),this.renderWhatsappConnection("error",null,p)}};
