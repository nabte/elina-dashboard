(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const e of t)if(e.type==="childList")for(const s of e.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function r(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?e.credentials="include":t.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function o(t){if(t.ep)return;t.ep=!0;const e=r(t);fetch(t.href,e)}})();const g="https://mytvwfbijlgbihlegmfg.supabase.co",p="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15dHZ3ZmJpamxnYmlobGVnbWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MTg5OTAsImV4cCI6MjA2OTk5NDk5MH0.eFL6N7pR4nmpOLywRwxZS_sEWwSbq5WGAnY0zBMreDE",w=`${g}/functions/v1`;function y(){let i=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),n=localStorage.getItem("superadmin_session_tokens");const r=new Set(["/","/index","/index.html","/forgot-password.html","/reset-password.html"]),o=(()=>{const a=window.location.pathname||"/",[l]=a.split("?"),d=l.replace(/\/+$/,"")||"/";return d===""?"/":d})(),t=r.has(o);let e={},s=null;if(n)try{s=JSON.parse(n)}catch(a){console.warn("[auth] Tokens de superadmin corruptos. Se eliminan.",a),localStorage.removeItem("superadmin_session_tokens")}return i&&(!s||!s.access_token||!s.refresh_token||t)&&(localStorage.removeItem("impersonated_user_info"),i=null),t&&n&&(localStorage.removeItem("superadmin_session_tokens"),n=null,s=null),!t&&i&&(s!=null&&s.access_token)&&(s!=null&&s.refresh_token)&&(console.log(`Modo suplantaci칩n activo. Actuando como: ${i.id}`),e={global:{headers:{"X-Impersonated-User-ID":i.id}}}),window.supabase.createClient(g,p,e)}window.auth={sb:y(),session:null,async invokeFunction(i,{method:n="POST",body:r,headers:o={},signal:t}={}){var m;const e={Accept:"application/json",apikey:p,...o};let s;r!==void 0&&(r instanceof FormData||r instanceof Blob?s=r:typeof r=="string"?(s=r,e["Content-Type"]||(e["Content-Type"]="application/json")):(s=JSON.stringify(r),e["Content-Type"]||(e["Content-Type"]="application/json")));const{data:a,error:l}=await this.sb.auth.getSession();l&&console.error("[invokeFunction] Error obteniendo la sesion actual:",l);const d=(m=a==null?void 0:a.session)==null?void 0:m.access_token;d&&(e.Authorization=`Bearer ${d}`);const u=await fetch(`${w}/${i}`,{method:n,headers:e,body:n==="GET"||n==="HEAD"?void 0:s,signal:t}),h=await u.text();let c=null;if(h)try{c=JSON.parse(h)}catch{c=h}return u.ok?{data:c,error:null}:{data:null,error:{message:(c&&typeof c=="object"?c.error||c.message:null)||`Function ${i} respondio con estado ${u.status}`,status:u.status,details:c}}},handleAuthStateChange(i,n){this.session=n;const r=window.location.pathname.endsWith("/")||window.location.pathname.endsWith("/index.html");if(n&&r){this.sb.from("profiles").select("role").eq("id",n.user.id).single().then(({data:o,error:t})=>{if(o&&o.role==="superadmin"){window.location.href="/dashboard.html";return}this.sb.rpc("get_user_team_info").then(({data:e,error:s})=>{if(s){console.error("Error fetching team info:",s),window.location.href="/dashboard.html";return}const a=(e==null?void 0:e.user_role)||(e==null?void 0:e.role);e&&a==="admin"&&console.log("Usuario es admin de empresa, pero redirigiendo a dashboard por seguridad"),window.location.href="/dashboard.html"})}).catch(o=>{console.error("Error checking profile:",o),window.location.href="/dashboard.html"});return}if(!n&&!r){window.location.href="/";return}document.dispatchEvent(new CustomEvent("auth:ready",{detail:{session:n}}))},getSession(){return this.session},async handleLogin(i){var t,e;i.preventDefault();const n=i.target,r=(t=document.getElementById("login-email"))==null?void 0:t.value,o=(e=document.getElementById("login-password"))==null?void 0:e.value;this.setLoadingState(n,!0,"Verificando...");try{if(!r||!o)throw new Error("Credenciales incompletas");const{error:s}=await this.sb.auth.signInWithPassword({email:r,password:o});if(s)throw s}catch(s){const a=s.message==="Invalid login credentials"?"Correo o contrase침a incorrectos.":s.message;this.setLoadingState(n,!1,"Iniciar Sesi칩n",a)}},async handleRegister(i){var s,a,l,d;i.preventDefault();const n=i.target,r=(s=document.getElementById("register-email"))==null?void 0:s.value,o=(a=document.getElementById("register-password"))==null?void 0:a.value,t=(l=document.getElementById("register-name"))==null?void 0:l.value,e=window.iti?window.iti.getNumber():(d=document.getElementById("register-phone"))==null?void 0:d.value;this.setLoadingState(n,!0,"Creando...");try{if(!r||!o||!t||!e)throw new Error("Todos los campos son obligatorios.");const{data:u,error:h}=await this.sb.auth.signUp({email:r,password:o,options:{data:{full_name:t,phone:e}}});if(h)throw h;if(u.user){try{await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/volution-instance-create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nombre:t,email:r,telefono_admin:e,Passwr:o})})}catch(m){console.error("Error al llamar al webhook de n8n, pero el registro de usuario continu칩:",m)}n.style.display="none";const c=document.getElementById("register-success-message");c.classList.remove("hidden"),lucide.createIcons({nodes:[c.querySelector("i")]})}}catch(u){this.setLoadingState(n,!1,"Crear Cuenta",u.message)}},async handleLogout(){try{await this.sb.auth.signOut()}catch(i){console.error("[Logout Error]",i)}},setLoadingState(i,n,r,o=null){const t=i.querySelector('button[type="submit"]'),e=t.querySelector(".button-text"),s=t.querySelector(".loading-spinner"),a=document.getElementById("error-message"),l=document.getElementById("error-text");n?(t.disabled=!0,s.classList.remove("hidden"),e.textContent=r,a.style.display="none"):(t.disabled=!1,s.classList.add("hidden"),e.textContent=r,o?(l.textContent=o,a.style.display="flex",console.error("[Auth Error]",o)):a.style.display="none")}};window.auth.sb.auth.onAuthStateChange((i,n)=>{window.auth.handleAuthStateChange(i,n)});window.getUserId=async()=>{var i,n,r,o,t,e,s;try{if((i=window.auth)!=null&&i.getSession){const l=window.auth.getSession();if((n=l==null?void 0:l.user)!=null&&n.id)return l.user.id}if((o=(r=window.appInstance)==null?void 0:r.user)!=null&&o.id)return window.appInstance.user.id;const a=JSON.parse(localStorage.getItem("impersonated_user_info")||"null");if(a!=null&&a.id)return a.id;if((t=window.auth)!=null&&t.sb){const{data:l,error:d}=await window.auth.sb.auth.getSession();if(!d&&((s=(e=l==null?void 0:l.session)==null?void 0:e.user)!=null&&s.id))return l.session.user.id}return null}catch(a){return console.error("[getUserId] Error al obtener ID de usuario:",a),null}};window.setValue=(i,n,r=!1)=>{const o=document.getElementById(i);if(!o){console.warn(`[setValue] Elemento no encontrado: ${i}`);return}r?o.checked=n:o.value=n||""};let f;window.showToast=(i,n="success",r=5e3)=>{const o=document.getElementById("toast-notification"),t=document.getElementById("toast-message"),e=document.getElementById("toast-icon");!o||!t||!e||(f&&clearTimeout(f),t.textContent=i,o.classList.remove("bg-green-500","bg-red-500","bg-blue-500"),o.classList.remove("translate-y-[150%]"),n==="success"?(o.classList.add("bg-green-500"),e.setAttribute("data-lucide","check-circle")):n==="error"?(o.classList.add("bg-red-500"),e.setAttribute("data-lucide","alert-circle")):(o.classList.add("bg-blue-500"),e.setAttribute("data-lucide","info")),lucide.createIcons(),o.classList.remove("hidden"),o.classList.remove("translate-x-[120%]"),f=setTimeout(()=>o.classList.add("translate-x-[120%]"),r))};
