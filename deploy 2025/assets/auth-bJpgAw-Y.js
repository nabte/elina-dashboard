(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const e of t)if(e.type==="childList")for(const o of e.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function r(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?e.credentials="include":t.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function n(t){if(t.ep)return;t.ep=!0;const e=r(t);fetch(t.href,e)}})();const p="https://mytvwfbijlgbihlegmfg.supabase.co",g="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15dHZ3ZmJpamxnYmlobGVnbWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MTg5OTAsImV4cCI6MjA2OTk5NDk5MH0.eFL6N7pR4nmpOLywRwxZS_sEWwSbq5WGAnY0zBMreDE",w=`${p}/functions/v1`;function y(){let i=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),s=localStorage.getItem("superadmin_session_tokens");const r=new Set(["/","/index","/index.html","/forgot-password.html","/reset-password.html"]),n=(()=>{const a=window.location.pathname||"/",[d]=a.split("?"),u=d.replace(/\/+$/,"")||"/";return u===""?"/":u})(),t=r.has(n);let e={},o=null;if(s)try{o=JSON.parse(s)}catch(a){console.warn("[auth] Tokens de superadmin corruptos. Se eliminan.",a),localStorage.removeItem("superadmin_session_tokens")}return i&&(!o||!o.access_token||!o.refresh_token||t)&&(localStorage.removeItem("impersonated_user_info"),i=null),t&&s&&(localStorage.removeItem("superadmin_session_tokens"),s=null,o=null),!t&&i&&(o!=null&&o.access_token)&&(o!=null&&o.refresh_token)&&(console.log(`Modo suplantación activo. Actuando como: ${i.id}`),e={global:{headers:{"X-Impersonated-User-ID":i.id}}}),window.supabase.createClient(p,g,e)}window.auth={sb:y(),session:null,async invokeFunction(i,{method:s="POST",body:r,headers:n={},signal:t}={}){var m;const e={Accept:"application/json",apikey:g,...n};let o;r!==void 0&&(r instanceof FormData||r instanceof Blob?o=r:typeof r=="string"?(o=r,e["Content-Type"]||(e["Content-Type"]="application/json")):(o=JSON.stringify(r),e["Content-Type"]||(e["Content-Type"]="application/json")));const{data:a,error:d}=await this.sb.auth.getSession();d&&console.error("[invokeFunction] Error obteniendo la sesion actual:",d);const u=(m=a==null?void 0:a.session)==null?void 0:m.access_token;u&&(e.Authorization=`Bearer ${u}`);const l=await fetch(`${w}/${i}`,{method:s,headers:e,body:s==="GET"||s==="HEAD"?void 0:o,signal:t}),h=await l.text();let c=null;if(h)try{c=JSON.parse(h)}catch{c=h}return l.ok?{data:c,error:null}:{data:null,error:{message:(c&&typeof c=="object"?c.error||c.message:null)||`Function ${i} respondio con estado ${l.status}`,status:l.status,details:c}}},handleAuthStateChange(i,s){this.session=s;const r=window.location.pathname.endsWith("/")||window.location.pathname.endsWith("/index.html");if(s&&r){this.sb.from("profiles").select("role").eq("id",s.user.id).single().then(({data:n,error:t})=>{if(n&&n.role==="superadmin"){window.location.href="/dashboard.html";return}this.sb.rpc("get_user_team_info").then(({data:e,error:o})=>{if(o){console.error("Error fetching team info:",o),window.location.href="/dashboard.html";return}const a=(e==null?void 0:e.user_role)||(e==null?void 0:e.role);e&&a==="admin"&&console.log("Usuario es admin de empresa, pero redirigiendo a dashboard por seguridad"),window.location.href="/dashboard.html"})}).catch(n=>{console.error("Error checking profile:",n),window.location.href="/dashboard.html"});return}if(!s&&!r){window.location.href="/";return}document.dispatchEvent(new CustomEvent("auth:ready",{detail:{session:s}}))},getSession(){return this.session},async handleLogin(i){var t,e;i.preventDefault();const s=i.target,r=(t=document.getElementById("login-email"))==null?void 0:t.value,n=(e=document.getElementById("login-password"))==null?void 0:e.value;this.setLoadingState(s,!0,"Verificando...");try{if(!r||!n)throw new Error("Credenciales incompletas");const{error:o}=await this.sb.auth.signInWithPassword({email:r,password:n});if(o)throw o}catch(o){const a=o.message==="Invalid login credentials"?"Correo o contraseña incorrectos.":o.message;this.setLoadingState(s,!1,"Iniciar Sesión",a)}},async handleRegister(i){var o,a,d,u;i.preventDefault();const s=i.target,r=(o=document.getElementById("register-email"))==null?void 0:o.value,n=(a=document.getElementById("register-password"))==null?void 0:a.value,t=(d=document.getElementById("register-name"))==null?void 0:d.value,e=window.iti?window.iti.getNumber():(u=document.getElementById("register-phone"))==null?void 0:u.value;this.setLoadingState(s,!0,"Creando...");try{if(!r||!n||!t||!e)throw new Error("Todos los campos son obligatorios.");const{data:l,error:h}=await this.sb.auth.signUp({email:r,password:n,options:{data:{full_name:t,phone:e}}});if(h)throw h;if(l.user){const c=new Date;c.setDate(c.getDate()+7);const{error:m}=await this.sb.from("subscriptions").insert({user_id:l.user.id,trial_ends_at:c.toISOString()});m&&console.error("Error creando la suscripción de prueba:",m)}if(l.user){try{await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/volution-instance-create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nombre:t,email:r,telefono_admin:e,Passwr:n})})}catch(m){console.error("Error al llamar al webhook de n8n, pero el registro de usuario continuó:",m)}s.style.display="none";const c=document.getElementById("register-success-message");c.classList.remove("hidden"),lucide.createIcons({nodes:[c.querySelector("i")]})}}catch(l){this.setLoadingState(s,!1,"Crear Cuenta",l.message)}},async handleLogout(){try{await this.sb.auth.signOut()}catch(i){console.error("[Logout Error]",i)}},setLoadingState(i,s,r,n=null){const t=i.querySelector('button[type="submit"]'),e=t.querySelector(".button-text"),o=t.querySelector(".loading-spinner"),a=document.getElementById("error-message"),d=document.getElementById("error-text");s?(t.disabled=!0,o.classList.remove("hidden"),e.textContent=r,a.style.display="none"):(t.disabled=!1,o.classList.add("hidden"),e.textContent=r,n?(d.textContent=n,a.style.display="flex",console.error("[Auth Error]",n)):a.style.display="none")}};window.auth.sb.auth.onAuthStateChange((i,s)=>{window.auth.handleAuthStateChange(i,s)});let f;window.showToast=(i,s="success",r=5e3)=>{const n=document.getElementById("toast-notification"),t=document.getElementById("toast-message"),e=document.getElementById("toast-icon");!n||!t||!e||(f&&clearTimeout(f),t.textContent=i,n.classList.remove("bg-green-500","bg-red-500","bg-blue-500"),n.classList.remove("translate-y-[150%]"),s==="success"?(n.classList.add("bg-green-500"),e.setAttribute("data-lucide","check-circle")):s==="error"?(n.classList.add("bg-red-500"),e.setAttribute("data-lucide","alert-circle")):(n.classList.add("bg-blue-500"),e.setAttribute("data-lucide","info")),lucide.createIcons(),n.classList.remove("hidden"),n.classList.remove("translate-x-[120%]"),f=setTimeout(()=>n.classList.add("translate-x-[120%]"),r))};
