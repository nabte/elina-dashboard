(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))o(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const a of t.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function s(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function o(e){if(e.ep)return;e.ep=!0;const t=s(e);fetch(e.href,t)}})();const g="https://mytvwfbijlgbihlegmfg.supabase.co",p="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15dHZ3ZmJpamxnYmlobGVnbWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MTg5OTAsImV4cCI6MjA2OTk5NDk5MH0.eFL6N7pR4nmpOLywRwxZS_sEWwSbq5WGAnY0zBMreDE",w=`${g}/functions/v1`;function y(){const r=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),n=localStorage.getItem("superadmin_session_tokens"),s=window.location.pathname.endsWith("/")||window.location.pathname.endsWith("/index.html");let o={},e=null;if(n)try{e=JSON.parse(n)}catch(t){console.warn("[auth] Tokens de superadmin corruptos. Se eliminan.",t),localStorage.removeItem("superadmin_session_tokens")}return r&&(!e||!e.access_token||!e.refresh_token||s)&&localStorage.removeItem("impersonated_user_info"),!s&&r&&(e!=null&&e.access_token)&&(e!=null&&e.refresh_token)&&(console.log(`Modo suplantación activo. Actuando como: ${r.id}`),o={global:{headers:{"X-Impersonated-User-ID":r.id}}}),window.supabase.createClient(g,p,o)}window.auth={sb:y(),session:null,async invokeFunction(r,{method:n="POST",body:s,headers:o={},signal:e}={}){var d;const t={Accept:"application/json",apikey:p,...o};let a;s!==void 0&&(s instanceof FormData||s instanceof Blob?a=s:typeof s=="string"?(a=s,t["Content-Type"]||(t["Content-Type"]="application/json")):(a=JSON.stringify(s),t["Content-Type"]||(t["Content-Type"]="application/json")));const{data:c,error:u}=await this.sb.auth.getSession();u&&console.error("[invokeFunction] Error obteniendo la sesion actual:",u);const h=(d=c==null?void 0:c.session)==null?void 0:d.access_token;h&&(t.Authorization=`Bearer ${h}`);const l=await fetch(`${w}/${r}`,{method:n,headers:t,body:n==="GET"||n==="HEAD"?void 0:a,signal:e}),m=await l.text();let i=null;if(m)try{i=JSON.parse(m)}catch{i=m}return l.ok?{data:i,error:null}:{data:null,error:{message:(i&&typeof i=="object"?i.error||i.message:null)||`Function ${r} respondio con estado ${l.status}`,status:l.status,details:i}}},handleAuthStateChange(r,n){this.session=n;const s=window.location.pathname.endsWith("/")||window.location.pathname.endsWith("/index.html");if(n&&s){this.sb.rpc("get_user_team_info").then(({data:o,error:e})=>{if(e){console.error("Error fetching team info:",e),window.location.href="/dashboard.html";return}o&&o.role==="admin"?window.location.href="/company-admin.html":window.location.href="/dashboard.html"});return}if(!n&&!s){window.location.href="/";return}document.dispatchEvent(new CustomEvent("auth:ready",{detail:{session:n}}))},getSession(){return this.session},async handleLogin(r){var e,t;r.preventDefault();const n=r.target,s=(e=document.getElementById("login-email"))==null?void 0:e.value,o=(t=document.getElementById("login-password"))==null?void 0:t.value;this.setLoadingState(n,!0,"Verificando...");try{if(!s||!o)throw new Error("Credenciales incompletas");const{error:a}=await this.sb.auth.signInWithPassword({email:s,password:o});if(a)throw a}catch(a){const c=a.message==="Invalid login credentials"?"Correo o contraseña incorrectos.":a.message;this.setLoadingState(n,!1,"Iniciar Sesión",c)}},async handleRegister(r){var a,c,u,h;r.preventDefault();const n=r.target,s=(a=document.getElementById("register-email"))==null?void 0:a.value,o=(c=document.getElementById("register-password"))==null?void 0:c.value,e=(u=document.getElementById("register-name"))==null?void 0:u.value,t=window.iti?window.iti.getNumber():(h=document.getElementById("register-phone"))==null?void 0:h.value;this.setLoadingState(n,!0,"Creando...");try{if(!s||!o||!e||!t)throw new Error("Todos los campos son obligatorios.");const{data:l,error:m}=await this.sb.auth.signUp({email:s,password:o,options:{data:{full_name:e,phone:t}}});if(m)throw m;if(l.user){const i=new Date;i.setDate(i.getDate()+7);const{error:d}=await this.sb.from("subscriptions").insert({user_id:l.user.id,trial_ends_at:i.toISOString()});d&&console.error("Error creando la suscripción de prueba:",d)}if(l.user){try{await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/volution-instance-create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nombre:e,email:s,telefono_admin:t,Passwr:o})})}catch(d){console.error("Error al llamar al webhook de n8n, pero el registro de usuario continuó:",d)}n.style.display="none";const i=document.getElementById("register-success-message");i.classList.remove("hidden"),lucide.createIcons({nodes:[i.querySelector("i")]})}}catch(l){this.setLoadingState(n,!1,"Crear Cuenta",l.message)}},async handleLogout(){try{await this.sb.auth.signOut()}catch(r){console.error("[Logout Error]",r)}},setLoadingState(r,n,s,o=null){const e=r.querySelector('button[type="submit"]'),t=e.querySelector(".button-text"),a=e.querySelector(".loading-spinner"),c=document.getElementById("error-message"),u=document.getElementById("error-text");n?(e.disabled=!0,a.classList.remove("hidden"),t.textContent=s,c.style.display="none"):(e.disabled=!1,a.classList.add("hidden"),t.textContent=s,o?(u.textContent=o,c.style.display="flex",console.error("[Auth Error]",o)):c.style.display="none")}};window.auth.sb.auth.onAuthStateChange((r,n)=>{window.auth.handleAuthStateChange(r,n)});let f;window.showToast=(r,n="success",s=5e3)=>{const o=document.getElementById("toast-notification"),e=document.getElementById("toast-message"),t=document.getElementById("toast-icon");!o||!e||!t||(f&&clearTimeout(f),e.textContent=r,o.classList.remove("bg-green-500","bg-red-500","bg-blue-500"),o.classList.remove("translate-y-[150%]"),n==="success"?(o.classList.add("bg-green-500"),t.setAttribute("data-lucide","check-circle")):n==="error"?(o.classList.add("bg-red-500"),t.setAttribute("data-lucide","alert-circle")):(o.classList.add("bg-blue-500"),t.setAttribute("data-lucide","info")),lucide.createIcons(),o.classList.remove("hidden"),o.classList.remove("translate-x-[120%]"),f=setTimeout(()=>o.classList.add("translate-x-[120%]"),s))};
