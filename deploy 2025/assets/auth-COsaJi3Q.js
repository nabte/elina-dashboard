(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const n of t.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function r(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function s(e){if(e.ep)return;e.ep=!0;const t=r(e);fetch(e.href,t)}})();const p="https://mytvwfbijlgbihlegmfg.supabase.co",g="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15dHZ3ZmJpamxnYmlobGVnbWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MTg5OTAsImV4cCI6MjA2OTk5NDk5MH0.eFL6N7pR4nmpOLywRwxZS_sEWwSbq5WGAnY0zBMreDE",w=`${p}/functions/v1`;function y(){let a=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),o=localStorage.getItem("superadmin_session_tokens");const r=new Set(["/","/index","/index.html"]),s=(()=>{const i=window.location.pathname||"/",[d]=i.split("?"),u=d.replace(/\/+$/,"")||"/";return u===""?"/":u})(),e=r.has(s);let t={},n=null;if(o)try{n=JSON.parse(o)}catch(i){console.warn("[auth] Tokens de superadmin corruptos. Se eliminan.",i),localStorage.removeItem("superadmin_session_tokens")}return a&&(!n||!n.access_token||!n.refresh_token||e)&&(localStorage.removeItem("impersonated_user_info"),a=null),e&&o&&(localStorage.removeItem("superadmin_session_tokens"),o=null,n=null),!e&&a&&(n!=null&&n.access_token)&&(n!=null&&n.refresh_token)&&(console.log(`Modo suplantación activo. Actuando como: ${a.id}`),t={global:{headers:{"X-Impersonated-User-ID":a.id}}}),window.supabase.createClient(p,g,t)}window.auth={sb:y(),session:null,async invokeFunction(a,{method:o="POST",body:r,headers:s={},signal:e}={}){var m;const t={Accept:"application/json",apikey:g,...s};let n;r!==void 0&&(r instanceof FormData||r instanceof Blob?n=r:typeof r=="string"?(n=r,t["Content-Type"]||(t["Content-Type"]="application/json")):(n=JSON.stringify(r),t["Content-Type"]||(t["Content-Type"]="application/json")));const{data:i,error:d}=await this.sb.auth.getSession();d&&console.error("[invokeFunction] Error obteniendo la sesion actual:",d);const u=(m=i==null?void 0:i.session)==null?void 0:m.access_token;u&&(t.Authorization=`Bearer ${u}`);const l=await fetch(`${w}/${a}`,{method:o,headers:t,body:o==="GET"||o==="HEAD"?void 0:n,signal:e}),h=await l.text();let c=null;if(h)try{c=JSON.parse(h)}catch{c=h}return l.ok?{data:c,error:null}:{data:null,error:{message:(c&&typeof c=="object"?c.error||c.message:null)||`Function ${a} respondio con estado ${l.status}`,status:l.status,details:c}}},handleAuthStateChange(a,o){this.session=o;const r=window.location.pathname.endsWith("/")||window.location.pathname.endsWith("/index.html");if(o&&r){this.sb.rpc("get_user_team_info").then(({data:s,error:e})=>{if(e){console.error("Error fetching team info:",e),window.location.href="/dashboard.html";return}s&&s.role==="admin"?window.location.href="/company-admin.html":window.location.href="/dashboard.html"});return}if(!o&&!r){window.location.href="/";return}document.dispatchEvent(new CustomEvent("auth:ready",{detail:{session:o}}))},getSession(){return this.session},async handleLogin(a){var e,t;a.preventDefault();const o=a.target,r=(e=document.getElementById("login-email"))==null?void 0:e.value,s=(t=document.getElementById("login-password"))==null?void 0:t.value;this.setLoadingState(o,!0,"Verificando...");try{if(!r||!s)throw new Error("Credenciales incompletas");const{error:n}=await this.sb.auth.signInWithPassword({email:r,password:s});if(n)throw n}catch(n){const i=n.message==="Invalid login credentials"?"Correo o contraseña incorrectos.":n.message;this.setLoadingState(o,!1,"Iniciar Sesión",i)}},async handleRegister(a){var n,i,d,u;a.preventDefault();const o=a.target,r=(n=document.getElementById("register-email"))==null?void 0:n.value,s=(i=document.getElementById("register-password"))==null?void 0:i.value,e=(d=document.getElementById("register-name"))==null?void 0:d.value,t=window.iti?window.iti.getNumber():(u=document.getElementById("register-phone"))==null?void 0:u.value;this.setLoadingState(o,!0,"Creando...");try{if(!r||!s||!e||!t)throw new Error("Todos los campos son obligatorios.");const{data:l,error:h}=await this.sb.auth.signUp({email:r,password:s,options:{data:{full_name:e,phone:t}}});if(h)throw h;if(l.user){const c=new Date;c.setDate(c.getDate()+7);const{error:m}=await this.sb.from("subscriptions").insert({user_id:l.user.id,trial_ends_at:c.toISOString()});m&&console.error("Error creando la suscripción de prueba:",m)}if(l.user){try{await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/volution-instance-create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nombre:e,email:r,telefono_admin:t,Passwr:s})})}catch(m){console.error("Error al llamar al webhook de n8n, pero el registro de usuario continuó:",m)}o.style.display="none";const c=document.getElementById("register-success-message");c.classList.remove("hidden"),lucide.createIcons({nodes:[c.querySelector("i")]})}}catch(l){this.setLoadingState(o,!1,"Crear Cuenta",l.message)}},async handleLogout(){try{await this.sb.auth.signOut()}catch(a){console.error("[Logout Error]",a)}},setLoadingState(a,o,r,s=null){const e=a.querySelector('button[type="submit"]'),t=e.querySelector(".button-text"),n=e.querySelector(".loading-spinner"),i=document.getElementById("error-message"),d=document.getElementById("error-text");o?(e.disabled=!0,n.classList.remove("hidden"),t.textContent=r,i.style.display="none"):(e.disabled=!1,n.classList.add("hidden"),t.textContent=r,s?(d.textContent=s,i.style.display="flex",console.error("[Auth Error]",s)):i.style.display="none")}};window.auth.sb.auth.onAuthStateChange((a,o)=>{window.auth.handleAuthStateChange(a,o)});let f;window.showToast=(a,o="success",r=5e3)=>{const s=document.getElementById("toast-notification"),e=document.getElementById("toast-message"),t=document.getElementById("toast-icon");!s||!e||!t||(f&&clearTimeout(f),e.textContent=a,s.classList.remove("bg-green-500","bg-red-500","bg-blue-500"),s.classList.remove("translate-y-[150%]"),o==="success"?(s.classList.add("bg-green-500"),t.setAttribute("data-lucide","check-circle")):o==="error"?(s.classList.add("bg-red-500"),t.setAttribute("data-lucide","alert-circle")):(s.classList.add("bg-blue-500"),t.setAttribute("data-lucide","info")),lucide.createIcons(),s.classList.remove("hidden"),s.classList.remove("translate-x-[120%]"),f=setTimeout(()=>s.classList.add("translate-x-[120%]"),r))};
