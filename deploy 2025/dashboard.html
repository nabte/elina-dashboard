<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elina IA - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librer√≠a para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- CORRECCI√ìN: Cargar lucide con 'defer' para garantizar que est√© disponible antes que los scripts de la app. -->
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">    
  <script type="module" crossorigin src="/assets/dashboard-BOEJQ9Oe.js"></script>
  <link rel="modulepreload" crossorigin href="/assets/auth-PYTeCFgn.js">
  <link rel="stylesheet" crossorigin href="/assets/dashboard-DHiSvKLA.css">
</head>
<body class="bg-slate-100 text-slate-800">
    <div class="flex h-screen overflow-hidden">
        <!-- Barra lateral de navegaci√≥n (se ocultar√° en m√≥vil) -->
        <aside id="main-sidebar" class="main-sidebar w-64 bg-slate-900 text-white flex flex-col p-4 overflow-y-auto">
            <div class="flex items-center justify-between gap-3 mb-8">
                <div class="flex items-center gap-3 overflow-hidden">
                    <img id="user-avatar" src="https://ui-avatars.com/api/?name=Elina" alt="Foto del negocio" class="h-10 w-10 rounded-full object-cover border border-white/20">
                    <div class="sidebar-text">
                        <p id="user-business-name" class="font-semibold text-white truncate">Cargando negocio...</p>
                        <span id="user-plan-badge" class="inline-block text-xs font-bold px-2 py-0.5 rounded-md mt-1.5 bg-slate-200 text-slate-800">Plan</span>
                    </div>
                </div>
                <!-- Bot√≥n para cerrar el men√∫ en m√≥vil -->
                <button id="close-sidebar-btn" class="md:hidden p-1 rounded-full hover:bg-slate-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <nav class="flex-grow">
                <ul class="space-y-1">
                    <!-- Dashboard -->
                    <li><a href="#" class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors" data-target="dashboard"><i data-lucide="layout-dashboard" class="w-4 h-4 flex-shrink-0"></i><span class="sidebar-text">Dashboard</span></a></li>
                    
                    <!-- Grupo: Campa√±as (solo el t√≠tulo, clickeable) -->
                    <li>
                        <a href="#" class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors" data-group="campaigns" data-group-default="bulk-sending">
                            <i data-lucide="megaphone" class="w-4 h-4 flex-shrink-0"></i>
                            <span class="sidebar-text font-semibold">Campa√±as</span>
                        </a>
                    </li>
                    
                    <!-- Grupo: Clientes (solo el t√≠tulo, clickeable) -->
                    <li>
                        <a href="#" class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors" data-group="clients" data-group-default="contacts">
                            <i data-lucide="users" class="w-4 h-4 flex-shrink-0"></i>
                            <span class="sidebar-text font-semibold">Clientes</span>
                        </a>
                    </li>
                    
                    <!-- Grupo: Configuraci√≥n IA (solo el t√≠tulo, clickeable) -->
                    <li>
                        <a href="#" class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors" data-group="ai-behavior" data-group-default="prompt-training">
                            <i data-lucide="brain" class="w-4 h-4 flex-shrink-0"></i>
                            <span class="sidebar-text font-semibold">Configuraci√≥n IA</span>
                        </a>
                    </li>
                    
                    <!-- Chats y Citas (items individuales) -->
                    <li><a href="#" class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors" data-target="chats"><i data-lucide="message-square" class="w-4 h-4 flex-shrink-0"></i><span class="sidebar-text">Chats</span></a></li>
                    <li id="appointments-menu-item" class="hidden"><a href="#" class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors" data-target="appointments"><i data-lucide="calendar-days" class="w-4 h-4 flex-shrink-0"></i><span class="sidebar-text">Citas</span></a></li>
                    
                    <!-- Grupo: Marketing (solo el t√≠tulo, clickeable) -->
                    <li>
                        <a href="#" class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors" data-group="marketing" data-group-default="designer-ai">
                            <i data-lucide="trending-up" class="w-4 h-4 flex-shrink-0"></i>
                            <span class="sidebar-text font-semibold">Marketing</span>
                        </a>
                    </li>
                    
                    <!-- Productos y Etiquetas IA (items individuales) -->
                    <li><a href="#" class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors" data-target="products"><i data-lucide="boxes" class="w-4 h-4 flex-shrink-0"></i><span class="sidebar-text">Productos</span></a></li>
                    <li><a href="#" class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors" data-target="smart-labels"><i data-lucide="tags" class="w-4 h-4 flex-shrink-0"></i><span class="sidebar-text">Etiquetas IA</span></a></li>
                </ul>
            </nav>
            <!-- Secci√≥n de Upgrade de Plan -->
            <div id="upgrade-plan-section" class="mt-6 mb-4 hidden">
                <div class="sidebar-text">
                    <button id="upgrade-trial-btn" class="hidden cta-button block w-full text-center bg-green-500 text-white font-bold py-3 px-4 rounded-lg">¬°Elige tu Plan!</button>
                    <a href="#" id="upgrade-grow-btn" class="hidden cta-button block w-full text-center bg-cyan-500 text-slate-900 font-bold py-3 px-4 rounded-lg">Mejorar a Plan Grow</a>
                </div>
                <button id="upgrade-collapsed-btn" class="hidden w-full justify-center bg-blue-600 text-white font-bold py-2 px-2 rounded-lg">
                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="mt-auto space-y-1">
                 <a href="/superadmin.html" id="superadmin-link" class="hidden nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-slate-700 transition-colors"><i data-lucide="shield" class="w-4 h-4 flex-shrink-0"></i><span class="sidebar-text">Super Admin</span></a>
                 <a href="#" class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-slate-700 transition-colors" data-target="settings"><i data-lucide="settings" class="w-4 h-4 flex-shrink-0"></i><span class="sidebar-text">Configuraci√≥n</span></a>
                 <a href="https://wa.me/5219995169313" target="_blank" class="flex items-center gap-3 px-4 py-2 rounded-md text-sm text-slate-400 hover:bg-slate-700 transition-colors mt-2">
                    <i data-lucide="life-buoy" class="w-4 h-4 flex-shrink-0"></i><span class="sidebar-text">Soporte</span>
                 </a>
                 <a href="#" id="logout-btn" class="flex items-center gap-3 px-4 py-2 rounded-md text-red-400 hover:bg-red-500 hover:text-white transition-colors mt-2"><i data-lucide="log-out" class="w-4 h-4 flex-shrink-0"></i><span class="sidebar-text">Cerrar Sesi√≥n</span></a>
            </div>
            <div class="border-t border-slate-700 mt-4 pt-4">
                <p class="text-center text-xs text-slate-400 sidebar-text">Impulsando tus ventas con IA</p>
            </div>
        </aside>

        <!-- Contenido principal -->
        <div id="main-content-area" class="flex-1 transition-all duration-300 ease-in-out">
            <main class="p-4 sm:p-5 lg:p-6 h-full overflow-y-auto pb-24">
                <!-- Bot√≥n para colapsar/expandir el sidebar (visible solo en desktop/tablet) -->
                <button id="toggle-sidebar-collapse-btn" class="hidden lg:block fixed top-5 z-50 p-2 rounded-full bg-white/80 backdrop-blur-sm shadow-md hover:bg-slate-100 transition-all duration-300 ease-in-out" style="left: 15.5rem;">
                    <i data-lucide="chevron-left" class="w-5 h-5 text-slate-600"></i>
                </button>

            <!-- Panel del Dashboard (activo por defecto) -->
            <div id="dashboard" class="content-panel active">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Columna principal (M√©tricas y Tutoriales) -->
                    <div class="lg:col-span-2 space-y-8 order-1">
                        <div>
                            <h2 class="text-2xl font-bold mb-4">Resumen del Embudo (√öltimos 30 d√≠as)</h2>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div class="stat-card bg-white p-4 rounded-xl shadow-md text-center">
                                    <h4 class="font-semibold text-slate-500 text-sm">Nuevos Leads</h4>
                                    <p id="funnel-leads-stat" class="text-3xl font-bold mt-2">0</p>
                                </div>
                                <div class="stat-card bg-white p-4 rounded-xl shadow-md text-center">
                                    <h4 class="font-semibold text-slate-500 text-sm">Interesados</h4>
                                    <p id="funnel-interested-stat" class="text-3xl font-bold mt-2">0</p>
                                </div>
                                <div class="stat-card bg-white p-4 rounded-xl shadow-md text-center">
                                    <h4 class="font-semibold text-slate-500 text-sm">Clientes Ganados</h4>
                                    <p id="funnel-won-stat" class="text-3xl font-bold mt-2">0</p>
                                </div>
                                <div class="stat-card bg-green-50 p-4 rounded-xl shadow-md text-center border border-green-200">
                                    <h4 class="font-semibold text-green-800 text-sm">Tasa de Conversi√≥n</h4>
                                    <p id="funnel-conversion-stat" class="text-3xl font-bold text-green-600 mt-2">0%</p>
                                </div>
                            </div>

                            <h2 class="text-2xl font-bold mb-4">M√©tricas de Valor</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="stat-card bg-white p-4 rounded-xl shadow-md">
                                    <h4 class="font-bold text-slate-800 mb-2">Mensajes Respondidos por IA</h4>
                                    <div class="h-48"><canvas id="responses-chart"></canvas></div>
                                </div>
                                <div class="stat-card bg-white p-4 rounded-xl shadow-md">
                                    <h4 class="font-bold text-slate-800 mb-2">Tiempo Ahorrado (minutos)</h4>
                                    <div class="h-48"><canvas id="time-saved-chart"></canvas></div>
                                </div>
                            </div>
                            <!-- INICIO: Bot√≥n para el Asistente de Configuraci√≥n -->
                            <div class="mt-8 text-center">
                                <button id="start-wizard-btn" class="bg-green-500 text-white font-bold py-4 px-8 rounded-lg hover:bg-green-600 transition-transform duration-300 ease-in-out shadow-lg animate-pulse-green">
                                    <i data-lucide="wand-2" class="inline-block w-5 h-5 mr-2"></i>
                                    Configura tu IA (Recomendado)
                                </button>
                            </div>
                        </div>

                    </div>
                    
                    <!-- Columna Lateral (Prompt y conexi√≥n) -->
                    <!-- INICIO: Columna lateral reorganizada -->
                    <div class="space-y-6 order-2">
                        <div id="whatsapp-card" class="bg-white p-4 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold mb-4">Conexi√≥n WhatsApp</h3>
                            <div id="whatsapp-connection-container" class="text-center"></div>
                            <button id="request-qr-btn" class="mt-4 w-full bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition">
                                Solicitar QR
                            </button>
                            <p class="text-xs text-slate-400 mt-2 text-center">El QR se actualiza cada 40 segundos.</p>
                        </div>
                        <div id="tutorials-card" class="bg-white p-4 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold mb-4">Tutoriales</h3>
                            <p class="text-sm text-slate-500 mb-3">Aprende a sacar el m√°ximo provecho de Elina.</p>
                            <!-- INICIO: Video incrustado -->
                            <div class="relative w-full aspect-video rounded-lg overflow-hidden shadow-inner">
                                <iframe
                                    id="yt-player-small"
                                    class="absolute top-0 left-0 w-full h-full"
                                    src="https://www.youtube.com/embed/videoseries?list=PLDs44uukbe3FIDa9CttQLh8N-Nfdpo_hG"
                                    title="Tutoriales ELINA IA"
                                    frameborder="0"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                    allowfullscreen></iframe>
                            </div>
                            <button id="open-tutorials-btn" class="mt-3 w-full bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200">Ver en Grande</button>
                        </div>
                    </div>
                    <!-- FIN: Columna lateral reorganizada -->

                    <!-- Configuraci√≥n de IA (ahora ancho completo) -->
<div class="col-span-1 lg:col-span-3 order-3 bg-white p-4 rounded-xl shadow-md max-w-none">
  <h3 class="text-2xl font-bold mb-4">Configuraci√≥n de IA</h3>

  <form id="prompt-form" class="space-y-4">
    <div>
      <div class="flex justify-between items-center mb-2">
          <label for="ai-master-prompt" class="block font-medium">Prompt del Asistente</label>
          <button type="button" id="remake-prompt-btn" class="text-xs bg-blue-100 text-blue-700 font-semibold py-1 px-2 rounded-md hover:bg-blue-200 flex items-center gap-1">
              <i data-lucide="refresh-cw" class="w-3 h-3"></i> Rehacer mi Prompt
          </button>
          <button type="button" id="main-prompt-ai-enhance-btn" class="text-xs bg-purple-100 text-purple-700 font-semibold py-1 px-2 rounded-md hover:bg-purple-200 flex items-center gap-1">
              <i data-lucide="sparkles" class="w-3 h-3"></i> Mejorar con IA
          </button>
      </div>
      <textarea
        id="ai-master-prompt"
        rows="10"
        class="w-full border-slate-300 rounded-lg p-3 min-h-40 lg:min-h-56 resize-y"
        placeholder="Describe aqu√≠ la personalidad y objetivos de tu asistente de IA..."></textarea>
    </div>

    <!-- Modal para definir colores de etiquetas detectadas -->
    <div id="new-labels-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 px-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
            <div class="flex items-start justify-between p-6 border-b border-slate-200">
                <div>
                    <h3 class="text-xl font-bold text-slate-900">Configura tus Etiquetas</h3>
                    <p class="text-sm text-slate-500 mt-1">Elige un color para cada etiqueta detectada en el archivo.</p>
                </div>
                <button id="close-new-labels-btn" class="text-slate-400 hover:text-slate-600" aria-label="Cerrar">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="px-6 pt-4 pb-6 overflow-y-auto">
                <div class="overflow-x-auto rounded-lg border border-slate-200">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50 text-left text-sm font-semibold text-slate-600 uppercase tracking-wide">
                            <tr>
                                <th class="px-4 py-3">Etiqueta</th>
                                <th class="px-4 py-3">Color</th>
                            </tr>
                        </thead>
                        <tbody id="new-labels-table-body" class="divide-y divide-slate-200 bg-white text-sm"></tbody>
                    </table>
                </div>
                <div id="new-labels-error" class="hidden mt-4 text-sm font-medium text-red-500"></div>
            </div>
            <div class="flex justify-end gap-3 px-6 pb-6 border-t border-slate-200 bg-slate-50">
                <button id="cancel-new-labels-btn" class="py-2 px-4 rounded-lg font-semibold text-slate-700 bg-slate-200 hover:bg-slate-300">Cancelar</button>
                <button id="confirm-new-labels-btn" class="py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700">Guardar etiquetas</button>
            </div>
        </div>
    </div>

    <div class="flex justify-between items-center">
      <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
        Guardar
      </button>
      <button type="button" id="prompt-help-btn" class="text-sm text-slate-500 hover:underline">Ayuda</button>
    </div>
  </form>
</div>

<!-- INICIO: Modal de Ayuda para el Prompt -->
<div id="prompt-help-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[95] p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
        <div class="p-5 border-b flex justify-between items-center">
            <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i data-lucide="help-circle" class="text-blue-500"></i>Gu√≠a para un Prompt Poderoso</h3>
            <button id="close-prompt-help-btn" class="p-2 rounded-full hover:bg-slate-100"><i data-lucide="x" class="w-6 h-6 text-slate-600"></i></button>
        </div>
        <div class="flex-grow overflow-y-auto p-8 space-y-6 text-slate-700">
            <p>El "prompt" es el cerebro de tu asistente. Son las instrucciones que Elina seguir√° en cada conversaci√≥n. Un buen prompt es la clave para que act√∫e como un experto de tu negocio.</p>
            
            <h4 class="text-lg font-semibold text-slate-800 pt-4 border-t">Elementos Clave de un Buen Prompt:</h4>
            <ul class="list-disc list-inside space-y-2">
                <li><strong>Rol y Personalidad:</strong> Define qui√©n es. ¬øEs un "asistente de ventas amigable", un "experto t√©cnico formal"?</li>
                <li><strong>Contexto del Negocio:</strong> Explica brevemente qu√© hace tu empresa, a qui√©n le vende y qu√© problema resuelve.</li>
                <li><strong>Reglas y L√≠mites:</strong> ¬øQu√© NUNCA debe hacer? (Ej: "Nunca dar precios sin preguntar primero el presupuesto"). ¬øQu√© SIEMPRE debe hacer? (Ej: "Siempre pedir el nombre del cliente").</li>
                <li><strong>Tono de Comunicaci√≥n:</strong> ¬øDebe usar emojis? ¬øSer muy formal? ¬øHablar de "t√∫" o de "usted"?</li>
            </ul>

            <h4 class="text-lg font-semibold text-slate-800 pt-4 border-t">Ejemplo de un Prompt Ganador:</h4>
            <pre class="bg-slate-100 p-4 rounded-lg text-sm whitespace-pre-wrap font-mono">Eres un asistente de ventas para "Soluciones Solares MX", una empresa que instala paneles solares para hogares. Tu tono debe ser amigable y educativo. Tu objetivo es calificar al cliente obteniendo su nombre, ciudad y un estimado de su gasto de luz bimestral. NUNCA des un precio final, en su lugar, explica que se necesita una visita t√©cnica y ofrece agendarla. Siempre termina tus mensajes con un emoji de sol ‚òÄÔ∏è.</pre>
        </div>
    </div>
</div>
                </div>
            </div>

            <!-- Panel de Contactos -->
            <div id="contacts" class="content-panel">
                <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-4 mb-6">
                    <div class="flex items-center gap-3">
                        <h2 class="text-2xl sm:text-3xl font-bold">Contactos</h2>
                        <span id="contacts-count-badge" class="hidden bg-slate-200 text-slate-600 text-sm font-semibold px-2.5 py-1 rounded-full">0</span>
                    </div>
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="search" id="contact-search-input" placeholder="Buscar..." class="form-input w-full sm:w-auto py-2.5 rounded-lg border-slate-300 text-sm">
                        <div class="custom-select-wrapper">
                            <!-- CORRECCI√ìN: El select ahora es m√°s simple, las clases se aplican desde JS -->
                            <select id="contact-label-filter" class="custom-select form-input w-full sm:w-auto py-2.5 rounded-lg border-slate-300 text-sm pr-8"></select>
                            <i data-lucide="chevron-down" class="select-icon w-5 h-5 text-slate-400"></i>
                        </div>
                        <button id="ignore-all-visible-btn" class="bg-red-100 text-red-700 font-semibold py-1.5 px-2.5 rounded-md hover:bg-red-200 transition text-xs flex items-center justify-center gap-1.5">
                            <i data-lucide="user-x" class="w-3 h-3"></i><span>Desactivar todas</span>
                        </button>
                        <button id="unignore-all-visible-btn" class="bg-emerald-100 text-emerald-700 font-semibold py-1.5 px-2.5 rounded-md hover:bg-emerald-200 transition text-xs flex items-center justify-center gap-1.5">
                            <i data-lucide="user-check" class="w-3 h-3"></i><span>Activar todas</span>
                        </button>
                        <button id="export-contacts-btn" class="bg-slate-200 text-slate-800 font-semibold py-1.5 px-2.5 rounded-md hover:bg-slate-300 transition text-xs flex items-center justify-center gap-1.5">
                            <i data-lucide="download" class="w-3 h-3"></i><span>Exportar Contactos</span>
                        </button>
                        <button id="import-contacts-btn" class="bg-blue-100 text-blue-700 font-semibold py-1.5 px-2.5 rounded-md hover:bg-blue-200 transition text-xs flex items-center justify-center gap-1.5">
                            <i data-lucide="upload" class="w-3 h-3"></i><span>Importar Contactos (CSV/XLSX)</span>
                        </button>
                        <input type="file" id="import-contacts-input" class="hidden" accept=".csv,.xlsx,.xls">
                        <button id="import-numbers-label-btn" class="bg-purple-100 text-purple-700 font-semibold py-1.5 px-2.5 rounded-md hover:bg-purple-200 transition text-xs flex items-center justify-center gap-1.5">
                            <i data-lucide="hash" class="w-3 h-3"></i><span>Importar N√∫meros con Etiqueta</span>
                        </button>
                        <button id="sync-contacts-btn" class="bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center justify-center gap-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i><span>Sincronizar</span>
                        </button>
                    </div>
                </div>

<!-- Contenedor para mensajes de estado -->
<div id="contacts-status-container" class="mb-4">
    <!-- Los mensajes de estado se insertar√°n aqu√≠ -->
</div>

<!-- Tabla -->
<div class="bg-white rounded-xl shadow-md overflow-x-auto">
  <table class="w-full text-left">
    <thead class="bg-slate-50">
        <tr>
            <th class="p-4 w-12"><input type="checkbox" id="select-all-contacts" class="form-checkbox rounded"></th>
            <th class="p-4 font-semibold cursor-pointer hover:bg-slate-100" data-sort="full_name">Nombre <span class="sort-indicator inline-block ml-1"><i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-400"></i></span></th>
            <th class="p-4 font-semibold cursor-pointer hover:bg-slate-100" data-sort="phone_number">Tel√©fono <span class="sort-indicator inline-block ml-1"><i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-400"></i></span></th>
            <th class="p-4 font-semibold cursor-pointer hover:bg-slate-100" data-sort="labels">Etiquetas <span class="sort-indicator inline-block ml-1"><i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-400"></i></span></th>
            <th class="p-4 font-semibold">Ignorar IA</th>
            <th class="p-4 font-semibold">Info IA</th>
            <th class="p-4 font-semibold">Acciones</th>
        </tr>
    </thead>
    <tbody id="contacts-table-body" class="divide-y divide-slate-200">
      <!-- filas din√°micas -->
    </tbody>
  </table>

    <!-- Loader para carga inicial -->
    <div id="contacts-loader" class="p-8 text-center text-slate-500">
        Cargando...
    </div>

    <!-- Paginaci√≥n -->
    <div id="contacts-pagination" class="flex justify-between items-center mt-4"></div>
</div>

<!-- Barra de acciones en lote (inicialmente oculta) -->
<div id="bulk-actions-bar" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white py-3 px-6 rounded-full shadow-lg flex items-center gap-4 z-20">
    <span id="selected-count">0 seleccionados</span>
    <button id="bulk-edit-labels-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full text-sm">Gestionar Etiquetas</button>
    <button id="bulk-ignore-selected-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full text-sm disabled:opacity-50 disabled:cursor-not-allowed">Ignorar con IA</button>
    <button id="bulk-unignore-selected-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-full text-sm disabled:opacity-50 disabled:cursor-not-allowed">Quitar Ignorar</button>
</div>

<!-- Nota visual -->
<p class="text-xs text-slate-500 mt-3">
  ‚Ä¢ <b>Ignorar IA</b> se prende si el contacto tiene la etiqueta <code>ignorar</code>.<br>
  ‚Ä¢ La etiqueta <code>todos</code> no se muestra aqu√≠ (solo se usa en Env√≠o Masivo).<br>
  ‚Ä¢ Puedes editar etiquetas con el bot√≥n ‚ÄúEditar etiquetas‚Äù.
</p>
            </div>

            <!-- Otros paneles -->
            <div id="bulk-sending" class="content-panel">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 order-1">
                        <h2 class="text-3xl font-bold mb-6">Crear Env√≠o Masivo</h2>
                        <form id="bulk-send-form" class="bg-white rounded-xl shadow-md p-8 space-y-6">
                            <!-- Mensaje -->
                            <div>
                                <label for="bulk-message" class="block font-medium mb-2">Mensaje</label>
                                <div class="flex justify-end mb-2">
                                    <button type="button" id="bulk-ai-enhance-btn" class="text-xs bg-purple-100 text-purple-700 font-semibold py-1 px-2 rounded-md hover:bg-purple-200 flex items-center gap-1">
                                        <i data-lucide="sparkles" class="w-3 h-3"></i> Mejorar con IA
                                    </button>
                                </div>
                                <div class="relative">
                                    <textarea id="bulk-message" rows="8" class="w-full border-slate-300 rounded-lg p-3 pr-12 resize-y" placeholder="Escribe tu mensaje aqu√≠... üöÄ" required></textarea>
                                </div>
                                <div class="flex items-center gap-2 mt-2">
                                    <button type="button" id="personalize-name-btn" class="text-sm bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-md">
                                        <i data-lucide="user-plus" class="w-4 h-4 inline-block mr-1"></i>
                                        Insertar Nombre
                                    </button>
                                    <p class="text-xs text-slate-500">Usa `%nombre%` para personalizar el mensaje.</p>
                                </div>
                            </div>

                            <!-- Carga de Archivo -->
                            <div>
                                <label class="block font-medium mb-2">Adjuntar Archivo (Opcional)</label>
                                <div id="file-drop-zone" class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50">
                                    <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto text-slate-400"></i>
                                    <p class="mt-2 text-slate-500">Arrastra un archivo o <span class="text-blue-600 font-semibold">haz clic para seleccionar</span></p>
                                    <p class="text-xs text-slate-400 mt-1">Im√°genes, videos o audios. M√°x 25MB.</p>
                                    <input type="file" id="bulk-file-input" class="hidden" accept="image/*,video/*,audio/*">
                                </div>
                                <div id="file-preview" class="hidden mt-4">
                                    <!-- Vista previa de la imagen -->
                                    <img id="file-image-preview" class="hidden max-h-40 rounded-lg mx-auto mb-2" alt="Vista previa del archivo">
                                    <!-- Info del archivo gen√É¬©rico -->
                                    <div class="flex items-center justify-between bg-slate-100 p-3 rounded-lg">
                                        <div class="flex items-center gap-3 overflow-hidden">
                                            <i data-lucide="file-check" class="text-green-500 flex-shrink-0"></i>
                                            <span id="file-name" class="text-sm font-medium truncate"></span>
                                        </div>
                                        <button type="button" id="remove-file-btn" class="text-red-500 hover:bg-red-100 p-1 rounded-full flex-shrink-0">
                                            <i data-lucide="x" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Audiencia -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="include-labels" class="block font-medium mb-2">¬øA qui√©n se lo enviamos?</label>
                                    <div class="custom-select-wrapper">
                                        <select id="include-labels" class="custom-select form-input w-full py-3"></select>
                                        <i data-lucide="chevron-down" class="select-icon w-5 h-5 text-slate-400"></i>
                                    </div>
                                </div>
                                <div>
                                    <label for="exclude-labels" class="block font-medium mb-2">Excluir a (opcional)</label>
                                    <div class="custom-select-wrapper">
                                        <select id="exclude-labels" class="custom-select form-input w-full py-3"></select>
                                        <i data-lucide="chevron-down" class="select-icon w-5 h-5 text-slate-400"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Programaci√≥n -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="bulk-schedule-date" class="block font-medium mb-2">Fecha de inicio (opcional)</label>
                                    <input type="date" id="bulk-schedule-date" class="form-input w-full py-3" min="">
                                </div>
                                <div>
                                    <label for="bulk-schedule-time" class="block font-medium mb-2">Hora de inicio (opcional)</label>
                                    <input type="time" id="bulk-schedule-time" class="form-input w-full py-3" step="60">
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 -mt-4">Si dejas estos campos vac√≠os la campa√±a se enviar√° de inmediato.</p>

                            <!-- Bot√≥n de Env√≠o -->
                            <div class="pt-4 border-t flex items-center gap-4">
                                <button type="submit" id="bulk-submit-btn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 disabled:opacity-50 flex items-center justify-center gap-2">
                                    <span class="button-text">Enviar Campa√±a</span>
                                    <div class="loading-spinner hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                                </button>
                                <button type="button" id="bulk-test-btn" class="w-auto bg-slate-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-700 disabled:opacity-50 flex items-center justify-center gap-2">
                                    <i data-lucide="flask-conical" class="w-5 h-5"></i>
                                    <span>Probar</span>
                                </button>
                                <button type="button" id="bulk-stop-btn" class="hidden w-auto bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 disabled:opacity-50 flex items-center justify-center gap-2">
                                    <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                                    <span>Detener Campa√±a</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Columna de Ayuda y Notas -->
                    <div class="space-y-6 order-2">
                        <div class="bg-amber-100 border-l-4 border-amber-500 text-amber-800 p-4 rounded-r-lg">
                            <h4 class="font-bold">¬°Importante! Uso responsable</h4>
                            <p class="text-sm mt-2">El env√≠o masivo puede resultar en el bloqueo de tu n√∫mero si no se usa con cuidado. Te recomendamos enviar mensajes solo a contactos que esperan noticias tuyas. Hemos limitado los env√≠os a 500 mensajes por d√≠a y una campa√±a a la vez para proteger tu cuenta.</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-md p-4">
                            <h4 class="font-bold mb-2">Video Tutorial</h4>
                            <iframe class="w-full aspect-video rounded-lg" src="https://www.youtube.com/embed/UPvbbiiOCao" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; compute-pressure" allowfullscreen></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenedor para el panel de Etiquetas IA. Se cargar√° din√°micamente. -->
            <div id="smart-labels" class="content-panel max-w-6xl mx-auto">
                <!-- Contenido de smart-labels.html -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold">Etiquetas Inteligentes y Funnels</h2>
                    <button id="add-smart-label-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> Nueva Automatizaci√≥n
                    </button>
                </div>
                <div id="smart-labels-loader" class="p-8 text-center text-slate-500">Cargando etiquetas inteligentes...</div>
                <div id="smart-labels-content" class="hidden space-y-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Funnels de Ventas</h3>
                        <div id="funnels-container" class="space-y-6"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Etiquetas Individuales</h3>
                        <div id="individual-labels-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                </div>
                <!-- Modal incrustado para crear/editar automatizaciones -->
                <div id="smart-label-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                        <div class="flex justify-between items-center p-6 border-b border-slate-200">
                            <h3 id="smart-label-modal-title" class="text-2xl font-bold text-slate-800">Nueva Automatizaci&oacute;n</h3>
                            <button id="cancel-smart-label-btn" class="text-slate-500 hover:text-slate-800">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>

                        <form id="smart-label-form" class="flex-grow overflow-y-auto p-6 space-y-6">
                            <input type="hidden" id="smart-label-id">

                            <div id="label-selector-container" class="space-y-2">
                                <label for="smart-label-select" class="font-semibold text-slate-700">Etiqueta a automatizar</label>
                                <select id="smart-label-select" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                    <!-- Opciones din&aacute;micas -->
                                </select>
                            </div>

                            <div id="new-label-fields-container" class="hidden space-y-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                                <div class="space-y-2">
                                    <label for="smart-label-name" class="font-semibold text-slate-700">Nombre de la nueva etiqueta</label>
                                    <input type="text" id="smart-label-name" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ej: Lead Caliente">
                                </div>
                                <div class="space-y-2">
                                    <label for="smart-label-color" class="font-semibold text-slate-700">Color</label>
                                    <input type="color" id="smart-label-color" class="w-full h-12 p-1 border border-slate-300 rounded-lg" value="#607D8B">
                                </div>
                            </div>
                            
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="smart-label-is-automated" class="sr-only peer">
                                <div class="relative w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                <span class="ml-3 font-semibold text-slate-700">Activar automatizaci&oacute;n con IA</span>
                            </label>

                            <div id="ai-fields-container" class="hidden space-y-4 pl-8 border-l-2 border-blue-200">
                                <div class="space-y-2">
                                    <label for="smart-label-prompt" class="font-semibold text-slate-700 flex items-center gap-2">
                                        <i data-lucide="brain-circuit" class="w-5 h-5 text-blue-600"></i>
                                        Instrucci&oacute;n para la IA
                                    </label>
                                    <p class="text-sm text-slate-500">Describe cu&aacute;ndo se debe aplicar esta automatizaci&oacute;n. La IA analizar&aacute; los chats para asignarla.</p>
                                    <textarea id="smart-label-prompt" class="w-full p-3 border border-slate-300 rounded-lg h-32" placeholder="Ej: Asignar esta etiqueta si el cliente muestra un fuerte inter&eacute;s en comprar, menciona un presupuesto o pide una demostraci&oacute;n."></textarea>
                                    <button id="smart-label-ai-enhance-btn" type="button" class="text-sm text-blue-600 hover:underline font-semibold flex items-center gap-1">
                                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                                        Mejorar con IA
                                    </button>
                                </div>
                            </div>

                            <div class="space-y-4 pt-4 border-t border-slate-200">
                                <h4 class="font-semibold text-slate-700">Opciones adicionales</h4>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="smart-label-ignore-in-chats" class="sr-only peer">
                                    <div class="relative w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-slate-600"></div>
                                    <span class="ml-3 font-medium text-slate-600">Asignar tambi&eacute;n la etiqueta <strong>&ldquo;ignorar&rdquo;</strong> (Ignorar con IA)</span>
                                </label>
                                <label class="relative inline-flex items-center cursor-pointer mt-3">
                                    <input type="checkbox" id="smart-label-notify" class="sr-only peer">
                                    <div class="relative w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    <span class="ml-3 font-medium text-slate-600">Notificarme cuando la IA asigne esta etiqueta</span>
                                </label>
                            </div>

                            <div class="space-y-4 pt-4 border-t border-slate-200">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="smart-label-enable-funnel" class="sr-only peer">
                                    <div class="relative w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                                    <span class="ml-3 font-semibold text-slate-700">Organizar dentro de un funnel</span>
                                </label>
                                <div id="funnel-fields-container" class="hidden space-y-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="space-y-2">
                                            <label for="smart-label-funnel-name" class="font-medium text-slate-600">Nombre del funnel</label>
                                            <input type="text" id="smart-label-funnel-name" list="funnel-names-list" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ej: Proceso de Venta">
                                            <datalist id="funnel-names-list"></datalist>
                                        </div>
                                        <div class="space-y-2">
                                            <label for="smart-label-funnel-order" class="font-medium text-slate-600">Orden dentro del funnel</label>
                                            <input type="number" id="smart-label-funnel-order" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="1">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>

        <div class="flex justify-between items-center p-6 bg-slate-50 border-t border-slate-200 rounded-b-xl">
            <button id="delete-smart-label-btn" type="button" class="text-red-600 hover:text-red-800 font-semibold hidden">Eliminar</button>
            <div class="flex gap-4">
                <button type="button" id="cancel-smart-label-btn-footer" class="bg-white border border-slate-300 text-slate-700 font-bold py-2 px-6 rounded-lg hover:bg-slate-50">Cancelar</button>
                <button type="submit" form="smart-label-form" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Guardar automatizaci&oacute;n</button>
            </div>
        </div>
                    </div>
                </div>
            </div>

            <!-- Panel Kanban -->
            <div id="kanban" class="content-panel flex flex-col h-full">
                <!-- Cabecera del Kanban -->
                <div class="w-full bg-slate-800 text-white p-3 shadow-md flex flex-wrap justify-between items-center gap-4 rounded-t-lg flex-shrink-0">
                    <button id="back-to-dashboard-btn" class="font-semibold py-2 px-4 rounded-lg text-sm bg-slate-700 hover:bg-slate-600 flex items-center gap-2 text-white">
                        <i data-lucide="arrow-left" class="w-4 h-4 text-white"></i>
                        <span>Dashboard</span>
                    </button>
                    <h2 class="text-xl font-bold">Kanban</h2>
                    <div id="kanban-controls" class="flex items-center gap-3"></div>
                </div>
                <!-- Contenedor del tablero Kanban -->
                <div id="kanban-board" class="flex-1 flex flex-wrap content-start overflow-y-auto p-2 bg-slate-200">
                    <div id="kanban-loader" class="w-full text-center p-8">Cargando...</div>
                </div>
            </div>

            <!-- Contenedor para el panel de Seguimientos. Se cargar√° din√°micamente. -->
            <div id="follow-ups" class="content-panel max-w-5xl mx-auto">
                <!-- Contenido de follow-ups.html -->
                <div id="follow-ups-access-denied" class="hidden bg-white rounded-xl shadow-md p-8 text-center">
                    <i data-lucide="lock" class="w-16 h-16 mx-auto text-slate-400 mb-4"></i>
                    <h3 class="text-xl font-bold">Funci√≥n Exclusiva del Plan Grow</h3>
                    <p class="text-slate-500 mt-2 max-w-md mx-auto">Automatiza tus seguimientos y nunca m√°s pierdas una venta por falta de atenci√≥n. ¬°Desbloquea esta funci√≥n mejorando tu plan!</p>
                    <button id="upgrade-to-grow-from-followups" class="mt-6 bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700">
                        Mejorar a Plan Grow
                    </button>
                </div>
                <!-- INICIO: Modal para crear/editar secuencia de seguimiento -->
                <div id="sequence-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                        <div class="p-6 border-b flex justify-between items-center">
                            <h3 id="sequence-modal-title" class="text-xl font-bold">Crear Nueva Secuencia</h3>
                            <button id="cancel-sequence-btn" class="p-2 rounded-full hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <form id="sequence-form" class="flex-grow overflow-y-auto p-6 space-y-6">
                            <input type="hidden" id="sequence-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="sequence-target-label" class="block text-sm font-medium text-slate-700">Etiqueta de Activaci√≥n</label>
                                    <div class="custom-select-wrapper mt-1">
                                        <select id="sequence-target-label" required class="custom-select form-input"></select>
                                        <i data-lucide="tag" class="select-icon w-5 h-5 text-slate-400"></i>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1">La secuencia iniciar√° cuando un contacto reciba esta etiqueta.</p>
                                </div>
                                <div class="pt-6">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="sequence-is-active" class="sr-only peer">
                                        <div class="relative w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        <span class="ml-3 text-sm font-medium text-slate-700">Activar secuencia al guardar</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-md font-semibold mb-2">Mensajes de la Secuencia (M√°x. 3)</h4>
                                <div id="messages-container" class="space-y-4"></div>
                                <button type="button" id="add-message-btn" class="mt-4 text-sm text-blue-600 hover:underline font-semibold flex items-center gap-1"><i data-lucide="plus-circle" class="w-4 h-4"></i> A√±adir Mensaje</button>
                            </div>
                        </form>
                        <div class="p-6 bg-slate-50 flex justify-between items-center rounded-b-lg">
                            <button type="button" id="delete-sequence-btn" class="hidden bg-red-100 text-red-700 font-bold py-2 px-4 rounded-lg hover:bg-red-200">Eliminar</button>
                            <button type="submit" id="save-sequence-btn" form="sequence-form" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Guardar Secuencia</button>
                        </div>
                    </div>
                </div>
                <template id="message-step-template">
                    <div class="message-step bg-slate-100 p-4 rounded-lg border">
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-semibold">Mensaje #<span class="step-number">1</span></h5>
                            <button type="button" class="remove-step-btn text-red-500 hover:text-red-700 p-1 rounded-full"><i data-lucide="x-circle" class="w-5 h-5 pointer-events-none"></i></button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-slate-600 mb-1">Contenido del Mensaje</label>
                                <textarea class="step-message form-input w-full" rows="4" placeholder="Escribe tu mensaje de seguimiento..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Enviar despu√©s de</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" class="step-delay form-input w-24" min="1" value="24">
                                    <span class="text-sm text-slate-600">horas</span>
                                </div>
                                <p class="text-xs text-slate-400 mt-1">Si el contacto no responde.</p>
                                <div class="mt-3">
                                    <label class="block text-sm font-medium text-slate-600 mb-1">Adjuntar archivo (opcional)</label>
                                    <input type="file" class="step-file-input hidden" accept="image/*,video/*,audio/*">
                                    <button type="button" class="upload-file-btn text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-2 rounded-md">Seleccionar</button>
                                    <span class="file-name-display text-xs text-slate-500 ml-2 truncate"></span>
                                    <img class="step-image-preview hidden max-h-16 mt-2 rounded" alt="Vista previa">
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
                <!-- FIN: Modal para crear/editar secuencia de seguimiento -->
                <div id="follow-ups-container" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl sm:text-3xl font-bold">Secuencias de Seguimiento</h2>
                        <button id="add-sequence-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> Nueva Secuencia
                        </button>
                    </div>
                    <div id="followups-list" class="space-y-4">
                        <div id="followups-loader" class="text-center text-slate-500 p-8">Cargando secuencias...</div>
                    </div>
                </div>
            </div>

            <!-- Panel de Respuestas Programadas (NUEVO) -->
            <div id="auto-responses" class="content-panel max-w-5xl mx-auto">
                <div id="auto-responses-content">
                    <!-- Se cargar√° din√°micamente desde auto-responses.js -->
                </div>
            </div>
            
            <!-- Panel de Entrenamiento de Prompt (NUEVO) -->
            <div id="prompt-training" class="content-panel max-w-7xl mx-auto">
                <div id="prompt-training-content">
                    <!-- Se cargar√° din√°micamente desde prompt-training.js -->
                </div>
            </div>
            
            <!-- Contenedor para el panel de Plantillas. Se cargar√° din√°micamente. -->
            <div id="templates" class="content-panel max-w-5xl mx-auto">
                <!-- Contenido de templates.html -->
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">Plantillas de Mensajes</h2>
                <div class="space-y-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Plantillas Base</h3>
                        <div id="base-templates-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Mis Plantillas Personalizadas</h3>
                            <button id="add-template-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Nueva Plantilla
                            </button>
                </div>
                        <div id="new-template-form-container" class="hidden bg-white p-6 rounded-lg shadow-md mb-6">
                            <form id="new-template-form" class="space-y-4">
                                <input type="text" id="new-template-name" placeholder="Nombre de la plantilla" class="form-input w-full" required>
                                <textarea id="new-template-content" rows="4" placeholder="Contenido del mensaje..." class="form-input w-full" required></textarea>
                                <div class="flex justify-end gap-2">
                                    <button type="button" id="cancel-new-template-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Guardar</button>
                                </div>
                            </form>
                        </div>
                        <div id="custom-templates-container" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- Panel de Cotizaciones -->
            <div id="quotes" class="content-panel max-w-7xl mx-auto">
                <!-- Contenido de Cotizaciones -->
                <div class="flex flex-col gap-4 mb-6">
                    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                        <div>
                            <h2 class="text-2xl sm:text-3xl font-bold">Cotizaciones</h2>
                            <p class="text-slate-500 mt-1">Gestiona y env√≠a cotizaciones a tus clientes</p>
                        </div>
                        <div class="flex gap-2">
                            <button id="quote-settings-btn" class="px-4 py-2 bg-slate-600 text-white font-semibold rounded-lg hover:bg-slate-700 transition-colors flex items-center gap-2">
                                <i data-lucide="settings" class="w-4 h-4"></i>
                                Personalizar PDF
                            </button>
                            <button id="new-quote-btn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Nueva Cotizaci√≥n
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="quote-search" placeholder="Buscar por ID o contacto..." 
                               class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <select id="quote-status-filter" 
                                class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="all">Todos los estados</option>
                            <option value="draft">Borrador</option>
                            <option value="sent">Enviada</option>
                            <option value="accepted">Aceptada</option>
                            <option value="rejected">Rechazada</option>
                            <option value="expired">Expirada</option>
                        </select>
                    </div>
                </div>

                <!-- Tabla de Cotizaciones -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Contacto</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Fecha</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Total</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Estado</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="quotes-table-body" class="divide-y divide-slate-200">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-slate-500">Cargando cotizaciones...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Contenedor para el panel de Productos. Se cargar√° din√°micamente. -->
            <div id="products" class="content-panel max-w-6xl mx-auto">
                <!-- Contenido de products.html -->
                <div class="flex flex-col gap-4 mb-6">
                    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                        <h2 class="text-2xl sm:text-3xl font-bold">Mis Productos (<span id="products-count-overview" data-role="products-count-overview" class="text-base font-semibold text-slate-500">0</span>)</h2>
                        <div class="w-full md:w-72">
                            <div class="relative">
                                <i data-lucide="search" class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400"></i>
                                <input type="search" data-role="products-search" placeholder="Buscar por nombre, SKU o precio..." class="w-full rounded-lg border border-slate-300 bg-white py-2 pl-10 pr-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 md:justify-end">
                        <button id="add-product-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Anadir Producto</button>
                        <button id="download-template-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Descargar Plantilla</button>
                        <label class="bg-green-100 text-green-700 font-semibold py-2 px-4 rounded-lg hover:bg-green-200 cursor-pointer"><input type="file" id="import-csv-input" class="hidden" accept=".csv,.xlsx,.xls">Importar CSV/XLSX</label>
                        <button id="export-products-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Exportar a CSV</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                    <table class="w-full text-left"><thead class="bg-slate-50"><tr><th class="p-4 font-semibold">Nombre</th><th class="p-4 font-semibold">SKU</th><th class="p-4 font-semibold">Precio</th><th class="p-4 font-semibold">Stock</th><th class="p-4 font-semibold">Media</th><th class="p-4 font-semibold">Acciones</th></tr></thead><tbody id="products-table-body"></tbody></table>
                    <div id="products-loader" class="p-8 text-center text-slate-500"></div>
                </div>
            </div>

            <!-- Panel Promos Inteligentes -->
            <div id="smart-promotions" class="content-panel hidden">
                <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6">
                    <div>
                        <p class="text-sm uppercase font-semibold text-slate-400">Promociones contextuales</p>
                        <h2 class="text-3xl font-bold text-slate-900">Promos Inteligentes</h2>
                        <p class="text-sm text-slate-500 max-w-3xl">Crea promos que la IA insertar√° de forma natural cuando detecte oportunidades o cuando el cliente pregunte por ofertas.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="smart-promos-refresh" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-slate-300 text-sm font-semibold text-slate-700 hover:bg-slate-100">
                            <i data-lucide="refresh-ccw" class="w-4 h-4"></i> Actualizar
                        </button>
                        <button id="smart-promos-new-btn" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-sm font-semibold text-white hover:bg-blue-700">
                            <i data-lucide="plus" class="w-4 h-4"></i> Nueva Promo Inteligente
                        </button>
                    </div>
                </div>

                <div class="grid gap-4 md:grid-cols-3 mb-6">
                    <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-4">
                        <p class="text-xs uppercase font-semibold text-slate-400">Activas hoy</p>
                        <p class="text-3xl font-bold text-slate-900"><span id="smart-promos-active-count">0</span></p>
                        <p class="text-xs text-slate-500">Listas para usarse</p>
                    </div>
                    <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-4">
                        <p class="text-xs uppercase font-semibold text-slate-400">Programadas</p>
                        <p class="text-3xl font-bold text-slate-900"><span id="smart-promos-scheduled-count">0</span></p>
                        <p class="text-xs text-slate-500">Promos con fecha futura</p>
                    </div>
                    <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-4">
                        <p class="text-xs uppercase font-semibold text-slate-400">Menciones hoy</p>
                        <p class="text-3xl font-bold text-slate-900"><span id="smart-promos-today-count">0</span></p>
                        <p class="text-xs text-slate-500">Inserciones registradas</p>
                    </div>
                </div>

                <div id="smart-promos-empty" class="hidden border border-dashed border-slate-300 rounded-2xl p-8 text-center text-slate-500">
                    <i data-lucide="sparkles" class="w-10 h-10 mx-auto mb-4 text-blue-500"></i>
                    <p class="font-semibold text-slate-700">A√∫n no tienes Promos Inteligentes</p>
                    <p class="text-sm mb-5">Crea tu primera promo para que la IA la proponga autom√°ticamente.</p>
                    <button id="smart-promos-empty-btn" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-sm font-semibold text-white hover:bg-blue-700">
                        <i data-lucide="plus" class="w-4 h-4"></i> Crear Promo Inteligente
                    </button>
                </div>

                <div id="smart-promos-grid" class="grid gap-4 lg:grid-cols-2 xl:grid-cols-3"></div>
            </div>

            <!-- Contenedor para el panel de Chats. Se cargar√° din√°micamente. -->
            <!-- CORRECCI√ìN: El contenedor ahora est√° vac√≠o y cargar√° su contenido din√°micamente -->
            <div id="chats" class="content-panel h-full">
                <!-- Contenido de chats.html -->
                <div class="flex h-full bg-white rounded-xl shadow-md overflow-hidden">
                    <div id="chats-sidebar" class="w-full md:w-1/3 lg:w-1/4 border-r border-slate-200 flex flex-col">
                        <div class="p-4 border-b border-slate-200 flex-shrink-0">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-xl font-bold">Chats</h2>
                                <button id="new-chat-btn" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition flex items-center justify-center" title="Iniciar chat nuevo">
                                    <i data-lucide="message-square-plus" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <!-- Toggle para grupos/contactos -->
                            <div class="flex gap-2 mb-3 bg-slate-100 p-1 rounded-lg">
                                <button id="toggle-contacts-btn" class="flex-1 py-2 px-3 rounded-md text-sm font-semibold transition-colors bg-white text-blue-600 shadow-sm">
                                    <i data-lucide="user" class="w-4 h-4 inline mr-1"></i>
                                    Contactos
                                </button>
                                <button id="toggle-groups-btn" class="flex-1 py-2 px-3 rounded-md text-sm font-semibold transition-colors text-slate-600 hover:bg-slate-50">
                                    <i data-lucide="users" class="w-4 h-4 inline mr-1"></i>
                                    Grupos
                                </button>
                            </div>
                            <!-- Bot√≥n de sincronizaci√≥n (solo visible en vista de grupos) -->
                            <button id="sync-groups-btn" class="hidden w-full mb-3 py-2 px-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2 text-sm font-semibold">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                <span id="sync-groups-text">Sincronizar Grupos</span>
                            </button>
                            <input type="search" id="chat-search-input" placeholder="Buscar..." class="w-full form-input py-2 rounded-lg border-slate-300 text-sm">
                        </div>
                        <div id="contact-list-container" class="flex-grow overflow-y-auto">
                            <div id="contacts-list-loader" class="p-8 text-center text-slate-500 hidden">Cargando contactos...</div>
                            <div id="groups-list-loader" class="p-8 text-center text-slate-500 hidden">Cargando grupos...</div>
                            <div id="chat-contacts-list" class="p-2">
                                <!-- Los items de contacto/grupo se insertar√°n aqu√≠ -->
                            </div>
                        </div>
                    </div>
                    <div id="chat-main-area" class="flex-1 flex-col hidden md:flex">
                        <div id="chat-view-placeholder" class="flex flex-col items-center justify-center h-full text-slate-400"><i data-lucide="message-square" class="w-24 h-24"></i><p class="mt-4 text-lg font-semibold">Selecciona un chat para empezar</p></div>
                        <div id="chat-view-main" class="hidden flex-1 flex-col lg:flex-row min-h-0">
                            <div class="flex-1 flex flex-col">
                                <div class="flex items-center justify-between p-4 border-b border-slate-200 flex-shrink-0"><p id="chat-header-name" class="font-bold text-lg">Nombre</p><button id="chat-contact-info-toggle" class="p-2 rounded-full hover:bg-slate-100"><i data-lucide="info"></i></button></div>
                                <div id="chat-history" class="flex-grow overflow-y-auto p-4 space-y-4 flex flex-col"></div>
                                <div class="p-4 border-t border-slate-200 bg-slate-50 flex-shrink-0">
                                    <div id="chat-image-preview-container" class="hidden relative w-24 h-24 mb-2"><img id="chat-image-preview" class="w-full h-full object-cover rounded-md"><button id="chat-remove-image-btn" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1"><i data-lucide="x" class="w-3 h-3"></i></button></div>
                                    <form id="chat-input-form" class="flex items-center gap-3">
                                        <button type="button" id="chat-attach-file-btn" class="p-3 rounded-full hover:bg-slate-200"><i data-lucide="paperclip" class="w-5 h-5 text-slate-600"></i></button><input type="file" id="chat-file-input" class="hidden" accept="image/*">
                                        <textarea id="chat-message-input" rows="1" placeholder="Escribe un mensaje..." class="flex-1 form-input rounded-lg resize-none"></textarea>
                                        <button type="submit" id="chat-send-btn" class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 disabled:opacity-50"><i data-lucide="send" class="w-5 h-5"></i></button>
                                    </form>
                                </div>
                            </div>
                            <div id="chat-contact-info-panel" class="hidden lg:w-1/3 lg:max-w-sm border-l bg-white p-6 overflow-y-auto"><h4 id="info-contact-name" class="text-lg font-bold"></h4><p id="info-contact-phone" class="text-sm text-slate-500"></p><div class="mt-4 pt-4 border-t"><div id="info-contact-labels"></div><div id="info-manage-labels-container"></div></div><div class="mt-4 pt-4 border-t"><div class="relative inline-flex items-center cursor-pointer" id="info-ignore-ia-toggle-switch" data-contact-id="" data-ignored="false"><div class="relative w-11 h-6 bg-slate-200 rounded-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div><span class="ml-3 text-sm font-medium text-slate-700">Ignorar IA</span></div></div><div id="info-contact-razon-ia" class="mt-4 pt-4 border-t"></div><div id="info-chat-files" class="mt-4 pt-4 border-t"></div></div>
                        </div>
                    </div>
                    <div id="chat-info-overlay" class="hidden fixed inset-0 bg-black bg-opacity-25 z-10 lg:hidden"></div>
                </div>
            </div>

            <!-- Panel Contexto de Ventas -->
            <div id="sales-context" class="content-panel hidden max-w-4xl mx-auto">
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 space-y-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <p class="text-sm uppercase font-semibold text-slate-400">Promociones & scripts</p>
                            <h2 class="text-3xl font-bold text-slate-900">Contexto Comercial</h2>
                            <p class="text-sm text-slate-500 max-w-2xl">
                                Describe la oferta, objeciones y ganchos prioritarios para que la IA los use autom√°ticamente en ventas. No necesitas procesos adicionales en n8n.
                            </p>
                        </div>
                    </div>


                    <form id="sales-context-form" class="space-y-5">
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                            <p class="text-sm text-blue-800">
                                <strong>üí° ¬øQu√© es el Contexto de Ventas?</strong><br>
                                Configura c√≥mo la IA debe responder a objeciones comunes de tus clientes. 
                                La IA detectar√° autom√°ticamente estas objeciones y usar√° las respuestas que configures aqu√≠.
                            </p>
                        </div>
                        

                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">
                                Objeciones detectadas autom√°ticamente
                            </label>
                            <div id="sales-context-detected-objections" class="bg-slate-50 border border-slate-200 rounded-xl p-4 min-h-[100px]">
                                <p class="text-sm text-slate-600 mb-3">
                                    <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
                                    La IA detectar√° autom√°ticamente objeciones comunes como:
                                </p>
                                <div id="objections-list" class="space-y-2">
                                    <!-- Las objeciones se cargar√°n din√°micamente aqu√≠ -->
                                </div>
                                <button type="button" id="add-objection-btn" class="mt-3 text-sm text-blue-600 hover:text-blue-700 font-semibold flex items-center gap-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    Agregar objeci√≥n personalizada
                                </button>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">
                                <strong>¬øC√≥mo funciona?</strong> La IA detecta autom√°ticamente cuando un cliente dice estas objeciones y usa las respuestas que configuraste. 
                                Puedes editar haciendo clic en el √≠cono de l√°piz ‚úèÔ∏è, generar respuestas autom√°ticas con el bot√≥n de IA ü§ñ, o eliminar con la X. 
                                Las promociones espec√≠ficas est√°n en "Promociones Inteligentes" y se insertan autom√°ticamente cuando es relevante.
                            </p>
                        </div>

                        <!-- Mensajes Cr√≠ticos -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">
                                üö® Mensajes Cr√≠ticos
                            </label>
                            <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-3">
                                <p class="text-sm text-amber-800">
                                    <strong>¬øQu√© son los mensajes cr√≠ticos?</strong><br>
                                    Cuando un cliente env√≠a un mensaje cr√≠tico, la conversaci√≥n se pausa autom√°ticamente y recibes una notificaci√≥n. 
                                    Un humano debe responder en lugar de la IA.
                                </p>
                            </div>
                            
                            <!-- Cr√≠ticos Predefinidos -->
                            <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 mb-4">
                                <h4 class="text-sm font-semibold text-slate-700 mb-3">Cr√≠ticos Predefinidos</h4>
                                <div id="predefined-critical-rules" class="space-y-2">
                                    <!-- Se cargar√°n din√°micamente -->
                                </div>
                            </div>

                            <!-- Cr√≠ticos Personalizados -->
                            <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-sm font-semibold text-slate-700">Cr√≠ticos Personalizados</h4>
                                    <button type="button" id="add-critical-rule-btn" class="text-sm text-blue-600 hover:text-blue-700 font-semibold flex items-center gap-2">
                                        <i data-lucide="plus" class="w-4 h-4"></i> Agregar cr√≠tico
                                    </button>
                                </div>
                                <div id="custom-critical-rules" class="space-y-2">
                                    <!-- Se cargar√°n din√°micamente -->
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">
                                Puedes agregar palabras clave simples o patrones (expresiones regulares) para detectar mensajes cr√≠ticos espec√≠ficos de tu negocio.
                            </p>
                        </div>

                        <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4 space-y-3">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="sales-context-active" class="sr-only peer" checked>
                                <div class="relative w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                <span class="ml-3 text-sm font-semibold text-slate-700">Marcar como activo (la IA lo usar√° en todas las conversaciones)</span>
                            </label>
                            <label class="relative inline-flex items-center cursor-pointer mt-3">
                                <input type="checkbox" id="sales-context-auto-generate" class="sr-only peer" checked>
                                <div class="relative w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                <span class="ml-3 text-sm font-semibold text-slate-700">Generar respuestas autom√°ticamente usando datos de mi empresa</span>
                            </label>
                            <p class="text-xs text-slate-500 ml-8">Cuando est√° activo, el bot√≥n "Generar respuesta" usar√° tu prompt general y la informaci√≥n de tu empresa para crear respuestas personalizadas.</p>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <p class="text-xs text-slate-500">Cada guardado desactiva versiones anteriores para mantener un solo contexto vigente.</p>
                            <div class="flex flex-wrap items-center gap-3">
                                <button type="button" id="sales-context-clear" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-slate-300 text-sm font-semibold text-slate-600 hover:bg-slate-100">
                                    <i data-lucide="eraser" class="w-4 h-4"></i> Limpiar campos
                                </button>
                                <button type="submit" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-blue-600 text-sm font-semibold text-white hover:bg-blue-700">
                                    <i data-lucide="save" class="w-4 h-4"></i> Guardar contexto
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Panel de Citas y Calendario -->
            <div id="appointments" class="content-panel max-w-7xl mx-auto">
                <!-- Calendario -->
                <div id="appointments-container" class="bg-white rounded-xl shadow-md p-3">
                    <div id="appointments-loader" class="text-center text-slate-500 p-8">
                        <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin"></i>
                        <p>Cargando citas...</p>
                    </div>
                    <!-- Vista Mensual -->
                    <div id="calendar-month-view" class="hidden">
                        <!-- Header compacto con controles integrados -->
                        <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-200">
                            <div class="flex items-center gap-3">
                                <button id="calendar-prev-month" class="p-1.5 rounded-lg hover:bg-slate-100">
                                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                </button>
                                <h3 id="calendar-month-title" class="text-base font-bold text-slate-800"></h3>
                                <button id="calendar-next-month" class="p-1.5 rounded-lg hover:bg-slate-100">
                                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-xs font-medium text-slate-600 whitespace-nowrap">Filtrar:</label>
                                <select id="appointments-filter-status" class="form-input border-slate-300 rounded-lg text-xs py-1 px-2 min-w-[100px]">
                                    <option value="all">Todas</option>
                                    <option value="pending">Pendientes</option>
                                    <option value="confirmed">Confirmadas</option>
                                    <option value="completed">Completadas</option>
                                    <option value="cancelled">Canceladas</option>
                                </select>
                                <div class="relative inline-flex items-center bg-slate-200 rounded-lg p-0.5">
                                    <button id="calendar-view-month-btn" class="relative z-10 px-2 py-1 rounded-md text-xs font-medium transition-all duration-200 flex items-center gap-1 bg-green-600 text-white shadow-sm">
                                        <i data-lucide="calendar" class="w-3 h-3"></i> Mes
                                    </button>
                                    <button id="calendar-view-week-btn" class="relative z-10 px-2 py-1 rounded-md text-xs font-medium transition-all duration-200 flex items-center gap-1 text-slate-700 hover:text-slate-900">
                                        <i data-lucide="calendar-days" class="w-3 h-3"></i> Sem
                                    </button>
                                </div>
                                <button id="new-appointment-btn" class="bg-green-600 text-white font-semibold py-1 px-2.5 rounded-lg hover:bg-green-700 flex items-center gap-1.5 text-xs">
                                    <i data-lucide="plus" class="w-3 h-3"></i> Nueva
                                </button>
                                <button id="appointments-config-btn" class="bg-slate-600 text-white font-semibold py-1 px-2.5 rounded-lg hover:bg-slate-700 flex items-center gap-1.5 text-xs" title="Configurar citas">
                                    <i data-lucide="settings" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>
                        <div id="calendar-month-grid" class="grid grid-cols-7 gap-1.5">
                            <!-- Los d√≠as del mes se renderizar√°n aqu√≠ -->
                        </div>
                    </div>
                    <!-- Vista Semanal -->
                    <div id="calendar-week-view" class="hidden">
                        <!-- Header compacto con controles integrados -->
                        <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-200">
                            <div class="flex items-center gap-3">
                                <button id="calendar-prev-week" class="p-1.5 rounded-lg hover:bg-slate-100">
                                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                </button>
                                <h3 id="calendar-week-title" class="text-base font-bold text-slate-800"></h3>
                                <button id="calendar-next-week" class="p-1.5 rounded-lg hover:bg-slate-100">
                                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-xs font-medium text-slate-600 whitespace-nowrap">Filtrar:</label>
                                <select id="appointments-filter-status-week" class="form-input border-slate-300 rounded-lg text-xs py-1 px-2 min-w-[100px]">
                                    <option value="all">Todas</option>
                                    <option value="pending">Pendientes</option>
                                    <option value="confirmed">Confirmadas</option>
                                    <option value="completed">Completadas</option>
                                    <option value="cancelled">Canceladas</option>
                                </select>
                                <div class="relative inline-flex items-center bg-slate-200 rounded-lg p-0.5">
                                    <button id="calendar-view-month-btn-week" class="relative z-10 px-2 py-1 rounded-md text-xs font-medium transition-all duration-200 flex items-center gap-1 text-slate-700 hover:text-slate-900">
                                        <i data-lucide="calendar" class="w-3 h-3"></i> Mes
                                    </button>
                                    <button id="calendar-view-week-btn-week" class="relative z-10 px-2 py-1 rounded-md text-xs font-medium transition-all duration-200 flex items-center gap-1 bg-green-600 text-white shadow-sm">
                                        <i data-lucide="calendar-days" class="w-3 h-3"></i> Sem
                                    </button>
                                </div>
                                <button id="new-appointment-btn-week" class="bg-green-600 text-white font-semibold py-1 px-2.5 rounded-lg hover:bg-green-700 flex items-center gap-1.5 text-xs">
                                    <i data-lucide="plus" class="w-3 h-3"></i> Nueva
                                </button>
                                <button id="appointments-config-btn-week" class="bg-slate-600 text-white font-semibold py-1 px-2.5 rounded-lg hover:bg-slate-700 flex items-center gap-1.5 text-xs" title="Configurar citas">
                                    <i data-lucide="settings" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>
                        <div id="calendar-week-grid" class="grid grid-cols-8 gap-2">
                            <!-- Los d√≠as de la semana con horas se renderizar√°n aqu√≠ -->
                        </div>
                    </div>
                    <!-- Lista de Citas (fallback) -->
                    <div id="appointments-list" class="hidden space-y-3"></div>
                    <div id="appointments-empty" class="hidden bg-slate-50 rounded-xl p-12 text-center">
                        <i data-lucide="calendar-x" class="w-16 h-16 mx-auto text-slate-400 mb-4"></i>
                        <h3 class="text-xl font-bold text-slate-700">No hay citas agendadas</h3>
                        <p class="text-slate-500 mt-2">Las citas que la IA agende aparecer√°n aqu√≠.</p>
                        <p class="text-sm text-slate-400 mt-4">Activa el sistema de citas en Configuraci√≥n para comenzar.</p>
                    </div>
                </div>
            </div>
            <div id="community-manager" class="content-panel">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">Community Manager IA</h2>
                <div class="bg-white rounded-xl shadow-md p-6 text-center">
                    <i data-lucide="construction" class="w-16 h-16 mx-auto text-slate-400 mb-4"></i>
                    <h3 class="text-xl font-bold">Pr√≥ximamente</h3>
                    <p class="text-slate-500 mt-2">Automatiza la creaci√≥n y publicaci√≥n de contenido en tus redes sociales.</p>
                </div>
            </div>
            <div id="designer-ai" class="content-panel pb-16">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">Dise√±ador Gr√°fico IA</h2>
                <div id="designer-ai-access-denied" class="hidden bg-white rounded-xl shadow-md p-8 text-center">
                    <i data-lucide="lock" class="w-16 h-16 mx-auto text-slate-400 mb-4"></i>
                    <h3 class="text-xl font-bold">Funci√≥n Exclusiva del Plan Grow</h3>
                    <p class="text-slate-500 mt-2 max-w-md mx-auto">Crea im√°genes publicitarias √∫nicas para tus campa√±as con el poder de la IA. ¬°Desbloquea esta funci√≥n mejorando tu plan!</p>
                    <button id="upgrade-to-grow-from-designer" class="mt-6 bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700">
                        Mejorar a Plan Grow
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Columna de generaci√≥n y resultado -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md space-y-6">
                        <h3 class="text-xl font-bold">1. Define el Contenido de tu Imagen</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium">Mensaje Principal (Texto a incluir)</label><textarea id="design-main-message" rows="2" class="form-input w-full mt-1" placeholder="Ej: 50% de descuento"></textarea></div>
                            <div><label class="block text-sm font-medium">Texto que lo acompa√±a</label><textarea id="design-sub-text" rows="2" class="form-input w-full mt-1" placeholder="Ej: Solo esta semana"></textarea></div>
                            <div><label class="block text-sm font-medium">Estilo Visual</label><textarea id="design-style" rows="2" class="form-input w-full mt-1" placeholder="Ej: Minimalista, colores pastel, fondo de madera"></textarea></div>
                            <div><label class="block text-sm font-medium">Precio (Opcional)</label><input type="text" id="design-price" class="form-input w-full mt-1" placeholder="Ej: Antes $999, ahora $499"></div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Im√°genes de Referencia (M√°x. 3)</label>
                            <div id="design-reference-selector" class="grid grid-cols-4 md:grid-cols-6 gap-2">
                                <!-- Im√°genes de referencia de settings y nuevas se cargar√°n aqu√≠ -->
                            </div>
                            <button id="design-add-temp-ref" class="text-sm text-blue-600 hover:underline mt-2">A√±adir referencia temporal</button>
                            <input type="file" id="design-temp-ref-input" class="hidden" multiple accept="image/*">
                        </div>
                        
                        <div>
                            <label for="design-final-prompt" class="block text-sm font-medium">Prompt Final para la IA (Editable)</label>
                            <textarea id="design-final-prompt" rows="4" class="form-input w-full mt-1 bg-slate-50 text-sm" placeholder="El prompt para la IA se generar√° aqu√≠..."></textarea>
                            <p class="text-xs text-slate-400 mt-1">Este es el texto exacto que se enviar√° a la IA. Puedes editarlo para refinar el resultado.</p>
                        </div>

                        <div class="flex items-center justify-between pt-4 border-t">
                            <div class="flex items-center gap-6">
                                <div>
                                    <label class="block text-sm font-medium">Formato</label>
                                        <div class="custom-select-wrapper mt-1">
                                            <select id="design-aspect-ratio" class="custom-select form-input">
                                                <option value="1024x1024">Cuadrado (1:1)</option>
                                                <option value="1792x1024">Horizontal (16:9)</option>
                                                <option value="1024x1792">Vertical (9:16)</option>
                                            </select>
                                            <i data-lucide="chevron-down" class="select-icon w-5 h-5 text-slate-400"></i>
                                        </div>
                                </div>
                                <div class="pt-6">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="design-include-logo" class="form-checkbox h-5 w-5 rounded text-purple-600" checked>
                                        <span class="text-sm font-medium">Incluir Logo</span>
                                    </label>
                                </div>
                            </div>
                            <button id="generate-design-btn" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-purple-700">Generar Imagen</button>
                        </div>
                    </div>
                    <!-- Columna de resultado -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4">2. Resultado</h3>
                        <div id="design-result-container" class="bg-slate-100 aspect-square rounded-lg flex items-center justify-center text-slate-400 cursor-pointer" title="Haz clic para ver m√°s grande">
                            <i data-lucide="image" class="w-16 h-16"></i>
                        </div>
                        <button id="design-download-btn" class="hidden mt-4 w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                            <i data-lucide="download"></i> Descargar
                        </button>
                        <div class="mt-4 bg-slate-50 rounded-lg p-3 text-center">
                             <h4 class="font-bold text-sm mb-1">Uso Mensual</h4>
                             <p class="text-xs text-slate-600">Im√°genes generadas: <span id="image-generation-usage" class="font-bold">0 / 0</span></p>
                        </div>
                    </div>
                </div>
                <!-- Galer√≠a de Im√°genes Generadas -->
                <div id="gallery-section" class="mt-8 bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold mb-4">Mi Galer√≠a</h3>
                    <div id="design-gallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                    <div id="gallery-pagination" class="flex justify-center items-center gap-4 mt-6"></div>
                </div>
            </div>

            <!-- Panel de Video IA -->
            <div id="video-ai" class="content-panel pb-16">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">Generador de Video con IA</h2>
                <div id="video-ai-access-denied" class="hidden bg-white rounded-xl shadow-md p-8 text-center">
                    <i data-lucide="lock" class="w-16 h-16 mx-auto text-slate-400 mb-4"></i>
                    <h3 class="text-xl font-bold">Funci√≥n Exclusiva del Plan Grow</h3>
                    <p class="text-slate-500 mt-2 max-w-md mx-auto">Crea videos impactantes a partir de texto o im√°genes. ¬°Desbloquea esta funci√≥n mejorando tu plan!</p>
                    <button id="upgrade-to-grow-from-video" class="mt-6 bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700">
                        Mejorar a Plan Grow
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Columna de generaci√≥n -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md space-y-6">
                        <div>
                            <h3 class="text-xl font-bold mb-2">Generador de Video con IA (KIE Veo 3.1 Fast)</h3>
                            <p class="text-sm text-slate-500">Crea videos impactantes usando KIE Veo 3.1 Fast. Por defecto en formato vertical (Auto).</p>
                        </div>

                        <!-- Secci√≥n 1: Prompt de Acciones -->
                        <div>
                            <label for="video-actions-prompt" class="block text-sm font-semibold text-slate-700 mb-2">
                                Acciones del Video
                            </label>
                            <textarea 
                                id="video-actions-prompt" 
                                rows="3" 
                                class="form-input w-full mt-1" 
                                placeholder="Ej: Un perro corriendo en el parque, una persona cocinando, un auto en movimiento...">
                            </textarea>
                            <p class="text-xs text-slate-500 mt-1">Describe las acciones principales que quieres ver en el video.</p>
                        </div>

                        <!-- Secci√≥n 2: Prompt de Texto -->
                        <div>
                            <label for="video-text-prompt" class="block text-sm font-semibold text-slate-700 mb-2">
                                Descripci√≥n del Video
                            </label>
                            <textarea 
                                id="video-text-prompt" 
                                rows="4" 
                                class="form-input w-full mt-1" 
                                placeholder="Ej: Estilo cinematogr√°fico, ambiente c√°lido, iluminaci√≥n natural, alta calidad...">
                            </textarea>
                            <p class="text-xs text-slate-500 mt-1">Describe el estilo, ambiente, iluminaci√≥n y otros detalles visuales.</p>
                        </div>

                        <!-- Secci√≥n 3: Audio de Fondo -->
                        <div>
                            <label for="video-audio-type" class="block text-sm font-semibold text-slate-700 mb-2">
                                Tipo de Audio de Fondo (Opcional)
                            </label>
                            <input 
                                type="text" 
                                id="video-audio-type" 
                                class="form-input w-full mt-1" 
                                placeholder="Ej: M√∫sica relajante, sonidos de naturaleza, ambiente urbano, sin audio...">
                            <p class="text-xs text-slate-500 mt-1">Describe el tipo de audio que quieres en el video.</p>
                        </div>

                        <!-- Secci√≥n 4: Imagen de Referencia -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">
                                Imagen de Referencia o Primer Frame (Opcional)
                            </label>
                            <p class="text-xs text-slate-500 mb-2">Puedes subir 1 imagen como referencia o 2 im√°genes (primera y √∫ltima frame) para crear una transici√≥n.</p>
                            <div id="video-reference-selector" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <!-- Slots para im√°genes de referencia -->
                            </div>
                        </div>

                        <!-- Configuraci√≥n Avanzada (Opcional) -->
                        <div class="pt-4 border-t">
                            <details class="cursor-pointer">
                                <summary class="text-sm font-semibold text-slate-700 mb-2">Configuraci√≥n Avanzada (Opcional)</summary>
                                <div class="mt-3 space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1">Relaci√≥n de Aspecto</label>
                                        <select id="video-aspect-ratio-select" class="form-input w-full">
                                            <option value="Auto" selected>Auto (Vertical - Recomendado)</option>
                                            <option value="9:16">9:16 (Vertical)</option>
                                            <option value="16:9">16:9 (Horizontal)</option>
                                        </select>
                                        <p class="text-xs text-slate-500 mt-1">Auto ajusta autom√°ticamente seg√∫n la imagen de referencia (recomendado para vertical).</p>
                                    </div>
                                </div>
                            </details>
                        </div>

                        <div class="flex items-center justify-end pt-4 border-t">
                            <button id="generate-video-btn" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-purple-700 flex items-center gap-2">
                                <i data-lucide="video" class="w-5 h-5"></i>
                                Generar Video
                            </button>
                        </div>
                    </div>
                    <!-- Columna de resultado -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4">2. Resultado</h3>
                        <div id="video-result-container" class="bg-slate-100 aspect-video rounded-lg flex items-center justify-center text-slate-400">
                            <i data-lucide="film" class="w-16 h-16"></i>
                        </div>
                        <div id="video-generation-usage-container" class="mt-4 bg-slate-50 rounded-lg p-3 text-center"></div>
                    </div>
                </div>
            </div>

            <div id="settings" class="content-panel max-w-4xl mx-auto">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">Configuraci√≥n</h2>
                <form id="settings-form" class="bg-white p-8 rounded-xl shadow-md space-y-8 max-w-4xl mx-auto">
                    <!-- Horario Laboral -->
                    <div>
                        <h3 class="text-lg font-semibold border-b pb-2 mb-4">Horario de Atenci√≥n</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">                            
                            <div><label for="work-start-hour" class="block text-sm font-medium text-slate-700">Hora de Apertura</label><input type="time" id="work-start-hour" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"></div>
                            <div><label for="work-end-hour" class="block text-sm font-medium text-slate-700">Hora de Cierre</label><input type="time" id="work-end-hour" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"></div>
                        </div>
                         <p class="text-xs text-slate-500 mt-2">Define las horas en las que Elina enviar√° seguimientos autom√°ticos.</p>
                    </div>

                    <!-- Informaci√≥n de la Empresa -->
                    <div>
                        <h3 class="text-lg font-semibold border-b pb-2 mb-4">Informaci√≥n de la Empresa</h3>
                        <div class="mb-4">
                            <label for="company-name" class="block text-sm font-medium text-slate-700">Nombre de la Empresa *</label>
                            <input type="text" id="company-name" placeholder="Ej: Mi Empresa S.A." class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" required>
                            <p class="text-xs text-slate-500 mt-1">Este nombre se usar√° en cotizaciones, mensajes y documentos oficiales</p>
                        </div>
                        <label for="company-description" class="block text-sm font-medium text-slate-700">Descripci√≥n General</label>
                        <textarea id="company-description" rows="5" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" placeholder="Ej: Somos una agencia de marketing digital en CDMX..."></textarea>
                        <p class="text-xs text-slate-500 mt-2">La IA usar√° esto para entender mejor tu negocio y responder preguntas generales.</p>
                    </div>
                    
                    <!-- Funcionalidades -->
                    <div>
                        <h3 class="text-lg font-semibold border-b pb-2 mb-4">Funcionalidades</h3>
                        <div class="space-y-4">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="quotes-enabled" class="sr-only peer">
                                <div class="relative w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                <div class="ml-3">
                                    <span class="block text-sm font-medium text-slate-700">Habilitar Cotizaciones</span>
                                    <span class="text-xs text-slate-500">Permite crear y gestionar cotizaciones en PDF para tus clientes</span>
                                </div>
                            </label>
                            <label class="relative inline-flex items-center cursor-pointer mt-4">
                                <input type="checkbox" id="appointments-enabled-general" class="sr-only peer">
                                <div class="relative w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                <div class="ml-3">
                                    <span class="block text-sm font-medium text-slate-700">Activar Sistema de Citas</span>
                                    <span class="text-xs text-slate-500">Permite gestionar citas y calendario. Configura horarios y servicios en la secci√≥n "Sistema de Citas y Calendario"</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Contacto y Redes -->
                    <div>
                        <h3 class="text-lg font-semibold border-b pb-2 mb-4">Contacto y Redes Sociales</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="website" class="block text-sm font-medium text-slate-700">Sitio Web</label><input type="text" id="website" placeholder="tuempresa.com" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"></div>
                            <!-- INICIO: Campo de tel√©fono del administrador -->
                            <div>
                                <label for="admin-phone-number" class="block text-sm font-medium text-slate-700 mb-1">Tel√©fono del Administrador</label>
                                <div class="flex items-center gap-2 mt-1">
                                    <input type="tel" id="admin-phone-input" class="form-input w-full border-slate-300 rounded-lg">
                                </div>
                            </div>
                            <!-- FIN: Campo de tel√©fono del administrador -->
                            <div><label for="social-instagram" class="block text-sm font-medium text-slate-700">Instagram</label><input type="text" id="social-instagram" placeholder="tu_usuario_de_instagram" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"></div>
                            <div><label for="social-facebook" class="block text-sm font-medium text-slate-700">Facebook</label><input type="text" id="social-facebook" placeholder="tu_pagina_de_facebook" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"></div>
                        </div>
                    </div>

                    <!-- Branding y Activos Visuales -->
                    <div>
                        <h3 class="text-lg font-semibold border-b pb-2 mb-4">Branding y Activos Visuales</h3>
                        <div class="space-y-6">
                            <!-- Logo -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Logo de la Empresa</label>
                                <div class="flex items-center gap-4">
                                    <img id="logo-preview" src="https://placehold.co/100x100/e2e8f0/475569?text=Logo" alt="Vista previa del logo" class="w-24 h-24 rounded-lg object-contain bg-slate-100 p-1">
                                    <input type="file" id="logo-input" class="hidden" accept="image/png, image/jpeg, image/webp, image/svg+xml">
                                    <button type="button" id="upload-logo-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cambiar Logo</button>
                                </div>
                            </div>
                            <!-- Paleta de Colores -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Paleta de Colores de Marca</label>
                                <div class="flex gap-4">
                                    <input type="color" id="brand-color-1" value="#3b82f6" class="h-12 w-full rounded-lg cursor-pointer">
                                    <input type="color" id="brand-color-2" value="#10b981" class="h-12 w-full rounded-lg cursor-pointer">
                                    <input type="color" id="brand-color-3" value="#f97316" class="h-12 w-full rounded-lg cursor-pointer">
                                    <input type="color" id="brand-color-4" value="#1e293b" class="h-12 w-full rounded-lg cursor-pointer">
                                </div>
                            </div>
                            <!-- Tipograf√≠a -->
                            <div>
                                <label for="brand-font" class="block text-sm font-medium text-slate-700">Tipograf√≠a de Marca</label>
                                <div class="custom-select-wrapper mt-1">
                                    <select id="brand-font" class="custom-select form-input">
                                        <option>Poppins</option><option>Roboto</option><option>Lato</option><option>Montserrat</option><option>Oswald</option><option>Open Sans</option>
                                    </select>
                                    <i data-lucide="chevron-down" class="select-icon w-5 h-5 text-slate-400"></i>
                                </div>
                                <p class="text-xs text-slate-500 mt-2">Por el momento no podemos cargar fuentes personalizadas, pero tenemos un amplio cat√°logo para que elijas.</p>
                            </div>
                            <!-- Im√°genes de Referencia -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Im√°genes de Referencia para IA</label>
                                <div id="reference-images-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4">
                                    <!-- Las im√°genes existentes se cargar√°n aqu√≠ -->
                                    <div id="add-ref-image-slot" class="aspect-square bg-slate-100 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-center cursor-pointer hover:bg-slate-200 hover:border-slate-400">
                                        <i data-lucide="plus" class="w-8 h-8 text-slate-400"></i>
                                    </div>
                                </div>
                                <input type="file" id="reference-image-input" class="hidden" accept="image/png, image/jpeg, image/webp" multiple>
                                <p class="text-xs text-slate-500 mt-2">Sube hasta 3 im√°genes. La IA las tomar√° como referencia para tus dise√±os gr√°ficos.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Gesti√≥n de Equipo (Solo para Admins) -->
                    <div id="team-management-panel" class="hidden">
                        <h3 class="text-lg font-semibold border-b pb-2 mb-4">Gesti√≥n de Equipo</h3>
                        <div class="bg-slate-50 p-6 rounded-lg">
                            <h4 class="font-semibold mb-2">Invitar Nuevo Miembro</h4>
                            <p class="text-sm text-slate-600 mb-4">La persona recibir√° un correo para crear su cuenta y unirse a tu equipo.</p>
                            <form id="invite-member-form" class="flex items-center gap-2">
                                <input type="email" id="invite-email" placeholder="correo@ejemplo.com" required class="form-input w-full border-slate-300 rounded-lg text-sm">
                                <button type="button" id="invite-member-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 whitespace-nowrap">Invitar</button>
                            </form>
                        </div>
                        <div class="mt-6">
                            <h4 class="font-semibold mb-2">Miembros del Equipo</h4>
                            <div id="team-members-list" class="space-y-3">
                                <!-- La lista de miembros y sus permisos se renderizar√° aqu√≠ -->
                            </div>
                        </div>
                    </div>

                    <div class="pt-5">
                        <button type="button" id="settings-save-safe-btn" data-settings-primary="true" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 disabled:opacity-50">Guardar</button>
                    </div>
                </form>
            </div>
            </main>
        </div>
    </div>

    <!-- Modal para Editar Etiquetas (inicialmente oculto) -->
    <div id="edit-labels-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 border-b">
                <h3 class="text-xl font-bold">Gestionar Etiquetas</h3>
            </div>
            <div id="labels-list" class="p-6 max-h-60 overflow-y-auto">
                <!-- Lista de etiquetas se renderizar√É¬° aqu√É¬≠ -->
                <div class="text-center text-slate-500">Cargando etiquetas...</div>
            </div>
            <div class="p-6 border-t">
                <form id="new-label-form" class="flex items-center gap-2">
                    <input type="text" id="new-label-name" placeholder="Crear nueva etiqueta..." class="form-input w-full border-slate-300 rounded-lg text-sm">
                    <input type="color" id="new-label-color" value="#38bdf8" class="h-9 w-12 rounded-lg cursor-pointer">
                    <button type="submit" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">
                        <i data-lucide="plus"></i>
                    </button>
                </form>
            </div>
            <div class="p-6 bg-slate-50 flex justify-end gap-3 rounded-b-lg">
                <button id="cancel-labels-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                <button id="save-labels-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Modal para Mejora con IA -->
    <div id="ai-enhance-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <div class="p-6 border-b">
                <h3 class="text-xl font-bold">Mejorar con IA</h3>
                <p class="text-sm text-slate-500">Usos restantes este mes: <span id="ai-uses-left" class="font-semibold">0/0</span></p>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="ai-original-text" class="block text-sm font-medium text-slate-600">Texto Original</label>
                    <textarea id="ai-original-text" rows="4" class="w-full border-slate-300 rounded-lg p-3 bg-slate-100 text-slate-700" readonly></textarea>
                </div>
                <div>
                    <label for="ai-prompt-input" class="block text-sm font-medium text-slate-600">¬øQu√© quieres mejorar? (Opcional)</label>
                    <input type="text" id="ai-prompt-input" placeholder="Ej: 'Hazlo m√°s amigable', 'A√±ade una regla sobre precios', 'Mejora la secci√≥n de ejemplos'" class="form-input w-full border-slate-300 rounded-lg text-sm">
                    <p class="text-xs text-slate-500 mt-1">La IA mejorar√° tu prompt manteniendo toda la estructura y contenido existente. Solo especifica qu√© aspecto quieres mejorar.</p>
                </div>
                <div id="ai-result-container" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg"></div>
            </div>
            <div class="p-6 bg-slate-50 flex justify-between items-center rounded-b-lg">
                <button id="cancel-ai-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                <div class="flex items-center gap-2">
                    <button id="regenerate-ai-btn" class="hidden bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Reintentar</button>
                    <button id="generate-ai-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Mejorar Texto</button>
                    <button id="apply-ai-btn" class="hidden bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Usar este texto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Env√≠o de Prueba -->
    <div id="test-send-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 border-b">
                <h3 class="text-xl font-bold">Enviar Mensaje de Prueba</h3>
            </div>
            <div class="p-6">
                <p class="text-sm text-slate-600 mb-4">Ingresa el n√∫mero de tel√©fono al que deseas enviar la prueba. El mensaje usar√° "Prueba" en lugar de %nombre%.</p>
                <div class="iti-container">
                    <label for="test-phone-input" class="block text-sm font-medium text-slate-700 mb-2">N√∫mero de Tel√©fono</label>
                    <input type="tel" id="test-phone-input" class="form-input w-full border-slate-300 rounded-lg">
                </div>
                <div id="test-phone-error" class="text-red-500 text-xs mt-1 hidden">N√∫mero inv√°lido.</div>
            </div>
            <div class="p-6 bg-slate-50 flex justify-end gap-3 rounded-b-lg">
                <button id="cancel-test-send-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                <button id="confirm-test-send-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Enviar Prueba</button>
            </div>
        </div>
    </div>

    <!-- Modal para Asignar/Crear Etiqueta con IA -->
    <div id="assign-label-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <form id="assign-label-form">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold">Asignar Etiqueta con IA</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="assign-label-select" class="block text-sm font-medium text-slate-700">Elige una etiqueta existente</label>
                        <div class="custom-select-wrapper mt-1">
                            <select id="assign-label-select" required class="custom-select form-input"></select>
                            <i data-lucide="tag" class="select-icon w-5 h-5 text-slate-400"></i>
                        </div>
                        <p class="text-xs text-slate-500 mt-1">O <a href="#" id="create-new-label-link" class="text-blue-600 hover:underline">crea una nueva etiqueta</a> si no la encuentras.</p>
                    </div>
                    <div>
                        <label for="assign-label-condition" class="block text-sm font-medium text-slate-700">Condici√≥n para la IA</label>
                        <div class="flex justify-end mb-1">
                            <button type="button" id="smart-label-ai-enhance-btn" class="text-xs bg-purple-100 text-purple-700 font-semibold py-1 px-2 rounded-md hover:bg-purple-200 flex items-center gap-1">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> Mejorar con IA
                            </button>
                        </div>
                        <textarea id="assign-label-condition" rows="4" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" placeholder="Describe cu√°ndo se debe aplicar esta etiqueta. Ej: 'Cuando el cliente pregunte por el precio y no vuelva a responder en 24 horas'." required></textarea>
                    </div>
                </div>
                <div class="p-6 bg-slate-50 flex justify-end gap-3 rounded-b-lg">
                    <button type="button" id="cancel-assign-label-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Guardar Automatizaci√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Nuevo Producto -->
    <div id="new-product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="p-6 border-b">
                    <h3 id="product-modal-title" class="text-xl font-bold">A√±adir Nuevo Producto</h3>
                </div>
                <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Tipo de Producto *</label>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="product-type" id="product-type-physical" value="physical" checked class="w-4 h-4 text-blue-600">
                                <span class="text-sm text-slate-700 font-medium">Producto F√≠sico</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="product-type" id="product-type-service" value="service" class="w-4 h-4 text-blue-600">
                                <span class="text-sm text-slate-700 font-medium">Servicio</span>
                            </label>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Los servicios tienen duraci√≥n y se usan para agendar citas</p>
                    </div>
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-slate-700 mb-1">Nombre del Producto *</label>
                        <input type="text" id="product-name" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm form-input" placeholder="Ej: Consulta Dental">
                    </div>
                    <div id="product-service-duration-container" class="hidden">
                        <label for="product-service-duration" class="block text-sm font-medium text-slate-700 mb-1">Duraci√≥n del Servicio (minutos) *</label>
                        <input type="number" id="product-service-duration" min="15" step="15" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm form-input" placeholder="Ej: 30, 60, 90">
                        <p class="text-xs text-slate-500 mt-1">Duraci√≥n en minutos (m√≠nimo 15, incrementos de 15)</p>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="product-description" class="block text-sm font-medium text-slate-700">Descripci√≥n</label>
                            <button type="button" id="product-description-ai-enhance-btn" class="text-xs bg-purple-100 text-purple-700 font-semibold py-1 px-2 rounded-md hover:bg-purple-200 flex items-center gap-1">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> Mejorar con IA
                            </button>
                        </div>
                        <textarea id="product-description" rows="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm form-textarea" placeholder="Describe el producto o servicio..."></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="product-sku" class="block text-sm font-medium text-slate-700 mb-1">SKU (Identificador √önico) *</label>
                            <input type="text" id="product-sku" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm form-input" placeholder="Ej: PROD-001">
                        </div>
                        <div>
                            <label for="product-price" class="block text-sm font-medium text-slate-700 mb-1">Precio *</label>
                            <input type="number" id="product-price" step="0.01" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm form-input" placeholder="0.00">
                        </div>
                    </div>
                    <div id="product-stock-container" class="flex items-center gap-4">
                        <div class="flex-1">
                            <label for="product-stock" class="block text-sm font-medium text-slate-700 mb-1">Disponibilidad (Stock)</label>
                            <input type="number" id="product-stock" value="0" min="0" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm form-input">
                        </div>
                        <div class="pt-6">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="product-infinite-stock" class="form-checkbox h-5 w-5 rounded text-blue-600">
                                <span class="ml-2 text-sm text-slate-600">Disponibilidad Infinita</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="product-media-file" class="block text-sm font-medium text-slate-700">Imagen o Video (Opcional)</label>
                        <div class="mt-2">
                            <img id="product-image-preview" src="" alt="Vista previa" class="hidden max-h-40 rounded-lg">
                        </div>
                        <input type="file" id="product-media-file" accept="image/*,video/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                    <div>
                        <label for="product-labels" class="block text-sm font-medium text-slate-700">Etiquetas (Opcional)</label>
                        <input type="text" id="product-labels" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" placeholder="Ej: Premium, Oferta, Nuevo (separadas por comas)">
                        <p class="text-xs text-slate-500 mt-1">Separa las etiquetas con comas. Ejemplo: Premium, Oferta, Nuevo</p>
                    </div>
                </div>
                <div class="p-6 bg-slate-50 flex justify-end gap-3 rounded-b-lg">
                    <button type="button" id="cancel-product-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                    <button type="submit" id="save-new-product-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50">Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para mapeo de columnas CSV -->
    <div id="column-mapping-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[90] px-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
            <div class="flex items-start justify-between p-6 border-b border-slate-200">
                <div>
                    <h3 class="text-xl font-bold text-slate-900">Mapeo de Columnas</h3>
                    <p class="text-sm text-slate-500 mt-1">Elige qu√© columna de tu archivo corresponde a cada campo de Elina.</p>
                </div>
                <button id="close-column-mapping-btn" class="text-slate-400 hover:text-slate-600" aria-label="Cerrar">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="px-6 pt-4 pb-6 overflow-y-auto">
                <div class="overflow-x-auto rounded-lg border border-slate-200">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50 text-left text-sm font-semibold text-slate-600 uppercase tracking-wide">
                            <tr>
                                <th class="px-4 py-3">Campo en Elina</th>
                                <th class="px-4 py-3">Columna del CSV</th>
                            </tr>
                        </thead>
                        <tbody id="column-mapping-table-body" class="divide-y divide-slate-200 bg-white text-sm"></tbody>
                    </table>
                </div>
                <div id="column-mapping-error" class="hidden mt-4 text-sm font-medium text-red-500"></div>
            </div>
            <div class="flex justify-end gap-3 px-6 pb-6 border-t border-slate-200 bg-slate-50">
                <button id="cancel-column-mapping-btn" class="py-2 px-4 rounded-lg font-semibold text-slate-700 bg-slate-200 hover:bg-slate-300">Cancelar</button>
                <button id="confirm-column-mapping-btn" class="py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700">Confirmar e Importar</button>
            </div>
        </div>
    </div>

    <!-- Modal para verificaci√≥n de contactos - Carga de archivo -->
    <div id="verify-contacts-file-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[90] px-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="flex items-start justify-between p-6 border-b border-slate-200">
                <div>
                    <h3 class="text-xl font-bold text-slate-900">Comprobar Contactos</h3>
                    <p class="text-sm text-slate-500 mt-1">Carga un archivo XLSX o CSV para verificar qu√© n√∫meros tienen WhatsApp.</p>
                </div>
                <button id="close-verify-file-modal-btn" class="text-slate-400 hover:text-slate-600" aria-label="Cerrar">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="verify-contacts-file-input" class="block text-sm font-medium text-slate-700 mb-2">
                        Seleccionar archivo
                    </label>
                    <input type="file" id="verify-contacts-file-input" accept=".csv,.xlsx,.xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <p class="mt-2 text-xs text-slate-500">Formatos soportados: CSV, XLSX, XLS</p>
                </div>
                <div id="verify-file-error" class="hidden mt-4 text-sm font-medium text-red-500"></div>
            </div>
            <div class="flex justify-end gap-3 px-6 pb-6 border-t border-slate-200 bg-slate-50">
                <button id="cancel-verify-file-btn" class="py-2 px-4 rounded-lg font-semibold text-slate-700 bg-slate-200 hover:bg-slate-300">Cancelar</button>
                <button id="confirm-verify-file-btn" class="py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700">Continuar</button>
            </div>
        </div>
    </div>

    <!-- Modal para selecci√≥n de hoja (XLSX) -->
    <div id="verify-contacts-sheet-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[90] px-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="flex items-start justify-between p-6 border-b border-slate-200">
                <div>
                    <h3 class="text-xl font-bold text-slate-900">Seleccionar Hoja</h3>
                    <p class="text-sm text-slate-500 mt-1">Elige qu√© hoja del archivo Excel deseas procesar.</p>
                </div>
                <button id="close-verify-sheet-modal-btn" class="text-slate-400 hover:text-slate-600" aria-label="Cerrar">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="verify-sheet-select" class="block text-sm font-medium text-slate-700 mb-2">
                        Hoja a procesar
                    </label>
                    <select id="verify-sheet-select" class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Cargando hojas...</option>
                    </select>
                </div>
                <div id="verify-sheet-error" class="hidden mt-4 text-sm font-medium text-red-500"></div>
            </div>
            <div class="flex justify-end gap-3 px-6 pb-6 border-t border-slate-200 bg-slate-50">
                <button id="cancel-verify-sheet-btn" class="py-2 px-4 rounded-lg font-semibold text-slate-700 bg-slate-200 hover:bg-slate-300">Cancelar</button>
                <button id="confirm-verify-sheet-btn" class="py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700">Continuar</button>
            </div>
        </div>
    </div>

    <!-- Modal para mapeo y nombre de lista (verificaci√≥n) -->
    <div id="verify-contacts-mapping-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[90] px-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="flex items-start justify-between p-6 border-b border-slate-200">
                <div>
                    <h3 class="text-xl font-bold text-slate-900">Configurar Verificaci√≥n</h3>
                    <p class="text-sm text-slate-500 mt-1">Mapea las columnas y asigna un nombre a la lista de contactos verificados.</p>
                </div>
                <button id="close-verify-mapping-modal-btn" class="text-slate-400 hover:text-slate-600" aria-label="Cerrar">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="px-6 pt-4 pb-6 overflow-y-auto">
                <div class="mb-6">
                    <label for="verify-list-name-input" class="block text-sm font-medium text-slate-700 mb-2">
                        Nombre de la lista/etiqueta <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="verify-list-name-input" placeholder="Ej: Lista Verificada Enero 2025" class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="mt-1 text-xs text-slate-500">Este nombre se usar√° como etiqueta para todos los contactos verificados.</p>
                </div>
                <div class="mb-4">
                    <h4 class="text-sm font-semibold text-slate-700 mb-3">Vista previa (primeras 10 filas)</h4>
                    <div class="overflow-x-auto rounded-lg border border-slate-200 max-h-64 overflow-y-auto">
                        <table class="min-w-full divide-y divide-slate-200 text-xs">
                            <thead class="bg-slate-50 sticky top-0">
                                <tr id="verify-preview-headers"></tr>
                            </thead>
                            <tbody id="verify-preview-body" class="divide-y divide-slate-200 bg-white"></tbody>
                        </table>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-lg border border-slate-200">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50 text-left text-sm font-semibold text-slate-600 uppercase tracking-wide">
                            <tr>
                                <th class="px-4 py-3">Campo en Elina</th>
                                <th class="px-4 py-3">Columna del archivo</th>
                            </tr>
                        </thead>
                        <tbody id="verify-column-mapping-table-body" class="divide-y divide-slate-200 bg-white text-sm"></tbody>
                    </table>
                </div>
                <div id="verify-mapping-error" class="hidden mt-4 text-sm font-medium text-red-500"></div>
            </div>
            <div class="flex justify-end gap-3 px-6 pb-6 border-t border-slate-200 bg-slate-50">
                <button id="cancel-verify-mapping-btn" class="py-2 px-4 rounded-lg font-semibold text-slate-700 bg-slate-200 hover:bg-slate-300">Cancelar</button>
                <button id="confirm-verify-mapping-btn" class="py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700">Verificar e Importar</button>
            </div>
        </div>
    </div>

    <!-- Men√∫ de Navegaci√≥n Inferior para M√≥vil -->
    <!-- CORRECCI√ìN: A√±adir 'md:hidden' para ocultar en desktop -->
    <div class="mobile-bottom-nav fixed bottom-0 left-0 w-full bg-slate-900 border-t border-slate-700 flex justify-around items-center px-2 py-3 z-40 md:hidden">
        <a href="#" class="nav-link text-sm flex flex-col items-center text-slate-400 hover:text-white" data-target="dashboard">
            <i data-lucide="layout-dashboard" class="w-6 h-6"></i><span class="text-xs mt-1">Dashboard</span>
        </a>
        <a href="/superadmin.html" id="mobile-superadmin-link" class="hidden nav-link text-sm flex flex-col items-center text-slate-400 hover:text-white">
            <i data-lucide="shield" class="w-6 h-6"></i><span class="text-xs mt-1">Admin</span>
        </a>
        <a href="#" class="nav-link text-sm flex flex-col items-center text-slate-400 hover:text-white" data-target="products">
            <i data-lucide="boxes" class="w-6 h-6"></i><span class="text-xs mt-1">Productos</span>
        </a>
        <a href="#" class="nav-link text-sm flex flex-col items-center text-slate-400 hover:text-white" data-target="sales-context">
            <i data-lucide="scroll-text" class="w-6 h-6"></i><span class="text-xs mt-1">Contexto</span>
        </a>
        <a href="#" class="nav-link text-sm flex flex-col items-center text-slate-400 hover:text-white" data-target="kanban">
            <i data-lucide="columns-3" class="w-6 h-6"></i><span class="text-xs mt-1">Kanban</span>
        </a>
        <a href="#" class="nav-link text-sm flex flex-col items-center text-slate-400 hover:text-white" data-target="settings">
            <i data-lucide="settings" class="w-6 h-6"></i><span class="text-xs mt-1">Ajustes</span>
        </a>
        <!-- CORRECCI√ìN: Bot√≥n de men√∫ hamburguesa movido a la barra inferior -->
        <button id="mobile-menu-btn" class="flex flex-col items-center text-slate-400 hover:text-white">
            <i data-lucide="menu" class="w-6 h-6"></i><span class="text-xs mt-1">Men√∫</span>
        </button>
    </div>

    <!-- Modal de Selecci√≥n de Plan (Pricing) -->
    <div id="pricing-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl">
            <div class="p-6 text-center border-b">
                <h3 class="text-2xl font-bold">Elige el Plan Perfecto para Ti</h3>
                <p class="text-slate-500 mt-1">Tu prueba gratuita est√° por terminar. ¬°Sigue creciendo con Elina IA!</p>
            </div>
            <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Plan Starter -->
                <div class="border rounded-lg p-6 flex flex-col">
                    <h4 class="text-xl font-bold text-cyan-600">Starter</h4>
                    <p class="plan-price text-3xl font-bold my-4">$499 <span class="text-sm font-normal text-slate-500">/mes</span></p>
                    <ul class="space-y-2 text-slate-600 mb-auto">
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500"></i>500 Env√≠os Masivos</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500"></i>5 Mejoras con IA</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500"></i>Manejo de Productos</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500"></i>Plantillas de Mensajes</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500"></i>Gesti√≥n de Etiquetas</li>
                        <li class="flex items-center gap-2"><i data-lucide="x" class="w-4 h-4 text-red-500"></i>Seguimientos Autom√°ticos</li>
                    </ul>
                    <button class="upgrade-btn mt-6 w-full bg-cyan-600 text-white font-bold py-3 rounded-lg hover:bg-cyan-700" data-plan="starter">
                        Elegir Starter
                    </button>
                </div>
                <!-- Plan Grow -->
                <div class="border-2 border-purple-500 rounded-lg p-6 flex flex-col relative">
                    <span class="absolute top-0 -translate-y-1/2 bg-purple-500 text-white text-xs font-bold px-3 py-1 rounded-full">M√°s Popular</span>
                    <h4 class="text-xl font-bold text-purple-600">Grow</h4>
                    <p class="plan-price text-3xl font-bold my-4">$1499 <span class="text-sm font-normal text-slate-500">/mes</span></p>
                    <ul class="space-y-2 text-slate-600 mb-auto">
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500"></i>1000 Env√≠os Masivos</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500"></i>20 Mejoras con IA</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500"></i>Manejo de Productos</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500"></i>Plantillas de Mensajes</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500"></i>Gesti√≥n de Etiquetas</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500"></i>Seguimientos Autom√°ticos</li>
                    </ul>
                    <button class="upgrade-btn mt-6 w-full bg-purple-600 text-white font-bold py-3 rounded-lg hover:bg-purple-700" data-plan="grow">
                        Elegir Grow
                    </button>
                </div>
            </div>
            <div class="p-4 bg-slate-50 text-center rounded-b-lg">
                <button id="cancel-pricing-modal-btn" class="text-sm text-slate-600 hover:underline">Seguir con la prueba</button>
            </div>
        </div>
    </div>

    <!-- Modal Global de Informaci√≥n del Contacto -->
    <div id="contact-info-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <!-- Cabecera -->
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Informaci√≥n del Contacto</h3>
                <button id="close-contact-info-modal-btn" class="p-2 rounded-full hover:bg-slate-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <!-- Cuerpo -->
            <div id="contact-info-modal-body" class="p-6 space-y-4">
                <!-- El contenido se llenar√° din√°micamente -->
                <div class="text-center text-slate-500">Cargando...</div>
            </div>
            <!-- Pie de p√°gina con acciones -->
            <div class="p-6 bg-slate-50 flex justify-end gap-3 rounded-b-lg">
                <button id="contact-info-modal-labels-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">
                    Gestionar Etiquetas
                </button>
                <button id="contact-info-modal-chat-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                    Abrir Chat
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Visor de Im√°genes -->
    <div id="image-viewer-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[80] p-4 cursor-pointer">
        <div class="relative w-[90vw] h-[80vh] cursor-default flex flex-col items-center justify-center">
            <div id="image-viewer-content" class="w-full h-full bg-black rounded-lg overflow-hidden flex items-center justify-center">
            <!-- El contenido (imagen o iframe) se insertar√° aqu√≠ -->
            </div>
            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-3 z-10">
                <button id="download-image-viewer-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 flex items-center gap-2 shadow-lg">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    Descargar
                </button>
            </div>
            <button id="close-image-viewer-btn" class="absolute -top-3 -right-3 bg-white text-slate-800 rounded-full p-2 shadow-lg hover:bg-slate-200 z-10 cursor-pointer">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <!-- Modal para Galer√≠a Completa -->
    <div id="full-gallery-modal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[70] p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col">
            <!-- Cabecera -->
            <div class="p-4 border-b flex justify-between items-center flex-shrink-0">
                <h3 class="text-xl font-bold text-slate-800">Mi Galer√≠a de Creaciones</h3>
                <button id="close-full-gallery-modal-btn" class="p-2 rounded-full hover:bg-slate-100">
                    <i data-lucide="x" class="w-6 h-6 text-slate-600"></i>
                </button>
            </div>
            <!-- Cuerpo con scroll -->
            <div id="full-gallery-content" class="p-6 flex-grow overflow-y-auto">
                <!-- Las im√°genes se insertar√°n aqu√≠ -->
                <div class="text-center text-slate-500">Cargando galer√≠a...</div>
            </div>
        </div>
    </div>

    <!-- Modal Promos Inteligentes -->
    <div id="smart-promo-modal" class="hidden fixed inset-0 z-40 items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" data-modal-close></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-3xl mx-auto p-6 overflow-y-auto max-h-[90vh]">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-xs uppercase font-semibold text-slate-400">Promos Inteligentes</p>
                    <h3 id="smart-promo-modal-title" class="text-2xl font-bold text-slate-900">Nueva Promo</h3>
                </div>
                <button class="p-2 rounded-full hover:bg-slate-100" data-modal-close><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="smart-promo-form" class="grid gap-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <label class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                        T√≠tulo
                        <input id="smart-promo-title" type="text" class="form-input" placeholder="Ej. 2x1 en noviembre" required>
                    </label>
                    <label class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                        CTA sugerido
                        <input id="smart-promo-cta" type="text" class="form-input" placeholder="Agenda tu demo hoy">
                    </label>
                </div>
                <label class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                    Descripci√≥n breve
                    <textarea id="smart-promo-description" rows="3" class="form-input" placeholder="Describe la promo en 1 o 2 frases" required></textarea>
                </label>
                <label class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                    Beneficios / detalles (opcional)
                    <textarea id="smart-promo-benefits" rows="3" class="form-input" placeholder="Incluye condiciones, beneficios u objeciones"></textarea>
                </label>
                <div class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                    Im√°genes de la promoci√≥n
                    <div id="smart-promo-images-container" class="grid grid-cols-2 md:grid-cols-4 gap-3 min-h-[100px] p-3 border border-slate-200 rounded-lg bg-slate-50">
                        <!-- Las im√°genes se renderizar√°n aqu√≠ din√°micamente -->
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Haz clic en el √°rea de subida para agregar im√°genes. Tambi√©n puedes ingresar URLs manualmente:</p>
                    <input id="smart-promo-images" type="text" class="form-input text-xs" placeholder="O ingresa URLs separadas por comas: https://...">
                </div>
                <div class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                    Inserci√≥n autom√°tica
                    <label class="inline-flex items-center gap-2 text-sm font-normal text-slate-600">
                        <input id="smart-promo-auto" type="checkbox" class="form-checkbox h-5 w-5 text-blue-600" checked>
                        Permitir que la IA la inserte cuando conviene
                    </label>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <label class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                        Inicio
                        <input id="smart-promo-start" type="datetime-local" class="form-input">
                    </label>
                    <label class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                        Fin
                        <input id="smart-promo-end" type="datetime-local" class="form-input">
                    </label>
                </div>
                <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between border rounded-xl p-4">
                    <label class="inline-flex items-center gap-2 text-sm font-semibold text-slate-700">
                        <input id="smart-promo-no-schedule" type="checkbox" class="form-checkbox h-5 w-5 text-blue-600">
                        Sin horario definido
                    </label>
                    <label class="inline-flex items-center gap-2 text-sm font-semibold text-slate-700">
                        <input id="smart-promo-active" type="checkbox" class="form-checkbox h-5 w-5 text-blue-600" checked>
                        Activa inmediatamente
                    </label>
                    <label class="flex items-center gap-2 text-sm font-semibold text-slate-700">
                        M√°x. menciones/d√≠a
                        <input id="smart-promo-max-mentions" type="number" min="1" max="20" class="form-input w-24 text-right" value="3">
                    </label>
                </div>
                <div class="flex flex-col gap-2">
                    <button type="button" id="smart-promo-ai-btn" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-blue-200 text-blue-600 text-sm font-semibold hover:bg-blue-50 w-fit">
                        <i data-lucide="wand-2" class="w-4 h-4"></i> Mejorar con IA
                    </button>
                    <p class="text-xs text-slate-500">Usa el asistente de IA para reescribir la promo con tono comercial.</p>
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" class="px-4 py-2 rounded-lg border border-slate-200 text-sm font-semibold text-slate-600 hover:bg-slate-100" data-modal-close>Cancelar</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-semibold text-sm hover:bg-blue-700">Guardar Promo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- INICIO: Modal del Asistente de Configuraci√≥n -->
    <div id="wizard-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[90] p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
            <!-- Cabecera -->
            <div class="p-5 border-b flex justify-between items-center flex-shrink-0">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="wand-2" class="text-purple-500"></i>
                    Asistente de Configuraci√≥n de IA
                </h3>
                <button id="close-wizard-btn" class="p-2 rounded-full hover:bg-slate-100">
                    <i data-lucide="x" class="w-6 h-6 text-slate-600"></i>
                </button>
            </div>
            <!-- Contenido de los Pasos -->
            <div class="flex-grow overflow-y-auto p-8">
                <!-- Paso 1: Conectar WhatsApp -->
                <div id="wizard-step-1" class="wizard-step hidden">
                    <div class="text-center">
                        <h4 class="text-2xl font-bold mb-4">Paso 1: Conecta tu WhatsApp</h4>
                        <p class="text-slate-600 max-w-2xl mx-auto mb-6">Para que Elina pueda responder, primero necesita acceso a tu WhatsApp. Haz clic en "Solicitar QR" y escanea el c√≥digo con tu celular desde <strong>WhatsApp > Dispositivos Vinculados > Vincular un dispositivo</strong>.</p>
                        <div id="wizard-qr-container" class="bg-slate-100 rounded-lg p-4 min-h-[240px] flex items-center justify-center w-full max-w-sm mx-auto">
                            <!-- El QR o estado de conexi√≥n se mostrar√° aqu√≠ -->
                        </div>
                        <button id="wizard-request-qr-btn" class="mt-6 bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition">
                            Solicitar QR
                        </button>
                    </div>
                </div>

                <!-- Paso 2: Sincronizar Contactos -->
                <div id="wizard-step-2" class="wizard-step hidden">
                    <div class="text-center">
                        <h4 class="text-2xl font-bold mb-4">Paso 2: Sincroniza tus Contactos</h4>
                        <p class="text-slate-600 max-w-2xl mx-auto mb-6">Ahora, vamos a importar tus contactos de WhatsApp para que Elina los conozca. Presiona el bot√≥n "Sincronizar".</p>
                        <p class="text-slate-500 text-sm mb-8">(Este proceso puede tardar unos minutos. Puedes continuar con el siguiente paso mientras se completa).</p>
                        <button id="wizard-sync-contacts-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center justify-center gap-2 mx-auto">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i><span>Sincronizar</span>
                        </button>
                    </div>
                </div>

                <!-- Paso 3: Informaci√≥n de la Empresa -->
                <div id="wizard-step-3" class="wizard-step hidden">
                    <h4 class="text-2xl font-bold mb-2">Paso 3: Cu√©ntanos sobre tu Empresa</h4>
                    <p class="text-slate-500 mb-8">Esta informaci√≥n ayudar√° a Elina a entender el contexto de tu negocio. Puedes cambiarla m√°s tarde en "Configuraci√≥n".</p>
                    <form id="wizard-company-form" class="space-y-6">
                        <!-- Nombre de la Empresa -->
                        <div class="p-5 bg-slate-50 rounded-xl border">
                            <label class="font-semibold text-slate-800">Nombre de tu Empresa *</label>
                            <input type="text" id="wizard-company-name" placeholder="Ej: Mi Empresa S.A." class="form-input w-full mt-2" required>
                            <p class="text-xs text-slate-500 mt-1">Este nombre se usar√° en cotizaciones, mensajes y documentos oficiales</p>
                        </div>
                        <!-- Horario -->
                        <div class="p-5 bg-slate-50 rounded-xl border">
                            <label class="font-semibold text-slate-800">Horario de Atenci√≥n</label>
                            <div class="grid grid-cols-2 gap-4 mt-2">
                                <div><label class="text-sm">Apertura:</label><input type="time" id="wizard-work-start-hour" class="form-input w-full mt-1"></div>
                                <div><label class="text-sm">Cierre:</label><input type="time" id="wizard-work-end-hour" class="form-input w-full mt-1"></div>
                            </div>
                        </div>
                        <!-- Descripci√≥n -->
                        <div class="p-5 bg-slate-50 rounded-xl border">
                            <label class="font-semibold text-slate-800">Descripci√≥n de tu Negocio</label>
                            <textarea id="wizard-company-description" rows="3" class="form-input w-full mt-2" placeholder="Ej: Somos una agencia de marketing digital que ayuda a pymes a crecer. Nuestra misi√≥n es..."></textarea>
                        </div>
                        <!-- Tipo de Negocio -->
                        <div class="p-5 bg-slate-50 rounded-xl border">
                            <label class="font-semibold text-slate-800">Tipo de Negocio *</label>
                            <select id="wizard-business-type" class="form-input w-full mt-2" required>
                                <option value="both">Ambos (E-commerce y Servicios)</option>
                                <option value="ecommerce">E-commerce (Productos F√≠sicos)</option>
                                <option value="services">Servicios</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">Esta configuraci√≥n afecta c√≥mo Elina maneja productos y citas. Puedes cambiarla m√°s tarde en Configuraci√≥n.</p>
                        </div>
                        <!-- Contacto y Redes -->
                        <div class="p-5 bg-slate-50 rounded-xl border space-y-4">
                            <label class="font-semibold text-slate-800">Contacto y Redes Sociales</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-sm">Sitio Web:</label><input type="text" id="wizard-website" placeholder="tuempresa.com" class="form-input w-full mt-1"></div>
                                <!-- CORRECCI√ìN: Se quita el selector de pa√≠s para simplificar -->
                                <div>
                                    <label class="text-sm">N√∫mero al que te mandaremos notificaciones de tus clientes:</label>
                                    <p class="text-xs text-slate-500 mb-1">Elina te escribir√° cuando detecte situaciones que requieran tu atenci√≥n</p>
                                    <input type="tel" id="wizard-admin-phone-input" placeholder="+521234567890" class="form-input w-full mt-1">
                                </div>
                                <div><label class="text-sm">Instagram:</label><input type="text" id="wizard-social-instagram" placeholder="usuario_instagram" class="form-input w-full mt-1"></div>
                                <div><label class="text-sm">Facebook:</label><input type="text" id="wizard-social-facebook" placeholder="paginadefacebook" class="form-input w-full mt-1"></div>
                            </div>
                        </div>
                        <!-- Branding -->
                        <div class="p-5 bg-slate-50 rounded-xl border space-y-4">
                            <label class="font-semibold text-slate-800">Branding</label>
                            <div class="flex items-center gap-6">
                                <div><label class="text-sm">Logo:</label><div class="flex items-center gap-2 mt-1"><img id="wizard-logo-preview" src="https://placehold.co/100x100/e2e8f0/475569?text=Logo" class="w-16 h-16 rounded-lg object-contain bg-white p-1"><button type="button" id="wizard-upload-logo-btn" class="text-xs bg-slate-200 p-2 rounded">Cambiar</button><input type="file" id="wizard-logo-input" class="hidden" accept="image/*"></div></div>
                                <div><label class="text-sm">Colores de Marca:</label><div class="flex gap-2 mt-1"><input type="color" id="wizard-brand-color-1" value="#3b82f6" class="h-10 w-10 rounded-lg cursor-pointer"><input type="color" id="wizard-brand-color-2" value="#10b981" class="h-10 w-10 rounded-lg cursor-pointer"><input type="color" id="wizard-brand-color-3" value="#f97316" class="h-10 w-10 rounded-lg cursor-pointer"><input type="color" id="wizard-brand-color-4" value="#1e293b" class="h-10 w-10 rounded-lg cursor-pointer"></div></div>
                            </div>
                        </div>
                        <!-- Sistema de Citas -->
                        <div class="p-5 bg-slate-50 rounded-xl border space-y-4">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="wizard-appointments-enabled" class="h-4 w-4 rounded text-blue-600">
                                <label for="wizard-appointments-enabled" class="font-semibold text-slate-800">Activar Sistema de Citas</label>
                            </div>
                            <p class="text-xs text-slate-500">Cuando est√° activado, la IA detectar√° autom√°ticamente cuando los clientes quieren agendar citas y les ofrecer√° horarios disponibles.</p>
                            <div id="wizard-appointments-config" class="hidden space-y-3 mt-4">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-sm">Zona Horaria:</label>
                                        <select id="wizard-appointment-timezone" class="form-input w-full mt-1 text-sm">
                                            <option value="America/Mexico_City">Ciudad de M√©xico (GMT-6)</option>
                                            <option value="America/New_York">Nueva York (GMT-5)</option>
                                            <option value="America/Los_Angeles">Los √Ångeles (GMT-8)</option>
                                            <option value="America/Bogota">Bogot√° (GMT-5)</option>
                                            <option value="America/Argentina/Buenos_Aires">Buenos Aires (GMT-3)</option>
                                            <option value="America/Santiago">Santiago (GMT-3)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-sm">Duraci√≥n por Defecto (min):</label>
                                        <input type="number" id="wizard-appointment-default-duration" min="15" step="15" value="60" class="form-input w-full mt-1 text-sm">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium">Horarios de Atenci√≥n (Lunes a Viernes por defecto)</label>
                                    <p class="text-xs text-slate-500 mt-1">Puedes configurar horarios espec√≠ficos m√°s tarde en Configuraci√≥n</p>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Paso 3: Cuestionario IA -->
                <div id="wizard-step-4" class="wizard-step hidden">
                    <h4 class="text-2xl font-bold mb-2">Paso 4: ¬°Vamos a conocer tu negocio!</h4>
                    <p class="text-slate-500 mb-8">Responde estas preguntas para que Elina pueda actuar como una experta de tu empresa. Mientras m√°s detallado seas, mejor ser√° su desempe√±o.</p>
                    <form id="wizard-qa-form" class="space-y-6">
                        <div class="p-5 bg-slate-50 rounded-xl border border-slate-200">
                            <label class="font-semibold text-slate-800">1. ¬øCu√°l es el nombre de tu negocio y a qu√© se dedica principalmente?</label>
                            <textarea name="negocio" rows="2" class="form-input w-full mt-2" placeholder="Ej: 'Somos Brandcode, una agencia de marketing digital especializada en SEO y redes sociales.'"></textarea>
                        </div>
                        <div class="p-5 bg-slate-50 rounded-xl border border-slate-200">
                            <label class="font-semibold text-slate-800">2. ¬øQui√©n es tu cliente ideal?</label>
                            <textarea name="cliente" rows="2" class="form-input w-full mt-2" placeholder="Ej: 'Peque√±as y medianas empresas que quieren aumentar su visibilidad en l√≠nea.'"></textarea>
                        </div>
                        <div class="p-5 bg-slate-50 rounded-xl border border-slate-200">
                            <label class="font-semibold text-slate-800">3. ¬øQu√© problema principal le resuelves a ese cliente?</label>
                            <textarea name="problema" rows="2" class="form-input w-full mt-2" placeholder="Ej: 'Les ayudamos a conseguir m√°s clientes a trav√©s de internet.'"></textarea>
                        </div>
                        <div class="p-5 bg-slate-50 rounded-xl border border-slate-200">
                            <label class="font-semibold text-slate-800">4. ¬øQu√© te hace diferente de tu competencia?</label>
                            <textarea name="diferenciador" rows="2" class="form-input w-full mt-2" placeholder="Ej: 'Ofrecemos un servicio personalizado y reportes mensuales transparentes.'"></textarea>
                        </div>
                        <div class="p-5 bg-slate-50 rounded-xl border border-slate-200">
                            <label class="font-semibold text-slate-800">5. ¬øQu√© tono de comunicaci√≥n debe usar Elina? (Ej: amigable, formal, t√©cnico, divertido)</label>
                            <input type="text" name="tono" class="form-input w-full mt-2" placeholder="Ej: 'Amigable y servicial, pero profesional.'">
                        </div>
                        <div class="p-5 bg-slate-50 rounded-xl border border-slate-200">
                            <label class="font-semibold text-slate-800">6. ¬øHay algo que Elina NUNCA deba hacer o decir?</label>
                            <textarea name="no_hacer" rows="2" class="form-input w-full mt-2" placeholder="Ej: 'Nunca debe dar descuentos sin autorizaci√≥n. Nunca debe prometer resultados garantizados.'"></textarea>
                        </div>
                        <div class="p-5 bg-slate-50 rounded-xl border border-slate-200">
                            <label class="font-semibold text-slate-800">7. ¬øC√≥mo debe manejar las preguntas sobre precios?</label>
                            <textarea name="precios" rows="2" class="form-input w-full mt-2" placeholder="Ej: 'Debe decir que los precios var√≠an y preguntar sobre las necesidades del cliente para preparar una cotizaci√≥n.'"></textarea>
                        </div>
                        <div class="p-5 bg-slate-50 rounded-xl border border-slate-200">
                            <label class="font-semibold text-slate-800">8. ¬øQu√© informaci√≥n clave debe intentar obtener de un nuevo prospecto?</label>
                            <textarea name="info_prospecto" rows="2" class="form-input w-full mt-2" placeholder="Ej: 'Nombre, en qu√© servicio est√° interesado y cu√°l es su presupuesto aproximado.'"></textarea>
                        </div>
                         <div class="p-5 bg-slate-50 rounded-xl border border-slate-200">
                            <label class="font-semibold text-slate-800">9. ¬øHay alguna informaci√≥n adicional, promoci√≥n actual o dato importante que Elina deba conocer?</label>
                            <textarea name="info_adicional" rows="2" class="form-input w-full mt-2" placeholder="Ej: 'Este mes tenemos 20% de descuento en planes de redes sociales. El horario de atenci√≥n es de 9am a 6pm.'"></textarea>
                        </div>
                    </form>
                </div>

                <!-- Paso 4: Finalizaci√≥n -->
                <div id="wizard-step-5" class="wizard-step hidden text-center">
                    <div id="wizard-loading" class="flex flex-col items-center justify-center h-full">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600"></div>
                        <p class="text-slate-600 mt-4 font-semibold">Analizando tus respuestas y creando el prompt perfecto...</p>
                    </div>
                    <div id="wizard-success" class="hidden">
                        <i data-lucide="party-popper" class="w-20 h-20 text-green-500 mx-auto mb-4"></i>
                        <h4 class="text-2xl font-bold mb-2">¬°Todo Listo!</h4>
                        <p class="text-slate-600 max-w-2xl mx-auto">Hemos generado y guardado un prompt de IA optimizado para tu negocio. Ahora Elina est√° lista para empezar a trabajar. Puedes revisar y ajustar el prompt en cualquier momento en el panel principal.</p>
                    </div>
                </div>

            </div>
            <!-- Pie de p√°gina con botones -->
            <div class="p-5 bg-slate-50 border-t flex justify-between items-center flex-shrink-0">
                <button id="wizard-prev-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 disabled:opacity-50 disabled:cursor-not-allowed">Anterior</button>                
                <div id="wizard-step-indicator" class="text-sm font-semibold text-slate-500">Paso 1 de 4</div>
                <button id="wizard-next-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 w-40 text-center">Siguiente</button>
                <button id="wizard-finish-btn" class="hidden bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Finalizar y Generar Prompt</button>
            </div>
        </div>
    </div>
    <!-- FIN: Modal del Asistente de Configuraci√≥n -->

    <!-- Modal para Importar N√∫meros con Etiqueta -->
    <div id="import-numbers-label-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold text-slate-800">Importar N√∫meros con Etiqueta</h3>
                    <button id="close-import-numbers-modal" class="text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="block font-semibold text-slate-800 mb-2">1. Selecciona el archivo con los n√∫meros</label>
                    <p class="text-sm text-slate-600 mb-3">El archivo debe contener n√∫meros de tel√©fono. Formatos aceptados: TXT, CSV, XLSX, XLS</p>
                    <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50" id="numbers-file-drop-zone">
                        <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto text-slate-400 mb-2"></i>
                        <p class="text-slate-600">Arrastra un archivo o <span class="text-blue-600 font-semibold">haz clic para seleccionar</span></p>
                        <p class="text-xs text-slate-400 mt-1">TXT, CSV, XLSX, XLS (se extraer√°n los n√∫meros de todas las celdas)</p>
                        <input type="file" id="numbers-file-input" class="hidden" accept=".txt,.csv,.xlsx,.xls">
                    </div>
                    <div id="numbers-file-preview" class="hidden mt-4 p-3 bg-slate-100 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i data-lucide="file-check" class="text-green-500"></i>
                                <span id="numbers-file-name" class="text-sm font-medium"></span>
                                <span id="numbers-count" class="text-xs text-slate-500"></span>
                            </div>
                            <button type="button" id="remove-numbers-file" class="text-red-500 hover:bg-red-100 p-1 rounded-full">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block font-semibold text-slate-800 mb-2">2. Seleccionar o crear etiqueta</label>
                    <p class="text-sm text-slate-600 mb-3">Elige una etiqueta existente o crea una nueva. Todos los n√∫meros se asociar√°n con esta etiqueta. Si el contacto ya existe, se le agregar√° la etiqueta.</p>
                    
                    <!-- Selector de etiquetas existentes -->
                    <div class="mb-3">
                        <select id="label-select" class="form-input w-full">
                            <option value="">-- Selecciona una etiqueta existente --</option>
                            <option value="__new__">+ Crear nueva etiqueta</option>
                        </select>
                    </div>
                    
                    <!-- Input para crear nueva etiqueta (oculto por defecto) -->
                    <div id="new-label-input-container" class="hidden">
                        <input type="text" id="label-name-input" class="form-input w-full" placeholder="Ej: Clientes-23-24">
                    </div>
                </div>
                <div id="import-numbers-progress" class="hidden">
                    <div class="bg-slate-100 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span id="import-progress-text" class="text-sm font-medium text-slate-700">Procesando...</span>
                            <span id="import-progress-percent" class="text-sm text-slate-500">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2">
                            <div id="import-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div id="import-numbers-results" class="hidden">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="font-semibold text-green-800 mb-2">Resultados de la importaci√≥n:</h4>
                        <ul class="text-sm text-green-700 space-y-1">
                            <li id="result-new-contacts">‚Ä¢ Contactos nuevos: 0</li>
                            <li id="result-updated-contacts">‚Ä¢ Contactos actualizados: 0</li>
                            <li id="result-skipped-contacts">‚Ä¢ N√∫meros omitidos: 0</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-slate-200 flex justify-end gap-3">
                <button id="cancel-import-numbers" class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300">
                    Cancelar
                </button>
                <button id="confirm-import-numbers" class="bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    Importar N√∫meros
                </button>
            </div>
        </div>
    </div>
    <!-- FIN: Modal para Importar N√∫meros con Etiqueta -->

    <!-- INICIO: Modal para Iniciar Chat Nuevo -->
    <div id="new-chat-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[90] px-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
            <div class="p-6 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold text-slate-800">Iniciar Chat Nuevo</h3>
                    <button id="close-new-chat-modal" class="text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <!-- Opci√≥n: Contacto existente o nuevo -->
                <div>
                    <label class="block font-semibold text-slate-800 mb-2">Selecciona una opci√≥n</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                            <input type="radio" name="chat-option" value="existing" class="w-4 h-4 text-blue-600" checked>
                            <div>
                                <span class="font-medium text-slate-800">Contacto existente</span>
                                <p class="text-xs text-slate-500">Selecciona de tus contactos registrados</p>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                            <input type="radio" name="chat-option" value="new" class="w-4 h-4 text-blue-600">
                            <div>
                                <span class="font-medium text-slate-800">Contacto nuevo</span>
                                <p class="text-xs text-slate-500">Ingresa un n√∫mero de tel√©fono nuevo</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Selector de contacto existente -->
                <div id="existing-contact-container">
                    <label for="existing-contact-search" class="block font-semibold text-slate-800 mb-2">Buscar contacto</label>
                    <input type="text" id="existing-contact-search" class="form-input w-full" placeholder="Buscar por nombre o n√∫mero de tel√©fono..." autocomplete="off">
                    <input type="hidden" id="existing-contact-select" value="">
                    <div id="existing-contact-results" class="hidden mt-2 max-h-60 overflow-y-auto border border-slate-200 rounded-lg bg-white shadow-lg">
                        <!-- Los resultados de b√∫squeda se mostrar√°n aqu√≠ -->
                    </div>
                </div>

                <!-- Input para contacto nuevo -->
                <div id="new-contact-container" class="hidden">
                    <label for="new-contact-phone" class="block font-semibold text-slate-800 mb-2">N√∫mero de tel√©fono</label>
                    <input type="tel" id="new-contact-phone" class="form-input w-full" placeholder="Ej: +521234567890">
                    <p class="text-xs text-slate-500 mt-1">Ingresa el n√∫mero en formato internacional (ej: +521234567890)</p>
                    
                    <label for="new-contact-name" class="block font-semibold text-slate-800 mb-2 mt-4">Nombre (opcional)</label>
                    <input type="text" id="new-contact-name" class="form-input w-full" placeholder="Nombre del contacto">
                </div>
            </div>
            <div class="p-6 border-t border-slate-200 flex justify-end gap-3">
                <button id="cancel-new-chat" class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300">
                    Cancelar
                </button>
                <button id="confirm-new-chat" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    Iniciar Chat
                </button>
            </div>
        </div>
    </div>
    <!-- FIN: Modal para Iniciar Chat Nuevo -->

    <!-- Carga de Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

    <!-- Componente de Notificaci√≥n Toast (Global) -->
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-3 px-5 rounded-lg shadow-lg flex items-center gap-3 z-[100] transform translate-y-[150%] transition-transform duration-300 ease-in-out">
        <i id="toast-icon" data-lucide="check-circle" class="w-5 h-5"></i>
        <span id="toast-message"></span>
    </div>

    <!-- Sistema de Modales Personalizados (Reemplazo de alert/prompt/confirm) -->
    <!-- Modal de Confirmaci√≥n -->
    <div id="app-confirm-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-[200]" onclick="window.appModal?.closeConfirm?.()">
        <div class="bg-white w-full max-w-md m-4 p-6 rounded-xl shadow-2xl border border-slate-200" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h2 id="app-confirm-title" class="text-xl font-bold text-slate-800">Confirmar</h2>
                <button type="button" onclick="window.appModal?.closeConfirm?.()" class="text-slate-400 hover:text-slate-600 transition-colors" aria-label="Cerrar">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="mb-6">
                <p id="app-confirm-message" class="text-slate-600"></p>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="app-confirm-cancel" onclick="window.appModal?.closeConfirm?.()" class="px-4 py-2 bg-slate-200 text-slate-700 font-semibold rounded-md hover:bg-slate-300 transition-colors">
                    Cancelar
                </button>
                <button type="button" id="app-confirm-ok" onclick="window.appModal?.confirmOk?.()" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 transition-colors">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Prompt (Input) -->
    <div id="app-prompt-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-[200]" onclick="window.appModal?.closePrompt?.()">
        <div class="bg-white w-full max-w-md m-4 p-6 rounded-xl shadow-2xl border border-slate-200" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h2 id="app-prompt-title" class="text-xl font-bold text-slate-800">Ingresar</h2>
                <button type="button" onclick="window.appModal?.closePrompt?.()" class="text-slate-400 hover:text-slate-600 transition-colors" aria-label="Cerrar">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="mb-6">
                <p id="app-prompt-message" class="text-slate-600 mb-3"></p>
                <input type="text" id="app-prompt-input" class="w-full px-4 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Escribe aqu√≠...">
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="app-prompt-cancel" onclick="window.appModal?.closePrompt?.()" class="px-4 py-2 bg-slate-200 text-slate-700 font-semibold rounded-md hover:bg-slate-300 transition-colors">
                    Cancelar
                </button>
                <button type="button" id="app-prompt-ok" onclick="window.appModal?.promptOk?.()" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 transition-colors">
                    Aceptar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Selecci√≥n (Para confirm con opciones) -->
    <div id="app-select-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-[200]" onclick="window.appModal?.closeSelect?.()">
        <div class="bg-white w-full max-w-md m-4 p-6 rounded-xl shadow-2xl border border-slate-200" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h2 id="app-select-title" class="text-xl font-bold text-slate-800">Seleccionar</h2>
                <button type="button" onclick="window.appModal?.closeSelect?.()" class="text-slate-400 hover:text-slate-600 transition-colors" aria-label="Cerrar">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="mb-6">
                <p id="app-select-message" class="text-slate-600 mb-4"></p>
                <div id="app-select-options" class="space-y-2"></div>
            </div>
            <div class="flex justify-end">
                <button type="button" id="app-select-cancel" onclick="window.appModal?.closeSelect?.()" class="px-4 py-2 bg-slate-200 text-slate-700 font-semibold rounded-md hover:bg-slate-300 transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Script para sistema de modales -->
    <script>
        // Sistema de Modales Personalizados (Reemplazo de alert/prompt/confirm)
        window.appModal = {
            // Confirmaci√≥n (reemplaza confirm())
            confirm: function(message, title = 'Confirmar') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('app-confirm-modal');
                    const titleEl = document.getElementById('app-confirm-title');
                    const messageEl = document.getElementById('app-confirm-message');
                    const okBtn = document.getElementById('app-confirm-ok');
                    const cancelBtn = document.getElementById('app-confirm-cancel');

                    titleEl.textContent = title;
                    messageEl.textContent = message;
                    modal.classList.remove('hidden');

                    // Limpiar listeners anteriores
                    const newOkBtn = okBtn.cloneNode(true);
                    const newCancelBtn = cancelBtn.cloneNode(true);
                    okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                    newOkBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(true);
                    };
                    newCancelBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(false);
                    };

                    if (window.lucide?.createIcons) {
                        window.lucide.createIcons({ root: modal });
                    }
                });
            },

            closeConfirm: function() {
                const modal = document.getElementById('app-confirm-modal');
                modal.classList.add('hidden');
            },

            confirmOk: function() {
                const okBtn = document.getElementById('app-confirm-ok');
                okBtn.click();
            },

            // Prompt (reemplaza prompt())
            prompt: function(message, defaultValue = '', title = 'Ingresar') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('app-prompt-modal');
                    const titleEl = document.getElementById('app-prompt-title');
                    const messageEl = document.getElementById('app-prompt-message');
                    const inputEl = document.getElementById('app-prompt-input');
                    const okBtn = document.getElementById('app-prompt-ok');
                    const cancelBtn = document.getElementById('app-prompt-cancel');

                    titleEl.textContent = title;
                    messageEl.textContent = message;
                    inputEl.value = defaultValue;
                    modal.classList.remove('hidden');
                    inputEl.focus();
                    inputEl.select();

                    // Limpiar listeners anteriores
                    const newOkBtn = okBtn.cloneNode(true);
                    const newCancelBtn = cancelBtn.cloneNode(true);
                    okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                    const handleOk = () => {
                        const value = inputEl.value.trim();
                        modal.classList.add('hidden');
                        resolve(value || null);
                    };

                    const handleCancel = () => {
                        modal.classList.add('hidden');
                        resolve(null);
                    };

                    newOkBtn.onclick = handleOk;
                    newCancelBtn.onclick = handleCancel;

                    inputEl.onkeydown = (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleOk();
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            handleCancel();
                        }
                    };

                    if (window.lucide?.createIcons) {
                        window.lucide.createIcons({ root: modal });
                    }
                });
            },

            closePrompt: function() {
                const modal = document.getElementById('app-prompt-modal');
                modal.classList.add('hidden');
            },

            promptOk: function() {
                const okBtn = document.getElementById('app-prompt-ok');
                okBtn.click();
            },

            // Select (para confirm con opciones)
            select: function(message, options, title = 'Seleccionar') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('app-select-modal');
                    const titleEl = document.getElementById('app-select-title');
                    const messageEl = document.getElementById('app-select-message');
                    const optionsEl = document.getElementById('app-select-options');
                    const cancelBtn = document.getElementById('app-select-cancel');

                    titleEl.textContent = title;
                    messageEl.textContent = message;
                    optionsEl.innerHTML = '';

                    options.forEach((option, index) => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'w-full px-4 py-3 text-left bg-slate-50 hover:bg-green-50 border border-slate-200 rounded-md transition-colors font-medium text-slate-700';
                        btn.textContent = option.label || option;
                        btn.onclick = () => {
                            modal.classList.add('hidden');
                            resolve(option.value !== undefined ? option.value : option);
                        };
                        optionsEl.appendChild(btn);
                    });

                    modal.classList.remove('hidden');

                    const newCancelBtn = cancelBtn.cloneNode(true);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                    newCancelBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(null);
                    };

                    if (window.lucide?.createIcons) {
                        window.lucide.createIcons({ root: modal });
                    }
                });
            },

            closeSelect: function() {
                const modal = document.getElementById('app-select-modal');
                modal.classList.add('hidden');
            }
        };
    </script>

    <!-- Modal para Crear Cr√≠tico con IA -->
    <div id="critical-rule-ai-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold text-slate-800">Crear Cr√≠tico Personalizado</h3>
                    <button id="close-critical-rule-ai-modal" class="text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-6">
                <!-- Paso 1: Nombre del cr√≠tico -->
                <div>
                    <label class="block font-semibold text-slate-800 mb-2">1. Nombra tu Asunto cr√≠tico</label>
                    <input type="text" id="critical-rule-name-input" class="form-input w-full" placeholder="Ej: Consulta de env√≠o">
                </div>

                <!-- Paso 2: Descripci√≥n de qu√© detectar -->
                <div>
                    <label class="block font-semibold text-slate-800 mb-2">2. Cu√©ntame qu√© es lo que debemos detectar</label>
                    <textarea id="critical-rule-description-input" class="form-input w-full h-24 resize-none" placeholder="Ej: Quiero detectar cuando un cliente pregunta por el estado de su env√≠o o pedido, usando palabras como d√≥nde, env√≠o, pedido, paquete..."></textarea>
                    <p class="text-xs text-slate-500 mt-1">Describe en lenguaje natural qu√© tipo de mensajes quieres detectar</p>
                </div>

                <!-- Bot√≥n de optimizar por IA -->
                <div>
                    <button id="optimize-pattern-ai-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="sparkles" class="w-5 h-5"></i>
                        <span>Optimizar por IA</span>
                    </button>
                </div>

                <!-- Resultado de la IA -->
                <div id="ai-pattern-result-container" class="hidden space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-semibold text-blue-900 mb-2">La IA interpret√≥ que debe reconocer lo siguiente:</h4>
                        <p id="ai-pattern-explanation" class="text-sm text-blue-800 mb-3"></p>
                        <div class="bg-white border border-blue-300 rounded p-3">
                            <code id="ai-generated-pattern" class="text-sm text-slate-800 font-mono break-all"></code>
                        </div>
                    </div>

                    <!-- Campo editable para el patr√≥n -->
                    <div>
                        <label class="block font-semibold text-slate-800 mb-2">¬øQuisieras modificarle algo?</label>
                        <textarea id="critical-rule-pattern-input" class="form-input w-full h-20 resize-none font-mono text-sm" placeholder="Puedes editar el patr√≥n generado por la IA aqu√≠..."></textarea>
                        <p class="text-xs text-slate-500 mt-1">Puedes editar el patr√≥n si necesitas ajustarlo</p>
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="flex gap-3 pt-4 border-t border-slate-200">
                    <button id="cancel-critical-rule-ai" class="flex-1 py-2 px-4 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 font-semibold">
                        Cancelar
                    </button>
                    <button id="save-critical-rule-ai" class="flex-1 py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Guardar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Configuraci√≥n de Cotizaciones -->
        <div id="quote-settings-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex justify-between items-center">
                    <h3 class="text-2xl font-bold">Personalizar Cotizaciones PDF</h3>
                    <button id="close-quote-settings-btn" class="p-2 text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="p-6 space-y-6">
                    <!-- Mensaje informativo -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-blue-800">
                            <i data-lucide="info" class="w-4 h-4 inline-block mr-2"></i>
                            Los datos mostrados provienen de tu configuraci√≥n general. Puedes editarlos aqu√≠ o en Configuraci√≥n.
                        </p>
                    </div>
                    
                    <!-- Informaci√≥n de la Empresa -->
                    <div class="border-b border-slate-200 pb-6">
                        <h4 class="text-lg font-semibold mb-4">Informaci√≥n de la Empresa</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Nombre de la Empresa *</label>
                                <input type="text" id="quote-company-name" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Tipo de Empresa</label>
                                <select id="quote-company-type" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                                    <option value="individual">Persona Individual</option>
                                    <option value="business">Negocio</option>
                                    <option value="corporation">Corporaci√≥n</option>
                                    <option value="other">Otro</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Direcci√≥n</label>
                                <input type="text" id="quote-company-address" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Tel√©fono</label>
                                <input type="tel" id="quote-company-phone" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Email</label>
                                <input type="email" id="quote-company-email" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Sitio Web</label>
                                <input type="url" id="quote-company-website" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">RFC / ID Fiscal</label>
                                <input type="text" id="quote-tax-id" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Horarios de Atenci√≥n</label>
                                <input type="text" id="quote-business-hours" placeholder="Ej: Lunes a Viernes 9:00 - 18:00" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <!-- Logo -->
                    <div class="border-b border-slate-200 pb-6">
                        <h4 class="text-lg font-semibold mb-4">Logo de la Empresa</h4>
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <label class="block text-sm font-semibold text-slate-700 mb-2">URL del Logo</label>
                                <input type="url" id="quote-logo-url" placeholder="https://..." class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                                <p class="text-xs text-slate-500 mt-1">Sube tu logo a Bunny.net o usa una URL p√∫blica</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="quote-show-logo" checked class="w-5 h-5">
                                <label for="quote-show-logo" class="text-sm font-semibold text-slate-700">Mostrar Logo</label>
                            </div>
                        </div>
                        <div id="quote-logo-preview" class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
                            <p class="text-sm text-slate-600 mb-2">Vista Previa:</p>
                            <img id="quote-logo-preview-img" src="" alt="Logo preview" class="max-h-20">
                        </div>
                    </div>

                    <!-- Elementos a Mostrar -->
                    <div class="border-b border-slate-200 pb-6">
                        <h4 class="text-lg font-semibold mb-4">Elementos a Mostrar en el PDF</h4>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="quote-show-address" checked class="w-5 h-5">
                                <span class="text-sm">Direcci√≥n</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="quote-show-phone" checked class="w-5 h-5">
                                <span class="text-sm">Tel√©fono</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="quote-show-email" checked class="w-5 h-5">
                                <span class="text-sm">Email</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="quote-show-website" class="w-5 h-5">
                                <span class="text-sm">Sitio Web</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="quote-show-tax-id" class="w-5 h-5">
                                <span class="text-sm">RFC / ID Fiscal</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="quote-show-hours" checked class="w-5 h-5">
                                <span class="text-sm">Horarios</span>
                            </label>
                        </div>
                    </div>

                    <!-- Colores -->
                    <div class="border-b border-slate-200 pb-6">
                        <h4 class="text-lg font-semibold mb-4">Colores del PDF</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Color Principal</label>
                                <input type="color" id="quote-primary-color" value="#000000" class="w-full h-10 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Color Secundario</label>
                                <input type="color" id="quote-secondary-color" value="#666666" class="w-full h-10 border border-slate-300 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <!-- Pie de P√°gina -->
                    <div>
                        <h4 class="text-lg font-semibold mb-4">Pie de P√°gina Personalizado</h4>
                        <textarea id="quote-footer-text" rows="3" placeholder="Texto que aparecer√° en el pie de p√°gina del PDF..." class="w-full px-4 py-2 border border-slate-300 rounded-lg"></textarea>
                    </div>
                </div>

                <div class="sticky bottom-0 bg-white border-t border-slate-200 p-6 flex justify-end gap-3">
                    <button id="cancel-quote-settings-btn" class="px-4 py-2 text-slate-600 border border-slate-300 rounded-lg hover:bg-slate-50">
                        Cancelar
                    </button>
                    <button id="save-quote-settings-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Guardar Configuraci√≥n
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Cotizaci√≥n -->
        <div id="quote-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex justify-between items-center">
                    <h3 id="quote-modal-title" class="text-2xl font-bold">Nueva Cotizaci√≥n</h3>
                    <button id="cancel-quote-btn" class="p-2 text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="p-6 space-y-6">
                    <!-- Informaci√≥n del Contacto -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Contacto *</label>
                        <div class="relative">
                            <input type="text" id="quote-contact-search" 
                                   placeholder="Buscar contacto por nombre o tel√©fono..." 
                                   autocomplete="off"
                                   class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <input type="hidden" id="quote-contact-id" value="">
                            <div id="quote-contact-results" class="hidden absolute z-50 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                <!-- Los resultados se mostrar√°n aqu√≠ -->
                            </div>
                        </div>
                    </div>

                    <!-- Productos -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <label class="block text-sm font-semibold text-slate-700">Productos *</label>
                            <button onclick="addQuoteItem()" class="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                                Agregar Producto
                            </button>
                        </div>
                        <div id="quote-items-container" class="space-y-3">
                            <p class="text-slate-500 text-center py-4">No hay productos agregados</p>
                        </div>
                    </div>

                    <!-- Totales -->
                    <div class="bg-slate-50 p-4 rounded-lg space-y-2">
                        <div class="flex justify-between">
                            <span class="text-slate-600">Subtotal:</span>
                            <span id="quote-subtotal" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-600">Descuento:</span>
                            <div class="flex items-center gap-2">
                                <input type="number" id="quote-discount" min="0" max="100" step="0.01" value="0" 
                                       placeholder="%" 
                                       class="w-20 px-2 py-1 border border-slate-300 rounded text-sm">
                                <span class="text-slate-500 text-sm">%</span>
                                <span id="quote-discount-display" class="font-semibold text-red-600">-$0.00</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="text-slate-600">IVA/Impuestos:</span>
                                <label class="flex items-center gap-1 text-xs text-slate-500">
                                    <input type="checkbox" id="quote-prices-include-tax" class="w-4 h-4">
                                    <span>Precios incluyen IVA</span>
                                </label>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" id="quote-tax" min="0" max="100" step="0.01" value="16" 
                                       placeholder="%" 
                                       class="w-20 px-2 py-1 border border-slate-300 rounded text-sm">
                                <span class="text-slate-500 text-sm">%</span>
                                <span id="quote-tax-display" class="font-semibold">$0.00</span>
                            </div>
                        </div>
                        <div class="flex justify-between pt-2 border-t border-slate-300">
                            <span class="text-lg font-bold text-slate-800">Total:</span>
                            <span id="quote-total" class="text-lg font-bold text-green-600">$0.00</span>
                        </div>
                    </div>

                    <!-- Fecha de validez y notas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">V√°lido hasta</label>
                            <input type="date" id="quote-valid-until" 
                                   class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Estado</label>
                            <select id="quote-status" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                                <option value="draft">Borrador</option>
                                <option value="sent">Enviada</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Notas adicionales</label>
                        <textarea id="quote-notes" rows="3" 
                                  class="w-full px-4 py-2 border border-slate-300 rounded-lg"
                                  placeholder="Notas internas o informaci√≥n adicional..."></textarea>
                    </div>
                </div>

                <div class="sticky bottom-0 bg-white border-t border-slate-200 p-6 flex justify-end gap-3">
                    <button id="cancel-quote-btn-bottom" class="px-4 py-2 text-slate-600 border border-slate-300 rounded-lg hover:bg-slate-50">
                        Cancelar
                    </button>
                    <button id="create-quote-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Crear Cotizaci√≥n
                    </button>
                    <button id="save-quote-btn" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Nueva Cita Manual -->
    <div id="new-appointment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex items-center justify-between">
                <div>
                    <h3 class="text-xl font-bold">Nueva Cita</h3>
                    <p class="text-sm text-slate-500 mt-1">Agrega una cita manualmente a tu calendario</p>
                </div>
                <button id="close-new-appointment-modal-btn" class="p-2 text-slate-400 hover:text-slate-600 rounded-lg hover:bg-slate-100 transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="new-appointment-form" class="p-6 space-y-4">
                <div>
                    <label for="appointment-contact-select" class="block text-sm font-medium text-slate-700 mb-1">Contacto (Opcional)</label>
                    <select id="appointment-contact-select" class="form-input w-full text-sm">
                        <option value="">Sin contacto</option>
                    </select>
                </div>
                <div>
                    <label for="appointment-service-select" class="block text-sm font-medium text-slate-700 mb-1">Servicio (Opcional)</label>
                    <select id="appointment-service-select" class="form-input w-full text-sm">
                        <option value="">Sin servicio</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-1">Si seleccionas un servicio, la duraci√≥n se calcular√° autom√°ticamente</p>
                </div>
                <div>
                    <label for="appointment-title" class="block text-sm font-medium text-slate-700 mb-1">T√≠tulo de la Cita *</label>
                    <input type="text" id="appointment-title" required class="form-input w-full text-sm" placeholder="Ej: Consulta con Juan P√©rez">
                </div>
                <div>
                    <label for="appointment-start-date" class="block text-sm font-medium text-slate-700 mb-1">Fecha de la Cita *</label>
                    <div class="relative date-input-wrapper" id="appointment-date-wrapper">
                        <input type="date" id="appointment-start-date" required class="form-input w-full text-sm pr-10 relative z-10" style="color: transparent !important; cursor: pointer;">
                        <div id="appointment-date-display" class="absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none text-sm font-medium text-black z-20" style="color: #000000 !important;">
                            Selecciona una fecha
                        </div>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none z-20">
                            <i data-lucide="calendar" class="w-5 h-5 text-green-600"></i>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Selecciona una fecha para ver los horarios disponibles</p>
                </div>
                <div id="appointment-time-slots-container" class="hidden">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Horarios Disponibles *</label>
                    <div id="appointment-time-slots" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 max-h-60 overflow-y-auto p-2 border border-slate-200 rounded-lg">
                        <!-- Los slots se cargar√°n din√°micamente aqu√≠ -->
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Selecciona un horario disponible</p>
                </div>
                <div id="appointment-selected-time-info" class="hidden p-3 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-green-800">Horario seleccionado:</p>
                            <p class="text-sm text-green-700" id="appointment-selected-time-text"></p>
                        </div>
                        <button type="button" id="appointment-clear-time-btn" class="text-xs text-green-600 hover:text-green-800 underline">Cambiar</button>
                    </div>
                </div>
                <input type="hidden" id="appointment-start-time" value="">
                <input type="hidden" id="appointment-end-time" value="">
                <input type="hidden" id="appointment-end-date" value="">
                <div>
                    <label for="appointment-status" class="block text-sm font-medium text-slate-700 mb-1">Estado</label>
                    <select id="appointment-status" class="form-input w-full text-sm">
                        <option value="pending">Pendiente</option>
                        <option value="confirmed" selected>Confirmada</option>
                        <option value="completed">Completada</option>
                        <option value="cancelled">Cancelada</option>
                    </select>
                </div>
                <div>
                    <label for="appointment-notes" class="block text-sm font-medium text-slate-700 mb-1">Notas (Opcional)</label>
                    <textarea id="appointment-notes" rows="3" class="form-input w-full text-sm" placeholder="Notas adicionales sobre la cita..."></textarea>
                </div>
            </form>
            <div class="p-6 bg-slate-50 flex justify-end gap-3 rounded-b-lg border-t">
                <button id="cancel-appointment-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                <button id="save-appointment-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Guardar Cita</button>
            </div>
        </div>
    </div>

    <!-- Modal para Detalles/Edici√≥n de Cita -->
    <div id="appointment-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex items-center justify-between">
                <div>
                    <h3 class="text-xl font-bold">Detalles de la Cita</h3>
                    <p class="text-sm text-slate-500 mt-1">Ver y editar informaci√≥n de la cita</p>
                </div>
                <button id="close-appointment-details-modal-btn" class="p-2 text-slate-400 hover:text-slate-600 rounded-lg hover:bg-slate-100 transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="appointment-details-form" class="p-6 space-y-4">
                <input type="hidden" id="appointment-details-id">
                <div>
                    <label for="appointment-details-contact-select" class="block text-sm font-medium text-slate-700 mb-1">Contacto (Opcional)</label>
                    <select id="appointment-details-contact-select" class="form-input w-full text-sm">
                        <option value="">Sin contacto</option>
                    </select>
                </div>
                <div>
                    <label for="appointment-details-service-select" class="block text-sm font-medium text-slate-700 mb-1">Servicio (Opcional)</label>
                    <select id="appointment-details-service-select" class="form-input w-full text-sm">
                        <option value="">Sin servicio</option>
                    </select>
                </div>
                <div>
                    <label for="appointment-details-title" class="block text-sm font-medium text-slate-700 mb-1">T√≠tulo de la Cita *</label>
                    <input type="text" id="appointment-details-title" required class="form-input w-full text-sm" placeholder="Ej: Consulta con Juan P√©rez">
                </div>
                <div>
                    <label for="appointment-details-start-date" class="block text-sm font-medium text-slate-700 mb-1">Fecha de la Cita *</label>
                    <div class="relative date-input-wrapper" id="appointment-details-date-wrapper">
                        <input type="date" id="appointment-details-start-date" required class="form-input w-full text-sm pr-10 relative z-10" style="color: transparent !important; cursor: pointer;">
                        <div id="appointment-details-date-display" class="absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none text-sm font-medium text-black z-20" style="color: #000000 !important;">
                            Selecciona una fecha
                        </div>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none z-20">
                            <i data-lucide="calendar" class="w-5 h-5 text-green-600"></i>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Selecciona una fecha para ver los horarios disponibles</p>
                </div>
                <div id="appointment-details-time-slots-container" class="hidden">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Horarios Disponibles *</label>
                    <div id="appointment-details-time-slots" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 max-h-60 overflow-y-auto p-2 border border-slate-200 rounded-lg">
                        <!-- Los slots se cargar√°n din√°micamente aqu√≠ -->
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Selecciona un horario disponible</p>
                </div>
                <div id="appointment-details-selected-time-info" class="hidden p-3 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-green-800">Horario seleccionado:</p>
                            <p class="text-sm text-green-700" id="appointment-details-selected-time-text"></p>
                        </div>
                        <button type="button" id="appointment-details-clear-time-btn" class="text-xs text-green-600 hover:text-green-800 underline">Cambiar</button>
                    </div>
                </div>
                <input type="hidden" id="appointment-details-start-time" value="">
                <input type="hidden" id="appointment-details-end-time" value="">
                <input type="hidden" id="appointment-details-end-date" value="">
                <div>
                    <label for="appointment-details-status" class="block text-sm font-medium text-slate-700 mb-1">Estado</label>
                    <select id="appointment-details-status" class="form-input w-full text-sm">
                        <option value="pending">Pendiente</option>
                        <option value="confirmed">Confirmada</option>
                        <option value="completed">Completada</option>
                        <option value="cancelled">Cancelada</option>
                    </select>
                </div>
                <div>
                    <label for="appointment-details-notes" class="block text-sm font-medium text-slate-700 mb-1">Notas (Opcional)</label>
                    <textarea id="appointment-details-notes" rows="3" class="form-input w-full text-sm" placeholder="Notas adicionales sobre la cita..."></textarea>
                </div>
            </form>
            <div class="p-6 bg-slate-50 flex justify-between items-center rounded-b-lg border-t">
                <button id="delete-appointment-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 flex items-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    Eliminar
                </button>
                <div class="flex gap-3">
                    <button id="cancel-appointment-details-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                    <button id="save-appointment-details-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configuraci√≥n R√°pida de Citas -->
    <div id="appointments-quick-config-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                <div>
                    <h3 class="text-xl font-bold text-slate-800">Configuraci√≥n de Citas</h3>
                    <p class="text-sm text-slate-500 mt-1">Configura horarios, slots y opciones de citas</p>
                </div>
                <button id="close-appointments-config-modal-btn" class="p-2 rounded-full hover:bg-slate-100">
                    <i data-lucide="x" class="w-5 h-5 text-slate-600"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6">

                <!-- Horarios de Atenci√≥n -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-md font-semibold text-slate-800">Horarios de Atenci√≥n</h4>
                        <button id="refresh-hours-btn" class="text-xs bg-slate-100 text-slate-700 px-2 py-1 rounded hover:bg-slate-200 flex items-center gap-1">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i> Actualizar
                        </button>
                    </div>
                    <p class="text-xs text-slate-500 mb-3">Configura los horarios disponibles para cada d√≠a de la semana. Estos horarios se usan para calcular los slots disponibles.</p>
                    <div id="quick-config-hours-container" class="space-y-2">
                        <!-- Los horarios se cargar√°n din√°micamente aqu√≠ -->
                    </div>
                </div>

                <!-- Configuraci√≥n General -->
                <div class="border-t pt-4">
                    <h4 class="text-md font-semibold text-slate-800 mb-3">Configuraci√≥n General</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="quick-config-buffer-time" class="block text-sm font-medium text-slate-700 mb-1">Tiempo entre Citas (minutos)</label>
                            <input type="number" id="quick-config-buffer-time" min="0" step="5" class="form-input w-full text-sm">
                            <p class="text-xs text-slate-500 mt-1">Tiempo de espera entre citas consecutivas</p>
                        </div>
                        <div>
                            <label for="quick-config-max-per-day" class="block text-sm font-medium text-slate-700 mb-1">M√°ximo de Citas por D√≠a</label>
                            <input type="number" id="quick-config-max-per-day" min="1" placeholder="Sin l√≠mite" class="form-input w-full text-sm">
                            <p class="text-xs text-slate-500 mt-1">Deja vac√≠o para permitir citas ilimitadas</p>
                        </div>
                        <div>
                            <label for="quick-config-default-duration" class="block text-sm font-medium text-slate-700 mb-1">Duraci√≥n por Defecto (minutos)</label>
                            <input type="number" id="quick-config-default-duration" min="15" step="15" class="form-input w-full text-sm">
                            <p class="text-xs text-slate-500 mt-1">Duraci√≥n cuando no se especifica un servicio</p>
                        </div>
                        <div>
                            <label for="quick-config-timezone" class="block text-sm font-medium text-slate-700 mb-1">Zona Horaria</label>
                            <select id="quick-config-timezone" class="form-input w-full text-sm">
                                <option value="America/Mexico_City">Ciudad de M√©xico (GMT-6)</option>
                                <option value="America/New_York">Nueva York (GMT-5)</option>
                                <option value="America/Los_Angeles">Los √Ångeles (GMT-8)</option>
                                <option value="America/Bogota">Bogot√° (GMT-5)</option>
                                <option value="America/Argentina/Buenos_Aires">Buenos Aires (GMT-3)</option>
                                <option value="America/Santiago">Santiago (GMT-3)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Servicios Disponibles -->
                <div class="border-t pt-4">
                    <h4 class="text-md font-semibold text-slate-800 mb-3">Servicios Disponibles</h4>
                    <p class="text-xs text-slate-500 mb-3">Estos servicios se usan para calcular los slots. Puedes gestionarlos en el panel de Productos.</p>
                    <div id="quick-config-services-list" class="bg-slate-50 rounded-lg p-3 max-h-40 overflow-y-auto">
                        <!-- Los servicios se cargar√°n din√°micamente aqu√≠ -->
                    </div>
                </div>

                <!-- Acceso R√°pido -->
                <div class="border-t pt-4">
                    <h4 class="text-md font-semibold text-slate-800 mb-3">Acceso R√°pido</h4>
                    <div class="flex flex-wrap gap-2">
                        <button id="open-full-settings-btn" class="text-xs bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-slate-200 flex items-center gap-1.5">
                            <i data-lucide="settings" class="w-3.5 h-3.5"></i>
                            Configuraci√≥n Completa
                        </button>
                        <button id="open-products-btn" class="text-xs bg-blue-100 text-blue-700 px-3 py-2 rounded-lg hover:bg-blue-200 flex items-center gap-1.5">
                            <i data-lucide="boxes" class="w-3.5 h-3.5"></i>
                            Gestionar Servicios
                        </button>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-slate-50 flex justify-end gap-3 border-t flex-shrink-0">
                <button id="cancel-appointments-config-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                <button id="save-appointments-config-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Guardar Cambios</button>
            </div>
        </div>
    </div>
</body>
</html>
