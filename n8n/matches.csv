"LineNumber","Line"
"69","        ""jsonBody"": ""={\n  \""p_user_id\"": \""{{ $('Obtener Prompt y Configuraci?n1').item.json.user_id }}\"",\n  \""p_product_ids\"": {{ JSON.stringify($('Extraer IDs de Placeholders').item.json.product_ids) }}\n}"","
"84","        ""jsCode"": ""// --- NODO: Filtrar Productos por IDs ---\n// Este nodo ya no es necesario ya que la funci?n RPC retorna solo los productos solicitados\n// Pero lo mantenemos por compatibilidad y para asegurar que los IDs coincidan\n\nconst productos = $('Obtener Productos por IDs').all() || [];\nconst productIds = $('Extraer IDs de Placeholders').item.json.product_ids || [];\n\n// Si no hay IDs o no hay productos, retornar vac?o\nif (productIds.length === 0 || productos.length === 0) {\n  return [];\n}\n\n// Filtrar productos que coincidan con los IDs (doble verificaci?n)\nconst productosFiltrados = productos.filter(item => {\n  const p = item.json;\n  return p && p.id && productIds.includes(parseInt(p.id, 10));\n});\n\n// Retornar productos filtrados\nreturn productosFiltrados.length > 0 ? productosFiltrados : [];"""
"97","        ""jsCode"": ""// --- NODO: Reemplazar Placeholders de Productos ---\n// Este nodo reemplaza placeholders como [PRODUCT_NAME:53] con datos reales\n\nconst textoOriginal = $('Extraer IDs de Placeholders').item.json.output || \""\"";\nconst hasPlaceholders = $('Extraer IDs de Placeholders').item.json.has_placeholders;\n\n// Si no hay placeholders, retornar texto original sin cambios\nif (!hasPlaceholders) {\n  const inputItem = $('Extraer IDs de Placeholders').item;\n  const outputItem = { json: { output: textoOriginal } };\n  if (inputItem && inputItem.pairedItem) {\n    outputItem.pairedItem = inputItem.pairedItem;\n  }\n  return [outputItem];\n}\n\n// Obtener productos del nodo anterior (ya filtrados)\nlet productos = [];\ntry {\n  productos = $('Filtrar Productos por IDs').all() || [];\n} catch (e) {\n  // Si el nodo no existe o falla, continuar sin productos\n  productos = [];\n}\n\n// Si no hay productos encontrados, retornar texto original (con placeholders)\nif (productos.length === 0) {\n  const inputItem = $('Extraer IDs de Placeholders').item;\n  const outputItem = { json: { output: textoOriginal } };\n  if (inputItem && inputItem.pairedItem) {\n    outputItem.pairedItem = inputItem.pairedItem;\n  }\n  return [outputItem];\n}\n\n// Crear mapa de productos por ID\nconst productMap = {};\nproductos.forEach(item => {\n  const p = item.json;\n  if (!p || !p.id) return;\n  \n  const price = p.price ? parseFloat(p.price) : 0;\n  productMap[p.id] = {\n    name: p.product_name || 'Producto',\n    price: price > 0 ? '$' + price.toFixed(2) : 'Consultar precio',\n    url: p.media_url || '',\n    stock: p.stock !== null && p.stock !== undefined ? String(p.stock) : 'N/A',\n    desc: p.description || ''\n  };\n});\n\n// Extraer placeholders y reemplazarlos\nconst placeholderRegex = /\\[PRODUCT_(\\w+):(\\d+)\\]/g;\nconst matches = [...textoOriginal.matchAll(placeholderRegex)];\n\nlet textoFinal = textoOriginal;\nmatches.forEach(match => {\n  const [fullMatch, field, idStr] = match;\n  const productId = parseInt(idStr, 10);\n  const product = productMap[productId];\n  \n  if (!product) return;\n  \n  let replacement = '';\n  switch(field.toUpperCase()) {\n    case 'NAME': replacement = product.name; break;\n    case 'PRICE': replacement = product.price; break;\n    case 'URL': replacement = product.url; break;\n    case 'STOCK': replacement = product.stock; break;\n    case 'DESC': replacement = product.desc; break;\n    default: replacement = fullMatch;\n  }\n  \n  textoFinal = textoFinal.replace(fullMatch, replacement);\n});\n\n// Calcular y reemplazar $[TOTAL_CALCULATED] o $[TOTAL_CALCULADO]\n// Buscar patrones de productos con cantidades y calcular totales\nconst totalPlaceholderRegex = /\\$\\[TOTAL_CALCULATED\\]|\\$\\[TOTAL_CALCULADO\\]/gi;\nif (totalPlaceholderRegex.test(textoFinal)) {\n  let totalSinIVA = 0;\n  \n  // Buscar l?neas con \""Subtotal:\"" para extraer valores\n  const subtotalRegex = /Subtotal:\\s*\\$([\\d,]+(?:\\.\\d{2})?)/g;\n  const subtotalMatches = [...textoFinal.matchAll(subtotalRegex)];\n  \n  subtotalMatches.forEach(match => {\n    const subtotalStr = match[1].replace(/,/g, '');\n    const subtotal = parseFloat(subtotalStr);\n    if (!isNaN(subtotal)) {\n      totalSinIVA += subtotal;\n    }\n  });\n  \n  // Si no encontr? subtotales, intentar calcular desde productos y cantidades\n  if (totalSinIVA === 0) {\n    // Buscar patrones: precio ? cantidad o cantidad piezas\n    const productLines = textoFinal.match(/\\$([\\d,]+(?:\\.\\d{2})?)\\s*c\\/u[\\s\\S]*?(\\d+)\\s*piezas?/gi);\n    if (productLines) {\n      productLines.forEach(line => {\n        const priceMatch = line.match(/\\$([\\d,]+(?:\\.\\d{2})?)/);\n        const qtyMatch = line.match(/(\\d+)\\s*piezas?/i);\n        if (priceMatch && qtyMatch) {\n          const price = parseFloat(priceMatch[1].replace(/,/g, ''));\n          const qty = parseInt(qtyMatch[1], 10);\n          if (!isNaN(price) && !isNaN(qty)) {\n            totalSinIVA += price * qty;\n          }\n        }\n      });\n    }\n  }\n  \n  // Formatear total con comas para miles\n  const totalFormateado = totalSinIVA > 0 ? totalSinIVA.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00';\n  \n  // Reemplazar todos los placeholders de total\n  textoFinal = textoFinal.replace(totalPlaceholderRegex, '$' + totalFormateado);\n}\n\n// Preservar pairedItem del input para mantener la referencia\nconst inputItem = $('Extraer IDs de Placeholders').item;\nconst outputItem = { json: { output: textoFinal } };\n\nif (inputItem && inputItem.pairedItem) {\n  outputItem.pairedItem = inputItem.pairedItem;\n}\n\nreturn [outputItem];"""
"110","        ""jsCode"": ""// --- NODO: Detectar si es Cotizaci?n ---\n// Detecta si se debe generar un PDF de cotizaci?n\n// L?GICA ESTRICTA: Solo genera cotizaci?n cuando es cierre de venta expl?cito con 3+ productos\n\nconst texto = $('Reemplazar Placeholders').item.json.output || \""\"";\nconst productIds = $('Extraer IDs de Placeholders').item.json.product_ids || [];\nconst productCount = productIds.length;\n\n// Palabras clave de cierre de venta (muy espec?ficas - debe ser acci?n de compra)\nconst cierreVentaKeywords = /(?:quiero|deseo|necesito|me interesa|vamos|procedo|acepto|confirmo|comprar|adquirir|tomar|llevar|s?|ok|perfecto|de acuerdo|hag?moslo|avancemos|cerrar|finalizar|hacer pedido|realizar pedido|confirmar pedido|proceder con|avanzar con)[\\s\\S]{0,80}(?:comprar|adquirir|tomar|llevar|pedido|orden|venta|transacci?n|compra|pago)/i;\nconst esCierreVenta = cierreVentaKeywords.test(texto);\n\n// Palabras clave expl?citas de cotizaci?n (debe pedir documento formal)\nconst cotizacionExplicita = /(?:cotizaci[o?]n|presupuesto|quote|propuesta|oferta)[\\s\\S]{0,40}(?:formal|pdf|documento|escrita|detallada|por escrito|en pdf|en documento)/i;\nconst hasCotizacionExplicita = cotizacionExplicita.test(texto);\n\n// REGLAS ESTRICTAS:\n// 1. Si solo hay 1 producto ? SIEMPRE mensaje (nunca cotizaci?n)\n// 2. Si hay 2 productos ? Solo si es cierre de venta MUY expl?cito Y pide cotizaci?n\n// 3. Si hay 3+ productos ? Solo si es cierre de venta expl?cito O pide cotizaci?n expl?cita\n\nlet shouldGenerateQuote = false;\n\nif (productCount === 0) {\n  // Sin productos, nunca cotizaci?n\n  shouldGenerateQuote = false;\n} else if (productCount === 1) {\n  // 1 producto ? SIEMPRE mensaje, nunca cotizaci?n\n  shouldGenerateQuote = false;\n} else if (productCount === 2) {\n  // 2 productos ? Solo si es cierre de venta MUY expl?cito Y pide cotizaci?n expl?cita\n  // Debe cumplir AMBAS condiciones\n  shouldGenerateQuote = esCierreVenta && hasCotizacionExplicita;\n} else {\n  // 3+ productos ? Solo si es cierre de venta expl?cito O pide cotizaci?n expl?cita\n  // Con 3+ productos es m?s probable que sea cierre de venta\n  shouldGenerateQuote = esCierreVenta || hasCotizacionExplicita;\n}\n\n// Obtener productos para preparar datos de cotizaci?n\nlet productos = [];\ntry {\n  productos = $('Filtrar Productos por IDs').all() || [];\n} catch (e) {\n  productos = [];\n}\n\n// Preparar items para la cotizaci?n\n// Intentar extraer cantidades del texto\nconst quantityPatterns = [\n  /(?:cantidad|qty|qty\\.|cant\\.|unidades?|uds?|pcs?|piezas?)[: ]*\\s*(\\d+)/gi,\n  /(\\d+)\\s*(?:unidades?|uds?|pcs?|piezas?|cantidad)/gi,\n  /x\\s*(\\d+)/gi,\n  /\\*\\s*(\\d+)/gi\n];\n\nconst extractQuantity = (productId, productName) => {\n  // Buscar patrones de cantidad en el texto\n  for (const pattern of quantityPatterns) {\n    const matches = [...texto.matchAll(pattern)];\n    if (matches.length > 0) {\n      // Si hay un match cerca del nombre del producto, usar esa cantidad\n      const productNameLower = productName.toLowerCase();\n      for (const match of matches) {\n        const matchIndex = match.index;\n        const context = texto.substring(Math.max(0, matchIndex - 50), Math.min(texto.length, matchIndex + 50)).toLowerCase();\n        if (context.includes(productNameLower) || context.includes(`id:${productId}`) || context.includes(`[${productId}]`)) {\n          return parseInt(match[1], 10) || 1;\n        }\n      }\n      // Si no hay contexto espec?fico, usar el primer n?mero encontrado\n      return parseInt(matches[0][1], 10) || 1;\n    }\n  }\n  return 1; // Por defecto 1\n};\n\nconst quoteItems = productos.map(item => {\n  const p = item.json;\n  const price = p.price ? parseFloat(p.price) : 0;\n  const quantity = extractQuantity(p.id, p.product_name || '');\n  \n  return {\n    product_id: parseInt(p.id, 10),\n    product_name: p.product_name || 'Producto',\n    quantity: quantity,\n    price: price,\n    subtotal: price * quantity,\n    image_url: p.media_url || undefined,\n    description: p.description || undefined\n  };\n});\n\n// Preservar pairedItem\nconst inputItem = $('Reemplazar Placeholders').item;\nconst outputItem = {\n  json: {\n    output: texto,\n    should_generate_quote: shouldGenerateQuote,\n    quote_items: quoteItems,\n    product_count: productIds.length\n  }\n};\n\nif (inputItem && inputItem.pairedItem) {\n  outputItem.pairedItem = inputItem.pairedItem;\n}\n\nreturn [outputItem];"""
"178","        ""jsonBody"": ""={\n  \""user_id\"": \""{{ $('Obtener Prompt y Configuraci?n1').item.json.user_id }}\"",\n  \""contact_id\"": {{ $('buscar contacto1').item.json.id }},\n  \""items\"": {{ JSON.stringify($('Detectar si es Cotizaci?n').item.json.quote_items) }},\n  \""valid_until\"": null,\n  \""notes\"": \""Cotizaci?n generada autom?ticamente desde WhatsApp\""\n}"","
"193","        ""jsCode"": ""// --- NODO: Preparar datos despu?s de crear cotizaci?n ---\n// Este nodo asegura que el texto original pase al siguiente nodo\n\nconst quoteResponse = $input.first().json;\nconst textoOriginal = $('Detectar si es Cotizaci?n').item.json.output || \""\"";\n\n// Preparar mensaje de confirmaci?n\nconst mensajeConfirmacion = `?? Cotizaci?n ${quoteResponse.quote?.quote_id || 'generada'} creada exitosamente. Total: $${(quoteResponse.quote?.total || 0).toFixed(2)}`;\n\n// Retornar el texto original para que contin?e el flujo normal\n// O un mensaje de confirmaci?n si se prefiere\nreturn [{\n  json: {\n    output: mensajeConfirmacion + \""\\n\\n\"" + textoOriginal,\n    quote_id: quoteResponse.quote?.quote_id,\n    quote_url: quoteResponse.quote?.pdf_url\n  },\n  pairedItem: $input.first().pairedItem\n}];"""
"208","        ""instanceName"": ""={{ $('Set Fields1').item.json.instance.name }}"","
"210","        ""media"": ""={{ $('Preparar despu?s de Cotizaci?n').item.json.quote_url || $json.quote?.pdf_url }}"","
"211","        ""caption"": ""={{ '?? Cotizaci?n ' + ($('Preparar despu?s de Cotizaci?n').item.json.quote_id || $json.quote?.quote_id || 'N/A') + ' generada. Total: $' + ($json.quote?.total || 0).toFixed(2) }}"","
"269","              ""value"": ""={{ $('DivideporType1').item.json.message.timestamp }}"","
"275","              ""value"": ""={{ $('Set Fields1').item.json.message.content }}"","
"304","              ""value"": ""={{ $('DivideporType1').item.json.timestamp }}"","
"333","              ""value"": ""={{ $('Merge3').item.json['descripcion de la imagen'] }}"","
"433","          ""systemMessage"": ""=Eres ELINA ??, asistente de ventas experta.\\nTu OBJETIVO: Vender, agendar citas y resolver dudas de productos.\\n\\n### ?? REGLAS DE ORO (SEGURIDAD) ??\\n1. **NO INVENTES NADA:** Jam?s inventes precios, stock, tel?fonos o direcciones. Si no sabes, di \""No tengo ese dato a la mano\"".\\n2. **USO DE HERRAMIENTAS:** Si el usuario menciona un producto (ej: \""toner\"", \""m477\"", \""cartucho\""), DEBES usar la herramienta `ver productos` para buscarlo.\\n3. **FORMATO DE PRECIOS:** NUNCA escribas precios (\""$500\"") directamente. Usa SIEMPRE los placeholders que te da la herramienta: `[PRODUCT_PRICE:ID]`, `[PRODUCT_STOCK:ID]`.\\n   - Correcto: \""El precio es $[PRODUCT_PRICE:123]\""\\n   - Incorrecto: \""El precio es $1,200\"" (Ser?s bloqueada si haces esto)\\n4. **COTIZACIONES:** No calcules totales. Solo lista los productos con sus placeholders. El sistema calcular? el total.\\n\\n**CONTEXTO DEL NEGOCIO (Personalizado):**\\n{{ $('Obtener Prompt y Configuraci?n1').item.json.prompt_content }}\\n\\n**INFORMACI?N DE LA EMPRESA (SOLO DATOS DISPONIBLES):**\\n{{ $('Obtener Perfil de Usuario1').item.json.website ? '- Sitio Web: ' + $('Obtener Perfil de Usuario1').item.json.website + '\\n' : '' }}{{ $('Obtener Perfil de Usuario1').item.json.social_media?.instagram ? '- Instagram: ' + $('Obtener Perfil de Usuario1').item.json.social_media.instagram + '\\n' : '' }}{{ $('Obtener Perfil de Usuario1').item.json.social_media?.facebook ? '- Facebook: ' + $('Obtener Perfil de Usuario1').item.json.social_media.facebook + '\\n' : '' }}{{ $('Obtener Perfil de Usuario1').item.json.company_description ? '- Descripci?n: ' + $('Obtener Perfil de Usuario1').item.json.company_description + '\\n' : '' }}{{ $('Obtener Perfil de Usuario1').item.json.work_start_hour && $('Obtener Perfil de Usuario1').item.json.work_end_hour ? '- Horario de atenci?n: ' + $('Obtener Perfil de Usuario1').item.json.work_start_hour + 'hrs a ' + $('Obtener Perfil de Usuario1').item.json.work_end_hour + 'hrs\\n' : '' }}{{ $('Obtener Perfil de Usuario1').item.json.business_address ? '- Direcci?n: ' + $('Obtener Perfil de Usuario1').item.json.business_address + '\\n' : '' }}{{ $('Obtener Perfil de Usuario1').item.json.business_phone ? '- Tel?fono: ' + $('Obtener Perfil de Usuario1').item.json.business_phone + '\\n' : '' }}{{ $('Obtener Perfil de Usuario1').item.json.pickup_location ? '- Ubicaci?n de recogida: ' + $('Obtener Perfil de Usuario1').item.json.pickup_location + '\\n' : '' }}\\n\\n### ?? PERSONALIDAD\\n- Breve, amable y profesional.\\n- Usa emojis moderadamente (?, ??, ??).\\n- Orientada a la acci?n."""
"462","        ""instanceName"": ""={{ $('Set Fields1').item.json.instance.name }}"","
"464","        ""messageText"": ""={{ $('Definir destinatario1').item.json['mensaje texto '] }}"","
"491","        ""instanceName"": ""={{ $('Set Fields1').item.json.instance.name }}"","
"493","        ""media"": ""={{ $('Definir destinatario1').item.json.url_imagen }}"","
"494","        ""caption"": ""={{ $('Definir destinatario1').item.json['mensaje texto '] }}"","
"518","        ""instanceName"": ""={{ $('Set Fields1').item.json.instance.name }}"","
"520","        ""media"": ""={{ $('Definir destinatario1').item.json.urlVideo }}"","
"521","        ""caption"": ""={{ $('Definir destinatario1').item.json['mensaje texto '] }}"","
"546","              ""value"": ""={{$('Webhook1').item.json.body.data.key.remoteJid.replace('@s.whatsapp.net', '') }}"","
"552","              ""value"": ""={{ $('Separar imagen o video del texto o audio1').item.json.mensaje_texto }}"","
"558","              ""value"": ""={{ $('Separar imagen o video del texto o audio1').item.json.url_imagen.trim() }}"","
"564","              ""value"": ""={{ $('Separar imagen o video del texto o audio1').item.json.url_video }}"","
"570","              ""value"": ""={{ $('Merge5').item.json.id }}"","
"672","                    ""leftValue"": ""={{ $('Webhook1').item.json.body.data.messageType }}"","
"697","                    ""leftValue"": ""={{ $('Json parse1').item.json.content_type }}"","
"721","                    ""leftValue"": ""={{ ($('Definir destinatario1').item.json.url_imagen || '').toString().trim() }}"","
"746","                    ""leftValue"": ""={{ ($('Definir destinatario1').item.json.urlVideo || '').toString().trim() }}"","
"770","                    ""leftValue"": ""={{ $('Definir destinatario1').item.json['mensaje texto '] }}"","
"780","                    ""leftValue"": ""={{ ($('Definir destinatario1').item.json.url_imagen || '').toString().trim() }}"","
"790","                    ""leftValue"": ""={{ ($('Definir destinatario1').item.json.urlVideo || '').toString().trim() }}"","
"825","        ""url"": ""=https://mytvwfbijlgbihlegmfg.supabase.co/storage/v1/object/audiostemp/audio_{{ $('que escribir como audio1').item.json.now }}"","
"890","        ""instanceName"": ""={{ $('Set Fields1').item.json.instance.name }}"","
"892","        ""media"": ""=https://mytvwfbijlgbihlegmfg.supabase.co/storage/v1/object/public/audiostemp/audio_{{ $('que escribir como audio1').item.json.now }}"","
"1040","              ""fieldValue"": ""={{ $('Get a row1').item.json.id }}"""
"1044","              ""fieldValue"": ""={{ $('Definir destinatario1').item.json.id }}"""
"1052","              ""fieldValue"": ""={{ $('set text1').item.json.text }}"""
"1083","              ""fieldValue"": ""={{ $('Get a row1').item.json.id }}"""
"1091","              ""fieldValue"": ""={{ $('AI Agent').item.json.output }}"""
"1099","              ""fieldValue"": ""={{ $('Definir destinatario1').item.json.id }}"""
"1133","        ""url"": ""={{ $('Set Fields1').item.json.instance['server_url '] }}/chat/getBase64FromMediaMessage/{{ $('Set Fields1').item.json.instance.name }}"","
"1139","              ""value"": ""={{ $('Set Fields1').item.json.instance.apikey }}"""
"1148","              ""value"": ""={{ $('Set Fields1').item.json.message.MessageBodyData_id }}"""
"1192","        ""url"": ""={{ $('Set Fields1').item.json.instance['server_url '] }}/chat/getBase64FromMediaMessage/{{ $('Set Fields1').item.json.instance.name }}"","
"1198","              ""value"": ""={{ $('Set Fields1').item.json.instance.apikey }}"""
"1207","              ""value"": ""={{ $('Set Fields1').item.json.message.MessageBodyData_id }}"""
"1250","        ""instanceName"": ""={{ $('Set Fields1').item.json.instance.name }}"","
"1251","        ""remoteJid"": ""={{ $('Webhook1').item.json.body.data.key.remoteJid.replace('@s.whatsapp.net', '') }}"","
"1276","        ""list"": ""={{ $('Set Fields1').item.json.message.chat_id }}_buffer"","
"1277","        ""messageData"": ""={{ JSON.stringify($('Set Fields1').item.json.message) }}"","
"1299","        ""key"": ""={{ $('Set Fields1').item.json.message.chat_id }}_buffer"","
"1332","                    ""rightValue"": ""={{ $('Set Fields1').item.json.message.chat_id }}"","
"1422","              ""value"": ""={{  $('Webhook1').item.json.body.data.message.extendedTextMessage ? 'text' : '' }}{{  $('Webhook1').item.json.body.data.message.conversation ? 'text' : '' }}{{  $('Webhook1').item.json.body.data.message.audioMessage ? 'audio' : '' }}{{  $('Webhook1').item.json.body.data.message.imageMessage ? 'image' : '' }}"","
"1428","              ""value"": ""={{  $('Webhook1').item.json.body.data.message.extendedTextMessage?.text || '' }}{{  $('Webhook1').item.json.body.data.message.imageMessage?.caption || '' }}{{  $('Webhook1').item.json.body.data.message.conversation || '' }}"","
"1440","              ""value"": ""={{ $('Webhook1').item.json.body.data.pushName }}"","
"1484","        ""key"": ""={{ $('Set Fields1').item.json.message.chat_id }}_buffer"""
"1680","        ""jsonBody"": ""={\n       \""text\"": \""{{ $('human1').item.json.content }}\"",\n       \""model\"": \""text-embedding-3-small\""\n}"","
"1704","              ""keyValue"": ""={{ $('human1').item.json.id }}"""
"1712","              ""fieldValue"": ""={{ (() => { const emb = $('1b. Obtener Embedding Humano1').item.json.embedding; if (!emb || !Array.isArray(emb) || emb.length === 0) return null; const nums = emb.filter(v => typeof v === 'number' && !isNaN(v) && isFinite(v)); if (nums.length !== emb.length || nums.length === 0) return null; return '[' + nums.join(',') + ']'; })() }}"""
"1755","        ""jsonBody"": ""={\n       \""text\"": {{ JSON.stringify($('AI1').item.json.content.replace(/\\\\[AUDIO\\\\]:?|\\n/gi, ' ').trim()) }},\n       \""model\"": \""text-embedding-3-small\""\n }"","
"1778","              ""keyValue"": ""={{ $('AI1').item.json.id }}"""
"1786","              ""fieldValue"": ""={{ (() => { const emb = $('2b. Obtener Embedding IA1').item.json.embedding; if (!emb || !Array.isArray(emb) || emb.length === 0) return null; const nums = emb.filter(v => typeof v === 'number' && !isNaN(v) && isFinite(v)); if (nums.length !== emb.length || nums.length === 0) return null; return '[' + nums.join(',') + ']'; })() }}"""
"2063","              ""keyValue"": ""=+{{ ($('Webhook1').item.json.body.data.key.remoteJid.includes('@lid') ? $('Webhook1').item.json.body.data.key.remoteJidAlt : $('Webhook1').item.json.body.data.key.remoteJid).replace('@s.whatsapp.net', '').replace('@lid', '') }}"""
"2125","              ""fieldValue"": ""={{ $('Webhook1').item.json.body.data.message.conversation }}"""
"2129","              ""fieldValue"": ""={{ new Date(new Date($('Webhook1').item.json.body.date_time).getTime() - 3 * 60 * 60 * 1000).toISOString() }}"""
"2151","        ""jsCode"": ""const userId = $('Get a row3').item.json.id;\nconst b64 = $('Get imagen1').item.json.base64;\n\n// Preparamos el cuerpo de la petici?n para la Edge Function\nconst body = {\n  userId: userId,\n  b64_json: b64,\n  subfolder: 'chat-files' // Guardamos en una carpeta espec?fica para chats\n};\n\n// Devolvemos el cuerpo para el siguiente nodo (HTTP Request)\nreturn { json: body };\n"""
"2196","              ""keyValue"": ""={{ $('Set Fields1').item.json.instance.name }}"""
"2200","              ""keyValue"": ""={{ $('Set Fields1').item.json.instance.apikey }}"""
"2222","        ""jsCode"": ""const caption = $('Set Fields1').item.json.message.content || '';\nconst cdnUrl = $('Subir a Bunny1').item.json.cdnUrl || '';\n\n// Unimos el caption y la URL para guardarlo como el contenido del mensaje\nconst finalContent = `${caption} ${cdnUrl}`.trim();\n\n// Devolvemos el contenido final y la descripci?n para el siguiente paso\nreturn {\n  json: {\n    content: finalContent,\n    'descripcion de la imagen': $('Describir Imagen1').item.json.content,\n    timestamp: $('Set Fields1').item.json.message.timestamp\n  }\n};\n"""
"2252","              ""value"": ""={{ $('Webhook1').item.json.body.data.key.remoteJid.replace('@s.whatsapp.net', '') }}"","
"2287","              ""value"": ""={{ $('Reemplazar Placeholders').item.json.output }}"","
"2418","              ""keyValue"": ""={{ $('Get a row1').item.json.id }}"""
"2455","        ""remoteJid"": ""={{ $('Obtener N?mero Notificaci?n1').item.json.contact_phone.replace('+', '').replace('@s.whatsapp.net', '') }}"","
"2456","        ""messageText"": ""={{ $('Preparar Mensaje Notificaci?n Cr?tica').item.json.mensaje_completo }}"","
"2632","        ""jsonBody"": ""={\n  \""user_id\"": \""{{ $('Get a row1').item.json.id }}\"",\n  \""date\"": \""{{ $now.toFormat('yyyy-MM-dd') }}\"",\n  \""duration_minutes\"": null\n}"","
"2672","              ""keyValue"": ""={{ $('Get Subscription1').item.json.user_id }}"""
"2703","              ""keyValue"": ""={{ $('Preparar Labels con Ignorar1').item.json.phone_number }}"""
"2716","              ""fieldValue"": ""={{ $('Preparar Labels con Ignorar1').item.json.labels }}"""
"2738","        ""jsCode"": ""// Obtener las labels actuales del contacto\nconst currentLabels = $('Merge5').item.json.labels || [];\n\n// Convertir a array si es string o null\nlet labelsArray = [];\nif (Array.isArray(currentLabels)) {\n  labelsArray = [...currentLabels];\n} else if (typeof currentLabels === 'string') {\n  try {\n    labelsArray = JSON.parse(currentLabels);\n  } catch (e) {\n    labelsArray = currentLabels.split(',').map(l => l.trim()).filter(Boolean);\n  }\n}\n\n// Verificar si \""ignorar\"" ya existe (case-insensitive)\nconst hasIgnore = labelsArray.some(label => \n  label && label.toString().toLowerCase().trim() === 'ignorar'\n);\n\n// Agregar \""ignorar\"" solo si no existe\nif (!hasIgnore) {\n  labelsArray.push('ignorar');\n}\n\n// Retornar el array preparado\nreturn [{\n  json: {\n    ...$('Merge5').item.json,\n    labels: labelsArray,\n    phone_number: $('Merge5').item.json.phone_number\n  }\n}];"""
"2769","              ""value"": ""={{ $('buscar contacto1').item.json.phone_number }}"","
"2775","              ""value"": ""={{ $('set text1').item.json.text }}"","
"2794","        ""sessionKey"": ""={{ $('Webhook1').item.json.body.data.key.remoteJid.replace('@s.whatsapp.net', '') }}"","
"2818","              ""leftValue"": ""={{ $('buscar contacto1').item.json.id }}"","
"2858","              ""fieldValue"": ""={{ $('Get Subscription1').item.json.user_id }}"""
"2866","              ""fieldValue"": ""={{ $('Webhook1').item.json.body.data.pushName || $('Webhook1').item.json.body.data.key.remoteJid.replace('@s.whatsapp.net', '') }}"""
"2930","              ""keyValue"": ""={{ $('Get a row1').item.json.id }}"""
"2981","              ""leftValue"": ""={{ $('Verificar Match Auto Response').item.json.hasMatch }}"","
"3095","        ""instanceName"": ""={{ $('Set Fields1').item.json.instance.name }}"","
"3122","        ""instanceName"": ""={{ $('Set Fields1').item.json.instance.name }}"","
"3149","        ""instanceName"": ""={{ $('Set Fields1').item.json.instance.name }}"","
"3216","        ""url"": ""=https://mytvwfbijlgbihlegmfg.supabase.co/storage/v1/object/audiostemp/audio_{{ $('que escribir como audio1').item.json.now }}"","
