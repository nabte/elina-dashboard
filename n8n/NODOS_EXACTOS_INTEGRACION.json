{
  "nota": "Estos son los nodos exactos que debes agregar al flow 'Elina V4'. Copia y pega la configuraciÃ³n de cada nodo.",
  
  "nodos": [
    {
      "nombre": "Detectar IntenciÃ³n CrÃ­tica",
      "tipo": "HTTP Request",
      "posicion": "DespuÃ©s de '3. RAG - Formatear Contexto', antes de 'AI Agent1'",
      "configuracion": {
        "method": "POST",
        "url": "https://mytvwfbijlgbihlegmfg.supabase.co/functions/v1/detect-critical-intent",
        "nota_url": "âš ï¸ Reemplaza 'mytvwfbijlgbihlegmfg' con tu Project ID de Supabase",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "[Pega tu Service Role Key aquÃ­ directamente]"
            },
            {
              "name": "Authorization",
              "value": "Bearer [Pega tu Service Role Key aquÃ­ directamente]"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contact_id\": {{ $('Get Contact ID').item.json.id }},\n  \"user_id\": \"{{ $('Get a row').item.json.id }}\",\n  \"message_content\": \"{{ $('set text').item.json.text }}\",\n  \"message_id\": {{ $('human').item.json.id || null }}\n}",
        "options": {}
      },
      "nota": "Este nodo llama a la Edge Function detect-critical-intent. Para Edge Functions necesitas HTTP Request (el nodo de Supabase no las soporta). Pega tu Service Role Key directamente en los headers."
    },
    
    {
      "nombre": "IF: Â¿Es CrÃ­tico?",
      "tipo": "IF",
      "posicion": "DespuÃ©s de 'Detectar IntenciÃ³n CrÃ­tica'",
      "configuracion": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.is_critical }}",
              "value2": true
            }
          ]
        }
      },
      "conexiones": {
        "true": "Obtener NÃºmero NotificaciÃ³n",
        "false": "Buscar Promociones Activas"
      }
    },
    
    {
      "nombre": "Obtener NÃºmero NotificaciÃ³n",
      "tipo": "Supabase",
      "posicion": "Rama TRUE de 'IF: Â¿Es CrÃ­tico?'",
      "configuracion": {
        "operation": "get",
        "tableId": "profiles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $('Get a row').item.json.id }}"
            }
          ]
        },
        "select": "contact_phone"
      },
      "credentials": "Selecciona tu credencial de Supabase configurada",
      "nota": "Obtiene el nÃºmero guardado en profiles.contact_phone. Usa el nodo oficial de Supabase con credenciales configuradas."
    },
    
    {
      "nombre": "Enviar NotificaciÃ³n WhatsApp",
      "tipo": "Evolution API",
      "posicion": "DespuÃ©s de 'Obtener NÃºmero NotificaciÃ³n'",
      "configuracion": {
        "resource": "messages-api",
        "instanceName": "={{ $('Set Fields').item.json.instance.name }}",
        "remoteJid": "={{ $('Obtener NÃºmero NotificaciÃ³n').item.json.contact_phone.replace('+', '').replace('@s.whatsapp.net', '') }}",
        "messageText": "=ðŸš¨ *ATENCIÃ“N REQUERIDA*\n\nSe detectÃ³ una intenciÃ³n crÃ­tica en una conversaciÃ³n:\n\n*Contacto:* {{ $('Get Contact ID').item.json.full_name || $('Webhook').item.json.body.data.pushName }}\n*NÃºmero:* {{ $('Webhook').item.json.body.data.key.remoteJid.replace('@s.whatsapp.net', '') }}\n\n*Tipo de detecciÃ³n:* {{ $('Detectar IntenciÃ³n CrÃ­tica').item.json.detection_type }}\n*Confianza:* {{ Math.round($('Detectar IntenciÃ³n CrÃ­tica').item.json.confidence * 100) }}%\n\n*Mensaje detectado:*\n\"{{ $('Detectar IntenciÃ³n CrÃ­tica').item.json.detected_content }}\"\n\nLa conversaciÃ³n ha sido pausada automÃ¡ticamente. Revisa el chat en la aplicaciÃ³n.",
        "options_message": {
          "delay": 1000
        }
      },
      "nota": "EnvÃ­a notificaciÃ³n al nÃºmero configurado en Settings"
    },
    
    {
      "nombre": "FIN - ConversaciÃ³n Pausada",
      "tipo": "No Operation",
      "posicion": "DespuÃ©s de 'Enviar NotificaciÃ³n WhatsApp'",
      "configuracion": {},
      "nota": "Detiene el flujo cuando es crÃ­tico (no genera respuesta de IA)"
    },
    
    {
      "nombre": "Buscar Promociones Activas",
      "tipo": "Supabase",
      "posicion": "Rama FALSE de 'IF: Â¿Es CrÃ­tico?', antes de 'AI Agent1'",
      "configuracion": {
        "operation": "getMany",
        "tableId": "smart_promotions",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "keyValue": "={{ $('Get a row').item.json.id }}",
              "condition": "equal"
            },
            {
              "keyName": "is_active",
              "keyValue": "true",
              "condition": "equal"
            }
          ]
        },
        "select": "*",
        "sort": {
          "field": "created_at",
          "direction": "DESC"
        }
      },
      "credentials": "Selecciona tu credencial de Supabase configurada",
      "nota": "Busca promociones activas del usuario. Usa el nodo oficial de Supabase con credenciales configuradas."
    },
    
    {
      "nombre": "Filtrar PromociÃ³n VÃ¡lida",
      "tipo": "Code",
      "posicion": "DespuÃ©s de 'Buscar Promociones Activas'",
      "codigo": "const promos = $input.item.json;\nif (!Array.isArray(promos) || !promos.length) {\n  return [{ json: { promo: null } }];\n}\n\nconst now = new Date();\nconst selected = promos.find(promo => {\n  if (!promo.is_active) return false;\n  if (!promo.no_schedule) {\n    if (promo.start_at && new Date(promo.start_at) > now) return false;\n    if (promo.end_at && new Date(promo.end_at) < now) return false;\n  }\n  return true;\n});\n\nreturn [{ json: { promo: selected || null } }];",
      "nota": "Filtra y selecciona la primera promociÃ³n vÃ¡lida"
    },
    
    {
      "nombre": "IF: Â¿Hay PromociÃ³n?",
      "tipo": "IF",
      "posicion": "DespuÃ©s de 'Filtrar PromociÃ³n VÃ¡lida'",
      "configuracion": {
        "conditions": {
          "collection": [
            {
              "field": "={{ $json.promo }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "conexiones": {
        "true": "Agregar Promo al Contexto",
        "false": "AI Agent1"
      }
    },
    
    {
      "nombre": "Agregar Promo al Contexto",
      "tipo": "Code",
      "posicion": "Rama TRUE de 'IF: Â¿Hay PromociÃ³n?'",
      "codigo": "const promo = $('Filtrar PromociÃ³n VÃ¡lida').item.json.promo;\nconst ragContext = $('3. RAG - Formatear Contexto').item.json.rag_context || '';\nconst text = $('set text').item.json.text || '';\nconst imageDesc = $('3. RAG - Formatear Contexto').item.json['descripcion de la imagen'] || '';\n\nlet promoContext = '';\nif (promo) {\n  promoContext = `\\n\\n[PROMOCIÃ“N ACTIVA DISPONIBLE]\\n` +\n    `TÃ­tulo: ${promo.title || 'PromociÃ³n especial'}\\n` +\n    `DescripciÃ³n: ${promo.description || ''}\\n` +\n    (promo.discount ? `Descuento: ${promo.discount}\\n` : '') +\n    (promo.offer ? `Oferta: ${promo.offer}\\n` : '') +\n    `Vigencia: ${promo.start_at ? new Date(promo.start_at).toLocaleDateString('es-MX') : 'Activa'} - ${promo.end_at ? new Date(promo.end_at).toLocaleDateString('es-MX') : 'Sin lÃ­mite'}\\n` +\n    `\\nSi el contexto de la conversaciÃ³n lo permite, menciona esta promociÃ³n de forma natural. No la fuerces si no es relevante.\\n`;\n}\n\nreturn [{\n  json: {\n    ...$('3. RAG - Formatear Contexto').item.json,\n    rag_context: ragContext + promoContext,\n    promo_id: promo?.id || null\n  }\n}];",
      "nota": "Agrega la promociÃ³n al contexto RAG para que la IA la use"
    }
  ],
  
  "modificaciones_necesarias": [
    {
      "nodo": "AI Agent1",
      "campo": "prompt",
      "modificacion": "Agregar al final del prompt:\n{{ $json.promo_context ? '\\n' + $json.promo_context : '' }}",
      "nota": "O mejor aÃºn, el nodo 'Agregar Promo al Contexto' ya incluye la promo en rag_context, asÃ­ que no necesitas modificar el prompt si ya usas rag_context"
    }
  ],
  
  "orden_de_conexion": [
    "3. RAG - Formatear Contexto",
    "  â†“",
    "Detectar IntenciÃ³n CrÃ­tica",
    "  â†“",
    "IF: Â¿Es CrÃ­tico?",
    "  â”œâ”€ TRUE â†’ Obtener NÃºmero NotificaciÃ³n â†’ Enviar NotificaciÃ³n WhatsApp â†’ FIN",
    "  â””â”€ FALSE â†’ Buscar Promociones Activas",
    "                â†“",
    "            Filtrar PromociÃ³n VÃ¡lida",
    "                â†“",
    "            IF: Â¿Hay PromociÃ³n?",
    "                â”œâ”€ TRUE â†’ Agregar Promo al Contexto â†’ AI Agent1",
    "                â””â”€ FALSE â†’ AI Agent1"
  ]
}

