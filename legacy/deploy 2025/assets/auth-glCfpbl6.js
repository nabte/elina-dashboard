(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const a of t.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function s(e){if(e.ep)return;e.ep=!0;const t=n(e);fetch(e.href,t)}})();const g="https://mytvwfbijlgbihlegmfg.supabase.co",p="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15dHZ3ZmJpamxnYmlobGVnbWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MTg5OTAsImV4cCI6MjA2OTk5NDk5MH0.eFL6N7pR4nmpOLywRwxZS_sEWwSbq5WGAnY0zBMreDE",y=`${g}/functions/v1`;function w(){const r=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),o=localStorage.getItem("superadmin_session_tokens");let n={};return r&&o?(console.log(`Modo suplantación activo. Actuando como: ${r.id}`),n={global:{headers:{"X-Impersonated-User-ID":r.id}}}):r&&!o&&localStorage.removeItem("impersonated_user_info"),window.supabase.createClient(g,p,n)}window.auth={sb:w(),session:null,async invokeFunction(r,{method:o="POST",body:n,headers:s={},signal:e}={}){var d;const t={Accept:"application/json",apikey:p,...s};let a;n!==void 0&&(n instanceof FormData||n instanceof Blob?a=n:typeof n=="string"?(a=n,t["Content-Type"]||(t["Content-Type"]="application/json")):(a=JSON.stringify(n),t["Content-Type"]||(t["Content-Type"]="application/json")));const{data:c,error:u}=await this.sb.auth.getSession();u&&console.error("[invokeFunction] Error obteniendo la sesion actual:",u);const h=(d=c==null?void 0:c.session)==null?void 0:d.access_token;h&&(t.Authorization=`Bearer ${h}`);const l=await fetch(`${y}/${r}`,{method:o,headers:t,body:o==="GET"||o==="HEAD"?void 0:a,signal:e}),m=await l.text();let i=null;if(m)try{i=JSON.parse(m)}catch{i=m}return l.ok?{data:i,error:null}:{data:null,error:{message:(i&&typeof i=="object"?i.error||i.message:null)||`Function ${r} respondio con estado ${l.status}`,status:l.status,details:i}}},handleAuthStateChange(r,o){this.session=o;const n=window.location.pathname.endsWith("/")||window.location.pathname.endsWith("/index.html");if(o&&n){this.sb.rpc("get_user_team_info").then(({data:s,error:e})=>{if(e){console.error("Error fetching team info:",e),window.location.href="/dashboard.html";return}s&&s.role==="admin"?window.location.href="/company-admin.html":window.location.href="/dashboard.html"});return}if(!o&&!n){window.location.href="/";return}document.dispatchEvent(new CustomEvent("auth:ready",{detail:{session:o}}))},getSession(){return this.session},async handleLogin(r){var e,t;r.preventDefault();const o=r.target,n=(e=document.getElementById("login-email"))==null?void 0:e.value,s=(t=document.getElementById("login-password"))==null?void 0:t.value;this.setLoadingState(o,!0,"Verificando...");try{if(!n||!s)throw new Error("Credenciales incompletas");const{error:a}=await this.sb.auth.signInWithPassword({email:n,password:s});if(a)throw a}catch(a){const c=a.message==="Invalid login credentials"?"Correo o contraseña incorrectos.":a.message;this.setLoadingState(o,!1,"Iniciar Sesión",c)}},async handleRegister(r){var a,c,u,h;r.preventDefault();const o=r.target,n=(a=document.getElementById("register-email"))==null?void 0:a.value,s=(c=document.getElementById("register-password"))==null?void 0:c.value,e=(u=document.getElementById("register-name"))==null?void 0:u.value,t=window.iti?window.iti.getNumber():(h=document.getElementById("register-phone"))==null?void 0:h.value;this.setLoadingState(o,!0,"Creando...");try{if(!n||!s||!e||!t)throw new Error("Todos los campos son obligatorios.");const{data:l,error:m}=await this.sb.auth.signUp({email:n,password:s,options:{data:{full_name:e,phone:t}}});if(m)throw m;if(l.user){const i=new Date;i.setDate(i.getDate()+7);const{error:d}=await this.sb.from("subscriptions").insert({user_id:l.user.id,trial_ends_at:i.toISOString()});d&&console.error("Error creando la suscripción de prueba:",d)}if(l.user){try{await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/volution-instance-create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nombre:e,email:n,telefono_admin:t,Passwr:s})})}catch(d){console.error("Error al llamar al webhook de n8n, pero el registro de usuario continuó:",d)}o.style.display="none";const i=document.getElementById("register-success-message");i.classList.remove("hidden"),lucide.createIcons({nodes:[i.querySelector("i")]})}}catch(l){this.setLoadingState(o,!1,"Crear Cuenta",l.message)}},async handleLogout(){try{await this.sb.auth.signOut()}catch(r){console.error("[Logout Error]",r)}},setLoadingState(r,o,n,s=null){const e=r.querySelector('button[type="submit"]'),t=e.querySelector(".button-text"),a=e.querySelector(".loading-spinner"),c=document.getElementById("error-message"),u=document.getElementById("error-text");o?(e.disabled=!0,a.classList.remove("hidden"),t.textContent=n,c.style.display="none"):(e.disabled=!1,a.classList.add("hidden"),t.textContent=n,s?(u.textContent=s,c.style.display="flex",console.error("[Auth Error]",s)):c.style.display="none")}};window.auth.sb.auth.onAuthStateChange((r,o)=>{window.auth.handleAuthStateChange(r,o)});let f;window.showToast=(r,o="success",n=5e3)=>{const s=document.getElementById("toast-notification"),e=document.getElementById("toast-message"),t=document.getElementById("toast-icon");!s||!e||!t||(f&&clearTimeout(f),e.textContent=r,s.classList.remove("bg-green-500","bg-red-500","bg-blue-500"),s.classList.remove("translate-y-[150%]"),o==="success"?(s.classList.add("bg-green-500"),t.setAttribute("data-lucide","check-circle")):o==="error"?(s.classList.add("bg-red-500"),t.setAttribute("data-lucide","alert-circle")):(s.classList.add("bg-blue-500"),t.setAttribute("data-lucide","info")),lucide.createIcons(),s.classList.remove("hidden"),s.classList.remove("translate-x-[120%]"),f=setTimeout(()=>s.classList.add("translate-x-[120%]"),n))};
