import"./auth-UWASyYTP.js";class Jt{constructor(){this.file=null,this.iti=null,this.init(),this.insertPlaceholder=this.insertPlaceholder.bind(this),this.openAiModalForBulk=this.openAiModalForBulk.bind(this),this.handleTestSend=this.handleTestSend.bind(this)}init(){document.addEventListener("panel:activated",({detail:t})=>{t.panelId==="bulk-sending"&&this.onPanelActivated()})}onPanelActivated(){console.log("Panel de Envío Masivo activado."),this.checkPrerequisites(),this.setupEventListeners(),this.populateLabelSelectors(),this.initializeScheduleDefaults(),document.addEventListener("profile:updated",()=>this.checkPrerequisites())}async checkPrerequisites(){var n,u,p;const t=document.getElementById("bulk-submit-btn");if(!t)return;const a=(u=(n=window.auth.getSession())==null?void 0:n.user)==null?void 0:u.id;if(!a){console.error("No se encontró el ID de usuario para verificar el estado de la campaña.");return}try{const[f,L,T]=await Promise.all([window.auth.sb.from("profiles").select("active_campaign_id, whatsapp_connected").eq("id",a).single(),window.appInstance.loadUserUsage(),window.appInstance.loadUserSubscription()]);if(f.error)throw f.error;const z=f.data,H=L,N=T,G=((p=N==null?void 0:N.plans)==null?void 0:p.bulk_sends_limit)||0,be=(H==null?void 0:H.bulk_sends_used)||0;console.log(`[Bulk Sending] Usage: ${be} / ${G}`),z.whatsapp_connected?z.active_campaign_id?(t.disabled=!0,t.querySelector(".button-text").textContent="Campaña en progreso..."):be>=G?(t.disabled=!0,t.querySelector(".button-text").textContent="Límite de envíos alcanzado"):(t.disabled=!1,t.querySelector(".button-text").textContent="Enviar Campaña"):(t.disabled=!0,t.querySelector(".button-text").textContent="Conecta WhatsApp primero")}catch(f){console.error("Error al verificar pre-requisitos de envío masivo:",f),t.disabled=!0,t.querySelector(".button-text").textContent="Error al verificar"}}setupEventListeners(){var p,f,L;const t=document.getElementById("bulk-send-form");if(!t||t.dataset.listenersAttached==="true")return;t.dataset.listenersAttached="true",t.addEventListener("submit",this.handleBulkSend.bind(this));const a=document.getElementById("file-drop-zone"),n=document.getElementById("bulk-file-input"),u=document.getElementById("remove-file-btn");a.addEventListener("click",()=>n.click()),a.addEventListener("dragover",T=>{T.preventDefault(),a.classList.add("border-blue-500","bg-blue-50")}),a.addEventListener("dragleave",()=>a.classList.remove("border-blue-500","bg-blue-50")),a.addEventListener("drop",T=>{T.preventDefault(),a.classList.remove("border-blue-500","bg-blue-50"),T.dataTransfer.files.length&&this.handleFileSelect(T.dataTransfer.files[0])}),n.addEventListener("change",T=>{T.target.files.length&&this.handleFileSelect(T.target.files[0])}),u.addEventListener("click",()=>this.removeFile()),(p=document.getElementById("personalize-name-btn"))==null||p.addEventListener("click",this.insertPlaceholder),(f=document.getElementById("bulk-test-btn"))==null||f.addEventListener("click",this.handleTestSend),(L=document.getElementById("bulk-ai-enhance-btn"))==null||L.addEventListener("click",this.openAiModalForBulk)}async handleFileSelect(t){var n;if(t.size>26214400){confirm("Ups, el archivo es muy grande (máximo 25MB). Te recomendamos esta web para reducir el peso de tu archivo.")&&window.open("https://www.iloveimg.com/compress-image","_blank"),this.removeFile();return}this.showUploadProgress(0,"Optimizando archivo...");try{const u=await this.optimizeFile(t);this.file=u;const p=document.getElementById("file-preview"),f=document.getElementById("file-image-preview");document.getElementById("file-name").textContent=u.name,u.type.startsWith("image/")?(f.src=URL.createObjectURL(u),f.classList.remove("hidden")):f.classList.add("hidden"),p.classList.remove("hidden"),document.getElementById("file-drop-zone").classList.add("hidden"),this.hideUploadProgress(),lucide.createIcons()}catch(u){console.error("Error al optimizar archivo:",u),(n=window.showToast)==null||n.call(window,"Error al procesar el archivo. Se usará el archivo original.","warning"),this.file=t,this.hideUploadProgress()}}showUploadProgress(t,a=""){let n=document.getElementById("file-upload-progress");if(!n){n=document.createElement("div"),n.id="file-upload-progress",n.className="mt-4",n.innerHTML=`
                <div class="bg-slate-100 rounded-lg p-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-slate-700" id="upload-progress-text">${a||"Subiendo..."}</span>
                        <span class="text-sm text-slate-500" id="upload-progress-percent">0%</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2">
                        <div id="upload-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            `;const L=document.getElementById("file-preview");L&&L.appendChild(n)}const u=document.getElementById("upload-progress-bar"),p=document.getElementById("upload-progress-percent"),f=document.getElementById("upload-progress-text");u&&(u.style.width=`${t}%`),p&&(p.textContent=`${t}%`),f&&a&&(f.textContent=a),n.classList.remove("hidden")}hideUploadProgress(){const t=document.getElementById("file-upload-progress");t&&t.classList.add("hidden")}async optimizeFile(t){return t.type.startsWith("image/")?await this.compressImage(t):(t.type.startsWith("video/"),t)}async compressImage(t,a=1920,n=1920,u=.85){return new Promise((p,f)=>{const L=new FileReader;L.onload=T=>{const z=new Image;z.onload=()=>{const H=document.createElement("canvas");let N=z.width,G=z.height;if(N>a||G>n){const he=Math.min(a/N,n/G);N=N*he,G=G*he}H.width=N,H.height=G,H.getContext("2d").drawImage(z,0,0,N,G),H.toBlob(he=>{if(!he){f(new Error("Error al comprimir la imagen"));return}const X=t.name,ce=X.substring(0,X.lastIndexOf("."))||X,W=t.type==="image/jpeg"?"jpg":t.type==="image/png"?"png":t.type==="image/webp"?"webp":"jpg",J=`${ce}.${W}`,Y=new File([he],J,{type:t.type,lastModified:Date.now()});p(Y)},t.type,u)},z.onerror=f,z.src=T.target.result},L.onerror=f,L.readAsDataURL(t)})}removeFile(){this.file=null,document.getElementById("bulk-file-input").value="",document.getElementById("file-preview").classList.add("hidden"),document.getElementById("file-image-preview").classList.add("hidden"),document.getElementById("file-drop-zone").classList.remove("hidden")}async populateLabelSelectors(){const t=document.getElementById("include-labels"),a=document.getElementById("exclude-labels");try{const{data:n,error:u}=await window.auth.sb.from("labels").select("name");if(u)throw u;const p=[...new Set(n.map(f=>f.name))].sort();t.innerHTML='<option value="todos">Todos los contactos</option>',p.forEach(f=>t.innerHTML+=`<option value="${f}">${f}</option>`),a.innerHTML='<option value="ninguno">Ninguno</option>',p.forEach(f=>a.innerHTML+=`<option value="${f}">${f}</option>`)}catch(n){console.error("Error al cargar etiquetas para selectores:",n),t.innerHTML="<option>Error al cargar</option>",a.innerHTML="<option>Error al cargar</option>"}}initializeScheduleDefaults(){const t=document.getElementById("bulk-schedule-date");if(t){const a=new Date,n=a.getTimezoneOffset()*6e4,u=new Date(a.getTime()-n).toISOString().split("T")[0];t.min=u}}insertPlaceholder(){const t=document.getElementById("bulk-message"),a=t.selectionStart,n=t.selectionEnd,u=t.value,p="%nombre%";t.value=u.substring(0,a)+p+u.substring(n),t.focus(),t.selectionEnd=a+p.length}openAiModalForBulk(){const t=document.getElementById("bulk-message"),a=t.value;if(!a){alert("Primero escribe un mensaje para poder mejorarlo.");return}window.appInstance.openAiEnhanceModal(a,n=>{t.value=n})}async handleBulkSend(t){var u,p;t.preventDefault();const a=t.target.querySelector('button[type="submit"]');a.disabled=!0;const n=a.querySelector(".button-text");n.textContent="Preparando...",a.querySelector(".loading-spinner").classList.remove("hidden");try{const f=window.auth.getSession().user.id,{error:L}=await window.auth.sb.from("profiles").update({active_campaign_id:`campaign_${Date.now()}`}).eq("id",f);if(L)throw new Error(`No se pudo actualizar el estado: ${L.message}`);let T=null;if(this.file){if(n.textContent="Subiendo archivo...",!window.appInstance)throw new Error("La instancia de la aplicación no está lista.");this.showUploadProgress(0,"Subiendo archivo...");try{T=await window.appInstance.uploadAsset(this.file,"bulk-campaigns",J=>{this.showUploadProgress(J,"Subiendo archivo...")}),this.showUploadProgress(100,"Archivo subido correctamente"),setTimeout(()=>this.hideUploadProgress(),1e3)}catch(J){throw this.hideUploadProgress(),J}}const z=document.getElementById("bulk-schedule-date"),H=document.getElementById("bulk-schedule-time"),N=((u=z==null?void 0:z.value)==null?void 0:u.trim())||"",G=((p=H==null?void 0:H.value)==null?void 0:p.trim())||"";let be=null,he=null;if(N||G){if(!N||!G)throw new Error("Si quieres programar la campaña debes seleccionar fecha y hora.");const J=new Date(`${N}T${G}`);if(Number.isNaN(J.getTime()))throw new Error("La fecha y hora seleccionadas no son válidas.");if(J.getTime()<=Date.now())throw new Error("Programa la campaña en una fecha y hora futura.");be=J.toISOString();try{he=Intl.DateTimeFormat().resolvedOptions().timeZone}catch{he=null}}n.textContent=be?"Programando campaña...":"Enviando campaña...";const X={userId:f,message:document.getElementById("bulk-message").value,includeTag:document.getElementById("include-labels").value,excludeTag:document.getElementById("exclude-labels").value,fileUrl:T,scheduledAt:be,scheduledTimezone:he,scheduledDate:N||null,scheduledTime:G||null};if(!(await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/masivos-elina",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(X)})).ok)throw new Error("El servidor de automatización (n8n) no respondió correctamente.");alert(be?"¡Campaña programada! La enviaremos automáticamente en la fecha y hora seleccionadas.":"¡Campaña enviada! El proceso se ejecutará en segundo plano. Puedes cerrar esta ventana."),t.target.reset(),this.removeFile(),z&&(z.value=""),H&&(H.value="")}catch(f){console.error("Error al enviar la campaña:",f),alert(`Error al enviar la campaña: ${f.message}`)}finally{a.disabled=!1,n.textContent="Enviar Campaña",a.querySelector(".loading-spinner").classList.add("hidden")}}handleTestSend(){if(document.getElementById("test-send-modal").classList.remove("hidden"),!this.iti){const a=document.querySelector("#test-phone-input");this.iti=window.intlTelInput(a,{utilsScript:"https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",initialCountry:"mx",separateDialCode:!0}),document.getElementById("cancel-test-send-btn").addEventListener("click",()=>this.closeTestModal()),document.getElementById("confirm-test-send-btn").addEventListener("click",()=>this.executeTestSend())}}closeTestModal(){document.getElementById("test-send-modal").classList.add("hidden"),document.getElementById("test-phone-error").classList.add("hidden")}async executeTestSend(){if(!this.iti.isValidNumber()){document.getElementById("test-phone-error").classList.remove("hidden");return}document.getElementById("test-phone-error").classList.add("hidden");const t=this.iti.getNumber(),a=document.getElementById("confirm-test-send-btn");a.disabled=!0,a.textContent="Enviando...";try{const n=window.auth.getSession().user.id,u=document.getElementById("bulk-message").value.replace("%nombre%","Prueba");let p=null;if(this.file){if(!window.appInstance)throw new Error("La instancia de la aplicación no está lista.");this.showUploadProgress(0,"Subiendo archivo...");try{p=await window.appInstance.uploadAsset(this.file,"bulk-tests",z=>{this.showUploadProgress(z,"Subiendo archivo...")}),this.showUploadProgress(100,"Archivo subido correctamente"),setTimeout(()=>this.hideUploadProgress(),1e3)}catch(z){throw this.hideUploadProgress(),z}}if(!(await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/masivos-test-elina",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:n,testNumber:t,message:u,fileUrl:p})})).ok)throw new Error("El servidor no respondió correctamente.");alert(`Mensaje de prueba enviado a ${t}.`)}catch(n){console.error("Error en envío de prueba:",n),alert(`Error al enviar la prueba: ${n.message}`)}finally{a.disabled=!1,a.textContent="Enviar Prueba",this.closeTestModal()}}}new Jt;(function(){let Be=!1,t=null,a=null,n=[],u=[];function p(I){var K,ge,pe;const q=(K=window.appInstance)==null?void 0:K.teamInfo;if((q==null?void 0:q.user_role)!=="advisor")return null;const F=((ge=q==null?void 0:q.permissions)==null?void 0:ge.label_filters)||((pe=q==null?void 0:q.permissions)==null?void 0:pe.labelFilters),D=F==null?void 0:F[I];return!Array.isArray(D)||D.length===0?null:D.filter(Boolean)}let f=null,L={current:!1},T={current:null},z=[],H=[],N=null,G=null;document.addEventListener("panel:activated",({detail:I})=>{var q;I.panelId==="chats"?(Be||be(),(q=I.options)!=null&&q.contactId&&setTimeout(()=>W(I.options.contactId),200)):e()});async function be(){var F,D,K;console.log("Inicializando panel de Chats..."),Be=!0,he(),(F=window.lucide)!=null&&F.createIcons&&lucide.createIcons();const I=(K=(D=window.auth.getSession())==null?void 0:D.user)==null?void 0:K.id;n=await window.auth.sb.from("labels").select("*").eq("user_id",I).then(ge=>ge.data||[]),await ce();const q=document.querySelector("#chat-contacts-list .contact-item");q&&q.click()}function he(){var K,ge,pe,_e,we,xe,Se,Ee,g,$;(K=document.getElementById("chat-contacts-list"))==null||K.addEventListener("click",P=>{const U=P.target.closest(".contact-item");if(U){document.querySelectorAll(".contact-item").forEach(le=>le.classList.remove("bg-slate-200")),U.classList.add("bg-slate-200");const te=U.dataset.contactId;U.dataset.contactName,U.dataset.contactPhone,W(te)}}),(ge=document.getElementById("chat-input-form"))==null||ge.addEventListener("submit",y);const I=document.getElementById("chat-message-input");I==null||I.addEventListener("input",w),I==null||I.addEventListener("keydown",P=>{P.key==="Enter"&&!P.shiftKey&&(P.preventDefault(),y(P))}),(pe=document.getElementById("chat-contact-info-toggle"))==null||pe.addEventListener("click",()=>X()),(_e=document.getElementById("info-ignore-ia-toggle"))==null||_e.addEventListener("change",O),(we=document.getElementById("info-manage-labels-btn"))==null||we.addEventListener("click",ee),(xe=document.getElementById("chat-search-input"))==null||xe.addEventListener("input",ae),(Se=document.getElementById("resume-conversation-btn"))==null||Se.addEventListener("click",R),document.getElementById("chat-contact-info-panel");const q=document.getElementById("chat-info-overlay");q&&q.addEventListener("click",()=>X(!1));const F=document.getElementById("back-to-chats-btn");F&&F.addEventListener("click",()=>X(!1)),(Ee=document.getElementById("chat-attach-file-btn"))==null||Ee.addEventListener("click",()=>{var P;(P=document.getElementById("chat-file-input"))==null||P.click()}),(g=document.getElementById("chat-file-input"))==null||g.addEventListener("change",P=>{P.target.files&&P.target.files[0]&&me(P.target.files[0])}),($=document.getElementById("chat-remove-image-btn"))==null||$.addEventListener("click",fe);const D=document.getElementById("chat-view-main");D&&(D.addEventListener("dragover",P=>{P.preventDefault(),P.stopPropagation(),D.classList.add("bg-blue-50")}),I.addEventListener("paste",ue),D.addEventListener("paste",ue),D.addEventListener("dragleave",P=>{P.preventDefault(),P.stopPropagation(),D.classList.remove("bg-blue-50")}),D.addEventListener("drop",ie))}function X(I=null){const q=document.getElementById("chat-contact-info-panel");document.getElementById("chat-view-main");const F=document.getElementById("chat-info-overlay"),D=I===null?!q.classList.contains("open"):!I;q.classList.toggle("hidden",!D),q.classList.toggle("open",D),F==null||F.classList.toggle("hidden",!D)}async function ce(){var F,D;const I=document.getElementById("chat-contacts-list"),q=document.getElementById("contacts-list-loader");if(!(!I||!q)){q.classList.remove("hidden"),q.textContent="Cargando conversaciones...",I.innerHTML="";try{const{data:K,error:ge}=await window.auth.sb.rpc("get_recent_contacts").order("last_message_at",{ascending:!1});if(ge)throw ge;const pe=(F=window.appInstance)==null?void 0:F.teamInfo,_e=pe==null?void 0:pe.user_role,we=(D=pe==null?void 0:pe.profiles)==null?void 0:D.full_name,xe=pe==null?void 0:pe.allow_all_chats_visibility;let Se=K;if(_e==="advisor"){const Ee=p("chats");Ee?Se=K.filter(g=>(g.labels||[]).some($=>Ee.includes($))):we&&!xe&&(Se=K.filter(g=>(g.labels||[]).includes(we)))}u=Se,Se.length===0?q.textContent="No hay conversaciones recientes.":(q.classList.add("hidden"),I.innerHTML=Se.map(Ee=>`
                    <div class="contact-item p-3 flex items-center gap-3 cursor-pointer hover:bg-slate-100 rounded-lg transition-colors"
                         data-contact-id="${Ee.contact_id}" 
                         data-contact-name="${Ee.full_name}"
                         data-contact-phone="${Ee.phone_number}">
                        <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0">
                            ${(Ee.full_name||"?").charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <p class="font-bold truncate">${Ee.full_name||Ee.phone_number}</p>
                            <p class="text-sm text-slate-500 truncate">${(Ee.last_message_content||"").substring(0,40)}...</p>
                        </div>
                    </div>
                `).join(""))}catch(K){console.error("Error al cargar lista de contactos para chat:",K),q.textContent="Error al cargar contactos."}}}async function W(I){var _e,we;t=I,N=null,e();const{data:q,error:F}=await window.auth.sb.from("contacts").select("*").eq("id",I).single();if(F){console.error("Error buscando contacto:",F);return}a={contact_id:q.id,...q};const D=document.getElementById("chat-history"),K=document.getElementById("chat-header-name"),ge=document.getElementById("chat-view-placeholder"),pe=document.getElementById("chat-view-main");if(!(!D||!K||!ge||!pe)){ge.classList.add("hidden"),pe.classList.remove("hidden"),pe.classList.add("flex"),(_e=window.lucide)!=null&&_e.createIcons&&lucide.createIcons({root:pe}),K.textContent=a.full_name||a.phone_number,D.innerHTML='<p class="text-center text-slate-400">Cargando mensajes...</p>';try{const{data:xe,error:Se}=await window.auth.sb.from("chat_history").select("message_type, content, created_at").eq("contact_id",I).order("created_at",{ascending:!0});if(Se)throw Se;xe.length===0?D.innerHTML='<p class="text-center text-slate-400">Inicia la conversación.</p>':(D.innerHTML="",xe.forEach(Ee=>i(Ee,!0)),setTimeout(()=>D.scrollTop=D.scrollHeight,0)),(we=window.lucide)!=null&&we.createIcons&&lucide.createIcons({root:D}),x(),l(),J(I),_(I)}catch(xe){console.error("Error al cargar historial de chat:",xe),D.innerHTML='<p class="text-center text-red-500">Error al cargar mensajes.</p>'}}}async function J(I){if(!I)return;const q=typeof I=="string"?parseInt(I,10):I;if(!q||isNaN(q)){console.warn("checkConversationState: contactId inválido:",I);return}try{const{data:F,error:D}=await window.auth.sb.from("conversation_states").select("*").eq("contact_id",q).maybeSingle();if(D){D.code!=="PGRST116"&&D.code!=="42P01"&&console.error("Error al verificar estado de conversación:",D);return}F!=null&&F.is_paused?Y(F):A()}catch(F){(F==null?void 0:F.status)!==406&&(F==null?void 0:F.statusCode)!==406&&console.error("Error al verificar estado de pausa:",F)}}function Y(I){var _e;const q=document.getElementById("conversation-paused-banner"),F=document.getElementById("pause-reason-text"),D=document.getElementById("chat-message-input"),K=document.getElementById("chat-send-btn");if(!q)return;q.classList.remove("hidden");const pe={human_request:"Solicitud de atención humana",purchase_intent:"Intención de compra detectada",urgent_attention:"Atención urgente requerida",sensitive_label:"Etiqueta sensible asignada",custom_keyword:"Palabra clave crítica detectada"}[I.pause_reason]||I.pause_reason||"Requiere atención";F&&(F.textContent=`(${pe})`),D&&(D.disabled=!0,D.placeholder="Conversación pausada - Requiere atención humana"),K&&(K.disabled=!0),(_e=window.lucide)!=null&&_e.createIcons&&lucide.createIcons({root:q})}function A(){const I=document.getElementById("conversation-paused-banner"),q=document.getElementById("chat-message-input"),F=document.getElementById("chat-send-btn");I&&I.classList.add("hidden"),q&&(q.disabled=!1,q.placeholder="Escribe un mensaje..."),F&&(F.disabled=!1)}let M=null;function _(I){I&&(M&&(window.auth.sb.removeChannel(M),M=null),M=window.auth.sb.channel(`conversation-state-${I}`).on("postgres_changes",{event:"*",schema:"public",table:"conversation_states",filter:`contact_id=eq.${I}`},q=>{var F;console.log("Estado de conversación actualizado:",q),(F=q.new)!=null&&F.is_paused?Y(q.new):A()}).subscribe())}async function R(){var q,F,D,K,ge;if(!t)return;const I=document.getElementById("resume-conversation-btn");I&&(I.disabled=!0,I.innerHTML='<div class="animate-spin rounded-full h-4 h-4 border-b-2 border-white"></div>');try{const pe=(F=(q=window.auth.getSession())==null?void 0:q.user)==null?void 0:F.id;if(!pe)throw new Error("Usuario no autenticado");const{data:_e,error:we}=await window.auth.sb.rpc("resume_conversation",{p_contact_id:t,p_resumed_by:pe});if(we)throw we;(D=window.showToast)==null||D.call(window,"Conversación reanudada. La IA puede responder nuevamente.","success"),A()}catch(pe){console.error("Error al reanudar conversación:",pe),(K=window.showToast)==null||K.call(window,"Error al reanudar la conversación: "+pe.message,"error")}finally{I&&(I.disabled=!1,I.innerHTML='<i data-lucide="play" class="w-4 h-4"></i> Reanudar',(ge=window.lucide)!=null&&ge.createIcons&&lucide.createIcons({root:I}))}}async function y(I){var _e,we;I.preventDefault();const q=I.target.closest("form");if(!q)return;const F=document.getElementById("chat-message-input");let D=F.value.trim();if(!D&&!G||!t)return;const K=q.querySelector('button[type="submit"]');K.disabled=!0;const ge=K.innerHTML;let pe=D;F.value="";try{const xe=(we=(_e=window.auth.getSession())==null?void 0:_e.user)==null?void 0:we.id;if(!a)throw new Error("Contacto no encontrado");let Se=null;if(G){if(K.innerHTML='<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>',Se=await window.appInstance.uploadAsset(G,"chat-files"),!Se)throw new Error("No se pudo subir el archivo.");D||(D="Imagen adjunta")}G&&(K.innerHTML=ge),pe=Se?`${D} ${Se}`:D;const g=await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/manual-send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:xe,contact_id:t,contact_name:a.full_name,phone_number:a.phone_number,message:D,media_url:Se})});if(!g.ok){const te=await m(g),le=(te==null?void 0:te.message)||await g.text();throw new Error(le||"El servidor no pudo enviar el mensaje.")}const{data:$,error:P}=await window.auth.sb.from("chat_history").insert({user_id:xe,contact_id:t,message_type:"ai",content:pe}).select().limit(1);if(P)throw new Error(`Error guardando el mensaje: ${P.message}`);const U=Array.isArray($)?$[0]:$;i({...U||{},message_type:"ai",content:pe,created_at:(U==null?void 0:U.created_at)||new Date().toISOString(),_localEcho:!0}),H.push({content:D,expiresAt:Date.now()+5e3})}catch(xe){console.error("Error al enviar mensaje:",xe),window.showToast(`Error al enviar mensaje: ${xe.message}`,"error"),F.value=D}finally{K.disabled=!1,K.innerHTML=ge,fe()}}async function m(I){try{return await I.json()}catch{return null}}function w(){f&&(L.current||(L.current=!0,f.track({is_typing:!0})),T.current&&clearTimeout(T.current),T.current=setTimeout(()=>{L.current=!1,f.track({is_typing:!1}),T.current=null},2e3))}function l(){var I,q,F;f||!t||(console.log(`Suscribiéndose a mensajes para el contacto ${t}`),f=window.auth.sb.channel(`chat-${t}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_history",filter:`contact_id=eq.${t}`},D=>{console.log("Nuevo mensaje recibido:",D.new),i(D.new)}).on("presence",{event:"sync"},()=>{if(!f)return;const D=f.presenceState(),K=[];for(const ge in D){const pe=D[ge][0];pe.is_typing&&K.push(pe.name)}z=K,s()}).subscribe(),f.track({is_typing:!1,name:((F=(q=(I=window.appInstance)==null?void 0:I.user)==null?void 0:q.user_metadata)==null?void 0:F.full_name)||"Agente"}))}function e(){f&&(console.log("Desuscribiéndose del chat actual."),window.auth.sb.removeChannel(f),f=null),M&&(window.auth.sb.removeChannel(M),M=null)}function s(){const I=document.getElementById("typing-indicator");I&&(z.length>0?I.textContent=`${z.join(", ")} está(n) escribiendo...`:I.textContent="")}function i(I,q=!1){const F=document.getElementById("chat-history");if(!F)return;const D=Date.now(),K=typeof(I==null?void 0:I.content)=="string"?I.content:"";if(H=H.filter(we=>we.expiresAt>D),I.message_type!=="human"&&!q){const we=H.findIndex(xe=>xe.content===K&&xe.expiresAt>D);if(we!==-1&&(H.splice(we,1),!I._localEcho))return}const ge=F.querySelector("p");ge&&ge.textContent.includes("Inicia la conversación")&&ge.remove(),h(I.created_at);const _e=`
        <div class="chat-bubble ${I.message_type==="human"?"self-start bg-white":"self-end bg-blue-100"} rounded-lg p-3 max-w-lg lg:max-w-xl shadow-sm space-y-2 break-words">
            ${(()=>{const we=K.match(/(https?:\/\/\S+\.(?:png|jpg|jpeg|gif|webp|avif|bmp|svg))/i);if(we){const Se=we[0],Ee=K.replace(Se,"").replace(/Imagen:|Media:|Imagen adjunta|Archivo adjunto/ig,"").trim();return`
                        <a href="${Se}" target="_blank" rel="noopener noreferrer" class="block group relative">
                            <img src="${Se}" class="rounded-lg max-w-xs cursor-pointer" alt="Imagen adjunta" loading="lazy">
                        </a>
                        ${Ee?`<p class="text-slate-800 text-sm break-words mt-2">${Ee.replace(/:$/,"")}</p>`:""}
                    `}return`<p class="text-slate-800">${K.trim()||"[Mensaje sin contenido]"}</p>`})()}
            <p class="text-xs text-slate-400 text-right mt-1">${new Date(I.created_at).toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"})}</p>
        </div>`;F.insertAdjacentHTML("beforeend",_e),F.scrollTop=F.scrollHeight}function h(I){const q=document.getElementById("chat-history");if(!q||!I)return;const F=new Date(I),D=`${F.getFullYear()}-${String(F.getMonth()+1).padStart(2,"0")}-${String(F.getDate()).padStart(2,"0")}`;if(N===D)return;N=D;const K=F.toLocaleDateString("es-MX",{day:"numeric",month:"long",year:"numeric"});q.insertAdjacentHTML("beforeend",`
            <div class="my-4 flex justify-center">
                <span class="text-xs text-slate-400 bg-white/90 px-3 py-1 rounded-full shadow-sm">${K}</span>
            </div>
        `)}function x(){var xe,Se;if(!a)return;const I=document.getElementById("info-chat-files");if(I){const Ee=(((xe=u.find(g=>g.contact_id==t))==null?void 0:xe.chat_history)||[]).map(g=>{const P=(typeof(g==null?void 0:g.content)=="string"?g.content:"").match(/(https?:\/\/\S+\.(?:png|jpg|jpeg|gif|webp|avif|bmp|svg))/i);return P?P[0]:null}).filter(Boolean);Ee.length>0?I.innerHTML=`
                    <h5 class="font-semibold mb-2">Archivos del Chat</h5>
                    <div class="grid grid-cols-3 gap-2">
                        ${Ee.map(g=>`<a href="${g}" target="_blank" class="aspect-square bg-slate-200 rounded-md overflow-hidden"><img src="${g}" class="w-full h-full object-cover"></a>`).join("")}
                    </div>`:I.innerHTML=""}document.getElementById("info-contact-name").textContent=a.full_name||"Sin nombre",document.getElementById("info-contact-phone").textContent=a.phone_number;const q=Ee=>Ee?Ee.trim().toLowerCase():"",F=document.getElementById("info-ignore-ia-toggle");if(F){const Ee=(a.labels||[]).some(g=>q(g)==="ignorar");F.checked=Ee}const D=(Se=window.appInstance)==null?void 0:Se.teamInfo,K=(D==null?void 0:D.ignored_labels)||[],ge=document.getElementById("info-contact-labels"),pe=a.labels||[];ge.innerHTML=pe.filter(Ee=>Ee!=="ignorar"&&!K.includes(Ee)).map(Ee=>{const g=n.find(U=>U.name===Ee),$=se(g==null?void 0:g.color),P=C($);return`<span class="text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full" style="background-color: ${$}; color: ${P};">${Ee}</span>`}).join("")||'<span class="text-xs text-slate-400">Sin etiquetas</span>';const _e=document.getElementById("info-contact-razon-ia");_e?a!=null&&a.razon_de_label_auto?(_e.innerHTML=`<h5 class="font-semibold mb-2">Razón de la IA</h5><p class="text-sm bg-blue-50 p-3 rounded-md text-slate-700">${a.razon_de_label_auto}</p>`,_e.classList.remove("hidden")):_e.classList.add("hidden"):console.warn("Elemento 'info-contact-razon-ia' no encontrado en el DOM.");const we=document.getElementById("info-manage-labels-container");we&&(we.innerHTML='<button id="info-manage-labels-btn" class="flex items-center gap-2 text-sm text-slate-700 hover:text-blue-600 font-semibold hover:underline mt-3"><i data-lucide="edit" class="w-4 h-4"></i> Gestionar etiquetas</button>',document.getElementById("info-manage-labels-btn").addEventListener("click",ee),lucide.createIcons({root:we}))}const B=["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#FF5722","#795548","#9E9E9E","#607D8B"];function se(I){if(typeof I=="string"&&I.startsWith("#"))return I;const q=parseInt(I,10);return!isNaN(q)&&q>=0&&q<B.length?B[q]:"#A0AEC0"}function C(I){return!I||!I.startsWith("#")||(.299*parseInt(I.substring(1,3),16)+.587*parseInt(I.substring(3,5),16)+.114*parseInt(I.substring(5,7),16))/255>.5?"#1e293b":"#ffffff"}function b(I){return I?I.trim().toLowerCase():""}async function j(I){if(!I)return"Ignorar";try{const{data:q,error:F}=await window.auth.sb.from("labels").select("name").eq("user_id",I).limit(100);if(F)throw F;const D=Array.isArray(q)?q.find(K=>K.name&&b(K.name)==="ignorar"):null;return(D==null?void 0:D.name)||"Ignorar"}catch(q){return console.error("Error al obtener nombre canónico de 'ignorar':",q),"Ignorar"}}async function O(I){var _e,we;const q=I.target;if(!a)return;const F=q.checked,D=(we=(_e=window.auth.getSession())==null?void 0:_e.user)==null?void 0:we.id,K=new Set(a.labels||[]),ge=Array.from(K);if(K.clear(),ge.forEach(xe=>{b(xe)!=="ignorar"&&K.add(xe)}),F){const xe=await j(D);K.add(xe)}const pe=Array.from(K);try{const{error:xe}=await window.auth.sb.from("contacts").update({labels:pe}).eq("id",a.contact_id);if(xe)throw xe;a.labels=pe;const{data:Se,error:Ee}=await window.auth.sb.from("contacts").select("*").eq("id",a.contact_id).single();if(!Ee&&Se){a={contact_id:Se.id,...Se};const g=(Se.labels||[]).some($=>b($)==="ignorar");q.checked=g}}catch(xe){console.error("Error al actualizar la etiqueta 'ignorar':",xe),q.checked=!F}}function ee(){a&&window.contacts.openLabelsModalForSingleContact(a.contact_id)}function ae(I){const q=I.target.value.toLowerCase(),F=document.getElementById("chat-contacts-list");if(!F)return;const D=u.filter(K=>(K.full_name||"").toLowerCase().includes(q)||(K.phone_number||"").includes(q));F.querySelectorAll(".contact-item").forEach(K=>{const ge=K.dataset.contactId;K.style.display=D.some(pe=>pe.contact_id==ge)?"flex":"none"})}function ue(I){if(I.clipboardData&&I.clipboardData.files&&I.clipboardData.files.length>0){const q=I.clipboardData.files[0];q.type.startsWith("image/")&&(I.preventDefault(),me(q))}}function ie(I){I.preventDefault(),I.stopPropagation(),document.getElementById("chat-view-main").classList.remove("bg-blue-50"),I.dataTransfer.files&&I.dataTransfer.files[0]&&me(I.dataTransfer.files[0])}function me(I){if(!I.type.startsWith("image/")){window.showToast("Solo se pueden adjuntar imágenes.","error");return}G=I;const q=document.getElementById("chat-image-preview-container"),F=document.getElementById("chat-image-preview");F.src=URL.createObjectURL(I),q.classList.remove("hidden")}function fe(){G=null,document.getElementById("chat-file-input").value="",document.getElementById("chat-image-preview-container").classList.add("hidden"),document.getElementById("chat-image-preview").src=""}})();(function(){var Tt;let Be=!1,t=!1,a=[],n=[],u=new Set,p={column:"created_at",direction:"desc"},f=1;const L=50;let T=0,z=null,H=null,N=null,G=null,be=null,he=null,X=null,ce=null;const W=(...o)=>console.info("[contacts-import]",...o);function J(o){var v,E,S;const r=(v=window.appInstance)==null?void 0:v.teamInfo;if((r==null?void 0:r.user_role)!=="advisor")return null;const c=((E=r==null?void 0:r.permissions)==null?void 0:E.label_filters)||((S=r==null?void 0:r.permissions)==null?void 0:S.labelFilters),d=c==null?void 0:c[o];return!Array.isArray(d)||d.length===0?null:d.filter(Boolean)}const Y=o=>o==null?"":String(o).trim().toLowerCase();function A(o,r){return Y(o)===Y(r)}function M(o,r){const c=Y(r);return c?(o||[]).some(d=>Y(d)===c):!1}function _(o,r){const c=Y(r);return c?(o||[]).filter(d=>Y(d)!==c):o||[]}function R(){const o=document.getElementById("contact-label-filter");return o?Array.from(o.selectedOptions||[]).map(r=>r.value):[]}function y(o,r){const c=Y(o);if(!c)return null;const d=n.find(v=>Y(v==null?void 0:v.name)===c&&(!(v!=null&&v.user_id)||!r||v.user_id===r));return d||n.find(v=>Y(v==null?void 0:v.name)===c)||null}document.addEventListener("panel:activated",({detail:o})=>{o.panelId==="contacts"?(Be||m(),jt()):Ft()});function m(){console.log("Inicializando panel de contactos..."),Be=!0,zt(),P(),xe(),Ee(),B(),Se(),ge(),D(),w(),document.addEventListener("profile:updated",Lt)}async function w(){await s(),await i(),await Lt()}async function l(o=1){var Z,Q,ne,de;const r=(Q=(Z=window.auth.getSession())==null?void 0:Z.user)==null?void 0:Q.id;if(!r)throw new Error("No se pudo obtener el ID del usuario.");f=o;const c=((ne=document.getElementById("contact-search-input"))==null?void 0:ne.value.trim())||"",d=Array.from(((de=document.getElementById("contact-label-filter"))==null?void 0:de.selectedOptions)||[]).map(ve=>ve.value).filter(Boolean),v=J("contacts");if(d.length>0&&d[0]!=="")try{const{data:ve,error:Ie}=await window.auth.sb.rpc("get_filtered_contacts",{p_user_id:r,p_label_filter:d.length>0?d:null,p_search_term:c||null,p_sort_column:p.column,p_sort_direction:p.direction,p_page_number:o,p_page_size:L,p_restricted_labels:v||null});if(Ie)throw Ie;const ye=ve==null?void 0:ve[0];return ye?(T=ye.total_count||0,ye.contacts||[]):(T=0,[])}catch(ve){console.error("[contacts] Error en get_filtered_contacts, usando método alternativo:",ve)}const E=(f-1)*L,S=E+L-1;let V=window.auth.sb.from("contacts").select("id, full_name, phone_number, created_at, labels, razon_de_label_auto",{count:"exact"}).eq("user_id",r);c&&(V=V.or(`full_name.ilike.%${c}%,phone_number.ilike.%${c}%`)),v&&(V=V.overlaps("labels",v));const{data:k,error:oe,count:re}=await V.order(p.column,{ascending:p.direction==="asc",nullsFirst:!1}).range(E,S);if(oe)throw new Error(`No se pudieron cargar contactos: ${oe.message}`);return T=re||0,k||[]}async function e(){const{data:o,error:r}=await window.auth.sb.from("labels").select("*");if(r)throw new Error(`No se pudieron cargar las etiquetas: ${r.message}`);return o}async function s(){var c,d;const o=["Nuevo cliente","Interesado","No responde"],r=(d=(c=window.auth.getSession())==null?void 0:c.user)==null?void 0:d.id;if(r)try{const{data:v,error:E}=await window.auth.sb.from("labels").select("name").eq("user_id",r);if(E)throw E;const S=new Set(v.map(k=>Y(k.name))),V=o.filter(k=>!S.has(Y(k))).map(k=>({name:k,user_id:r,color:"#848484"}));V.length>0&&await window.auth.sb.from("labels").insert(V)}catch(v){console.error("Error al asegurar etiquetas base:",v)}}async function i(){var c;const o=document.getElementById("contacts-loader"),r=document.getElementById("contacts-table-body");if(!(!r||!o)){o.style.display="block",o.textContent="Cargando contactos y etiquetas...",r.innerHTML="";try{if([a,n]=await Promise.all([l(1),e()]),W("loadAndRender resolved",{contacts:a.length,labels:n.length}),ie(),x(T),!a.length){const d=(c=document.getElementById("contact-search-input"))==null?void 0:c.value.trim();o.textContent=d?"No se encontraron contactos con ese término.":"Aún no tienes contactos. ¡Sincroniza para empezar!",me([]),h();return}o.style.display="none",me(a),h(),fe(),lucide.createIcons()}catch(d){console.error(d),o.textContent="Error al cargar contactos. Revisa la consola."}}}function h(){var v,E;const o=document.getElementById("contacts-pagination");if(!o)return;const r=Math.ceil(T/L);if(r<=1){o.innerHTML="";return}const c=(f-1)*L+1,d=Math.min(f*L,T);o.innerHTML=`
            <span class="text-sm text-slate-600">Mostrando ${c}-${d} de ${T} contactos</span>
            <div class="flex gap-2">
                <button id="prev-page-btn" class="p-2 rounded-md hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed" ${f===1?"disabled":""}><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                <button id="next-page-btn" class="p-2 rounded-md hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed" ${f===r?"disabled":""}><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
            </div>
        `,(v=document.getElementById("prev-page-btn"))==null||v.addEventListener("click",()=>g(f-1)),(E=document.getElementById("next-page-btn"))==null||E.addEventListener("click",()=>g(f+1)),lucide.createIcons()}function x(o){const r=document.getElementById("contacts-count-badge");if(r){if(typeof o!="number"){r.classList.add("hidden");return}r.textContent=o.toLocaleString("es-MX"),r.classList.toggle("hidden",o<=0)}}function B(){const o=document.getElementById("export-contacts-btn"),r=document.getElementById("import-contacts-btn"),c=document.getElementById("import-contacts-input");o&&o.addEventListener("click",E=>{E.preventDefault(),se(o)}),r&&c&&(r.addEventListener("click",E=>{E.preventDefault(),c.click()}),c.addEventListener("change",Mt));const d=document.getElementById("import-numbers-label-btn");d&&d.addEventListener("click",E=>{E.preventDefault(),Wt()});const v=document.getElementById("sidebar-verify-contacts-btn");v&&v.addEventListener("click",E=>{E.preventDefault(),gt()})}function se(o){be?b():C(o)}function C(o){b();const r=o.getBoundingClientRect(),c=document.createElement("div");c.id="contacts-export-menu",c.className="absolute bg-white border border-slate-200 rounded-xl shadow-xl w-56 py-2 z-[260]",c.innerHTML=`
            <button type="button" data-format="csv" class="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 flex items-center gap-2">
                <i data-lucide="file-text" class="w-4 h-4 text-slate-500"></i>
                <span>Exportar como CSV</span>
            </button>
            <button type="button" data-format="xlsx" class="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 flex items-center gap-2">
                <i data-lucide="table" class="w-4 h-4 text-slate-500"></i>
                <span>Exportar como Excel (.xlsx)</span>
            </button>
            <div class="border-t border-slate-200 my-1"></div>
            <button type="button" id="verify-contacts-btn" class="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 flex items-center gap-2">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                <span>Comprobar Contactos</span>
            </button>
        `,document.body.appendChild(c);const d=c.getBoundingClientRect(),v=r.bottom+window.scrollY+8,E=window.scrollX+window.innerWidth-d.width-16;let S=r.left+window.scrollX;S>E&&(S=Math.max(window.scrollX+16,E)),c.style.top=`${v}px`,c.style.left=`${S}px`,be=c,c.querySelectorAll("button[data-format]").forEach(k=>{k.addEventListener("click",async()=>{await j(k.dataset.format)})});const V=c.querySelector("#verify-contacts-btn");V&&V.addEventListener("click",()=>{b(),gt()}),he=k=>{!c.contains(k.target)&&k.target!==o&&b()},X=k=>{k.key==="Escape"&&(k.preventDefault(),b())},ce=()=>b(),document.addEventListener("mousedown",he),document.addEventListener("keydown",X),window.addEventListener("resize",ce),window.addEventListener("scroll",ce,!0),typeof lucide<"u"&&lucide.createIcons&&lucide.createIcons({root:c})}function b(){be!=null&&be.parentElement&&be.parentElement.removeChild(be),be=null,he&&(document.removeEventListener("mousedown",he),he=null),X&&(document.removeEventListener("keydown",X),X=null),ce&&(window.removeEventListener("resize",ce),window.removeEventListener("scroll",ce,!0),ce=null)}async function j(o="csv"){var v,E,S,V,k;const r=document.getElementById("export-contacts-btn");b();const c=window.auth.getSession(),d=(v=c==null?void 0:c.user)==null?void 0:v.id;if(!d){(E=window.showToast)==null||E.call(window,"No se pudo obtener tu sesión. Intenta recargar.","error");return}try{r&&(r.disabled=!0,r.classList.add("opacity-60","cursor-wait"));const{data:oe,error:re}=await window.auth.sb.from("contacts").select("full_name, phone_number, labels, razon_de_label_auto, created_at, assigned_to_id").eq("user_id",d).order("created_at",{ascending:!1});if(re)throw re;const Z=O(oe||[]);if(!Z.length){(S=window.showToast)==null||S.call(window,"No tienes contactos para exportar.","info");return}o==="xlsx"?ae(Z):ee(Z),(V=window.showToast)==null||V.call(window,"Exportación generada correctamente.","success")}catch(oe){console.error("Error al exportar contactos:",oe),(k=window.showToast)==null||k.call(window,`No se pudo exportar: ${oe.message}`,"error")}finally{r&&(r.disabled=!1,r.classList.remove("opacity-60","cursor-wait"))}}function O(o){return o.map(r=>({Nombre:r.full_name||"",Telefono:r.phone_number||"",Etiquetas:Array.isArray(r.labels)?r.labels.join(", "):"","Motivo IA":r.razon_de_label_auto||"","Asignado a":r.assigned_to_id||"","Creado el":r.created_at?new Date(r.created_at).toLocaleString("es-MX"):""}))}function ee(o){if(!o.length)return;const r=Object.keys(o[0]),c=[r.join(","),...o.map(v=>r.map(E=>je(v[E])).join(","))],d=new Blob([c.join(`
`)],{type:"text/csv;charset=utf-8;"});ue(d,`contactos_${new Date().toISOString().slice(0,10)}.csv`)}function ae(o){var E;if(typeof XLSX>"u"){(E=window.showToast)==null||E.call(window,"No se encontró la librería XLSX. Se generará un CSV.","info"),ee(o);return}const r=XLSX.utils.json_to_sheet(o),c=XLSX.utils.book_new();XLSX.utils.book_append_sheet(c,r,"Contactos");const d=XLSX.write(c,{bookType:"xlsx",type:"array"}),v=new Blob([d],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});ue(v,`contactos_${new Date().toISOString().slice(0,10)}.xlsx`)}function ue(o,r){const c=document.createElement("a"),d=URL.createObjectURL(o);c.href=d,c.download=r,document.body.appendChild(c),c.click(),document.body.removeChild(c),setTimeout(()=>URL.revokeObjectURL(d),1500)}function ie(){var V;if(!G)return;const o=window.auth.getSession(),r=(V=o==null?void 0:o.user)==null?void 0:V.id;if(!r)return;const c=Array.from(G.selectedOptions||[]).map(k=>k.value),d=n.filter(k=>(k==null?void 0:k.user_id)===r).map(k=>k.name).filter(Boolean).sort((k,oe)=>k.localeCompare(oe,"es",{sensitivity:"base"})),E=['<option value="">Todas las etiquetas</option>',...Array.from(new Set(d)).map(k=>`<option value="${k}">${k}</option>`)].join("");G.innerHTML=E,c.forEach(k=>{const oe=Array.from(G.options).find(re=>re.value===k);oe&&(oe.selected=!0)}),c.length||(G.value="");const S=G.parentElement;if(S&&(S.classList.add("relative"),!S.querySelector(".contact-label-filter-icon"))){const k=document.createElement("i");k.dataset.lucide="chevron-down",k.className="contact-label-filter-icon absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none",S.appendChild(k),typeof lucide<"u"&&lucide.createIcons&&lucide.createIcons({root:S})}}function me(o){var d,v;const r=document.getElementById("contacts-table-body");if(!r)return;const c=(v=(d=window.auth.getSession())==null?void 0:d.user)==null?void 0:v.id;r.innerHTML=o.map(E=>{const S=(()=>{const k=_(E.labels,"ignorar");return k.length?k.map(oe=>{const re=y(oe,c),Z=re?te(re.color):"#848484",Q=le(Z),ne=((re==null?void 0:re.name)||oe||"").trim()||oe;return`<span class="text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full" style="background-color: ${Z}; color: ${Q};">
                        ${ne}
                    </span>`}).join(""):'<span class="text-slate-400">-</span>'})(),V=M(E.labels,"ignorar");return`
                <tr data-id="${E.id}">
                    <td class="p-4"><input type="checkbox" class="contact-checkbox form-checkbox rounded" data-id="${E.id}"></td>
                    <td class="p-4 font-medium">
                        <div class="contact-name-editable flex items-center gap-2 group" data-contact-id="${E.id}" data-original-name="${E.full_name||""}">
                            <span class="contact-name-display cursor-pointer hover:text-blue-600 hover:underline">${E.full_name||"Sin nombre"}</span>
                            <i data-lucide="edit-2" class="w-3 h-3 text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer"></i>
                            <input type="text" class="contact-name-input hidden border border-blue-500 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" value="${E.full_name||""}" data-contact-id="${E.id}">
                        </div>
                    </td>
                    <td class="p-4 text-slate-600">${E.phone_number||"-"}</td>
                    <td class="p-4 text-sm">
                        ${S}
                    </td>
                    <td class="p-4">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer ignore-ia-toggle" data-contact-id="${E.id}" ${V?"checked":""}>
                            <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </td>
                    <td class="p-4 text-center">
                        ${E.razon_de_label_auto?`
                            <div class="relative group inline-block">
                                <i data-lucide="brain-circuit" class="w-5 h-5 text-purple-500"></i>
                                <div class="absolute bottom-full mb-2 w-64 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs rounded-lg py-2 px-3 z-10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                    ${E.razon_de_label_auto}
                                </div>
                            </div>
                        `:"-"}
                    </td>
                    <td class="p-4">
                        <button class="edit-contact-btn p-2 hover:bg-slate-200 rounded-md" data-id="${E.id}" title="Editar etiquetas">
                            <i data-lucide="edit" class="w-4 h-4 text-blue-600 pointer-events-none"></i>
                        </button>
                    </td>
                </tr>
            `}).join("")}function fe(){const o=document.getElementById("contacts-table-body"),r=document.getElementById("select-all-contacts");!o||!r||(o.addEventListener("click",c=>{var E;const d=c.target.closest(".contact-name-display"),v=c.target.closest('[data-lucide="edit-2"]');if(d||v){c.stopPropagation();const S=(E=d||v)==null?void 0:E.closest(".contact-name-editable");if(S){const V=S.querySelector(".contact-name-display"),k=S.querySelector(".contact-name-input");V&&k&&(V.classList.add("hidden"),k.classList.remove("hidden"),k.focus(),k.select())}return}if(c.target.classList.contains("edit-contact-btn")||c.target.closest(".edit-contact-btn")){const V=(c.target.closest(".edit-contact-btn")||c.target).dataset.id;u.clear(),u.add(V),Ce();return}if(c.target.classList.contains("contact-checkbox")){const S=c.target.dataset.id;c.target.checked?u.add(S):u.delete(S),I();return}if(c.target.classList.contains("ignore-ia-toggle")){F(c.target);return}}),o.addEventListener("blur",c=>{const d=c.target.closest(".contact-name-input");d&&document.activeElement!==d&&It(d)},!0),o.addEventListener("keydown",c=>{const d=c.target.closest(".contact-name-input");d&&(c.key==="Enter"?(c.preventDefault(),It(d)):c.key==="Escape"&&(c.preventDefault(),ft(d)))},!0),r.addEventListener("change",c=>{const d=o.querySelectorAll(".contact-checkbox");u.clear(),d.forEach(v=>{v.checked=c.target.checked,c.target.checked&&u.add(v.dataset.id)}),I()}))}function I(){const o=document.getElementById("bulk-actions-bar"),r=document.getElementById("selected-count"),c=document.getElementById("bulk-ignore-selected-btn"),d=document.getElementById("bulk-unignore-selected-btn");u.size>0?(o.classList.remove("hidden"),r.textContent=`${u.size} seleccionado(s)`,c&&(c.disabled=!1),d&&(d.disabled=!1)):(o.classList.add("hidden"),c&&(c.disabled=!0),d&&(d.disabled=!0))}async function q(o){if(!o)return"Ignorar";try{const{data:r,error:c}=await window.auth.sb.from("labels").select("name").eq("user_id",o).limit(100);if(c)throw c;const d=Array.isArray(r)?r.find(v=>v.name&&Y(v.name)==="ignorar"):null;return(d==null?void 0:d.name)||"Ignorar"}catch(r){return console.error("Error al obtener nombre canónico de 'ignorar':",r),"Ignorar"}}async function F(o){var k,oe;const r=o.dataset.contactId,c=o.checked,d=a.find(re=>re.id==r);if(!d)return;const v=(oe=(k=window.auth.getSession())==null?void 0:k.user)==null?void 0:oe.id,E=new Set(d.labels||[]),S=Array.from(E);if(E.clear(),S.forEach(re=>{Y(re)!=="ignorar"&&E.add(re)}),c){const re=await q(v);E.add(re)}const V=Array.from(E);try{const{error:re}=await window.auth.sb.from("contacts").update({labels:V}).eq("id",r);if(re)throw re;d.labels=V}catch(re){console.error("Error al actualizar la etiqueta 'ignorar':",re),o.checked=!c}}function D(){const o=document.getElementById("bulk-ignore-selected-btn"),r=document.getElementById("bulk-unignore-selected-btn");o&&(o.disabled=!0,o.addEventListener("click",()=>K(!0))),r&&(r.disabled=!0,r.addEventListener("click",()=>K(!1)))}async function K(o){var S,V,k,oe,re;if(!u.size){(S=window.showToast)==null||S.call(window,"Selecciona al menos un contacto.","info");return}const r=o?document.getElementById("bulk-ignore-selected-btn"):document.getElementById("bulk-unignore-selected-btn");r&&(r.disabled=!0);const c=Array.from(u);let d=0;const v=(k=(V=window.auth.getSession())==null?void 0:V.user)==null?void 0:k.id,E=await q(v);try{for(const Z of c){const Q=a.find(Ae=>Ae.id==Z);if(!Q)continue;const ne=new Set(Q.labels||[]),de=Array.from(ne).some(Ae=>A(Ae,"ignorar"));if(o&&de){d+=1;continue}if(!o&&!de){d+=1;continue}const ve=Array.from(ne);ne.clear(),ve.forEach(Ae=>{Y(Ae)!=="ignorar"&&ne.add(Ae)}),o&&ne.add(E);const Ie=Array.from(ne),{error:ye}=await window.auth.sb.from("contacts").update({labels:Ie}).eq("id",Z);if(ye)throw ye;Q.labels=Ie,d+=1}await g(f),u.clear(),I(),(oe=window.showToast)==null||oe.call(window,o?"Se marcó la etiqueta ignorar en los contactos seleccionados.":"Se quitó la etiqueta ignorar de los contactos seleccionados.","success")}catch(Z){console.error("Error al aplicar la acción masiva de ignorar:",Z),(re=window.showToast)==null||re.call(window,"No se pudo actualizar la etiqueta ignorar en todos los contactos seleccionados.","error")}finally{r&&(r.disabled=!1)}}function ge(){const o=document.getElementById("ignore-all-visible-btn"),r=document.getElementById("unignore-all-visible-btn");o==null||o.addEventListener("click",()=>we(!0)),r==null||r.addEventListener("click",()=>we(!1))}function pe(o,r,c){if(!o)return;const d=o.querySelector("span");d&&(r?(o.dataset.originalLabel||(o.dataset.originalLabel=d.textContent||""),d.textContent=c,o.disabled=!0,o.classList.add("opacity-60","pointer-events-none")):(d.textContent=o.dataset.originalLabel||d.textContent,delete o.dataset.originalLabel,o.disabled=!1,o.classList.remove("opacity-60","pointer-events-none")))}function _e(o){var v;const r=o.filter(E=>E&&E.trim().length>0),c=(v=document.getElementById("contact-search-input"))==null?void 0:v.value.trim(),d=[];return r.length&&d.push(`etiqueta${r.length>1?"s":""}: ${r.join(", ")}`),c&&d.push(`búsqueda "${c}"`),d.length?`(${d.join(" · ")})`:"(todos los contactos)"}async function we(o){var E,S,V,k,oe,re,Z,Q,ne;const r=o?document.getElementById("ignore-all-visible-btn"):document.getElementById("unignore-all-visible-btn");if(!r)return;const c=(S=(E=window.auth.getSession())==null?void 0:E.user)==null?void 0:S.id;if(!c){(V=window.showToast)==null||V.call(window,"No se pudo determinar el usuario actual.","error");return}const d=R(),v=_e(d);pe(r,!0,o?"Desactivando...":"Activando...");try{let de=d.length>0&&d[0]!==""?d:null;if(!o){const Le=await q(c);(!de||de.length===0)&&(de=[Le])}const ve=((k=document.getElementById("contact-search-input"))==null?void 0:k.value.trim())||null;console.log("[contacts] Bulk ignore:",{action:o?"DESACTIVAR (agregar ignorar)":"ACTIVAR (quitar ignorar)",labelFilter:de,searchTerm:ve});const{data:Ie,error:ye}=await window.auth.sb.rpc("bulk_update_ignore_label",{p_user_id:c,p_should_ignore:o,p_label_filter:de,p_search_term:ve});if(ye)throw console.error("[contacts] Error en bulk_update_ignore_label:",ye),ye;const Ae=((oe=Ie==null?void 0:Ie[0])==null?void 0:oe.updated_count)||0;if(console.log("[contacts] Resultado:",{updatedCount:Ae,data:Ie}),await g(f),Ae===0){o?(re=window.showToast)==null||re.call(window,`No se encontraron contactos para desactivar. Los contactos ${v} ya tienen la etiqueta "ignorar".`,"info"):(Z=window.showToast)==null||Z.call(window,`No se encontraron contactos para activar. Los contactos ${v} no tienen la etiqueta "ignorar".`,"info");return}const qe=o?"desactivamos":"reactivamos";(Q=window.showToast)==null||Q.call(window,`Listo: ${qe} la IA en ${Ae} contacto(s) ${v}.`,"success")}catch(de){console.error("[contacts] Acción global ignorar:",de),(ne=window.showToast)==null||ne.call(window,"No pudimos aplicar la acción a todos los contactos.","error")}finally{pe(r,!1)}}function xe(){const o=document.getElementById("contact-search-input");if(!o)return;let r;o.addEventListener("input",()=>{clearTimeout(r),r=setTimeout(()=>{g(1)},300)})}function Se(){if(G=document.getElementById("contact-label-filter"),!!G){if(G.dataset.initialized==="true"){ie();return}G.dataset.initialized="true",G.className="w-full sm:w-60 bg-white border border-slate-200 rounded-xl text-sm px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition appearance-none",G.style.paddingRight="2.5rem",G.addEventListener("change",()=>{g(1)}),ie()}}function Ee(){document.querySelectorAll("#contacts thead th[data-sort]").forEach(r=>{r.addEventListener("click",()=>{const c=r.dataset.sort;p.column===c?p.direction=p.direction==="asc"?"desc":"asc":(p.column=c,p.direction="asc"),g(1),$()})})}async function g(o){const r=document.getElementById("contacts-loader");r.style.display="block";try{const c=await l(o);a=c,me(c),h(),x(T),W("page updated",{page:o,pageCount:c.length,total:T}),typeof lucide<"u"&&lucide.createIcons&&lucide.createIcons()}catch(c){console.error("Error al cambiar de página:",c)}finally{r.style.display="none"}}function $(){document.querySelectorAll("#contacts thead th[data-sort]").forEach(o=>{const r=o.querySelector(".sort-indicator");o.dataset.sort===p.column?r.innerHTML=p.direction==="asc"?'<i data-lucide="arrow-up" class="w-4 h-4"></i>':'<i data-lucide="arrow-down" class="w-4 h-4"></i>':r.innerHTML='<i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-400"></i>'}),lucide.createIcons()}function P(){const o=document.getElementById("edit-labels-modal");document.getElementById("cancel-labels-btn").addEventListener("click",()=>o.classList.add("hidden")),document.getElementById("bulk-edit-labels-btn").addEventListener("click",Ce),document.getElementById("new-label-form").addEventListener("submit",Me),document.getElementById("save-labels-btn").addEventListener("click",Ge)}const U=["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#FF5722","#795548","#9E9E9E","#607D8B","#FFFFFF"];function te(o){if(typeof o=="string"&&o.startsWith("#"))return o;const r=parseInt(o,10);return!isNaN(r)&&r>=0&&r<U.length?U[r]:"#848484"}function le(o){if(!o.startsWith("#"))return"#1e293b";const r=o.charAt(0)==="#"?o.substring(1,7):o,c=parseInt(r.substring(0,2),16),d=parseInt(r.substring(2,4),16),v=parseInt(r.substring(4,6),16),S=[c/255,d/255,v/255].map(k=>k<=.03928?k/12.92:Math.pow((k+.055)/1.055,2.4));return .2126*S[0]+.7152*S[1]+.0722*S[2]>.179?"#1e293b":"#ffffff"}async function Ce(){var c,d;const o=document.getElementById("edit-labels-modal"),r=document.getElementById("labels-list");o.classList.remove("hidden"),r.innerHTML='<div class="text-center text-slate-500">Cargando etiquetas...</div>';try{const v=(d=(c=window.auth.getSession())==null?void 0:c.user)==null?void 0:d.id,{data:E,error:S}=await window.auth.sb.from("labels").select("*").eq("user_id",v);if(S)throw S;n=E;const V=n.reduce((re,Z)=>(re.some(Q=>Q.name===Z.name)||re.push(Z),re),[]);V.sort((re,Z)=>re.name.localeCompare(Z.name));const k=u.size>0?a.find(re=>re.id==[...u][0]):{},oe=new Set(((k==null?void 0:k.labels)||[]).map(Y));r.innerHTML=V.map(re=>`
                <div class="flex items-center justify-between p-2 rounded-md hover:bg-slate-100">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" class="label-checkbox form-checkbox rounded" data-label-name="${re.name}" ${oe.has(Y(re.name))?"checked":""}>
                        <span class="w-4 h-4 rounded-full" style="background-color: ${te(re.color)};"></span>
                        <span>${re.name}</span>
                    </label>
                    <button class="edit-label-properties-btn p-1.5 rounded-md hover:bg-slate-200" data-label-id="${re.id}" title="Editar propiedades de la etiqueta">
                        <i data-lucide="edit" class="w-4 h-4 pointer-events-none edit-label-icon"></i>
                    </button>
                </div>
            `).join("")}catch(v){console.error("Error al cargar etiquetas:",v),r.innerHTML='<div class="text-center text-red-500">Error al cargar etiquetas.</div>'}}(Tt=document.getElementById("labels-list"))==null||Tt.addEventListener("click",o=>{const r=o.target.closest(".edit-label-properties-btn");r&&(document.getElementById("edit-labels-modal").classList.add("hidden"),window.appInstance.switchPanel("smart-labels"),setTimeout(()=>{var c;return(c=document.querySelector(`.edit-smart-label-btn[data-id="${r.dataset.labelId}"]`))==null?void 0:c.click()},200))});async function Me(o){var E,S,V;o.preventDefault();const r=document.getElementById("new-label-name"),c=document.getElementById("new-label-color"),d=r.value.trim(),v=(S=(E=window.auth.getSession())==null?void 0:E.user)==null?void 0:S.id;if(!(!d||!v))try{const k=d.charAt(0).toUpperCase()+d.slice(1).toLowerCase();if(n.find(Q=>Q.user_id===v&&Y(Q.name)===Y(k))){(V=window.showToast)==null||V.call(window,"Esta etiqueta ya existe (puede tener diferente capitalización).","info"),r.value="",Ce();return}const{data:re,error:Z}=await window.auth.sb.from("labels").insert({name:k,color:c.value,user_id:v}).select();if(Z)throw Z;if(W("label creada vía formulario",re),Array.isArray(re)&&re.length){const Q=re[0];n=n.filter(ne=>ne.id!==Q.id),n.push(Q),ie()}r.value="",Ce()}catch(k){console.error("Error al crear etiqueta:",k.message),alert(`No se pudo crear la etiqueta. Error: ${k.message}

Revisa si la columna 'evolution_label_id' en Supabase permite valores nulos.`)}}async function Ge(){var r,c,d,v;const o=document.getElementById("save-labels-btn");o.disabled=!0,o.textContent="Guardando...";try{const E=document.getElementById("new-label-name").value.trim(),S=document.getElementById("new-label-color").value,V=(c=(r=window.auth.getSession())==null?void 0:r.user)==null?void 0:c.id;let k=null;if(E&&V){const Q=E.trim().charAt(0).toUpperCase()+E.trim().slice(1).toLowerCase(),ne=n.find(de=>de.user_id===V&&Y(de.name)===Y(Q));if(ne)k=ne.name;else{const{data:de,error:ve}=await window.auth.sb.from("labels").insert({name:Q,color:S,user_id:V}).select().single();if(ve)throw new Error(`Error al crear la nueva etiqueta: ${ve.message}`);k=de.name,n.push(de)}n.push(newLabel),ie(),document.getElementById("new-label-name").value=""}const oe=new Set;document.querySelectorAll("#labels-list .label-checkbox:checked").forEach(Q=>oe.add(Q.dataset.labelName)),E&&oe.add(E);const re=new Set;document.querySelectorAll(".label-checkbox:not(:checked)").forEach(Q=>re.add(Q.dataset.labelName));const Z=[];for(const Q of u){const ne=a.find(Ie=>Ie.id==Q);if(!ne)continue;let de=new Set(ne.labels||[]);oe.forEach(Ie=>de.add(Ie)),re.forEach(Ie=>de.delete(Ie));const ve=Array.from(de);Z.push(window.auth.sb.from("contacts").update({labels:ve}).eq("id",Q))}await Promise.all(Z),(d=window.showToast)==null||d.call(window,"Etiquetas guardadas correctamente.","success"),document.getElementById("edit-labels-modal").classList.add("hidden"),Ve(oe,u),await g(f),u.clear(),I()}catch(E){console.error("Error al guardar cambios:",E),(v=window.showToast)==null||v.call(window,`No se pudieron guardar los cambios: ${E.message}`,"error")}finally{o.disabled=!1,o.textContent="Guardar Cambios"}}async function Ve(o,r){var d,v;const c=(v=(d=window.auth.getSession())==null?void 0:d.user)==null?void 0:v.id;if(!(!c||o.size===0||r.size===0))try{const{data:E}=await window.auth.sb.from("followups").select("target_label").eq("user_id",c).eq("is_active",!0),S=new Set((E||[]).map(k=>k.target_label));for(const k of o)if(S.has(k))for(const oe of r)fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/start-followup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contact_id:oe,user_id:c,target_label:k})}).catch(re=>console.error(`Error al activar seguimiento para ${oe}:`,re));const V=n.filter(k=>k.notify_on_assign&&o.has(k.name));for(const k of V)for(const oe of r){const re=a.find(Z=>Z.id==oe);re&&fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/notificarlabel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:c,contact_name:re.full_name||"Sin nombre",contact_phone:re.phone_number,assigned_label:k.name})}).catch(Z=>console.error(`Error al enviar notificación para ${oe}:`,Z))}}catch(E){console.error("Error en las acciones post-guardado:",E)}}function je(o){if(o==null)return"";const r=String(o);return/[",\n]/.test(r)?'"'+r.replace(/"/g,'""')+'"':r}async function $e(o){const r=(o.name||"").toLowerCase();if(r.endsWith(".xlsx")||r.endsWith(".xls")){if(typeof XLSX>"u")throw new Error("No se pudo cargar el lector de hojas de cálculo (XLSX). Recarga la página e intenta nuevamente.");const c=await o.arrayBuffer(),d=XLSX.read(c,{type:"array"});if(!d.SheetNames.length)throw new Error("El archivo de Excel no contiene hojas válidas.");const v=d.Sheets[d.SheetNames[0]];return XLSX.utils.sheet_to_csv(v,{FS:",",RS:`
`})}return await o.text()}async function Fe(o,r){if(!o||!o.length||!r)return;const c=new Map;for(const Z of o){const Q=Z==null?void 0:Z.trim();if(!Q)continue;const ne=Q.charAt(0).toUpperCase()+Q.slice(1).toLowerCase(),de=ne.toLowerCase();c.has(de)||c.set(de,ne)}const d=Array.from(c.values());if(!d.length)return;W("verificando etiquetas detectadas",d);const v=await Promise.all(d.map(async Z=>{try{const{data:Q,error:ne}=await window.auth.sb.rpc("get_canonical_label_name",{p_user_id:r,p_label_name:Z});if(ne)throw ne;return Q||Z}catch(Q){return console.warn(`Error al obtener nombre canónico para "${Z}":`,Q),Z}}));if(!n.length)try{n=await e()}catch(Z){throw console.error("No se pudo cargar la lista de etiquetas:",Z),new Error("No se pudo cargar la lista de etiquetas actuales.")}const E=new Map(n.filter(Z=>Z.user_id===r).map(Z=>[Z.name.toLowerCase(),Z])),S=v.map(Z=>{const Q=E.get(Z.toLowerCase());return{name:Z,color:(Q==null?void 0:Q.color)||Ke(),isNew:!Q}});if(!S.length)return;W("colores de etiquetas asignados automáticamente",S);const V=S.filter(Z=>{const Q=E.get(Z.name.toLowerCase());return Q?(Q.color||"").toLowerCase()!==Z.color.toLowerCase():!0}).map(Z=>({user_id:r,name:Z.name,color:Z.color}));if(!V.length){S.forEach(Z=>{const Q=Z.name.toLowerCase(),ne=E.get(Q);ne&&(ne.color=Z.color)});return}const{data:k,error:oe}=await window.auth.sb.from("labels").upsert(V,{onConflict:"user_id,name"}).select();if(oe)throw console.warn("Error en upsert inicial, intentando con nombres canónicos:",oe),oe;W("etiquetas upsert",{requested:V.length,persisted:(k==null?void 0:k.length)??0});const re=new Map((k||[]).map(Z=>[Z.name.toLowerCase(),Z]));S.forEach(Z=>{const Q=Z.name.toLowerCase(),ne=re.get(Q);let de=n.find(ve=>ve.user_id===r&&ve.name.toLowerCase()===Q);de?(de.color=Z.color,de.name=(ne==null?void 0:ne.name)||de.name,ne!=null&&ne.id&&(de.id=ne.id)):ne&&n.push({id:ne.id,user_id:r,name:ne.name,color:ne.color||Z.color}),E.set(Q,{id:(ne==null?void 0:ne.id)||(de==null?void 0:de.id)||null,user_id:r,name:(ne==null?void 0:ne.name)||(de==null?void 0:de.name)||Z.name,color:Z.color})}),ie()}function Ke(){const o=()=>Math.floor(180+Math.random()*60),r=o().toString(16).padStart(2,"0"),c=o().toString(16).padStart(2,"0"),d=o().toString(16).padStart(2,"0");return`#${r}${c}${d}`}async function Mt(o){var V,k,oe,re,Z,Q,ne,de,ve,Ie;const r=o.target,c=(V=r==null?void 0:r.files)==null?void 0:V[0];if(!c)return;b();const d=[],v=[];let E=null,S=[];try{let ye=await _t().catch(()=>null);if(ye)try{const{data:ze,error:ot}=await window.auth.sb.from("apps").select("id").eq("id",ye).single();(ot||!ze)&&(console.warn("[contacts-import] app_id no válido, se omitirá:",ye),ye=null)}catch(ze){console.warn("[contacts-import] Error al validar app_id:",ze),ye=null}const qe=(await $e(c)).split(/\r?\n/).map(ze=>ze.trim()).filter(ze=>ze.length>0);if(W("archivo leído",{name:c.name,lineCount:qe.length}),!qe.length){(k=window.showToast)==null||k.call(window,"El archivo de contactos está vacío.","info");return}const Le=ct(qe[0]).map(ze=>ze.trim());if(E=await Pt(Le),W("mapeo de columnas",{headers:Le,mapping:E}),!E){(oe=window.showToast)==null||oe.call(window,"Importación cancelada.","info");return}const Pe=qe.slice(1),Te=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),ke=Te?Te.id:(Z=(re=window.auth.getSession())==null?void 0:re.user)==null?void 0:Z.id;if(W("targetUserId detectado",ke),!ke)throw new Error("No se pudo determinar el usuario destino para la importación.");const{data:De,error:Ue}=await window.auth.sb.from("contacts").select("id, phone_number, labels, full_name, followup_status, current_followup_id, followup_step_sent, last_followup_sent_at, chatwoot_contact_id, assigned_to_id, razon_de_label_auto, created_at").eq("user_id",ke);if(Ue)throw Ue;const Ye=new Map;(De||[]).forEach(ze=>{const ot=at(ze.phone_number);ot&&(Array.isArray(ze.labels)||(ze.labels=ze.labels?[ze.labels]:[]),Ye.set(ot,ze))});const Xe=new Map,He=new Set;if(Pe.forEach((ze,ot)=>{var $t,qt;const ut=ot+2,bt=ct(ze),mt=($t=pt(bt,E.phone_number))==null?void 0:$t.trim();if(!mt){d.push({rowNumber:ut,reason:"Sin telefono",rawPhone:mt});return}const st=at(mt);if(!st){d.push({rowNumber:ut,reason:"Telefono invalido",rawPhone:mt});return}const Oe=Ye.get(st);W("fila procesada",{rowNumber:ut,normalizedPhone:st,existing:!!Oe});const et={user_id:ke,phone_number:st};ye&&(et.app_id=ye);const rt=(qt=pt(bt,E.full_name))==null?void 0:qt.trim();Oe!=null&&Oe.full_name&&!tt(Oe.full_name)?tt(rt)?et.full_name=Oe.full_name:rt?et.full_name=rt:et.full_name=Oe.full_name:rt&&!tt(rt)&&(et.full_name=rt);const wt=new Set;Oe!=null&&Oe.labels&&(Array.isArray(Oe.labels)?Oe.labels:[Oe.labels]).filter(Boolean).map(lt=>String(lt).trim()).filter(lt=>lt.length>0).forEach(lt=>wt.add(lt));const At=vt(pt(bt,E.labels));At&&At.map(Qe=>String(Qe).trim()).filter(Qe=>Qe&&Qe.length>0&&Qe.toLowerCase()!=="ignorar").forEach(Qe=>wt.add(Qe));const it=Array.from(wt).filter(Boolean);et.labels=it.length>0?it:(Oe==null?void 0:Oe.labels)||[],(it.length?it:[]).forEach(Qe=>{Qe.toLowerCase()!=="ignorar"&&He.add(Qe)}),Xe.set(st,Et(et)),v.push({rowNumber:ut,phone:st,fullName:et.full_name||"",labels:it.join(", ")})}),W("contactsToUpsert size",Xe.size),He.size>0&&await Fe(Array.from(He),ke),S=Array.from(Xe.values()),W("payload preparado",{totalRows:Pe.length,payloadCount:S.length,skipped:d.length,sample:S.slice(0,3),phones:S.map(ze=>ze.phone_number)}),window.lastContactImport={stage:"beforeUpsert",totalRows:Pe.length,processedRows:v,skippedRows:d,mapping:E,finalPayload:S,targetUserId:ke},!S.length){window.lastContactImport={totalRows:Pe.length,processedRows:v,skippedRows:d,finalPayload:S},d.length&&(console.warn("Importacion de contactos sin filas validas.",{skippedRows:d,headers:Le,mapping:E}),typeof console.table=="function"&&console.table(d)),(Q=window.showToast)==null||Q.call(window,d.length>0?`No se detectaron contactos válidos. ${d.length} filas omitidas.`:"El archivo no contiene contactos para importar.","warning");return}const{data:We,error:dt}=await window.auth.sb.from("contacts").upsert(S,{onConflict:"user_id,phone_number"}).select("id, phone_number, user_id");if(dt)throw dt;W("upsert completado",{insertedOrUpdated:(We==null?void 0:We.length)??0,sample:(ne=We==null?void 0:We.slice)==null?void 0:ne.call(We,0,3)}),window.lastContactImport={stage:"afterUpsert",totalRows:Pe.length,processedRows:v,skippedRows:d,finalPayload:S,upserted:We,targetUserId:ke},typeof console.table=="function"&&v.length&&console.table(v),d.length&&(console.warn("Filas omitidas durante la importacion.",d),typeof console.table=="function"&&console.table(d),(de=window.showToast)==null||de.call(window,`${d.length} filas se omitieron. Revisa la consola para detalles.`,"info")),console.info("Resumen de la importacion de contactos",{totalRows:Pe.length,enviados:S.length,omitidos:d.length,vistaPrevia:v.slice(0,10)});const Re=`${S.length} contactos importados/actualizados con exito.`;(ve=window.showToast)==null||ve.call(window,Re,"success"),await i()}catch(ye){if(W("error durante importación",ye),(ye==null?void 0:ye.message)==="IMPORTACION_CANCELADA")return;const Ae=(ye==null?void 0:ye.details)||(ye==null?void 0:ye.hint)||"",qe=ye!=null&&ye.message?`Error al importar: ${ye.message}`:"Error desconocido al importar contactos.",Le=Ae?`${qe} (${Ae})`:qe;console.error("Error al importar contactos:",{error:ye,finalPayload:S,skippedRows:d,processedRows:v,mapping:E}),window.lastContactImport={stage:"error",error:ye,finalPayload:S,skippedRows:d,processedRows:v,mapping:E},(Ie=window.showToast)==null||Ie.call(window,Le,"error")}finally{r&&(r.value="")}}function ct(o){const r=[];let c="",d=!1;for(let v=0;v<o.length;v++){const E=o[v];E==='"'&&(v===0||o[v-1]!=='"')?d&&o[v+1]==='"'?(c+='"',v++):d=!d:E===","&&!d?(r.push(c.trim()),c=""):c+=E}return r.push(c.trim()),r}async function Pt(o){const r=[{field:"phone_number",label:"Teléfono",required:!0,aliases:["phone_number","telefono","teléfono","tel","phone","mobile","celular","whatsapp"]},{field:"full_name",label:"Nombre",required:!1,aliases:["full_name","nombre","name","contacto"]},{field:"labels",label:"Etiquetas",required:!1,aliases:["labels","etiquetas","tags"]}];return typeof window.openColumnMappingModal=="function"?await window.openColumnMappingModal(r,o):Dt(o,r)}function Dt(o,r){const c={},d=new Set,v=o.map(E=>E.toLowerCase());for(const E of r){let S=-1;for(const V of E.aliases||[]){const k=v.indexOf(V.toLowerCase());if(k!==-1&&!d.has(k)){S=k;break}}if(S===-1&&(S=o.findIndex((V,k)=>!d.has(k))),S===-1){if(E.required)return null;continue}c[E.field]=S,d.add(S)}return c}function pt(o,r){return typeof r!="number"||r<0||r>=o.length?"":o[r]}function vt(o){if(!o)return null;const r=o.trim();if(!r)return null;try{const v=JSON.parse(r);if(Array.isArray(v)){const E=v.map(S=>String(S??"").trim()).filter(Boolean);if(E.length)return E}}catch{}const d=r.replace(/^\[(.*)\]$/,"$1").replace(/\r?\n/g,",").split(/[;,|]/).map(v=>v.trim()).filter(Boolean);return d.length?d:null}function at(o){if(!o)return"";const r=String(o).replace(/\D+/g,"");return r.length<10?"":"+521"+r.slice(-10)}function Et(o){const r={};return Object.entries(o||{}).forEach(([c,d])=>{d!==void 0&&(Array.isArray(d)&&d.length===0&&c==="labels"||(r[c]=d))}),r}function tt(o){if(!o)return!0;const r=o.trim().toLowerCase();return["sin nombre","sin-nombre","sin_nombre","sinnombre","n/a","na","none","null",""].includes(r)}async function It(o){var S,V,k;const r=o.dataset.contactId,c=o.value.trim(),d=o.closest(".contact-name-editable"),v=d==null?void 0:d.querySelector(".contact-name-display"),E=(d==null?void 0:d.dataset.originalName)||"";if(r){if(tt(c)){o.value=E||"",ft(o),(S=window.showToast)==null||S.call(window,'El nombre no puede estar vacío o ser "sin nombre".',"warning");return}try{const{error:oe}=await window.auth.sb.from("contacts").update({full_name:c}).eq("id",r);if(oe)throw oe;v&&(v.textContent=c,d.dataset.originalName=c);const re=a.find(Z=>Z.id===r);re&&(re.full_name=c),o.classList.add("hidden"),v==null||v.classList.remove("hidden"),(V=window.showToast)==null||V.call(window,"Nombre actualizado correctamente.","success")}catch(oe){console.error("Error al actualizar nombre:",oe),(k=window.showToast)==null||k.call(window,`Error al actualizar nombre: ${oe.message}`,"error"),ft(o)}}}function ft(o){const r=o.closest(".contact-name-editable"),c=r==null?void 0:r.querySelector(".contact-name-display"),d=(r==null?void 0:r.dataset.originalName)||"";o.value=d,o.classList.add("hidden"),c==null||c.classList.remove("hidden")}function xt(){var r,c,d;const o=(r=window.appInstance)==null?void 0:r.teamInfo;return(o==null?void 0:o.active_app_id)||(o==null?void 0:o.app_id)||(o==null?void 0:o.default_app_id)||((d=(c=o==null?void 0:o.apps)==null?void 0:c[0])==null?void 0:d.id)||(o==null?void 0:o.team_id)||null}async function _t(){var c;const o=xt();if(o)return o;if((c=window.appInstance)!=null&&c.loadTeamInfo){try{await window.appInstance.loadTeamInfo()}catch(v){console.warn("[contacts-import] No se pudo refrescar teamInfo:",v)}const d=xt();if(d)return d}return localStorage.getItem("active_app_id")||null}async function Lt(){var c;const o=document.getElementById("sync-contacts-btn"),r=document.getElementById("contacts-status-container");if(!(!o||!r)){o.disabled=!0;try{const d=window.auth.getSession(),v=(c=d==null?void 0:d.user)==null?void 0:c.id;if(!v)return;const{data:E,error:S}=await window.auth.sb.from("profiles").select("whatsapp_connected, sync_status").eq("id",v).single();if(S)throw S;const V=E==null?void 0:E.whatsapp_connected,k=E==null?void 0:E.sync_status;if(!V){r.innerHTML=`
                    <div class="bg-amber-100 border-l-4 border-amber-500 text-amber-800 p-4 rounded-r-lg">
                        <h4 class="font-bold">Acción requerida</h4>
                        <p class="text-sm mt-1">Debes conectar tu WhatsApp en el panel de <strong>Dashboard</strong> antes de poder sincronizar tus contactos.</p>
                    </div>`,o.disabled=!0,o.innerHTML="Sincronizar Contactos y Etiquetas";return}k==="processing"?(r.innerHTML=`
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg animate-pulse">
                        <p class="text-sm font-medium">Hay una sincronización en progreso. La tabla se actualizará automáticamente al finalizar.</p>
                    </div>`,o.disabled=!0,Bt()):(r.innerHTML="",o.disabled=!1,o.innerHTML="Sincronizar Contactos y Etiquetas")}catch(d){console.error("Error al verificar pre-requisitos de sincronización:",d),o.disabled=!1,o.innerHTML="Sincronizar Contactos y Etiquetas"}}}function zt(){const o=document.getElementById("sync-contacts-btn");o&&o.addEventListener("click",async()=>{var c;if(t)return;const r=(c=window.auth.getSession())==null?void 0:c.user;if(!r){alert("Error: No se encontró sesión de usuario.");return}t=!0,o.disabled=!0,o.innerHTML='<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';try{const{data:d,error:v}=await window.auth.invokeFunction("sync-contacts",{body:{user_id:r.id}});if(v)throw new Error(v.message||"Error al iniciar la sincronización.");const E=document.getElementById("contacts-status-container");E&&(E.innerHTML=`
                        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg">
                            <h4 class="font-bold">Sincronización en progreso...</h4>
                            <p class="text-sm mt-1">Esto puede tardar varios minutos dependiendo de la cantidad de contactos. Te avisaremos cuando esté listo. Puedes seguir usando la aplicación.</p>
                        </div>`),Bt()}catch(d){console.error("Error al iniciar la sincronización:",d),alert("Error al iniciar la sincronización."),o.disabled=!1,o.innerHTML="Sincronizar Contactos y Etiquetas"}finally{t=!1}})}function Bt(){var c;const o=window.auth.getSession(),r=(c=o==null?void 0:o.user)==null?void 0:c.id;!r||N||(N=setInterval(async()=>{var d;try{const{data:v,error:E}=await window.auth.sb.from("profiles").select("sync_status").eq("id",r).single();if(E)throw E;const S=v==null?void 0:v.sync_status;if(S!=="processing"){clearInterval(N),N=null;const V=document.getElementById("contacts-status-container");V&&(V.innerHTML="");const k=document.getElementById("sync-contacts-btn");k&&(k.disabled=!1,k.innerHTML="Sincronizar Contactos y Etiquetas"),S==="completed"&&((d=window.showToast)==null||d.call(window,"Sincronización completada. La tabla se ha actualizado.","success"))}}catch(v){console.error("Error durante el seguimiento de la sincronización:",v),clearInterval(N),N=null;const E=document.getElementById("sync-contacts-btn");E&&(E.disabled=!1,E.innerHTML="Sincronizar Contactos y Etiquetas")}},1e4))}function jt(){var r,c;if(z)return;const o=(c=(r=window.auth.getSession())==null?void 0:r.user)==null?void 0:c.id;o&&(console.log("Suscribiéndose a cambios en la tabla de Contactos..."),z=window.auth.sb.channel("public:contacts:contacts-table").on("postgres_changes",{event:"*",schema:"public",table:"contacts",filter:`user_id=eq.${o}`},d=>{console.log("Cambio recibido en Contactos:",d),clearTimeout(H),H=setTimeout(()=>{var v;(v=window.showToast)==null||v.call(window,"La lista de contactos se ha actualizado.","info"),i()},2e3)}).subscribe())}function Ft(){if(z){console.log("Desuscribiéndose de los cambios de Contactos.");try{window.auth.sb.removeChannel(z)}catch(o){console.error("Error al desuscribir del canal de contactos:",o)}z=null}b()}let Ne={file:null,fileType:null,selectedSheet:null,workbook:null,headers:[],data:[],mapping:null,listName:null};function gt(){var V;const o=document.getElementById("verify-contacts-file-modal");if(!o){(V=window.showToast)==null||V.call(window,"Error: No se encontró el modal de verificación.","error");return}Ne={file:null,fileType:null,selectedSheet:null,workbook:null,headers:[],data:[],mapping:null,listName:null};const r=document.getElementById("verify-contacts-file-input");r&&(r.value=""),o.classList.remove("hidden"),document.body.classList.add("overflow-hidden");const c=document.getElementById("close-verify-file-modal-btn"),d=document.getElementById("cancel-verify-file-btn"),v=document.getElementById("confirm-verify-file-btn"),E=document.getElementById("verify-contacts-file-input"),S=()=>{o.classList.add("hidden"),document.body.classList.remove("overflow-hidden")};c&&(c.onclick=S),d&&(d.onclick=S),v&&(v.onclick=async()=>{var k;try{if(!((k=E==null?void 0:E.files)!=null&&k[0])){Je("verify-file-error","Por favor selecciona un archivo.");return}const oe=E.files[0];if(!oe||oe.size===0){Je("verify-file-error","El archivo seleccionado está vacío o no es válido.");return}await Ut(oe)}catch(oe){console.error("Error al seleccionar archivo:",oe),Je("verify-file-error",`Error: ${oe.message||"No se pudo leer el archivo. Asegúrate de que el archivo no esté corrupto."}`)}}),typeof(lucide==null?void 0:lucide.createIcons)=="function"&&lucide.createIcons()}async function Ut(o){var r;try{const c=document.getElementById("verify-file-error");c&&c.classList.add("hidden");const d=50*1024*1024;if(o.size>d){Je("verify-file-error",`El archivo es muy grande (${(o.size/1024/1024).toFixed(2)}MB). El tamaño máximo es 50MB.`);return}const v=(r=o.name.split(".").pop())==null?void 0:r.toLowerCase();if(!["csv","xlsx","xls"].includes(v)){Je("verify-file-error","Formato no soportado. Usa CSV, XLSX o XLS.");return}const E=document.getElementById("confirm-verify-file-btn");E&&(E.disabled=!0,E.innerHTML='<span class="animate-spin">⏳</span> Cargando...'),Ne.file=o,Ne.fileType=v,v==="csv"?await St():await Rt(o),E&&(E.disabled=!1,E.textContent="Continuar")}catch(c){console.error("Error al procesar archivo:",c);const d=c.message||"Error desconocido al procesar el archivo.";Je("verify-file-error",`Error: ${d}`);const v=document.getElementById("confirm-verify-file-btn");v&&(v.disabled=!1,v.textContent="Continuar")}}async function Rt(o){var r,c;try{if(typeof XLSX>"u")throw new Error("No se pudo cargar el lector de hojas de cálculo (XLSX). Recarga la página.");(r=window.showToast)==null||r.call(window,"Leyendo archivo Excel, por favor espera...","info");const d=await o.arrayBuffer(),v=XLSX.read(d,{type:"array",sheetStubs:!0,cellDates:!1,cellNF:!1,cellStyles:!1});Ne.workbook=v;const E=v.SheetNames;if(E.length===0)throw new Error("El archivo Excel no contiene hojas válidas.");const S=document.getElementById("verify-contacts-file-modal");S&&S.classList.add("hidden");const V=document.getElementById("verify-contacts-sheet-modal");if(!V)throw new Error("No se encontró el modal de selección de hoja.");const k=document.getElementById("verify-sheet-select");k&&(k.innerHTML="",E.forEach((ne,de)=>{const ve=document.createElement("option");ve.value=de,ve.textContent=ne,k.appendChild(ve)})),V.classList.remove("hidden"),document.body.classList.add("overflow-hidden");const oe=document.getElementById("close-verify-sheet-modal-btn"),re=document.getElementById("cancel-verify-sheet-btn"),Z=document.getElementById("confirm-verify-sheet-btn"),Q=()=>{V.classList.add("hidden"),document.body.classList.remove("overflow-hidden"),gt()};oe&&(oe.onclick=Q),re&&(re.onclick=Q),Z&&(Z.onclick=()=>{const ne=parseInt(k==null?void 0:k.value);if(isNaN(ne)){Je("verify-sheet-error","Por favor selecciona una hoja.");return}Ne.selectedSheet=ne,V.classList.add("hidden"),St()}),typeof(lucide==null?void 0:lucide.createIcons)=="function"&&lucide.createIcons()}catch(d){console.error("Error al leer archivo Excel:",d);let v="Error al leer el archivo Excel.";d.message?v=d.message:d.name==="QuotaExceededError"||d.name==="RangeError"?v="El archivo es demasiado grande para procesar en el navegador. Intenta dividirlo en archivos más pequeños.":d.message&&d.message.includes("Failed to fetch")&&(v="Error al leer el archivo. Asegúrate de que el archivo no esté abierto en otro programa y vuelve a intentarlo."),Je("verify-file-error",v),(c=window.showToast)==null||c.call(window,v,"error");const E=document.getElementById("confirm-verify-file-btn");E&&(E.disabled=!1,E.textContent="Continuar")}}async function St(){var o,r,c,d,v,E;try{(o=window.showToast)==null||o.call(window,"Procesando archivo, esto puede tardar unos momentos...","info");let S="";if(Ne.fileType==="csv")S=await Ne.file.text();else{if((r=window.showToast)==null||r.call(window,"Leyendo datos de la hoja seleccionada...","info"),!Ne.workbook||!Ne.workbook.Sheets){const Ie=await Ne.file.arrayBuffer();Ne.workbook=XLSX.read(Ie,{type:"array",cellDates:!1,cellNF:!1,cellStyles:!1})}const Q=Ne.workbook,ne=Ne.selectedSheet??0,de=Q.SheetNames[ne],ve=Q.Sheets[de];S=XLSX.utils.sheet_to_csv(ve,{FS:",",RS:`
`,blankrows:!1})}(c=window.showToast)==null||c.call(window,"Analizando estructura del archivo...","info");const V=S.split(/\r?\n/).map(Q=>Q.trim()).filter(Q=>Q.length>0);if(!V.length)throw new Error("El archivo está vacío.");const k=1e5,oe=V.length>k?V.slice(0,k+1):V;V.length>k&&((d=window.showToast)==null||d.call(window,`El archivo tiene ${V.length} filas. Se procesarán las primeras ${k} filas.`,"warning"));const re=ct(oe[0]).map(Q=>Q.trim()),Z=oe.slice(1).map(Q=>ct(Q));Ne.headers=re,Ne.data=Z,(v=window.showToast)==null||v.call(window,"Archivo procesado correctamente.","success"),await Ot()}catch(S){console.error("Error al procesar archivo:",S);let V="Error desconocido al procesar el archivo.";S.message?V=S.message:S.name==="QuotaExceededError"||S.name==="RangeError"?V="El archivo es demasiado grande. Intenta dividirlo en archivos más pequeños (máximo 100,000 filas).":S.message&&S.message.includes("Failed to fetch")&&(V="Error al leer el archivo. Asegúrate de que el archivo no esté abierto en otro programa."),Je("verify-file-error",`Error: ${V}`),(E=window.showToast)==null||E.call(window,`Error: ${V}`,"error");const k=document.getElementById("verify-contacts-file-modal"),oe=document.getElementById("verify-contacts-sheet-modal");k&&k.classList.add("hidden"),oe&&oe.classList.add("hidden"),document.body.classList.remove("overflow-hidden")}}async function Ot(){const o=document.getElementById("verify-contacts-mapping-modal");if(!o)throw new Error("No se encontró el modal de mapeo.");const r=document.getElementById("verify-contacts-file-modal"),c=document.getElementById("verify-contacts-sheet-modal");r&&r.classList.add("hidden"),c&&c.classList.add("hidden");const d=document.getElementById("verify-preview-headers"),v=document.getElementById("verify-preview-body");d&&v&&(d.innerHTML="",v.innerHTML="",Ne.headers.forEach(ne=>{const de=document.createElement("th");de.className="px-3 py-2 text-left font-semibold text-slate-700",de.textContent=ne,d.appendChild(de)}),Ne.data.slice(0,10).forEach(ne=>{const de=document.createElement("tr");ne.forEach(ve=>{const Ie=document.createElement("td");Ie.className="px-3 py-2 text-slate-600",Ie.textContent=ve||"",de.appendChild(Ie)}),v.appendChild(de)}));const E=[{field:"phone_number",label:"Teléfono",required:!0,aliases:["phone_number","telefono","teléfono","tel","phone","mobile","celular","whatsapp","numero","número"]},{field:"full_name",label:"Nombre",required:!1,aliases:["full_name","nombre","name","contacto"]},{field:"labels",label:"Etiquetas",required:!1,aliases:["labels","etiquetas","tags"]}],S=document.getElementById("verify-column-mapping-table-body");if(S){S.innerHTML="";const Q=[];E.forEach(de=>{const ve=document.createElement("tr");ve.innerHTML=`
                    <td class="px-4 py-3">
                        <div class="flex flex-col">
                            <span class="font-medium text-slate-700">${de.label}</span>
                            <span class="mt-1 text-xs ${de.required?"text-red-500 font-semibold":"text-slate-400"}">${de.required?"Obligatorio":"Opcional"}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <select class="verify-column-select w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" data-field="${de.field}" data-required="${de.required}">
                            <option value="">${de.required?"Selecciona una columna":"Dejar sin asignar"}</option>
                        </select>
                    </td>
                `;const Ie=ve.querySelector("select");Q.push(Ie),Ne.headers.forEach((Ae,qe)=>{const Le=document.createElement("option");Le.value=String(qe),Le.textContent=Ae,Ie.appendChild(Le)});const ye=Ne.headers.map(Ae=>Ae.toLowerCase());for(const Ae of de.aliases||[]){const qe=ye.indexOf(Ae.toLowerCase());if(qe!==-1){Ie.value=String(qe);break}}S.appendChild(ve)});const ne=()=>{const de=new Set(Q.map(ve=>ve.value).filter(Boolean));Q.forEach(ve=>{Array.from(ve.options).forEach(Ie=>{Ie.value&&(Ie.disabled=ve.value!==Ie.value&&de.has(Ie.value))})})};Q.forEach(de=>{de.addEventListener("change",ne)}),ne()}o.classList.remove("hidden"),document.body.classList.add("overflow-hidden");const V=document.getElementById("close-verify-mapping-modal-btn"),k=document.getElementById("cancel-verify-mapping-btn"),oe=document.getElementById("confirm-verify-mapping-btn"),re=document.getElementById("verify-list-name-input"),Z=()=>{o.classList.add("hidden"),document.body.classList.remove("overflow-hidden")};V&&(V.onclick=Z),k&&(k.onclick=Z),oe&&(oe.onclick=async()=>{var Ie;const Q=(Ie=re==null?void 0:re.value)==null?void 0:Ie.trim();if(!Q){Je("verify-mapping-error","Por favor ingresa un nombre para la lista/etiqueta.");return}const ne={},de=document.querySelectorAll(".verify-column-select");let ve=!1;if(de.forEach(ye=>{const Ae=ye.dataset.field,qe=ye.dataset.required==="true",Le=ye.value;!Le&&qe?(ye.classList.add("border-red-500"),ve=!0):(ye.classList.remove("border-red-500"),Le&&(ne[Ae]=Number(Le)))}),ve){Je("verify-mapping-error","Por favor completa todos los campos obligatorios.");return}Ne.mapping=ne,Ne.listName=Q,Z(),await Ht()}),typeof(lucide==null?void 0:lucide.createIcons)=="function"&&lucide.createIcons()}function Je(o,r){const c=document.getElementById(o);c&&(c.textContent=r,c.classList.remove("hidden"))}async function Ht(){var o,r,c,d,v,E;try{(o=window.showToast)==null||o.call(window,"Procesando archivo y extrayendo números...","info");const S=[],V=[];if(Ne.data.forEach((ne,de)=>{var Pe,Te,ke;const ve=Ne.mapping.phone_number;if(ve==null)return;const Ie=(Pe=ne[ve])==null?void 0:Pe.trim();if(!Ie)return;const ye=at(Ie);if(!ye)return;const Ae={phone:ye,rowIndex:de+2},qe=Ne.mapping.full_name;qe!=null&&(Ae.name=((Te=ne[qe])==null?void 0:Te.trim())||"");const Le=Ne.mapping.labels;if(Le!=null){const De=(ke=ne[Le])==null?void 0:ke.trim();De&&(Ae.labels=vt(De)||[])}S.push(ye),V.push(Ae)}),S.length===0){(r=window.showToast)==null||r.call(window,"No se encontraron números válidos en el archivo.","warning");return}(c=window.showToast)==null||c.call(window,`Verificando ${S.length} números con WhatsApp...`,"info");const k=window.auth.getSession(),oe=(d=k==null?void 0:k.user)==null?void 0:d.id;if(!oe)throw new Error("No se pudo obtener la sesión del usuario.");const Z=await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/verificar-contactos",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({numbers:S,userId:oe,listName:Ne.listName,contactData:V})});if(!Z.ok){const ne=await Z.text();throw new Error(`Error del servidor: ${ne||Z.statusText}`)}const Q=await Z.json();if(!Q.verifiedNumbers||Q.verifiedNumbers.length===0){(v=window.showToast)==null||v.call(window,`Ninguno de los ${Q.totalProcessed||S.length} números verificados tiene WhatsApp.`,"warning");return}await Gt(Q,Ne.listName)}catch(S){console.error("Error en verificación de contactos:",S),(E=window.showToast)==null||E.call(window,`Error: ${S.message}`,"error")}}async function Gt(o,r){var c,d,v,E,S;try{(c=window.showToast)==null||c.call(window,"Importando contactos verificados...","info");const V=window.auth.getSession(),k=(d=V==null?void 0:V.user)==null?void 0:d.id;if(!k)throw new Error("No se pudo obtener la sesión del usuario.");let oe=await _t().catch(()=>null);if(oe)try{const{data:Te,error:ke}=await window.auth.sb.from("apps").select("id").eq("id",oe).single();(ke||!Te)&&(console.warn("[contacts-verify] app_id no válido, se omitirá:",oe),oe=null)}catch(Te){console.warn("[contacts-verify] Error al validar app_id:",Te),oe=null}const re=o.verifiedNumbers||[],Z=new Map;o.contactData&&o.contactData.forEach(Te=>{Z.set(Te.phone,Te)});const{data:Q,error:ne}=await window.auth.sb.from("contacts").select("id, phone_number, labels, full_name").eq("user_id",k);if(ne)throw ne;const de=new Map;(Q||[]).forEach(Te=>{const ke=at(Te.phone_number);ke&&(Array.isArray(Te.labels)||(Te.labels=Te.labels?[Te.labels]:[]),de.set(ke,Te))});const ve=[],Ie=new Set([r]);if(re.forEach(Te=>{var We;const ke=de.get(Te),De=Z.get(Te)||{},Ue={user_id:k,phone_number:Te};oe&&(Ue.app_id=oe);const Ye=(We=De.name)==null?void 0:We.trim();ke!=null&&ke.full_name&&!tt(ke.full_name)?tt(Ye)?Ue.full_name=ke.full_name:Ye?Ue.full_name=Ye:Ue.full_name=ke.full_name:Ye&&!tt(Ye)&&(Ue.full_name=Ye);const Xe=new Set;ke!=null&&ke.labels&&(Array.isArray(ke.labels)?ke.labels:[ke.labels]).filter(Boolean).map(Re=>String(Re).trim()).filter(Re=>Re.length>0).forEach(Re=>Xe.add(Re)),r&&r.trim()&&Xe.add(r.trim()),De.labels&&(Array.isArray(De.labels)?De.labels:[De.labels]).map(Re=>String(Re).trim()).filter(Re=>Re&&Re.length>0&&Re.toLowerCase()!=="ignorar").forEach(Re=>{Xe.add(Re),Ie.add(Re)});const He=Array.from(Xe).filter(Boolean);Ue.labels=He.length>0?He:(ke==null?void 0:ke.labels)||[],ve.push(Et(Ue))}),ve.length===0){(v=window.showToast)==null||v.call(window,"No hay contactos para importar.","warning");return}Ie.size>0&&await Fe(Array.from(Ie),k);const ye=100;let Ae=0,qe=[];for(let Te=0;Te<ve.length;Te+=ye){const ke=ve.slice(Te,Te+ye);try{const{data:De,error:Ue}=await window.auth.sb.from("contacts").upsert(ke,{onConflict:"user_id,phone_number"}).select("id, phone_number, user_id");Ue?(console.error(`[contacts-verify] Error en lote ${Math.floor(Te/ye)+1}:`,Ue),qe.push({batch:Math.floor(Te/ye)+1,error:Ue})):Ae+=(De==null?void 0:De.length)||0}catch(De){console.error(`[contacts-verify] Error al procesar lote ${Math.floor(Te/ye)+1}:`,De),qe.push({batch:Math.floor(Te/ye)+1,error:De})}}if(qe.length>0&&Ae===0)throw new Error(`Error al importar contactos: ${qe[0].error.message||"Error desconocido"}`);const Le={length:Ae},Pe=`${(Le==null?void 0:Le.length)||0} contactos verificados importados con la etiqueta "${r}".`;(E=window.showToast)==null||E.call(window,Pe,"success"),await i()}catch(V){console.error("Error al importar contactos verificados:",V),(S=window.showToast)==null||S.call(window,`Error al importar: ${V.message}`,"error")}}window.contacts={openLabelsModalForSingleContact:o=>{o&&(u.clear(),u.add(o),Ce())},logLastImport:()=>(console.info("[contacts-import] lastContactImport snapshot:",window.lastContactImport),window.lastContactImport),async verifySupabaseAccess(o=5){var r;try{const c=window.auth.getSession(),d=(r=c==null?void 0:c.user)==null?void 0:r.id;if(!d)return console.warn("[contacts-import] verifySupabaseAccess: no active session"),null;const{data:v,error:E}=await window.auth.sb.from("contacts").select("id, user_id, phone_number, created_at").eq("user_id",d).order("created_at",{ascending:!1}).limit(o);if(E)throw E;return console.info("[contacts-import] verifySupabaseAccess result:",v),v}catch(c){return console.error("[contacts-import] verifySupabaseAccess error:",c),null}},async debugInsertTestContact(){var o;try{const r=window.auth.getSession(),c=(o=r==null?void 0:r.user)==null?void 0:o.id;if(!c)return console.warn("[contacts-import] debugInsertTestContact: no active session"),null;const d=Date.now(),v=`+521000${String(d).slice(-6)}`,E={user_id:c,phone_number:v,full_name:`Debug Contact ${d}`,labels:["debug"],followup_status:"idle",followup_step_sent:-1,created_at:new Date().toISOString(),razon_de_label_auto:null,assigned_to_id:null,current_followup_id:null,last_followup_sent_at:null,chatwoot_contact_id:null},{data:S,error:V}=await window.auth.sb.from("contacts").insert([E]).select("id, phone_number, created_at");if(V)throw V;return console.info("[contacts-import] debugInsertTestContact result:",S),S}catch(r){throw console.error("[contacts-import] debugInsertTestContact error:",r),r}}};let Ze=null;function Wt(){const o=document.getElementById("import-numbers-label-modal");o&&(o.classList.remove("hidden"),Ct(),Vt(),lucide.createIcons())}function ht(){const o=document.getElementById("import-numbers-label-modal");o&&o.classList.add("hidden"),Ct()}function Ct(){Ze=null;const o=document.getElementById("numbers-file-input"),r=document.getElementById("numbers-file-preview"),c=document.getElementById("label-name-input"),d=document.getElementById("import-numbers-progress"),v=document.getElementById("import-numbers-results"),E=document.getElementById("confirm-import-numbers");o&&(o.value=""),r&&r.classList.add("hidden"),c&&(c.value=""),d&&d.classList.add("hidden"),v&&v.classList.add("hidden"),E&&(E.disabled=!1)}function Vt(){const o=document.getElementById("numbers-file-drop-zone"),r=document.getElementById("numbers-file-input"),c=document.getElementById("remove-numbers-file"),d=document.getElementById("close-import-numbers-modal"),v=document.getElementById("cancel-import-numbers"),E=document.getElementById("confirm-import-numbers");o&&r&&(o.addEventListener("click",()=>r.click()),o.addEventListener("dragover",S=>{S.preventDefault(),o.classList.add("border-blue-500","bg-blue-50")}),o.addEventListener("dragleave",()=>{o.classList.remove("border-blue-500","bg-blue-50")}),o.addEventListener("drop",S=>{S.preventDefault(),o.classList.remove("border-blue-500","bg-blue-50"),S.dataTransfer.files.length&&kt(S.dataTransfer.files[0])})),r&&r.addEventListener("change",S=>{S.target.files.length&&kt(S.target.files[0])}),c&&c.addEventListener("click",()=>{Ze=null;const S=document.getElementById("numbers-file-input"),V=document.getElementById("numbers-file-preview");S&&(S.value=""),V&&V.classList.add("hidden")}),d&&d.addEventListener("click",ht),v&&v.addEventListener("click",ht),E&&E.addEventListener("click",Xt)}async function kt(o){var r,c,d;try{const v=(r=o.name.split(".").pop())==null?void 0:r.toLowerCase();let E=[],S=[];if(["csv","xlsx","xls"].includes(v)){const Q=(await $e(o)).split(/\r?\n/).map(ne=>ne.trim()).filter(ne=>ne.length>0);S=Q;for(const ne of Q){const de=ne.split(",").map(ve=>ve.trim());for(const ve of de){const Ie=ve.replace(/\D/g,"");Ie.length>=10&&E.push(Ie)}}}else{const Q=(await o.text()).split(/\r?\n/).map(ne=>ne.trim()).filter(ne=>ne.length>0);S=Q,E=Q.map(ne=>ne.replace(/\D/g,"")).filter(ne=>ne.length>=10)}const V=[...new Set(E)];Ze={file:o,numbers:V,rawLines:S};const k=document.getElementById("numbers-file-preview"),oe=document.getElementById("numbers-file-name"),re=document.getElementById("numbers-count");k&&k.classList.remove("hidden"),oe&&(oe.textContent=o.name),re&&(re.textContent=`${V.length} números únicos detectados`),(c=window.showToast)==null||c.call(window,`Se detectaron ${V.length} números válidos en el archivo.`,"success")}catch(v){console.error("Error al leer archivo:",v),(d=window.showToast)==null||d.call(window,"Error al leer el archivo. Asegúrate de que sea un archivo válido (TXT, CSV, XLSX, XLS).","error")}}async function Xt(){var E,S,V,k,oe,re,Z;const o=document.getElementById("label-name-input"),r=(E=o==null?void 0:o.value)==null?void 0:E.trim();if(!r){(S=window.showToast)==null||S.call(window,"Por favor ingresa un nombre para la etiqueta.","error");return}if(!Ze||!Ze.numbers||Ze.numbers.length===0){(V=window.showToast)==null||V.call(window,"Por favor selecciona un archivo con números válidos.","error");return}const c=document.getElementById("confirm-import-numbers"),d=document.getElementById("import-numbers-progress"),v=document.getElementById("import-numbers-results");c&&(c.disabled=!0);try{const Q=(oe=(k=window.auth.getSession())==null?void 0:k.user)==null?void 0:oe.id;if(!Q)throw new Error("No se pudo determinar el usuario actual.");d&&d.classList.remove("hidden"),nt(0,"Preparando importación..."),await Fe([r],Q),nt(10,"Etiqueta configurada"),nt(20,"Buscando contactos existentes...");const{data:ne,error:de}=await window.auth.sb.from("contacts").select("id, phone_number, labels").eq("user_id",Q);if(de)throw de;const ve=new Map;(ne||[]).forEach(Le=>{const Pe=at(Le.phone_number);Pe&&(Array.isArray(Le.labels)||(Le.labels=Le.labels?[Le.labels]:[]),Le.labels=[...Le.labels],ve.set(Pe,Le))}),nt(30,"Procesando números...");const Ie=[],ye=[];let Ae=0;const qe=Ze.numbers.length;for(let Le=0;Le<Ze.numbers.length;Le++){const Pe=Ze.numbers[Le],Te=at(Pe);if(!Te){Ae++;continue}const ke=ve.get(Te),De=new Set;ke!=null&&ke.labels&&(Array.isArray(ke.labels)?ke.labels:[ke.labels]).filter(Boolean).map(He=>String(He).trim()).filter(He=>He.length>0).forEach(He=>{De.add(He)}),De.add(r);const Ue=Array.from(De);if(ke){const Xe=ke.labels?ke.labels.length:0,He=Ue.length;if(He<Xe){console.warn(`[import-numbers] Advertencia: Se detectó pérdida de etiquetas para ${Te}. Originales: ${Xe}, Merge: ${He}`);const We=new Set([...ke.labels,r]);ye.push({id:ke.id,labels:Array.from(We),originalLabels:ke.labels})}else ye.push({id:ke.id,labels:Ue})}else Ie.push({user_id:Q,phone_number:Te,full_name:null,labels:[r],followup_status:"idle",followup_step_sent:-1});const Ye=30+(Le+1)/qe*60;nt(Ye,`Procesando número ${Le+1} de ${qe}...`)}if(nt(90,"Guardando contactos..."),Ie.length>0){const{error:Le}=await window.auth.sb.from("contacts").insert(Ie);if(Le)throw Le}if(ye.length>0)for(const Le of ye){const Pe=Le.labels||[],{error:Te}=await window.auth.sb.from("contacts").update({labels:Pe}).eq("id",Le.id);if(Te)throw console.error(`[import-numbers] Error al actualizar contacto ${Le.id}:`,Te),new Error(`Error al actualizar contacto: ${Te.message}`)}if(nt(100,"¡Importación completada!"),v){v.classList.remove("hidden");const Le=document.getElementById("result-new-contacts"),Pe=document.getElementById("result-updated-contacts"),Te=document.getElementById("result-skipped-contacts");Le&&(Le.textContent=`• Contactos nuevos: ${Ie.length}`),Pe&&(Pe.textContent=`• Contactos actualizados: ${ye.length}`),Te&&(Te.textContent=`• Números omitidos: ${Ae}`)}(re=window.showToast)==null||re.call(window,`Importación completada: ${Ie.length} nuevos, ${ye.length} actualizados.`,"success"),setTimeout(()=>{loadAndRenderContacts(),ht()},2e3)}catch(Q){console.error("Error al importar números:",Q),(Z=window.showToast)==null||Z.call(window,`Error al importar números: ${Q.message}`,"error"),c&&(c.disabled=!1)}}function nt(o,r){const c=document.getElementById("import-progress-bar"),d=document.getElementById("import-progress-percent"),v=document.getElementById("import-progress-text");c&&(c.style.width=`${o}%`),d&&(d.textContent=`${Math.round(o)}%`),v&&(v.textContent=r)}})();(function(){let Be=!1,t=null,a=[];const n={panel:"smart-promotions",grid:"smart-promos-grid",empty:"smart-promos-empty",activeCount:"smart-promos-active-count",scheduledCount:"smart-promos-scheduled-count",todayCount:"smart-promos-today-count",modal:"smart-promo-modal",modalTitle:"smart-promo-modal-title",form:"smart-promo-form",title:"smart-promo-title",description:"smart-promo-description",benefits:"smart-promo-benefits",cta:"smart-promo-cta",images:"smart-promo-images",autoInsert:"smart-promo-auto",startAt:"smart-promo-start",endAt:"smart-promo-end",noSchedule:"smart-promo-no-schedule",active:"smart-promo-active",maxMentions:"smart-promo-max-mentions",aiBtn:"smart-promo-ai-btn",refreshBtn:"smart-promos-refresh",newBtn:"smart-promos-new-btn",emptyBtn:"smart-promos-empty-btn"};document.addEventListener("panel:activated",async({detail:e})=>{e.panelId===n.panel&&(Be||(u(),Be=!0),await p())});function u(){var i,h,x,B,se,C,b;(i=document.getElementById(n.refreshBtn))==null||i.addEventListener("click",()=>p()),(h=document.getElementById(n.newBtn))==null||h.addEventListener("click",()=>be()),(x=document.getElementById(n.emptyBtn))==null||x.addEventListener("click",()=>be()),(B=document.querySelectorAll("#smart-promo-modal [data-modal-close]"))==null||B.forEach(j=>{j.addEventListener("click",()=>he())}),(se=document.getElementById(n.noSchedule))==null||se.addEventListener("change",X),(C=document.getElementById(n.aiBtn))==null||C.addEventListener("click",R);const e=document.getElementById(n.form);e&&e.addEventListener("submit",ce);const s=document.getElementById(n.modal);s&&s.addEventListener("click",j=>{j.target.dataset.modalClose!==void 0&&he()}),(b=document.getElementById(n.grid))==null||b.addEventListener("click",A)}async function p(){var e,s,i;try{const{data:h,error:x}=await window.auth.sb.from("smart_promotions").select("*").order("created_at",{ascending:!1});if(x){if(x.code==="PGRST205"||(e=x.message)!=null&&e.includes("Could not find the table")){console.error("[smart-promotions] La tabla smart_promotions no existe. Ejecuta la migración SQL primero."),(s=window.showToast)==null||s.call(window,"La tabla de promociones no está configurada. Contacta al administrador.","error");return}throw x}a=h||[],f()}catch(h){console.error("[smart-promotions] Error al cargar promos:",h);const x=h.message||"Error desconocido";(i=window.showToast)==null||i.call(window,`No se pudieron cargar las promos: ${x}`,"error")}}function f(){var i;const e=document.getElementById(n.grid),s=document.getElementById(n.empty);!e||!s||(a.length?(s.classList.add("hidden"),e.innerHTML=a.map(T).join("")):(e.innerHTML="",s.classList.remove("hidden")),L(),(i=window.lucide)!=null&&i.createIcons&&window.lucide.createIcons({root:e||document}))}async function L(){var e;try{const s=window.auth.getSession();if(!((e=s==null?void 0:s.user)!=null&&e.id)){const x=new Date,B=a.filter(z).length,se=a.filter(b=>H(b,x)).length,C=a.filter(b=>b.last_triggered_at&&N(b.last_triggered_at,x)).length;document.getElementById(n.activeCount).textContent=B,document.getElementById(n.scheduledCount).textContent=se,document.getElementById(n.todayCount).textContent=C;return}const{data:i,error:h}=await window.auth.sb.rpc("get_smart_promotions_stats",{p_user_id:s.user.id});if(h){console.warn("[smart-promotions] Error al obtener estadísticas, usando cálculo local:",h);const x=new Date,B=a.filter(z).length,se=a.filter(b=>H(b,x)).length,C=a.filter(b=>b.last_triggered_at&&N(b.last_triggered_at,x)).length;document.getElementById(n.activeCount).textContent=B,document.getElementById(n.scheduledCount).textContent=se,document.getElementById(n.todayCount).textContent=C;return}i&&(document.getElementById(n.activeCount).textContent=i.active_count||0,document.getElementById(n.scheduledCount).textContent=i.scheduled_count||0,document.getElementById(n.todayCount).textContent=i.today_count||0)}catch(s){console.error("[smart-promotions] Error al actualizar estadísticas:",s);const i=new Date,h=a.filter(z).length,x=a.filter(se=>H(se,i)).length,B=a.filter(se=>se.last_triggered_at&&N(se.last_triggered_at,i)).length;document.getElementById(n.activeCount).textContent=h,document.getElementById(n.scheduledCount).textContent=x,document.getElementById(n.todayCount).textContent=B}}function T(e){const s=z(e),i=H(e),h=s?"Activa":i?"Programada":"Inactiva",x=s?"bg-green-100 text-green-700":i?"bg-amber-100 text-amber-700":"bg-slate-200 text-slate-700",B=(e.image_urls||[]).slice(0,3).map(se=>`<span class="text-xs bg-slate-100 px-2 py-0.5 rounded-full truncate" title="${se}">Imagen</span>`).join("");return`
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-5 flex flex-col gap-4" data-id="${e.id}">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${x}">${h}</span>
                        <h3 class="text-xl font-semibold mt-2 text-slate-900">${e.title}</h3>
                        <p class="text-sm text-slate-600 mt-1">${e.description||"Sin descripción"}</p>
                    </div>
                    <div class="text-right text-xs text-slate-500 leading-5">
                        ${G(e)}
                        <div>Auto: ${e.auto_insert?"Sí":"No"}</div>
                        <div>Menciones hoy máx.: ${e.max_mentions_per_day||3}</div>
                    </div>
                </div>
                ${e.benefits?`<div class="text-sm text-slate-500 border-l-4 border-slate-200 pl-3">${e.benefits}</div>`:""}
                ${B?`<div class="flex flex-wrap gap-2">${B}</div>`:""}
                <div class="flex flex-wrap gap-2 mt-2">
                    <button class="promo-action inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-200 text-sm text-slate-600 hover:bg-slate-100" data-action="edit" data-id="${e.id}">
                        <i data-lucide="edit-3" class="w-4 h-4"></i> Editar
                    </button>
                    <button class="promo-action inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-200 text-sm text-slate-600 hover:bg-slate-100" data-action="clone" data-id="${e.id}">
                        <i data-lucide="copy" class="w-4 h-4"></i> Duplicar
                    </button>
                    <button class="promo-action inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-200 text-sm text-slate-600 hover:bg-slate-100" data-action="toggle" data-id="${e.id}">
                        <i data-lucide="${e.is_active?"pause":"play"}" class="w-4 h-4"></i> ${e.is_active?"Pausar":"Activar"}
                    </button>
                    <button class="promo-action inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-red-200 text-sm text-red-600 hover:bg-red-50" data-action="delete" data-id="${e.id}">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Eliminar
                    </button>
                </div>
            </div>
        `}function z(e){if(!e.is_active)return!1;if(e.no_schedule)return!0;const s=new Date,i=!e.start_at||new Date(e.start_at)<=s,h=!e.end_at||new Date(e.end_at)>=s;return i&&h}function H(e,s=new Date){return e.no_schedule||!e.start_at?!1:new Date(e.start_at)>s}function N(e,s){const i=new Date(e);return i.getUTCFullYear()===s.getUTCFullYear()&&i.getUTCMonth()===s.getUTCMonth()&&i.getUTCDate()===s.getUTCDate()}function G(e){if(e.no_schedule)return'<span class="text-xs font-semibold text-blue-500">Sin horario definido</span>';if(!e.start_at&&!e.end_at)return'<span class="text-xs text-slate-500">Sin fechas</span>';const s={dateStyle:"medium",timeStyle:"short"},i=e.start_at?new Date(e.start_at).toLocaleString("es-MX",s):"Inmediato",h=e.end_at?new Date(e.end_at).toLocaleString("es-MX",s):"Sin fin";return`<div>${i} → ${h}</div>`}function be(e=null,s=!1){t=e&&!s?e.id:null,document.getElementById(n.modalTitle).textContent=e&&!s?"Editar Promo":"Nueva Promo",document.getElementById(n.title).value=e?`${e.title}${s?" (copia)":""}`:"",document.getElementById(n.description).value=(e==null?void 0:e.description)||"",document.getElementById(n.benefits).value=(e==null?void 0:e.benefits)||"",document.getElementById(n.cta).value=(e==null?void 0:e.call_to_action)||"",document.getElementById(n.images).value=((e==null?void 0:e.image_urls)||[]).join(", "),document.getElementById(n.autoInsert).checked=(e==null?void 0:e.auto_insert)??!0,document.getElementById(n.noSchedule).checked=(e==null?void 0:e.no_schedule)??!1,document.getElementById(n.active).checked=(e==null?void 0:e.is_active)??!0,document.getElementById(n.maxMentions).value=(e==null?void 0:e.max_mentions_per_day)??3,document.getElementById(n.startAt).value=e!=null&&e.start_at?Y(e.start_at):"",document.getElementById(n.endAt).value=e!=null&&e.end_at?Y(e.end_at):"",X(),m((e==null?void 0:e.image_urls)||[]);const i=document.getElementById(n.modal);i&&(i.classList.remove("hidden"),i.classList.add("flex"))}function he(){var i;const e=document.getElementById(n.modal);e&&(e.classList.add("hidden"),e.classList.remove("flex")),(i=document.getElementById(n.form))==null||i.reset();const s=document.getElementById("smart-promo-images-container");s&&(s.innerHTML=""),t=null}function X(){var s;const e=(s=document.getElementById(n.noSchedule))==null?void 0:s.checked;["startAt","endAt"].forEach(i=>{const h=document.getElementById(n[i]);h&&(h.disabled=e,e&&(h.value=""))})}async function ce(e){var i,h,x,B,se,C;e.preventDefault();const s=W();try{if(!t){const b=window.auth.getSession();if(!((i=b==null?void 0:b.user)!=null&&i.id))throw new Error("No se pudo obtener el usuario actual");s.user_id=b.user.id}if(t){const{error:b}=await window.auth.sb.from("smart_promotions").update(s).eq("id",t);if(b)throw b.code==="PGRST205"||(h=b.message)!=null&&h.includes("Could not find the table")?new Error("La tabla smart_promotions no existe. Ejecuta la migración SQL primero."):b;(x=window.showToast)==null||x.call(window,"Promo actualizada","success")}else{const{error:b}=await window.auth.sb.from("smart_promotions").insert(s);if(b)throw b.code==="PGRST205"||(B=b.message)!=null&&B.includes("Could not find the table")?new Error("La tabla smart_promotions no existe. Ejecuta la migración SQL primero."):b;(se=window.showToast)==null||se.call(window,"Promo creada","success")}he(),await p()}catch(b){console.error("[smart-promotions] Error guardando promo:",b);const j=b.message||"Error desconocido";(C=window.showToast)==null||C.call(window,`No se pudo guardar la promo: ${j}`,"error")}}function W(){const e=document.getElementById("smart-promo-images-container");let s=[];if(e){const h=e.querySelectorAll("[data-image-url]");s=Array.from(h).map(x=>x.dataset.imageUrl).filter(Boolean)}const i=document.getElementById(n.images).value.trim();if(i&&s.length===0)s=i.split(",").map(h=>h.trim()).filter(Boolean);else if(i&&s.length>0){const h=i.split(",").map(x=>x.trim()).filter(Boolean);s=[...new Set([...s,...h])]}return{title:document.getElementById(n.title).value.trim(),description:document.getElementById(n.description).value.trim(),benefits:document.getElementById(n.benefits).value.trim()||null,call_to_action:document.getElementById(n.cta).value.trim()||null,image_urls:s,auto_insert:document.getElementById(n.autoInsert).checked,no_schedule:document.getElementById(n.noSchedule).checked,is_active:document.getElementById(n.active).checked,start_at:document.getElementById(n.noSchedule).checked?null:J(document.getElementById(n.startAt).value),end_at:document.getElementById(n.noSchedule).checked?null:J(document.getElementById(n.endAt).value),max_mentions_per_day:parseInt(document.getElementById(n.maxMentions).value||"3",10)}}function J(e){if(!e)return null;const s=new Date(e);return isNaN(s.getTime())?null:s.toISOString()}function Y(e){const s=new Date(e);if(isNaN(s.getTime()))return"";const i=h=>String(h).padStart(2,"0");return`${s.getFullYear()}-${i(s.getMonth()+1)}-${i(s.getDate())}T${i(s.getHours())}:${i(s.getMinutes())}`}function A(e){const s=e.target.closest(".promo-action");if(!s)return;const{action:i,id:h}=s.dataset;if(!i||!h)return;const x=a.find(B=>B.id===h);if(x)switch(i){case"edit":be(x);break;case"clone":be(x,!0);break;case"toggle":M(x);break;case"delete":_(x);break}}async function M(e){var s,i;try{const{error:h}=await window.auth.sb.from("smart_promotions").update({is_active:!e.is_active}).eq("id",e.id);if(h)throw h;(s=window.showToast)==null||s.call(window,e.is_active?"Promo pausada":"Promo activada","success"),await p()}catch(h){console.error("[smart-promotions] Error al cambiar estado:",h),(i=window.showToast)==null||i.call(window,"No se pudo actualizar el estado.","error")}}async function _(e){var s,i;if(confirm(`¿Eliminar la promo "${e.title}"?`))try{const{error:h}=await window.auth.sb.from("smart_promotions").delete().eq("id",e.id);if(h)throw h;(s=window.showToast)==null||s.call(window,"Promo eliminada","success"),await p()}catch(h){console.error("[smart-promotions] Error al eliminar:",h),(i=window.showToast)==null||i.call(window,"No se pudo eliminar la promo.","error")}}function R(){var x,B;const e=document.getElementById(n.description).value.trim(),s=document.getElementById(n.benefits).value.trim(),h=`${document.getElementById(n.title).value.trim()}

${e}

Beneficios:
${s}`;if(!((x=window.appInstance)!=null&&x.openAiEnhanceModal)){(B=window.showToast)==null||B.call(window,"La mejora con IA no está disponible en este momento.","info");return}window.appInstance.openAiEnhanceModal(h,se=>{document.getElementById(n.description).value=se})}async function y(e,s="smart-promotions"){var h;if(!e)throw new Error("No se proporcionó ningún archivo");const i=window.auth.getSession();if(!((h=i==null?void 0:i.user)!=null&&h.id))throw new Error("No se pudo obtener el usuario actual");try{const x=await new Promise((C,b)=>{const j=new FileReader;j.onload=()=>{const O=j.result,ee=O.includes(",")?O.split(",")[1]:O;C(ee)},j.onerror=b,j.readAsDataURL(e)}),{data:B,error:se}=await window.auth.invokeFunction("smart-worker",{body:{userId:i.user.id,b64_json:x,subfolder:s}});if(se)throw new Error(se.message||"Error al subir la imagen");if(!(B!=null&&B.cdnUrl))throw new Error("La función no devolvió una URL de CDN");return B.cdnUrl}catch(x){throw console.error("[smart-promotions] Error al subir imagen:",x),x}}window.uploadImageToBunny=y;function m(e){var i;const s=document.getElementById("smart-promo-images-container");if(s){if(s.innerHTML="",e.forEach((h,x)=>{if(!h)return;const B=w(h,x);s.insertAdjacentHTML("beforeend",B)}),e.length<10){const h=document.createElement("div");h.className="image-upload-slot border-2 border-dashed border-slate-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 transition-colors",h.innerHTML=`
                <i data-lucide="upload" class="w-6 h-6 mx-auto mb-2 text-slate-400"></i>
                <p class="text-sm text-slate-500">Subir imagen</p>
                <input type="file" accept="image/*" class="hidden" id="smart-promo-image-input" />
            `,h.addEventListener("click",()=>{var B;(B=document.getElementById("smart-promo-image-input"))==null||B.click()}),s.appendChild(h);const x=document.getElementById("smart-promo-image-input");x&&x.addEventListener("change",l)}(i=window.lucide)!=null&&i.createIcons&&window.lucide.createIcons({root:s})}}function w(e,s){return`
            <div class="relative group" data-image-url="${e}">
                <img src="${e}" alt="Imagen ${s+1}" 
                     class="w-full h-32 object-cover rounded-lg border border-slate-200" />
                <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1.5 opacity-0 group-hover:opacity-100 transition-opacity remove-image-btn"
                        data-url="${e}">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        `}async function l(e){var x,B,se,C,b,j,O,ee;const s=(x=e.target.files)==null?void 0:x[0];if(!s)return;if(!s.type.startsWith("image/")){(B=window.showToast)==null||B.call(window,"Por favor selecciona un archivo de imagen válido","error");return}if(s.size>10*1024*1024){(se=window.showToast)==null||se.call(window,"La imagen es demasiado grande. Máximo 10MB","error");return}const i=document.getElementById("smart-promo-images-container");if(!i)return;const h=`loading-${Date.now()}`;i.insertAdjacentHTML("beforeend",`
            <div id="${h}" class="border-2 border-dashed border-blue-300 rounded-lg p-4 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                <p class="text-sm text-slate-500 mt-2">Subiendo...</p>
            </div>
        `);try{const ae=await y(s,"smart-promotions");(C=document.getElementById(h))==null||C.remove();const ue=w(ae,i.querySelectorAll("[data-image-url]").length);i.insertAdjacentHTML("beforeend",ue);const ie=i.querySelector(`[data-url="${ae}"]`);ie&&ie.addEventListener("click",()=>{const me=ie.closest("[data-image-url]");me==null||me.remove()}),(b=window.lucide)!=null&&b.createIcons&&window.lucide.createIcons({root:i}),(j=window.showToast)==null||j.call(window,"Imagen subida correctamente","success")}catch(ae){(O=document.getElementById(h))==null||O.remove(),console.error("[smart-promotions] Error al subir imagen:",ae),(ee=window.showToast)==null||ee.call(window,`Error al subir imagen: ${ae.message}`,"error")}e.target.value=""}document.addEventListener("click",e=>{if(e.target.closest(".remove-image-btn")){const i=e.target.closest(".remove-image-btn").closest("[data-image-url]");i==null||i.remove()}})})();(function(){let Be=!1,t=!0,a=null;document.addEventListener("panel:activated",async({detail:A})=>{A.panelId==="sales-context"&&(Be||(n(),Be=!0),await J())});function n(){var M,_,R;const A=document.getElementById("sales-context-form");A==null||A.addEventListener("submit",Y),A==null||A.addEventListener("input",T),(M=document.getElementById("sales-context-clear"))==null||M.addEventListener("click",()=>{A==null||A.reset();const y=document.getElementById("sales-context-active");y&&(y.checked=!0),H()}),(_=document.getElementById("add-objection-btn"))==null||_.addEventListener("click",()=>{be()}),document.addEventListener("click",y=>{var m;y.target.closest(".remove-objection-btn")&&((m=y.target.closest(".bg-white"))==null||m.remove())}),(R=document.getElementById("sales-context-load-defaults"))==null||R.addEventListener("click",u)}function u(){var A;H(),(A=window.showToast)==null||A.call(window,"Objeciones comunes cargadas. Puedes editarlas o generar respuestas automáticas con el botón 🤖.","success")}async function p(A,M){var i,h,x,B,se,C,b,j,O,ee;const _=A.querySelector(".generate-response-btn"),R=_.innerHTML,y=A.querySelector(".objection-display"),m=A.querySelector(".objection-edit"),w=A.querySelector(".response-text"),l=A.querySelector(".response-input"),e=A.querySelector(".edit-objection-btn"),s=A.querySelector(".save-objection-btn");y&&m&&(y.classList.remove("hidden"),m.classList.add("hidden"),e&&e.classList.remove("hidden"),s&&s.classList.add("hidden"));try{_.disabled=!0,_.innerHTML='<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>',(i=window.lucide)!=null&&i.createIcons&&window.lucide.createIcons({root:A});const ae=f();if(!ae)throw new Error("No se pudo obtener el usuario");const[ue,ie]=await Promise.all([window.auth.sb.from("prompts").select("prompt_content").eq("user_id",ae).single(),window.auth.sb.from("profiles").select("company_description, website, social_media").eq("id",ae).single()]),me=((h=ue.data)==null?void 0:h.prompt_content)||"",fe=((x=ie.data)==null?void 0:x.company_description)||"",I=((B=ie.data)==null?void 0:B.website)||"",q=((se=ie.data)==null?void 0:se.social_media)||{};if(!me&&!fe){(C=window.showToast)==null||C.call(window,"Necesitas configurar tu prompt general o la descripción de tu empresa en Configuración","warning");return}let F=`Objeción del cliente: "${M}"

`;me&&(F+=`Prompt general de la empresa:
${me}

`),fe&&(F+=`Información de la empresa:
${fe}

`),I&&(F+=`Sitio web: ${I}
`),(q.instagram||q.facebook)&&(F+="Redes sociales: ",q.instagram&&(F+=`Instagram: ${q.instagram} `),q.facebook&&(F+=`Facebook: ${q.facebook}`),F+=`

`),F+="Tarea: Genera una respuesta profesional y personalizada para esta objeción, usando la información de la empresa. La respuesta debe ser concisa (2-3 oraciones) y explicar cómo debe responder la IA cuando detecte esta objeción.";const{data:D,error:K}=await window.auth.sb.functions.invoke("openai-proxy",{body:{prompt:F,systemInstruction:"Eres un asistente experto en ventas. Genera respuestas concisas y profesionales para objeciones comunes, basándote en la información de la empresa proporcionada. La respuesta debe ser de 2-3 oraciones máximo.",model:"gpt-4o-mini"}});if(K)throw K;const ge=((b=D==null?void 0:D.content)==null?void 0:b.trim())||"";if(!ge)throw new Error("No se pudo generar la respuesta");w&&(w.textContent=ge),l&&(l.value=ge),y&&m&&(y.classList.remove("hidden"),m.classList.add("hidden")),(j=window.showToast)==null||j.call(window,"Respuesta generada correctamente. Puedes editarla haciendo clic en el ícono de lápiz.","success")}catch(ae){console.error("[sales-context] Error al generar respuesta:",ae),(O=window.showToast)==null||O.call(window,"Error al generar la respuesta: "+(ae.message||"Error desconocido"),"error")}finally{_.disabled=!1,_.innerHTML=R,(ee=window.lucide)!=null&&ee.createIcons&&window.lucide.createIcons({root:A})}}const f=()=>{var A,M;return(M=(A=window.auth.getSession())==null?void 0:A.user)==null?void 0:M.id},L=()=>{var y,m;const A=((y=document.getElementById("sales-context-active"))==null?void 0:y.checked)??!0,M=((m=document.getElementById("sales-context-auto-generate"))==null?void 0:m.checked)??!0,_=document.querySelectorAll("#objections-list .objection-card"),R=Array.from(_).map(w=>{var s,i,h,x;const l=((i=(s=w.querySelector(".objection-text"))==null?void 0:s.textContent)==null?void 0:i.trim())||"",e=((x=(h=w.querySelector(".response-text"))==null?void 0:h.textContent)==null?void 0:x.trim())||"";return{objection:l,response:e}}).filter(w=>w.objection&&w.response);return{title:"Contexto de Ventas",is_active:A,auto_generate_responses:M,prompt:{detected_objections:R.length>0?R:null}}};function T(){}function z(A){var _;const M=document.getElementById("sales-context-form");M&&(M.querySelectorAll('input, textarea, button[type="submit"], button[type="button"]').forEach(R=>{R.disabled=A}),A||(_=document.getElementById("sales-context-clear"))==null||_.removeAttribute("disabled"))}function H(){if(!document.getElementById("sales-context-detected-objections"))return;N([{objection:'"Es muy caro"',response:"Preguntar si el precio es el único problema o si hay dudas técnicas"},{objection:'"Déjame pensarlo"',response:"Preguntar qué duda específica tiene para poder ayudarlo"},{objection:'"Lo consultaré con mi socio/esposa"',response:"Ofrecer un resumen corto de 3 puntos para compartir"}])}function N(A){var w,l;const M=document.getElementById("sales-context-detected-objections");if(!M)return;const _=A&&Array.isArray(A)&&A.length>0?A:[{objection:'"Es muy caro"',response:"Preguntar si el precio es el único problema o si hay dudas técnicas"},{objection:'"Déjame pensarlo"',response:"Preguntar qué duda específica tiene para poder ayudarlo"},{objection:'"Lo consultaré con mi socio/esposa"',response:"Ofrecer un resumen corto de 3 puntos para compartir"}],R=((w=M.querySelector("#add-objection-btn"))==null?void 0:w.outerHTML)||"";M.innerHTML="";const y=document.createElement("p");y.className="text-sm text-slate-600 mb-3",y.innerHTML='<i data-lucide="info" class="w-4 h-4 inline mr-2"></i>La IA detectará automáticamente estas objeciones. Puedes editarlas haciendo clic en el ícono de lápiz ✏️.',M.appendChild(y);const m=document.createElement("div");if(m.id="objections-list",m.className="space-y-2",M.appendChild(m),_.forEach((e,s)=>{const i=G(e.objection,e.response,s);m.appendChild(i)}),R)M.insertAdjacentHTML("beforeend",R);else{const e=document.createElement("button");e.type="button",e.id="add-objection-btn",e.className="mt-3 text-sm text-blue-600 hover:text-blue-700 font-semibold flex items-center gap-2",e.innerHTML='<i data-lucide="plus" class="w-4 h-4"></i> Agregar objeción personalizada',e.addEventListener("click",be),M.appendChild(e)}(l=window.lucide)!=null&&l.createIcons&&window.lucide.createIcons({root:M})}function G(A,M,_){const R=document.createElement("div");R.className="flex items-start gap-2 bg-white p-3 rounded-lg border border-slate-200 objection-card",R.dataset.index=_,R.innerHTML=`
            <div class="flex-1">
                <div class="objection-display">
                    <p class="text-sm font-semibold text-slate-700 objection-text">${A}</p>
                    <p class="text-xs text-slate-500 mt-1 response-text">${M}</p>
                </div>
                <div class="objection-edit hidden">
                    <input type="text" class="objection-input w-full text-sm font-semibold text-slate-700 border border-slate-300 rounded px-2 py-1 mb-2" value="${A}" placeholder="Objeción (ej: 'Es muy caro')">
                    <textarea class="response-input w-full text-xs text-slate-500 border border-slate-300 rounded px-2 py-1" rows="2" placeholder="Cómo debe responder la IA">${M}</textarea>
                </div>
            </div>
            <div class="flex gap-1">
                <button type="button" class="text-purple-500 hover:text-purple-700 generate-response-btn" title="Generar respuesta para mi empresa">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                </button>
                <button type="button" class="text-blue-500 hover:text-blue-700 edit-objection-btn" title="Editar">
                    <i data-lucide="pencil" class="w-4 h-4"></i>
                </button>
                <button type="button" class="text-green-500 hover:text-green-700 save-objection-btn hidden" title="Guardar">
                    <i data-lucide="check" class="w-4 h-4"></i>
                </button>
                <button type="button" class="text-red-500 hover:text-red-700 remove-objection-btn" title="Eliminar">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        `;const y=R.querySelector(".generate-response-btn"),m=R.querySelector(".edit-objection-btn"),w=R.querySelector(".save-objection-btn"),l=R.querySelector(".remove-objection-btn"),e=R.querySelector(".objection-display"),s=R.querySelector(".objection-edit"),i=R.querySelector(".objection-input"),h=R.querySelector(".response-input");return y.addEventListener("click",async()=>{var B,se;const x=((se=(B=R.querySelector(".objection-text"))==null?void 0:B.textContent)==null?void 0:se.trim())||A;await p(R,x)}),m.addEventListener("click",()=>{e.classList.add("hidden"),s.classList.remove("hidden"),m.classList.add("hidden"),w.classList.remove("hidden"),i.focus()}),w.addEventListener("click",()=>{var se,C;const x=i.value.trim(),B=h.value.trim();if(!x||!B){(se=window.showToast)==null||se.call(window,"La objeción y la respuesta no pueden estar vacías","error");return}R.querySelector(".objection-text").textContent=x,R.querySelector(".response-text").textContent=B,e.classList.remove("hidden"),s.classList.add("hidden"),m.classList.remove("hidden"),w.classList.add("hidden"),(C=window.lucide)!=null&&C.createIcons&&window.lucide.createIcons({root:R})}),l.addEventListener("click",()=>{confirm("¿Eliminar esta objeción?")&&R.remove()}),[i,h].forEach(x=>{x.addEventListener("keydown",B=>{B.key==="Enter"&&B.ctrlKey&&w.click()})}),R}function be(){var y,m;const A=document.getElementById("sales-context-detected-objections");if(!A)return;let M=document.getElementById("objections-list");if(!M){M=document.createElement("div"),M.id="objections-list",M.className="space-y-2";const w=A.querySelector("#add-objection-btn");A.insertBefore(M,w||A.lastElementChild)}const _=G("Nueva objeción","Escribe cómo debe responder la IA...",Date.now());M.appendChild(_);const R=_.querySelector(".edit-objection-btn");R&&R.click(),(y=window.lucide)!=null&&y.createIcons&&window.lucide.createIcons({root:A}),(m=window.showToast)==null||m.call(window,"Nueva objeción agregada. Edítala y guarda.","success")}const he=(A,M)=>!A||A.code!=="PGRST205"?!1:M?(A.message||"").toLowerCase().includes(M.toLowerCase()):!0,X=A=>{if(!A)return!1;if(he(A))return!0;const M=(A.message||"").toLowerCase();return M.includes("is_active")||M.includes("column")};function ce(A){var M;t=!1,z(!0),console.warn("[sales-context]",A),(M=window.showToast)==null||M.call(window,A,"warning")}async function W(A){if(!t)return null;const M=window.auth.sb,_="id,user_id,title,prompt,is_active,updated_at",R=()=>M.from("sales_prompts").select(_).eq("user_id",A).eq("is_active",!0).order("updated_at",{ascending:!1}).limit(1);let{data:y,error:m}=await R();if(m&&X(m)&&({data:y,error:m}=await M.from("sales_prompts_active").select("id,user_id,title,prompt,updated_at").eq("user_id",A).limit(1)),m&&he(m,"sales_prompts_active"))return ce("El contexto comercial requiere la migración que crea sales_prompts."),null;if(m)throw m;return(y==null?void 0:y[0])??null}async function J(){var M,_;const A=f();if(A&&t){z(!0);try{a=await W(A);const R=document.getElementById("sales-context-active"),y=document.getElementById("sales-context-auto-generate");if(!a)R&&(R.checked=!0),y&&(y.checked=!0),H();else{R&&(R.checked=a.is_active??!0),y&&(y.checked=a.auto_generate_responses??!0);const m=(M=a.prompt)==null?void 0:M.detected_objections;m&&Array.isArray(m)&&m.length>0?N(m):H()}}catch(R){console.error("[sales-context] No se pudo cargar el contexto:",R),(_=window.showToast)==null||_.call(window,"No pudimos cargar tu contexto comercial.","error")}finally{t&&z(!1)}}}async function Y(A){var R,y,m;if(A.preventDefault(),!t)return;const M=f();if(!M){(R=window.showToast)==null||R.call(window,"Inicia sesión nuevamente para guardar tu contexto.","error");return}const _=L();z(!0);try{const{error:w}=await window.auth.sb.from("sales_prompts").update({is_active:!1}).eq("user_id",M);if(w){if(he(w,"sales_prompts")){ce("El contexto comercial requiere la tabla sales_prompts.");return}throw w}const{error:l}=await window.auth.sb.from("sales_prompts").insert({user_id:M,title:_.title||"Contexto sin título",prompt:_.prompt,is_active:_.is_active,auto_generate_responses:_.auto_generate_responses});if(l){if(he(l,"sales_prompts")){ce("El contexto comercial requiere la tabla sales_prompts.");return}throw l}(y=window.showToast)==null||y.call(window,"Contexto comercial guardado","success"),await J()}catch(w){console.error("[sales-context] Error al guardar:",w),(m=window.showToast)==null||m.call(window,w.message||"No pudimos guardar tu contexto comercial.","error")}finally{t&&z(!1)}}})();(function(){let Be=!1,t="home",a=[],n=null,u=[],p={used:0,limit:0},f=null,L=!1;const T={provider:"gemini",model:"google/nano-banana",aspectRatio:"auto",outputFormat:"png"};window.designerAiSettings=T;let z=!1,H={},N={},G={};const be={none:{name:"Ninguno / Manual",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/noun.jpg",prompt:"Create a visually appealing, well-composed, full-bleed promotional social media flyer based *only* on the user's specific instructions for style, text, and visual elements. There is no predefined base style."},"corp-moderno":{name:"Corp. Moderno",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Corporativo%20Moderno.jpg",prompt:"Create a professional, clean, full-bleed promotional social media flyer design. The background should be a smooth, edge-to-edge gradient in corporate blue tones. Use professional, high-quality photos. Typography is a modern, readable sans-serif. Leave ample clean space for text overlays."},elegancia:{name:"Elegancia Min.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Elegancia%20Minimalista.jpg",prompt:"Create an elegant, minimalist, full-bleed promotional social media flyer design. Use a clean, light-colored background (like white or soft gray), a refined serif or sans-serif font. The layout must be uncluttered with generous use of negative space. The overall feeling should be premium and sophisticated."},comida:{name:"Estilo Audaz",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Comida%20Audaz.jpg",prompt:"Create a bold, promotional, full-bleed social media flyer design. Use strong, high-contrast colors like red, yellow, and black. The typography must be large and impactful. The main subject should be presented in a powerful and appealing manner."},colorido:{name:"Colorido",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/Gemini_Generated_Image_th5h7nth5h7nth5h.png",prompt:'Create a "Modern Health Campaign" style full-bleed design. The background should feature smooth, flowing gradients of purple and blue that extend edge-to-edge. All visual and textual elements must be integrated directly into this background, utilizing clean, geometric divisions (e.g., sharp diagonal lines, large color blocks, or integrated rounded shapes). High-quality, relevant photography should be seamlessly blended into sections of this full-bleed layout. Typography is a modern, clean sans-serif, using varying weights and colors to establish clear hierarchy. The overall feel must be trustworthy, informative, and clean.'},urbano:{name:"Collage Urbano",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Collage%20Urbano.jpg",prompt:"Create a dynamic, urban collage-style, full-bleed promotional social media flyer design. Combine textures like torn paper, duct tape, and spray paint splatters. Use a mix of gritty, high-contrast photography and bold, handwritten or stencil-style fonts. The vibe should be edgy and energetic."},deporte:{name:"Estilo Dinámico",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Deporte%20Din%C3%A1mico.jpg",prompt:"Create an energetic and dynamic, full-bleed promotional social media flyer design. Use strong diagonal lines, motion blur effects, and a high-contrast color palette. Typography should be bold, modern, and convey a sense of speed and power."},premium:{name:"Brillo Premium",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/Brillo%20Premium.jpg",prompt:"Create a luxurious and premium, full-bleed promotional social media flyer design. Use a dark, sophisticated color palette, often incorporating gold, silver, or metallic accents. Lighting should be elegant, creating soft highlights and shadows. The mood is exclusive and high-end."},lineas:{name:"Líneas",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/Gemini_Generated_Image_r0m7v1r0m7v1r0m7.png",prompt:'Create a "Dynamic Geometric" style design. The composition is based on a clean, bright white background that is geometrically divided by fluid, rounded shapes (circles, capsule-like diagonal forms) in various tones of blue. These shapes must extend to the very edges of the canvas. All visual and textual elements, including photography, must be seamlessly integrated as part of this unified full-bleed canvas. High-quality photography should be directly incorporated into the flow of the geometric shapes or background, forming an organic part of the overall design. Typography is modern and clean sans-serif, using bold weights for headlines and lighter weights for details.'}},he={studio:{name:"Foto de Estudio Clásica",description:"Fondo limpio y neutro.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/foto%20estudio%20clasica.png",prompt:"on a seamless, light gray background. The lighting is a soft, three-point setup, creating subtle, flattering shadows that define the product's form. Hyper-realistic, 8k, tack sharp focus."},lifestyle:{name:"Escena de Estilo de Vida",description:"Integrado en una escena realista.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/lifestyle.png",prompt:"on a rustic wooden coffee shop table, next to a steaming latte with latte art. Natural, soft window lighting is coming from the side. The scene feels candid, atmospheric, and has a shallow depth of field."},"flat-lay":{name:"Plano Cenital (Flat Lay)",description:"Vista desde arriba con accesorios.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/flat%20lay.png",prompt:"in a perfectly organized top-down flat lay composition on a clean white surface alongside a partially open laptop, a pair of stylish eyeglasses, and a small green succulent plant. The lighting is bright, even, and shadowless."},texture:{name:"Sobre Fondo Texturizado",description:"Colocado sobre mármol, madera, etc.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/fondo%20texturizado.png",prompt:"placed on a rough, dark slab of natural slate. A single, strong directional light rakes across the surface, emphasizing the fine texture of the slate and the smooth, glossy glaze of the product. Moody and tactile."},dramatic:{name:"Entorno Dramático",description:"Iluminación cinematográfica.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/entorno%20dramatico.png",prompt:"on a wet, volcanic rock with mist swirling in the background. The lighting is high-contrast and moody, with a single spotlight hitting the product, making it glow. Shot from a low-angle to make it feel monumental and epic."},abstract:{name:"Conceptual y Abstracto",description:"Ambiente surrealista y artístico.",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/abstracto.png",prompt:"floating and partially submerged in crystal clear water, with vibrant clouds of blue and orange ink swirling around it. Bold, artistic lighting creates beautiful refractions through the water and on the product's surface."}},X={none:{name:"Ninguno",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/noun.jpg",prompt:""},woman:{name:"Mujer",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/quien%20lo%20usa%20mujer.png",prompt:"a woman is using the product naturally."},man:{name:"Hombre",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/quien%20los%20usa%20hombre.png",prompt:"a man is using the product naturally."}},ce={none:{name:"Ninguno",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/noun.jpg",prompt:""},nature:{name:"Naturaleza",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/donde%20se%20usa%20naturaleza.png",prompt:"The scene is set in a vibrant, natural environment like a forest or a beach."},city:{name:"Urbano",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/donde%20lo%20usa%20urbano.png",prompt:"The scene is set in a dynamic, modern urban environment, like a bustling city street or a stylish cafe."},home:{name:"Hogar",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/donde%20lo%20usa%20hogar.png",prompt:"The scene is set inside a cozy, well-lit home, like a living room or kitchen."}},W={none:{name:"Ninguno",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/noun.jpg",prompt:""},day:{name:"Día",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/ambiente%20dia%20soleado.png",prompt:"The lighting is bright and clear, like a sunny morning or midday."},sunset:{name:"Atardecer",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/ambiente%20atardecer%20dorado.png",prompt:"The lighting is warm and golden, characteristic of a beautiful sunset."},night:{name:"Noche",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/product/ambiente%20noche.png",prompt:"The scene is set at night, with dramatic, moody lighting from artificial sources like city lights or lamps."}},J={professional:{name:"Profesional",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_tdnut4tdnut4tdnu.png",prompt:"A professional corporate headshot. The person is in business attire, with a soft, out-of-focus modern office background. Lighting is flattering and studio-quality. The expression is confident and approachable. Photorealistic, 8k, sharp focus on the eyes."},casual:{name:"Casual Urbano",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_bo3epfbo3epfbo3e.png",prompt:"A friendly, casual outdoor portrait in a vibrant urban setting, like a stylish city street with bokeh lights. The person is dressed in smart-casual clothing. The lighting is bright, natural daylight, creating a warm and inviting mood. Photorealistic, shallow depth of field."},studio:{name:"Estudio Creativo",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_b7m3uob7m3uob7m3.png",prompt:"A modern, creative studio headshot. The person is against a solid, bold-colored background (like deep teal or mustard yellow). The lighting is more dramatic and artistic, with a key light creating defined shadows. The expression is confident and creative. High-fashion style, sharp details."},nature:{name:"Naturaleza",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_h265k4h265k4h265.png",prompt:"A relaxed, natural headshot in a lush, green environment like a park or forest. The person is dressed casually. The lighting is soft, diffused sunlight filtering through leaves, creating a serene and authentic atmosphere. Photorealistic, natural look."},event:{name:"En Evento",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_amp7eiamp7eiamp7.png",prompt:"A dynamic, in-action headshot as if taken at a professional conference or networking event. The person appears engaged, perhaps speaking or listening intently. The background is blurred, showing hints of a crowd and event lighting, giving a sense of energy and professionalism. Candid style."},minimalist:{name:"Minimalista",image:"https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_761a3j761a3j761a.png",prompt:"A clean, minimalist headshot against a simple, textured, light-gray or off-white studio background. The lighting is perfectly even and soft, eliminating harsh shadows. The focus is entirely on the person's natural expression. Modern and clean aesthetic."}};document.addEventListener("panel:activated",({detail:g})=>{g.panelId==="designer-ai"&&!Be?Y():g.panelId==="designer-ai"&&window.appInstance&&window.appInstance.renderUsageAndLimits()});function Y(){Be=!0,document.addEventListener("usage:updated",({detail:g})=>{const $=g==null?void 0:g.imageGenerations;if(!$)return;const P=typeof $.limit=="number"?$.limit:0,U=typeof $.remaining=="number"?$.remaining:0;p.limit=P,p.used=Math.max(0,P-U),i(),ie()}),A(),x()}async function A(){var g,$;L=!0,ie();try{const P=($=(g=window.auth.getSession())==null?void 0:g.user)==null?void 0:$.id,{data:U,error:te}=await window.auth.sb.from("profiles").select("branding_settings, gallery_images").eq("id",P).single();if(u=[],U!=null&&U.gallery_images&&(u=U.gallery_images.map(le=>({id:le,src:le}))),te)throw te;await M(),f=U.branding_settings,await _()}catch(P){console.error("Error al generar diseño:",P),window.showToast(P.message||"Ocurrio un error al generar la imagen.","error")}finally{L=!1,ie(),i()}}async function M(){var g;try{if(!window.appInstance)return;const $=typeof window.appInstance.loadUserSubscription=="function"?window.appInstance.loadUserSubscription():Promise.resolve(null),P=typeof window.appInstance.loadUserUsage=="function"?window.appInstance.loadUserUsage():Promise.resolve(null),[U,te]=await Promise.all([$,P]);U&&te&&(p.limit=((g=U==null?void 0:U.plans)==null?void 0:g.image_generations_limit)??0,p.used=(te==null?void 0:te.image_generations_used)??0)}catch($){console.warn("No se pudo cargar el uso de imagenes:",$)}}async function _(){if(R(),!f){y();return}Array.isArray(f.colors)&&f.colors.length>0&&(N.colors=f.colors.slice(0,4));const g=[];f.logo_url&&g.push(xe(f.logo_url).then($=>{$&&(N.images.logo=$)})),Array.isArray(f.reference_images)&&f.reference_images.slice(0,3).forEach(($,P)=>{g.push(xe($).then(U=>{if(U){const te=`ref${P+1}`;N.images[te]=U}}))}),g.length>0&&await Promise.allSettled(g),y()}function R(){const g=Array.isArray(f==null?void 0:f.colors)&&f.colors.length>0?f.colors.slice(0,4):["#4F46E5","#9333EA","#FFFFFF","#000000"];N={images:{logo:null,product:null,background:null,ref1:null,ref2:null,ref3:null},removeProductBg:!0,flyerStyle:"none",colors:g,textInputs:{headline:"",secondary:"",terms:"",price:"",visuals:"",styleMods:""},finalPrompt:""},G={images:{main:null,opt1:null,opt2:null},mode:"product-only",productOnlyData:{environment:"studio",customPrompt:""},lifestyleData:{who:"none",whoCustom:"",where:"none",whereCustom:"",when:"none",whenCustom:""},finalPrompt:""},H={images:{ref1:null,ref2:null,ref3:null},scene:"professional",finalPrompt:""},a=[],n=null,y()}function y(){l(),e(),s()}function m(g){return typeof g=="string"?g.trim():""}function w(g){return g.filter(Boolean).map($=>$.toUpperCase()).join(", ")}function l(){const g=[];g.push("Design a polished promotional flyer suitable for social media. Use clear hierarchy and professional layout.");const $=be[N.flyerStyle];if($&&g.push(`Base style guidance: ${$.prompt}`),N.flyerStyle==="none"){const Me=m(N.textInputs.styleMods);Me&&g.push(`Custom style instructions: ${Me}`)}const P=m(N.textInputs.headline);P&&g.push(`Headline: ${P}`);const U=m(N.textInputs.secondary);U&&g.push(`Secondary text: ${U}`);const te=m(N.textInputs.price);te&&g.push(`Call to action or price: ${te}`);const le=m(N.textInputs.terms);le&&g.push(`Small print: ${le}`);const Ce=m(N.textInputs.visuals);Ce&&g.push(`Visual elements to include: ${Ce}`),N.colors&&N.colors.length&&g.push(`Brand colour palette: ${w(N.colors)}`),N.removeProductBg&&g.push("If a product reference is used, remove its original background."),N.finalPrompt=g.join(`

`).trim()}function e(){const g=[];if(g.push("Create a photorealistic marketing render of the product with dramatic lighting and professional composition."),G.mode==="product-only"){const $=he[G.productOnlyData.environment];$&&g.push(`Environment: ${$.prompt}`);const P=m(G.productOnlyData.customPrompt);P&&g.push(`Extra instructions: ${P}`)}else{const $=X[G.lifestyleData.who];$!=null&&$.prompt&&g.push(`Subject: ${$.prompt}`);const P=ce[G.lifestyleData.where];P!=null&&P.prompt&&g.push(`Location: ${P.prompt}`);const U=W[G.lifestyleData.when];U!=null&&U.prompt&&g.push(`Mood or time: ${U.prompt}`);const te=m(G.lifestyleData.whoCustom);te&&g.push(`Subject details: ${te}`);const le=m(G.lifestyleData.whereCustom);le&&g.push(`Location details: ${le}`);const Ce=m(G.lifestyleData.whenCustom);Ce&&g.push(`Mood details: ${Ce}`)}G.finalPrompt=g.join(`

`).trim()}function s(){const g=[];g.push("Generate a professional portrait that preserves the subject identity with realistic lighting and skin texture.");const $=J[H.scene];$!=null&&$.prompt&&g.push(`Scene: ${$.prompt}`),g.push("Deliver a sharp, flattering headshot suitable for corporate branding."),H.finalPrompt=g.join(`

`).trim()}function i(){const g=document.getElementById("designer-ai");if(!g)return;const $=g.querySelector(`#${t}-image-generation-usage`);$&&($.textContent=`${p.used} / ${p.limit}`)}function h(){const g=document.getElementById("designer-ai");if(!g)return;const $=g.querySelector('[data-role="prompt-display"]');if($&&(t==="flyer"?$.textContent=N.finalPrompt:t==="product"?$.textContent=G.finalPrompt:t==="headshot"&&($.textContent=H.finalPrompt)),t==="flyer"){const P=g.querySelector("[data-flyer-style-manual]");P&&P.classList.toggle("hidden",N.flyerStyle!=="none")}i()}function x(){z||(z=!0,document.addEventListener("click",B),document.addEventListener("input",se),document.addEventListener("change",C))}function B(g){const $=document.getElementById("designer-ai");if(!$)return;const P=g.target.closest("[data-tool]");if(P&&$.contains(P)){g.preventDefault(),b(P.dataset.tool);return}if(g.target.closest("#view-all-gallery-btn")){g.preventDefault(),Se();return}const U=g.target.closest(".gallery-item-home");if(U){const Ce=U.dataset.imageSrc;if(Ce){const Me=`imagen-${Date.now()}.png`;Ee(Ce,"Imagen generada",Me)}return}const te=g.target.closest(".gallery-thumbnail");if(te){n=te.getAttribute("src"),h(),ie();return}if(g.target.closest(".generate-btn")){g.preventDefault(),j();return}if(g.target.closest(".download-btn")){g.preventDefault(),n&&ue(n);return}const le=g.target.closest("[data-mode]");if(le&&$.contains(le)){const Ce=le.dataset.mode;Ce&&Ce!==G.mode&&(G.mode=Ce,e(),ie())}}function se(g){const $=document.getElementById("designer-ai");if(!$||!$.contains(g.target))return;const P=g.target;if(P.matches("textarea[data-flyer_text]")){const U=P.getAttribute("data-flyer_text");U&&(N.textInputs[U]=P.value,l(),h());return}if(P.matches("textarea[data-product_text]")){G.productOnlyData.customPrompt=P.value,e(),h();return}if(P.matches("textarea[data-lifestyle_text]")){const U=P.getAttribute("data-lifestyle_text");U&&(G.lifestyleData[U]=P.value,e(),h());return}if(P.matches('input[type="color"][data-index]')){const U=Number(P.getAttribute("data-index"));Number.isNaN(U)||(N.colors[U]=P.value,l(),h())}}function C(g){const $=document.getElementById("designer-ai");if(!$||!$.contains(g.target))return;const P=g.target;if(P.matches("#remove-bg-check")){N.removeProductBg=P.checked,l(),h();return}if(P.matches('input[name="flyer-style"]')){N.flyerStyle=P.value,l(),h();return}if(P.matches('input[name="environment"]')){G.productOnlyData.environment=P.value,e(),h();return}if(P.matches('input[name="who"]')){G.lifestyleData.who=P.value,e(),h();return}if(P.matches('input[name="where"]')){G.lifestyleData.where=P.value,e(),h();return}if(P.matches('input[name="when"]')){G.lifestyleData.when=P.value,e(),h();return}if(P.matches('input[name="headshot-scene"]')){H.scene=P.value,s(),h();return}}function b(g){!g||g===t||(t=g,L=!0,ie(),_().finally(()=>{L=!1,ie(),h()}))}async function j(){var $,P;if(L)return;if(p.limit>0&&p.used>=p.limit){window.showToast("Has alcanzado tu límite de generaciones.","error");return}const g=ae();if(!g){window.showToast("El prompt está vacío o incompleto.","error");return}L=!0,ie();try{const U=(P=($=window.auth.getSession())==null?void 0:$.user)==null?void 0:P.id;if(!U)throw new Error("No se pudo determinar el usuario actual.");const{data:te,error:le}=await window.auth.sb.rpc("increment_image_usage",{p_user_id:U});if(le||!(te!=null&&te.success))throw new Error((te==null?void 0:te.message)||(le==null?void 0:le.message)||"Error al verificar el uso.");await O(U,g,te)}catch(U){console.error("Designer AI generation error:",U);const te=(U==null?void 0:U.message)||"Ocurrió un error al generar la imagen.";window.showToast(te,"error")}finally{L=!1,ie()}}async function O(g,$,P){var je;const U=ee($),{data:te,error:le}=await window.auth.invokeFunction("gemini-proxy",{body:{userId:g,type:"image",parts:U}});if(le)throw le;const Ce=Array.isArray(te==null?void 0:te.results)?te.results:[];if(Ce.length===0)throw new Error("La IA no devolvió ninguna imagen.");const Me=Ce.map($e=>{var Fe;return{id:((Fe=crypto==null?void 0:crypto.randomUUID)==null?void 0:Fe.call(crypto))??`${Date.now()}-${Math.random()}`,src:$e}});a.unshift(...Me),n=((je=Me[0])==null?void 0:je.src)||n;const Ve=(await Promise.allSettled(Ce.map($e=>window.auth.invokeFunction("smart-worker",{body:{userId:g,b64_json:$e.includes(",")?$e.split(",")[1]:$e,subfolder:"ELINA"}})))).filter($e=>$e.status==="fulfilled").map($e=>{var Fe,Ke;return(Ke=(Fe=$e.value)==null?void 0:Fe.data)==null?void 0:Ke.cdnUrl}).filter(Boolean);if(Ve.length){const $e=Ve.map(Fe=>({id:Fe,src:Fe}));u.unshift(...$e);try{const Fe=u.map(Ke=>Ke.src);await window.auth.sb.from("profiles").update({gallery_images:Fe}).eq("id",g)}catch(Fe){console.error("No se pudo guardar la galería en el perfil:",Fe)}}p.used=P.used||p.used+1,i(),window.showToast("Imágenes generadas correctamente.","success")}function ee(g){const $=[],P=T.aspectRatio;let U=g;P&&P!=="auto"&&(U=`${g}

Render the image using a ${P} aspect ratio.`);const te=(le,Ce)=>{!Ce||!Ce.base64||!Ce.mimeType||(le&&$.push({text:le}),$.push({inlineData:{data:Ce.base64,mimeType:Ce.mimeType}}))};if(t==="flyer"){const le=N.images||{};if(te("BACKGROUND IMAGE: Usa esta imagen como fondo completo sin distorsionarla.",le.background),le.product){const Ce=N.removeProductBg?"PRODUCT IMAGE: Incluye este producto en el diseno y elimina su fondo original.":"PRODUCT IMAGE: Incluye este producto en el diseno respetando su fondo.";te(Ce,le.product)}te("LOGO IMAGE: Manten la integridad del logo.",le.logo),["ref1","ref2","ref3"].forEach(Ce=>{te("STYLE REFERENCE: Utiliza esta imagen como inspiracion visual.",le[Ce])})}else if(t==="product"){const le=G.images||{};te("PRIMARY PRODUCT IMAGE: Manten la fidelidad del producto.",le.main),te("SECONDARY IMAGE 1: Usa esta referencia solo para detalles adicionales.",le.opt1),te("SECONDARY IMAGE 2: Usa esta referencia solo para detalles adicionales.",le.opt2)}else if(t==="headshot"){const le=H.images||{};["ref1","ref2","ref3"].forEach(Ce=>{te("FACE REFERENCE: Preserva la identidad de la persona.",le[Ce])})}return $.push({text:U}),$}function ae(){return t==="flyer"?N.finalPrompt:t==="product"?G.finalPrompt:t==="headshot"?H.finalPrompt:null}function ue(g){if(!g)return;const $=document.createElement("a");$.href=g;const U=g.split(";")[0].split(":")[1].split("/")[1]||"png";$.download=`elina-design-${Date.now()}.${U}`,document.body.appendChild($),$.click(),document.body.removeChild($)}function ie(){const g=document.getElementById("designer-ai");if(!g)return;let $="";switch(t){case"flyer":$=I();break;case"product":$=q();break;case"headshot":$=F();break;case"home":default:$=me()}g.innerHTML=$,lucide.createIcons(),t!=="home"&&pe();const P=g.querySelector("#image-provider-select");if(P){const le=T.provider||"gemini",Ce=T.kieModel||"google/imagen4-fast";let Me=le;le==="kie"&&(Ce==="google/imagen4-fast"?Me="kie":Ce==="flux-2/pro-text-to-image"?Me="kie-flux-text":Ce==="flux-2/pro-image-to-image"&&(Me="kie-flux-image")),P.value=Me,P.addEventListener("change",je=>{const $e=je.target.value;$e==="gemini"?T.provider="gemini":$e==="kie"?(T.provider="kie",T.kieModel="google/imagen4-fast"):$e==="kie-flux-text"?(T.provider="kie-flux-text",T.kieModel="flux-2/pro-text-to-image"):$e==="kie-flux-image"&&(T.provider="kie-flux-image",T.kieModel="flux-2/pro-image-to-image");const Fe=g.querySelector("#kie-model-settings"),Ke=g.querySelector("#flux-resolution-setting");Fe&&Fe.classList.toggle("hidden",$e==="gemini"),Ke&&Ke.classList.toggle("hidden",$e!=="kie-flux-text"&&$e!=="kie-flux-image")});const Ge=g.querySelector("#kie-model-settings"),Ve=g.querySelector("#flux-resolution-setting");Ge&&Ge.classList.toggle("hidden",Me==="gemini"),Ve&&Ve.classList.toggle("hidden",Me!=="kie-flux-text"&&Me!=="kie-flux-image")}const U=g.querySelector("#kie-resolution-select");U&&(U.value=T.resolution||"1K",U.addEventListener("change",le=>{T.resolution=le.target.value}));const te=g.querySelector("#image-aspect-ratio-select");te&&(te.value=T.aspectRatio,te.addEventListener("change",le=>{T.aspectRatio=le.target.value,document.dispatchEvent(new CustomEvent("designer-ai:aspect-ratio-changed",{detail:{aspectRatio:T.aspectRatio}}))})),h()}function me(){return`
            <div class="text-center">
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Creador de Contenido con IA</h1>
                <p class="text-slate-500 mt-2 mb-8">Elige una herramienta para empezar.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                    <button data-tool="flyer" class="start-option-btn">
                        <img src="https://creativersezone.b-cdn.net/ELINA/media%20app/Gemini_Generated_Image_dvylmddvylmddvyl.png" alt="Crear Flyer" class="start-option-img" />
                        <div class="start-option-overlay">
                            <h3 class="font-semibold text-lg">Crear Flyer para Redes Sociales</h3>
                            <p class="text-sm text-gray-300 mt-1">Para promos, anuncios y comunicados.</p>
                        </div>
                    </button>
                    <button data-tool="product" class="start-option-btn">
                        <img src="https://creativersezone.b-cdn.net/ELINA/media%20app/Gemini_Generated_Image_fexq2ufexq2ufexq.png" alt="Visualizar Producto" class="start-option-img" />
                        <div class="start-option-overlay">
                            <h3 class="font-semibold text-lg">Visualizar Producto</h3>
                            <p class="text-sm text-gray-300 mt-1">Coloca tu producto en diferentes escenarios.</p>
                        </div>
                    </button>
                    <button data-tool="headshot" class="start-option-btn">
                        <img src="https://creativersezone.b-cdn.net/ELINA/media%20app/smarportrairt/Gemini_Generated_Image_vsl3jdvsl3jdvsl3.png" alt="Estudio Fotografico IA" class="start-option-img" />
                        <div class="start-option-overlay">
                            <h3 class="font-semibold text-lg">Estudio Fotografico IA</h3>
                            <p class="text-sm text-gray-300 mt-1">Crea fotos de perfil profesionales.</p>
                        </div>
                    </button>
                </div>
                ${u.length>0?`
                    <div class="mt-12">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Tus Últimas Creaciones</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 home-gallery-container">
                            ${u.slice(0,6).map(g=>`
                                <div class="gallery-item-home aspect-square bg-slate-200 rounded-lg overflow-hidden group relative cursor-pointer" data-image-src="${g.src}" data-image-id="${g.id||g.src}">
                                    <img src="${g.src}" alt="Imagen generada" class="w-full h-full object-cover">
                                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                        <i data-lucide="zoom-in" class="w-8 h-8 text-white"></i>
                                    </div>
                                </div>
                            `).join("")}
                        </div> 
                        <button id="view-all-gallery-btn" class="mt-6 inline-flex items-center justify-center gap-2 px-5 py-2.5 rounded-lg bg-blue-500 hover:bg-blue-400 text-white font-semibold shadow-md transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300 mx-auto">
                            Ver más
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                `:""}
            </div>
        `}function fe(g,$,P){return`
            <nav class="main-nav mb-8">
                <button data-tool="home" class="nav-btn ${t==="home"?"active":""}"><i data-lucide="home" class="w-4 h-4 mr-2"></i>Inicio</button>
                <button data-tool="flyer" class="nav-btn ${t==="flyer"?"active":""}"><i data-lucide="layout-template" class="w-4 h-4 mr-2"></i>Flyers</button>
                <button data-tool="product" class="nav-btn ${t==="product"?"active":""}"><i data-lucide="gem" class="w-4 h-4 mr-2"></i>Producto</button>
                <button data-tool="headshot" class="nav-btn ${t==="headshot"?"active":""}"><i data-lucide="user-round" class="w-4 h-4 mr-2"></i>Estudio IA</button>
            </nav>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-slate-900">${g}</h2>
                    <p class="text-slate-500 mt-1 mb-6">${$}</p>
                    ${P}
                </div>
                <div class="lg:col-span-2 space-y-4 lg:sticky lg:top-6 self-start flex flex-col">
                    <div class="output-image-container dark-bg relative">
                        ${L?'<div class="absolute inset-0 flex items-center justify-center"><div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500"></div></div>':""} 
                        ${!L&&n?`
                            <div class="relative w-full h-full group aspect-square">
                                <img src="${n}" alt="Generated result" class="w-full h-full object-cover" />
                                <button class="download-btn">Descargar</button>
                            </div>
                        `:""}
                        ${!L&&!n?'<div class="placeholder-icon dark-placeholder"><i data-lucide="image-down"></i><p>El resultado aparecerá aquí</p></div>':""}
                    </div>
                    <div class="bg-slate-100 rounded-lg p-3 text-left space-y-2">
                        <div>
                            <label class="text-xs font-semibold text-slate-600 block mb-1">Proveedor de IA</label>
                            <select id="image-provider-select" class="form-input w-full text-sm mb-2" disabled>
                                <option value="gemini" selected>Gemini (Google)</option>
                            </select>
                            <p class="text-[10px] text-slate-500 mt-1">Usando Gemini para generación de imágenes</p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-slate-600 block mb-1">Relación de aspecto</label>
                            <select id="image-aspect-ratio-select" class="form-input w-full text-sm">
                                <option value="auto">Auto (sin forzar)</option>
                                <option value="1:1">1:1 (Cuadrada)</option>
                                <option value="16:9">16:9 (Horizontal)</option>
                                <option value="9:16">9:16 (Vertical)</option>
                                <option value="4:5">4:5</option>
                                <option value="5:4">5:4</option>
                                <option value="3:2">3:2</option>
                                <option value="2:3">2:3</option>
                                <option value="4:3">4:3</option>
                                <option value="3:4">3:4</option>
                                <option value="21:9">21:9</option>
                            </select>
                        </div>
                        <p class="text-[11px] text-slate-500">Esta configuración ajusta el prompt enviado para respetar el formato final.</p>
                    </div>
                    <div class="mt-2 bg-slate-100 rounded-lg p-3 text-center">
                         <h4 class="font-bold text-sm mb-1 text-slate-700">Uso Mensual</h4>
                         <p class="text-xs text-slate-600">Imágenes generadas: <span id="${t}-image-generation-usage" class="font-bold">0 / 0</span></p>
                    </div><button class="primary-btn !mt-4 w-full generate-btn animate-pulse-blue" ${L||p.limit>0&&p.used>=p.limit?"disabled":""}>${L?'<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div> Generando...':"Generar"}</button>
                    ${a.length>0?` 
                        <div class="pt-4 border-t">
                            <h3 class="text-sm font-medium text-slate-500 mb-2">Resultados (${a.length} opciones)</h3>
                            <div class="grid grid-cols-4 gap-2">
                               ${a.map(U=>`
                                    <div class="gallery-thumbnail-wrapper">
                                        <img src="${U.src}" alt="Generated thumbnail" class="gallery-thumbnail ${n===U.src?"active":""}" />
                                    </div>
                                `).join("")}
                            </div>
                        </div>
                    `:""}
                </div>
            </div>
        `}function I(){const g=`
            <div class="space-y-6">
                <div>
                    <label class="text-sm font-medium">1. Sube tus imágenes (Opcional)</label>
                    <div class="grid grid-cols-3 gap-4 mt-1">
                       ${D("flyer-upload-logo","Logo","(Opcional)",N.images.logo)}
                       <div>
                            ${D("flyer-upload-product","Producto","(Opcional)",N.images.product)}
                            <div class="flex items-center mt-2 justify-center" onclick="event.stopPropagation()">
                                <input type="checkbox" id="remove-bg-check" ${N.removeProductBg?"checked":""} class="form-checkbox rounded text-blue-600" />
                                <label for="remove-bg-check" class="ml-2 text-xs text-gray-500">Quitar fondo</label>
                            </div>
                       </div>
                       ${D("flyer-upload-background","Fondo","(Opcional)",N.images.background)}
                       ${D("flyer-upload-ref1","Ref. Estilo 1","(Opcional)",N.images.ref1)}
                       ${D("flyer-upload-ref2","Ref. Estilo 2","(Opcional)",N.images.ref2)}
                       ${D("flyer-upload-ref3","Ref. Estilo 3","(Opcional)",N.images.ref3)}
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                       <label class="text-sm font-medium">2. Elige un estilo base</label>
                       ${K(be,"flyer-style",N.flyerStyle)}
                    </div>
                     <div>
                        <label class="text-sm font-medium">3. Completa la información del flyer</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2 text-input-grid">
                            <div class="text-input-wrapper">
                                <label>Texto Principal</label>
                                <textarea data-flyer_text="headline" placeholder="Ej: 50% DE DESCUENTO">${N.textInputs.headline}</textarea>
                            </div>
                            <div class="text-input-wrapper">
                                <label>Texto Secundario</label>
                                <textarea data-flyer_text="secondary" placeholder="Ej: Solo esta semana">${N.textInputs.secondary}</textarea>
                            </div>
                            <div class="text-input-wrapper">
                                <label>Precio / Llamada a la acción</label>
                                <textarea data-flyer_text="price" placeholder="Ej: $99.99 o ¡Inscríbete!">${N.textInputs.price}</textarea>
                            </div>
                            <div class="text-input-wrapper">
                                <label>Términos / Info Adicional</label>
                                <textarea data-flyer_text="terms" placeholder="Ej: Válido hasta agotar existencias">${N.textInputs.terms}</textarea>
                            </div>
                             <div class="md:col-span-2 text-input-wrapper">
                                <label>Elementos Visuales a Incluir</label>
                                <textarea data-flyer_text="visuals" placeholder="Ej: mujer con laptop, íconos de tecnología, un cerebro brillante">${N.textInputs.visuals}</textarea>
                            </div>
                            <!-- INICIO: CORRECCIÓN - Mostrar campo de estilo solo si es manual -->
                            <div class="md:col-span-2 text-input-wrapper ${N.flyerStyle==="none"?"":"hidden"}" data-flyer-style-manual>
                                <label>Describe tu Estilo Personalizado</label>
                                <textarea data-flyer_text="styleMods" placeholder="Ej: estética futurista, patrones de circuitos, colores neón">${N.textInputs.styleMods}</textarea>
                            </div>
                            <!-- FIN: CORRECCIÓN -->
                        </div>
                    </div>
                     <div>
                        <label class="text-sm font-medium">4. Define tu paleta de colores</label>
                        ${ge(N.colors)}
                    </div>
                     <div class="!mt-4">
                        <label class="text-xs font-medium text-slate-500">Prompt Final (Solo para referencia)</label>
                        <pre class="prompt-display" data-role="prompt-display">${N.finalPrompt}</pre>
                    </div>
                </div>
            </div>
        `;return fe("Creador de Flyers","Crea flyers promocionales para redes sociales.",g)}function q(){const g=!!G.images.main,$=`
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-medium">1. Sube tu producto</label>
                    <div class="grid grid-cols-3 gap-2 mt-1">
                       ${D("product-upload-main","Imagen Principal","(Obligatorio)",G.images.main)}
                       ${D("product-upload-opt1","Opcional 1","(Detalles)",G.images.opt1)}
                       ${D("product-upload-opt2","Opcional 2","(Contexto)",G.images.opt2)}
                    </div>
                </div>
                <fieldset class="space-y-4 ${g?"fieldset-enabled":"fieldset-disabled"}">
                    <div>
                        <label class="text-sm font-medium">2. Elige un modo</label>
                        <div class="grid grid-cols-2 gap-3 mt-1">
                            <button data-mode="product-only" class="mode-selector-btn ${G.mode==="product-only"?"active":""}">
                                <img src="https://creativersezone.b-cdn.net/ELINA/media%20app/product/fondo%20texturizado.png" alt="Producto en un escenario" class="mode-selector-img" />
                                <div class="mode-selector-overlay"><h3 class="font-semibold text-base">Producto Solo</h3></div>
                            </button>
                            <button data-mode="with-human" class="mode-selector-btn ${G.mode==="with-human"?"active":""}">
                                <img src="https://creativersezone.b-cdn.net/ELINA/media%20app/product/lifestyle.png" alt="Producto con persona" class="mode-selector-img" />
                                <div class="mode-selector-overlay"><h3 class="font-semibold text-base">Con Persona</h3></div>
                            </button>
                        </div>
                    </div>
                    ${G.mode==="product-only"?`
                        <div class="space-y-4 fade-in">
                            <div>
                                <label class="text-sm font-medium">3. Elige un entorno</label>
                                ${K(he,"environment",G.productOnlyData.environment)}
                            </div>
                             <div>
                                <div class="text-input-wrapper">
                                    <label>4. AÃ±ade detalles (Opcional)</label>
                                    <textarea data-product_text="customPrompt" placeholder="Ej: con un toque de vapor saliendo, sobre una superficie reflectante">${G.productOnlyData.customPrompt}</textarea>
                                </div>
                            </div>
                        </div>
                    `:`
                         <div class="space-y-4 fade-in">
                            <div>
                                <label class="text-sm font-medium">3. Define la escena</label>
                                <div class="space-y-4 p-3 bg-slate-100 rounded-lg mt-1">
                                    <div>
                                        <h4 class="text-xs font-bold text-slate-500">QUIÃN LO USA</h4>
                                        ${K(X,"who",G.lifestyleData.who)}
                                        <div class="text-input-wrapper mt-2">
                                            <label class="hidden">Detalles de quiÃ©n</label>
                                            <textarea data-lifestyle_text="whoCustom" rows="1" placeholder="Detalles (Ej: una mujer joven, sonriendo)">${G.lifestyleData.whoCustom}</textarea>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-bold text-slate-500">DÃNDE LO USA</h4>
                                        ${K(ce,"where",G.lifestyleData.where)}
                                        <div class="text-input-wrapper mt-2">
                                            <label class="hidden">Detalles de dÃ³nde</label>
                                            <textarea data-lifestyle_text="whereCustom" rows="1" placeholder="Detalles (Ej: en un balcÃ³n con vistas)">${G.lifestyleData.whereCustom}</textarea>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-bold text-slate-500">CUÃNDO LO USA</h4>
                                        ${K(W,"when",G.lifestyleData.when)}
                                        <div class="text-input-wrapper mt-2">
                                            <label class="hidden">Detalles de cuÃ¡ndo</label>
                                            <textarea data-lifestyle_text="whenCustom" rows="1" placeholder="Detalles (Ej: la luz del sol se filtra)">${G.lifestyleData.whenCustom}</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `}
                    <div class="!mt-4"> 
                        <label class="text-xs font-medium text-slate-500">Prompt Final (Solo para referencia)</label>
                        <pre class="prompt-display" data-role="prompt-display">${G.finalPrompt}</pre>
                    </div>
            </div>
        `;return fe("Visualizador de Producto","Coloca tu producto en diferentes escenarios profesionales.",$)}function F(){const g=`
            <div class="space-y-6">
                <div>
                    <label class="text-sm font-medium">1. Sube tus fotos de referencia (1-3)</label>
                    <p class="text-xs text-slate-500 mt-1">Sube fotos claras de tu rostro desde diferentes Ã¡ngulos para obtener el mejor resultado.</p>
                    <div class="grid grid-cols-3 gap-4 mt-2">
                       ${D("headshot-upload-ref1","Foto Principal","(Obligatorio)",H.images.ref1)}
                       ${D("headshot-upload-ref2","Foto Opcional 2","",H.images.ref2)}
                       ${D("headshot-upload-ref3","Foto Opcional 3","",H.images.ref3)}
                    </div>
                </div>
                <div>
                    <label class="text-sm font-medium">2. Elige un escenario</label>
                    ${K(J,"headshot-scene",H.scene)}
                </div>
            </div>
        `;return fe("Estudio FotogrÃ¡fico IA","Crea fotos de perfil profesionales a partir de tus propias imÃ¡genes.",g)}function D(g,$,P,U){const te=U?`data:${U.mimeType};base64,${U.base64}`:null;return`
            <div class="image-upload-slot" data-upload-id="${g}">
                <label for="${g}" class="upload-label">
                    ${U?"":`
                        <div class="text-center text-xs text-gray-500">
                            <p class="font-semibold">${$}</p>
                            <p>${P}</p>
                        </div>
                    `}
                </label>
                ${U?`<img src="${te}" alt="Preview" class="image-preview" />`:""}
                ${U?`<button class="remove-button" data-remove-id="${g}"><i data-lucide="x" class="w-4 h-4 pointer-events-none"></i></button>`:""}
                <input id="${g}" type="file" class="hidden" accept="image/*" />
            </div>
        `}function K(g,$,P){return`
            <div class="grid grid-cols-4 gap-3 mt-2">
                ${Object.entries(g).map(([U,te])=>`
                    <div>
                        <input type="radio" id="${$}-${U}" name="${$}" value="${U}" class="hidden peer" ${P===U?"checked":""} />
                        <label for="${$}-${U}" class="style-selector-label group">
                            <img src="${te.image}" alt="${te.name}" class="style-thumbnail" />
                            <div class="style-text-overlay">${te.name}</div>
                        </label>
                    </div>
                `).join("")}
            </div>
        `}function ge(g){return`
            <div class="color-palette-container">
                ${g.map(($,P)=>`
                    <div class="color-swatch-wrapper">
                        <input type="color" value="${$}" data-index="${P}" class="color-swatch-input" />
                        <span class="color-swatch-hex">${$}</span>
                    </div>
                `).join("")}
            </div>
        `}function pe(){document.querySelectorAll(".image-upload-slot").forEach(g=>{var U;const $=g.dataset.uploadId,P=document.getElementById($);(U=g.querySelector(".remove-button"))==null||U.addEventListener("click",te=>{te.preventDefault(),te.stopPropagation(),_e(null,$)}),P.addEventListener("change",te=>{var le;return _e(((le=te.target.files)==null?void 0:le[0])||null,$)}),g.addEventListener("dragover",te=>{te.preventDefault(),g.classList.add("dragging-over")}),g.addEventListener("dragleave",te=>{te.preventDefault(),g.classList.remove("dragging-over")}),g.addEventListener("drop",te=>{var le;te.preventDefault(),g.classList.remove("dragging-over"),_e(((le=te.dataTransfer.files)==null?void 0:le[0])||null,$)})})}async function _e(g,$){const U=(le=>le.startsWith("flyer-")?le.replace("flyer-upload-",""):le.startsWith("product-")?le.replace("product-upload-",""):le.startsWith("headshot-")?le.replace("headshot-upload-",""):null)($);if(!U)return;let te=null;if(g&&g.type.startsWith("image/"))try{te={base64:await we(g),mimeType:g.type}}catch(le){console.error("Error leyendo el archivo:",le),window.showToast("Error al leer el archivo.","error")}t==="flyer"?N.images[U]=te:t==="product"?G.images[U]=te:t==="headshot"&&(H.images[U]=te),ie()}function we(g){return new Promise(($,P)=>{const U=new FileReader;U.onload=()=>$(U.result.split(",")[1]),U.onerror=te=>P(te),U.readAsDataURL(g)})}async function xe(g){if(!g||typeof g!="string"||g.trim()==="")return console.warn("urlToImageFile: URL inválida o vacía:",g),null;try{new URL(g)}catch{return console.warn("urlToImageFile: URL no tiene formato válido:",g),null}try{const{data:$,error:P}=await window.auth.invokeFunction("image-proxy",{body:{url:g.trim()}});if(P){if(P.status===400||P.statusCode===400)console.warn("image-proxy: Error 400 - URL inválida o parámetros incorrectos:",g);else throw new Error(`Proxy error: ${P.message||"Error desconocido"}`);return null}return!$||!$.base64||!$.mimeType?(console.warn("image-proxy: Respuesta inválida - falta base64 o mimeType"),null):{base64:$.base64,mimeType:$.mimeType}}catch($){return console.error(`Error al convertir la URL ${g} a Base64:`,$),null}}function Se(){var P;const g=document.getElementById("full-gallery-modal"),$=document.getElementById("full-gallery-content");!g||!$||($.innerHTML=`
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                ${u.map(U=>`
                    <div class="aspect-square bg-slate-200 rounded-lg overflow-hidden group relative">
                        <img src="${U.src}" alt="Imagen generada" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <button class="view-image-btn p-2 bg-white/80 rounded-full" data-src="${U.src}">
                                <i data-lucide="zoom-in" class="w-6 h-6 text-slate-800 pointer-events-none"></i>
                            </button>
                        </div>
                    </div>
                `).join("")}
            </div>
        `,g.classList.remove("hidden"),lucide.createIcons(),(P=document.getElementById("close-full-gallery-modal-btn"))==null||P.addEventListener("click",()=>g.classList.add("hidden"),{once:!0}),$.addEventListener("click",U=>{const te=U.target.closest(".view-image-btn");te&&Ee(te.dataset.src,"Imagen de la galerÃ­a")}))}function Ee(g,$="Vista previa de imagen",P="imagen.png"){var Me;const U=document.getElementById("image-viewer-modal"),te=document.getElementById("image-viewer-content"),le=document.getElementById("download-image-viewer-btn"),Ce=document.getElementById("close-image-viewer-btn");!U||!te||!g||(te.innerHTML=`<img src="${g}" alt="${$}" class="max-h-[80vh] max-w-[85vw] object-contain rounded-lg shadow-2xl">`,le&&(le.onclick=Ge=>{var Ve,je;Ge.preventDefault(),Ge.stopPropagation();try{const $e=document.createElement("a");$e.href=g,$e.download=P,$e.target="_blank",$e.rel="noopener noreferrer",document.body.appendChild($e),$e.click(),setTimeout(()=>{document.body.removeChild($e)},100),(Ve=window.showToast)==null||Ve.call(window,'Descarga iniciada. Si no funciona, haz clic derecho en la imagen y "Guardar como"',"success")}catch($e){console.error("Error al descargar imagen:",$e),window.open(g,"_blank"),(je=window.showToast)==null||je.call(window,"Abre la imagen en una nueva pestaña y guárdala desde ahí","info")}}),Ce&&(Ce.onclick=Ge=>{Ge.preventDefault(),Ge.stopPropagation(),U.classList.add("hidden")}),U.onclick=Ge=>{Ge.target===U&&U.classList.add("hidden")},U.classList.remove("hidden"),(Me=window.lucide)!=null&&Me.createIcons&&window.lucide.createIcons({root:U}))}})();(function(){let Be=!1,t=[],a=[];const n=24;document.addEventListener("panel:activated",({detail:X})=>{X.panelId==="follow-ups"&&!Be&&(u(),Be=!0)});async function u(){console.log("Inicializando panel de Seguimientos..."),Be=!0,await p(),f()}async function p(){var W,J;const X=document.getElementById("followups-list");if(!X)return;X.innerHTML='<div id="followups-loader" class="text-center text-slate-500 p-8">Cargando secuencias...</div>';const ce=X.querySelector("#followups-loader");try{const Y=(J=(W=window.auth.getSession())==null?void 0:W.user)==null?void 0:J.id,[A,M]=await Promise.all([window.auth.sb.from("followups").select("*").eq("user_id",Y),window.auth.sb.from("labels").select("name").eq("user_id",Y)]);if(A.error)throw A.error;if(M.error)throw M.error;t=A.data,a=M.data.map(_=>_.name).sort(),L()}catch(Y){console.error("Error al cargar datos de seguimientos:",Y),ce&&(ce.textContent="Error al cargar datos.")}finally{}}function f(){var X,ce,W,J,Y,A,M;(X=document.getElementById("add-sequence-btn"))==null||X.addEventListener("click",()=>T(null)),(ce=document.getElementById("cancel-sequence-btn"))==null||ce.addEventListener("click",z),(W=document.getElementById("sequence-form"))==null||W.addEventListener("submit",G),(J=document.getElementById("delete-sequence-btn"))==null||J.addEventListener("click",be),(Y=document.getElementById("add-message-btn"))==null||Y.addEventListener("click",()=>H()),(A=document.getElementById("follow-ups-container"))==null||A.addEventListener("click",_=>{const R=_.target.closest(".toggle-follow-up-btn");R&&he(R);const y=_.target.closest(".edit-follow-up-btn");if(y){const m=y.dataset.id,w=t.find(l=>l.id==m);w&&T(w)}}),(M=document.getElementById("messages-container"))==null||M.addEventListener("click",_=>{_.target.closest(".remove-step-btn")&&(_.target.closest(".message-step").remove(),N()),_.target.classList.contains("upload-file-btn")&&_.target.previousElementSibling.click()})}function L(){const X=document.getElementById("followups-list");if(!X)return;const ce=X.querySelector("#followups-loader");if(ce&&ce.classList.add("hidden"),t.length===0){X.innerHTML='<p class="text-slate-500 text-center p-8">No has creado ninguna secuencia de seguimiento.</p>';return}X.innerHTML=t.map(W=>`
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="text-lg font-bold text-slate-900">${`Secuencia para "${W.target_label}"`}</h4>
                        <p class="text-sm text-slate-500">Se activa con la etiqueta: <span class="font-semibold text-blue-600">${W.target_label}</span></p>
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer toggle-follow-up-btn" data-id="${W.id}" ${W.is_active?"checked":""}>
                            <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600" title="${W.is_active?"Secuencia Activa":"Secuencia Inactiva"}"></div>
                        </label>
                        <button class="edit-follow-up-btn text-blue-600 hover:underline font-semibold flex items-center gap-1 ml-3" data-id="${W.id}">
                            <i data-lucide="edit-2" class="w-4 h-4"></i> Editar
                        </button>
                    </div>
                </div>
            </div>
        `).join(""),lucide.createIcons()}function T(X){var Y;const ce=document.getElementById("sequence-modal");document.getElementById("sequence-form").reset(),document.getElementById("sequence-modal-title").textContent=X?"Editar Secuencia":"Crear Nueva Secuencia",document.getElementById("sequence-id").value=(X==null?void 0:X.id)||"";const W=document.getElementById("sequence-target-label");W.innerHTML='<option value="">-- Selecciona una etiqueta --</option>'+a.map(A=>`<option value="${A}">${A}</option>`).join(""),X&&(W.value=X.target_label),document.getElementById("sequence-is-active").checked=X?X.is_active:!0;const J=document.getElementById("messages-container");if(J.innerHTML="",((Y=X==null?void 0:X.messages)==null?void 0:Y.length)>0){const A=typeof X.messages=="string"?JSON.parse(X.messages):X.messages,M=Array.isArray(X.timings)?X.timings:typeof X.timings=="string"?JSON.parse(X.timings):[],_=Array.isArray(X.file_urls)?X.file_urls:typeof X.file_urls=="string"?JSON.parse(X.file_urls):[];A.forEach((R,y)=>{var m;H({message:R,delay:((m=M[y])==null?void 0:m.delay)??n,fileUrl:(_==null?void 0:_[y])??""})})}else H();document.getElementById("delete-sequence-btn").classList.toggle("hidden",!X),ce.classList.remove("hidden"),lucide.createIcons()}function z(){document.getElementById("sequence-modal").classList.add("hidden")}function H(X={message:"",delay:n,fileUrl:""}){const ce=document.getElementById("messages-container"),W=document.getElementById("add-message-btn");if(ce.querySelectorAll(".message-step").length>=3){window.showToast("Puedes añadir un máximo de 3 mensajes por secuencia.","info");return}const Y=document.getElementById("message-step-template").content.cloneNode(!0);Y.querySelector(".step-message").value=X.message,Y.querySelector(".step-delay").value=X.delay??n;const A=Y.querySelector(".file-name-display"),M=Y.querySelector(".step-image-preview");X.fileUrl&&(/\.(jpg|jpeg|png|gif|webp)$/i.test(X.fileUrl)&&(M.src=X.fileUrl,M.classList.remove("hidden")),A.textContent=X.fileUrl.split("/").pop(),A.dataset.existingUrl=X.fileUrl),Y.querySelector(".step-file-input").addEventListener("change",_=>{A.textContent=_.target.files[0]?_.target.files[0].name:"Ningún archivo seleccionado",A.dataset.existingUrl=""}),ce.appendChild(Y),N(),ce.querySelectorAll(".message-step").length>=3?W.classList.add("hidden"):W.classList.remove("hidden"),lucide.createIcons()}function N(){document.querySelectorAll(".message-step").forEach((ce,W)=>{ce.querySelector(".step-number").textContent=W+1});const X=document.getElementById("add-message-btn");document.querySelectorAll(".message-step").length<3&&X.classList.remove("hidden")}async function G(X){var _,R;X.preventDefault();const ce=document.getElementById("save-sequence-btn");ce.disabled=!0,ce.textContent="Guardando...";const W=document.getElementById("sequence-id").value,J=Array.from(document.querySelectorAll(".message-step")),Y=J.map(async y=>{const m=y.querySelector(".step-file-input"),w=y.querySelector(".file-name-display");return m.files[0]?await window.appInstance.uploadAsset(m.files[0],"follow-ups"):w.dataset.existingUrl?w.dataset.existingUrl:null}),A=await Promise.all(Y),M={user_id:(R=(_=window.auth.getSession())==null?void 0:_.user)==null?void 0:R.id,target_label:document.getElementById("sequence-target-label").value,is_active:document.getElementById("sequence-is-active").checked,messages:J.map(y=>y.querySelector(".step-message").value),timings:J.map(y=>({delay:parseInt(y.querySelector(".step-delay").value)||n})),file_urls:A,follow_up_count:J.length};try{const y=W?window.auth.sb.from("followups").update(M).eq("id",W).select().single():window.auth.sb.from("followups").insert(M).select().single(),{data:m,error:w}=await y;if(w)throw w;if(M.is_active&&M.target_label){console.log(`Reintegrando contactos con la etiqueta: ${M.target_label}`);const{error:l}=await window.auth.sb.rpc("reassign_followup_to_contacts_with_label",{p_user_id:M.user_id,p_target_label:M.target_label,p_followup_id:m.id});l&&(console.error("Error al reintegrar contactos:",l),window.showToast("Secuencia guardada, pero hubo un error al reintegrar los contactos existentes.","warning"))}window.showToast("Secuencia guardada con éxito.","success"),z(),await p(),L()}catch(y){console.error("Error al guardar la secuencia:",y),window.showToast(`Error: ${y.message}`,"error")}finally{ce.disabled=!1,ce.textContent="Guardar Secuencia"}}async function be(){const X=document.getElementById("sequence-id").value;if(!(!X||!confirm("¿Estás seguro de que quieres eliminar esta secuencia?")))try{const{error:ce}=await window.auth.sb.from("followups").delete().eq("id",X);if(ce)throw ce;window.showToast("Secuencia eliminada.","info"),z(),await p(),L()}catch(ce){console.error("Error al eliminar:",ce),window.showToast(`Error: ${ce.message}`,"error")}}async function he(X){const ce=X.dataset.id,W=X.checked;X.disabled=!0;try{const{error:J}=await window.auth.sb.from("followups").update({is_active:W}).eq("id",ce);if(J)throw J;const Y=t.find(A=>A.id==ce);Y&&(Y.is_active=W)}catch(J){console.error("Error al cambiar estado:",J),X.checked=!W}finally{X.disabled=!1}}})();(function(){let Be=!1,t=[],a=[],n=[],u="_individual_",p=null;function f(m){var s,i,h;const w=(s=window.appInstance)==null?void 0:s.teamInfo;if((w==null?void 0:w.user_role)!=="advisor")return null;const l=((i=w==null?void 0:w.permissions)==null?void 0:i.label_filters)||((h=w==null?void 0:w.permissions)==null?void 0:h.labelFilters),e=l==null?void 0:l[m];return!Array.isArray(e)||e.length===0?null:e.filter(Boolean)}function L(m){if(!m)return[];const w=[m.members,m.team_members,m.teamMembers,m.member_list].filter(Array.isArray);if(!w.length)return[];const l=[];for(const e of w)if(e.forEach(s=>{const i=(s==null?void 0:s.user_id)||(s==null?void 0:s.id)||(s==null?void 0:s.member_id)||(s==null?void 0:s.userId);i&&l.push({user_id:i,profiles:s.profiles||{full_name:s.full_name||s.name||null,email:s.email||null}})}),l.length)break;return l}async function T(){Be||(console.log("Inicializando panel Kanban..."),Be=!0,await z(),H(),G())}document.addEventListener("panel:activated",({detail:m})=>{m.panelId==="kanban"?(Be||T(),R()):y()});async function z(){const m=document.getElementById("kanban-loader");m&&m.classList.remove("hidden");try{const w=window.auth.getSession();if(!w)throw new Error("No hay sesión activa.");const l=w.user.id,e=await window.appInstance.loadTeamInfo(),s=window.auth.sb.from("labels").select("*").eq("user_id",l),i=window.auth.sb.from("contacts").select("id, full_name, phone_number, labels, razon_de_label_auto, assigned_to_id"),[h,x]=await Promise.all([s,i]);if(h.error)throw h.error;if(x.error)throw x.error;if(t=h.data,n=x.data,a=[],(e==null?void 0:e.user_role)==="admin"){let se=L(e);if(se.length){const C=se.map(b=>b.user_id).filter(Boolean);if(C.length){const{data:b,error:j}=await window.auth.sb.from("profiles").select("id, full_name, email").in("id",C);if(j)console.warn("Error al obtener perfiles de miembros del equipo:",j),a=se.map(O=>({...O,profiles:null}));else{const O=Object.fromEntries((b||[]).map(ee=>[ee.id,ee]));a=se.map(ee=>({...ee,profiles:O[ee.user_id]||null}))}}else a=se.map(b=>({...b,profiles:null}))}else console.warn("No se obtuvo información de miembros del equipo desde teamInfo. La asignación de asesores podría no estar disponible.")}}catch(w){console.error("Error al cargar datos para Kanban:",w),m&&(m.textContent="Error al cargar datos.")}finally{m&&m.classList.add("hidden")}}function H(){var w,l,e;const m=document.getElementById("kanban");m&&(m.addEventListener("click",s=>{s.target.id==="kanban-individual-btn"&&(N(s.target),u="_individual_",be(u))}),m.addEventListener("change",s=>{s.target.id==="kanban-funnel-select"&&(N(s.target),u=s.target.value||"_individual_",be(u))}),(w=document.getElementById("kanban-board"))==null||w.addEventListener("click",s=>{const i=s.target.closest('[data-lucide="info"]');i&&W(i.closest(".kanban-card").dataset.contactId)}),(l=document.getElementById("kanban-board"))==null||l.addEventListener("change",s=>{s.target.classList.contains("assign-advisor-select")&&ce(s.target.dataset.contactId,s.target.value)}),(e=document.getElementById("kanban-board"))==null||e.addEventListener("mouseover",s=>{J(s)}))}function N(m){document.querySelectorAll("#kanban-controls .kanban-control-item").forEach(l=>{l.classList.remove("bg-blue-600","text-white","border-blue-500","ring-2","ring-blue-200","ring-blue-300"),l.classList.add("border-slate-300","bg-white","text-slate-700","shadow-sm")});const w=m.closest(".kanban-control-item");w&&(w.classList.remove("border-slate-300"),w.classList.add("border-blue-500","ring-2","ring-blue-300"),w.tagName==="BUTTON"?(w.classList.add("bg-blue-600","text-white"),w.classList.remove("bg-white","text-slate-700")):w.classList.add("ring-blue-300"))}function G(){var s;const m=[...new Set(t.map(i=>i.funnel_name).filter(Boolean))].sort(),w=t.some(i=>!i.funnel_name),l=document.getElementById("kanban-controls");if(!l)return;if(l.innerHTML="",w&&(l.innerHTML+=`
                <div>
                    <h4 class="text-xs text-slate-400 uppercase font-bold mb-1 ml-1">Vista</h4>
                    <button id="kanban-individual-btn" class="kanban-control-item font-semibold py-2 px-4 rounded-lg text-sm border-2 border-slate-300 bg-white text-slate-700 hover:border-blue-400 transition-colors shadow-sm">Etiquetas Individuales</button>
                </div>
            `),m.length>0&&(l.innerHTML+=`
                <div>
                    <h4 class="text-xs text-slate-400 uppercase font-bold mb-1 ml-1">Funnels</h4>
                    <div class="kanban-control-item custom-select-wrapper rounded-lg border-2 border-slate-300 bg-white text-slate-700 shadow-sm transition-colors">
                        <select id="kanban-funnel-select" class="custom-select form-input text-sm font-semibold py-2 bg-transparent focus:outline-none">
                            <option value="" disabled>-- Seleccionar Funnel --</option>
                            ${m.map(i=>`<option value="${i}">${i}</option>`).join("")}
                        </select>
                        <i data-lucide="chevron-down" class="select-icon w-5 h-5 text-slate-500"></i>
                    </div>
                </div>
            `),l.innerHTML===""){document.getElementById("kanban-board").innerHTML='<div class="w-full text-center p-8"><p class="text-slate-500">Crea etiquetas o un funnel en "Etiquetas IA" para empezar a visualizar tus contactos.</p></div>';return}const e=document.getElementById("kanban-individual-btn");if(e)N(e),u="_individual_",be(u);else{const i=document.getElementById("kanban-funnel-select");i&&(N(i),u=i.value||"_individual_",be(i.value))}(s=document.getElementById("back-to-dashboard-btn"))==null||s.addEventListener("click",()=>{window.appInstance.switchPanel("dashboard")})}function be(m){var b,j,O,ee,ae,ue,ie;const w=document.getElementById("kanban-board");if(!w)return;const l=typeof m=="string"&&m.length?m:"_individual_";u=l;const e=(b=window.appInstance)==null?void 0:b.teamInfo,s=e==null?void 0:e.user_role,i=(j=e==null?void 0:e.profiles)==null?void 0:j.full_name;let h=n,x=null;s==="advisor"&&(x=f("contacts"),x?h=n.filter(me=>(me.labels||[]).some(fe=>x.includes(fe))):i&&(h=n.filter(me=>(me.labels||[]).includes(i))));const B=(O=window.appInstance)==null?void 0:O.userPlan,se=((ae=(ee=window.appInstance)==null?void 0:ee.teamInfo)==null?void 0:ae.user_role)==="admin"&&((ie=(ue=B==null?void 0:B.plans)==null?void 0:ue.features)==null?void 0:ie.multi_user);let C;if(l==="_individual_"?C=t.filter(me=>!me.funnel_name).sort((me,fe)=>me.name.localeCompare(fe.name)):C=t.filter(me=>me.funnel_name===l).sort((me,fe)=>(me.funnel_order||0)-(fe.funnel_order||0)),x&&(C=C.filter(me=>x.includes(me.name))),C.length===0){w.innerHTML='<p class="text-slate-500 p-4">No hay etiquetas para mostrar en esta vista.</p>';return}w.innerHTML=C.map(me=>{const fe=M(me.color),I=h.filter(D=>(D.labels||[]).includes(me.name)).sort((D,K)=>{const ge=(D.labels||[]).length;return(K.labels||[]).length-ge}),q=I.length>10,F=q?"max-h-[600px]":"";return`
                <div class="kanban-column w-full sm:w-1/2 md:w-1/3 lg:w-1/4 xl:w-1/5 flex-shrink-0 p-2">
                    <div class="bg-slate-100 rounded-lg shadow-sm flex flex-col h-full">
                    <h3 class="font-bold text-slate-800 p-3 border-b-4 flex-shrink-0" style="border-color: ${fe};">${me.name} <span class="text-sm font-normal text-slate-500">${I.length}</span></h3>
                    <div class="kanban-cards p-3 space-y-3 flex-grow overflow-y-auto ${F}" data-label-id="${me.id}" style="${q?"max-height: 600px;":""}">
                        ${I.map(D=>`
                            <div class="kanban-card bg-white p-3 rounded-md shadow-sm" data-contact-id="${D.id}">
                                <div class="flex justify-between items-start relative">
                                    <p class="font-semibold text-sm">${D.full_name||"Sin nombre"}</p>
                                    ${D.razon_de_label_auto?`                                        
                                        <i data-lucide="info" class="w-4 h-4 text-blue-400 cursor-pointer hover:text-blue-600 z-20 group"></i>
                                        <div class="kanban-tooltip w-64 bg-slate-800 text-white text-xs rounded-lg py-2 px-3 z-50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                            ${D.razon_de_label_auto}
                                            <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-slate-800"></div>
                                        </div>                                        
                                    `:'<i data-lucide="info" class="w-4 h-4 text-blue-400 cursor-pointer hover:text-blue-600 z-20"></i>'}
                                </div>
                                <p class="text-xs text-slate-500">${D.phone_number}</p>
                                ${se?`
                                    <div class="mt-2 pt-2 border-t border-slate-100">
                                        <div class="custom-select-wrapper">
                                            <select class="assign-advisor-select custom-select form-input text-xs py-1" data-contact-id="${D.id}">
                                                <option value="">Sin asignar</option>
                                                ${a.map(K=>{const ge=K.profiles;return`<option value="${K.user_id}" ${D.assigned_to_id===K.user_id?"selected":""}>
                                                        ${(ge==null?void 0:ge.full_name)||(ge==null?void 0:ge.email)||"Asesor sin nombre"}
                                                    </option>`}).join("")}
                                            </select>
                                            <i data-lucide="user-check" class="select-icon w-3 h-3 text-slate-400"></i>
                                        </div>
                                    </div>
                                `:""}
                            </div>
                        `).join("")||'<p class="text-xs text-slate-400 p-2">Sin contactos</p>'}
                    </div></div>
                </div>
            `}).join(""),window.Sortable&&he()}function he(){const m=document.getElementById("kanban-board");if(!m)return;const w=m.querySelectorAll(".kanban-cards");w.length>0&&w[0].sortable&&w.forEach(l=>l.sortable.destroy()),w.forEach(l=>{l.sortable=new Sortable(l,{group:"kanban",animation:150,onEnd:X,onMove:e=>{const s=e.dragged.dataset.contactId,i=e.to.dataset.labelId,h=n.find(B=>B.id==s),x=t.find(B=>B.id==i);return!h||!x?!1:!(h.labels||[]).includes(x.name)},ghostClass:"bg-blue-100",dragClass:"opacity-50"})})}async function X(m){const w=m.item.dataset.contactId,l=m.to.dataset.labelId,e=m.from.dataset.labelId;if(l===e)return;const s=t.find(h=>h.id==l),i=t.find(h=>h.id==e);if(!(!s||!i))try{const h=n.find(C=>C.id==w);if(!h)throw new Error("Contacto no encontrado en la caché.");const x=new Set(h.labels||[]);x.delete(i.name),x.add(s.name);const B=Array.from(x),{error:se}=await window.auth.sb.from("contacts").update({labels:B}).eq("id",w);if(se)throw se;window.showToast(`Contacto movido a "${s.name}"`,"success"),h.labels=B,be(u)}catch(h){console.error("Error al mover la tarjeta:",h),window.showToast("Error al actualizar el contacto.","error"),m.from.appendChild(m.item)}}async function ce(m,w){const l=w||null;try{const{error:e}=await window.auth.sb.from("contacts").update({assigned_to_id:l}).eq("id",m);if(e)throw e;window.showToast("Contacto asignado correctamente.","success")}catch(e){console.error("Error al asignar el contacto:",e),window.showToast("No se pudo asignar el contacto.","error")}}function W(m){const w=n.find(s=>s.id==m);if(!w)return;const l=document.getElementById("contact-info-modal"),e=document.getElementById("contact-info-modal-body");!l||!e||(e.innerHTML=`
            <div>
                <p class="text-lg font-bold">${w.full_name||"Sin nombre"}</p>
                <p class="text-sm text-slate-500">${w.phone_number}</p>
            </div>
            <div class="border-t pt-4">
                <h5 class="font-semibold mb-2">Etiquetas</h5>
                <div class="flex flex-wrap gap-2">
                    ${(w.labels||[]).filter(s=>s!=="ignorar").map(s=>{const i=t.find(B=>B.name===s),h=i?M(i.color):"#A0AEC0",x=_(h);return`<span class="text-xs font-semibold px-2.5 py-0.5 rounded-full" style="background-color: ${h}; color: ${x};">${s}</span>`}).join("")||'<span class="text-xs text-slate-400">Sin etiquetas</span>'}
                </div>
            </div>
            <div class="border-t pt-4">
                <h5 class="font-semibold mb-2">Información de IA</h5>
                <div class="flex flex-wrap gap-2">
                    ${w.razon_de_label_auto?`
                        <p class="text-sm bg-blue-50 p-3 rounded-md text-slate-700">${w.razon_de_label_auto}</p>
                    `:`
                        <p class="text-xs text-slate-400">No hay información de IA para este contacto.</p>
                    `}
                </div>
            </div>
        `,document.getElementById("contact-info-modal-labels-btn").onclick=()=>{Y(),window.contacts.openLabelsModalForSingleContact(m)},document.getElementById("contact-info-modal-chat-btn").onclick=()=>{Y(),window.appInstance.switchPanel("chats",{contactId:w.id})},l.classList.remove("hidden"),document.getElementById("close-contact-info-modal-btn").onclick=Y,lucide.createIcons())}function J(m){const w=m.target.closest(".kanban-card");if(!w)return;const l=w.querySelector(".kanban-tooltip");if(!l)return;const e=document.getElementById("kanban-board");if(!e)return;const s=w.getBoundingClientRect(),i=e.getBoundingClientRect(),h=l.offsetHeight;s.top-i.top>h+10?(l.style.bottom="100%",l.style.top="auto"):(l.style.top="100%",l.style.bottom="auto")}function Y(){document.getElementById("contact-info-modal").classList.add("hidden")}const A=["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#FF5722","#795548","#9E9E9E","#607D8B","#FFFFFF"];function M(m){if(typeof m=="string"&&m.startsWith("#"))return m;const w=parseInt(m,10);return!isNaN(w)&&w>=0&&w<A.length?A[w]:"#A0AEC0"}function _(m){if(!m||!m.startsWith("#"))return"#1e293b";const w=m.substring(1,7),l=parseInt(w.substring(0,2),16),e=parseInt(w.substring(2,4),16),s=parseInt(w.substring(4,6),16);return(.299*l+.587*e+.114*s)/255>.5?"#1e293b":"#ffffff"}function R(){var w,l;if(p)return;const m=(l=(w=window.auth.getSession())==null?void 0:w.user)==null?void 0:l.id;m&&(p=window.auth.sb.channel("public:contacts").on("postgres_changes",{event:"UPDATE",schema:"public",table:"contacts",filter:`user_id=eq.${m}`},e=>{const s=e.new,i=n.findIndex(h=>h.id===s.id);i!==-1?n[i]={...n[i],...s}:n.push(s),be(u),window.showToast("El tablero se ha actualizado automáticamente.","info")}).subscribe())}function y(){p&&(window.auth.sb.removeChannel(p),p=null)}})();(function(){let Be=!1,t=[],a="",n="",u="",p=[];document.addEventListener("panel:activated",({detail:b})=>{b.panelId==="products"&&!Be&&(f(),Be=!0)});function f(){console.log("Inicializando panel de Productos..."),Be=!0,L(),x(),z()}function L(){var b,j,O,ee,ae,ue,ie,me,fe,I,q,F;(b=document.getElementById("download-template-btn"))==null||b.addEventListener("click",W),(j=document.getElementById("export-products-btn"))==null||j.addEventListener("click",ce),(O=document.getElementById("import-csv-input"))==null||O.addEventListener("change",J),(ee=document.getElementById("add-product-btn"))==null||ee.addEventListener("click",w),(ae=document.getElementById("cancel-product-btn"))==null||ae.addEventListener("click",m),(ue=document.getElementById("product-form"))==null||ue.addEventListener("submit",s),(ie=document.getElementById("product-description-ai-enhance-btn"))==null||ie.addEventListener("click",e),(me=document.getElementById("products-table-body"))==null||me.addEventListener("click",D=>{D.target.closest(".edit-product-btn")&&l(D.target.closest(".edit-product-btn").dataset.id),D.target.closest(".delete-product-btn")&&T(D.target.closest(".delete-product-btn").dataset.id)}),document.querySelectorAll('[data-role="products-search"]').forEach(D=>{D.addEventListener("input",N)}),(fe=document.getElementById("product-label-filter"))==null||fe.addEventListener("change",i),(I=document.getElementById("product-status-filter"))==null||I.addEventListener("change",h),(q=document.getElementById("deactivate-all-visible-btn"))==null||q.addEventListener("click",()=>se(!1)),(F=document.getElementById("activate-all-visible-btn"))==null||F.addEventListener("click",()=>se(!0))}async function T(b){if(b&&confirm("¿Eliminar este producto de forma permanente?"))try{const{error:j}=await window.auth.sb.from("products").delete().eq("id",b);if(j)throw j;t=t.filter(O=>O.id!==b),H(),z()}catch(j){console.error("Error al eliminar el producto:",j);const O=(j==null?void 0:j.message)||"No se pudo eliminar el producto.";window.showToast?window.showToast(`Error: ${O}`,"error"):alert(O)}}async function z(){const b=document.getElementById("products-loader"),j=document.getElementById("products-table-body");if(!(!b||!j)){b.textContent="Cargando productos...",b.style.display="block",j.innerHTML="";try{const{data:O,error:ee}=await window.auth.sb.from("products").select("*").order("product_name");if(ee)throw ee;t=Array.isArray(O)?O:[],await x(),H()}catch(O){console.error("Error al cargar productos:",O),b.textContent="No se pudieron cargar los productos. Intenta nuevamente.",b.style.display="block",window.showToast&&window.showToast("No se pudieron cargar los productos. Intenta nuevamente.","error"),Y(t.length,t.length)}}}function H(){const b=document.getElementById("products-loader"),j=document.getElementById("products-table-body");if(!b||!j)return;const O=t.length,ee=be(t,a,n,u);if(O===0){j.innerHTML="",b.textContent="No tienes productos. Importa un archivo CSV para empezar.",b.style.display="block",Y(0,0);return}if(ee.length===0){j.innerHTML="",b.textContent=a?"No se encontraron productos que coincidan con la búsqueda.":"No tienes productos. Importa un archivo CSV para empezar.",b.style.display="block",Y(0,O);return}b.style.display="none",j.innerHTML=ee.map(ae=>{const ue=ae.is_active!==!1,ie=ue?'<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">Activo</span>':'<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">Inactivo</span>',me=ae.labels&&Array.isArray(ae.labels)&&ae.labels.length>0?ae.labels.map(fe=>`<span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-800 mr-1">${C(fe)}</span>`).join(""):'<span class="text-slate-400 text-xs">Sin etiquetas</span>';return`
            <tr class="${ue?"":"opacity-60"}">
                <td class="p-4 font-medium">${C(ae.product_name)}</td>
                <td class="p-4 text-slate-600">${C(ae.sku||"-")}</td>
                <td class="p-4 text-slate-600">${he(ae.price)}</td>
                <td class="p-4 text-slate-600">${X(ae.stock)}</td>
                <td class="p-4">${ie}</td>
                <td class="p-4">${me}</td>
                <td class="p-4">${ae.media_url?`<a href="${C(ae.media_url)}" target="_blank" class="text-blue-500 hover:underline">Ver Media</a>`:"-"}</td>
                <td class="p-4">
                    <div class="flex gap-2">
                        <button class="edit-product-btn p-2 hover:bg-slate-200 rounded-md" data-id="${ae.id}" title="Editar"><i data-lucide="edit" class="w-4 h-4 text-slate-600 pointer-events-none"></i></button>
                        <button class="delete-product-btn p-2 hover:bg-red-100 rounded-md" data-id="${ae.id}" title="Eliminar"><i data-lucide="trash-2" class="w-4 h-4 text-red-500 pointer-events-none"></i></button>
                    </div>
                </td>
            </tr>
        `}).join(""),Y(ee.length,O),typeof(lucide==null?void 0:lucide.createIcons)=="function"&&lucide.createIcons()}function N(b){a=b.target.value||"",G(b.target),t.length&&H()}function G(b){document.querySelectorAll('[data-role="products-search"]').forEach(j=>{j!==b&&(j.value=a)})}function be(b,j,O,ee){if(!Array.isArray(b))return[];let ae=b;const ue=(j||"").toString().trim().toLowerCase();if(ue&&(ae=ae.filter(ie=>{const me=(ie.product_name||"").toLowerCase().includes(ue),fe=(ie.sku||"").toLowerCase().includes(ue),I=(ie.description||"").toLowerCase().includes(ue);let q=!1;if(ie.price!==null&&ie.price!==void 0&&ie.price!==""){const F=Number(ie.price),D=String(ie.price).toLowerCase(),K=Number.isFinite(F)?F.toFixed(2):"",ge=Number.isFinite(F)?F.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2}).toLowerCase():"";q=D.includes(ue)||K.toLowerCase().includes(ue)||K.replace(".",",").includes(ue)||ge.includes(ue)}return me||fe||I||q})),O&&O.trim()!==""&&(ae=ae.filter(ie=>{const me=ie.labels||[];return Array.isArray(me)&&me.some(fe=>fe&&fe.toString().toLowerCase()===O.toLowerCase())})),ee&&ee!==""){const ie=ee==="true";ae=ae.filter(me=>me.is_active!==!1===ie)}return ae}function he(b){const j=Number(b);return Number.isFinite(j)?"$"+j.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2}):"$0.00"}function X(b){if(b===-1)return"Infinita";const j=Number(b);return Number.isFinite(j)?j.toLocaleString("es-MX"):"0"}function ce(){if(t.length===0){alert("No hay productos para exportar.");return}const b="product_name,description,price,media_url,stock,sku",j=t.map(ae=>{const ue=window.escapeCsvValue(ae.description||"");return[ae.product_name,ue,ae.price,ae.media_url,ae.stock,ae.sku].join(",")}),O=`data:text/csv;charset=utf-8,${b}
${j.join(`
`)}`,ee=document.createElement("a");ee.setAttribute("href",encodeURI(O)),ee.setAttribute("download","mis_productos.csv"),ee.click()}function W(){const b=["nombre_producto","descripcion","precio","media_url","stock","sku"],j=[["Suero hidratante","Suero facial con ácido hialurónico para uso diario.","349.90","https://ejemplo.com/imagenes/suero.jpg","120","SKU-SERUM-01"],["Crema corporal","Crema nutritiva de rápida absorción.","189.50","","-1","SKU-CREMA-02"]],ee=`data:text/csv;charset=utf-8,${[b.join(","),...j.map(ie=>ie.map(window.escapeCsvValue).join(","))].join(`
`)}`,ae=encodeURI(ee),ue=document.createElement("a");ue.setAttribute("href",ae),ue.setAttribute("download","plantilla_productos.csv"),document.body.appendChild(ue),ue.click(),document.body.removeChild(ue)}async function J(b){var ee,ae,ue,ie,me,fe,I,q;const j=b.target.files[0];if(!j)return;let O=null;try{const F=await window.convertFileToCsvText(j),D=window.splitCsvLines(F);if(!D.length){(ee=window.showToast)==null||ee.call(window,"El archivo de productos está vacío.","info");return}const K=window.parseCsvRow(D[0]).map(we=>we.trim());if(!K.length){(ae=window.showToast)==null||ae.call(window,"No se pudieron detectar las columnas del archivo.","error");return}if(O=await window.openColumnMappingModal(R,K),!O)return;const ge=D.slice(1),pe=[],_e=new Map;for(const we of ge){const xe=window.parseCsvRow(we).map(Ee=>(Ee==null?void 0:Ee.trim())??""),Se=window.getColumnValue(xe,O.sku);Se&&_e.set(Se,xe)}for(const[,we]of _e){const xe=window.getColumnValue(we,O.product_name),Se=window.getColumnValue(we,O.sku);if(!xe||!Se)continue;const Ee={product_name:xe,sku:Se},g=getColumnValue(we,O.description);g&&(Ee.description=g.replace(/^"|"$/g,"").replace(/""/g,'"'));const $=window.getColumnValue(we,O.price);if($){const te=_($),le=Number(te);Number.isFinite(le)&&(Ee.price=le)}const P=window.getColumnValue(we,O.media_url);P&&(Ee.media_url=P);const U=window.getColumnValue(we,O.stock);if(U){const te=U.replace(/[^\d-]/g,""),le=parseInt(te,10);Number.isNaN(le)||(Ee.stock=le===-1?-1:le)}pe.push(Ee)}if(pe.length===0){(ue=window.showToast)==null||ue.call(window,"El archivo CSV está vacío o no tiene el formato correcto.","info");return}try{const we=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),xe=we?we.id:(me=(ie=window.auth.getSession())==null?void 0:ie.user)==null?void 0:me.id;if(!xe)throw new Error("No se pudo determinar el usuario destino para la importación.");const Se=await M().catch(()=>null);let Ee=null;if(Se)try{const{data:P,error:U}=await window.auth.sb.from("apps").select("id").eq("id",Se).single();!U&&P?Ee=Se:console.warn("[products-import] app_id no encontrado en tabla apps:",Se)}catch(P){console.warn("[products-import] Error al verificar app_id:",P)}const g=pe.map(P=>{const U={...P,user_id:xe};return Ee&&(U.app_id=Ee),U}),{error:$}=await window.auth.sb.from("products").upsert(g,{onConflict:"user_id,sku"});if($)throw $;(fe=window.showToast)==null||fe.call(window,`${g.length} productos importados/actualizados con éxito.`,"success"),z()}catch(we){console.error("Error al importar CSV:",we),(I=window.showToast)==null||I.call(window,`Error al importar: ${we.message}`,"error")}}catch(F){console.error("Error general en la importación:",F),(q=window.showToast)==null||q.call(window,`Error general en la importación: ${F.message}`,"error")}finally{b.target.value=""}}function Y(b,j=b){const O=Number(b),ee=Number(j),ae=Number.isFinite(O)?Math.max(0,Math.trunc(O)):0,ue=Number.isFinite(ee)?Math.max(0,Math.trunc(ee)):0,ie=ae===1?"producto":"productos",me=ae.toLocaleString("es-MX"),fe=ue.toLocaleString("es-MX"),I=document.getElementById("products-count");I&&(I.textContent=ae===ue?`${me} ${ie}`:`${me} ${ie} (de ${fe})`);const q=document.getElementById("products-count-overview");q&&(q.textContent=fe)}function A(){var j,O,ee;const b=(j=window.appInstance)==null?void 0:j.teamInfo;return(b==null?void 0:b.active_app_id)||(b==null?void 0:b.app_id)||(b==null?void 0:b.default_app_id)||((ee=(O=b==null?void 0:b.apps)==null?void 0:O[0])==null?void 0:ee.id)||(b==null?void 0:b.team_id)||null}async function M(){var j;const b=A();if(b)return b;if((j=window.appInstance)!=null&&j.loadTeamInfo){try{await window.appInstance.loadTeamInfo()}catch(ee){console.warn("[products-import] No se pudo refrescar teamInfo:",ee)}const O=A();if(O)return O}return localStorage.getItem("active_app_id")||null}function _(b){if(!b)return b;const j=b.replace(/[^\d.,-]/g,"").trim();if(!j)return j;const O=j.includes(","),ee=j.includes(".");return O&&ee?j.lastIndexOf(".")>j.lastIndexOf(",")?j.replace(/,/g,""):j.replace(/\./g,"").replace(",","."):O?j.replace(",","."):j}const R=[{field:"product_name",label:"Nombre del producto",required:!0,aliases:["product_name","nombre","name","titulo","title"]},{field:"description",label:"Descripción",required:!1,aliases:["description","descripcion","detalle","detalle_producto"]},{field:"price",label:"Precio",required:!1,aliases:["price","precio","pricing","costo","valor"]},{field:"media_url",label:"URL de imagen o media",required:!1,aliases:["media_url","imagen","url_imagen","link","link_media"]},{field:"stock",label:"Disponibilidad (stock)",required:!1,aliases:["stock","inventario","cantidad","existencias"]},{field:"sku",label:"SKU",required:!0,aliases:["sku","codigo","referencia","id_producto"]}];function y(b){const j=document.getElementById("new-product-modal"),O=document.getElementById("product-form");if(!(!j||!O)){if(O.reset(),document.getElementById("product-id").value=(b==null?void 0:b.id)||"",document.getElementById("product-modal-title").textContent=b?"Editar Producto":"Añadir Nuevo Producto",b){document.getElementById("product-name").value=b.product_name||"",document.getElementById("product-description").value=b.description||"",document.getElementById("product-sku").value=b.sku||"",document.getElementById("product-price").value=b.price||0,document.getElementById("product-labels").value=(b.labels||[]).join(", "),document.getElementById("product-infinite-stock").checked=b.stock===-1;const ee=document.getElementById("product-stock");ee&&(ee.value=b.stock===-1?0:b.stock||0,ee.disabled=b.stock===-1);const ae=document.getElementById("product-image-preview");ae&&b.media_url?(ae.src=b.media_url,ae.classList.remove("hidden")):ae&&ae.classList.add("hidden")}else{const ee=document.getElementById("product-image-preview");ee&&ee.classList.add("hidden");const ae=document.getElementById("product-stock");ae&&(ae.disabled=!1)}j.classList.remove("hidden")}}function m(){document.getElementById("new-product-modal").classList.add("hidden")}function w(){y(null)}function l(b){const j=t.find(O=>O.id==b);j&&y(j)}function e(){var ae,ue,ie;const b=document.getElementById("product-description");if(!b)return;const j=b.value.trim(),O=((ae=document.getElementById("product-name"))==null?void 0:ae.value.trim())||"",ee=O?`Producto: ${O}

Descripción actual:
${j||"Sin descripción"}`:j||"Sin descripción";if(!((ue=window.appInstance)!=null&&ue.openAiEnhanceModal)){(ie=window.showToast)==null||ie.call(window,"La mejora con IA no está disponible en este momento.","info");return}window.appInstance.openAiEnhanceModal(ee,me=>{b.value=me})}async function s(b){var O,ee,ae;b.preventDefault();const j=document.getElementById("save-new-product-btn");j.disabled=!0,j.textContent="Guardando...";try{let ue=null;const ie=document.getElementById("product-media-file").files[0];if(ie){const we=["image/jpeg","image/png","image/webp","image/gif"];if(ie.size>5242880)throw new Error("El archivo es demasiado grande. El tamaño máximo permitido es de 5 MB.");if(!we.includes(ie.type))throw new Error("Formato de archivo no válido. Solo se permiten imágenes (JPG, PNG, WEBP, GIF).")}if(ie&&(ue=await window.appInstance.uploadAsset(ie,"products"),!ue))throw new Error("La subida del archivo al servidor final falló. Revisa la consola para más detalles.");const me=document.getElementById("product-infinite-stock").checked,fe=document.getElementById("product-id").value,I=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),q=(I==null?void 0:I.id)||((ee=(O=window.auth.getSession())==null?void 0:O.user)==null?void 0:ee.id),F=((ae=document.getElementById("product-labels"))==null?void 0:ae.value.trim())||"",D=F?F.split(",").map(_e=>_e.trim()).filter(_e=>_e.length>0):[],K={product_name:document.getElementById("product-name").value,description:document.getElementById("product-description").value,sku:document.getElementById("product-sku").value,price:parseFloat(document.getElementById("product-price").value),stock:me?-1:parseInt(document.getElementById("product-stock").value),labels:D};fe||(K.user_id=q),ue&&(K.media_url=ue);const ge=fe?window.auth.sb.from("products").update(K).eq("id",fe):window.auth.sb.from("products").insert(K),{error:pe}=await ge;if(pe)throw pe;alert(`¡Producto ${fe?"actualizado":"guardado"} con éxito!`),m(),z()}catch(ue){console.error("Error al guardar el producto:",ue),window.showToast?window.showToast(`Error: ${ue.message}`,"error"):alert(`No se pudo guardar el producto: ${ue.message}`)}finally{j.disabled=!1,j.textContent="Guardar Producto"}}function i(b){n=b.target.value||"",H()}function h(b){u=b.target.value||"",H()}async function x(){try{const b=new Set;t.forEach(j=>{j.labels&&Array.isArray(j.labels)&&j.labels.forEach(O=>{O&&O.trim()&&b.add(O.trim())})}),p=Array.from(b).sort(),B()}catch(b){console.error("Error al cargar etiquetas:",b)}}function B(){const b=document.getElementById("product-label-filter");if(!b)return;const j=b.value;b.innerHTML='<option value="">Todas las etiquetas</option>',p.forEach(O=>{const ee=document.createElement("option");ee.value=O,ee.textContent=O,b.appendChild(ee)}),j&&(b.value=j)}async function se(b){var fe,I,q,F,D,K,ge;const j=b?document.getElementById("activate-all-visible-btn"):document.getElementById("deactivate-all-visible-btn");if(!j)return;const O=(I=(fe=window.auth.getSession())==null?void 0:fe.user)==null?void 0:I.id;if(!O){(q=window.showToast)==null||q.call(window,"No se pudo determinar el usuario actual.","error");return}const ee=n&&n.trim()!==""?[n]:null,ae=a&&a.trim()!==""?a.trim():null;let ue=null;u&&u!==""?ue=u==="true":ue=!b;const ie=b?"activar":"desactivar";if(!confirm(`¿${ie.charAt(0).toUpperCase()+ie.slice(1)} todos los productos visibles según los filtros actuales?`))return;j.disabled=!0;const me=j.innerHTML;j.innerHTML=b?'<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i><span>Activando...</span>':'<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i><span>Desactivando...</span>',typeof(lucide==null?void 0:lucide.createIcons)=="function"&&lucide.createIcons();try{const{data:pe,error:_e}=await window.auth.sb.rpc("bulk_update_products_status",{p_user_id:O,p_is_active:b,p_label_filter:ee,p_search_term:ae,p_current_status_filter:ue});if(_e)throw _e;const we=((F=pe==null?void 0:pe[0])==null?void 0:F.updated_count)||0;await z(),await x(),we===0?(D=window.showToast)==null||D.call(window,`No se encontraron productos para ${ie} con los filtros actuales.`,"info"):(K=window.showToast)==null||K.call(window,`Se ${b?"activaron":"desactivaron"} ${we} producto(s) exitosamente.`,"success")}catch(pe){console.error("Error al actualizar estado de productos:",pe),(ge=window.showToast)==null||ge.call(window,`Error al ${ie} productos: ${pe.message||"Error desconocido"}`,"error")}finally{j.disabled=!1,j.innerHTML=me,typeof(lucide==null?void 0:lucide.createIcons)=="function"&&lucide.createIcons()}}function C(b){if(!b)return"";const j=document.createElement("div");return j.textContent=b,j.innerHTML}})();(function(){let Be=!1,t=null,a=[];document.addEventListener("panel:activated",({detail:y})=>{y.panelId==="settings"&&(Be||n())}),document.addEventListener("panel:loaded",({detail:y})=>{y.panelId==="settings"&&!Be&&n()});function n(){console.log("Inicializando panel de Configuración..."),Be=!0,t=window.auth.sb,p(),f()}async function u(){var l,e,s,i,h;const y=JSON.parse(localStorage.getItem("impersonated_user_info")||"null");if(y!=null&&y.id)return y.id;const m=(e=(l=window.appInstance)==null?void 0:l.user)==null?void 0:e.id;if(m)return m;const w=(i=(s=window.auth.getSession())==null?void 0:s.user)==null?void 0:i.id;if(w)return w;try{const{data:x,error:B}=await window.auth.sb.auth.getSession();if(B)return console.error("[Settings] Error al obtener la sesión activa desde Supabase:",B),null;if(x!=null&&x.session)return window.auth.session=x.session,((h=x.session.user)==null?void 0:h.id)||null}catch(x){console.error("[Settings] Error inesperado al resolver el usuario activo:",x)}return null}function p(){var w,l,e,s,i,h,x;(w=document.getElementById("settings-form"))==null||w.addEventListener("submit",L),(l=document.getElementById("settings-save-safe-btn"))==null||l.addEventListener("click",T),(e=document.getElementById("upload-logo-btn"))==null||e.addEventListener("click",()=>document.getElementById("logo-input").click()),(s=document.getElementById("logo-input"))==null||s.addEventListener("change",B=>Y(B.target.files[0]));const y=document.getElementById("reference-image-input");y==null||y.addEventListener("change",B=>A(B.target.files)),(i=document.getElementById("add-ref-image-slot"))==null||i.addEventListener("click",()=>y.click());const m=document.getElementById("reference-images-container");m==null||m.addEventListener("click",B=>{B.target.closest(".delete-ref-image-btn")?_(B.target.closest(".delete-ref-image-btn")):B.target.closest("#add-ref-image-slot")||B.target.closest(".ref-image-item")||m.querySelectorAll(".ref-image-item").length<3&&y.click()}),(h=document.getElementById("invite-member-form"))==null||h.addEventListener("submit",B=>{B.preventDefault(),X()}),(x=document.getElementById("team-members-list"))==null||x.addEventListener("change",B=>{B.target.classList.contains("permission-toggle")?ce(B.target):B.target.classList.contains("label-filter-select")&&W(B.target)})}async function f(){var y,m,w,l;try{const e=await u();if(!e)throw new Error("No se pudo determinar el usuario para cargar la configuracion.");const{data:s,error:i}=await t.from("profiles").select("work_start_hour, work_end_hour, company_description, website, social_media, branding_settings, contact_phone").eq("id",e).single();if(i&&i.code!=="PGRST116")throw i;if(!s)return;s.work_start_hour&&(document.getElementById("work-start-hour").value=`${String(s.work_start_hour).padStart(2,"0")}:00`),s.work_end_hour&&(document.getElementById("work-end-hour").value=`${String(s.work_end_hour).padStart(2,"0")}:00`),s.company_description&&(document.getElementById("company-description").value=s.company_description),s.website&&(document.getElementById("website").value=s.website),s.social_media&&(document.getElementById("social-instagram").value=s.social_media.instagram||"",document.getElementById("social-facebook").value=s.social_media.facebook||"");const h=document.getElementById("admin-phone-input");h&&s.contact_phone&&(h.value=s.contact_phone),(y=s.branding_settings)!=null&&y.logo_url&&(document.getElementById("logo-preview").src=s.branding_settings.logo_url),(m=s.branding_settings)!=null&&m.colors&&s.branding_settings.colors.forEach((B,se)=>document.getElementById(`brand-color-${se+1}`).value=B),(w=s.branding_settings)!=null&&w.reference_images&&M(s.branding_settings.reference_images);const x=(l=window.appInstance)==null?void 0:l.teamInfo;await N(x)}catch(e){console.error("Error al cargar la configuración de la empresa:",e)}}async function L(y){y.preventDefault();const m=y.target,w=m.querySelector("button[data-settings-primary]")||m.querySelector('button[type="submit"]');await z(w)}async function T(y){y.preventDefault();const m=y.currentTarget;console.log('[Settings] Boton "Guardar Seguro" presionado.'),await z(m,{toastMessage:"Guardando configuracion (modo seguro)..."})}async function z(y,m={}){var h,x,B,se;const w=document.getElementById("settings-form");if(!w){console.warn("[Settings] No se encontro el formulario de configuracion.");return}const l=y||w.querySelector('button[type="submit"]');if(!l){console.warn("[Settings] No se encontro el boton de guardado.");return}const{loadingLabel:e="Guardando...",restoreLabel:s=l.dataset.originalLabel||l.textContent||"Guardar Configuracion",toastMessage:i="Guardando configuracion..."}=m;window.showToast(i,"info",2e3),l.dataset.originalLabel=s,l.disabled=!0,l.textContent=e;try{console.log("[Settings] Iniciando guardado...");const C=document.getElementById("logo-input"),b=document.getElementById("logo-preview"),j=(h=C==null?void 0:C.files)==null?void 0:h[0];let O=(x=b==null?void 0:b.src)!=null&&x.startsWith("https")?b.src:null;if(j){if(!window.appInstance)throw new Error("La instancia de la aplicacion no esta lista.");O=await window.appInstance.uploadAsset(j,"logos")}console.log("[Settings] URL del logo:",O);const ee=document.querySelector("#reference-images-container"),ae=ee?Array.from(ee.querySelectorAll(".ref-image-item img")).map(le=>le.src.split("?")[0]):[],ue=document.getElementById("reference-image-input"),ie=(ue==null?void 0:ue.files)||[],me=Array.from(ie).map(le=>window.appInstance.uploadAsset(le,"reference_images")),fe=await Promise.all(me),I=[...ae,...fe.filter(Boolean)];console.log("[Settings] URLs de referencia:",I);const q=document.getElementById("brand-font"),F={logo_url:O,colors:Array.from({length:4},(le,Ce)=>{const Me=document.getElementById(`brand-color-${Ce+1}`);return(Me==null?void 0:Me.value)||"#000000"}),font:(q==null?void 0:q.value)||"Arial",reference_images:I.slice(0,3)};console.log("[Settings] Datos de branding:",F);const D=document.getElementById("work-start-hour"),K=document.getElementById("work-end-hour"),ge=document.getElementById("company-description"),pe=document.getElementById("website"),_e=document.getElementById("social-instagram"),we=document.getElementById("social-facebook"),xe=document.getElementById("admin-phone-input"),Se=(D==null?void 0:D.value)||"",Ee=(K==null?void 0:K.value)||"",g=((B=xe==null?void 0:xe.value)==null?void 0:B.trim())||null,$={work_start_hour:Se?parseInt(Se.split(":")[0],10):null,work_end_hour:Ee?parseInt(Ee.split(":")[0],10):null,company_description:(ge==null?void 0:ge.value)||"",website:(pe==null?void 0:pe.value)||"",social_media:{instagram:(_e==null?void 0:_e.value)||"",facebook:(we==null?void 0:we.value)||""},branding_settings:F,contact_phone:g};console.log("[Settings] Datos a guardar:",$);const P=await u();if(!P)throw console.error("[Settings] Error: no se pudo determinar el usuario objetivo."),new Error("No se pudo determinar el usuario objetivo para guardar la configuracion.");const{error:U}=await t.from("profiles").update($).eq("id",P);if(U)throw console.error("[Settings] Error de Supabase al guardar:",U),new Error(U.message);const te=(se=window.appInstance)==null?void 0:se.teamInfo;if(te&&te.user_role==="admin"&&te.team_id){const le=document.getElementById("see-all-chats-toggle"),Ce=document.getElementById("ignore-labels-input"),Me=(le==null?void 0:le.checked)??!1,Ve=((Ce==null?void 0:Ce.value)||"").split(",").map(je=>je.trim()).filter(je=>je);try{const{error:je}=await t.from("teams").update({allow_all_chats_visibility:Me,ignored_labels:Ve}).eq("id",te.team_id);je&&(je.code==="PGRST204"?console.log("[Settings] La funcionalidad de equipos requiere plan business. Saltando guardado de configuración de equipo."):console.error("[Settings] Error al guardar la configuración del equipo:",je))}catch(je){console.log("[Settings] No se pudo guardar configuración de equipo (puede requerir plan business):",je.message)}}console.log("[Settings] Guardado con exito."),window.showToast("Configuracion guardada con exito.","success")}catch(C){console.error("Error al guardar la configuracion:",C),window.showToast("No se pudo guardar la configuracion.","error")}finally{l.disabled=!1,l.textContent=s}}async function H(y){var e,s,i,h,x;const m=(y==null?void 0:y.owner_id)||((e=y==null?void 0:y.profiles)==null?void 0:e.id)||((i=(s=window.appInstance)==null?void 0:s.user)==null?void 0:i.id)||((x=(h=window.auth.getSession())==null?void 0:h.user)==null?void 0:x.id);if(!m){a=[];return}const{data:w,error:l}=await window.auth.sb.from("labels").select("name").eq("user_id",m).order("name",{ascending:!0});if(l){console.error("[Settings] Error al cargar etiquetas del equipo:",l),a=[];return}a=(w||[]).map(B=>B.name).filter(Boolean)}async function N(y){var i,h,x;const m=document.getElementById("team-management-panel");if(!m)return;let w=!1;if((y==null?void 0:y.user_role)==="admin"){const B=await((i=window.appInstance)==null?void 0:i.loadUserSubscription());(x=(h=B==null?void 0:B.plans)==null?void 0:h.features)!=null&&x.multi_user&&(w=!0)}if(!w){m.classList.add("hidden");return}m.classList.remove("hidden"),await H(y);const l=document.getElementById("team-members-list");if(!l)return;const{data:e,error:s}=await window.auth.sb.from("team_members").select("user_id, role, permissions, profiles:user_id(full_name, email)").eq("team_id",y.team_id);if(s){console.error("Error al cargar miembros del equipo:",s),l.innerHTML='<p class="text-red-500">Error al cargar miembros.</p>';return}e.length>0?l.innerHTML=e.map(B=>{var se,C;return`
                <div class="bg-white p-4 rounded-lg border">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${((se=B.profiles)==null?void 0:se.full_name)||((C=B.profiles)==null?void 0:C.email)}</p>
                            <span class="text-xs font-medium px-2 py-0.5 rounded-full ${B.role==="admin"?"bg-purple-100 text-purple-700":"bg-blue-100 text-blue-700"}">${B.role}</span>
                        </div>
                        ${B.role==="advisor"?`
                            <button class="text-xs text-slate-500 hover:underline" onclick="this.nextElementSibling.classList.toggle('hidden')">Permisos</button>
                        `:""}
                    </div>
                    ${B.role==="advisor"?`
                        <div class="hidden mt-4 pt-4 border-t border-slate-100 space-y-4">
                            <div>
                                <h5 class="text-sm font-semibold text-slate-600">Acceso a Paneles:</h5>
                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2">
                                    ${G(B,"follow-ups","Seguimientos")}
                                    ${G(B,"bulk-sending","Envío Masivo")}
                                    ${G(B,"contacts","Contactos")}
                                    ${G(B,"templates","Plantillas")}
                                    ${G(B,"products","Productos")}
                                    ${G(B,"designer-ai","Diseñador IA")}
                                </div>
                            </div>
                            ${be(B)}
                        </div>
                    `:""}
                </div>
            `}).join(""):l.innerHTML='<p class="text-slate-500 text-center p-4 text-sm">Aún no has invitado a nadie a tu equipo.</p>'}function G(y,m,w){var e;const l=((e=y.permissions)==null?void 0:e[m])||!1;return`
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" class="permission-toggle form-checkbox h-4 w-4 rounded text-blue-600" data-member-id="${y.user_id}" data-panel-id="${m}" ${l?"checked":""}>
                <span class="text-sm text-slate-700">${w}</span>
            </label>
        `}function be(y){var e;const m=((e=y.permissions)==null?void 0:e.label_filters)||{},w=Array.isArray(m.contacts)?m.contacts:[],l=Array.isArray(m.chats)?m.chats:[];return`
            <div class="space-y-2">
                <h5 class="text-sm font-semibold text-slate-600">Etiquetas permitidas</h5>
                <p class="text-xs text-slate-500">Solo verá contactos y chats que tengan las etiquetas seleccionadas.</p>
                <div class="grid gap-3 md:grid-cols-2">
                    ${he(y,"contacts","Contactos y Kanban",w)}
                    ${he(y,"chats","Chats",l)}
                </div>
            </div>
        `}function he(y,m,w,l){const e=new Set([...a||[],...l||[]]);if(!e.size)return`
                <div class="text-sm text-slate-500 border border-dashed border-slate-200 rounded-lg p-3">
                    Crea etiquetas desde el panel de Contactos para asignarlas a tus vendedores.
                </div>
            `;const s=Array.from(e).filter(Boolean).sort((i,h)=>i.localeCompare(h,"es",{sensitivity:"base"})).map(i=>`<option value="${i}" ${l!=null&&l.includes(i)?"selected":""}>${i}</option>`).join("");return`
            <label class="flex flex-col gap-1 text-sm text-slate-600">
                <span>${w}</span>
                <select multiple size="4" class="label-filter-select border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" data-member-id="${y.user_id}" data-scope="${m}">
                    ${s}
                </select>
            </label>
        `}async function X(){const y=document.getElementById("invite-member-form"),m=document.getElementById("invite-email"),w=y.querySelector("button"),l=m.value.trim();if(!(!l||!(teamInfo!=null&&teamInfo.team_id))){w.disabled=!0,w.textContent="Enviando...";try{const{error:e}=await window.auth.invokeFunction("invite-team-member",{body:{teamId:teamInfo.team_id,inviteeEmail:l,role:"advisor"}});if(e)throw new Error(e.message);window.showToast(`Invitación enviada a ${l}.`,"success"),m.value=""}catch(e){console.error("Error al invitar miembro:",e),window.showToast(e.message,"error")}finally{w.disabled=!1,w.textContent="Invitar"}}}async function ce(y){const m=y.dataset.memberId,w=y.dataset.panelId,l=y.checked;if(!(!m||!w))try{const{data:e,error:s}=await t.from("team_members").select("permissions").eq("user_id",m).eq("team_id",teamInfo.team_id).single();if(s)throw s;const i=J(e.permissions);i[w]=l;const{error:h}=await t.from("team_members").update({permissions:i}).eq("user_id",m).eq("team_id",teamInfo.team_id);if(h)throw h}catch(e){console.error("Error al actualizar permisos:",e),window.showToast("No se pudo actualizar el permiso.","error"),y.checked=!l}}async function W(y){const m=y.dataset.memberId,w=y.dataset.scope;if(!m||!w)return;const l=Array.from(y.selectedOptions).map(e=>e.value).filter(Boolean);try{const{data:e,error:s}=await t.from("team_members").select("permissions").eq("user_id",m).eq("team_id",teamInfo.team_id).single();if(s)throw s;const i=J(e.permissions);i.label_filters[w]=l;const{error:h}=await t.from("team_members").update({permissions:i}).eq("user_id",m).eq("team_id",teamInfo.team_id);if(h)throw h}catch(e){console.error("[Settings] Error al actualizar etiquetas permitidas:",e),window.showToast("No se pudo actualizar el acceso por etiquetas.","error"),await N(teamInfo)}}function J(y){const m=y&&typeof y=="object"?{...y}:{},w=m.label_filters&&typeof m.label_filters=="object"?{...m.label_filters}:{};return Array.isArray(w.contacts)||(w.contacts=[]),Array.isArray(w.chats)||(w.chats=[]),m.label_filters=w,m}function Y(y){if(!y)return;const m=document.getElementById("logo-preview"),w=new FileReader;w.onload=l=>{m.src=l.target.result},w.readAsDataURL(y)}async function A(y){const m=document.getElementById("reference-images-container");if(m){for(const w of y){if(m.querySelectorAll(".ref-image-item").length>=3){alert("Puedes subir un máximo de 3 imágenes de referencia.");break}if(!window.appInstance)throw new Error("La instancia de la aplicación no está lista.");const l=await window.appInstance.uploadAsset(w,"reference_images");l&&(document.getElementById("add-ref-image-slot").insertAdjacentHTML("beforebegin",R(l)),lucide.createIcons())}document.getElementById("reference-image-input").value="",m.querySelectorAll(".ref-image-item").length>=3&&(document.getElementById("add-ref-image-slot").style.display="none")}}function M(y){const m=document.getElementById("reference-images-container"),w=document.getElementById("add-ref-image-slot");m&&(m.querySelectorAll(".ref-image-item").forEach(l=>l.remove()),(y||[]).forEach(l=>{w.insertAdjacentHTML("beforebegin",R(l))}),w.style.display=(y||[]).length>=3?"none":"flex",lucide.createIcons(),lucide.createIcons())}function _(y){const m=y.closest(".ref-image-item");if(m){m.remove();const w=document.getElementById("add-ref-image-slot");w&&(w.style.display="flex")}}function R(y){return`<div class="ref-image-item relative group aspect-square bg-slate-100 rounded-lg"><img src="${y}" class="w-full h-full object-cover rounded-lg"><button type="button" class="delete-ref-image-btn absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="x" class="w-3 h-3 pointer-events-none"></i></button></div>`}})();(function(){const Be=["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#FF5722","#795548","#9E9E9E","#607D8B","#FFFFFF"];function t(l){if(typeof l=="string"&&l.startsWith("#"))return l;const e=parseInt(l,10);return!isNaN(e)&&e>=0&&e<Be.length?Be[e]:"#A0AEC0"}let a=!1,n=[],u=!1,p=!1,f=null;document.addEventListener("panel:activated",({detail:l})=>{l.panelId==="smart-labels"&&!a&&L()});function L(){console.log("Inicializando panel de Etiquetas Inteligentes..."),T(),z(),X(),a=!0}function T(){u||(document.addEventListener("click",N),u=!0)}function z(){H()||f||(f=new MutationObserver(()=>{H()&&(f.disconnect(),f=null)}),f.observe(document.body,{childList:!0,subtree:!0}))}function H(){var x,B,se,C;if(p)return!0;const l=document.getElementById("smart-label-modal");if(!l)return!1;(x=l.querySelector("#cancel-smart-label-btn"))==null||x.addEventListener("click",M),(B=l.querySelector("#cancel-smart-label-btn-footer"))==null||B.addEventListener("click",M),(se=l.querySelector("#smart-label-form"))==null||se.addEventListener("submit",m),(C=l.querySelector("#delete-smart-label-btn"))==null||C.addEventListener("click",w);const e=document.getElementById("smart-label-is-automated");e==null||e.addEventListener("change",G);const s=document.getElementById("smart-label-ai-enhance-btn");s==null||s.addEventListener("click",be);const i=document.getElementById("smart-label-select");i==null||i.addEventListener("change",he);const h=document.getElementById("smart-label-enable-funnel");return h==null||h.addEventListener("change",b=>_(b.target.checked)),p=!0,!0}function N(l){if(l.target.closest("#add-smart-label-btn")){l.preventDefault(),A(null);return}const s=l.target.closest(".edit-smart-label-btn");if(s){l.preventDefault();const i=s.dataset.id,h=n.find(x=>{var B;return((B=x.id)==null?void 0:B.toString())===i});h&&A(h)}}function G(l){var e;(e=document.getElementById("ai-fields-container"))==null||e.classList.toggle("hidden",!l.target.checked)}function be(l){l.preventDefault();const e=document.getElementById("smart-label-prompt");e!=null&&e.value&&window.appInstance.openAiEnhanceModal(e.value,s=>e.value=s)}function he(l){var h;const e=l==null?void 0:l.target;if(!e)return;const s=e.value==="_new_";(h=document.getElementById("new-label-fields-container"))==null||h.classList.toggle("hidden",!s);const i=document.getElementById("smart-label-name");i&&(i.required=s)}async function X(){const l=document.getElementById("smart-labels-loader"),e=document.getElementById("smart-labels-content");l.classList.remove("hidden"),e.classList.add("hidden");try{const{data:s,error:i}=await window.auth.sb.from("labels").select("*");if(i)throw i;const h=new Map;for(const x of s||[]){if(!x.name)continue;const B=h.get(x.name);(!B||!B.prompt&&x.prompt||!B.funnel_name&&x.funnel_name)&&h.set(x.name,x)}n=Array.from(h.values()),ce(),W(),J(),l.classList.add("hidden"),e.classList.remove("hidden")}catch(s){console.error("Error al cargar etiquetas:",s),l.textContent="Error al cargar las etiquetas."}}function ce(){const l=document.getElementById("funnels-container"),e=n.reduce((s,i)=>(i.funnel_name&&(s[i.funnel_name]||(s[i.funnel_name]=[]),s[i.funnel_name].push(i)),s),{});if(Object.keys(e).length===0){l.innerHTML='<p class="text-slate-500">No se han configurado funnels de etiquetas.</p>';return}l.innerHTML=Object.entries(e).map(([s,i])=>(i.sort((h,x)=>(h.funnel_order||0)-(x.funnel_order||0)),`
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h4 class="text-lg font-bold text-slate-900 mb-4">${s}</h4>
                    <div class="flex items-center space-x-2 overflow-x-auto pb-4">
                        ${i.map((h,x)=>`
                            ${x>0?'<i data-lucide="chevron-right" class="text-slate-400 flex-shrink-0"></i>':""}
                            <div class="flex-shrink-0 w-64">
                                ${Y(h)}
                            </div>
                        `).join("")}
                    </div>
                </div>
            `)).join(""),lucide.createIcons()}function W(){const l=document.getElementById("individual-labels-container"),e=n.filter(s=>!s.funnel_name);if(e.length===0){l.innerHTML='<p class="text-slate-500 text-sm">No hay etiquetas individuales.</p>';return}l.innerHTML=e.map(s=>Y(s)).join(""),lucide.createIcons()}function J(){const l=document.getElementById("funnel-names-list");if(!l)return;const e=new Set(n.map(s=>s.funnel_name).filter(Boolean));l.innerHTML=Array.from(e).map(s=>`<option value="${s}"></option>`).join("")}function Y(l){var se,C;const e=l.is_automated?"bg-green-100 text-green-800":"bg-slate-100 text-slate-500",s=l.is_automated?"Automática":"Manual",x=(((C=(se=window.appInstance)==null?void 0:se.teamInfo)==null?void 0:C.ignored_labels)||[]).includes(l.name)?'<span class="text-[10px] font-semibold uppercase tracking-wide px-2 py-0.5 rounded-full bg-red-100 text-red-700">Ignorar IA</span>':"";return`
            <div class="border border-slate-200 rounded-lg p-4 space-y-3">
                <div class="flex justify-between items-start gap-3">
                    <h5 class="font-bold" style="color: ${t(l.color)}">${l.name}</h5>
                    <div class="flex flex-col items-end gap-1">
                        <span class="text-xs font-medium px-2 py-0.5 rounded-full ${e}">${s}</span>
                        ${x}
                    </div>
                </div>
                <p class="text-sm text-slate-600 h-16 overflow-y-auto">
                    <strong>Instrucción:</strong> ${l.prompt||"<em>No definida</em>"}
                </p>
                <button class="edit-smart-label-btn text-xs text-blue-600 hover:underline font-semibold flex items-center gap-1" data-id="${l.id}">
                    <i data-lucide="edit-2" class="w-3 h-3 pointer-events-none"></i> Editar
                </button>
            </div>
        `}async function A(l,e=0){var j,O,ee,ae;const s=document.getElementById("smart-label-modal"),i=document.getElementById("smart-label-form");if(!s||!i){e<10?setTimeout(()=>A(l,e+1),50):console.warn("El modal de automatizaciones IA no está disponible después de varios intentos.");return}p||H(),i.reset(),document.getElementById("ai-fields-container").classList.add("hidden"),document.getElementById("new-label-fields-container").classList.add("hidden"),document.getElementById("smart-label-name").required=!1;const h=document.getElementById("label-selector-container"),x=document.getElementById("smart-label-select"),B=document.getElementById("smart-label-enable-funnel"),se=document.getElementById("smart-label-is-automated"),C=document.getElementById("smart-label-notify");if(!x||!h){console.warn("No se encontró el selector de etiquetas para automatizaciones."),e<10&&setTimeout(()=>A(l,e+1),50);return}if(l){h.classList.remove("hidden"),document.getElementById("new-label-fields-container").classList.add("hidden"),document.getElementById("smart-label-name").required=!1,document.getElementById("smart-label-modal-title").textContent="Editar automatización",document.getElementById("smart-label-id").value=l.id;const{data:ue,error:ie}=await window.auth.sb.from("labels").select("id, name").or(`prompt.is.null,id.eq.${l.id}`);if(ie)console.error("Error cargando etiquetas disponibles:",ie),x.innerHTML="<option>Error al cargar</option>";else{const me=(ue||[]).reduce((fe,I)=>(fe.some(q=>q.name===I.name)||fe.push(I),fe),[]);x.innerHTML=me.map(fe=>`<option value="${fe.id}">${fe.name}</option>`).join(""),x.value=l.id}document.getElementById("smart-label-prompt").value=l.prompt||"",se&&(se.checked=!!l.is_automated,G({target:se})),C&&(C.checked=!!l.notify_on_assign),B&&(B.checked=!!l.funnel_name,document.getElementById("smart-label-funnel-name").value=l.funnel_name||"",document.getElementById("smart-label-funnel-order").value=l.funnel_order??"",_(B.checked))}else{h.classList.remove("hidden"),document.getElementById("smart-label-modal-title").textContent="Nueva automatización de etiqueta",document.getElementById("smart-label-id").value="";const{data:ue,error:ie}=await window.auth.sb.from("labels").select("id, name").is("prompt",null);if(ie)console.error("Error cargando etiquetas no automatizadas:",ie),x.innerHTML="<option>Error al cargar</option>";else{const me=(ue||[]).reduce((fe,I)=>(fe.some(q=>q.name===I.name)||fe.push(I),fe),[]);x.innerHTML='<option value="" disabled selected>Selecciona una etiqueta...</option>'+me.map(fe=>`<option value="${fe.id}">${fe.name}</option>`).join("")+'<option value="_new_" class="font-bold text-blue-600">Crear nueva etiqueta...</option>'}B&&(B.checked=!1,document.getElementById("smart-label-funnel-name").value="",document.getElementById("smart-label-funnel-order").value="",_(!1)),se&&(se.checked=!1,G({target:se})),C&&(C.checked=!1)}he({target:x});const b=document.getElementById("smart-label-ignore-in-chats");if(b){const ue=(j=window.appInstance)==null?void 0:j.teamInfo,ie=(ue==null?void 0:ue.ignored_labels)||[],me=(l==null?void 0:l.name)||((ae=(ee=(O=x.selectedOptions)==null?void 0:O[0])==null?void 0:ee.textContent)==null?void 0:ae.trim())||"";b.checked=!!me&&ie.includes(me)}s.classList.remove("hidden"),lucide.createIcons()}function M(){document.getElementById("smart-label-modal").classList.add("hidden")}function _(l){const e=document.getElementById("funnel-fields-container"),s=document.getElementById("smart-label-funnel-name"),i=document.getElementById("smart-label-funnel-order");!e||!s||!i||(e.classList.toggle("hidden",!l),s.disabled=!l,s.required=l,i.disabled=!l)}async function R(l){if(l)try{const{data:e,error:s}=await window.auth.sb.from("labels").select("id, name").eq("user_id",l).limit(100);if(s)throw s;(Array.isArray(e)?e.find(h=>h.name&&h.name.toLowerCase().trim()==="ignorar"):null)||await window.auth.sb.from("labels").insert({user_id:l,name:"Ignorar",color:"#64748B",is_automated:!1,notify_on_assign:!1})}catch(e){throw console.error('No se pudo asegurar la etiqueta "ignorar":',e),e}}async function y(l,e){var B;const s=(B=window.appInstance)==null?void 0:B.teamInfo;if(!s||!l)return;let i=Array.isArray(s.ignored_labels)?[...s.ignored_labels]:[];const h=i.includes(l);if(e&&!h)i.push(l);else if(!e&&h)i=i.filter(se=>se!==l);else return;const{error:x}=await window.auth.sb.from("teams").update({ignored_labels:i}).eq("id",s.team_id);if(x)throw x;window.appInstance.teamInfo={...s,ignored_labels}}async function m(l){var O,ee,ae,ue,ie,me;l.preventDefault();const e=document.querySelector('#smart-label-modal button[type="submit"]');e&&(e.disabled=!0,e.textContent="Guardando...");let s=document.getElementById("smart-label-id").value;const i=document.getElementById("smart-label-select"),h=document.getElementById("smart-label-enable-funnel"),x=!!(h!=null&&h.checked),B=document.getElementById("smart-label-funnel-order").value,se=document.getElementById("smart-label-funnel-name").value.trim(),C=!!((O=document.getElementById("smart-label-ignore-in-chats"))!=null&&O.checked),b=(ae=(ee=window.auth.getSession())==null?void 0:ee.user)==null?void 0:ae.id,j=document.getElementById("smart-label-name").value.trim()||((me=(ie=(ue=i==null?void 0:i.selectedOptions)==null?void 0:ue[0])==null?void 0:ie.textContent)==null?void 0:me.trim())||"";try{const fe=B?parseInt(B,10):null,I={is_automated:document.getElementById("smart-label-is-automated").checked,prompt:document.getElementById("smart-label-prompt").value,funnel_name:x&&se?se:null,funnel_order:x&&Number.isFinite(fe)?fe:null,notify_on_assign:document.getElementById("smart-label-notify").checked};if(C&&b&&await R(b),s){const q=document.getElementById("smart-label-select").value;if(s!==q){await window.auth.sb.from("labels").update({prompt:null,is_automated:!1,funnel_name:null,funnel_order:null,notify_on_assign:!1}).eq("id",s);const{error:F}=await window.auth.sb.from("labels").update(I).eq("id",q);if(F)throw F;s=q}else{const{error:F}=await window.auth.sb.from("labels").update(I).eq("id",s);if(F)throw F}}else{const q=document.getElementById("smart-label-select").value;if(q==="_new_"){const F=document.getElementById("smart-label-name").value.trim(),D=F.charAt(0).toUpperCase()+F.slice(1).toLowerCase(),K=document.getElementById("smart-label-color").value,{data:ge}=await window.auth.sb.from("labels").select("id, name").eq("user_id",b),pe=ge==null?void 0:ge.find(we=>we.name.toLowerCase().trim()===D.toLowerCase().trim());if(pe)throw new Error(`La etiqueta "${pe.name}" ya existe.`);const{error:_e}=await window.auth.sb.from("labels").insert({...I,user_id:b,name:D,color:K});if(_e)throw _e}else{const{error:F}=await window.auth.sb.from("labels").update(I).eq("id",q);if(F)throw F}}await y(j,C),window.showToast("Automatización guardada con éxito.","success"),M(),X()}catch(fe){console.error("Error al guardar la automatización:",fe),window.showToast(`Error: ${fe.message}`,"error")}finally{e&&(e.disabled=!1,e.textContent="Guardar automatización")}}async function w(){const l=document.getElementById("smart-label-id").value;if(!(!l||!confirm("¿Estás seguro de que quieres eliminar esta etiqueta permanentemente? Esta acción no se puede deshacer.")))try{const{error:e}=await window.auth.sb.from("labels").delete().eq("id",l);if(e)throw e;window.showToast("Etiqueta eliminada.","info"),M(),X()}catch(e){console.error("Error al eliminar la etiqueta:",e),window.showToast(`Error al eliminar: ${e.message}`,"error")}}})();(function(){const Be=[{name:"Saludo y Presentación",content:`¡Hola %nombre%! 👋
Soy de [Nombre de tu negocio] y quería saludarte.
Estamos ayudando a [clientes/negocios/personas] como tú con [beneficio principal].
¿Te interesa que te cuente un poco más?`},{name:"Promoción Exclusiva",content:`¡Hola %nombre%! 🎉
Tenemos una promoción especial esta semana:
👉 [Nombre del producto/servicio] con un descuento exclusivo.

¿Quieres que te mande la información completa? 🚀`},{name:"Recordatorio Amistoso",content:`¡Hola %nombre%!
Solo para recordarte sobre [tema pendiente].
Si necesitas algo, no dudes en avisarme. ¡Estoy para ayudarte!`}];let t=[],a=!1;document.addEventListener("panel:activated",({detail:W})=>{W.panelId==="templates"&&(a||(n(),a=!0))});async function n(){console.log("Panel de Plantillas activado."),u(),await p(),f(),L()}function u(){const W=document.getElementById("base-templates-container");W.innerHTML=Be.map(J=>`
            <div class="bg-white p-4 rounded-lg shadow">
                <h4 class="font-bold text-slate-800">${J.name}</h4>
                <p class="text-sm text-slate-600 mt-2 h-20 overflow-hidden">${J.content}</p>
                <div class="text-right mt-4">
                    <button class="apply-template-btn text-sm bg-blue-500 text-white py-1 px-3 rounded-md" data-content="${J.content}">Usar</button>
                </div>
            </div>
        `).join("")}async function p(){try{const{data:W,error:J}=await window.auth.sb.from("message_templates").select("*");if(J)throw J;t=W}catch(W){console.error("Error al cargar plantillas personalizadas:",W)}}function f(){const W=document.getElementById("custom-templates-container");if(t.length===0){W.innerHTML='<p class="text-slate-500 text-center">Aún no has creado plantillas.</p>';return}W.innerHTML=t.map(J=>`
            <div class="bg-white p-4 rounded-lg shadow flex items-center justify-between">
                <div>
                    <h4 class="font-bold text-slate-800">${J.name}</h4>
                    <p class="text-sm text-slate-600 mt-1">${J.content}</p>
                </div>
                <div class="flex items-center gap-2">
                    <button class="ai-enhance-btn text-sm bg-purple-100 text-purple-700 py-1 px-3 rounded-md" data-template-id="${J.id}"><i data-lucide="sparkles" class="w-4 h-4 inline-block pointer-events-none"></i> Mejorar</button>
                    <button class="apply-template-btn text-sm bg-blue-500 text-white py-1 px-3 rounded-md" data-content="${J.content}">Usar</button>
                    <button class="delete-template-btn text-sm bg-red-100 text-red-700 p-2 rounded-md" data-template-id="${J.id}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                </div>
            </div>
        `).join(""),lucide.createIcons()}function L(){var W,J,Y;(W=document.getElementById("add-template-btn"))==null||W.addEventListener("click",T),document.body.addEventListener("click",A=>{const M=A.target.closest(".apply-template-btn"),_=A.target.closest(".delete-template-btn"),R=A.target.closest(".ai-enhance-btn");M&&be(A.target.dataset.content),_&&G(A.target.dataset.templateId),R&&X(A.target.dataset.templateId)}),(J=document.getElementById("cancel-new-template-btn"))==null||J.addEventListener("click",H),(Y=document.getElementById("new-template-form"))==null||Y.addEventListener("submit",N)}async function T(){if(t.length>=5){alert("Has alcanzado el límite de 5 plantillas personalizadas.");return}z()}function z(){var Y;document.getElementById("new-template-form-container").classList.remove("hidden"),document.getElementById("add-template-btn").classList.add("hidden");const W=document.getElementById("new-template-content"),J=document.getElementById("new-template-form");(Y=J.querySelector(".template-actions"))==null||Y.remove(),W.insertAdjacentHTML("afterend",`
            <div class="template-actions flex items-center justify-between mt-2">
                <button type="button" class="personalize-name-btn text-sm bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-md"><i data-lucide="user-plus" class="w-4 h-4 inline-block mr-1"></i>Insertar Nombre</button>
                <button type="button" class="ai-enhance-btn text-xs bg-purple-100 text-purple-700 font-semibold py-1 px-2 rounded-md hover:bg-purple-200 flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> Mejorar con IA</button>
            </div>
        `),J.querySelector(".ai-enhance-btn").addEventListener("click",()=>window.appInstance.openAiEnhanceModal(W.value,A=>{W.value=A})),J.querySelector(".personalize-name-btn").addEventListener("click",()=>he(W)),lucide.createIcons({root:J.querySelector(".template-actions")}),document.getElementById("new-template-name").value="",document.getElementById("new-template-content").value=""}function H(){var J;document.getElementById("new-template-form-container").classList.add("hidden"),document.getElementById("add-template-btn").classList.remove("hidden");const W=document.getElementById("new-template-form");W.reset(),(J=W.querySelector(".template-actions"))==null||J.remove()}async function N(W){W.preventDefault();const J=document.getElementById("new-template-name").value.trim(),Y=document.getElementById("new-template-content").value.trim();if(!(!J||!Y))try{const{error:A}=await window.auth.sb.from("message_templates").insert({user_id:window.auth.getSession().user.id,name:J,content:Y});if(A)throw A;H(),await p(),f()}catch(A){console.error("Error al crear plantilla:",A),alert("No se pudo crear la plantilla.")}}async function G(W){if(confirm("¿Estás seguro de que quieres borrar esta plantilla?"))try{const{error:J}=await window.auth.sb.from("message_templates").delete().eq("id",W);if(J)throw J;await p(),f()}catch(J){console.error("Error al borrar plantilla:",J),alert("No se pudo borrar la plantilla.")}}function be(W){const J=document.querySelector('.nav-link[data-target="bulk-sending"]');J&&(J.click(),setTimeout(()=>{const Y=document.getElementById("bulk-message");Y&&(Y.value=W,Y.focus())},100))}function he(W){if(!W)return;const J=W.selectionStart,Y=W.selectionEnd,A=W.value,M="%nombre%";W.value=A.substring(0,J)+M+A.substring(Y),W.focus(),W.selectionEnd=J+M.length}function X(W){const J=t.find(Y=>Y.id==W);J&&window.appInstance.openAiEnhanceModal(J.content,Y=>{ce(J.id,Y)})}async function ce(W,J){await window.auth.sb.from("message_templates").update({content:J}).eq("id",W),window.appInstance.closeAiModal(),await p(),f()}})();(function(){let Be=!1,t={},a=null,n={used:0,limit:0},u=!1;const p=5e3,f=40;document.addEventListener("panel:activated",({detail:_})=>{_.panelId==="video-ai"&&!Be&&L()});async function L(){Be=!0,await T(),z(),H(),N()}async function T(){var R;a=await window.appInstance.loadUserSubscription();const _=await window.appInstance.loadUserUsage();n={used:(_==null?void 0:_.video_generations_used)||0,limit:((R=a==null?void 0:a.plans)==null?void 0:R.video_generations_limit)||0}}function z(){t={actionsPrompt:"",textPrompt:"",audioType:"",imageUrls:[],model:"veo3_fast",aspectRatio:"Auto",callBackUrl:"",seed:null,generationType:"auto"}}function H(){const _=document.getElementById("video-ai");_&&(_.addEventListener("input",R=>{R.target.id==="video-actions-prompt"&&(t.actionsPrompt=R.target.value),R.target.id==="video-text-prompt"&&(t.textPrompt=R.target.value),R.target.id==="video-audio-type"&&(t.audioType=R.target.value),R.target.id==="video-aspect-ratio-select"&&(t.aspectRatio=R.target.value)}),_.addEventListener("click",R=>{R.target.id==="generate-video-btn"&&X()}))}function N(){var i,h;const _=document.getElementById("video-ai");if(!_)return;const R=((h=(i=a==null?void 0:a.plans)==null?void 0:i.features)==null?void 0:h.video_ai)??!1;if(_.querySelector(".grid").classList.toggle("hidden",!R),_.querySelector("#video-ai-access-denied").classList.toggle("hidden",R),!R){document.getElementById("upgrade-to-grow-from-video").onclick=()=>window.appInstance.handleUpgradeClick("grow");return}const y=_.querySelector("#video-reference-selector");y&&(y.innerHTML=Array.from({length:2}).map((x,B)=>G(`video-ref-${B}`,B===0?"Primer Frame":"Último Frame",t.imageUrls[B])).join(""));const m=_.querySelector("#video-actions-prompt"),w=_.querySelector("#video-text-prompt"),l=_.querySelector("#video-audio-type"),e=_.querySelector("#video-aspect-ratio-select");m&&(m.value=t.actionsPrompt||""),w&&(w.value=t.textPrompt||""),l&&(l.value=t.audioType||""),e&&(e.value=t.aspectRatio||"Auto");const s=_.querySelector("#video-generation-usage-container");s&&(s.innerHTML=`
                <h4 class="font-bold text-sm mb-1">Uso Mensual</h4>
                <p class="text-xs text-slate-600">Videos generados: <span id="video-generation-usage" class="font-bold">${n.used} / ${n.limit}</span></p>
            `),be(),lucide.createIcons()}function G(_,R,y){return`
            <div class="image-upload-slot" data-upload-id="${_}">
                <label for="${_}" class="upload-label">
                    ${y?"":`<div class="text-center text-xs text-gray-500"><p class="font-semibold">${R}</p></div>`}
                </label>
                ${y?`<img src="${y}" alt="Preview" class="image-preview" />`:""}
                ${y?`<button class="remove-button" data-remove-id="${_}"><i data-lucide="x" class="w-4 h-4 pointer-events-none"></i></button>`:""}
                <input id="${_}" type="file" class="hidden" accept="image/*" />
            </div>
        `}function be(){document.querySelectorAll("#video-reference-selector .image-upload-slot").forEach(_=>{var w;const R=_.dataset.uploadId,y=document.getElementById(R),m=parseInt(R.split("-")[2],10);(w=_.querySelector(".remove-button"))==null||w.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),t.imageUrls[m]=null,N()}),y.addEventListener("change",async l=>{var s;const e=(s=l.target.files)==null?void 0:s[0];if(e){try{const i=await window.appInstance.uploadAsset(e,"video-references");t.imageUrls[m]=i}catch{window.showToast("Error al subir la imagen.","error")}N()}})})}function he(){var R,y,m;const _=[];return(R=t.actionsPrompt)!=null&&R.trim()&&_.push(`Acciones: ${t.actionsPrompt.trim()}`),(y=t.textPrompt)!=null&&y.trim()&&_.push(t.textPrompt.trim()),(m=t.audioType)!=null&&m.trim()&&_.push(`Audio de fondo: ${t.audioType.trim()}`),_.join(". ")}async function X(){var m,w,l;if(u)return;const _=he();if(!_||_.trim().length===0){window.showToast("Debes completar al menos una sección (acciones, texto o audio).","error");return}if(n.limit>0&&n.used>=n.limit){window.showToast("Has alcanzado tu limite de generaciones de video.","error");return}const R=document.getElementById("generate-video-btn"),y=document.getElementById("video-result-container");u=!0,R.disabled=!0,R.textContent="Generando...",y.innerHTML='<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>';try{const e=(w=(m=window.auth.getSession())==null?void 0:m.user)==null?void 0:w.id;if(!e)throw new Error("No se pudo determinar el usuario actual.");const{data:s,error:i}=await window.auth.sb.rpc("increment_video_usage",{p_user_id:e});if(i||!(s!=null&&s.success))throw new Error((s==null?void 0:s.message)||(i==null?void 0:i.message)||"Error al verificar el uso.");const h=t.imageUrls.filter(Boolean);let x="TEXT_2_VIDEO";h.length>=1&&(x="FIRST_AND_LAST_FRAMES_2_VIDEO");const B={prompt:_,model:"veo3_fast",aspectRatio:t.aspectRatio||"Auto",generationType:x,enableTranslation:!0,imageUrls:h.length?h:void 0,callBackUrl:t.callBackUrl||void 0,seeds:t.seed||void 0},{data:se,error:C}=await window.auth.invokeFunction("kie-veo-proxy",{body:B});if(C)throw C;const b=(l=se==null?void 0:se.data)==null?void 0:l.taskId;if(!b)throw new Error("La API de Kie.ai no devolvio un identificador de tarea.");y.innerHTML=`
                <div class="text-center p-4">
                    <p class="font-semibold">Tarea enviada. Esperando resultados...</p>
                    <p class="text-xs text-slate-500 mt-1">ID: <span class="font-mono">${b}</span></p>
                </div>
            `;const j=await ce(b),O=W(j);if(!O)throw new Error("La tarea finalizo sin devolver el video.");const ee=await J(O,e);n.used=s.used||n.used+1,A(),y.innerHTML=`
                <div class="space-y-3">
                    <video class="w-full rounded-lg shadow-lg" controls playsinline src="${ee}"></video>
                    <div class="flex flex-col items-center gap-2 text-sm text-slate-600">
                        <span class="font-semibold">Video generado con audio (KIE Veo 3.1 Fast)</span>
                        <a class="text-indigo-600 hover:underline" href="${ee}" target="_blank" rel="noopener">Abrir en nueva pestaña</a>
                    </div>
                </div>
            `,lucide.createIcons(),window.showToast("Video generado correctamente.","success")}catch(e){console.error("Error al generar video:",e);const s=(e==null?void 0:e.message)||"Ocurrio un error al generar el video.";window.showToast(s,"error"),A();const i=document.getElementById("video-result-container");i.innerHTML=`
                <div class="text-center p-4">
                    <i data-lucide="alert-triangle" class="w-12 h-12 text-red-500 mx-auto"></i>
                    <p class="font-semibold mt-2 text-red-700">Error en la generacion</p>
                    <p class="text-xs text-slate-500 mt-1">${s}</p>
                </div>
            `,lucide.createIcons()}finally{u=!1,R.disabled=!1,R.textContent="Generar Video"}}async function ce(_,R=f,y=p){let m=0;for(;m<R;){m+=1;try{const{data:w,error:l}=await window.auth.invokeFunction("kie-task-status",{body:{taskId:_}});if(l)throw new Error(l.message||"Error consultando el estado de la tarea.");const e=w==null?void 0:w.data,s=e==null?void 0:e.state;if(s==="success")return e;if(s==="fail"){const i=(e==null?void 0:e.failMsg)||"La generacion de video fallo.";throw new Error(i)}await M(y)}catch(w){if(console.error("Error al consultar el estado de la tarea de video:",w),m>=R)throw w;await M(y)}}throw new Error("La generacion de video esta tardando mas de lo esperado. Intenta nuevamente.")}function W(_){if(!_)return null;if(Array.isArray(_.resultUrls)&&_.resultUrls.length>0)return _.resultUrls[0];if(_.videoUrl)return _.videoUrl;const R=typeof _.resultJson=="string"?_.resultJson:null;if(R)try{const y=JSON.parse(R);if(Array.isArray(y.resultUrls)&&y.resultUrls.length>0)return y.resultUrls[0];if(y.videoUrl)return y.videoUrl}catch(y){console.error("No se pudo interpretar el resultJson de Veo 3.1:",y)}return null}async function J(_,R){const y=await fetch(_);if(!y.ok)throw new Error(`No se pudo descargar el video generado (status ${y.status}).`);const m=await y.blob(),w=Y(m.type),l=`veo-video-${Date.now()}.${w}`,e=new File([m],l,{type:m.type||"video/mp4"}),s=await window.appInstance.uploadAsset(e,"video-results");try{await window.auth.sb.from("profiles").update({last_video_generated_url:s}).eq("id",R)}catch(i){console.warn("No se pudo registrar el último video generado en el perfil:",i)}return s}function Y(_){return _?_.includes("webm")?"webm":_.includes("mov")?"mov":_.includes("gif")?"gif":"mp4":"mp4"}function A(){const _=document.getElementById("video-generation-usage");_&&(_.textContent=`${n.used} / ${n.limit}`)}function M(_){return new Promise(R=>setTimeout(R,_))}})();const Nt=document.createElement("style");Nt.textContent=".content-panel:not(.active) { display: none !important; }";document.head.appendChild(Nt);document.addEventListener("DOMContentLoaded",()=>{const Be=t=>{t&&!window.appInstance&&(window.appInstance=new yt(t),window.appInstance.init())};document.addEventListener("auth:ready",({detail:t})=>Be(t.session))});(function(){if(window.openColumnMappingModal)return;const t=(a,n)=>{const u={},p=new Set,f=a.map(T=>T.toLowerCase()),L=(T=[])=>{for(const z of T){const H=f.indexOf(z.toLowerCase());if(H!==-1&&!p.has(H))return H}return-1};for(const T of n){let z=L(T.aliases);if(z===-1&&(z=a.findIndex((H,N)=>!p.has(N))),z===-1){if(T.required)return console.warn(`No se pudo asignar automáticamente la columna para "${T.label}".`),null;continue}u[T.field]=z,p.add(z)}return u};window.openColumnMappingModal=async function(a=[],n=[]){const u=n.map(N=>typeof N=="string"?N.trim():"").filter(Boolean),p=document.getElementById("column-mapping-modal"),f=document.getElementById("column-mapping-table-body"),L=document.getElementById("column-mapping-error"),T=document.getElementById("confirm-column-mapping-btn"),z=document.getElementById("cancel-column-mapping-btn"),H=document.getElementById("close-column-mapping-btn");return!p||!f||!L||!T||!z||!H?(console.warn("No se encontró el modal de mapeo de columnas. Se intentará asignar automáticamente."),t(u,a)):await new Promise(N=>{var l;const G=new Map(a.map(e=>[e.field,e]));let be=!1,he=[];f.innerHTML="";const X=(e=[])=>{const s=u.map(i=>i.toLowerCase());for(const i of e){const h=s.indexOf(i.toLowerCase());if(h!==-1)return h}return-1};a.forEach(e=>{const s=document.createElement("tr");s.innerHTML=`
                    <td class="px-4 py-3">
                        <div class="flex flex-col">
                            <span class="font-medium text-slate-700">${e.label}</span>
                            <span class="mt-1 text-xs ${e.required?"text-red-500 font-semibold":"text-slate-400"}">${e.required?"Obligatorio":"Opcional"}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <select class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">${e.required?"Selecciona una columna":"Dejar sin asignar"}</option>
                        </select>
                    </td>
                `;const i=s.querySelector("select");i.dataset.field=e.field,i.dataset.required=e.required?"true":"false",u.forEach((h,x)=>{const B=document.createElement("option");B.value=String(x),B.textContent=h,i.appendChild(B)}),f.appendChild(s)}),he=Array.from(f.querySelectorAll("select"));const ce=new Set;he.forEach(e=>{const s=G.get(e.dataset.field),i=X((s==null?void 0:s.aliases)||[]);typeof i=="number"&&i>=0&&!ce.has(String(i))&&(e.value=String(i),ce.add(String(i)))});const W=()=>{const e=new Set(he.map(s=>s.value).filter(Boolean));he.forEach(s=>{Array.from(s.options).forEach(i=>{i.value&&(i.disabled=s.value!==i.value&&e.has(i.value))})})},J=e=>{L.textContent=e,L.classList.remove("hidden")},Y=()=>{L.textContent="",L.classList.add("hidden")},A=e=>{e.target.classList.remove("border-red-500"),Y(),W()},M=()=>{he.forEach(e=>e.removeEventListener("change",A)),T.removeEventListener("click",R),z.removeEventListener("click",y),H.removeEventListener("click",y),p.removeEventListener("click",m),document.removeEventListener("keydown",w),f.innerHTML="",Y(),p.classList.add("hidden"),document.body.classList.remove("overflow-hidden")},_=e=>{be||(be=!0,M(),N(e))},R=()=>{const e={};Y();for(const s of he){const i=s.dataset.field,h=G.get(i),x=s.value;if(!x){if(h!=null&&h.required){s.classList.add("border-red-500"),J(`Selecciona una columna para "${h.label}".`),s.focus();return}continue}e[i]=Number(x)}_(e)},y=()=>_(null),m=e=>{e.target===p&&_(null)},w=e=>{e.key==="Escape"&&(e.preventDefault(),_(null))};he.forEach(e=>e.addEventListener("change",A)),T.addEventListener("click",R),z.addEventListener("click",y),H.addEventListener("click",y),p.addEventListener("click",m),document.addEventListener("keydown",w),document.body.classList.add("overflow-hidden"),p.classList.remove("hidden"),Y(),typeof(lucide==null?void 0:lucide.createIcons)=="function"&&lucide.createIcons(),W(),(l=he[0])==null||l.focus()})},window.escapeCsvValue=function(a){if(a==null)return"";const n=String(a);return/[",\n]/.test(n)?'"'+n.replace(/"/g,'""')+'"':n},window.splitCsvLines=function(a){if(typeof a!="string")return[];let n=a;n.length&&n.charCodeAt(0)===65279&&(n=n.slice(1));const u=[];let p="",f=!1;for(let L=0;L<n.length;L++){const T=n[L];if(T==='"'){f&&n[L+1]==='"'?(p+='"',L++):(f=!f,p+=T);continue}if((T===`
`||T==="\r")&&!f){T==="\r"&&n[L+1]===`
`&&L++,u.push(p),p="";continue}p+=T}return p.length>0&&u.push(p),u.map(L=>L.trim()).filter(L=>L.length>0)},window.convertFileToCsvText=async function(a){const n=(a.name||"").toLowerCase();if(n.endsWith(".xlsx")||n.endsWith(".xls")){if(typeof XLSX>"u")throw new Error("No se pudo cargar el lector de hojas de cálculo (XLSX). Recarga la página e intenta nuevamente.");const u=await a.arrayBuffer(),p=XLSX.read(u,{type:"array"});if(!p.SheetNames.length)throw new Error("El archivo de Excel no contiene hojas válidas.");const f=p.Sheets[p.SheetNames[0]];return XLSX.utils.sheet_to_csv(f,{FS:",",RS:`
`})}return await a.text()},window.parseCsvRow=function(a){const n=[];let u="",p=!1;for(let f=0;f<a.length;f++){const L=a[f];L==='"'&&(f===0||a[f-1]!=='"')?p&&a[f+1]==='"'?(u+='"',f++):p=!p:L===","&&!p?(n.push(u.trim()),u=""):u+=L}return n.push(u.trim()),n},window.autoMapHeaders=function(a,n){const u={},p=new Set,f=a.map(L=>L.toLowerCase());for(const L of n){let T=-1;for(const z of L.aliases||[]){const H=f.indexOf(z.toLowerCase());if(H!==-1&&!p.has(H)){T=H;break}}if(T===-1&&(T=a.findIndex((z,H)=>!p.has(H))),T===-1){if(L.required)return null;continue}u[L.field]=T,p.add(T)}return u},window.getColumnValue=function(a,n){return typeof n!="number"||n<0||n>=a.length?"":a[n]},window.cleanPhone=function(a){if(!a)return"";const n=String(a).replace(/\D+/g,"");return n.length<10?"":"+521"+n.slice(-10)}})();class yt{constructor(t){this.session=t,this.switchPanel=this.switchPanel.bind(this),this.user=t.user,this.teamInfo=null,this.config={N8N_URL:"https://n8n-n8n.mcjhhb.easypanel.host",YOUTUBE_PLAYLIST_ID:"PLfA32SmdFbHBdOXaPc_tdg28Kl2CFAXnz",CHATWOOT_BASE_URL:"https://chat.elinaia.com.mx"},this.handlePromptSave=this.handlePromptSave.bind(this),this.checkWhatsappConnection=this.checkWhatsappConnection.bind(this),this.openChatwoot=this.openChatwoot.bind(this),this.openAiEnhanceModal=this.openAiEnhanceModal.bind(this)}init(){if(lucide.createIcons(),!localStorage.getItem("welcome_popup_shown")){const a=document.getElementById("welcome-modal");a&&(a.classList.remove("hidden"),document.getElementById("close-welcome-modal").addEventListener("click",()=>{a.classList.add("hidden"),localStorage.setItem("welcome_popup_shown","true")}))}this.setupEventListeners(),this.loadInitialData(),this.checkImpersonation();const t=localStorage.getItem("activePanelId")||"dashboard";this.switchPanel(t),this.listenForProfileChanges(),this.wizard=new Yt(this),this.setSidebarCollapsed(localStorage.getItem("sidebarCollapsed")==="true")}setupEventListeners(){var n,u,p,f,L,T,z,H,N,G,be,he,X,ce,W,J,Y,A;document.querySelectorAll(".nav-link[data-target]").forEach(M=>{M.addEventListener("click",_=>{_.preventDefault(),this.switchPanel(M.dataset.target)})}),(n=document.getElementById("logout-btn"))==null||n.addEventListener("click",M=>{M.preventDefault(),auth.handleLogout()}),(u=document.getElementById("prompt-form"))==null||u.addEventListener("submit",this.handlePromptSave),(p=document.getElementById("main-prompt-ai-enhance-btn"))==null||p.addEventListener("click",()=>{const M=document.getElementById("ai-master-prompt");M.value&&this.openAiEnhanceModal(M.value,_=>{M.value=_},"behavior_prompt")}),(f=document.getElementById("remake-prompt-btn"))==null||f.addEventListener("click",()=>{this.wizard.start(!0)}),(L=document.getElementById("request-qr-btn"))==null||L.addEventListener("click",this.checkWhatsappConnection),(T=document.getElementById("chatwoot-link"))==null||T.addEventListener("click",this.openChatwoot),(z=document.getElementById("mobile-menu-btn"))==null||z.addEventListener("click",()=>{const M=document.getElementById("main-sidebar");M==null||M.classList.add("open")}),(H=document.getElementById("prompt-help-btn"))==null||H.addEventListener("click",()=>{var M;return(M=document.getElementById("prompt-help-modal"))==null?void 0:M.classList.remove("hidden")}),(N=document.getElementById("close-prompt-help-btn"))==null||N.addEventListener("click",()=>{var M;return(M=document.getElementById("prompt-help-modal"))==null?void 0:M.classList.add("hidden")}),(G=document.getElementById("start-wizard-btn"))==null||G.addEventListener("click",()=>this.wizard.start()),(be=document.getElementById("close-sidebar-btn"))==null||be.addEventListener("click",()=>{const M=document.getElementById("main-sidebar");M==null||M.classList.remove("open")}),(he=document.getElementById("open-tutorials-btn"))==null||he.addEventListener("click",()=>this.openTutorialsModal()),this.setupYoutubeCarousel(),(X=document.getElementById("cancel-ai-btn"))==null||X.addEventListener("click",()=>this.closeAiModal()),(ce=document.getElementById("generate-ai-btn"))==null||ce.addEventListener("click",()=>this.handleGenerateAi());const t=document.getElementById("regenerate-ai-btn");t&&t.addEventListener("click",()=>this.handleGenerateAi(!0)),(W=document.getElementById("regenerate-ai-btn"))==null||W.addEventListener("click",()=>this.handleGenerateAi()),(J=document.getElementById("apply-ai-btn"))==null||J.addEventListener("click",()=>this.handleApplyAi()),(Y=document.getElementById("toggle-sidebar-collapse-btn"))==null||Y.addEventListener("click",()=>this.toggleSidebarCollapsed()),(A=document.getElementById("cancel-pricing-modal-btn"))==null||A.addEventListener("click",()=>this.closePricingModal());const a=document.getElementById("pricing-modal");a&&a.addEventListener("click",M=>{const _=M.target.closest(".upgrade-btn");if(_){M.preventDefault();const R=_.dataset.plan;R&&this.handleUpgradeClick(R)}})}checkImpersonation(){const t=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),a=localStorage.getItem("superadmin_session_tokens");if(!t){document.body.style.paddingTop="0";return}if(!a){localStorage.removeItem("impersonated_user_info"),document.body.style.paddingTop="0";return}if(!document.getElementById("impersonation-bar")&&t){const n=document.createElement("div");n.id="impersonation-bar",n.className="fixed top-0 left-0 w-full bg-amber-500 text-black font-bold text-xs p-1 text-center z-[200] flex justify-center items-center gap-2",n.innerHTML=`
                <span>Estás viendo como <strong>${t.email}</strong>.</span>
                <button id="stop-impersonating-btn" class="bg-slate-800 text-white py-0.5 px-2 rounded hover:bg-slate-700 text-xs">Volver a Super Admin</button>
            `,document.body.prepend(n),document.body.style.paddingTop="0",document.getElementById("stop-impersonating-btn").addEventListener("click",async()=>{try{const u=JSON.parse(localStorage.getItem("superadmin_session_tokens")||"null");if(!(u!=null&&u.access_token)||!(u!=null&&u.refresh_token))throw new Error("Sesión original inválida. Por favor, inicia sesión nuevamente.");await window.auth.sb.auth.setSession(u),localStorage.removeItem("impersonated_user_info"),localStorage.removeItem("superadmin_session_tokens"),document.body.style.paddingTop="0",window.location.reload()}catch(u){console.error("Error al detener la suplantación:",u),alert("No se pudo volver a la sesión de superadmin. Por favor, cierra sesión y vuelve a entrar.")}})}}loadInitialData(){this.fetchUserProfile(),this.fetchMasterPrompt(),this.loadDashboardMetrics(),this.loadFunnelMetrics(),Promise.all([this.loadUserSubscription(),this.loadTeamInfo()]).then(([t,a])=>{this.renderUserPlanBadge(t),this.renderUpgradeButtons(t),document.addEventListener("panel:activated",()=>this.applyFeatureRestrictions(t,a))}),this.renderWhatsappConnection("initial")}openTutorialsModal(){const t="https://www.youtube.com/embed/videoseries?list=PLDs44uukbe3FIDa9CttQLh8N-Nfdpo_hG&autoplay=1",a=document.getElementById("image-viewer-modal"),n=document.getElementById("image-viewer-content");n.innerHTML=`<iframe class="w-full h-full" src="${t}" title="Tutoriales ELINA IA" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`,a.classList.remove("hidden")}toggleSidebarCollapsed(){const t=document.getElementById("main-sidebar");if(!t)return;const a=t.classList.toggle("sidebar-collapsed");this.setSidebarCollapsed(a),localStorage.setItem("sidebarCollapsed",a)}setSidebarCollapsed(t){const a=document.getElementById("main-sidebar"),n=document.getElementById("main-content-area"),u=document.getElementById("toggle-sidebar-collapse-btn");if(!a||!n||!u)return;t?(a.classList.add("sidebar-collapsed"),n.classList.add("lg:ml-20"),n.classList.remove("lg:ml-64"),u.style.left="4.5rem"):(a.classList.remove("sidebar-collapsed"),n.classList.remove("lg:ml-20"),n.classList.add("lg:ml-64"),u.style.left="15.5rem");const p=u.querySelector("i");p&&p.setAttribute("data-lucide",t?"chevron-right":"chevron-left"),lucide.createIcons({nodes:[p]})}switchPanel(t,a={}){const n=document.getElementById("main-sidebar"),u=document.getElementById("main-content-area"),p=document.getElementById("toggle-sidebar-collapse-btn");document.querySelectorAll(".content-panel").forEach(z=>z.classList.remove("active"));const f=document.getElementById(t);if(f){if(t==="kanban")n.classList.add("hidden"),p.style.display="none",u.classList.remove("lg:ml-64","lg:ml-20","ml-0"),u.classList.add("lg:ml-0");else{n.classList.remove("hidden"),p.style.display="";const z=n.classList.contains("sidebar-collapsed");u.classList.remove("lg:ml-0"),u.classList.toggle("lg:ml-20",z),u.classList.toggle("lg:ml-64",!z)}f.classList.add("active"),localStorage.setItem("activePanelId",t),document.dispatchEvent(new CustomEvent("panel:activated",{detail:{panelId:t,options:a}})),n&&n.classList.contains("open")&&n.classList.remove("open")}const L=["bg-green-500","text-white"];document.querySelectorAll(".nav-link[data-target]").forEach(z=>z.classList.remove(...L));const T=document.querySelector(`.nav-link[data-target="${t}"]`);T&&T.classList.add(...L)}listenForProfileChanges(){auth.sb.channel(`profile-changes:${this.user.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"profiles",filter:`id=eq.${this.user.id}`},t=>{const{whatsapp_connected:a,sync_status:n}=t.new;document.dispatchEvent(new CustomEvent("profile:updated",{detail:{whatsapp_connected:a,sync_status:n}}))}).subscribe()}async loadUserSubscription(){try{const{data:t,error:a}=await auth.sb.from("subscriptions").select("status, plan_id, plans:plan_id(*)").eq("user_id",this.user.id).limit(1).single();if(a&&a.code!=="PGRST116")throw a;if(t&&t.plan_id==="free_trial"&&t.status==="trialing"){const{data:n}=await auth.sb.from("profiles").select("stripe_customer_id").eq("id",this.user.id).single();if(n&&n.stripe_customer_id){const{data:u,error:p}=await window.auth.invokeFunction("get-stripe-subscription",{body:{customerId:n.stripe_customer_id}});if(p)throw p;u&&u.planId&&(t.plan_id=u.planId,t.plans.name=u.planName,t.plans.features=u.features)}}return t}catch(t){return console.error("Error al cargar la suscripción del usuario:",t),null}}async loadTeamInfo(){try{const{data:t,error:a}=await auth.sb.rpc("get_user_team_info_with_permissions",{p_user_id:this.user.id});if(a)throw a;return t&&t.length>0&&(this.teamInfo=t[0]),this.teamInfo}catch(t){return console.error("Error al cargar la información del equipo:",t),null}}async loadUserUsage(){try{const{data:t,error:a}=await window.auth.sb.from("profiles").select("ai_enhancements_used, image_generations_used, bulk_sends_used").eq("id",this.user.id).single();if(a)throw a;return t}catch(t){return console.error("Error al cargar el uso del usuario:",t),{ai_enhancements_used:0,image_generations_used:0,bulk_sends_used:0}}}async renderUsageAndLimits(){var p;const[t,a]=await Promise.all([this.loadUserSubscription(),this.loadUserUsage()]);t?(this.renderUserPlanBadge(t),this.renderUpgradeButtons(t),this.applyFeatureRestrictions(t,this.teamInfo)):console.warn("El usuario no tiene una suscripción registrada.");const n=((p=t==null?void 0:t.plans)==null?void 0:p.image_generations_limit)||0,u=(a==null?void 0:a.image_generations_used)||0;console.log("[Uso Verificado]",{imageGenerations:{used:u,limit:n}}),document.dispatchEvent(new CustomEvent("usage:updated",{detail:{imageGenerations:{remaining:n-u,limit:n}}}))}renderUserPlanBadge(t){var L;const a=document.getElementById("user-plan-badge");if(!a||!t)return;const n=t.plan_id,u=((L=t.plans)==null?void 0:L.name)||n.replace("_"," ").replace(/\b\w/g,T=>T.toUpperCase());let p="bg-slate-200",f="text-slate-700";switch(n){case"free_trial":p="bg-blue-100",f="text-blue-800";break;case"starter":p="bg-green-100",f="text-green-800";break;case"grow":p="bg-purple-100",f="text-purple-800";break;case"business":p="bg-slate-200",f="text-slate-800";break}a.textContent=u,a.className=`inline-block text-xs font-bold px-2 py-0.5 rounded-md mt-1.5 ${p} ${f}`}applyFeatureRestrictions(t,a){if(!t||!t.plans)return;const n=t.plans.features||{},u=a==null?void 0:a.user_role,p=document.getElementById("follow-ups");if(p!=null&&p.classList.contains("active")&&p.querySelector("#follow-ups-container")){const L=p.querySelector("#follow-ups-container"),T=p.querySelector("#follow-ups-access-denied");n.follow_ups?(L&&L.classList.remove("hidden"),T&&T.classList.add("hidden")):(L&&L.classList.add("hidden"),T&&T.classList.remove("hidden"),document.getElementById("upgrade-to-grow-from-followups").onclick=()=>this.handleUpgradeClick("grow"))}const f=document.getElementById("designer-ai");if(f!=null&&f.classList.contains("active")&&f.querySelector("#designer-ai-access-denied")){const L=f.querySelector(".grid"),T=f.querySelector("#designer-ai-access-denied"),z=n.designer_ai;L&&L.classList.toggle("hidden",!z),T&&T.classList.toggle("hidden",z),z||(document.getElementById("upgrade-to-grow-from-designer").onclick=()=>this.handleUpgradeClick("grow"))}if(u==="advisor"){const L=(a==null?void 0:a.permissions)||{};document.querySelectorAll(".nav-link[data-target]").forEach(T=>{const z=T.dataset.target;z!=="dashboard"&&!L[z]&&(T.parentElement.style.display="none")})}}renderUpgradeButtons(t){const a=document.getElementById("upgrade-plan-section");if(!a||!t)return;const n=document.getElementById("upgrade-grow-btn"),u=document.getElementById("upgrade-collapsed-btn"),p=document.getElementById("upgrade-trial-btn");n&&n.classList.add("hidden"),p&&p.classList.add("hidden"),a&&a.classList.add("hidden"),u&&u.classList.add("hidden");const f=t.plan_id;f==="free_trial"?(p.classList.remove("hidden"),a.classList.remove("hidden"),p.onclick=()=>this.openPricingModal(),u.onclick=()=>this.openPricingModal()):f==="starter"&&(n.classList.remove("hidden"),a.classList.remove("hidden"),n.onclick=()=>this.handleUpgradeClick("grow"),u.onclick=()=>this.handleUpgradeClick("grow"))}openPricingModal(){const t=document.getElementById("pricing-modal");t&&t.classList.remove("hidden")}closePricingModal(){const t=document.getElementById("pricing-modal");t&&t.classList.add("hidden")}async handleUpgradeClick(t){const a=document.querySelector(`.upgrade-btn[data-plan="${t}"]`)||document.getElementById(`upgrade-${t}-btn`);if(!a)return;const n=document.getElementById("pricing-modal");n&&n.classList.add("hidden");const u=a.textContent;a.disabled=!0,a.textContent="Redirigiendo a pago...";try{const{data:p,error:f}=await window.auth.invokeFunction("create-checkout-session",{body:{planId:t,userId:this.user.id}});if(f)throw new Error(f.message);window.location.href=p.url}catch(p){console.error("Error al iniciar el proceso de pago:",p),window.showToast("No se pudo iniciar el proceso de pago. Por favor, intenta de nuevo.","error"),a.disabled=!1,a.textContent=u}}async fetchUserProfile(){var n,u,p;const t=document.getElementById("user-business-name"),a=document.getElementById("user-avatar");try{const{data:f,error:L}=await window.auth.sb.from("profiles").select("full_name, role, urlfoto").eq("id",this.user.id).single();if(L)throw L;const z=((n=this.teamInfo)==null?void 0:n.team_name)||f.full_name||"Mi negocio";if(t&&(t.textContent=z),a){const H=(f.urlfoto||"").trim();a.src=H||`https://ui-avatars.com/api/?background=0A3B66&color=fff&name=${encodeURIComponent(z)}`,a.alt=`Logo de ${z}`}f.role==="superadmin"&&((u=document.getElementById("superadmin-link"))==null||u.classList.remove("hidden"),(p=document.getElementById("mobile-superadmin-link"))==null||p.classList.remove("hidden"))}catch(f){console.error("Error al cargar el perfil del usuario:",f),t&&(t.textContent="Mi negocio"),a&&(a.src="https://ui-avatars.com/api/?background=0A3B66&color=fff&name=Elina")}}async fetchMasterPrompt(){try{const{data:t,error:a}=await auth.sb.from("prompts").select("prompt_content").eq("user_id",this.user.id).single();if(a&&a.code!=="PGRST116")throw a;document.getElementById("ai-master-prompt").value=(t==null?void 0:t.prompt_content)||""}catch(t){console.error("Error al cargar el prompt:",t),document.getElementById("ai-master-prompt").value="No se pudo cargar el prompt."}}async handlePromptSave(t){t.preventDefault();const a=document.getElementById("prompt-form");if(!a)return;const n=a.querySelector('button[type="submit"]'),u=document.getElementById("ai-master-prompt").value;if(n){n.disabled=!0,n.textContent="Guardando...";try{const{error:p}=await auth.sb.from("prompts").upsert({user_id:this.user.id,prompt_content:u},{onConflict:"user_id"});if(p)throw p;window.showToast("Prompt guardado con éxito.","success")}catch(p){console.error("Error al guardar el prompt:",p),window.showToast("Error al guardar el prompt. Revisa la consola.","error")}finally{n.disabled=!1,n.textContent="Guardar"}}}async uploadAsset(t,a,n){if(!t)return null;const u=this.user.id,p=t.name,f=p.lastIndexOf("."),L=f>0?p.substring(f):"",z=(f>0?p.substring(0,f):p).replace(/[^a-zA-Z0-9._-]/g,"_")+L,H=`temp-uploads/${u}/${a}/${Date.now()}-${z}`;try{n&&n(10);const{error:N}=await window.auth.sb.storage.from("campaign_files").upload(H,t,{onUploadProgress:ce=>{if(n){const W=10+ce.loaded/ce.total*50;n(Math.min(W,60))}}});if(N)throw new Error(`Error en subida temporal: ${N.message}`);n&&n(60);const{data:G}=window.auth.sb.storage.from("campaign_files").getPublicUrl(H);n&&n(70);const{data:be,error:he}=await window.auth.invokeFunction("smart-worker",{body:{sourceUrl:G.publicUrl,userId:u,fileName:z,folder:a}});if(he)throw new Error(`Error al mover a CDN: ${he.message}`);n&&n(90);const{error:X}=await window.auth.sb.storage.from("campaign_files").remove([H]);return X&&console.warn(`[Limpieza] No se pudo borrar el archivo temporal ${H}:`,X.message),n&&n(100),be.cdnUrl}catch(N){throw console.error("Falló el proceso completo de subida de asset:",N),N}}async loadDashboardMetrics(){try{const t=new Date,a=new Date(t);a.setDate(t.getDate()-30);const{data:n,error:u}=await auth.sb.from("daily_stats").select("stat_date, ai_responses_count, time_saved_seconds").eq("user_id",this.user.id).gte("stat_date",a.toISOString().split("T")[0]).order("stat_date",{ascending:!0});if(u)throw u;this.renderMetricsCharts(n)}catch(t){console.error("Error al cargar métricas del dashboard:",t)}}renderMetricsCharts(t){var T,z;const a=t.map(H=>new Date(H.stat_date+"T00:00:00").toLocaleDateString("es-MX",{day:"numeric",month:"short"})),n=t.map(H=>H.ai_responses_count),u=t.map(H=>Math.round(H.time_saved_seconds/60)),p={responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{color:"#94a3b8"}},x:{ticks:{color:"#94a3b8"}}},plugins:{legend:{display:!1}}},f=(T=document.getElementById("responses-chart"))==null?void 0:T.getContext("2d");f&&new Chart(f,{type:"line",data:{labels:a,datasets:[{label:"Mensajes Respondidos",data:n,borderColor:"rgb(59, 130, 246)",backgroundColor:"rgba(59, 130, 246, 0.1)",fill:!0,tension:.3}]},options:p});const L=(z=document.getElementById("time-saved-chart"))==null?void 0:z.getContext("2d");L&&new Chart(L,{type:"line",data:{labels:a,datasets:[{label:"Minutos Ahorrados",data:u,borderColor:"rgb(139, 92, 246)",backgroundColor:"rgba(139, 92, 246, 0.1)",fill:!0,tension:.3}]},options:p})}async loadFunnelMetrics(){try{const t=new Date;t.setDate(t.getDate()-30);const{data:a,error:n}=await auth.sb.from("contacts").select("labels, created_at").eq("user_id",this.user.id).gte("created_at",t.toISOString());if(n)throw n;let u=0,p=0,f=0;a.forEach(T=>{const z=new Set(T.labels||[]);u++,z.has("Interesado")&&p++,z.has("nuevo cliente")&&f++});const L=u>0?(f/u*100).toFixed(1):0;document.getElementById("funnel-leads-stat").textContent=u,document.getElementById("funnel-interested-stat").textContent=p,document.getElementById("funnel-won-stat").textContent=f,document.getElementById("funnel-conversion-stat").textContent=`${L}%`}catch(t){console.error("Error al cargar métricas del embudo:",t)}}async checkWhatsappConnection(){this.renderWhatsappConnection("loading");const t=`${this.config.N8N_URL}/webhook/generate-whatsapp-qr-Elina`;try{const a=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:this.user.email})});if(!a.ok)throw new Error("El servidor N8N no responde correctamente.");const n=await a.text(),u=n.trim();if(!u){this.renderWhatsappConnection("connected");return}let p;try{p=JSON.parse(u)}catch(L){console.warn("Respuesta QR inesperada, se esperaba JSON.",L,n),this.renderWhatsappConnection("error");return}const f=Array.isArray(p)?p[0]:p;f!=null&&f.qr_image_data?this.renderWhatsappConnection("qr",f.qr_image_data):this.renderWhatsappConnection("connected")}catch(a){console.error("Error al solicitar QR:",a),this.renderWhatsappConnection("error")}}openChatwoot(t){t.preventDefault(),window.open(`${this.config.CHATWOOT_BASE_URL}/app/login`,"_blank")}setupYoutubeCarousel(){const t=document.getElementById("yt-player"),a=document.querySelectorAll("#yt-carousel [data-vid]"),n=this.config.YOUTUBE_PLAYLIST_ID;a.forEach(u=>{u.addEventListener("click",p=>{p.preventDefault();const f=u.dataset.vid;f&&t&&(t.src=`https://www.youtube.com/embed/${f}?list=${n}&rel=0&autoplay=1`)})})}renderWhatsappConnection(t,a=null){const n=document.getElementById("whatsapp-connection-container"),u=document.getElementById("request-qr-btn");let p="";switch(t){case"connected":p=`
                    <div class="flex flex-col items-center justify-center h-48 text-green-600">
                        <i data-lucide="check-circle" class="w-16 h-16"></i>
                        <p class="font-bold mt-2">¡Conectado!</p>
                        <p class="text-sm text-slate-500">Tu sesión de WhatsApp está activa.</p>
                    </div>`,u.style.display="none";break;case"loading":p=`
                    <div class="flex justify-center items-center h-48">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-slate-900"></div>
                    </div>`,u.style.display="block";break;case"qr":p=`<img src="data:image/png;base64,${a}" alt="Escanea para conectar WhatsApp" class="mx-auto max-w-xs rounded-lg">`,u.style.display="block";break;case"error":p=`
                    <div class="flex flex-col items-center justify-center h-48 text-red-500">
                         <i data-lucide="alert-triangle" class="w-16 h-16"></i>
                         <p class="font-bold mt-2">Error de Conexión</p>
                    </div>`,u.style.display="block";break;case"initial":default:p=`
                    <div class="flex flex-col items-center justify-center h-48 text-slate-400">
                         <i data-lucide="qr-code" class="w-16 h-16"></i>
                         <p class="font-bold mt-2">Solicita el QR para vincular</p>
                    </div>`,u.style.display="block";break}n.innerHTML=p,lucide.createIcons()}async openAiEnhanceModal(t,a,n="default"){var f;const u=document.getElementById("ai-enhance-modal");if(!u)return;const p=document.getElementById("generate-ai-btn");try{this.aiModalContext=n;const[L,T]=await Promise.all([this.loadUserSubscription(),this.loadUserUsage()]);if(!L)throw new Error("No se pudo cargar la información del plan.");const z=((f=L.plans)==null?void 0:f.ai_enhancements_limit)||0,H=(T==null?void 0:T.ai_enhancements_used)||0,N=z-H;document.getElementById("ai-uses-left").textContent=`${N}/${z}`,p.disabled=N<=0,N<=0&&window.showToast("Has alcanzado tu límite de mejoras con IA este mes.","info"),this.aiModalCallback=a,document.getElementById("ai-original-text").value=t,document.getElementById("ai-prompt-input").value="",document.getElementById("ai-result-container").innerHTML="",document.getElementById("ai-result-container").classList.add("hidden"),p.classList.remove("hidden"),document.getElementById("apply-ai-btn").classList.add("hidden"),document.getElementById("regenerate-ai-btn").classList.add("hidden"),u.classList.remove("hidden")}catch(L){window.showToast(L.message,"error");return}}closeAiModal(){document.getElementById("ai-enhance-modal").classList.add("hidden"),this.aiModalCallback=null}async handleGenerateAi(t=!1){var L;const a=t?document.getElementById("regenerate-ai-btn"):document.getElementById("generate-ai-btn"),n=document.getElementById("generate-ai-btn");a.disabled=!0,a.textContent="Generando...";const u=document.getElementById("ai-original-text").value,p=document.getElementById("ai-prompt-input").value;let f;this.aiModalContext==="designer"?f=`Eres un asistente de diseño experto. Mejora la siguiente descripción para un prompt de generación de imágenes. Sé creativo y visual.
            - NO uses placeholders como '%nombre%'.
            - Devuelve ÚNICAMENTE la descripción mejorada.
            ${p?`Considera esta instrucción adicional del usuario: '${p}'.`:""}`:this.aiModalContext==="behavior_prompt"?f=`Eres un experto en optimización de prompts de comportamiento para asistentes de IA conversacionales.

Tu tarea es MEJORAR el prompt de comportamiento proporcionado, NO reemplazarlo completamente.

**REGLAS CRÍTICAS:**
1. DEBES mantener TODA la estructura original del prompt (secciones, formato, ejemplos, etc.)
2. DEBES conservar TODO el contenido existente (identidad, reglas, procesos, ejemplos)
3. SOLO debes hacer mejoras incrementales basadas en las instrucciones del usuario
4. NO elimines secciones, ejemplos o información importante
5. NO cambies el formato o estructura a menos que el usuario lo solicite explícitamente
6. Si el usuario pide algo específico, incorpóralo sin eliminar el resto del contenido
7. Mantén la misma extensión y nivel de detalle del prompt original
8. Conserva todos los ejemplos (FEW-SHOT_LEARNING) y casos de uso

**INSTRUCCIONES DEL USUARIO:**
${p?`El usuario quiere: "${p}"`:"Mejora general del prompt manteniendo todo el contenido."}

**PROMPT ORIGINAL A MEJORAR:**
[El prompt completo se enviará a continuación]

**IMPORTANTE:** 
- Devuelve el prompt COMPLETO mejorado, no solo las partes que cambiaste
- Mantén todas las secciones: CORE_IDENTITY, KNOWLEDGE_BASE, RULES, PROCESS, OUTPUT_FORMAT, FEW-SHOT_LEARNING
- Si agregas algo nuevo, intégralo en la sección correspondiente sin eliminar lo existente
- Si el prompt original tiene 1000 palabras, el mejorado debe tener al menos 900-1100 palabras
- Si el usuario solo pide un cambio pequeño, haz ese cambio específico pero mantén TODO lo demás intacto
- NUNCA devuelvas solo un resumen o versión corta del prompt original
- El resultado debe ser un prompt completo y funcional, no un resumen`:f=`Eres un asistente de marketing experto en WhatsApp. Reescribe el siguiente texto para que sea más efectivo y profesional, manteniendo el tono y la intención original.
            - El único placeholder permitido es '%nombre%'. Mantenlo exactamente como está. NO inventes otros placeholders como '%empresa%'.
            - NO añadas saludos, despedidas, ni firmes con "[Tu Nombre]", etc. Devuelve ÚNICamente el texto mejorado.
            ${p?`Considera esta instrucción adicional del usuario: '${p}'.`:""}`;try{const{data:T,error:z}=await window.auth.invokeFunction("openai-proxy",{body:{type:"text",prompt:f,text:u,userId:this.user.id}});if(z)throw z;const H=await this.loadUserUsage(),N=((L=(await this.loadUserSubscription()).plans)==null?void 0:L.ai_enhancements_limit)||0,G=(H==null?void 0:H.ai_enhancements_used)||0;document.getElementById("ai-uses-left").textContent=`${N-G}/${N}`;const be=document.getElementById("ai-result-container");be.textContent=T.result||"La IA no devolvió un resultado válido.",be.classList.remove("hidden"),n.classList.add("hidden"),document.getElementById("apply-ai-btn").classList.remove("hidden"),document.getElementById("regenerate-ai-btn").classList.remove("hidden")}catch(T){/limit/i.test(T.message)||window.showToast("No se pudo generar la mejora. Revisa la consola.","error")}finally{a.disabled=!1,a.textContent=t?"Reintentar":"Mejorar Texto"}}handleApplyAi(){const t=document.getElementById("ai-result-container").textContent;this.aiModalCallback&&this.aiModalCallback(t),this.closeAiModal()}}class Yt{constructor(t){var a;this.app=t,this.iti=null,this.currentStep=1,this.totalSteps=4,this.modal=document.getElementById("wizard-modal"),this.prevBtn=document.getElementById("wizard-prev-btn"),this.nextBtn=document.getElementById("wizard-next-btn"),this.finishBtn=document.getElementById("wizard-finish-btn"),this.closeBtn=document.getElementById("close-wizard-btn"),this.stepIndicator=document.getElementById("wizard-step-indicator"),this.companyForm=document.getElementById("wizard-company-form"),this.qaForm=((a=this.modal)==null?void 0:a.querySelector("#wizard-qa-form"))||null,this.qrContainer=document.getElementById("wizard-qr-container"),this.requestQrBtn=document.getElementById("wizard-request-qr-btn"),this.syncContactsBtn=document.getElementById("wizard-sync-contacts-btn"),this.companySnapshot=null,this.setupListeners()}setupListeners(){var t,a,n,u;this.prevBtn.addEventListener("click",()=>this.changeStep(-1)),this.nextBtn.addEventListener("click",()=>this.changeStep(1)),this.finishBtn.addEventListener("click",()=>this.finish()),this.closeBtn.addEventListener("click",()=>this.hide()),(t=this.requestQrBtn)==null||t.addEventListener("click",()=>this.app.checkWhatsappConnection(!0)),(a=this.syncContactsBtn)==null||a.addEventListener("click",()=>this.handleSyncClick()),(n=this.modal.querySelector("#wizard-upload-logo-btn"))==null||n.addEventListener("click",()=>this.modal.querySelector("#wizard-logo-input").click()),(u=this.modal.querySelector("#wizard-logo-input"))==null||u.addEventListener("change",p=>this.previewLogo(p.target.files[0]))}start(t=!1){this.currentStep=t?4:1,this.updateStepUI(),t||this.loadExistingCompanySettings(),this.modal.classList.remove("hidden"),document.body.classList.add("overflow-hidden")}hide(){this.modal.classList.add("hidden"),document.body.classList.remove("overflow-hidden")}changeStep(t){if(this.currentStep===3&&t>0){this.handleSettingsSave();return}const a=this.currentStep+t;a>=1&&a<=this.totalSteps&&(this.currentStep=a,this.updateStepUI())}updateStepUI(){this.modal.querySelectorAll(".wizard-step").forEach(a=>a.classList.add("hidden"));const t=document.getElementById(`wizard-step-${this.currentStep}`);t&&t.classList.remove("hidden"),this.prevBtn.disabled=this.currentStep===1,this.nextBtn.classList.toggle("hidden",this.currentStep>=this.totalSteps),this.finishBtn.classList.toggle("hidden",this.currentStep!==this.totalSteps),this.currentStep===3?this.nextBtn.innerHTML="Guardar y Seguir":this.nextBtn.innerHTML="Siguiente",this.stepIndicator.textContent=`Paso ${this.currentStep} de ${this.totalSteps}`}previewLogo(t){if(!t||!this.modal)return;const a=this.modal.querySelector("#wizard-logo-preview"),n=new FileReader;n.onload=u=>{a.src=u.target.result},n.readAsDataURL(t)}async loadExistingCompanySettings(){var t,a;try{if(!this.companyForm)return;const{data:n,error:u}=await window.auth.sb.from("profiles").select("work_start_hour, work_end_hour, company_description, website, social_media, branding_settings, contact_phone").single();if(u&&u.code!=="PGRST116")throw u;if(!n)return;this.companySnapshot={work_start_hour:n.work_start_hour??null,work_end_hour:n.work_end_hour??null,company_description:n.company_description??"",website:n.website??"",social_media:n.social_media??{},branding_settings:n.branding_settings??{},contact_phone:n.contact_phone??null},n.work_start_hour&&(this.companyForm.querySelector("#wizard-work-start-hour").value=`${String(n.work_start_hour).padStart(2,"0")}:00`),n.work_end_hour&&(this.companyForm.querySelector("#wizard-work-end-hour").value=`${String(n.work_end_hour).padStart(2,"0")}:00`),n.company_description&&(this.companyForm.querySelector("#wizard-company-description").value=n.company_description),n.website&&(this.companyForm.querySelector("#wizard-website").value=n.website),n.social_media&&(this.companyForm.querySelector("#wizard-social-instagram").value=n.social_media.instagram||"",this.companyForm.querySelector("#wizard-social-facebook").value=n.social_media.facebook||""),(t=n.branding_settings)!=null&&t.logo_url&&(this.companyForm.querySelector("#wizard-logo-preview").src=n.branding_settings.logo_url),(a=n.branding_settings)!=null&&a.colors&&n.branding_settings.colors.forEach((p,f)=>{const L=this.companyForm.querySelector(`#wizard-brand-color-${f+1}`);L&&(L.value=p)}),n.contact_phone&&this.iti&&this.iti.setNumber(n.contact_phone)}catch(n){console.error("Error al precargar datos de la empresa en el wizard:",n)}}async handleSettingsSave(){var t;this.nextBtn.disabled=!0,this.nextBtn.innerHTML='<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';try{const a=this.companyForm.querySelector("#wizard-logo-input").files[0];let n=(t=this.companyForm.querySelector("#wizard-logo-preview"))==null?void 0:t.src;a&&(n=await this.app.uploadAsset(a,"logos"));const u={logo_url:n.startsWith("https")?n:null,colors:Array.from({length:4},(H,N)=>this.companyForm.querySelector(`#wizard-brand-color-${N+1}`).value)},p=this.companyForm.querySelector("#wizard-work-start-hour").value,f=this.companyForm.querySelector("#wizard-work-end-hour").value,L=this.companyForm.querySelector("#wizard-admin-phone-input").value.trim()||null,T={work_start_hour:p?parseInt(p.split(":")[0]):null,work_end_hour:f?parseInt(f.split(":")[0]):null,company_description:this.companyForm.querySelector("#wizard-company-description").value,website:this.companyForm.querySelector("#wizard-website").value,social_media:{instagram:this.companyForm.querySelector("#wizard-social-instagram").value,facebook:this.companyForm.querySelector("#wizard-social-facebook").value},contact_phone:L,branding_settings:u},{error:z}=await window.auth.sb.from("profiles").update(T).eq("id",this.app.user.id);if(z)throw z;this.companySnapshot={...T,branding_settings:u},window.showToast("Información de la empresa guardada.","success"),this.currentStep++,this.updateStepUI()}catch(a){console.error("Error al guardar configuración desde el wizard:",a),window.showToast("No se pudo guardar la información de la empresa.","error")}finally{this.nextBtn.disabled=!1,this.nextBtn.innerHTML="Guardar y Seguir"}}async handleSyncClick(){const t=this.syncContactsBtn;if(!t||t.disabled)return;const a=t.innerHTML;t.disabled=!0,t.innerHTML='<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>';try{const n=this.app.user.id;if(!(await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/sync-labels-final",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:n})})).ok)throw new Error("La solicitud al webhook de sincronización falló.");window.showToast("Sincronización iniciada. Esto puede tardar unos minutos.","info"),setTimeout(()=>{t.disabled=!1,t.innerHTML=a},6e4)}catch(n){console.error("Error al iniciar la sincronización desde el wizard:",n),window.showToast("No se pudo iniciar la sincronización.","error"),t.disabled=!1,t.innerHTML=a}}async finish(){var t;this.modal.querySelectorAll(".wizard-step").forEach(a=>a.classList.add("hidden")),document.getElementById("wizard-step-5").classList.remove("hidden"),document.getElementById("wizard-loading").classList.remove("hidden"),document.getElementById("wizard-success").classList.add("hidden"),this.prevBtn.parentElement.classList.add("hidden");try{const a=this.qaForm||((t=this.modal)==null?void 0:t.querySelector("#wizard-qa-form"));if(!a)throw new Error("No se encontro el formulario de preguntas del wizard.");const n=new FormData(a),u=Object.fromEntries(n.entries()),p=this.buildPromptFromAnswers(u),f=document.getElementById("ai-master-prompt");f.value=p,await this.app.handlePromptSave(new Event("submit",{cancelable:!0})),document.getElementById("wizard-loading").classList.add("hidden"),document.getElementById("wizard-success").classList.remove("hidden"),setTimeout(()=>this.hide(),4e3)}catch(a){console.error("Error al finalizar el wizard:",a),window.showToast("No se pudo generar el prompt. Inténtalo de nuevo.","error"),this.currentStep=4,this.updateStepUI(),this.prevBtn.parentElement.classList.remove("hidden")}}buildPromptFromAnswers(t){var b,j;const a=O=>(O||"").trim(),n=a(t.negocio);a(t.cliente);const u=a(t.problema),p=a(t.diferenciador),f=a(t.tono)||"amigable, profesional y proactivo",L=a(t.no_hacer),T=a(t.precios),z=a(t.info_prospecto),H=a(t.info_adicional),N=this.companySnapshot||{};a(N.company_description);const G=a(N.website),be=a(N.contact_phone),he=a((b=N.social_media)==null?void 0:b.instagram),X=a((j=N.social_media)==null?void 0:j.facebook),ce=typeof N.work_start_hour=="number"?N.work_start_hour:null,W=typeof N.work_end_hour=="number"?N.work_end_hour:null,J=n?`Eres el asistente principal de WhatsApp para ${n}.`:"Eres un asistente virtual de WhatsApp enfocado en ventas, soporte y retencion.",Y=u?`Tu objetivo es resolver la necesidad principal del cliente: ${u}.`:"Tu objetivo es guiar, asesorar y convertir conversaciones de WhatsApp en oportunidades de negocio.",A=`Tu tono debe ser ${f}.`,M=H?"Basa tus respuestas en el contexto proporcionado por el negocio y en los datos que recibas en la conversacion. Si algo no esta en el contexto, puedes apoyarte en tu conocimiento general, pero debes indicarlo explicitamente.":"Debes basar TODAS tus respuestas unicamente en la informacion proporcionada por el usuario y en los datos recopilados durante la conversacion. Si no tienes un dato, solicita confirmacion.",_=["Redacta mensajes breves, claros y pensados para WhatsApp; separa ideas con lineas en blanco.",`Manten el tono descrito en CORE_IDENTITY en cada mensaje (${f}).`];z?_.push(`Cuando hables con nuevos prospectos, intenta obtener: ${z}.`):_.push("Cuando recibas un posible prospecto, formula preguntas para conocer necesidad, presupuesto y forma de contacto."),T&&_.push(`Sigue estas pautas cuando consulten precios: ${T}.`),ce!==null&&W!==null&&_.push(`Respeta el horario de atencion: ${ce}:00 a ${W}:00 hora local. Si escriben fuera de horario, agenda seguimiento.`),be&&_.push(`Cuando sea necesario escalar, ofrece el numero directo ${be} o agenda una llamada.`);const R=["No inventes precios, promociones ni compromisos si no fueron confirmados.","No compartas informacion confidencial o interna que el negocio no haya autorizado.","No olvides indicar cuando necesitas que un humano continúe la conversacion."];L&&L.split(/[\n.;]+/g).map(ee=>a(ee)).filter(Boolean).forEach(ee=>{const ae=ee.toLowerCase().startsWith("no")?ee:`No ${ee}`;R.push(ae)});const y=["Analizar: identifica la intencion principal del mensaje (venta, soporte, seguimiento o small talk).","Consultar: repasa la base de conocimiento interna del negocio y la informacion recopilada en la conversacion."];T?y.push("Formular: responde siguiendo las reglas de tono, precios y objetivos del negocio. Ofrece valor y menciona diferenciales cuando sea oportuno."):y.push("Formular: responde siguiendo las reglas de tono y objetivos del negocio. Ofrece valor y menciona diferenciales cuando sea oportuno."),y.push("Verificar: antes de enviar, confirma que cumples todas las reglas DO y DON'T, y agrega una pregunta de seguimiento cuando corresponda.");const m=["Usa texto plano con parrafos de maximo 2 oraciones cada uno. Separa parrafos con una linea en blanco.","Incluye bullets simples (-) solo cuando enumeres opciones o pasos.","Cierra con una pregunta o un siguiente paso claro para mantener la conversacion viva.","Utiliza emojis solo cuando aporten cercania sin afectar la claridad."],w="Hola, vi su anuncio y quiero saber en que pueden ayudarme.",l=[];l.push("Hola, gracias por escribirnos. "+(n||"Estamos aqui para ayudarte a obtener resultados concretos.")),p&&l.push(`Nos destacamos porque ${p}.`),l.push(z?`Te parece si me cuentas ${z.toLowerCase()}?`:"Te parece si me cuentas que servicio buscas y que objetivo tienes?");const e=l.join(" "),s="Cuanto cuesta su servicio principal?",i=[];T?i.push(T):i.push("Nuestros precios varian segun el alcance. Prefiero entender tu caso para darte una propuesta justa."),i.push(z?`Podrias compartir ${z.toLowerCase()}?`:"Me cuentas que necesitas y en que plazo para prepararte una propuesta?");const h=i.join(" "),x="Necesito un descuento grande, hazlo ya.",B="Claro, te doy 50% de descuento ahora mismo.",se=L?`Quiero apoyarte, pero ${L}. Puedo revisar alternativas con nuestro equipo si me das tus datos.`:"Quiero apoyarte, pero no puedo aprobar descuentos sin validar internamente. Puedo llevar tu caso con un asesor si me compartes tus datos.",C=[];if(C.push("# INICIO DE INSTRUCCIONES DE SISTEMA"),C.push(""),C.push("## 1. CORE_IDENTITY (Identidad y Rol)"),C.push(`**Rol:** ${J}`),C.push(`**Proposito Principal:** ${Y}`),C.push(`**Personalidad/Tono:** ${A}`),C.push(""),C.push("## 2. KNOWLEDGE_BASE (Base de Conocimiento)"),C.push(`**Alcance:** ${M}`),G||he||X){const O=[];G&&O.push(`Sitio web: ${G}`),he&&O.push(`Instagram: ${he}`),X&&O.push(`Facebook: ${X}`),C.push(`**Fuentes de referencia disponibles:** ${O.join(" | ")}`)}return C.push(""),C.push("## 3. RULES (Reglas y Restricciones)"),C.push("**Reglas Obligatorias (DO):**"),_.forEach(O=>C.push(`* ${O}`)),C.push("**Restricciones (DON'T):**"),R.forEach(O=>C.push(`* ${O}`)),C.push(""),C.push("## 4. PROCESS (Pasos a Seguir)"),C.push("**Al recibir una consulta del usuario, sigue estos pasos:**"),y.forEach((O,ee)=>C.push(`${ee+1}. ${O}`)),C.push(""),C.push("## 5. OUTPUT_FORMAT (Formato de Salida)"),C.push("**Estructura de Respuesta:**"),m.forEach(O=>C.push(`* ${O}`)),C.push(""),C.push("## 6. FEW-SHOT_LEARNING (Ejemplos de Comportamiento)"),C.push("**Ejemplo 1 (Bueno):**"),C.push(`* **Usuario:** "${w}"`),C.push(`* **Asistente:** "${e}"`),C.push(""),C.push("**Ejemplo 2 (Bueno):**"),C.push(`* **Usuario:** "${s}"`),C.push(`* **Asistente:** "${h}"`),C.push(""),C.push("**Ejemplo 3 (Malo - Que evitar):**"),C.push(`* **Usuario:** "${x}"`),C.push(`* **Asistente (Incorrecto):** "${B}"`),C.push(`* **Asistente (Correcto):** "${se}"`),C.push(""),C.push("## 7. CONTEXT_AWARENESS (Conciencia de Contexto)"),C.push("**Reglas de Memoria Conversacional:**"),C.push(""),C.push("1. **NO REPITAS PREGUNTAS:**"),C.push("   - Si el cliente ya mencionó una cantidad, NO preguntes de nuevo"),C.push("   - Si el cliente ya mencionó una marca, NO preguntes de nuevo"),C.push("   - Si el cliente ya mencionó un modelo, NO preguntes de nuevo"),C.push('   - Si el cliente ya mencionó un producto, NO preguntes "¿qué producto necesitas?"'),C.push(""),C.push("2. **REVISA EL HISTORIAL COMPLETO:**"),C.push("   - Antes de hacer cualquier pregunta, revisa TODO el historial de la conversación"),C.push("   - Identifica qué información YA tienes"),C.push("   - Identifica qué información FALTA"),C.push("   - Usa la información del historial para evitar redundancias"),C.push(""),C.push("3. **PREGUNTA SOLO LO NECESARIO:**"),C.push("   - Si tienes producto + cantidad + marca → Procede directamente"),C.push("   - Si falta información crítica → Pregunta SOLO por lo que falta"),C.push("   - Si tienes suficiente → Ofrece agregar al carrito o generar cotización"),C.push(""),C.push("4. **CONFIRMACIÓN INTELIGENTE:**"),C.push("   - En lugar de preguntar de nuevo, confirma lo que entendiste:"),C.push('   - ❌ "¿Cuántas piezas necesitas?" (si ya lo dijo)'),C.push('   - ✅ "Perfecto, 3 piezas de CE285A para HP. ¿Algo más?"'),C.push(""),C.push("5. **PROACTIVIDAD:**"),C.push("   - Si detectas intención de compra clara, ofrece directamente:"),C.push('   - "¿Quieres que prepare tu cotización ahora?"'),C.push('   - "¿Te agrego esto a tu pedido?"'),C.push(""),C.push("6. **MENSAJES CONCISOS:**"),C.push("   - Evita escribir párrafos largos cuando una frase corta es suficiente"),C.push('   - Si el cliente pregunta "precio", responde directamente con el precio, no con un párrafo explicativo'),C.push("   - Mantén las respuestas relevantes y al punto"),C.join(`
`)}}yt.prototype.renderWhatsappConnection=function(Be,t=null,a=null){const n={el:document.getElementById("whatsapp-connection-container"),btn:document.getElementById("request-qr-btn")},u={el:document.getElementById("wizard-qr-container"),btn:document.getElementById("wizard-request-qr-btn")},p=[n];u.el&&!document.getElementById("wizard-modal").classList.contains("hidden")&&p.push(u),p.forEach(f=>{if(!f.el)return;let L="";switch(Be){case"connected":L='<div class="flex flex-col items-center justify-center text-green-600 py-4"><i data-lucide="check-circle" class="w-16 h-16"></i><p class="font-bold mt-2">¡Conectado!</p></div>',f.btn&&(f.btn.style.display="none");break;case"loading":L='<div class="flex justify-center items-center min-h-[200px]"><div class="animate-spin rounded-full h-16 w-16 border-b-2 border-slate-900"></div></div>',f.btn&&(f.btn.style.display="block");break;case"qr":L=`<img src="data:image/png;base64,${t}" alt="Escanea para conectar WhatsApp" class="mx-auto max-w-full h-auto rounded-lg">`,f.btn&&(f.btn.style.display="block");break;case"error":L='<div class="flex flex-col items-center justify-center text-red-500 py-4"><i data-lucide="alert-triangle" class="w-16 h-16"></i><p class="font-bold mt-2">Error de Conexión</p></div>',f.btn&&(f.btn.style.display="block");break;case"initial":default:L='<div class="flex flex-col items-center justify-center text-slate-400 py-4"><i data-lucide="qr-code" class="w-16 h-16"></i><p class="font-bold mt-2">Solicita el QR para vincular</p></div>',f.btn&&(f.btn.style.display="block");break}f.el.innerHTML=L}),lucide.createIcons()};yt.prototype.checkWhatsappConnection=async function(Be=!1,t=null){const a=document.getElementById("wizard-modal"),u=a&&!a.classList.contains("hidden")?"wizard-qr-container":null;this.renderWhatsappConnection("loading",null,u);const p=`${this.config.N8N_URL}/webhook/generate-whatsapp-qr-Elina`;try{const f=await fetch(p,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:this.user.email})});if(!f.ok)throw new Error("El servidor N8N no responde correctamente.");const L=await f.text(),T=L.trim();if(!T){this.renderWhatsappConnection("connected",null,u);return}let z;try{z=JSON.parse(T)}catch(G){console.warn("Respuesta QR inesperada, se esperaba JSON.",G,L),this.renderWhatsappConnection("error",null,u);return}const H=Array.isArray(z)?z[0]:z,N=H!=null&&H.qr_image_data?"qr":"connected";this.renderWhatsappConnection(N,H==null?void 0:H.qr_image_data,u)}catch(f){console.error("Error al solicitar QR:",f),this.renderWhatsappConnection("error",null,u)}};
