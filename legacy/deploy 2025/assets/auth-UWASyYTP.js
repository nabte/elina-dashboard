(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const e of t)if(e.type==="childList")for(const o of e.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function r(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?e.credentials="include":t.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function s(t){if(t.ep)return;t.ep=!0;const e=r(t);fetch(t.href,e)}})();const p="https://mytvwfbijlgbihlegmfg.supabase.co",g="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15dHZ3ZmJpamxnYmlobGVnbWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MTg5OTAsImV4cCI6MjA2OTk5NDk5MH0.eFL6N7pR4nmpOLywRwxZS_sEWwSbq5WGAnY0zBMreDE",w=`${p}/functions/v1`;function y(){let i=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),n=localStorage.getItem("superadmin_session_tokens");const r=new Set(["/","/index","/index.html","/forgot-password.html","/reset-password.html"]),s=(()=>{const a=window.location.pathname||"/",[c]=a.split("?"),d=c.replace(/\/+$/,"")||"/";return d===""?"/":d})(),t=r.has(s);let e={},o=null;if(n)try{o=JSON.parse(n)}catch(a){console.warn("[auth] Tokens de superadmin corruptos. Se eliminan.",a),localStorage.removeItem("superadmin_session_tokens")}return i&&(!o||!o.access_token||!o.refresh_token||t)&&(localStorage.removeItem("impersonated_user_info"),i=null),t&&n&&(localStorage.removeItem("superadmin_session_tokens"),n=null,o=null),!t&&i&&(o!=null&&o.access_token)&&(o!=null&&o.refresh_token)&&(console.log(`Modo suplantaci칩n activo. Actuando como: ${i.id}`),e={global:{headers:{"X-Impersonated-User-ID":i.id}}}),window.supabase.createClient(p,g,e)}window.auth={sb:y(),session:null,async invokeFunction(i,{method:n="POST",body:r,headers:s={},signal:t}={}){var h;const e={Accept:"application/json",apikey:g,...s};let o;r!==void 0&&(r instanceof FormData||r instanceof Blob?o=r:typeof r=="string"?(o=r,e["Content-Type"]||(e["Content-Type"]="application/json")):(o=JSON.stringify(r),e["Content-Type"]||(e["Content-Type"]="application/json")));const{data:a,error:c}=await this.sb.auth.getSession();c&&console.error("[invokeFunction] Error obteniendo la sesion actual:",c);const d=(h=a==null?void 0:a.session)==null?void 0:h.access_token;d&&(e.Authorization=`Bearer ${d}`);const u=await fetch(`${w}/${i}`,{method:n,headers:e,body:n==="GET"||n==="HEAD"?void 0:o,signal:t}),m=await u.text();let l=null;if(m)try{l=JSON.parse(m)}catch{l=m}return u.ok?{data:l,error:null}:{data:null,error:{message:(l&&typeof l=="object"?l.error||l.message:null)||`Function ${i} respondio con estado ${u.status}`,status:u.status,details:l}}},handleAuthStateChange(i,n){this.session=n;const r=window.location.pathname.endsWith("/")||window.location.pathname.endsWith("/index.html");if(n&&r){this.sb.from("profiles").select("role").eq("id",n.user.id).single().then(({data:s,error:t})=>{if(s&&s.role==="superadmin"){window.location.href="/dashboard.html";return}this.sb.rpc("get_user_team_info").then(({data:e,error:o})=>{if(o){console.error("Error fetching team info:",o),window.location.href="/dashboard.html";return}const a=(e==null?void 0:e.user_role)||(e==null?void 0:e.role);e&&a==="admin"&&console.log("Usuario es admin de empresa, pero redirigiendo a dashboard por seguridad"),window.location.href="/dashboard.html"})}).catch(s=>{console.error("Error checking profile:",s),window.location.href="/dashboard.html"});return}if(!n&&!r){window.location.href="/";return}document.dispatchEvent(new CustomEvent("auth:ready",{detail:{session:n}}))},getSession(){return this.session},async handleLogin(i){var t,e;i.preventDefault();const n=i.target,r=(t=document.getElementById("login-email"))==null?void 0:t.value,s=(e=document.getElementById("login-password"))==null?void 0:e.value;this.setLoadingState(n,!0,"Verificando...");try{if(!r||!s)throw new Error("Credenciales incompletas");const{error:o}=await this.sb.auth.signInWithPassword({email:r,password:s});if(o)throw o}catch(o){const a=o.message==="Invalid login credentials"?"Correo o contrase침a incorrectos.":o.message;this.setLoadingState(n,!1,"Iniciar Sesi칩n",a)}},async handleRegister(i){var o,a,c,d;i.preventDefault();const n=i.target,r=(o=document.getElementById("register-email"))==null?void 0:o.value,s=(a=document.getElementById("register-password"))==null?void 0:a.value,t=(c=document.getElementById("register-name"))==null?void 0:c.value,e=window.iti?window.iti.getNumber():(d=document.getElementById("register-phone"))==null?void 0:d.value;this.setLoadingState(n,!0,"Creando...");try{if(!r||!s||!t||!e)throw new Error("Todos los campos son obligatorios.");const{data:u,error:m}=await this.sb.auth.signUp({email:r,password:s,options:{data:{full_name:t,phone:e}}});if(m)throw m;if(u.user){try{await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/volution-instance-create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nombre:t,email:r,telefono_admin:e,Passwr:s})})}catch(h){console.error("Error al llamar al webhook de n8n, pero el registro de usuario continu칩:",h)}n.style.display="none";const l=document.getElementById("register-success-message");l.classList.remove("hidden"),lucide.createIcons({nodes:[l.querySelector("i")]})}}catch(u){this.setLoadingState(n,!1,"Crear Cuenta",u.message)}},async handleLogout(){try{await this.sb.auth.signOut()}catch(i){console.error("[Logout Error]",i)}},setLoadingState(i,n,r,s=null){const t=i.querySelector('button[type="submit"]'),e=t.querySelector(".button-text"),o=t.querySelector(".loading-spinner"),a=document.getElementById("error-message"),c=document.getElementById("error-text");n?(t.disabled=!0,o.classList.remove("hidden"),e.textContent=r,a.style.display="none"):(t.disabled=!1,o.classList.add("hidden"),e.textContent=r,s?(c.textContent=s,a.style.display="flex",console.error("[Auth Error]",s)):a.style.display="none")}};window.auth.sb.auth.onAuthStateChange((i,n)=>{window.auth.handleAuthStateChange(i,n)});let f;window.showToast=(i,n="success",r=5e3)=>{const s=document.getElementById("toast-notification"),t=document.getElementById("toast-message"),e=document.getElementById("toast-icon");!s||!t||!e||(f&&clearTimeout(f),t.textContent=i,s.classList.remove("bg-green-500","bg-red-500","bg-blue-500"),s.classList.remove("translate-y-[150%]"),n==="success"?(s.classList.add("bg-green-500"),e.setAttribute("data-lucide","check-circle")):n==="error"?(s.classList.add("bg-red-500"),e.setAttribute("data-lucide","alert-circle")):(s.classList.add("bg-blue-500"),e.setAttribute("data-lucide","info")),lucide.createIcons(),s.classList.remove("hidden"),s.classList.remove("translate-x-[120%]"),f=setTimeout(()=>s.classList.add("translate-x-[120%]"),r))};
