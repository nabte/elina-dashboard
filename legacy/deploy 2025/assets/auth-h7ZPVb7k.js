(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))o(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const s of t.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function r(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function o(e){if(e.ep)return;e.ep=!0;const t=r(e);fetch(e.href,t)}})();const p="https://mytvwfbijlgbihlegmfg.supabase.co",g="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15dHZ3ZmJpamxnYmlobGVnbWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MTg5OTAsImV4cCI6MjA2OTk5NDk5MH0.eFL6N7pR4nmpOLywRwxZS_sEWwSbq5WGAnY0zBMreDE",w=`${p}/functions/v1`;function y(){let i=JSON.parse(localStorage.getItem("impersonated_user_info")||"null"),n=localStorage.getItem("superadmin_session_tokens");const r=new Set(["/","/index","/index.html","/forgot-password.html","/reset-password.html"]),o=(()=>{const a=window.location.pathname||"/",[d]=a.split("?"),u=d.replace(/\/+$/,"")||"/";return u===""?"/":u})(),e=r.has(o);let t={},s=null;if(n)try{s=JSON.parse(n)}catch(a){console.warn("[auth] Tokens de superadmin corruptos. Se eliminan.",a),localStorage.removeItem("superadmin_session_tokens")}return i&&(!s||!s.access_token||!s.refresh_token||e)&&(localStorage.removeItem("impersonated_user_info"),i=null),e&&n&&(localStorage.removeItem("superadmin_session_tokens"),n=null,s=null),!e&&i&&(s!=null&&s.access_token)&&(s!=null&&s.refresh_token)&&(console.log(`Modo suplantación activo. Actuando como: ${i.id}`),t={global:{headers:{"X-Impersonated-User-ID":i.id}}}),window.supabase.createClient(p,g,t)}window.auth={sb:y(),session:null,async invokeFunction(i,{method:n="POST",body:r,headers:o={},signal:e}={}){var m;const t={Accept:"application/json",apikey:g,...o};let s;r!==void 0&&(r instanceof FormData||r instanceof Blob?s=r:typeof r=="string"?(s=r,t["Content-Type"]||(t["Content-Type"]="application/json")):(s=JSON.stringify(r),t["Content-Type"]||(t["Content-Type"]="application/json")));const{data:a,error:d}=await this.sb.auth.getSession();d&&console.error("[invokeFunction] Error obteniendo la sesion actual:",d);const u=(m=a==null?void 0:a.session)==null?void 0:m.access_token;u&&(t.Authorization=`Bearer ${u}`);const l=await fetch(`${w}/${i}`,{method:n,headers:t,body:n==="GET"||n==="HEAD"?void 0:s,signal:e}),h=await l.text();let c=null;if(h)try{c=JSON.parse(h)}catch{c=h}return l.ok?{data:c,error:null}:{data:null,error:{message:(c&&typeof c=="object"?c.error||c.message:null)||`Function ${i} respondio con estado ${l.status}`,status:l.status,details:c}}},handleAuthStateChange(i,n){this.session=n;const r=window.location.pathname.endsWith("/")||window.location.pathname.endsWith("/index.html");if(n&&r){this.sb.rpc("get_user_team_info").then(({data:o,error:e})=>{if(e){console.error("Error fetching team info:",e),window.location.href="/dashboard.html";return}const t=(o==null?void 0:o.user_role)||(o==null?void 0:o.role);o&&t==="admin"?window.location.href="/company-admin.html":window.location.href="/dashboard.html"});return}if(!n&&!r){window.location.href="/";return}document.dispatchEvent(new CustomEvent("auth:ready",{detail:{session:n}}))},getSession(){return this.session},async handleLogin(i){var e,t;i.preventDefault();const n=i.target,r=(e=document.getElementById("login-email"))==null?void 0:e.value,o=(t=document.getElementById("login-password"))==null?void 0:t.value;this.setLoadingState(n,!0,"Verificando...");try{if(!r||!o)throw new Error("Credenciales incompletas");const{error:s}=await this.sb.auth.signInWithPassword({email:r,password:o});if(s)throw s}catch(s){const a=s.message==="Invalid login credentials"?"Correo o contraseña incorrectos.":s.message;this.setLoadingState(n,!1,"Iniciar Sesión",a)}},async handleRegister(i){var s,a,d,u;i.preventDefault();const n=i.target,r=(s=document.getElementById("register-email"))==null?void 0:s.value,o=(a=document.getElementById("register-password"))==null?void 0:a.value,e=(d=document.getElementById("register-name"))==null?void 0:d.value,t=window.iti?window.iti.getNumber():(u=document.getElementById("register-phone"))==null?void 0:u.value;this.setLoadingState(n,!0,"Creando...");try{if(!r||!o||!e||!t)throw new Error("Todos los campos son obligatorios.");const{data:l,error:h}=await this.sb.auth.signUp({email:r,password:o,options:{data:{full_name:e,phone:t}}});if(h)throw h;if(l.user){const c=new Date;c.setDate(c.getDate()+7);const{error:m}=await this.sb.from("subscriptions").insert({user_id:l.user.id,trial_ends_at:c.toISOString()});m&&console.error("Error creando la suscripción de prueba:",m)}if(l.user){try{await fetch("https://n8n-n8n.mcjhhb.easypanel.host/webhook/volution-instance-create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nombre:e,email:r,telefono_admin:t,Passwr:o})})}catch(m){console.error("Error al llamar al webhook de n8n, pero el registro de usuario continuó:",m)}n.style.display="none";const c=document.getElementById("register-success-message");c.classList.remove("hidden"),lucide.createIcons({nodes:[c.querySelector("i")]})}}catch(l){this.setLoadingState(n,!1,"Crear Cuenta",l.message)}},async handleLogout(){try{await this.sb.auth.signOut()}catch(i){console.error("[Logout Error]",i)}},setLoadingState(i,n,r,o=null){const e=i.querySelector('button[type="submit"]'),t=e.querySelector(".button-text"),s=e.querySelector(".loading-spinner"),a=document.getElementById("error-message"),d=document.getElementById("error-text");n?(e.disabled=!0,s.classList.remove("hidden"),t.textContent=r,a.style.display="none"):(e.disabled=!1,s.classList.add("hidden"),t.textContent=r,o?(d.textContent=o,a.style.display="flex",console.error("[Auth Error]",o)):a.style.display="none")}};window.auth.sb.auth.onAuthStateChange((i,n)=>{window.auth.handleAuthStateChange(i,n)});let f;window.showToast=(i,n="success",r=5e3)=>{const o=document.getElementById("toast-notification"),e=document.getElementById("toast-message"),t=document.getElementById("toast-icon");!o||!e||!t||(f&&clearTimeout(f),e.textContent=i,o.classList.remove("bg-green-500","bg-red-500","bg-blue-500"),o.classList.remove("translate-y-[150%]"),n==="success"?(o.classList.add("bg-green-500"),t.setAttribute("data-lucide","check-circle")):n==="error"?(o.classList.add("bg-red-500"),t.setAttribute("data-lucide","alert-circle")):(o.classList.add("bg-blue-500"),t.setAttribute("data-lucide","info")),lucide.createIcons(),o.classList.remove("hidden"),o.classList.remove("translate-x-[120%]"),f=setTimeout(()=>o.classList.add("translate-x-[120%]"),r))};
