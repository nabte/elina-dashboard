{"name":"agents/conversational.ts","content":"/**\r\n * ELINA V5 - Conversational Agent\r\n * \r\n * Agente conversacional principal usando OpenRouter con GPT-5-nano\r\n */\r\n\r\nimport type { SupabaseClient } from 'https://esm.sh/@supabase/supabase-js@2'\r\nimport type { AccountConfig, IntentDetectionResult, ConversationContext, AgentResponse, Message, ToolResult, ToolCall } from '../config/types.ts'\r\nimport { DEFAULT_MODEL, DEFAULT_TEMPERATURE, DEFAULT_MAX_TOKENS, OPENROUTER_API_URL } from '../config/constants.ts'\r\n\r\n/**\r\n * Ejecuta el agente conversacional\r\n */\r\nexport async function runConversationalAgent(\r\n    supabase: SupabaseClient,\r\n    config: AccountConfig,\r\n    userMessage: string,\r\n    intent: IntentDetectionResult,\r\n    context: ConversationContext,\r\n    toolCalls?: ToolCall[],     // ‚Üê Tool calls originales del assistant\r\n    toolResults?: ToolResult[]  // ‚Üê Resultados de herramientas ejecutadas\r\n): Promise<AgentResponse> {\r\n    console.log(`ü§ñ [AGENT] Running conversational agent`)\r\n    console.log(`   - Intent: ${intent.primary}`)\r\n    console.log(`   - Sentiment: ${intent.sentiment.polarity} (${intent.sentiment.score})`)\r\n\r\n    const startTime = performance.now()\r\n\r\n    // 1. Construir system prompt\r\n    const systemPrompt = await buildSystemPrompt(config, intent, context)\r\n\r\n    // 2. Preparar mensajes\r\n    const messages: any[] = [\r\n        { role: 'system', content: systemPrompt },\r\n        ...context.recentMessages.slice(-8), // √öltimos 8 mensajes para contexto\r\n        { role: 'user', content: userMessage }\r\n    ]\r\n\r\n    // Si hay tool calls y results, construir el flujo completo\r\n    if (toolCalls && toolCalls.length > 0 && toolResults && toolResults.length > 0) {\r\n        // Agregar el mensaje del assistant con tool_calls\r\n        messages.push({\r\n            role: 'assistant',\r\n            content: null,\r\n            tool_calls: toolCalls\r\n        })\r\n        // Agregar los resultados de las herramientas\r\n        messages.push(...toolResults)\r\n    }\r\n\r\n    // 3. Llamar a OpenRouter\r\n    const openrouterKey = Deno.env.get('OPENROUTER_API_KEY')\r\n    if (!openrouterKey) {\r\n        throw new Error('OPENROUTER_API_KEY not found in environment')\r\n    }\r\n\r\n    try {\r\n        const response = await fetch(OPENROUTER_API_URL, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Authorization': `Bearer ${openrouterKey}`,\r\n                'HTTP-Referer': 'https://elina.ai',\r\n                'X-Title': 'ELINA V5',\r\n                'Content-Type': 'application/json'\r\n            },\r\n            body: JSON.stringify({\r\n                model: config.model || DEFAULT_MODEL,\r\n                messages,  // Ya incluye tool results si existen\r\n                temperature: config.temperature || DEFAULT_TEMPERATURE,\r\n                max_tokens: config.maxTokens || DEFAULT_MAX_TOKENS,\r\n                // Tools solo en la primera llamada (cuando no hay toolResults)\r\n                ...(toolResults && toolResults.length > 0 ? {} : {\r\n                    tools: getAvailableTools(config, intent),\r\n                    tool_choice: 'auto'\r\n                })\r\n            })\r\n        })\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text()\r\n            throw new Error(`OpenRouter API error: ${response.status} ${response.statusText} - ${errorText}`)\r\n        }\r\n\r\n        const data = await response.json()\r\n        const duration = performance.now() - startTime\r\n\r\n        console.log(`‚úÖ [AGENT] Response generated in ${duration.toFixed(0)}ms`)\r\n        console.log(`   - Model: ${data.model || config.model}`)\r\n        console.log(`   - Tokens: ${data.usage?.total_tokens || 'unknown'}`)\r\n\r\n        // 4. Procesar respuesta\r\n        const choice = data.choices[0]\r\n\r\n        return {\r\n            text: choice.message.content || '',\r\n            toolCalls: choice.message.tool_calls || [],\r\n            metadata: {\r\n                model: data.model || config.model,\r\n                tokensUsed: data.usage?.total_tokens || 0,\r\n                finishReason: choice.finish_reason || 'stop',\r\n                duration\r\n            }\r\n        }\r\n    } catch (error) {\r\n        console.error(`‚ùå [AGENT] Error calling OpenRouter: ${error.message}`)\r\n        throw error\r\n    }\r\n}\r\n\r\n/**\r\n * Construye el system prompt din√°micamente\r\n */\r\nasync function buildSystemPrompt(\r\n    config: AccountConfig,\r\n    intent: IntentDetectionResult,\r\n    context: ConversationContext\r\n): Promise<string> {\r\n    let prompt = `Eres el asistente virtual de ${config.companyName}, un chatbot de ventas y atenci√≥n al cliente ${config.tone} y profesional.\r\n\r\n## Informaci√≥n de la Empresa\r\n${config.website ? `Sitio web: ${config.website}` : ''}\r\n${config.businessPhone ? `\\nTel√©fono: ${config.businessPhone}` : ''}\r\n${config.businessAddress ? `\\nDirecci√≥n: ${config.businessAddress}` : ''}\r\n`\r\n\r\n    // CR√çTICO: Solo incluir descripci√≥n de empresa si NO es consulta de productos\r\n    // Esto evita que el LLM invente productos bas√°ndose en la descripci√≥n\r\n    if (intent.primary !== 'product_inquiry') {\r\n        prompt += `\\n${config.companyDescription || 'Empresa dedicada a ofrecer productos y servicios de calidad.'}\r\n`\r\n    }\r\n\r\n    prompt += `\r\n## Tu Misi√≥n\r\n- Responder de forma natural y conversacional, como un humano por WhatsApp\r\n- Ser BREVE: m√°ximo 2-3 l√≠neas por mensaje (como un mensaje de texto real)\r\n- Ir directo al grano, sin rodeos ni explicaciones largas\r\n- Detectar las necesidades del cliente y ofrecer soluciones\r\n- Mantener un tono ${config.tone} pero casual\r\n- Usar emojis ocasionalmente (1-2 por mensaje m√°ximo) üòä\r\n- Si hay mucha info, dividir en mensajes cortos en lugar de un mensaje largo\r\n- Responder como si estuvieras chateando, no escribiendo un email\r\n\r\n## Capacidades Disponibles\r\n\r\n**IMPORTANTE: FECHA ACTUAL**\r\nHoy es: ${new Date().toLocaleString('es-MX', { timeZone: config.timezone || 'America/Mexico_City', weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}.\r\nUsa esta fecha como referencia absoluta para \"ma√±ana\", \"lunes\", etc.\r\n`\r\n\r\n    // REGLAS CR√çTICAS SOBRE PRODUCTOS\r\n    prompt += `\\nüö® **REGLAS CR√çTICAS SOBRE PRODUCTOS** üö®\\n`\r\n    prompt += `1. NUNCA respondas sobre productos sin usar la herramienta buscar_productos primero.\\n`\r\n    prompt += `2. NUNCA inventes productos, servicios o caracter√≠sticas bas√°ndote en la descripci√≥n de la empresa.\\n`\r\n    prompt += `3. Si el usuario pregunta \"qu√© vendes?\", \"qu√© productos tienes?\", \"qu√© manejas?\", etc., DEBES usar buscar_productos con query vac√≠a (\"\") para obtener el cat√°logo real.\\n`\r\n    prompt += `4. Si buscar_productos devuelve 0 resultados, significa que NO lo tenemos. Di: \"No manejo esa marca/modelo actualmente.\"\\n`\r\n    prompt += `5. NUNCA digas \"tengo otros modelos\" o \"puedo buscar otros\" si la b√∫squeda fall√≥.\\n`\r\n    prompt += `6. Solo menciona productos que REALMENTE encontraste con la herramienta.\\n`\r\n    prompt += `7. PROHIBIDO asumir que vendes algo solo porque est√° en la descripci√≥n de la empresa.\\n`\r\n\r\n    if (config.appointmentsEnabled) {\r\n        prompt += `‚úÖ **Citas**: Puedes consultar disponibilidad y agendar citas.\\n`\r\n    }\r\n\r\n    if (config.quotesEnabled) {\r\n        prompt += `‚úÖ **Cotizaciones**: Puedes generar cotizaciones en PDF cuando el cliente lo solicite.\\n`\r\n    }\r\n\r\n    if (config.hasShipping) {\r\n        prompt += `‚úÖ **Env√≠os**: Ofrecemos servicio de env√≠o a domicilio.\\n`\r\n    }\r\n\r\n    // Agregar contexto RAG si existe\r\n    if (context.ragContext) {\r\n        prompt += `\\n## Informaci√≥n Relevante de la Base de Conocimientos\\n${context.ragContext}\\n`\r\n    }\r\n\r\n    // Agregar aprendizajes de largo plazo\r\n    if (context.accountLearnings && context.accountLearnings.length > 0) {\r\n        prompt += `\\n## Aprendizajes Previos\\n`\r\n        context.accountLearnings.forEach(learning => {\r\n            prompt += `- ${learning.content}\\n`\r\n        })\r\n    }\r\n\r\n    // Agregar preferencias del usuario\r\n    if (context.userPreferences && context.userPreferences.length > 0) {\r\n        prompt += `\\n## Preferencias del Cliente\\n`\r\n        context.userPreferences.forEach(pref => {\r\n            prompt += `- ${pref.key}: ${pref.value}\\n`\r\n        })\r\n    }\r\n\r\n    // Agregar promociones activas\r\n    if (context.activePromotions && context.activePromotions.length > 0) {\r\n        prompt += `\\n## Promociones Activas\\n`\r\n        context.activePromotions.forEach(promo => {\r\n            prompt += `- **${promo.title}**: ${promo.description || ''}\\n`\r\n            if (promo.discount) prompt += `  Descuento: ${promo.discount}\\n`\r\n        })\r\n    }\r\n\r\n    // üî• PRODUCTOS MENCIONADOS RECIENTEMENTE (con FAQs para follow-up questions)\r\n    if (context.recentlyMentionedProducts && context.recentlyMentionedProducts.length > 0) {\r\n        const { formatCachedProductsForPrompt } = await import('../utils/product-cache.ts')\r\n        prompt += formatCachedProductsForPrompt(context.recentlyMentionedProducts)\r\n        prompt += `\\n**IMPORTANTE:** Si el cliente hace preguntas sobre estos productos (ej: \"¬øc√≥mo funciona?\", \"¬øes compatible?\"), usa la informaci√≥n de FAQs arriba. NO necesitas buscar de nuevo.\\n`\r\n    }\r\n\r\n    // Instrucciones espec√≠ficas seg√∫n intenci√≥n\r\n    if (intent.primary === 'product_inquiry') {\r\n        prompt += `\\n## üéØ ACCI√ìN REQUERIDA: CONSULTA DE PRODUCTOS\r\n\r\n**PASO 1 - OBLIGATORIO:** Usa la herramienta buscar_productos AHORA.\r\n- Si el usuario pregunta \"qu√© vendes?\", \"qu√© productos?\", \"qu√© tienes?\": usa query=\"\" (vac√≠o) para ver TODO el cat√°logo\r\n- Si pregunta por algo espec√≠fico (ej: \"migra√±a\", \"665\", \"105X\"): usa ese t√©rmino como query\r\n\r\n**PASO 2:** Bas√°ndote SOLO en los resultados de la herramienta:\r\n- Si encontraste productos: menciona usando placeholders (OPCIONAL):\r\n  * Nombre: [PRODUCT_NAME:ID] o el nombre directamente\r\n  * Precio: [PRODUCT_PRICE:ID] o el precio directamente\r\n  * Stock: [PRODUCT_STOCK:ID]\r\n  * Descripci√≥n: [PRODUCT_DESC:ID]\r\n- Si NO encontraste nada (0 resultados): di \"No manejo esa marca/modelo actualmente.\"\r\n- **üñºÔ∏è MEDIA**: NO necesitas mencionar [PRODUCT_MEDIA:ID] - el sistema env√≠a im√°genes/videos autom√°ticamente si el producto las tiene\r\n\r\n**EJEMPLOS:**\r\n- \"S√≠, tengo el [PRODUCT_NAME:123] por [PRODUCT_PRICE:123]\"\r\n- O simplemente: \"S√≠, tengo el HP 665 por $350. Hay 10 en stock\"\r\n\r\n‚Üí Si el producto tiene media_url, se enviar√° autom√°ticamente como imagen con tu texto como caption\r\n\r\n**üîé USO DE FAQs DE PRODUCTOS:**\r\n- La herramienta buscar_productos devuelve FAQs (preguntas frecuentes) para cada producto\r\n- Las FAQs contienen respuestas verificadas y espec√≠ficas sobre caracter√≠sticas, compatibilidad, uso, etc.\r\n- Si el cliente pregunta algo que est√° en las FAQs del producto, usa esa informaci√≥n para responder\r\n- Las FAQs son informaci√≥n CONFIABLE y REAL del producto\r\n- Ejemplo: Cliente: \"¬øEs compatible con Windows?\" ‚Üí Si hay FAQ que lo responde, √∫sala\r\n\r\n**PROHIBIDO:**\r\n‚ùå Responder sin usar la herramienta primero\r\n‚ùå Inventar productos bas√°ndote en la descripci√≥n de la empresa\r\n‚ùå Decir \"ofrecemos servicios en...\" sin verificar productos reales\r\n‚ùå Asumir que vendes algo solo porque suena l√≥gico\r\n‚ùå Enviar URLs de im√°genes manualmente (el sistema las env√≠a autom√°ticamente)\r\n`\r\n    }\r\n\r\n    if (intent.primary === 'appointment_request') {\r\n        prompt += `\\n## Contexto Actual\r\nEl cliente quiere agendar una cita.\r\nIMPORTANTE: \r\n1. PRIMERO usa consultar_disponibilidad para ver horarios disponibles.\r\n2. Si hay slots disponibles, mu√©stralos.\r\n3. CR√çTICO: Si el usuario elige un horario (ej: \"a las 3\", \"el de las 5\"), AGENDA INMEDIATAMENTE usando agendar_cita.\r\n4. NO preguntes \"¬øte gustar√≠a agendar?\" o \"¬øconfirmamos?\". HAZLO DIRECTAMENTE. Simplemente di: \"Listo, ha quedado agendada...\".\r\n5. Solo si el horario no es claro o no hay disponibilidad, pregunta.\r\n${context.appointmentSlots && context.appointmentSlots.length > 0 ? `\r\nHorarios disponibles:\r\n${context.appointmentSlots.map(s => `- ${s.date} a las ${s.time}`).join('\\n')}\r\n` : ''}\r\n`\r\n    }\r\n\r\n    if (intent.primary === 'complaint' || intent.primary === 'urgent_issue') {\r\n        prompt += `\\n## ALERTA: Intenci√≥n Cr√≠tica Detectada\r\nEl cliente tiene una queja o problema urgente. Responde con:\r\n1. Empat√≠a y disculpas sinceras\r\n2. Reconocimiento del problema\r\n3. Ofrecimiento de soluci√≥n inmediata\r\n4. Escalamiento a un humano si es necesario\r\n\r\nEjemplo: \"Lamento mucho escuchar eso üòî Entiendo tu frustraci√≥n y quiero ayudarte a resolver esto de inmediato. ¬øPodr√≠as darme m√°s detalles para poder asistirte mejor?\"\r\n`\r\n    }\r\n\r\n    // Prompt personalizado del usuario\r\n    if (config.customPrompt) {\r\n        prompt += `\\n## Instrucciones Adicionales del Negocio\\n${config.customPrompt}\\n`\r\n    }\r\n\r\n    // Reglas generales\r\n    prompt += `\\n## Reglas Importantes\r\n1. S√â BREVE: M√°ximo 2-3 l√≠neas, como un mensaje de WhatsApp real\r\n2. NUNCA inventes informaci√≥n que no tengas\r\n3. Si no sabes algo, adm√≠telo brevemente y ofrece alternativas\r\n4. Usa placeholders [PRODUCT_NAME:ID] para productos\r\n5. Responde como humano casual, no como robot formal\r\n6. Usa emojis con moderaci√≥n (1-2 m√°ximo)\r\n7. Si detectas venta, cierra con CTA breve y claro\r\n8. EVITA p√°rrafos largos - divide en mensajes cortos si es necesario\r\n`\r\n\r\n    return prompt\r\n}\r\n\r\n/**\r\n * Obtiene las herramientas disponibles seg√∫n configuraci√≥n\r\n */\r\nfunction getAvailableTools(config: AccountConfig, intent: IntentDetectionResult): any[] {\r\n    const tools: any[] = []\r\n\r\n    // Herramienta de b√∫squeda de productos\r\n    // SIEMPRE disponible si el usuario tiene productos, sin importar el intent\r\n    // El LLM decidir√° cu√°ndo usarla\r\n    if (config.hasProducts) {\r\n        tools.push({\r\n            type: 'function',\r\n            function: {\r\n                name: 'buscar_productos',\r\n                description: 'Busca productos en el cat√°logo bas√°ndose en una consulta de texto. √ösala cuando el cliente pregunte por productos, precios, SKUs, o qu√© vendes.',\r\n                parameters: {\r\n                    type: 'object',\r\n                    properties: {\r\n                        query: {\r\n                            type: 'string',\r\n                            description: 'Consulta de b√∫squeda (ej: \"zapatos deportivos\", \"laptop gaming\", \"105X\", \"migra√±a\")'\r\n                        },\r\n                        limit: {\r\n                            type: 'number',\r\n                            description: 'N√∫mero m√°ximo de resultados (default: 5)'\r\n                        }\r\n                    },\r\n                    required: ['query']\r\n                }\r\n            }\r\n        })\r\n    }\r\n\r\n    // Herramienta de agendamiento de citas\r\n    if (config.appointmentsEnabled && intent.primary === 'appointment_request') {\r\n        tools.push({\r\n            type: 'function',\r\n            function: {\r\n                name: 'agendar_cita',\r\n                description: 'Agenda una cita para el cliente',\r\n                parameters: {\r\n                    type: 'object',\r\n                    properties: {\r\n                        date: {\r\n                            type: 'string',\r\n                            description: 'Fecha de la cita (formato: YYYY-MM-DD)'\r\n                        },\r\n                        time: {\r\n                            type: 'string',\r\n                            description: 'Hora de la cita (formato: HH:MM)'\r\n                        },\r\n                        service_id: {\r\n                            type: 'number',\r\n                            description: 'ID del servicio (opcional)'\r\n                        },\r\n                        notes: {\r\n                            type: 'string',\r\n                            description: 'Notas adicionales (opcional)'\r\n                        }\r\n                    },\r\n                    required: ['date', 'time']\r\n                }\r\n            }\r\n        })\r\n\r\n        // Tool para consultar disponibilidad\r\n        tools.push({\r\n            type: 'function',\r\n            function: {\r\n                name: 'consultar_disponibilidad',\r\n                description: 'Consulta los horarios disponibles para una fecha espec√≠fica',\r\n                parameters: {\r\n                    type: 'object',\r\n                    properties: {\r\n                        date: {\r\n                            type: 'string',\r\n                            description: 'Fecha a consultar (formato: YYYY-MM-DD)'\r\n                        }\r\n                    },\r\n                    required: ['date']\r\n                }\r\n            }\r\n        })\r\n    }\r\n\r\n    return tools\r\n}\r\n"}