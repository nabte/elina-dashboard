{"name":"utils/product-cache.ts","content":"/**\r\n * ELINA V5 - Product Cache Manager\r\n *\r\n * Gestiona el cache de productos mencionados en conversaciones\r\n * para mantener FAQs y contexto disponible en follow-up questions\r\n */\r\n\r\nimport type { SupabaseClient } from 'https://esm.sh/@supabase/supabase-js@2'\r\nimport type { ProductWithFAQs } from '../config/types.ts'\r\n\r\n/**\r\n * Cachea productos mencionados en una conversaci√≥n\r\n */\r\nexport async function cacheProductsMentioned(\r\n    supabase: SupabaseClient,\r\n    userId: string,\r\n    contactId: number,\r\n    products: any[] // Productos retornados por buscar_productos\r\n): Promise<void> {\r\n    if (!products || products.length === 0) {\r\n        return\r\n    }\r\n\r\n    console.log(`üíæ [CACHE] Caching ${products.length} mentioned products for contact ${contactId}`)\r\n\r\n    try {\r\n        // Preparar datos para insertar\r\n        const cacheRecords = products.map(p => ({\r\n            user_id: userId,\r\n            contact_id: contactId,\r\n            product_id: p.id,\r\n            product_snapshot: {\r\n                id: p.id,\r\n                product_name: p.product_name,\r\n                price: p.price,\r\n                description: p.description,\r\n                enhanced_description: p.enhanced_description,\r\n                media_url: p.media_url,\r\n                faq: p.faq,\r\n                benefits: p.benefits,\r\n                usage_instructions: p.usage_instructions\r\n            },\r\n            mentioned_at: new Date().toISOString(),\r\n            last_accessed_at: new Date().toISOString()\r\n        }))\r\n\r\n        // Upsert: Si ya existe (user_id + contact_id + product_id), actualizar last_accessed_at\r\n        const { error } = await supabase\r\n            .from('conversation_product_cache')\r\n            .upsert(cacheRecords, {\r\n                onConflict: 'user_id,contact_id,product_id',\r\n                ignoreDuplicates: false\r\n            })\r\n\r\n        if (error) {\r\n            console.error(`‚ùå [CACHE] Error caching products: ${error.message}`)\r\n            // No lanzar error, esto no debe bloquear la conversaci√≥n\r\n        } else {\r\n            console.log(`‚úÖ [CACHE] Products cached successfully`)\r\n        }\r\n\r\n    } catch (error) {\r\n        console.error(`‚ùå [CACHE] Exception caching products: ${error.message}`)\r\n        // No lanzar error\r\n    }\r\n}\r\n\r\n/**\r\n * Obtiene productos mencionados recientemente en una conversaci√≥n\r\n */\r\nexport async function getRecentlyMentionedProducts(\r\n    supabase: SupabaseClient,\r\n    userId: string,\r\n    contactId: number,\r\n    limit: number = 5\r\n): Promise<ProductWithFAQs[]> {\r\n    console.log(`üì¶ [CACHE] Fetching recently mentioned products for contact ${contactId}`)\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from('conversation_product_cache')\r\n            .select('product_snapshot, mentioned_at, last_accessed_at')\r\n            .eq('user_id', userId)\r\n            .eq('contact_id', contactId)\r\n            .order('last_accessed_at', { ascending: false })\r\n            .limit(limit)\r\n\r\n        if (error) {\r\n            console.error(`‚ùå [CACHE] Error fetching cached products: ${error.message}`)\r\n            return []\r\n        }\r\n\r\n        if (!data || data.length === 0) {\r\n            console.log(`   - No cached products found`)\r\n            return []\r\n        }\r\n\r\n        // Mapear snapshots a ProductWithFAQs\r\n        const products: ProductWithFAQs[] = data.map((record: any) => {\r\n            const snapshot = record.product_snapshot\r\n\r\n            return {\r\n                id: snapshot.id,\r\n                productName: snapshot.product_name,\r\n                price: parseFloat(snapshot.price) || 0,\r\n                description: snapshot.description,\r\n                enhanced_description: snapshot.enhanced_description,\r\n                faq: snapshot.faq,\r\n                benefits: snapshot.benefits,\r\n                usage_instructions: snapshot.usage_instructions,\r\n                mentionedAt: new Date(record.mentioned_at)\r\n            }\r\n        })\r\n\r\n        console.log(`‚úÖ [CACHE] Found ${products.length} cached products`)\r\n        return products\r\n\r\n    } catch (error) {\r\n        console.error(`‚ùå [CACHE] Exception fetching cached products: ${error.message}`)\r\n        return []\r\n    }\r\n}\r\n\r\n/**\r\n * Formatea productos cacheados para incluir en el prompt del sistema\r\n */\r\nexport function formatCachedProductsForPrompt(products: ProductWithFAQs[]): string {\r\n    if (!products || products.length === 0) {\r\n        return ''\r\n    }\r\n\r\n    let formatted = `\\n## üì¶ Productos Mencionados Recientemente en esta Conversaci√≥n\\n`\r\n    formatted += `(√ösalos para responder preguntas de seguimiento sin necesidad de buscar de nuevo)\\n\\n`\r\n\r\n    for (const product of products) {\r\n        formatted += `### ${product.productName} (ID: ${product.id})\\n`\r\n        formatted += `- Precio: $${product.price}\\n`\r\n\r\n        // Usar enhanced_description si existe\r\n        const desc = product.enhanced_description || product.description\r\n        if (desc) {\r\n            formatted += `- Descripci√≥n: ${desc}\\n`\r\n        }\r\n\r\n        // Incluir benefits si existen\r\n        if (product.benefits) {\r\n            formatted += `- Beneficios: ${product.benefits}\\n`\r\n        }\r\n\r\n        // Incluir FAQs si existen\r\n        if (product.faq && Array.isArray(product.faq) && product.faq.length > 0) {\r\n            formatted += `- FAQs:\\n`\r\n            product.faq.forEach((item, idx) => {\r\n                formatted += `  ${idx + 1}. ${item.question}\\n`\r\n                formatted += `     ‚Üí ${item.answer}\\n`\r\n            })\r\n        }\r\n\r\n        formatted += `\\n`\r\n    }\r\n\r\n    return formatted\r\n}\r\n\r\n/**\r\n * Limpia cache antiguo (llamar peri√≥dicamente o en cron job)\r\n */\r\nexport async function cleanupOldCache(supabase: SupabaseClient): Promise<number> {\r\n    console.log(`üßπ [CACHE] Cleaning up old product cache`)\r\n\r\n    try {\r\n        const { error } = await supabase.rpc('cleanup_old_product_cache')\r\n\r\n        if (error) {\r\n            console.error(`‚ùå [CACHE] Error cleaning up cache: ${error.message}`)\r\n            return 0\r\n        }\r\n\r\n        console.log(`‚úÖ [CACHE] Old cache cleaned up successfully`)\r\n        return 1\r\n\r\n    } catch (error) {\r\n        console.error(`‚ùå [CACHE] Exception cleaning up cache: ${error.message}`)\r\n        return 0\r\n    }\r\n}\r\n"}