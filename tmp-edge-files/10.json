{"name":"utils/context-filter.ts","content":"/**\r\n * ELINA V5 - Context Filter\r\n * \r\n * Filtra mensajes antiguos para evitar alucinaciones con precios/citas viejas\r\n */\r\n\r\nimport type { Message } from '../config/types.ts'\r\n\r\n/**\r\n * Detecta si el mensaje actual es una nueva solicitud transaccional\r\n * (precio, cita, info) que debería invalidar el contexto anterior.\r\n */\r\nexport function isNewTransactionalRequest(message: string, history: Message[]): boolean {\r\n    const text = message.toLowerCase()\r\n\r\n    // Palabras clave de intención transaccional\r\n    const transactionalKeywords = [\r\n        'precio', 'costo', 'cuesta', 'cuanto', 'cuánto',\r\n        'cita', 'agenda', 'reservar', 'disponible', 'horario',\r\n        'info', 'información', 'detalles'\r\n    ]\r\n\r\n    const hasKeyword = transactionalKeywords.some(kw => text.includes(kw))\r\n\r\n    // Si no hay historial reciente, es una nueva solicitud\r\n    if (history.length === 0) return true\r\n\r\n    // Si pasaron más de 2 horas desde el último mensaje, es nueva sesión\r\n    const lastMsgTime = new Date(history[0].timestamp).getTime()\r\n    const now = Date.now()\r\n    const isSessionExpired = (now - lastMsgTime) > (2 * 60 * 60 * 1000)\r\n\r\n    return hasKeyword || isSessionExpired\r\n}\r\n\r\n/**\r\n * Filtra el contexto histórico para eliminar \"ruido\" transaccional viejo\r\n */\r\nexport function filterTransactionalContext(history: Message[], isNewRequest: boolean): Message[] {\r\n    if (!isNewRequest) return history\r\n\r\n    // Si es una nueva solicitud, filtramos mensajes viejos que contienen precios o citas\r\n    // para que el bot no se confunda con datos antiguos.\r\n    return history.filter(msg => {\r\n        const text = msg.content.toLowerCase()\r\n        const isOldQuote = text.includes('subtotal:') || text.includes('total:') || text.includes('$')\r\n        const isOldAppointment = text.includes('cita confirmada') || text.includes('reserva')\r\n\r\n        // Mantenemos solo mensajes conversacionales, no transaccionales viejos\r\n        return !isOldQuote && !isOldAppointment\r\n    })\r\n}\r\n"}