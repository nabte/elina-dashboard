{"name":"utils/placeholders.ts","content":"/**\r\n * ELINA V5 - Product Placeholders System\r\n * \r\n * Maneja el reemplazo de placeholders de productos y generación de cotizaciones\r\n * Basado en la lógica original de n8n V4\r\n */\r\n\r\nimport type { SupabaseClient } from 'https://esm.sh/@supabase/supabase-js@2'\r\nimport type { Product, QuoteItem, PlaceholderResult } from '../config/types.ts'\r\n\r\n/**\r\n * Procesa el texto del agente para reemplazar placeholders y detectar cotizaciones\r\n */\r\nexport async function processPlaceholders(\r\n    supabase: SupabaseClient,\r\n    userId: string,\r\n    text: string\r\n): Promise<PlaceholderResult> {\r\n    let finalText = text\r\n\r\n    // 1. Extraer IDs de productos\r\n    // Regex: Busca [CUALQUIER_COSA:NUMERO]\r\n    const placeholderRegex = /\\[[^\\]]*?(\\d+)\\]/g\r\n    const matches = [...text.matchAll(placeholderRegex)]\r\n    const productIds = [...new Set(matches.map(m => parseInt(m[1], 10)))].filter(id => !isNaN(id))\r\n\r\n    if (productIds.length === 0) {\r\n        return {\r\n            finalText,\r\n            productIds: [],\r\n            productsMap: {},\r\n            shouldGenerateQuote: false,\r\n            quoteItems: [],\r\n            productMedia: []\r\n        }\r\n    }\r\n\r\n    // 2. Obtener productos de la DB\r\n    const { data: products, error } = await supabase\r\n        .rpc('get_products_by_ids', {\r\n            p_user_id: userId,\r\n            p_product_ids: productIds\r\n        })\r\n\r\n    if (error || !products) {\r\n        console.error(`❌ [PLACEHOLDERS] Error fetching products: ${error?.message}`)\r\n        return {\r\n            finalText, // Devolver texto original si falla\r\n            productIds,\r\n            productsMap: {},\r\n            shouldGenerateQuote: false,\r\n            quoteItems: [],\r\n            productMedia: []\r\n        }\r\n    }\r\n\r\n    // Crear mapa de productos para búsqueda rápida\r\n    const productMap: Record<string, Product> = {}\r\n    products.forEach((p: any) => {\r\n        productMap[String(p.id)] = {\r\n            id: p.id,\r\n            productName: p.product_name,\r\n            price: Number(p.price),\r\n            stock: p.stock,\r\n            description: p.description,\r\n            mediaUrl: p.media_url,\r\n            productType: p.product_type\r\n        }\r\n    })\r\n\r\n    // 3. Reemplazar Placeholders Técnicos\r\n    const techRegex = /\\[PRODUCT_(\\w+):(\\d+)\\]/g\r\n    finalText = finalText.replace(techRegex, (fullMatch, field, idStr) => {\r\n        const product = productMap[idStr]\r\n        if (!product) return fullMatch\r\n\r\n        switch (field.toUpperCase()) {\r\n            case 'NAME': return product.productName\r\n            case 'PRICE': return `$${product.price.toFixed(2)}`\r\n            case 'URL': return '' // No mostrar URL en texto, se envía como media automáticamente\r\n            case 'MEDIA': return '' // No mostrar URL en texto, se envía como media automáticamente\r\n            case 'STOCK': return String(product.stock)\r\n            case 'DESC': return product.description || ''\r\n            default: return fullMatch\r\n        }\r\n    })\r\n\r\n    // 4. Limpiar Placeholders \"Sucios\" (IA hallucination: [105X:7305])\r\n    // Reemplaza [CUALQUIER_TEXTO:ID] por el nombre real del producto\r\n    const messRegex = /\\[([^\\]]+):(\\d+)\\]/g\r\n    finalText = finalText.replace(messRegex, (fullMatch, content, idStr) => {\r\n        const product = productMap[idStr]\r\n        if (!product) return fullMatch\r\n\r\n        // Si es un placeholder técnico ya procesado (o que parezca uno), ignorarlo\r\n        if (content.startsWith('PRODUCT_')) return fullMatch\r\n\r\n        return product.productName\r\n    })\r\n\r\n    // 5. Detectar necesidad de cotización\r\n    const shouldGenerateQuote = detectQuoteNeed(text, productIds.length)\r\n\r\n    // 6. Generar items de cotización si es necesario\r\n    const quoteItems: QuoteItem[] = []\r\n    if (shouldGenerateQuote) {\r\n        // Extraer cantidades del texto (simple heuristic)\r\n        // Busca patrones como \"2 unidades de [PROD:123]\" o \"x3 [PROD:123]\"\r\n        // Esta es una simplificación, la lógica real puede ser más compleja\r\n        productIds.forEach(id => {\r\n            const product = productMap[String(id)]\r\n            if (product) {\r\n                quoteItems.push({\r\n                    product_id: product.id,\r\n                    product_name: product.productName,\r\n                    quantity: 1, // Default a 1 por ahora\r\n                    price: product.price,\r\n                    subtotal: product.price\r\n                })\r\n            }\r\n        })\r\n    }\r\n\r\n    // 7. Recopilar media de productos procesados\r\n    // Regla: Si el producto fue mencionado (productIds) Y tiene mediaUrl, agregarlo\r\n    const productMedia: Array<{ productId: number; url: string; type: 'image' | 'video' }> = []\r\n\r\n    productIds.forEach(id => {\r\n        const product = productMap[String(id)]\r\n        if (product && product.mediaUrl) {\r\n            // Detectar tipo por extensión\r\n            const isVideo = /\\.(mp4|mov|avi|webm)$/i.test(product.mediaUrl)\r\n            productMedia.push({\r\n                productId: product.id,\r\n                url: product.mediaUrl,\r\n                type: isVideo ? 'video' : 'image'\r\n            })\r\n        }\r\n    })\r\n\r\n    console.log(`   - Found ${productMedia.length} product media from ${productIds.length} products`)\r\n\r\n    return {\r\n        finalText,\r\n        productIds,\r\n        productsMap: productMap,\r\n        shouldGenerateQuote,\r\n        quoteItems,\r\n        productMedia\r\n    }\r\n}\r\n\r\n/**\r\n * Detecta si se debe generar una cotización basado en reglas\r\n */\r\nfunction detectQuoteNeed(text: string, productCount: number): boolean {\r\n    const lowerText = text.toLowerCase()\r\n\r\n    // Keywords positivas\r\n    const quoteKeywords = [\r\n        'cotización', 'cotizacion', 'presupuesto',\r\n        'generar pdf', 'enviar pdf', 'formalizar', 'documento'\r\n    ]\r\n    const hasKeyword = quoteKeywords.some(k => lowerText.includes(k))\r\n\r\n    // Keywords negativas\r\n    const negativeKeywords = [\r\n        'no quiero', 'no necesito', 'solo ver',\r\n        'consultar', 'solo pregunto'\r\n    ]\r\n    const hasNegative = negativeKeywords.some(k => lowerText.includes(k))\r\n\r\n    if (hasNegative) return false\r\n\r\n    // Regla 1: Muchos productos (>= 3) -> Asumir cotización\r\n    if (productCount >= 3) return true\r\n\r\n    // Regla 2: Petición explícita\r\n    if (productCount > 0 && hasKeyword) return true\r\n\r\n    return false\r\n}\r\n"}