{"name":"config/account-config.ts","content":"/**\r\n * ELINA V5 - Account Configuration Loader\r\n * \r\n * Carga toda la configuraci√≥n de una cuenta desde m√∫ltiples tablas de Supabase\r\n */\r\n\r\nimport type { SupabaseClient } from 'https://esm.sh/@supabase/supabase-js@2'\r\nimport type { AccountConfig, CriticalRule, AutoResponse, Profile } from './types.ts'\r\nimport { DEFAULT_MODEL, DEFAULT_TEMPERATURE, DEFAULT_MAX_TOKENS } from './constants.ts'\r\n\r\n/**\r\n * Carga la configuraci√≥n completa de una cuenta\r\n */\r\n/**\r\n * Carga la configuraci√≥n completa de una cuenta\r\n */\r\nexport async function loadAccountConfig(\r\n    supabase: SupabaseClient,\r\n    userId: string\r\n): Promise<AccountConfig> {\r\n    console.log(`üìã [CONFIG] Loading account configuration for user: ${userId}`)\r\n\r\n    // 1. Cargar datos en paralelo (New Schema)\r\n    const [\r\n        profileResult,\r\n        teamResult,\r\n        rulesResult\r\n    ] = await Promise.all([\r\n        supabase.from('profiles').select('*').eq('id', userId).single(),\r\n        supabase.from('teams').select('ignored_labels').eq('owner_id', userId).maybeSingle(),\r\n        supabase.from('automation_rules').select('*').eq('user_id', userId).eq('is_active', true)\r\n    ])\r\n\r\n    if (profileResult.error || !profileResult.data) {\r\n        throw new Error(`Profile not found for user ${userId}: ${profileResult.error?.message}`)\r\n    }\r\n\r\n    const profile = profileResult.data as Profile\r\n    const team = teamResult.data\r\n    const allRules = (rulesResult.data || []) as any[] // Start as any to handle mapping\r\n\r\n    // 2. Map Automation Rules to Legacy Structures (for compatibility)\r\n    const criticalRules = allRules\r\n        .filter(r => r.type === 'critical')\r\n        .map(r => ({\r\n            id: r.id,\r\n            ruleName: r.name,\r\n            ruleType: r.trigger_type === 'pattern' ? 'pattern' : 'keyword',\r\n            patternOrKeyword: r.trigger_config?.pattern || r.trigger_config?.keyword || '',\r\n            detectionType: r.trigger_config?.detection_type || 'contains',\r\n            isActive: r.is_active,\r\n            priority: r.priority,\r\n            caseSensitive: false // Default\r\n        }))\r\n\r\n    const autoResponses = allRules\r\n        .filter(r => r.type === 'auto_response')\r\n        .map(r => ({\r\n            id: r.id,\r\n            triggerText: r.trigger_config?.keyword || '',\r\n            responseText: r.action_config?.response_text || '',\r\n            isActive: r.is_active,\r\n            matchType: r.trigger_config?.match_type || 'exact',\r\n            mediaUrl: r.action_config?.media_url,\r\n            mediaType: r.action_config?.media_type || 'text'\r\n        }))\r\n\r\n    // Extract settings from JSONB columns\r\n    const aptConfig = profile.appointment_config || {}\r\n    const quoteConfig = profile.quote_config || {}\r\n\r\n    // 3. Construir objeto de configuraci√≥n\r\n    const config: AccountConfig = {\r\n        // Identification\r\n        userId,\r\n        instanceName: profile.evolution_instance_name || '',\r\n        serverUrl: profile.evolution_api_url || 'https://evolutionapi-evolution-api.mcjhhb.easypanel.host', // Default as fallback\r\n\r\n        // AI Configuration\r\n        model: DEFAULT_MODEL,\r\n        temperature: DEFAULT_TEMPERATURE,\r\n        maxTokens: DEFAULT_MAX_TOKENS,\r\n\r\n        // Company Info\r\n        companyName: profile.full_name || 'Asistente',\r\n        companyDescription: profile.company_description || '',\r\n        website: profile.website,\r\n        businessAddress: profile.business_address,\r\n        businessPhone: profile.business_phone,\r\n        timezone: profile.timezone || 'America/Mexico_City',\r\n        slug: profile.slug,\r\n\r\n        // Personality\r\n        tone: 'profesional',\r\n        customPrompt: profile.system_prompt || undefined, // New Field\r\n\r\n        // Business Capabilities\r\n        businessType: (profile.business_type as any) || 'hybrid',\r\n        hasProducts: true, // Siempre permitir b√∫squeda de productos\r\n        hasServices: true, // Siempre permitir servicios\r\n        hasAppointments: !!(aptConfig.is_enabled),\r\n        hasQuotes: profile.quotes_enabled || false,\r\n        hasShipping: profile.has_shipping_system || false,\r\n        productCount: 0, // Deprecated - se calcula din√°micamente\r\n        serviceCount: 0, // Deprecated - se calcula din√°micamente\r\n\r\n        // Filters and Rules\r\n        ignoredLabels: team?.ignored_labels || [],\r\n        criticalRules: criticalRules as any[], // Explicit cast to avoid literal type mismatch\r\n        autoResponses,\r\n\r\n        // Integrations\r\n        evolutionApiKey: profile.evolution_api_key || '',\r\n        evolutionApiUrl: profile.evolution_api_url || 'https://evolutionapi-evolution-api.mcjhhb.easypanel.host',\r\n        elevenLabsVoiceId: undefined,\r\n\r\n        // Working Hours\r\n        workStartHour: profile.work_start_hour || 9,\r\n        workEndHour: profile.work_end_hour || 18,\r\n\r\n        // Limits\r\n        maxMessagesPerDay: undefined,\r\n\r\n        // Features\r\n        quotesEnabled: profile.quotes_enabled || false,\r\n        appointmentsEnabled: !!(aptConfig.is_enabled),\r\n        remindersEnabled: false\r\n    }\r\n\r\n    console.log(`‚úÖ [CONFIG] Configuration loaded successfully (New Schema)`)\r\n    console.log(`   - Company: ${config.companyName}`)\r\n    console.log(`   - Instance: ${config.instanceName}`)\r\n    console.log(`   - API Key Present: ${config.evolutionApiKey ? 'YES' : 'NO'} (${config.evolutionApiKey.substring(0, 4)}...)`)\r\n    return config\r\n}\r\n\r\n/**\r\n * Valida que la configuraci√≥n de la cuenta sea v√°lida\r\n */\r\nexport function validateAccountConfig(config: AccountConfig): { valid: boolean; errors: string[] } {\r\n    const errors: string[] = []\r\n\r\n    if (!config.userId) {\r\n        errors.push('Missing userId')\r\n    }\r\n\r\n    if (!config.instanceName) {\r\n        errors.push('Missing instanceName')\r\n    }\r\n\r\n    if (!config.evolutionApiKey) {\r\n        errors.push('Missing evolutionApiKey')\r\n    }\r\n\r\n    if (!config.companyName) {\r\n        errors.push('Missing companyName')\r\n    }\r\n\r\n    if (config.workStartHour < 0 || config.workStartHour > 23) {\r\n        errors.push('Invalid workStartHour (must be 0-23)')\r\n    }\r\n\r\n    if (config.workEndHour < 0 || config.workEndHour > 23) {\r\n        errors.push('Invalid workEndHour (must be 0-23)')\r\n    }\r\n\r\n    if (config.workStartHour >= config.workEndHour) {\r\n        errors.push('workStartHour must be less than workEndHour')\r\n    }\r\n\r\n    return {\r\n        valid: errors.length === 0,\r\n        errors\r\n    }\r\n}\r\n\r\n\r\n"}