{"name":"utils/evolution.ts","content":"/**\r\n * ELINA V5 - Evolution API Client\r\n * \r\n * Cliente para interactuar con Evolution API (WhatsApp)\r\n */\r\n\r\nimport type { AccountConfig } from '../config/types.ts'\r\n\r\n/**\r\n * Env√≠a un mensaje de texto\r\n */\r\nexport async function sendMessage(\r\n    config: AccountConfig,\r\n    remoteJid: string,\r\n    text: string,\r\n    enableDelay: boolean = true\r\n): Promise<void> {\r\n    console.log(`üì§ [EVOLUTION] Sending message to ${remoteJid}`)\r\n\r\n    const url = `${config.evolutionApiUrl}/message/sendText/${config.instanceName}`\r\n\r\n    // Calcular delay aleatorio entre 1000-2000ms\r\n    const delayMs = enableDelay ? Math.floor(Math.random() * 1000) + 1000 : 0\r\n\r\n    const payload = {\r\n        number: remoteJid,\r\n        text: text,\r\n        ...(enableDelay && { delay: delayMs })\r\n    }\r\n\r\n    console.log(`üì§ [EVOLUTION] URL: ${url}`)\r\n    console.log(`üì§ [EVOLUTION] Payload:`, JSON.stringify(payload, null, 2))\r\n\r\n    try {\r\n        const response = await fetch(url, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'apikey': config.evolutionApiKey\r\n            },\r\n            body: JSON.stringify(payload)\r\n        })\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text()\r\n            throw new Error(`Evolution API error: ${response.status} - ${errorText}`)\r\n        }\r\n\r\n        console.log(`‚úÖ [EVOLUTION] Message sent successfully`)\r\n    } catch (error) {\r\n        console.error(`‚ùå [EVOLUTION] Error sending message: ${error.message}`)\r\n        throw error\r\n    }\r\n}\r\n\r\n/**\r\n * Env√≠a una imagen\r\n */\r\nexport async function sendImage(\r\n    config: AccountConfig,\r\n    remoteJid: string,\r\n    imageUrl: string,\r\n    caption?: string\r\n): Promise<void> {\r\n    console.log(`üì§ [EVOLUTION] Sending image to ${remoteJid}`)\r\n\r\n    const url = `${config.evolutionApiUrl}/message/sendMedia/${config.instanceName}`\r\n\r\n    // Limpiar n√∫mero (remover @s.whatsapp.net si existe)\r\n    const cleanNumber = remoteJid.replace('@s.whatsapp.net', '')\r\n\r\n    // Extraer extensi√≥n de la URL para mimetype\r\n    const extension = imageUrl.split('.').pop()?.toLowerCase() || 'jpg'\r\n    const mimetypes: Record<string, string> = {\r\n        'jpg': 'image/jpeg',\r\n        'jpeg': 'image/jpeg',\r\n        'png': 'image/png',\r\n        'gif': 'image/gif',\r\n        'webp': 'image/webp'\r\n    }\r\n    const mimetype = mimetypes[extension] || 'image/jpeg'\r\n\r\n    // Delay aleatorio entre 1000-2000ms\r\n    const delayMs = Math.floor(Math.random() * 1000) + 1000\r\n\r\n    const payload = {\r\n        number: cleanNumber,\r\n        mediatype: 'image',\r\n        mimetype: mimetype,\r\n        caption: caption || '',\r\n        media: imageUrl,\r\n        fileName: `image.${extension}`,\r\n        delay: delayMs\r\n    }\r\n\r\n    console.log(`üì§ [EVOLUTION] Payload:`, JSON.stringify(payload, null, 2))\r\n\r\n    try {\r\n        const response = await fetch(url, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'apikey': config.evolutionApiKey\r\n            },\r\n            body: JSON.stringify(payload)\r\n        })\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text()\r\n            throw new Error(`Evolution API error: ${response.status} - ${errorText}`)\r\n        }\r\n\r\n        console.log(`‚úÖ [EVOLUTION] Image sent successfully`)\r\n    } catch (error) {\r\n        console.error(`‚ùå [EVOLUTION] Error sending image: ${error.message}`)\r\n        throw error\r\n    }\r\n}\r\n\r\n/**\r\n * Env√≠a un audio\r\n */\r\nexport async function sendAudio(\r\n    config: AccountConfig,\r\n    remoteJid: string,\r\n    audioUrl: string\r\n): Promise<void> {\r\n    console.log(`üì§ [EVOLUTION] Sending audio to ${remoteJid}`)\r\n\r\n    const url = `${config.evolutionApiUrl}/message/sendMedia/${config.instanceName}`\r\n\r\n    try {\r\n        const response = await fetch(url, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'apikey': config.evolutionApiKey\r\n            },\r\n            body: JSON.stringify({\r\n                number: remoteJid,\r\n                mediatype: 'audio',\r\n                media: audioUrl\r\n            })\r\n        })\r\n\r\n        if (!response.ok) {\r\n            throw new Error(`Evolution API error: ${response.status}`)\r\n        }\r\n\r\n        console.log(`‚úÖ [EVOLUTION] Audio sent successfully`)\r\n    } catch (error) {\r\n        console.error(`‚ùå [EVOLUTION] Error sending audio: ${error.message}`)\r\n        throw error\r\n    }\r\n}\r\n\r\n/**\r\n * Env√≠a un video\r\n */\r\nexport async function sendVideo(\r\n    config: AccountConfig,\r\n    remoteJid: string,\r\n    videoUrl: string,\r\n    caption?: string\r\n): Promise<void> {\r\n    console.log(`üì§ [EVOLUTION] Sending video to ${remoteJid}`)\r\n\r\n    const url = `${config.evolutionApiUrl}/message/sendMedia/${config.instanceName}`\r\n\r\n    // Limpiar n√∫mero (remover @s.whatsapp.net si existe)\r\n    const cleanNumber = remoteJid.replace('@s.whatsapp.net', '')\r\n\r\n    // Extraer extensi√≥n para mimetype\r\n    const extension = videoUrl.split('.').pop()?.toLowerCase() || 'mp4'\r\n    const mimetypes: Record<string, string> = {\r\n        'mp4': 'video/mp4',\r\n        'mov': 'video/quicktime',\r\n        'avi': 'video/x-msvideo',\r\n        'webm': 'video/webm'\r\n    }\r\n    const mimetype = mimetypes[extension] || 'video/mp4'\r\n\r\n    // Delay aleatorio entre 1000-2000ms\r\n    const delayMs = Math.floor(Math.random() * 1000) + 1000\r\n\r\n    const payload = {\r\n        number: cleanNumber,\r\n        mediatype: 'video',\r\n        mimetype: mimetype,\r\n        caption: caption || '',\r\n        media: videoUrl,\r\n        fileName: `video.${extension}`,\r\n        delay: delayMs\r\n    }\r\n\r\n    console.log(`üì§ [EVOLUTION] Payload:`, JSON.stringify(payload, null, 2))\r\n\r\n    try {\r\n        const response = await fetch(url, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'apikey': config.evolutionApiKey\r\n            },\r\n            body: JSON.stringify(payload)\r\n        })\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text()\r\n            throw new Error(`Evolution API error: ${response.status} - ${errorText}`)\r\n        }\r\n\r\n        console.log(`‚úÖ [EVOLUTION] Video sent successfully`)\r\n    } catch (error) {\r\n        console.error(`‚ùå [EVOLUTION] Error sending video: ${error.message}`)\r\n        throw error\r\n    }\r\n}\r\n\r\n"}