{"name":"utils/tool-executor.ts","content":"/**\r\n * ELINA V5 - Tool Executor\r\n * \r\n * Ejecuta las llamadas a herramientas (tool calls) del LLM\r\n */\r\n\r\nimport type { SupabaseClient } from 'https://esm.sh/@supabase/supabase-js@2'\r\nimport type { AccountConfig, ToolCall, ToolResult } from '../config/types.ts'\r\nimport { buscarProductos, agendarCita, consultarDisponibilidad } from './tools.ts'\r\n\r\n/**\r\n * Ejecuta una lista de tool calls y devuelve los resultados\r\n */\r\nexport async function executeToolCalls(\r\n    supabase: SupabaseClient,\r\n    config: AccountConfig,\r\n    contactId: number,\r\n    toolCalls: ToolCall[],\r\n    conversationState?: any,  // ‚Üê Par√°metro para estado conversacional\r\n    userMessage?: string      // ‚Üê Nuevo: mensaje original del usuario para detecci√≥n inteligente\r\n): Promise<ToolResult[]> {\r\n    console.log(`üîß [TOOLS] Executing ${toolCalls.length} tool call(s)`)\r\n\r\n    const results: ToolResult[] = []\r\n\r\n    for (const toolCall of toolCalls) {\r\n        const functionName = toolCall.function.name\r\n        const functionArgs = JSON.parse(toolCall.function.arguments)\r\n\r\n        console.log(`   - Calling: ${functionName}`, functionArgs)\r\n\r\n        try {\r\n            let result: any\r\n\r\n            switch (functionName) {\r\n                case 'buscar_productos':\r\n                    const searchResult = await buscarProductos(\r\n                        supabase,\r\n                        config.userId,\r\n                        functionArgs.query,\r\n                        functionArgs.limit || 5,\r\n                        userMessage // ‚Üê Pasar mensaje original para detecci√≥n autom√°tica\r\n                    )\r\n\r\n                    // Handle new structured response format\r\n                    if (searchResult.status === 'ERROR' || searchResult.status === 'NOT_FOUND') {\r\n                        result = {\r\n                            status: searchResult.status,\r\n                            message: searchResult.message,\r\n                            products: []\r\n                        }\r\n                    } else {\r\n                        // SUCCESS case - combine exact matches and alternatives\r\n                        const allProducts = [\r\n                            ...(searchResult.exact_matches || []),\r\n                            ...(searchResult.suggested_alternatives || [])\r\n                        ]\r\n\r\n                        // Separate services for special formatting\r\n                        const services = allProducts.filter(p => p.product_type === 'service')\r\n                        const physicalProducts = allProducts.filter(p => p.product_type !== 'service')\r\n\r\n                        result = {\r\n                            status: searchResult.status,\r\n                            message: searchResult.message,\r\n                            exact_match_found: searchResult.exact_match_found,\r\n                            has_alternatives: searchResult.has_alternatives,\r\n                            products: allProducts,\r\n                            services: services,  // Store for code-based formatting\r\n                            physicalProducts: physicalProducts,\r\n                            // Pass formatting hints to agent\r\n                            formatting_hint: searchResult.exact_matches?.map(p => p.formatting_hint).join('\\n') || ''\r\n                        }\r\n                    }\r\n                    break\r\n\r\n                    break\r\n\r\n                case 'consultar_disponibilidad':\r\n                    result = await consultarDisponibilidad(\r\n                        supabase,\r\n                        config.userId,\r\n                        functionArgs.date,\r\n                        config.slug // Pasar el slug para generar link\r\n                    )\r\n                    break\r\n\r\n                case 'agendar_cita':\r\n                    result = await agendarCita(\r\n                        supabase,\r\n                        config.userId,\r\n                        contactId,\r\n                        functionArgs.date,\r\n                        functionArgs.time,\r\n                        functionArgs.service_id,\r\n                        functionArgs.notes,\r\n                        conversationState  // ‚Üê Pasar el estado\r\n                    )\r\n                    break\r\n\r\n                case 'consultar_mis_citas':\r\n                    const { consultarMisCitas } = await import('./tools.ts')\r\n                    result = await consultarMisCitas(\r\n                        supabase,\r\n                        config.userId,\r\n                        contactId\r\n                    )\r\n                    break\r\n\r\n                case 'modificar_cita':\r\n                    const { modificarCita } = await import('./tools.ts')\r\n                    result = await modificarCita(\r\n                        supabase,\r\n                        config.userId,\r\n                        contactId,\r\n                        functionArgs.appointment_id,\r\n                        functionArgs.new_date,\r\n                        functionArgs.new_time\r\n                    )\r\n                    break\r\n\r\n                case 'consultar_promociones':\r\n                    const { consultarPromociones } = await import('./tools.ts')\r\n                    result = await consultarPromociones(\r\n                        supabase,\r\n                        config.userId\r\n                    )\r\n                    break\r\n\r\n                default:\r\n                    console.warn(`‚ö†Ô∏è [TOOLS] Unknown tool: ${functionName}`)\r\n                    result = { error: `Unknown tool: ${functionName}` }\r\n            }\r\n\r\n            results.push({\r\n                tool_call_id: toolCall.id,\r\n                role: 'tool',\r\n                name: functionName,\r\n                content: JSON.stringify(result)\r\n            })\r\n\r\n            console.log(`   ‚úÖ ${functionName} completed`)\r\n\r\n        } catch (error) {\r\n            console.error(`   ‚ùå Error executing ${functionName}:`, error)\r\n            results.push({\r\n                tool_call_id: toolCall.id,\r\n                role: 'tool',\r\n                name: functionName,\r\n                content: JSON.stringify({\r\n                    error: error instanceof Error ? error.message : String(error)\r\n                })\r\n            })\r\n        }\r\n    }\r\n\r\n    return results\r\n}\r\n"}