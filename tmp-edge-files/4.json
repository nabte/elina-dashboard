{"name":"core/filters.ts","content":"/**\r\n * ELINA V5 - Filters System\r\n * \r\n * Sistema de filtros para ignorar mensajes seg√∫n etiquetas, estado de conversaci√≥n, etc.\r\n */\r\n\r\nimport type { SupabaseClient } from 'https://esm.sh/@supabase/supabase-js@2'\r\nimport type { AccountConfig, FilterResult, Contact, ConversationState } from '../config/types.ts'\r\n\r\n/**\r\n * Determina si un mensaje debe ser ignorado\r\n */\r\nexport async function shouldIgnoreMessage(\r\n    supabase: SupabaseClient,\r\n    config: AccountConfig,\r\n    contactId: number\r\n): Promise<FilterResult> {\r\n    console.log(`üîç [FILTER] Checking if message should be ignored for contact ${contactId}`)\r\n\r\n    // 1. Obtener informaci√≥n del contacto\r\n    const { data: contact, error: contactError } = await supabase\r\n        .from('contacts')\r\n        .select('labels, is_simulation')\r\n        .eq('id', contactId)\r\n        .single()\r\n\r\n    if (contactError || !contact) {\r\n        console.warn(`‚ö†Ô∏è [FILTER] Contact not found: ${contactId}`)\r\n        return { ignore: false }\r\n    }\r\n\r\n    // 2. Verificar etiquetas ignoradas\r\n    const contactLabels = (contact as Contact).labels || []\r\n\r\n    // El usuario confirm√≥ expl√≠citamente: \"si entro de sus label existe 'ignorar' ingoramos\"\r\n    const hasIgnoredLabel = contactLabels.some(label =>\r\n        label.toLowerCase() === 'ignorar' ||\r\n        config.ignoredLabels.includes(label)\r\n    )\r\n\r\n    if (hasIgnoredLabel) {\r\n        console.log(`üö´ [FILTER] Contact has ignored label. Labels: ${contactLabels.join(', ')}`)\r\n        return {\r\n            ignore: true,\r\n            reason: `Contact marked as 'ignorar'`\r\n        }\r\n    }\r\n\r\n    // 3. Verificar si la conversaci√≥n est√° pausada\r\n    const { data: convState, error: convError } = await supabase\r\n        .from('conversation_states')\r\n        .select('is_paused, pause_reason')\r\n        .eq('contact_id', contactId)\r\n        .maybeSingle()\r\n\r\n    if (!convError && convState) {\r\n        const state = convState as ConversationState\r\n        if (state.is_paused) {\r\n            console.log(`‚è∏Ô∏è [FILTER] Conversation is paused: ${state.pause_reason}`)\r\n            return {\r\n                ignore: true,\r\n                reason: `Conversation paused: ${state.pause_reason || 'No reason provided'}`\r\n            }\r\n        }\r\n    }\r\n\r\n    // 4. Verificar horario laboral (solo si no es simulaci√≥n)\r\n    if (!contact.is_simulation) {\r\n        const now = new Date()\r\n        const currentHour = now.getHours()\r\n\r\n        if (currentHour < config.workStartHour || currentHour >= config.workEndHour) {\r\n            console.log(`üïê [FILTER] Outside working hours (${currentHour}:00, work hours: ${config.workStartHour}-${config.workEndHour})`)\r\n            // NO ignorar, pero podr√≠amos enviar un mensaje autom√°tico\r\n            // Por ahora, permitimos que el bot responda 24/7\r\n        }\r\n    }\r\n\r\n    console.log(`‚úÖ [FILTER] Message should be processed`)\r\n    return { ignore: false }\r\n}\r\n\r\n/**\r\n * Verifica si un contacto tiene una etiqueta espec√≠fica\r\n */\r\nexport async function contactHasLabel(\r\n    supabase: SupabaseClient,\r\n    contactId: number,\r\n    labelName: string\r\n): Promise<boolean> {\r\n    const { data, error } = await supabase\r\n        .from('contacts')\r\n        .select('labels')\r\n        .eq('id', contactId)\r\n        .single()\r\n\r\n    if (error || !data) {\r\n        return false\r\n    }\r\n\r\n    const labels = (data as Contact).labels || []\r\n    return labels.includes(labelName)\r\n}\r\n\r\n/**\r\n * Pausa una conversaci√≥n\r\n */\r\nexport async function pauseConversation(\r\n    supabase: SupabaseClient,\r\n    contactId: number,\r\n    userId: string,\r\n    reason: string\r\n): Promise<void> {\r\n    console.log(`‚è∏Ô∏è [FILTER] Pausing conversation for contact ${contactId}`)\r\n\r\n    const { error } = await supabase\r\n        .from('conversation_states')\r\n        .upsert({\r\n            contact_id: contactId,\r\n            user_id: userId,\r\n            is_paused: true,\r\n            pause_reason: reason,\r\n            paused_at: new Date().toISOString(),\r\n            paused_by: userId,\r\n            updated_at: new Date().toISOString()\r\n        }, {\r\n            onConflict: 'contact_id'\r\n        })\r\n\r\n    if (error) {\r\n        console.error(`‚ùå [FILTER] Error pausing conversation: ${error.message}`)\r\n        throw error\r\n    }\r\n\r\n    console.log(`‚úÖ [FILTER] Conversation paused successfully`)\r\n}\r\n\r\n/**\r\n * Reanuda una conversaci√≥n\r\n */\r\nexport async function resumeConversation(\r\n    supabase: SupabaseClient,\r\n    contactId: number,\r\n    userId: string\r\n): Promise<void> {\r\n    console.log(`‚ñ∂Ô∏è [FILTER] Resuming conversation for contact ${contactId}`)\r\n\r\n    const { error } = await supabase\r\n        .from('conversation_states')\r\n        .update({\r\n            is_paused: false,\r\n            pause_reason: null,\r\n            resumed_at: new Date().toISOString(),\r\n            resumed_by: userId,\r\n            updated_at: new Date().toISOString()\r\n        })\r\n        .eq('contact_id', contactId)\r\n\r\n    if (error) {\r\n        console.error(`‚ùå [FILTER] Error resuming conversation: ${error.message}`)\r\n        throw error\r\n    }\r\n\r\n    console.log(`‚úÖ [FILTER] Conversation resumed successfully`)\r\n}\r\n\r\n/**\r\n * Verifica si un mensaje es spam o abusivo\r\n */\r\nexport function isSpamOrAbusive(message: string): boolean {\r\n    // Detectar mensajes muy cortos repetidos\r\n    if (message.length < 3) {\r\n        return true\r\n    }\r\n\r\n    // Detectar caracteres repetidos excesivamente\r\n    const repeatedCharsRegex = /(.)\\1{10,}/\r\n    if (repeatedCharsRegex.test(message)) {\r\n        return true\r\n    }\r\n\r\n    // Detectar URLs sospechosas (opcional)\r\n    const suspiciousUrlRegex = /(bit\\.ly|tinyurl|goo\\.gl)/i\r\n    if (suspiciousUrlRegex.test(message)) {\r\n        console.warn(`‚ö†Ô∏è [FILTER] Suspicious URL detected in message`)\r\n        // No bloquear autom√°ticamente, solo advertir\r\n    }\r\n\r\n    return false\r\n}\r\n"}