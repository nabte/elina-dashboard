<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elina IA - Dashboard</title>
    <!-- Versi√≥n: 2026-02-16-001 - Bot√≥n Verificar Estado WhatsApp -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librer√≠a para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- CORRECCI√ìN: Cargar lucide con 'defer' para garantizar que est√© disponible antes que los scripts de la app. -->
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Forzar ancho completo para intl-tel-input */
        .iti {
            width: 100% !important;
        }

        .iti__flag-container {
            position: absolute;
        }

        #whatsapp-phone-input {
            padding-left: 90px !important;
        }

        .iti__selected-dial-code {
            margin-left: 6px;
        }
    </style>
    <script type="module" crossorigin src="/assets/modulepreload-polyfill-B5Qt9EMX.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/dashboard-DSi9585J.css">
</head>

<body class="bg-slate-100 text-slate-800">
    <!-- Modal para Confirmaci√≥n de Optimizaci√≥n con IA (Movido al inicio para evitar problemas de anidamiento) -->
    <div id="optimize-confirm-modal"
        style="display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); align-items: center; justify-content: center; z-index: 999999; padding: 1rem;">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
            <div class="p-6 text-center">
                <div
                    class="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="sparkles" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">¬øOptimizar Cat√°logo con IA?</h3>
                <p class="text-slate-500 text-sm mb-6">
                    Mejoraremos las descripciones de tus productos usando GPT-4.1 Mini para hacerlas m√°s atractivas y
                    profesionales.
                </p>

                <div class="space-y-3">
                    <button id="optimize-empty-btn" type="button"
                        class="w-full py-3 px-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold rounded-xl hover:from-purple-700 hover:to-indigo-700 shadow-lg shadow-purple-200 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="filter" class="w-4 h-4"></i>
                        Optimizar solo los vac√≠os
                    </button>

                    <button id="optimize-all-btn" type="button"
                        class="w-full py-3 px-4 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-bold rounded-xl hover:from-emerald-600 hover:to-teal-700 shadow-lg shadow-emerald-100 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="list" class="w-4 h-4"></i>
                        Aplicar a todos
                    </button>

                    <button id="close-optimize-modal-btn" type="button"
                        class="w-full py-3 px-4 bg-slate-100 text-slate-500 font-bold rounded-xl hover:bg-slate-200 transition-all">
                        Cancelar
                    </button>
                </div>
            </div>
            <div class="bg-slate-50 p-4 text-center">
                <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Potenciado por Elina AI</p>
            </div>
        </div>
    </div>

    <div class="flex h-screen overflow-hidden">
        <!-- Barra lateral de navegaci√≥n (se ocultar√° en m√≥vil) -->
        <aside id="main-sidebar" class="main-sidebar w-64 bg-slate-900 text-white flex flex-col p-4 overflow-y-auto">
            <div class="flex items-center justify-between gap-3 mb-8">
                <div class="flex items-center gap-3 overflow-hidden">
                    <img id="user-avatar" src="https://ui-avatars.com/api/?name=Elina" alt="Foto del negocio"
                        class="h-10 w-10 rounded-full object-cover border border-white/20">
                    <div class="sidebar-text">
                        <p id="user-business-name" class="font-semibold text-white truncate">Cargando negocio...</p>
                        <span id="user-plan-badge"
                            class="inline-block text-xs font-bold px-2 py-0.5 rounded-md mt-1.5 bg-slate-200 text-slate-800">Plan</span>
                    </div>
                </div>
                <!-- Bot√≥n para cerrar el men√∫ en m√≥vil -->
                <button id="close-sidebar-btn" class="md:hidden p-1 rounded-full hover:bg-slate-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <nav class="flex-grow">
                <ul class="space-y-1">
                    <!-- Dashboard -->
                    <li><a href="#"
                            class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors"
                            data-target="dashboard"><i data-lucide="layout-dashboard"
                                class="w-4 h-4 flex-shrink-0"></i><span class="sidebar-text">Dashboard</span></a></li>

                    <!-- Grupo: Campa√±as (solo el t√≠tulo, clickeable) -->
                    <li>
                        <a href="#"
                            class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors"
                            data-group="campaigns" data-group-default="bulk-sending">
                            <i data-lucide="megaphone" class="w-4 h-4 flex-shrink-0"></i>
                            <span class="sidebar-text font-semibold">Campa√±as</span>
                        </a>
                    </li>

                    <!-- Grupo: Clientes (solo el t√≠tulo, clickeable) -->
                    <li>
                        <a href="#"
                            class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors"
                            data-group="clients" data-group-default="contacts">
                            <i data-lucide="users" class="w-4 h-4 flex-shrink-0"></i>
                            <span class="sidebar-text font-semibold">Clientes</span>
                        </a>
                    </li>

                    <!-- Grupo: Configuraci√≥n IA (solo el t√≠tulo, clickeable) -->
                    <!-- Grupo: Configuraci√≥n IA -->
                    <li>
                        <a href="#"
                            class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors"
                            data-target="prompt-training" data-group="ai-behavior" data-tab="prompt-training">
                            <i data-lucide="brain" class="w-4 h-4 flex-shrink-0"></i>
                            <span class="sidebar-text font-semibold">IA Mind</span>
                        </a>
                    </li>

                    <!-- Chats y Citas (items individuales) -->
                    <li><a href="#"
                            class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors"
                            data-target="chats"><i data-lucide="message-square" class="w-4 h-4 flex-shrink-0"></i><span
                                class="sidebar-text">Chats</span></a></li>
                    <li id="appointments-menu-item"><a href="#"
                            class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors"
                            data-target="appointments"><i data-lucide="calendar-days"
                                class="w-4 h-4 flex-shrink-0"></i><span class="sidebar-text">Citas</span></a></li>

                    <!-- Grupo: Marketing (solo el t√≠tulo, clickeable) -->
                    <li>
                        <a href="#"
                            class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors"
                            data-group="marketing" data-group-default="designer-ai">
                            <i data-lucide="trending-up" class="w-4 h-4 flex-shrink-0"></i>
                            <span class="sidebar-text font-semibold">Marketing</span>
                        </a>
                    </li>

                    <!-- Productos y Etiquetas IA (items individuales) -->
                    <li><a href="#"
                            class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors"
                            data-target="products"><i data-lucide="boxes" class="w-4 h-4 flex-shrink-0"></i><span
                                class="sidebar-text">Productos</span></a></li>
                    <li><a href="#"
                            class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-green-500 hover:text-white transition-colors"
                            data-target="smart-labels"><i data-lucide="tags" class="w-4 h-4 flex-shrink-0"></i><span
                                class="sidebar-text">Etiquetas IA</span></a></li>
                </ul>
            </nav>
            <!-- Secci√≥n de Upgrade de Plan -->
            <div id="upgrade-plan-section" class="mt-6 mb-4 hidden">
                <div class="sidebar-text">
                    <button id="upgrade-trial-btn"
                        class="hidden cta-button block w-full text-center bg-green-500 text-white font-bold py-3 px-4 rounded-lg">¬°Elige
                        tu Plan!</button>
                    <a href="#" id="upgrade-grow-btn"
                        class="hidden cta-button block w-full text-center bg-cyan-500 text-slate-900 font-bold py-3 px-4 rounded-lg">Mejorar
                        a Plan Grow</a>
                </div>
                <button id="upgrade-collapsed-btn"
                    class="hidden w-full justify-center bg-blue-600 text-white font-bold py-2 px-2 rounded-lg">
                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="mt-auto space-y-1">
                <a href="/superadmin.html" id="superadmin-link"
                    class="hidden nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-slate-700 transition-colors"><i
                        data-lucide="shield" class="w-4 h-4 flex-shrink-0"></i><span class="sidebar-text">Super
                        Admin</span></a>

                <!-- Enlace Panel de Afiliados (Oculto por defecto) -->
                <a href="#" id="affiliate-link"
                    class="hidden nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md text-amber-400 hover:bg-slate-700 transition-colors"
                    data-target="affiliate-panel"><i data-lucide="award" class="w-4 h-4 flex-shrink-0"></i><span
                        class="sidebar-text">Panel de Afiliado</span></a>

                <a href="#"
                    class="nav-link text-sm flex items-center gap-3 px-4 py-2 rounded-md hover:bg-slate-700 transition-colors"
                    data-target="settings"><i data-lucide="settings" class="w-4 h-4 flex-shrink-0"></i><span
                        class="sidebar-text">Configuraci√≥n</span></a>
                <a href="#" id="logout-btn"
                    class="flex items-center gap-3 px-4 py-2 rounded-md text-red-400 hover:bg-red-500 hover:text-white transition-colors mt-2"><i
                        data-lucide="log-out" class="w-4 h-4 flex-shrink-0"></i><span class="sidebar-text">Cerrar
                        Sesi√≥n</span></a>
            </div>
            <div class="border-t border-slate-700 mt-4 pt-4">
                <p class="text-center text-xs text-slate-400 sidebar-text">Impulsando tus ventas con IA</p>
            </div>
        </aside>

        <!-- Contenido principal -->
        <div id="main-content-area"
            class="flex-1 transition-all duration-300 ease-in-out flex flex-col h-full overflow-hidden">
            <!-- Mobile Header -->
            <div
                class="lg:hidden bg-white border-b border-slate-200 p-4 flex items-center justify-between shadow-sm z-30 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <img src="/assets/lgo_web-DaqHEzAW.png" alt="Elina Logo" class="w-8 h-8 object-contain">
                    <span class="font-bold text-lg text-slate-900 tracking-tight font-heading">Elina <span
                            class="text-emerald-500">IA</span></span>
                </div>
                <button id="mobile-sidebar-toggle"
                    class="p-2 -mr-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>

            <main class="p-4 sm:p-5 lg:p-6 flex-1 overflow-y-auto pb-24">
                <!-- Bot√≥n para colapsar/expandir el sidebar (visible solo en desktop/tablet) -->
                <button id="toggle-sidebar-collapse-btn"
                    class="hidden lg:block fixed top-5 z-50 p-2 rounded-full bg-white/80 backdrop-blur-sm shadow-md hover:bg-slate-100 transition-all duration-300 ease-in-out">
                    <i data-lucide="chevron-left" class="w-5 h-5 text-slate-600"></i>
                </button>

                <!-- Panel del Dashboard (activo por defecto) -->
                <div id="dashboard" class="content-panel active">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Columna principal (M√©tricas y Tutoriales) -->
                        <div class="lg:col-span-2 space-y-8 order-1">
                            <div>
                                <h2 class="text-2xl font-bold mb-4">üöÄ NUEVO: Resumen de Actividad (√öltimos 30 d√≠as)
                                </h2>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                    <div
                                        class="stat-card bg-blue-50 p-4 rounded-xl shadow-md text-center border border-blue-200">
                                        <div class="flex items-center justify-center gap-2 mb-2">
                                            <i data-lucide="message-circle" class="w-4 h-4 text-blue-600"></i>
                                            <h4 class="font-semibold text-blue-800 text-xs">Conversaciones Atendidas
                                            </h4>
                                        </div>
                                        <p id="funnel-conversations-stat" class="text-3xl font-bold text-blue-600 mt-2">
                                            0</p>
                                    </div>
                                    <div
                                        class="stat-card bg-purple-50 p-4 rounded-xl shadow-md text-center border border-purple-200">
                                        <div class="flex items-center justify-center gap-2 mb-2">
                                            <i data-lucide="file-text" class="w-4 h-4 text-purple-600"></i>
                                            <h4 class="font-semibold text-purple-800 text-xs">Cotizaciones Generadas
                                            </h4>
                                        </div>
                                        <p id="funnel-quotes-stat" class="text-3xl font-bold text-purple-600 mt-2">0</p>
                                    </div>
                                    <div
                                        class="stat-card bg-orange-50 p-4 rounded-xl shadow-md text-center border border-orange-200">
                                        <div class="flex items-center justify-center gap-2 mb-2">
                                            <i data-lucide="clock" class="w-4 h-4 text-orange-600"></i>
                                            <h4 class="font-semibold text-orange-800 text-xs">Tiempo Ahorrado</h4>
                                        </div>
                                        <p id="funnel-time-saved-stat" class="text-3xl font-bold text-orange-600 mt-2">
                                            0<span class="text-sm">min</span></p>
                                    </div>
                                    <div
                                        class="stat-card bg-green-50 p-4 rounded-xl shadow-md text-center border border-green-200">
                                        <div class="flex items-center justify-center gap-2 mb-2">
                                            <i data-lucide="zap" class="w-4 h-4 text-green-600"></i>
                                            <h4 class="font-semibold text-green-800 text-xs">Tasa de Automatizaci√≥n</h4>
                                        </div>
                                        <p id="funnel-automation-stat" class="text-3xl font-bold text-green-600 mt-2">0%
                                        </p>
                                    </div>
                                </div>

                                <h2 class="text-2xl font-bold mb-4">M√©tricas de Valor</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                    <div class="stat-card bg-white p-4 rounded-xl shadow-md">
                                        <h4 class="font-bold text-slate-800 mb-2">Mensajes Respondidos por IA</h4>
                                        <div class="h-40"><canvas id="responses-chart"></canvas></div>
                                    </div>
                                    <div class="stat-card bg-white p-4 rounded-xl shadow-md">
                                        <h4 class="font-bold text-slate-800 mb-2">Tiempo Ahorrado (minutos)</h4>
                                        <div class="h-40"><canvas id="time-saved-chart"></canvas></div>
                                    </div>
                                </div>

                                <!-- Configuraci√≥n de IA (Movido al centro) -->
                                <div class="bg-white p-4 rounded-xl shadow-md">
                                    <h3 class="text-2xl font-bold mb-4">Configuraci√≥n de IA</h3>

                                    <form id="prompt-form" class="space-y-4">
                                        <div>
                                            <div class="flex flex-wrap justify-between items-center mb-2 gap-2">
                                                <div class="flex items-center gap-2">
                                                    <label for="ai-master-prompt" class="block font-medium">Prompt del
                                                        Asistente</label>
                                                    <span id="prompt-version-indicator"
                                                        class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-md font-mono"
                                                        title="Versi√≥n del prompt"></span>
                                                </div>
                                                <div class="flex gap-2">
                                                    <button type="button" id="remake-prompt-btn"
                                                        class="text-xs bg-blue-100 text-blue-700 font-semibold py-1 px-2 rounded-md hover:bg-blue-200 flex items-center gap-1">
                                                        <i data-lucide="refresh-cw" class="w-3 h-3"></i> Rehacer
                                                    </button>
                                                    <button type="button" id="view-history-btn"
                                                        class="text-xs bg-slate-100 text-slate-700 font-semibold py-1 px-2 rounded-md hover:bg-slate-200 flex items-center gap-1">
                                                        <i data-lucide="history" class="w-3 h-3"></i> Historial
                                                    </button>
                                                    <button type="button" id="main-prompt-ai-enhance-btn"
                                                        class="text-xs bg-purple-100 text-purple-700 font-semibold py-1 px-2 rounded-md hover:bg-purple-200 flex items-center gap-1">
                                                        <i data-lucide="sparkles" class="w-3 h-3"></i> Mejorar IA
                                                    </button>
                                                </div>
                                            </div>
                                            <textarea id="ai-master-prompt" rows="10"
                                                class="w-full border-slate-300 rounded-lg p-3 min-h-[18rem] max-h-[60vh] overflow-y-auto resize-y text-sm focus:ring-green-500 focus:border-green-500 font-mono leading-relaxed"
                                                placeholder="Describe aqu√≠ la personalidad y objetivos de tu asistente de IA..."></textarea>
                                        </div>
                                        <div class="flex justify-between items-center pt-2">
                                            <div class="text-xs text-slate-500">
                                                <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                                                Guarda los cambios para actualizar tu asistente.
                                            </div>
                                            <button type="submit"
                                                class="bg-slate-900 text-white px-6 py-2 rounded-lg hover:bg-slate-800 transition-colors font-medium flex items-center gap-2">
                                                <i data-lucide="save" class="w-4 h-4"></i> Guardar Cambios
                                            </button>
                                        </div>
                                    </form>
                                    <!-- Modals y otros elementos ocultos del prompt form aqu√≠ si es necesario -->
                                </div>
                            </div>

                        </div>

                        <!-- Columna Lateral (Prompt y conexi√≥n) -->
                        <!-- INICIO: Columna lateral reorganizada -->
                        <div class="space-y-6 order-2">
                            <!-- Link de Agendamiento (Solo si est√° activo) -->
                            <div id="booking-link-card"
                                class="bg-white p-4 rounded-xl shadow-md border-l-4 border-emerald-500 hidden">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="calendar-check" class="w-5 h-5 text-emerald-500"></i>
                                    <h3 class="text-lg font-bold">Tu Agenda P√∫blica</h3>
                                </div>
                                <p class="text-[11px] text-slate-500 mb-3 leading-tight">Comparte este link para que tus
                                    clientes agenden citas autom√°ticamente.</p>
                                <div class="flex items-center gap-2">
                                    <input type="text" id="dashboard-booking-link" readonly
                                        class="w-full text-[10px] bg-slate-50 border border-slate-200 rounded-lg px-2 py-1.5 text-slate-600 focus:outline-none select-all"
                                        value="Cargando link...">
                                    <button id="copy-dashboard-link-btn"
                                        class="p-1.5 bg-slate-100 border border-slate-200 rounded-lg hover:border-emerald-500 hover:text-emerald-600 transition-colors"
                                        title="Copiar link">
                                        <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                                    </button>
                                </div>
                                <a id="open-dashboard-link-btn" href="#" target="_blank"
                                    class="mt-3 flex items-center justify-center gap-2 w-full py-2 bg-emerald-50 text-emerald-700 rounded-lg text-xs font-bold hover:bg-emerald-100 transition-colors">
                                    <i data-lucide="external-link" class="w-3.5 h-3.5"></i> Abrir Link
                                </a>
                            </div>

                            <div id="whatsapp-card" class="bg-white p-4 rounded-xl shadow-md">
                                <h3 class="text-xl font-bold mb-4">Conexi√≥n WhatsApp</h3>

                                <!-- Estado de conexi√≥n -->
                                <div id="whatsapp-connection-container" class="text-center mb-4"></div>

                                <!-- M√©todo de conexi√≥n -->
                                <div id="connection-method-selector" class="mb-4">
                                    <label class="block text-sm font-medium text-slate-700 mb-2">M√©todo de
                                        conexi√≥n</label>
                                    <div class="flex gap-2">
                                        <button id="method-qr-btn"
                                            class="flex-1 py-2 px-3 bg-purple-50 text-purple-700 border-2 border-purple-300 font-semibold rounded-lg hover:bg-purple-100 transition">
                                            üì± C√≥digo QR
                                        </button>
                                        <button id="method-pairing-btn"
                                            class="flex-1 py-2 px-3 bg-slate-50 text-slate-700 border-2 border-slate-300 font-semibold rounded-lg hover:bg-slate-100 transition">
                                            üî¢ C√≥digo PIN
                                        </button>
                                    </div>
                                </div>

                                <!-- Input para n√∫mero de WhatsApp (ambos m√©todos) -->
                                <div id="phone-input-container" class="mb-3">
                                    <div
                                        class="bg-gradient-to-r from-purple-50 to-indigo-50 p-3 rounded-lg border border-purple-200">
                                        <div class="flex items-center gap-2 mb-2">
                                            <div class="bg-purple-600 rounded-full p-1.5 flex-shrink-0">
                                                <i data-lucide="smartphone" class="w-3.5 h-3.5 text-white"></i>
                                            </div>
                                            <label class="text-xs font-bold text-slate-800 flex-grow">
                                                Tu n√∫mero de WhatsApp <span class="text-red-500">*</span>
                                            </label>
                                            <i data-lucide="info" class="w-3.5 h-3.5 text-purple-600 flex-shrink-0"
                                                title="N√∫mero con el que usas WhatsApp"></i>
                                        </div>

                                        <input type="tel" id="whatsapp-phone-input" placeholder="55 1234 5678"
                                            class="w-full px-3 py-2 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all font-medium"
                                            required>

                                        <!-- Error message (hidden by default) -->
                                        <div id="phone-error-message"
                                            class="hidden mt-2 p-2 bg-red-50 border-l-4 border-red-500 rounded flex items-center gap-2">
                                            <i data-lucide="alert-circle"
                                                class="w-3.5 h-3.5 text-red-600 flex-shrink-0"></i>
                                            <p class="text-xs text-red-700 font-medium">Ingresa tu n√∫mero de WhatsApp
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bot√≥n de conexi√≥n -->
                                <button id="request-qr-btn"
                                    class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-2.5 px-4 rounded-lg hover:from-purple-700 hover:to-indigo-700 transition shadow-md">
                                    Conectar WhatsApp
                                </button>

                                <!-- Bot√≥n de verificar estado (oculto por defecto) -->
                                <button id="verify-whatsapp-status-btn" style="display: none;"
                                    class="w-full bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition shadow-md flex items-center justify-center gap-2">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    Verificar Estado
                                </button>

                                <!-- Bot√≥n de desconexi√≥n (oculto por defecto) -->
                                <button id="disconnect-whatsapp-btn" style="display: none;"
                                    class="w-full bg-red-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-red-700 transition shadow-md">
                                    Desconectar WhatsApp
                                </button>

                                <p class="text-xs text-slate-400 mt-2 text-center" id="connection-hint">
                                    Escanea el QR desde WhatsApp > Dispositivos Vinculados
                                </p>
                            </div>

                            <!-- Bot√≥n de Wizard - Auto-configuraci√≥n del Sistema -->
                            <div
                                class="bg-gradient-to-br from-purple-600 via-blue-600 to-cyan-500 p-6 rounded-2xl shadow-2xl relative overflow-hidden group animate-pulse-slow border-4 border-white/30">
                                <div
                                    class="absolute top-0 right-0 -mr-4 -mt-4 w-32 h-32 bg-white opacity-20 rounded-full blur-2xl group-hover:scale-150 transition-transform duration-500">
                                </div>
                                <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>
                                <div class="relative z-10">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="text-3xl">üöÄ</span>
                                        <h3 class="text-xl font-black text-white drop-shadow-lg">Auto-Configuraci√≥n</h3>
                                    </div>
                                    <p class="text-white/95 text-sm mb-4 font-medium leading-relaxed">
                                        Configura todo tu sistema en <span class="font-black text-yellow-300">menos de 3
                                            minutos</span> con nuestro asistente inteligente.
                                    </p>
                                    <button id="dashboard-wizard-btn"
                                        class="w-full bg-white text-purple-700 font-black py-3.5 px-6 rounded-xl shadow-xl hover:shadow-2xl hover:scale-105 transition-all duration-300 flex items-center justify-center gap-3 group/btn">
                                        <i data-lucide="sparkles" class="w-5 h-5 group-hover/btn:animate-spin"></i>
                                        <span>INICIAR WIZARD</span>
                                        <i data-lucide="arrow-right"
                                            class="w-5 h-5 group-hover/btn:translate-x-1 transition-transform"></i>
                                    </button>
                                    <p class="text-white/70 text-xs mt-3 text-center font-semibold">
                                        ‚ú® Conecta WhatsApp ‚Ä¢ ‚öôÔ∏è Configura IA ‚Ä¢ üìä Listo para vender
                                    </p>
                                </div>
                            </div>

                            <div id="tutorials-card" class="bg-white p-4 rounded-xl shadow-md">
                                <h3 class="text-xl font-bold mb-4">Tutoriales</h3>
                                <p class="text-sm text-slate-500 mb-3">Aprende a sacar el m√°ximo provecho de Elina.</p>
                                <!-- INICIO: Video incrustado -->
                                <div class="relative w-full aspect-video rounded-lg overflow-hidden shadow-inner">
                                    <iframe id="yt-player-small" class="absolute top-0 left-0 w-full h-full"
                                        src="https://www.youtube.com/embed/videoseries?list=PLDs44uukbe3FIDa9CttQLh8N-Nfdpo_hG"
                                        title="Tutoriales ELINA IA" frameborder="0"
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                        allowfullscreen></iframe>
                                </div>
                                <button id="open-tutorials-btn"
                                    class="mt-3 w-full bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200">Ver
                                    en Grande</button>
                            </div>
                        </div>
                        <!-- FIN: Columna lateral reorganizada -->

                        <!-- Configuraci√≥n antigua eliminada -->
                        <!-- El modal de etiquetas se mantiene aqu√≠ para preservar funcionalidad -->
                        <div id="new-labels-modal"
                            class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 px-4">
                            <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
                                <div class="flex items-start justify-between p-6 border-b border-slate-200">
                                    <div>
                                        <h3 class="text-xl font-bold text-slate-900">Configura tus Etiquetas
                                        </h3>
                                        <p class="text-sm text-slate-500 mt-1">Elige un color para cada etiqueta
                                            detectada en el archivo.</p>
                                    </div>
                                    <button id="close-new-labels-btn" class="text-slate-400 hover:text-slate-600"
                                        aria-label="Cerrar">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                <div class="px-6 pt-4 pb-6 overflow-y-auto">
                                    <div class="overflow-x-auto rounded-lg border border-slate-200">
                                        <table class="min-w-full divide-y divide-slate-200">
                                            <thead
                                                class="bg-slate-50 text-left text-sm font-semibold text-slate-600 uppercase tracking-wide">
                                                <tr>
                                                    <th class="px-4 py-3">Etiqueta</th>
                                                    <th class="px-4 py-3">Color</th>
                                                </tr>
                                            </thead>
                                            <tbody id="new-labels-table-body"
                                                class="divide-y divide-slate-200 bg-white text-sm"></tbody>
                                        </table>
                                    </div>
                                    <div id="new-labels-error" class="hidden mt-4 text-sm font-medium text-red-500">
                                    </div>
                                </div>
                                <div class="flex justify-end gap-3 px-6 pb-6 border-t border-slate-200 bg-slate-50">
                                    <button id="cancel-new-labels-btn"
                                        class="py-2 px-4 rounded-lg font-semibold text-slate-700 bg-slate-200 hover:bg-slate-300">Cancelar</button>
                                    <button id="confirm-new-labels-btn"
                                        class="py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700">Guardar
                                        etiquetas</button>
                                </div>
                            </div>
                        </div>

                        <!-- Modal Historial de Versiones -->
                        <div id="prompt-history-modal"
                            class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 px-4">
                            <div
                                class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                                <div class="flex items-center justify-between p-6 border-b border-slate-200">
                                    <h3 class="text-xl font-bold text-slate-900">Historial de Versiones</h3>
                                    <button id="close-history-modal-btn" class="text-slate-400 hover:text-slate-600">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
                                    <div id="prompt-history-list" class="space-y-4">
                                        <!-- Items -->
                                    </div>
                                </div>
                            </div>
                        </div>




                        <!-- Modal Configuraci√≥n de Recordatorios -->
                        <div id="reminders-config-modal"
                            class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 px-4">
                            <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-auto overflow-hidden">
                                <div class="flex items-center justify-between p-4 border-b border-slate-200">
                                    <h3 class="text-lg font-bold text-slate-900">Configurar Recordatorios</h3>
                                    <button id="close-reminders-config-btn" class="text-slate-400 hover:text-slate-600">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                <div class="p-6 space-y-4">
                                    <p class="text-sm text-slate-600">Elige cu√°ndo quieres que tu asistente te recuerde
                                        las tareas pendientes.</p>

                                    <div class="space-y-3">
                                        <label
                                            class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer transition-colors">
                                            <input type="checkbox" id="reminder-48h"
                                                class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                                            <span class="text-sm font-medium text-slate-700">48 horas antes</span>
                                        </label>

                                        <label
                                            class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer transition-colors">
                                            <input type="checkbox" id="reminder-24h"
                                                class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                                            <span class="text-sm font-medium text-slate-700">24 horas antes</span>
                                        </label>

                                        <label
                                            class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer transition-colors">
                                            <input type="checkbox" id="reminder-2h"
                                                class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                                            <span class="text-sm font-medium text-slate-700">2 horas antes</span>
                                        </label>
                                    </div>

                                    <div id="reminders-save-status" class="text-xs font-medium text-center h-4"></div>
                                </div>
                                <div class="p-4 border-t border-slate-200 bg-slate-50 flex justify-end gap-2">
                                    <button id="cancel-reminders-config-btn"
                                        class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-lg transition-colors">Cancelar</button>
                                    <button id="save-reminders-config-btn"
                                        class="px-4 py-2 text-sm font-bold text-white bg-green-600 hover:bg-green-700 rounded-lg transition-colors shadow-sm">Guardar
                                        Preferencias</button>
                                </div>
                            </div>
                        </div>
                        <!-- INICIO: Modal de Ayuda para el Prompt -->
                        <div id="prompt-help-modal"
                            class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[95] p-4">
                            <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                                <div class="p-5 border-b flex justify-between items-center">
                                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i
                                            data-lucide="help-circle" class="text-blue-500"></i>Gu√≠a para un Prompt
                                        Poderoso</h3>
                                    <button id="close-prompt-help-btn" class="p-2 rounded-full hover:bg-slate-100"><i
                                            data-lucide="x" class="w-6 h-6 text-slate-600"></i></button>
                                </div>
                                <div class="flex-grow overflow-y-auto p-8 space-y-6 text-slate-700">
                                    <p>El "prompt" es el cerebro de tu asistente. Son las instrucciones que Elina
                                        seguir√° en cada conversaci√≥n. Un buen prompt es la clave para que act√∫e como un
                                        experto de tu negocio.</p>

                                    <h4 class="text-lg font-semibold text-slate-800 pt-4 border-t">Elementos Clave de un
                                        Buen Prompt:</h4>
                                    <ul class="list-disc list-inside space-y-2">
                                        <li><strong>Rol y Personalidad:</strong> Define qui√©n es. ¬øEs un "asistente de
                                            ventas amigable", un "experto t√©cnico formal"?</li>
                                        <li><strong>Contexto del Negocio:</strong> Explica brevemente qu√© hace tu
                                            empresa, a qui√©n le vende y qu√© problema resuelve.</li>
                                        <li><strong>Reglas y L√≠mites:</strong> ¬øQu√© NUNCA debe hacer? (Ej: "Nunca dar
                                            precios sin preguntar primero el presupuesto"). ¬øQu√© SIEMPRE debe hacer?
                                            (Ej: "Siempre pedir el nombre del cliente").</li>
                                        <li><strong>Tono de Comunicaci√≥n:</strong> ¬øDebe usar emojis? ¬øSer muy formal?
                                            ¬øHablar de "t√∫" o de "usted"?</li>
                                    </ul>

                                    <h4 class="text-lg font-semibold text-slate-800 pt-4 border-t">Ejemplo de un Prompt
                                        Ganador:</h4>
                                    <pre
                                        class="bg-slate-100 p-4 rounded-lg text-sm whitespace-pre-wrap font-mono">Eres un asistente de ventas para "Soluciones Solares MX", una empresa que instala paneles solares para hogares. Tu tono debe ser amigable y educativo. Tu objetivo es calificar al cliente obteniendo su nombre, ciudad y un estimado de su gasto de luz bimestral. NUNCA des un precio final, en su lugar, explica que se necesita una visita t√©cnica y ofrece agendarla. Siempre termina tus mensajes con un emoji de sol ‚òÄÔ∏è.</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel de Contactos -->
                <div id="contacts" class="content-panel">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-8">
                        <div class="space-y-1">
                            <div class="flex items-center gap-3">
                                <h2 class="text-3xl font-black text-slate-800 tracking-tight">Directorio</h2>
                                <span id="contacts-count-badge"
                                    class="hidden bg-slate-100 text-slate-500 text-xs font-bold px-2 py-1 rounded-full border border-slate-200">0</span>
                            </div>
                            <p class="text-sm text-slate-500 font-medium">Gestiona tus prospectos y clientes de
                                WhatsApp.</p>
                        </div>

                        <div class="flex flex-wrap items-center gap-3">
                            <!-- Botones de Acci√≥n R√°pida -->
                            <div class="flex items-center bg-slate-100/50 p-1 rounded-2xl border border-slate-100">
                                <button id="ignore-all-visible-btn"
                                    class="text-slate-600 font-bold py-2 px-4 rounded-xl hover:bg-white hover:text-red-600 hover:shadow-sm transition-all text-xs flex items-center gap-2">
                                    <i data-lucide="user-x" class="w-3.5 h-3.5"></i><span>Desactivar Todo</span>
                                </button>
                                <button id="unignore-all-visible-btn"
                                    class="text-slate-600 font-bold py-2 px-4 rounded-xl hover:bg-white hover:text-emerald-600 hover:shadow-sm transition-all text-xs flex items-center gap-2">
                                    <i data-lucide="user-check" class="w-3.5 h-3.5"></i><span>Activar Todo</span>
                                </button>
                            </div>

                            <!-- Dropdown de Importar/Exportar (Click-based) -->
                            <div class="relative">
                                <button id="more-actions-contacts-btn"
                                    class="bg-white border-2 border-slate-100 text-slate-700 font-bold py-2.5 px-5 rounded-xl hover:border-blue-400 hover:text-blue-600 transition-all text-xs flex items-center gap-2 shadow-sm active:scale-95">
                                    <i data-lucide="layout-grid" class="w-4 h-4"></i>
                                    <span>M√°s Acciones</span>
                                    <i data-lucide="chevron-down" class="w-3.5 h-3.5 opacity-50"></i>
                                </button>

                                <div id="more-actions-contacts-menu"
                                    class="hidden absolute right-0 mt-3 w-64 bg-white rounded-2xl shadow-[0_20px_50px_rgba(0,0,0,0.1)] border border-slate-100 z-[100] py-3 animate-in fade-in zoom-in slide-in-from-top-2 duration-200">
                                    <div class="px-4 py-2 mb-1">
                                        <span
                                            class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Herramientas
                                            de Importaci√≥n</span>
                                    </div>
                                    <button id="import-contacts-btn"
                                        class="w-full text-left px-4 py-3 text-xs font-bold text-slate-600 hover:bg-blue-50 hover:text-blue-600 flex items-center gap-3 transition-colors">
                                        <div
                                            class="w-8 h-8 rounded-lg bg-blue-100/50 flex items-center justify-center text-blue-600">
                                            <i data-lucide="file-up" class="w-4 h-4"></i>
                                        </div>
                                        <div class="flex flex-col">
                                            <span>Subir CSV / Excel</span>
                                            <span class="text-[9px] text-slate-400 font-medium">Carga masiva desde
                                                archivo</span>
                                        </div>
                                    </button>
                                    <button id="import-numbers-label-btn"
                                        class="w-full text-left px-4 py-3 text-xs font-bold text-slate-600 hover:bg-purple-50 hover:text-purple-600 flex items-center gap-3 transition-colors">
                                        <div
                                            class="w-8 h-8 rounded-lg bg-purple-100/50 flex items-center justify-center text-purple-600">
                                            <i data-lucide="hash" class="w-4 h-4"></i>
                                        </div>
                                        <div class="flex flex-col">
                                            <span>Por Etiqueta</span>
                                            <span class="text-[9px] text-slate-400 font-medium">Importar de chats
                                                existentes</span>
                                        </div>
                                    </button>

                                    <div class="h-px bg-slate-50 my-2 mx-4"></div>

                                    <div class="px-4 py-2 mb-1">
                                        <span
                                            class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Respaldo
                                            y Datos</span>
                                    </div>
                                    <button id="export-contacts-btn"
                                        class="w-full text-left px-4 py-3 text-xs font-bold text-slate-600 hover:bg-emerald-50 hover:text-emerald-600 flex items-center gap-3 transition-colors">
                                        <div
                                            class="w-8 h-8 rounded-lg bg-emerald-100/50 flex items-center justify-center text-emerald-600">
                                            <i data-lucide="download-cloud" class="w-4 h-4"></i>
                                        </div>
                                        <div class="flex flex-col">
                                            <span>Exportar Directorio</span>
                                            <span class="text-[9px] text-slate-400 font-medium">Descargar base de
                                                datos</span>
                                        </div>
                                    </button>
                                </div>
                            </div>

                            <input type="file" id="import-contacts-input" class="hidden" accept=".csv,.xlsx,.xls">

                            <button id="sync-contacts-btn"
                                class="bg-blue-600 text-white font-black py-2.5 px-6 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-100 transition-all active:scale-95 text-xs flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i><span>Sincronizar</span>
                            </button>
                        </div>
                    </div>

                    <!-- Barra de B√∫squeda y Filtros Premium -->
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <div class="flex-grow relative group">
                            <i data-lucide="search"
                                class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                            <input type="search" id="contact-search-input" placeholder="Buscar por nombre o tel√©fono..."
                                class="w-full bg-white border-2 border-slate-100 rounded-2xl py-3 pl-11 pr-4 text-sm font-medium text-slate-700 focus:border-blue-400 focus:ring-4 focus:ring-blue-50/50 outline-none transition-all shadow-sm">
                        </div>
                        <div class="relative w-full md:w-64">
                            <select id="contact-label-filter"
                                class="w-full bg-white border-2 border-slate-100 rounded-2xl py-3 pl-4 pr-10 text-sm font-bold text-slate-700 appearance-none focus:border-blue-400 outline-none transition-all shadow-sm cursor-pointer"></select>
                            <i data-lucide="filter"
                                class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>

                    <!-- Contenedor para mensajes de estado -->
                    <div id="contacts-status-container" class="mb-4">
                        <!-- Los mensajes de estado se insertar√°n aqu√≠ -->
                    </div>

                    <!-- Tabla -->
                    <!-- Tabla Premium -->
                    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50/50 border-b border-slate-100">
                                    <tr>
                                        <th class="px-6 py-4 w-12 text-center">
                                            <input type="checkbox" id="select-all-contacts"
                                                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 transition-all cursor-pointer">
                                        </th>
                                        <th class="px-6 py-4 text-xs font-black text-slate-500 uppercase tracking-wider cursor-pointer group hover:text-blue-600 transition-colors"
                                            data-sort="full_name">
                                            <div class="flex items-center gap-2">
                                                <span>Contacto</span>
                                                <span
                                                    class="sort-indicator opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <i data-lucide="arrow-up-down" class="w-3 h-3"></i>
                                                </span>
                                            </div>
                                        </th>
                                        <th class="px-6 py-4 text-xs font-black text-slate-500 uppercase tracking-wider cursor-pointer group hover:text-blue-600 transition-colors"
                                            data-sort="phone_number">
                                            <div class="flex items-center gap-2">
                                                <span>WhatsApp</span>
                                                <span
                                                    class="sort-indicator opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <i data-lucide="arrow-up-down" class="w-3 h-3"></i>
                                                </span>
                                            </div>
                                        </th>
                                        <th class="px-6 py-4 text-xs font-black text-slate-500 uppercase tracking-wider cursor-pointer group hover:text-blue-600 transition-colors"
                                            data-sort="labels">
                                            <div class="flex items-center gap-2">
                                                <span>Categor√≠a / Etiquetas</span>
                                                <span
                                                    class="sort-indicator opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <i data-lucide="arrow-up-down" class="w-3 h-3"></i>
                                                </span>
                                            </div>
                                        </th>
                                        <th
                                            class="px-6 py-4 text-xs font-black text-slate-500 uppercase tracking-wider text-center">
                                            Omitir IA</th>
                                        <th
                                            class="px-6 py-4 text-xs font-black text-slate-500 uppercase tracking-wider text-center">
                                            IA Insight</th>
                                        <th
                                            class="px-6 py-4 text-xs font-black text-slate-500 uppercase tracking-wider text-center">
                                            Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="contacts-table-body" class="divide-y divide-slate-50">
                                    <!-- Cargado din√°micamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Loader y Estado -->
                    <div id="contacts-loader" class="py-20 text-center hidden">
                        <div
                            class="inline-flex items-center gap-3 px-6 py-3 bg-white rounded-2xl shadow-sm border border-slate-100">
                            <i data-lucide="loader-2" class="w-5 h-5 text-blue-500 animate-spin"></i>
                            <span class="text-sm font-bold text-slate-600">Actualizando directorio...</span>
                        </div>
                    </div>

                    <!-- Paginaci√≥n -->
                    <div id="contacts-pagination" class="mt-8 flex items-center justify-between"></div>

                    <!-- Barra de Acciones Masivas (Flotante) -->
                    <div id="bulk-actions-bar"
                        class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur-md text-white px-8 py-4 rounded-3xl shadow-2xl z-[100] border border-white/10 animate-in fade-in slide-in-from-bottom-5 duration-300">
                        <div class="flex items-center gap-8">
                            <div class="flex flex-col">
                                <span id="selected-count" class="text-sm font-black tracking-tight">0
                                    Seleccionados</span>
                                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Acciones
                                    Masivas</span>
                            </div>
                            <div class="h-8 w-px bg-white/10"></div>
                            <div class="flex items-center gap-3">
                                <button id="bulk-ignore-selected-btn"
                                    class="bg-white/10 hover:bg-red-500 hover:text-white text-slate-300 font-bold py-2 px-6 rounded-xl transition-all text-xs flex items-center gap-2 border border-white/5">
                                    <i data-lucide="user-x" class="w-4 h-4"></i>
                                    <span>Desactivar IA</span>
                                </button>
                                <button id="bulk-unignore-selected-btn"
                                    class="bg-white/10 hover:bg-emerald-500 hover:text-white text-slate-300 font-bold py-2 px-6 rounded-xl transition-all text-xs flex items-center gap-2 border border-white/5">
                                    <i data-lucide="user-check" class="w-4 h-4"></i>
                                    <span>Activar IA</span>
                                </button>
                                <button id="bulk-edit-labels-btn"
                                    class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-xl transition-all text-xs flex items-center gap-2 shadow-lg shadow-blue-500/20">
                                    <i data-lucide="tag" class="w-4 h-4"></i>
                                    <span>Asignar Etiqueta</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Nota visual -->
                    <p class="text-xs text-slate-500 mt-3">
                        ‚Ä¢ <b>Ignorar IA</b> se prende si el contacto tiene la etiqueta <code>ignorar</code>.<br>
                        ‚Ä¢ La etiqueta <code>todos</code> no se muestra aqu√≠ (solo se usa en Env√≠o Masivo).<br>
                        ‚Ä¢ Puedes editar etiquetas con el bot√≥n ‚ÄúEditar etiquetas‚Äù.
                    </p>
                </div>

                <!-- Panel de Marketing / Env√≠o Masivo -->
                <div id="bulk-sending" class="content-panel max-w-6xl mx-auto px-4 sm:px-6" data-placeholder="true">
                    <div class="flex flex-col lg:flex-row gap-10">
                        <!-- Columna Principal: Creaci√≥n de Campa√±a -->
                        <div class="lg:col-span-2 flex-grow space-y-8">
                            <header class="relative">
                                <span
                                    class="text-xs font-bold text-blue-600 uppercase tracking-widest bg-blue-50 px-3 py-1 rounded-full border border-blue-100 mb-3 inline-block">Marketing
                                    Engine</span>
                                <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">Crear Campa√±a</h1>
                                <p class="text-slate-500 text-lg mt-2 font-medium">Llega a tus clientes de manera
                                    personalizada y efectiva.</p>
                                <div
                                    class="absolute -top-4 -left-4 w-20 h-20 bg-blue-400/10 rounded-full blur-3xl -z-10">
                                </div>
                            </header>

                            <form id="bulk-send-form"
                                class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-[0_20px_50px_rgba(0,0,0,0.05)] border border-white/50 p-6 sm:p-10 space-y-10 relative overflow-hidden">
                                <!-- Decorative Accent Line -->
                                <div
                                    class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-400 via-indigo-500 to-purple-600">
                                </div>

                                <!-- Mensaje Principal -->
                                <div class="space-y-4">
                                    <div class="flex justify-between items-end">
                                        <div>
                                            <label for="bulk-message"
                                                class="block text-sm font-bold text-slate-800 ml-1">Contenido del
                                                Mensaje</label>
                                            <p class="text-xs text-slate-400 mt-1 ml-1">Personaliza con <code
                                                    class="text-blue-600 bg-blue-50 px-1 rounded">%nombre%</code></p>
                                        </div>
                                        <button type="button" id="bulk-ai-enhance-btn"
                                            class="group flex items-center gap-2 px-4 py-2 text-sm font-bold text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 rounded-2xl transition-all shadow-lg shadow-purple-200 ring-2 ring-purple-100 active:scale-95">
                                            <i data-lucide="sparkles"
                                                class="w-4 h-4 group-hover:rotate-12 transition-transform"></i>
                                            <span>Perfeccionar con AI</span>
                                        </button>
                                    </div>
                                    <div class="group relative">
                                        <textarea id="bulk-message"
                                            class="w-full bg-slate-50/50 border-2 border-slate-100 rounded-2xl p-5 text-slate-700 placeholder-slate-400 focus:ring-4 focus:ring-blue-100 focus:border-blue-400 transition-all resize-y min-h-[200px] text-base leading-relaxed"
                                            placeholder="Escribe tu propuesta irresistible aqu√≠..."></textarea>
                                        <div
                                            class="absolute bottom-4 right-4 text-[10px] font-bold text-slate-300 uppercase tracking-wider group-focus-within:text-blue-400 transition-colors">
                                            Markdown Ready</div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button type="button" id="personalize-name-btn"
                                            class="text-xs bg-white hover:bg-slate-50 text-slate-600 font-bold py-2 px-4 rounded-xl transition-all border border-slate-200 flex items-center gap-2 hover:border-blue-300 hover:text-blue-600 shadow-sm">
                                            <i data-lucide="user-plus" class="w-3.5 h-3.5"></i> Insertar %nombre%
                                        </button>
                                    </div>
                                </div>

                                <!-- Archivo Adjunto (Premium Dropzone) -->
                                <div class="space-y-4">
                                    <label class="block text-sm font-bold text-slate-800 ml-1">Material Multimedia <span
                                            class="text-slate-400 font-normal">(Opcional)</span></label>

                                    <div id="file-drop-area" class="relative group">
                                        <input type="file" id="bulk-file-input" accept="image/*,video/*"
                                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                                        <div
                                            class="border-3 border-dashed border-slate-100 hover:border-blue-400 hover:bg-blue-50/30 rounded-3xl p-10 transition-all text-center bg-slate-50/50 group-hover:shadow-inner flex flex-col items-center">
                                            <div
                                                class="w-16 h-16 bg-white rounded-2xl shadow-sm text-blue-600 flex items-center justify-center mb-4 group-hover:scale-110 group-hover:bg-blue-600 group-hover:text-white transition-all duration-300">
                                                <i data-lucide="image-plus" class="w-8 h-8"></i>
                                            </div>
                                            <p class="text-base font-bold text-slate-800">Sube una imagen o video
                                                promocional</p>
                                            <p class="text-sm text-slate-500 mt-1">Arrastra archivos aqu√≠ o haz clic
                                                para explorar</p>
                                            <div class="mt-4 flex gap-3">
                                                <span
                                                    class="text-[10px] font-bold text-slate-400 border border-slate-200 px-2 py-0.5 rounded uppercase">JPG,
                                                    PNG</span>
                                                <span
                                                    class="text-[10px] font-bold text-slate-400 border border-slate-200 px-2 py-0.5 rounded uppercase">MP4,
                                                    MOV</span>
                                                <span
                                                    class="text-[10px] font-bold text-slate-400 border border-slate-200 px-2 py-0.5 rounded uppercase">Hasta
                                                    25MB</span>
                                            </div>
                                        </div>

                                        <!-- Preview Card Overlay -->
                                        <div id="file-preview"
                                            class="hidden absolute inset-0 bg-white z-20 flex flex-col items-center justify-center rounded-3xl border border-slate-200 p-2 overflow-hidden animate-in fade-in zoom-in duration-300">
                                            <div
                                                class="relative w-full h-full bg-slate-900 rounded-2xl flex items-center justify-center">
                                                <img id="file-image-preview"
                                                    class="max-h-full max-w-full rounded-lg object-contain"
                                                    alt="Preview">
                                                <div
                                                    class="absolute bottom-4 left-4 right-4 flex items-center justify-between bg-black/40 backdrop-blur-md p-3 rounded-2xl border border-white/20">
                                                    <div class="flex items-center gap-2 overflow-hidden">
                                                        <i data-lucide="file-check"
                                                            class="w-4 h-4 text-emerald-400 flex-shrink-0"></i>
                                                        <span id="file-name"
                                                            class="text-xs font-bold text-white truncate max-w-[150px]">nombre-archivo.jpg</span>
                                                    </div>
                                                    <button type="button" id="remove-file-btn"
                                                        class="bg-red-500/80 hover:bg-red-600 text-white p-2 rounded-xl active:scale-95 transition-all pointer-events-auto">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Segmentaci√≥n y Configuraci√≥n -->
                                <div
                                    class="p-8 bg-gradient-to-br from-slate-50 to-blue-50/30 rounded-3xl border border-slate-100/50 space-y-8">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center shadow-sm">
                                            <i data-lucide="users" class="w-4 h-4"></i>
                                        </div>
                                        <h3 class="text-lg font-bold text-slate-800">Segmentaci√≥n de Audiencia</h3>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div class="space-y-3">
                                            <label for="include-labels"
                                                class="block text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">Incluir
                                                Etiquetas</label>
                                            <div class="relative">
                                                <select id="include-labels"
                                                    class="w-full bg-white border-2 border-slate-100 rounded-2xl py-3.5 pl-4 pr-12 text-sm font-semibold text-slate-700 focus:ring-4 focus:ring-blue-100 focus:border-blue-400 shadow-sm appearance-none cursor-pointer">
                                                    <!-- Options via JS -->
                                                </select>
                                                <i data-lucide="chevron-down"
                                                    class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none"></i>
                                            </div>
                                        </div>
                                        <div class="space-y-3">
                                            <label for="exclude-labels"
                                                class="block text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">Excluir
                                                Etiquetas</label>
                                            <div class="relative">
                                                <select id="exclude-labels"
                                                    class="w-full bg-white border-2 border-slate-100 rounded-2xl py-3.5 pl-4 pr-12 text-sm font-semibold text-slate-700 focus:ring-4 focus:ring-red-50 sm:focus:ring-red-100 focus:border-red-400 shadow-sm appearance-none cursor-pointer">
                                                    <!-- Options via JS -->
                                                </select>
                                                <i data-lucide="filter-x"
                                                    class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="pt-4 space-y-4">
                                        <label
                                            class="block text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">Programaci√≥n
                                            del Env√≠o</label>
                                        <div class="flex flex-col sm:flex-row gap-4">
                                            <div class="flex-grow flex gap-2">
                                                <div class="relative flex-grow">
                                                    <input type="date" id="bulk-schedule-date"
                                                        class="w-full bg-white border-2 border-slate-100 rounded-2xl py-3.5 px-4 text-sm font-semibold text-slate-700 focus:ring-4 focus:ring-blue-100 shadow-sm">
                                                </div>
                                                <div class="relative w-32">
                                                    <input type="time" id="bulk-schedule-time"
                                                        class="w-full bg-white border-2 border-slate-100 rounded-2xl py-3.5 px-4 text-sm font-semibold text-slate-700 focus:ring-4 focus:ring-blue-100 shadow-sm">
                                                </div>
                                            </div>
                                            <div
                                                class="sm:w-64 bg-amber-50 rounded-2xl p-3.5 flex items-center gap-3 border border-amber-100 shadow-sm">
                                                <i data-lucide="clock" class="w-5 h-5 text-amber-600"></i>
                                                <span class="text-xs font-bold text-amber-900 leading-tight">Aleatorio
                                                    (1-3 min) <br><span class="font-medium text-amber-700/80">Evita
                                                        bloqueos de WhatsApp</span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Botones de Acci√≥n -->
                                <div class="flex flex-col sm:flex-row justify-end gap-4 pt-4">
                                    <button type="button" id="bulk-test-btn"
                                        class="group bg-white hover:bg-slate-50 text-slate-700 font-bold py-4 px-8 rounded-2xl transition-all border border-slate-200 flex items-center justify-center gap-3 shadow-md hover:shadow-lg active:scale-95">
                                        <i data-lucide="beaker"
                                            class="w-5 h-5 text-indigo-500 group-hover:scale-110 transition-transform"></i>
                                        <span>Probar Env√≠o</span>
                                    </button>
                                    <button type="submit" id="bulk-submit-btn"
                                        class="min-w-[200px] bg-gradient-to-br from-blue-600 via-blue-700 to-indigo-800 hover:from-blue-700 hover:to-indigo-900 text-white font-black py-4 px-10 rounded-2xl shadow-xl shadow-blue-500/40 transform transition-all hover:-translate-y-1 active:scale-95 flex items-center justify-center gap-3 relative overflow-hidden group">
                                        <div
                                            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:animate-[shimmer_2s_infinite]">
                                        </div>
                                        <span class="button-text flex items-center gap-3"><i data-lucide="rocket"
                                                class="w-5 h-5"></i> INICIAR CAMPA√ëA</span>
                                        <div
                                            class="loading-spinner hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white">
                                        </div>
                                    </button>
                                    <button type="button" id="bulk-stop-btn"
                                        class="hidden bg-gradient-to-r from-red-500 to-red-700 text-white font-black py-4 px-8 rounded-2xl shadow-xl shadow-red-500/30 hover:shadow-red-500/50 transition-all flex items-center justify-center gap-3 active:scale-95">
                                        <i data-lucide="octagon-minus" class="w-5 h-5 animate-pulse"></i>
                                        <span>DETENER AHORA</span>
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Panel Lateral: Recursos y Ayuda -->
                        <div class="lg:w-80 space-y-8 flex-shrink-0">
                            <!-- Safe Usage Card -->
                            <div
                                class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-3xl p-6 text-white shadow-xl shadow-emerald-500/20 relative overflow-hidden">
                                <i data-lucide="shield-check"
                                    class="absolute -right-4 -top-4 w-24 h-24 text-white/10 rotate-12"></i>
                                <h4 class="text-lg font-black flex items-center gap-2 mb-3">
                                    <i data-lucide="info" class="w-5 h-5"></i>
                                    Regla de Oro
                                </h4>
                                <p class="text-sm text-emerald-50 font-medium leading-relaxed">
                                    Para evitar bloqueos, env√≠a solo a personas que te tengan agregado o esperen tu
                                    contacto.
                                </p>
                                <div class="mt-4 bg-black/10 rounded-xl p-3 border border-white/10">
                                    <div class="flex justify-between text-[10px] font-black uppercase mb-1">
                                        <span>Prioridad de Seguridad</span>
                                        <span class="text-emerald-300">M√°xima</span>
                                    </div>
                                    <div class="w-full h-1.5 bg-emerald-900/40 rounded-full overflow-hidden">
                                        <div class="w-full h-full bg-emerald-300"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tutorial Card -->
                            <div
                                class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 p-2 group hover:shadow-2xl transition-all duration-500">
                                <div class="relative rounded-2xl overflow-hidden aspect-video">
                                    <iframe class="w-full h-full" src="https://www.youtube.com/embed/UPvbbiiOCao"
                                        title="Tutorial" frameborder="0"
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                        allowfullscreen></iframe>
                                    <div
                                        class="absolute inset-0 bg-gradient-to-t from-slate-900/60 to-transparent pointer-events-none group-hover:opacity-0 transition-opacity">
                                    </div>
                                    <div
                                        class="absolute bottom-3 left-4 pointer-events-none group-hover:opacity-0 transition-opacity">
                                        <p class="text-white text-xs font-black uppercase tracking-wider">Aprende a
                                            usarlo</p>
                                        <p class="text-white/80 text-[10px]">Gu√≠a paso a paso</p>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <h5 class="text-sm font-bold text-slate-800">Masterclass Campa√±as</h5>
                                    <button
                                        class="mt-3 w-full py-2 bg-slate-50 hover:bg-slate-100 text-slate-500 text-xs font-bold rounded-xl border border-slate-100 transition-colors">Ver
                                        en YouTube</button>
                                </div>
                            </div>

                            <!-- Stats Widget -->
                            <div class="bg-slate-900 rounded-3xl p-6 text-white shadow-2xl shadow-blue-900/20">
                                <h4 class="text-xs font-black text-blue-400 uppercase tracking-widest mb-6">Estado de
                                    Env√≠o</h4>
                                <div class="space-y-6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                                            <span class="text-xs font-bold text-slate-300">Env√≠os Diarios</span>
                                        </div>
                                        <span class="text-sm font-black text-white">500 Limite</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_#3b82f6]">
                                            </div>
                                            <span class="text-xs font-bold text-slate-300">Simult√°neos</span>
                                        </div>
                                        <span class="text-sm font-black text-white">1 Activo</span>
                                    </div>
                                </div>
                                <button
                                    class="w-full mt-8 py-3 bg-blue-600 hover:bg-blue-700 text-white text-xs font-black rounded-xl shadow-lg shadow-blue-500/30 transition-all active:scale-95">VER
                                    HISTORIAL COMPLETO</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel de Afiliados (Nuevo) -->
                <div id="affiliate-panel" class="content-panel max-w-6xl mx-auto">
                    <header class="mb-8">
                        <h2 class="text-3xl font-bold text-slate-800">Panel de Afiliado</h2>
                        <p class="text-slate-500">Gestiona tus referidos y visualiza tus ganancias.</p>
                    </header>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                            <h4 class="text-sm font-semibold text-slate-500 uppercase">Referidos Totales</h4>
                            <p id="affiliate-total-referrals" class="text-4xl font-bold text-slate-800 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                            <h4 class="text-sm font-semibold text-slate-500 uppercase">Referidos Activos</h4>
                            <p id="affiliate-active-referrals" class="text-4xl font-bold text-green-600 mt-2">0</p>
                            <p class="text-xs text-slate-400 mt-1">Usuarios pagando suscripci√≥n</p>
                        </div>
                        <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white p-6 rounded-xl shadow-md">
                            <h4 class="text-sm font-semibold text-cyan-400 uppercase">Comisi√≥n Mensual Est.</h4>
                            <p id="affiliate-monthly-commission" class="text-4xl font-bold mt-2">$0.00 MXN</p>
                            <p class="text-xs text-slate-400 mt-1">20% de recurrencia activa</p>
                        </div>
                    </div>

                    <!-- Tabla de Referidos -->
                    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-lg">Tus Referidos</h3>
                            <button id="request-withdrawal-btn"
                                class="bg-gradient-to-r from-green-500 to-emerald-600 text-white text-sm font-bold py-2 px-4 rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all shadow-md shadow-green-500/30 flex items-center gap-2">
                                <i data-lucide="banknote" class="w-4 h-4"></i>
                                Solicitar Retiro
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="p-4 font-semibold text-slate-600">Usuario</th>
                                        <th class="p-4 font-semibold text-slate-600">Fecha Registro</th>
                                        <th class="p-4 font-semibold text-slate-600">Estado</th>
                                        <th class="p-4 font-semibold text-slate-600">Plan</th>
                                    </tr>
                                </thead>
                                <tbody id="referrals-table-body" class="divide-y divide-slate-100">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Historial de Retiros -->
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="font-bold text-lg flex items-center gap-2">
                                <i data-lucide="history" class="w-5 h-5 text-slate-400"></i>
                                Historial de Retiros
                            </h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="p-3 font-semibold text-slate-500 text-xs uppercase">Fecha</th>
                                        <th class="p-3 font-semibold text-slate-500 text-xs uppercase">Monto</th>
                                        <th class="p-3 font-semibold text-slate-500 text-xs uppercase">Estado</th>
                                        <th class="p-3 font-semibold text-slate-500 text-xs uppercase">Notas</th>
                                    </tr>
                                </thead>
                                <tbody id="withdrawal-history-body" class="divide-y divide-slate-100">
                                    <!-- Rows populated by affiliate-panel.js -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Contenedor para el panel de Etiquetas IA. Se cargar√° din√°micamente. -->
                <div id="smart-labels" class="content-panel max-w-[1600px] mx-auto" data-placeholder="true"></div>

                <!-- Panel Kanban -->
                <div id="kanban" class="content-panel flex flex-col h-full">
                    <!-- Cabecera del Kanban -->
                    <div
                        class="w-full bg-slate-800 text-white p-3 shadow-md flex flex-wrap justify-between items-center gap-4 rounded-t-lg flex-shrink-0">
                        <button id="back-to-dashboard-btn"
                            class="font-semibold py-2 px-4 rounded-lg text-sm bg-slate-700 hover:bg-slate-600 flex items-center gap-2 text-white">
                            <i data-lucide="arrow-left" class="w-4 h-4 text-white"></i>
                            <span>Dashboard</span>
                        </button>
                        <h2 class="text-xl font-bold">Kanban</h2>
                        <div id="kanban-controls" class="flex items-center gap-3"></div>
                    </div>
                    <!-- Contenedor del tablero Kanban -->
                    <div id="kanban-board" class="flex-1 flex flex-wrap content-start overflow-y-auto p-2 bg-slate-200">
                        <div id="kanban-loader" class="w-full text-center p-8">Cargando...</div>
                    </div>
                </div>

                <!-- Contenedor para el panel de Seguimientos. Se cargar√° din√°micamente. -->
                <div id="follow-ups" class="content-panel max-w-5xl mx-auto">
                    <!-- Contenido de follow-ups.html -->
                    <div id="follow-ups-access-denied" class="hidden bg-white rounded-xl shadow-md p-8 text-center">
                        <i data-lucide="lock" class="w-16 h-16 mx-auto text-slate-400 mb-4"></i>
                        <h3 class="text-xl font-bold">Funci√≥n Exclusiva del Plan Grow</h3>
                        <p class="text-slate-500 mt-2 max-w-md mx-auto">Automatiza tus seguimientos y nunca m√°s pierdas
                            una venta por falta de atenci√≥n. ¬°Desbloquea esta funci√≥n mejorando tu plan!</p>
                        <button id="upgrade-to-grow-from-followups"
                            class="mt-6 bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700">
                            Mejorar a Plan Grow
                        </button>
                    </div>
                    <!-- INICIO: Modal para crear/editar secuencia de seguimiento -->
                    <div id="sequence-modal"
                        class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                            <div class="p-6 border-b flex justify-between items-center">
                                <h3 id="sequence-modal-title" class="text-xl font-bold">Crear Nueva Secuencia</h3>
                                <button id="cancel-sequence-btn" class="p-2 rounded-full hover:bg-slate-100"><i
                                        data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <form id="sequence-form" class="flex-grow overflow-y-auto p-6 space-y-6">
                                <input type="hidden" id="sequence-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="sequence-target-label"
                                            class="block text-sm font-medium text-slate-700">Etiqueta de
                                            Activaci√≥n</label>
                                        <div class="custom-select-wrapper mt-1">
                                            <select id="sequence-target-label" required
                                                class="custom-select form-input"></select>
                                            <i data-lucide="tag" class="select-icon w-5 h-5 text-slate-400"></i>
                                        </div>
                                        <p class="text-xs text-slate-500 mt-1">La secuencia iniciar√° cuando un contacto
                                            reciba esta etiqueta.</p>
                                    </div>
                                    <div class="pt-6">
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="sequence-is-active" class="sr-only peer" checked>
                                            <div
                                                class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                            </div>
                                            <span class="ml-3 text-sm font-medium text-slate-700">Activar secuencia al
                                                guardar</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-md font-semibold mb-2">Mensajes de la Secuencia (M√°x. 3)</h4>
                                    <div id="messages-container" class="space-y-4"></div>
                                    <button type="button" id="add-message-btn"
                                        class="mt-4 text-sm text-blue-600 hover:underline font-semibold flex items-center gap-1"><i
                                            data-lucide="plus-circle" class="w-4 h-4"></i> A√±adir Mensaje</button>
                                </div>
                            </form>
                            <div class="p-6 bg-slate-50 flex justify-between items-center rounded-b-lg">
                                <button type="button" id="delete-sequence-btn"
                                    class="hidden bg-red-100 text-red-700 font-bold py-2 px-4 rounded-lg hover:bg-red-200">Eliminar</button>
                                <button type="submit" id="save-sequence-btn" form="sequence-form"
                                    class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Guardar
                                    Secuencia</button>
                            </div>
                        </div>
                    </div>
                    <template id="message-step-template">
                        <div class="message-step bg-slate-100 p-4 rounded-lg border">
                            <div class="flex justify-between items-center mb-3">
                                <h5 class="font-semibold">Mensaje #<span class="step-number">1</span></h5>
                                <button type="button"
                                    class="remove-step-btn text-red-500 hover:text-red-700 p-1 rounded-full"><i
                                        data-lucide="x-circle" class="w-5 h-5 pointer-events-none"></i></button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-slate-600 mb-1">Contenido del
                                        Mensaje</label>
                                    <textarea class="step-message form-input w-full" rows="4"
                                        placeholder="Escribe tu mensaje de seguimiento..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">Enviar despu√©s
                                        de</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" class="step-delay form-input w-24" min="1" value="24">
                                        <span class="text-sm text-slate-600">horas</span>
                                    </div>
                                    <p class="text-xs text-slate-400 mt-1">Si el contacto no responde.</p>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-slate-600 mb-1">Adjuntar archivo
                                            (opcional)</label>
                                        <input type="file" class="step-file-input hidden"
                                            accept="image/*,video/*,audio/*">
                                        <button type="button"
                                            class="upload-file-btn text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-2 rounded-md">Seleccionar</button>
                                        <span class="file-name-display text-xs text-slate-500 ml-2 truncate"></span>
                                        <img class="step-image-preview hidden max-h-16 mt-2 rounded" alt="Vista previa">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                    <!-- FIN: Modal para crear/editar secuencia de seguimiento -->
                    <div id="follow-ups-container" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl sm:text-3xl font-bold">Secuencias de Seguimiento</h2>
                            <button id="add-sequence-btn"
                                class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Nueva Secuencia
                            </button>
                        </div>
                        <div id="followups-list" class="space-y-4">
                            <div id="followups-loader" class="text-center text-slate-500 p-8">Cargando secuencias...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel de Respuestas Programadas (NUEVO) -->
                <div id="auto-responses" class="content-panel max-w-5xl mx-auto">
                    <div id="auto-responses-content">
                        <!-- Se cargar√° din√°micamente desde auto-responses.js -->
                    </div>
                </div>

                <!-- Panel de Entrenamiento de Prompt (NUEVO) -->
                <div id="prompt-training" class="content-panel max-w-7xl mx-auto">
                    <div id="prompt-training-content">
                        <!-- Se cargar√° din√°micamente desde prompt-training.js -->
                    </div>
                </div>

                <!-- Panel de Memoria / Asistente IA (NUEVO) -->
                <div id="ai-memory" class="content-panel max-w-7xl mx-auto">
                    <div id="ai-memory-content">
                        <!-- Se cargar√° din√°micamente desde prompt-training.js -->
                    </div>
                </div>

                <!-- Panel de Flujos Personalizados (NUEVO) -->
                <div id="ai-flows" class="content-panel max-w-7xl mx-auto">
                    <div id="ai-flows-content">
                        <!-- Se cargar√° din√°micamente desde prompt-training.js o flow-builder.js -->
                    </div>
                </div>

                <!-- Panel de Contexto de Ventas (NUEVO) -->
                <!-- Panel Contexto de Ventas -->
                <div id="sales-context" class="content-panel hidden max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                        <div>
                            <p class="text-sm uppercase font-semibold text-slate-400">Promociones & scripts</p>
                            <h2 class="text-3xl font-black text-slate-900 tracking-tight">Contexto Comercial</h2>
                            <p class="text-slate-500 font-medium mt-1">
                                Describe la oferta, objeciones y ganchos prioritarios para que la IA los use
                                autom√°ticamente en ventas.
                            </p>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 space-y-6">
                        <form id="sales-context-form" class="space-y-5">
                            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                                <p class="text-sm text-blue-800">
                                    <strong>üí° ¬øQu√© es el Contexto de Ventas?</strong><br>
                                    Configura c√≥mo la IA debe responder a objeciones comunes de tus clientes.
                                    La IA detectar√° autom√°ticamente estas objeciones y usar√° las respuestas que
                                    configures aqu√≠.
                                </p>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">
                                    Objeciones detectadas autom√°ticamente
                                </label>
                                <div id="sales-context-detected-objections"
                                    class="bg-slate-50 border border-slate-200 rounded-xl p-4 min-h-[100px]">
                                    <p class="text-sm text-slate-600 mb-3">
                                        <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                                        La IA detectar√° autom√°ticamente objeciones comunes como:
                                    </p>
                                    <div id="objections-list" class="space-y-2">
                                        <!-- Las objeciones se cargar√°n din√°micamente aqu√≠ -->
                                    </div>
                                    <button type="button" id="add-objection-btn"
                                        class="mt-3 text-sm text-blue-600 hover:text-blue-700 font-semibold flex items-center gap-2">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                        Agregar objeci√≥n personalizada
                                    </button>
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    <strong>¬øC√≥mo funciona?</strong> La IA detecta autom√°ticamente cuando un cliente
                                    dice estas objeciones y usa las respuestas que configuraste.
                                    Puedes editar haciendo clic en el √≠cono de l√°piz ‚úèÔ∏è, generar respuestas autom√°ticas
                                    con el bot√≥n de IA ü§ñ, o eliminar con la X.
                                </p>
                            </div>

                            <!-- Mensajes Cr√≠ticos -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">
                                    üö® Mensajes Cr√≠ticos
                                </label>
                                <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-3">
                                    <p class="text-sm text-amber-800">
                                        <strong>¬øQu√© son los mensajes cr√≠ticos?</strong><br>
                                        Cuando un cliente env√≠a un mensaje cr√≠tico, la conversaci√≥n se pausa
                                        autom√°ticamente y recibes una notificaci√≥n.
                                        Un humano debe responder en lugar de la IA.
                                    </p>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Cr√≠ticos Predefinidos -->
                                    <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 mb-4">
                                        <h4 class="text-sm font-semibold text-slate-700 mb-3">Cr√≠ticos Predefinidos</h4>
                                        <div id="predefined-critical-rules" class="space-y-2">
                                            <!-- Se cargar√°n din√°micamente -->
                                        </div>
                                    </div>

                                    <!-- Cr√≠ticos Personalizados -->
                                    <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="text-sm font-semibold text-slate-700">Cr√≠ticos Personalizados
                                            </h4>
                                            <button type="button" id="add-critical-rule-btn"
                                                class="text-sm text-blue-600 hover:text-blue-700 font-semibold flex items-center gap-2">
                                                <i data-lucide="plus" class="w-4 h-4"></i> Agregar cr√≠tico
                                            </button>
                                        </div>
                                        <div id="custom-critical-rules" class="space-y-2">
                                            <!-- Se cargar√°n din√°micamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4 space-y-4">
                                <!-- Switches Section -->
                                <div class="flex flex-wrap gap-6">
                                    <div id="sales-context-active-switch"
                                        class="flex items-start gap-3 cursor-pointer group" data-active="true">
                                        <div
                                            class="switch-track relative w-11 h-6 flex-shrink-0 bg-slate-200 rounded-full transition-colors duration-200 flex items-center">
                                            <div
                                                class="switch-thumb absolute left-[2px] w-5 h-5 bg-white border border-slate-300 rounded-full transition-transform duration-200 shadow-sm">
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <span class="text-sm font-semibold text-slate-700">Activo</span>
                                            <p class="text-xs text-slate-500">La IA lo usar√° en todas las conversaciones
                                            </p>
                                        </div>
                                    </div>
                                    <div id="sales-context-auto-generate-switch"
                                        class="flex items-start gap-3 cursor-pointer group" data-active="true">
                                        <div
                                            class="switch-track relative w-11 h-6 flex-shrink-0 bg-slate-200 rounded-full transition-colors duration-200 flex items-center">
                                            <div
                                                class="switch-thumb absolute left-[2px] w-5 h-5 bg-white border border-slate-300 rounded-full transition-transform duration-200 shadow-sm">
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <span class="text-sm font-semibold text-slate-700">Auto-Generar</span>
                                            <p class="text-xs text-slate-500">Generar respuestas autom√°ticamente con IA
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center justify-between pt-4 border-t border-slate-100">
                                <button type="button" id="sales-context-clear"
                                    class="text-sm text-slate-500 hover:text-slate-700 flex items-center gap-1 font-medium">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Limpiar
                                </button>
                                <button type="submit" id="sales-context-save-btn"
                                    class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 shadow-sm transition-all active:scale-95 flex items-center gap-2">
                                    <i data-lucide="save" class="w-4 h-4"></i> Guardar Contexto
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Contenedor para el panel de Plantillas. Se cargar√° din√°micamente. -->
                <div id="templates" class="content-panel max-w-5xl mx-auto">
                    <!-- Contenido de templates.html -->
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">Plantillas de Mensajes</h2>
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-xl font-semibold mb-4">Plantillas Base</h3>
                            <div id="base-templates-container"
                                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold">Mis Plantillas Personalizadas</h3>
                                <button id="add-template-btn"
                                    class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i> Nueva Plantilla
                                </button>
                            </div>
                            <div id="new-template-form-container" class="hidden bg-white p-6 rounded-lg shadow-md mb-6">
                                <form id="new-template-form" class="space-y-4">
                                    <input type="text" id="new-template-name" placeholder="Nombre de la plantilla"
                                        class="form-input w-full" required>
                                    <textarea id="new-template-content" rows="4" placeholder="Contenido del mensaje..."
                                        class="form-input w-full" required></textarea>
                                    <div class="flex justify-end gap-2">
                                        <button type="button" id="cancel-new-template-btn"
                                            class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                                        <button type="submit"
                                            class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Guardar</button>
                                    </div>
                                </form>
                            </div>
                            <div id="custom-templates-container" class="space-y-4"></div>
                        </div>
                    </div>
                </div>

                <!-- Panel de Cotizaciones -->
                <div id="quotes" class="content-panel max-w-7xl mx-auto">
                    <!-- Contenido de Cotizaciones -->
                    <div class="flex flex-col gap-4 mb-6">
                        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                            <div>
                                <h2 class="text-2xl sm:text-3xl font-bold">Cotizaciones</h2>
                                <p class="text-slate-500 mt-1">Gestiona y env√≠a cotizaciones a tus clientes</p>
                            </div>
                            <div class="flex gap-2 items-center">
                                <!-- Toggle para activar IA en cotizaciones -->
                                <div
                                    class="flex items-center gap-2 mr-2 bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100 h-[40px]">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="ai-quotes-toggle" class="sr-only peer">
                                        <div
                                            class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600">
                                        </div>
                                        <span class="ml-2 text-sm font-medium text-blue-800 whitespace-nowrap">IA
                                            Cotiza</span>
                                    </label>
                                </div>

                                <button id="quote-settings-btn"
                                    class="px-4 py-2 bg-slate-600 text-white font-semibold rounded-lg hover:bg-slate-700 transition-colors flex items-center gap-2">
                                    <i data-lucide="settings" class="w-4 h-4"></i>
                                    Personalizar PDF
                                </button>
                                <button id="new-quote-btn"
                                    class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    Nueva Cotizaci√≥n
                                </button>
                            </div>
                        </div>

                        <!-- Filtros -->
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="quote-search" placeholder="Buscar por ID o contacto..."
                                class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <select id="quote-status-filter"
                                class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="all">Todos los estados</option>
                                <option value="draft">Borrador</option>
                                <option value="sent">Enviada</option>
                                <option value="accepted">Aceptada</option>
                                <option value="rejected">Rechazada</option>
                                <option value="expired">Expirada</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tabla de Cotizaciones -->
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">
                                            ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">
                                            Contacto</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">
                                            Fecha</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">
                                            Total</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">
                                            Estado</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">
                                            Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="quotes-table-body" class="divide-y divide-slate-200">
                                    <tr>
                                        <td colspan="6" class="text-center py-8 text-slate-500">Cargando cotizaciones...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Contenedor para el panel de Productos. Se cargar√° din√°micamente. -->
                <div id="products" class="content-panel max-w-6xl mx-auto">
                    <!-- Contenido de products.html -->
                    <div class="flex flex-col gap-4 mb-6">
                        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                            <h2 class="text-2xl sm:text-3xl font-bold">Mis Productos (<span id="products-count-overview"
                                    data-role="products-count-overview"
                                    class="text-base font-semibold text-slate-500">0</span>)
                            </h2>
                            <div class="w-full md:w-72">
                                <div class="relative">
                                    <i data-lucide="search"
                                        class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400"></i>
                                    <input type="search" data-role="products-search"
                                        placeholder="Buscar por nombre, SKU o precio..."
                                        class="w-full rounded-lg border border-slate-300 bg-white py-2 pl-10 pr-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        autocomplete="off">
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 md:justify-end">
                            <button id="add-product-btn"
                                class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">A√±adir
                                Producto</button>

                            <button id="bulk-optimize-btn" type="button"
                                class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:from-purple-700 hover:to-indigo-700 flex items-center gap-1 shadow-md shadow-purple-200 ring-1 ring-purple-100 transition-all active:scale-95">
                                <i data-lucide="sparkles" class="w-4 h-4"></i>
                                Optimizar Todo
                            </button>

                            <button id="download-template-btn"
                                class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Descargar
                                Plantilla</button>

                            <label
                                class="bg-green-100 text-green-700 font-semibold py-2 px-4 rounded-lg hover:bg-green-200 cursor-pointer flex items-center gap-2">
                                <input type="file" id="import-csv-input" class="hidden" accept=".csv,.xlsx,.xls">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                Importar CSV/XLSX
                            </label>

                            <button id="export-products-btn"
                                class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Exportar
                                a CSV</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="p-4 font-semibold">Nombre</th>
                                    <th class="p-4 font-semibold">SKU</th>
                                    <th class="p-4 font-semibold">Precio</th>
                                    <th class="p-4 font-semibold">Stock</th>
                                    <th class="p-4 font-semibold">Media</th>
                                    <th class="p-4 font-semibold">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body"></tbody>
                        </table>
                        <div id="products-loader" class="p-8 text-center text-slate-500"></div>
                    </div>
                </div>



                <!-- Panel Smart Promotions -->
                <div id="smart-promotions" class="content-panel max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 tracking-tight">Smart Promotions</h2>
                            <p class="text-slate-500 font-medium mt-1">Ofertas inteligentes que Elina menciona en el
                                momento perfecto.</p>
                        </div>
                        <div class="flex gap-3">
                            <button id="smart-promos-refresh"
                                class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                title="Actualizar">
                                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                            </button>
                            <button id="smart-promos-header-create-btn"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-5 rounded-xl shadow-lg shadow-blue-200 transition-all active:scale-95 flex items-center gap-2">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                <span>Nueva Promo</span>
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                            <div
                                class="w-12 h-12 rounded-xl bg-green-100 text-green-600 flex items-center justify-center">
                                <i data-lucide="zap" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Activas</p>
                                <p id="smart-promos-active-count" class="text-2xl font-black text-slate-900">0</p>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                            <div
                                class="w-12 h-12 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center">
                                <i data-lucide="calendar-clock" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Programadas</p>
                                <p id="smart-promos-scheduled-count" class="text-2xl font-black text-slate-900">0</p>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                            <div
                                class="w-12 h-12 rounded-xl bg-purple-100 text-purple-600 flex items-center justify-center">
                                <i data-lucide="message-circle" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Menciones Hoy</p>
                                <p id="smart-promos-today-count" class="text-2xl font-black text-slate-900">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Grid de Promos -->
                    <div id="smart-promos-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Las cards se inyectan aqu√≠ -->
                    </div>

                    <!-- Estado Vac√≠o -->
                    <div id="smart-promos-empty"
                        class="hidden flex flex-col items-center justify-center py-20 text-center">
                        <div class="w-24 h-24 bg-slate-50 rounded-full flex items-center justify-center mb-6">
                            <i data-lucide="zap-off" class="w-10 h-10 text-slate-300"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2">No hay promociones activas</h3>
                        <p class="text-slate-500 max-w-md mx-auto mb-8">Crea tu primera Smart Promotion para que Elina
                            pueda ofrecerla autom√°ticamente a tus clientes interesados.</p>
                        <button id="smart-promos-empty-create-btn"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-xl shadow-lg shadow-blue-200 transition-all active:scale-95 flex items-center gap-2 mx-auto">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            <span>Crear Primera Promo</span>
                        </button>
                    </div>

                    <!-- Modal Crear/Editar Promo -->
                    <div id="smart-promo-modal"
                        class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                        <div
                            class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col relative animate-in fade-in zoom-in duration-200">
                            <div
                                class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10 rounded-t-3xl">
                                <div>
                                    <h3 id="smart-promo-modal-title" class="text-xl font-black text-slate-900">Nueva
                                        Smart Promotion</h3>
                                    <p class="text-sm text-slate-500 font-medium">Configura cu√°ndo y c√≥mo Elina debe
                                        ofrecer esto.</p>
                                </div>
                                <button data-modal-close
                                    class="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-600 transition-colors">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>

                            <div class="flex-1 overflow-y-auto p-6 sm:p-8">
                                <form id="smart-promo-form" class="space-y-8">
                                    <!-- Secci√≥n 1: Qu√© ofrecemos -->
                                    <div class="space-y-5">
                                        <div
                                            class="flex items-center gap-2 text-blue-600 font-bold uppercase text-xs tracking-wider">
                                            <i data-lucide="gift" class="w-4 h-4"></i> Datos de la Oferta
                                        </div>

                                        <div>
                                            <label class="block text-sm font-bold text-slate-800 mb-2">T√≠tulo de la
                                                Promo <span class="text-red-500">*</span></label>
                                            <input type="text" id="smart-promo-title" required
                                                placeholder="Ej: 20% de Descuento en Faciales"
                                                class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 font-semibold text-slate-700 focus:border-blue-400 focus:ring-4 focus:ring-blue-50 outline-none transition-all">
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                            <div>
                                                <label class="block text-sm font-bold text-slate-800 mb-2">Descripci√≥n
                                                    Corta <span class="text-red-500">*</span></label>
                                                <input type="text" id="smart-promo-description" required
                                                    placeholder="Ej: V√°lido solo este mes para nuevos clientes."
                                                    class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 text-sm text-slate-700 focus:border-blue-400 outline-none transition-all">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-bold text-slate-800 mb-2">Call to
                                                    Action <span class="text-red-500">*</span></label>
                                                <input type="text" id="smart-promo-cta" required
                                                    placeholder="Ej: ¬°Quiero mi descuento!"
                                                    class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 text-sm text-slate-700 focus:border-blue-400 outline-none transition-all">
                                            </div>
                                        </div>

                                        <!-- Selector de Productos (NUEVO) -->
                                        <div>
                                            <label class="block text-sm font-bold text-slate-800 mb-2">Productos
                                                Vinculados <span class="text-red-500">*</span></label>
                                            <p class="text-xs text-slate-500 mb-2">Selecciona los productos o servicios
                                                que aplican para esta promoci√≥n.</p>
                                            <select id="smart-promo-products" multiple
                                                class="hidden w-full border-2 border-slate-100 rounded-xl px-4 py-3 text-sm text-slate-700 focus:border-blue-400 outline-none transition-all">
                                                <!-- Opciones se llenar√°n din√°micamente -->
                                            </select>

                                            <!-- Search Input -->
                                            <div class="relative mb-2">
                                                <i data-lucide="search"
                                                    class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                                                <input type="text" id="smart-promo-product-search"
                                                    placeholder="Buscar por nombre o SKU..."
                                                    class="w-full border border-slate-200 rounded-lg pl-9 pr-3 py-2 text-sm text-slate-700 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all">
                                            </div>

                                            <!-- Custom UI for Multi-select -->
                                            <div id="product-selection-ui"
                                                class="border-2 border-slate-100 rounded-xl p-3 bg-slate-50/50 max-h-48 overflow-y-auto">
                                                <div id="product-list-container" class="space-y-2">
                                                    <!-- Checkboxes se renderizar√°n aqu√≠ -->
                                                    <div class="text-center py-4 text-slate-400 text-sm">Cargando
                                                        productos...</div>
                                                </div>
                                            </div>
                                            <div id="selected-products-summary" class="flex flex-wrap gap-2 mt-2"></div>
                                        </div>

                                        <div>
                                            <div class="flex justify-between items-center mb-2">
                                                <label class="block text-sm font-bold text-slate-800">Beneficios
                                                    Clave</label>
                                                <button type="button" id="smart-promo-ai-btn"
                                                    class="text-xs text-purple-600 font-bold hover:underline flex items-center gap-1">
                                                    <i data-lucide="sparkles" class="w-3 h-3"></i> Mejorar con IA
                                                </button>
                                            </div>
                                            <textarea id="smart-promo-benefits" rows="3"
                                                placeholder="Ej: - Piel m√°s radiante&#10;- Relajaci√≥n profunda&#10;- Productos org√°nicos"
                                                class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 text-sm text-slate-700 focus:border-blue-400 outline-none transition-all resize-none"></textarea>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-bold text-slate-800 mb-2">Im√°genes (URLs o
                                                Subir)</label>
                                            <div id="smart-promo-images-container"
                                                class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-3">
                                                <!-- Im√°genes renderizadas aqu√≠ -->
                                            </div>
                                            <input type="text" id="smart-promo-images" placeholder="https://..."
                                                class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 text-sm text-slate-700 focus:border-blue-400 outline-none transition-all placeholder:text-slate-400">
                                        </div>
                                    </div>

                                    <hr class="border-slate-100">

                                    <!-- Secci√≥n 2: Reglas de Activaci√≥n -->
                                    <div class="space-y-5">
                                        <div
                                            class="flex items-center gap-2 text-indigo-600 font-bold uppercase text-xs tracking-wider">
                                            <i data-lucide="settings-2" class="w-4 h-4"></i> Reglas de Activaci√≥n
                                        </div>

                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                            <div class="bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100">
                                                <label class="flex items-center gap-3 cursor-pointer">
                                                    <input type="checkbox" id="smart-promo-auto"
                                                        class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500 border-gray-300">
                                                    <div>
                                                        <span class="block text-sm font-bold text-slate-900">Inserci√≥n
                                                            Autom√°tica</span>
                                                        <span class="block text-xs text-slate-500 mt-0.5">Elina la
                                                            ofrecer√° si detecta inter√©s.</span>
                                                    </div>
                                                </label>
                                            </div>
                                            <div class="bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100">
                                                <label class="flex items-center gap-3 cursor-pointer">
                                                    <input type="checkbox" id="smart-promo-active"
                                                        class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500 border-gray-300"
                                                        checked>
                                                    <div>
                                                        <span class="block text-sm font-bold text-slate-900">Promo
                                                            Activa</span>
                                                        <span class="block text-xs text-slate-500 mt-0.5">Visible para
                                                            el sistema.</span>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>

                                        <div>
                                            <label class="flex items-center gap-2 mb-3">
                                                <input type="checkbox" id="smart-promo-no-schedule"
                                                    class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 border-gray-300">
                                                <span class="text-sm font-semibold text-slate-700">Siempre disponible
                                                    (Sin fecha de vigencia)</span>
                                            </label>

                                            <div class="grid grid-cols-2 gap-5">
                                                <div>
                                                    <label
                                                        class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5">Inicio</label>
                                                    <input type="datetime-local" id="smart-promo-start"
                                                        class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:border-blue-400 outline-none">
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5">Fin</label>
                                                    <input type="datetime-local" id="smart-promo-end"
                                                        class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:border-blue-400 outline-none">
                                                </div>
                                            </div>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-bold text-slate-800 mb-2">L√≠mite Diario
                                                (Anti-Spam)</label>
                                            <div class="flex items-center gap-4">
                                                <input type="range" id="smart-promo-max-mentions" min="1" max="20"
                                                    value="3"
                                                    class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                                                <span class="text-lg font-bold text-blue-600 w-12 text-center"
                                                    id="max-mentions-display">3</span>
                                            </div>
                                            <p class="text-xs text-slate-500 mt-1">M√°ximo n√∫mero de veces que Elina
                                                mencionar√° esto por d√≠a (global).</p>
                                        </div>
                                    </div>

                                    <button type="submit" class="hidden"></button> <!-- Submit impl√≠cito -->
                                </form>
                            </div>

                            <div
                                class="p-6 border-t border-slate-100 bg-slate-50 rounded-b-3xl flex justify-end gap-3 sticky bottom-0 z-10">
                                <button data-modal-close
                                    class="px-6 py-2.5 rounded-xl font-bold text-slate-600 hover:bg-slate-200 transition-colors">
                                    Cancelar
                                </button>
                                <button type="button"
                                    onclick="document.getElementById('smart-promo-form').requestSubmit()"
                                    class="px-8 py-2.5 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all active:scale-95 flex items-center gap-2">
                                    <i data-lucide="save" class="w-4 h-4"></i> Guardar Promo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenedor para el panel de Chats. Se cargar√° din√°micamente. -->
                <!-- CORRECCI√ìN: El contenedor ahora est√° vac√≠o y cargar√° su contenido din√°micamente -->

                <div id="chats" class="content-panel h-full">
                    <!-- Contenido de chats.html -->
                    <div class="flex h-full bg-white rounded-xl shadow-md overflow-hidden">
                        <div id="chats-sidebar"
                            class="w-full md:w-1/3 lg:w-1/4 border-r border-slate-200 flex flex-col">
                            <div class="p-4 border-b border-slate-200 flex-shrink-0">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-xl font-bold">Chats</h2>
                                    <button id="new-chat-btn"
                                        class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition flex items-center justify-center"
                                        title="Iniciar chat nuevo">
                                        <i data-lucide="message-square-plus" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                <!-- Toggle para grupos/contactos -->
                                <div class="flex gap-2 mb-3 bg-slate-100 p-1 rounded-lg">
                                    <button id="toggle-contacts-btn"
                                        class="flex-1 py-2 px-3 rounded-md text-sm font-semibold transition-colors bg-white text-blue-600 shadow-sm">
                                        <i data-lucide="user" class="w-4 h-4 inline mr-1"></i>
                                        Contactos
                                    </button>
                                    <button id="toggle-groups-btn"
                                        class="flex-1 py-2 px-3 rounded-md text-sm font-semibold transition-colors text-slate-600 hover:bg-slate-50">
                                        <i data-lucide="users" class="w-4 h-4 inline mr-1"></i>
                                        Grupos
                                    </button>
                                </div>
                                <!-- Bot√≥n de sincronizaci√≥n (solo visible en vista de grupos) -->
                                <button id="sync-groups-btn"
                                    class="hidden w-full mb-3 py-2 px-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2 text-sm font-semibold">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    <span id="sync-groups-text">Sincronizar Grupos</span>
                                </button>
                                <input type="search" id="chat-search-input" placeholder="Buscar..."
                                    class="w-full form-input py-2 rounded-lg border-slate-300 text-sm">
                            </div>
                            <div id="contact-list-container" class="flex-grow overflow-y-auto">
                                <div id="contacts-list-loader" class="p-8 text-center text-slate-500 hidden">Cargando
                                    contactos...</div>
                                <div id="groups-list-loader" class="p-8 text-center text-slate-500 hidden">Cargando
                                    grupos...</div>
                                <div id="chat-contacts-list" class="p-2">
                                    <!-- Los items de contacto/grupo se insertar√°n aqu√≠ -->
                                </div>
                            </div>
                        </div>
                        <div id="chat-main-area" class="flex-1 flex-col hidden md:flex">
                            <div id="chat-view-placeholder"
                                class="flex flex-col items-center justify-center h-full text-slate-400"><i
                                    data-lucide="message-square" class="w-24 h-24"></i>
                                <p class="mt-4 text-lg font-semibold">Selecciona un chat para empezar</p>
                            </div>
                            <div id="chat-view-main" class="hidden flex-1 flex-col lg:flex-row min-h-0">
                                <div class="flex-1 flex flex-col">
                                    <div
                                        class="flex items-center justify-between p-4 border-b border-slate-200 flex-shrink-0">
                                        <p id="chat-header-name" class="font-bold text-lg">Nombre</p><button
                                            id="chat-contact-info-toggle" class="p-2 rounded-full hover:bg-slate-100"><i
                                                data-lucide="info"></i></button>
                                    </div>
                                    <div id="chat-history"
                                        class="flex-grow overflow-y-auto p-4 space-y-4 flex flex-col"></div>
                                    <div class="p-4 border-t border-slate-200 bg-slate-50 flex-shrink-0">
                                        <div id="chat-image-preview-container" class="hidden relative w-24 h-24 mb-2">
                                            <img id="chat-image-preview"
                                                class="w-full h-full object-cover rounded-md"><button
                                                id="chat-remove-image-btn"
                                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1"><i
                                                    data-lucide="x" class="w-3 h-3"></i></button>
                                        </div>
                                        <form id="chat-input-form" class="flex items-center gap-3">
                                            <button type="button" id="chat-attach-file-btn"
                                                class="p-3 rounded-full hover:bg-slate-200"><i data-lucide="paperclip"
                                                    class="w-5 h-5 text-slate-600"></i></button><input type="file"
                                                id="chat-file-input" class="hidden" accept="image/*">
                                            <textarea id="chat-message-input" rows="1"
                                                placeholder="Escribe un mensaje..."
                                                class="flex-1 form-input rounded-lg resize-none"></textarea>
                                            <button type="submit" id="chat-send-btn"
                                                class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 disabled:opacity-50"><i
                                                    data-lucide="send" class="w-5 h-5"></i></button>
                                        </form>
                                    </div>
                                </div>
                                <div id="chat-contact-info-panel"
                                    class="hidden lg:w-1/3 lg:max-w-sm border-l bg-white p-6 overflow-y-auto">
                                    <h4 id="info-contact-name" class="text-lg font-bold"></h4>
                                    <p id="info-contact-phone" class="text-sm text-slate-500"></p>
                                    <div class="mt-4 pt-4 border-t">
                                        <div id="info-contact-labels"></div>
                                        <div id="info-manage-labels-container"></div>
                                    </div>
                                    <div class="mt-4 pt-4 border-t">
                                        <div class="relative inline-flex items-center cursor-pointer"
                                            id="info-ignore-ia-toggle-switch" data-contact-id="" data-ignored="false">
                                            <div
                                                class="relative w-11 h-6 bg-slate-200 rounded-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                                            </div><span class="ml-3 text-sm font-medium text-slate-700">Ignorar
                                                IA</span>
                                        </div>
                                    </div>
                                    <div id="info-contact-razon-ia" class="mt-4 pt-4 border-t"></div>
                                    <div id="info-chat-files" class="mt-4 pt-4 border-t"></div>
                                </div>
                            </div>
                        </div>
                        <div id="chat-info-overlay" class="hidden fixed inset-0 bg-black bg-opacity-25 z-10 lg:hidden">
                        </div>
                    </div>
                </div>

                <!-- Panel Contexto de Ventas -->
                <div id="sales-context" class="content-panel hidden max-w-4xl mx-auto">
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 space-y-6">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <div>
                                <p class="text-sm uppercase font-semibold text-slate-400">Promociones & scripts</p>
                                <h2 class="text-3xl font-bold text-slate-900">Contexto Comercial</h2>
                                <p class="text-sm text-slate-500 max-w-2xl">
                                    Describe la oferta, objeciones y ganchos prioritarios para que la IA los use
                                    autom√°ticamente en ventas. No necesitas procesos adicionales en n8n.
                                </p>
                            </div>
                        </div>


                        <form id="sales-context-form" class="space-y-5">
                            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                                <p class="text-sm text-blue-800">
                                    <strong>üí° ¬øQu√© es el Contexto de Ventas?</strong><br>
                                    Configura c√≥mo la IA debe responder a objeciones comunes de tus clientes.
                                    La IA detectar√° autom√°ticamente estas objeciones y usar√° las respuestas que
                                    configures aqu√≠.
                                </p>
                            </div>


                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">
                                    Objeciones detectadas autom√°ticamente
                                </label>
                                <div id="sales-context-detected-objections"
                                    class="bg-slate-50 border border-slate-200 rounded-xl p-4 min-h-[100px]">
                                    <p class="text-sm text-slate-600 mb-3">
                                        <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
                                        La IA detectar√° autom√°ticamente objeciones comunes como:
                                    </p>
                                    <div id="objections-list" class="space-y-2">
                                        <!-- Las objeciones se cargar√°n din√°micamente aqu√≠ -->
                                    </div>
                                    <button type="button" id="add-objection-btn"
                                        class="mt-3 text-sm text-blue-600 hover:text-blue-700 font-semibold flex items-center gap-2">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                        Agregar objeci√≥n personalizada
                                    </button>
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    <strong>¬øC√≥mo funciona?</strong> La IA detecta autom√°ticamente cuando un cliente
                                    dice estas objeciones y usa las respuestas que configuraste.
                                    Puedes editar haciendo clic en el √≠cono de l√°piz ‚úèÔ∏è, generar respuestas autom√°ticas
                                    con el bot√≥n de IA ü§ñ, o eliminar con la X.
                                    Las promociones espec√≠ficas est√°n en "Promociones Inteligentes" y se insertan
                                    autom√°ticamente cuando es relevante.
                                </p>
                            </div>

                            <!-- Mensajes Cr√≠ticos -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">
                                    üö® Mensajes Cr√≠ticos
                                </label>
                                <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-3">
                                    <p class="text-sm text-amber-800">
                                        <strong>¬øQu√© son los mensajes cr√≠ticos?</strong><br>
                                        Cuando un cliente env√≠a un mensaje cr√≠tico, la conversaci√≥n se pausa
                                        autom√°ticamente y recibes una notificaci√≥n.
                                        Un humano debe responder en lugar de la IA.
                                    </p>
                                </div>

                                <!-- Cr√≠ticos Predefinidos -->
                                <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 mb-4">
                                    <h4 class="text-sm font-semibold text-slate-700 mb-3">Cr√≠ticos Predefinidos</h4>
                                    <div id="predefined-critical-rules" class="space-y-2">
                                        <!-- Se cargar√°n din√°micamente -->
                                    </div>
                                </div>

                                <!-- Cr√≠ticos Personalizados -->
                                <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="text-sm font-semibold text-slate-700">Cr√≠ticos Personalizados</h4>
                                        <button type="button" id="add-critical-rule-btn"
                                            class="text-sm text-blue-600 hover:text-blue-700 font-semibold flex items-center gap-2">
                                            <i data-lucide="plus" class="w-4 h-4"></i> Agregar cr√≠tico
                                        </button>
                                    </div>
                                    <div id="custom-critical-rules" class="space-y-2">
                                        <!-- Se cargar√°n din√°micamente -->
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500 mt-2">
                                    Puedes agregar palabras clave simples o patrones (expresiones regulares) para
                                    detectar mensajes cr√≠ticos espec√≠ficos de tu negocio.
                                </p>
                            </div>

                            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4 space-y-4">
                                <!-- Switch 1: Activo -->
                                <div id="sales-context-active-switch"
                                    class="flex items-start gap-3 cursor-pointer group" data-active="true">
                                    <!-- Switch Track -->
                                    <div
                                        class="switch-track relative w-11 h-6 flex-shrink-0 bg-slate-200 rounded-full transition-colors duration-200 flex items-center">
                                        <!-- Switch Thumb -->
                                        <div
                                            class="switch-thumb absolute left-[2px] w-5 h-5 bg-white border border-slate-300 rounded-full transition-transform duration-200 shadow-sm">
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-semibold text-slate-700 select-none">Marcar como
                                                activo</span>
                                            <!-- Tooltip -->
                                            <div class="relative group/tooltip inline-flex">
                                                <i data-lucide="help-circle"
                                                    class="w-4 h-4 text-slate-400 hover:text-blue-500 cursor-help transition-colors"></i>
                                                <div
                                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 bg-slate-800 text-white text-xs p-2 rounded-lg shadow-xl opacity-0 invisible group-hover/tooltip:opacity-100 group-hover/tooltip:visible transition-all z-10 pointer-events-none">
                                                    Si activas esto, la IA usar√° este contexto comercial en TODAS tus
                                                    conversaciones para vender y responder objeciones.
                                                    <div
                                                        class="absolute top-full left-1/2 -translate-x-1/2 -mt-1 border-4 border-transparent border-t-slate-800">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <p class="text-xs text-slate-500 mt-0.5">La IA lo usar√° en todas las
                                            conversaciones</p>
                                    </div>
                                </div>

                                <!-- Switch 2: Auto Generar -->
                                <div id="sales-context-auto-generate-switch"
                                    class="flex items-start gap-3 cursor-pointer group" data-active="true">
                                    <!-- Switch Track -->
                                    <div
                                        class="switch-track relative w-11 h-6 flex-shrink-0 bg-slate-200 rounded-full transition-colors duration-200 flex items-center">
                                        <!-- Switch Thumb -->
                                        <div
                                            class="switch-thumb absolute left-[2px] w-5 h-5 bg-white border border-slate-300 rounded-full transition-transform duration-200 shadow-sm">
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-semibold text-slate-700 select-none">Generar
                                                respuestas autom√°ticamente</span>
                                            <!-- Tooltip -->
                                            <div class="relative group/tooltip inline-flex">
                                                <i data-lucide="help-circle"
                                                    class="w-4 h-4 text-slate-400 hover:text-blue-500 cursor-help transition-colors"></i>
                                                <div
                                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 bg-slate-800 text-white text-xs p-2 rounded-lg shadow-xl opacity-0 invisible group-hover/tooltip:opacity-100 group-hover/tooltip:visible transition-all z-10 pointer-events-none">
                                                    Cuando haces clic en el bot√≥n m√°gico ü§ñ de una objeci√≥n, la IA usar√°
                                                    los datos de tu empresa (web, descripci√≥n) para redactar la mejor
                                                    respuesta posible.
                                                    <div
                                                        class="absolute top-full left-1/2 -translate-x-1/2 -mt-1 border-4 border-transparent border-t-slate-800">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <p class="text-xs text-slate-500 mt-0.5">Usando datos de mi empresa</p>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500 border-t pt-2 mt-2">
                                    <i data-lucide="zap" class="w-3 h-3 inline mr-1 text-amber-500"></i>
                                    <strong>Tip:</strong> Mant√©n ambas opciones activas para aprovechar al m√°ximo la
                                    automatizaci√≥n.
                                </p>
                            </div>
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <p class="text-xs text-slate-500">Cada guardado desactiva versiones anteriores para
                                    mantener un solo contexto vigente.</p>
                                <div class="flex flex-wrap items-center gap-3">
                                    <button type="button" id="sales-context-clear"
                                        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-slate-300 text-sm font-semibold text-slate-600 hover:bg-slate-100">
                                        <i data-lucide="eraser" class="w-4 h-4"></i> Limpiar campos
                                    </button>
                                    <button type="submit"
                                        class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-blue-600 text-sm font-semibold text-white hover:bg-blue-700">
                                        <i data-lucide="save" class="w-4 h-4"></i> Guardar contexto
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Panel de Citas y Calendario -->
                <div id="appointments" class="content-panel max-w-7xl mx-auto">
                    <!-- Calendario -->
                    <div id="appointments-container" class="bg-white rounded-xl shadow-md p-3">
                        <div id="appointments-loader" class="text-center text-slate-500 p-8">
                            <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin"></i>
                            <p>Cargando citas...</p>
                        </div>
                        <!-- Vista Mensual -->
                        <div id="calendar-month-view" class="hidden">
                            <!-- Header compacto con controles integrados -->
                            <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-200">
                                <div class="flex items-center gap-3">
                                    <button id="calendar-prev-month" class="p-1.5 rounded-lg hover:bg-slate-100">
                                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                    </button>
                                    <h3 id="calendar-month-title" class="text-base font-bold text-slate-800"></h3>
                                    <button id="calendar-next-month" class="p-1.5 rounded-lg hover:bg-slate-100">
                                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-xs font-medium text-slate-600 whitespace-nowrap">Filtrar:</label>
                                    <select id="appointments-filter-status"
                                        class="form-input border-slate-300 rounded-lg text-xs py-1 px-2 min-w-[100px]">
                                        <option value="all">Todas</option>
                                        <option value="pending">Pendientes</option>
                                        <option value="confirmed">Confirmadas</option>
                                        <option value="completed">Completadas</option>
                                        <option value="cancelled">Canceladas</option>
                                    </select>
                                    <div class="relative inline-flex items-center bg-slate-200 rounded-lg p-0.5">
                                        <button id="calendar-view-month-btn"
                                            class="relative z-10 px-2 py-1 rounded-md text-xs font-medium transition-all duration-200 flex items-center gap-1 bg-green-600 text-white shadow-sm">
                                            <i data-lucide="calendar" class="w-3 h-3"></i> Mes
                                        </button>
                                        <button id="calendar-view-week-btn"
                                            class="relative z-10 px-2 py-1 rounded-md text-xs font-medium transition-all duration-200 flex items-center gap-1 text-slate-700 hover:text-slate-900">
                                            <i data-lucide="calendar-days" class="w-3 h-3"></i> Sem
                                        </button>
                                    </div>
                                    <button id="new-appointment-btn"
                                        class="bg-green-600 text-white font-semibold py-1 px-2.5 rounded-lg hover:bg-green-700 flex items-center gap-1.5 text-xs">
                                        <i data-lucide="plus" class="w-3 h-3"></i> Nueva
                                    </button>
                                    <button id="appointments-config-btn"
                                        class="bg-slate-600 text-white font-semibold py-1 px-2.5 rounded-lg hover:bg-slate-700 flex items-center gap-1.5 text-xs"
                                        title="Configurar citas">
                                        <i data-lucide="settings" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="calendar-month-grid" class="grid grid-cols-7 gap-1.5">
                                <!-- Los d√≠as del mes se renderizar√°n aqu√≠ -->
                            </div>
                        </div>
                        <!-- Vista Semanal -->
                        <div id="calendar-week-view" class="hidden">
                            <!-- Header compacto con controles integrados -->
                            <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-200">
                                <div class="flex items-center gap-3">
                                    <button id="calendar-prev-week" class="p-1.5 rounded-lg hover:bg-slate-100">
                                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                    </button>
                                    <h3 id="calendar-week-title" class="text-base font-bold text-slate-800"></h3>
                                    <button id="calendar-next-week" class="p-1.5 rounded-lg hover:bg-slate-100">
                                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-xs font-medium text-slate-600 whitespace-nowrap">Filtrar:</label>
                                    <select id="appointments-filter-status-week"
                                        class="form-input border-slate-300 rounded-lg text-xs py-1 px-2 min-w-[100px]">
                                        <option value="all">Todas</option>
                                        <option value="pending">Pendientes</option>
                                        <option value="confirmed">Confirmadas</option>
                                        <option value="completed">Completadas</option>
                                        <option value="cancelled">Canceladas</option>
                                    </select>
                                    <div class="relative inline-flex items-center bg-slate-200 rounded-lg p-0.5">
                                        <button id="calendar-view-month-btn-week"
                                            class="relative z-10 px-2 py-1 rounded-md text-xs font-medium transition-all duration-200 flex items-center gap-1 text-slate-700 hover:text-slate-900">
                                            <i data-lucide="calendar" class="w-3 h-3"></i> Mes
                                        </button>
                                        <button id="calendar-view-week-btn-week"
                                            class="relative z-10 px-2 py-1 rounded-md text-xs font-medium transition-all duration-200 flex items-center gap-1 bg-green-600 text-white shadow-sm">
                                            <i data-lucide="calendar-days" class="w-3 h-3"></i> Sem
                                        </button>
                                    </div>
                                    <button id="new-appointment-btn-week"
                                        class="bg-green-600 text-white font-semibold py-1 px-2.5 rounded-lg hover:bg-green-700 flex items-center gap-1.5 text-xs">
                                        <i data-lucide="plus" class="w-3 h-3"></i> Nueva
                                    </button>
                                    <button id="appointments-config-btn-week"
                                        class="bg-slate-600 text-white font-semibold py-1 px-2.5 rounded-lg hover:bg-slate-700 flex items-center gap-1.5 text-xs"
                                        title="Configurar citas">
                                        <i data-lucide="settings" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="calendar-week-grid" class="grid grid-cols-8 gap-2">
                                <!-- Los d√≠as de la semana con horas se renderizar√°n aqu√≠ -->
                            </div>
                        </div>
                        <!-- Lista de Citas (fallback) -->
                        <div id="appointments-list" class="hidden space-y-3"></div>
                        <div id="appointments-empty" class="hidden bg-slate-50 rounded-xl p-12 text-center">
                            <i data-lucide="calendar-x" class="w-16 h-16 mx-auto text-slate-400 mb-4"></i>
                            <h3 class="text-xl font-bold text-slate-700">No hay citas agendadas</h3>
                            <p class="text-slate-500 mt-2">Las citas que la IA agende aparecer√°n aqu√≠.</p>
                            <p class="text-sm text-slate-400 mt-4">Activa el sistema de citas en Configuraci√≥n para
                                comenzar.</p>
                        </div>
                    </div>
                </div>

                <div id="community-manager" class="content-panel">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">Community Manager IA</h2>
                    <div class="bg-white rounded-xl shadow-md p-6 text-center">
                        <i data-lucide="construction" class="w-16 h-16 mx-auto text-slate-400 mb-4"></i>
                        <h3 class="text-xl font-bold">Pr√≥ximamente</h3>
                        <p class="text-slate-500 mt-2">Automatiza la creaci√≥n y publicaci√≥n de contenido en tus
                            redes
                            sociales.</p>
                    </div>
                </div>

                <div id="designer-ai" class="content-panel pb-16" data-placeholder="true">
                    <!-- Contenido cargado din√°micamente desde designer-ai.html -->
                </div>


                <div id="video-ai" class="content-panel pb-16" data-placeholder="true">
                    <!-- Contenido cargado din√°micamente desde video-ai.html -->
                </div>

                <div id="ia-mind" class="content-panel pb-16" data-placeholder="true">
                    <!-- Contenido cargado din√°micamente desde personal-tasks.html -->
                </div>


                <div id="settings" class="content-panel" data-placeholder="true">
                    <!-- Contenido cargado din√°micamente desde settings.html -->
                </div>
        </div>
        </main>
    </div>
    </div>

    <!-- Modal para Editar Etiquetas (inicialmente oculto) -->
    <div id="edit-labels-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 border-b">
                <h3 class="text-xl font-bold">Gestionar Etiquetas</h3>
            </div>
            <div id="labels-list" class="p-6 max-h-60 overflow-y-auto">
                <!-- Lista de etiquetas se renderizar√É¬° aqu√É¬≠ -->
                <div class="text-center text-slate-500">Cargando etiquetas...</div>
            </div>
            <div class="p-6 border-t">
                <form id="new-label-form" class="flex items-center gap-2">
                    <input type="text" id="new-label-name" placeholder="Crear nueva etiqueta..."
                        class="form-input w-full border-slate-300 rounded-lg text-sm">
                    <input type="color" id="new-label-color" value="#38bdf8" class="h-9 w-12 rounded-lg cursor-pointer">
                    <button type="submit" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">
                        <i data-lucide="plus"></i>
                    </button>
                </form>
            </div>
            <div class="p-6 bg-slate-50 flex justify-end gap-3 rounded-b-lg">
                <button id="cancel-labels-btn"
                    class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                <button id="save-labels-btn"
                    class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Guardar
                    Cambios</button>
            </div>
        </div>
    </div>

    <!-- Modal para Mejora con IA -->
    <div id="ai-enhance-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl h-[80vh] flex flex-col">
            <div class="p-6 border-b">
                <h3 class="text-xl font-bold">Mejorar con IA</h3>
                <p class="text-sm text-slate-500">Usos restantes este mes: <span id="ai-uses-left"
                        class="font-semibold">0/0</span></p>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto flex-1">
                <div>
                    <label for="ai-original-text" class="block text-sm font-medium text-slate-600">Texto
                        Original</label>
                    <textarea id="ai-original-text" rows="4"
                        class="w-full border-slate-300 rounded-lg p-3 bg-slate-100 text-slate-700" readonly></textarea>
                </div>
                <div>
                    <label for="ai-prompt-input" class="block text-sm font-medium text-slate-600">¬øQu√© quieres mejorar?
                        (Opcional)</label>
                    <input type="text" id="ai-prompt-input"
                        placeholder="Ej: 'Hazlo m√°s amigable', 'A√±ade una regla sobre precios', 'Mejora la secci√≥n de ejemplos'"
                        class="form-input w-full border-slate-300 rounded-lg text-sm">
                    <p class="text-xs text-slate-500 mt-1">La IA mejorar√° tu prompt manteniendo toda la estructura y
                        contenido existente. Solo especifica qu√© aspecto quieres mejorar.</p>
                </div>
                <div id="ai-result-container" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg">
                </div>
            </div>
            <div class="p-6 bg-slate-50 flex justify-between items-center rounded-b-lg">
                <button id="cancel-ai-btn"
                    class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                <div class="flex items-center gap-2">
                    <button id="regenerate-ai-btn"
                        class="hidden bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Reintentar</button>
                    <button id="generate-ai-btn"
                        class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Mejorar
                        Texto</button>
                    <button id="apply-ai-btn"
                        class="hidden bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Usar
                        este texto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Env√≠o de Prueba -->
    <div id="test-send-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 border-b">
                <h3 class="text-xl font-bold">Enviar Mensaje de Prueba</h3>
            </div>
            <div class="p-6">
                <p class="text-sm text-slate-600 mb-4">Ingresa el n√∫mero de tel√©fono al que deseas enviar la prueba. El
                    mensaje usar√° "Prueba" en lugar de %nombre%.</p>
                <div class="iti-container">
                    <label for="test-phone-input" class="block text-sm font-medium text-slate-700 mb-2">N√∫mero de
                        Tel√©fono</label>
                    <input type="tel" id="test-phone-input" class="form-input w-full border-slate-300 rounded-lg">
                </div>
                <div id="test-phone-error" class="text-red-500 text-xs mt-1 hidden">N√∫mero inv√°lido.</div>
            </div>
            <div class="p-6 bg-slate-50 flex justify-end gap-3 rounded-b-lg">
                <button id="cancel-test-send-btn"
                    class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                <button id="confirm-test-send-btn"
                    class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Enviar
                    Prueba</button>
            </div>
        </div>
    </div>

    <!-- Modal para Asignar/Crear Etiqueta con IA -->
    <div id="assign-label-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <form id="assign-label-form">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold">Asignar Etiqueta con IA</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="assign-label-select" class="block text-sm font-medium text-slate-700">Elige una
                            etiqueta existente</label>
                        <div class="custom-select-wrapper mt-1">
                            <select id="assign-label-select" required class="custom-select form-input"></select>
                            <i data-lucide="tag" class="select-icon w-5 h-5 text-slate-400"></i>
                        </div>
                        <p class="text-xs text-slate-500 mt-1">O <a href="#" id="create-new-label-link"
                                class="text-blue-600 hover:underline">crea una nueva etiqueta</a> si no la encuentras.
                        </p>
                    </div>
                    <div>
                        <label for="assign-label-condition" class="block text-sm font-medium text-slate-700">Condici√≥n
                            para la IA</label>
                        <div class="flex justify-end mb-1">
                            <button type="button" id="smart-label-ai-enhance-btn"
                                class="text-xs bg-purple-100 text-purple-700 font-semibold py-1 px-2 rounded-md hover:bg-purple-200 flex items-center gap-1">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> Mejorar con IA
                            </button>
                        </div>
                        <textarea id="assign-label-condition" rows="4"
                            class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"
                            placeholder="Describe cu√°ndo se debe aplicar esta etiqueta. Ej: 'Cuando el cliente pregunte por el precio y no vuelva a responder en 24 horas'."
                            required></textarea>
                    </div>
                </div>
                <div class="p-6 bg-slate-50 flex justify-end gap-3 rounded-b-lg">
                    <button type="button" id="cancel-assign-label-btn"
                        class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                    <button type="submit"
                        class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Guardar
                        Automatizaci√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Nuevo Producto -->
    <div id="new-product-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div
                    class="px-6 py-4 flex items-center justify-between border-b bg-white rounded-t-lg sticky top-0 z-10">
                    <div>
                        <h3 id="product-modal-title" class="text-xl font-bold text-slate-800 tracking-tight">Configurar
                            Producto</h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Cat√°logo &
                            Inteligencia Artificial</p>
                    </div>
                </div>

                <div class="px-6 py-6 space-y-8 max-h-[75vh] overflow-y-auto bg-slate-50/30">
                    <!-- SECCI√ìN 1: IDENTIFICACI√ìN -->
                    <section class="space-y-4">
                        <div class="flex items-center gap-2 mb-4">
                            <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600">
                                <i data-lucide="package" class="w-5 h-5"></i>
                            </div>
                            <h4 class="font-bold text-sm text-slate-700 uppercase tracking-wider">Identificaci√≥n</h4>
                        </div>

                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="md:col-span-2">
                                    <label for="product-name"
                                        class="block text-xs font-bold text-slate-500 uppercase mb-2">Nombre Comercial
                                        *</label>
                                    <input type="text" id="product-name" required
                                        class="w-full rounded-xl border border-slate-300 bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all py-3 px-4 text-sm"
                                        placeholder="Ej: Teclado Mec√°nico RGB">
                                </div>

                                <div>
                                    <label for="product-sku"
                                        class="block text-xs font-bold text-slate-500 uppercase mb-2">SKU / C√≥digo √önico
                                        *</label>
                                    <input type="text" id="product-sku" required
                                        class="w-full rounded-xl border border-slate-300 bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all py-3 px-4 text-sm"
                                        placeholder="SKU-001">
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Tipo de Oferta
                                        *</label>
                                    <div class="flex p-1 bg-slate-100 rounded-xl gap-1">
                                        <label class="flex-1">
                                            <input type="radio" name="product-type" id="product-type-physical"
                                                value="physical" checked class="hidden peer">
                                            <div
                                                class="text-center py-2 px-3 rounded-lg cursor-pointer text-xs font-bold transition-all peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm text-slate-500 hover:text-slate-700">
                                                Producto
                                            </div>
                                        </label>
                                        <label class="flex-1">
                                            <input type="radio" name="product-type" id="product-type-service"
                                                value="service" class="hidden peer">
                                            <div
                                                class="text-center py-2 px-3 rounded-lg cursor-pointer text-xs font-bold transition-all peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm text-slate-500 hover:text-slate-700">
                                                Servicio
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div id="product-service-duration-container"
                                class="hidden animate-in fade-in slide-in-from-top-2 duration-200 pt-4 border-t border-slate-100">
                                <label for="product-service-duration"
                                    class="block text-xs font-bold text-slate-500 uppercase mb-2">Duraci√≥n (minutos)
                                    *</label>
                                <div class="relative">
                                    <i data-lucide="clock" class="absolute left-4 top-3.5 w-4 h-4 text-slate-400"></i>
                                    <input type="number" id="product-service-duration" min="15" step="15" value="60"
                                        class="w-full pl-11 rounded-xl border border-slate-300 bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all py-3 text-sm"
                                        placeholder="Ej: 60">
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- SECCI√ìN 2: PRECIOS -->
                    <section class="space-y-4">
                        <div class="flex items-center gap-2 mb-4">
                            <div
                                class="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center text-green-600">
                                <i data-lucide="banknote" class="w-5 h-5"></i>
                            </div>
                            <h4 class="font-bold text-sm text-slate-700 uppercase tracking-wider">Precio &
                                Disponibilidad</h4>
                        </div>

                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="product-price"
                                        class="block text-xs font-bold text-slate-500 uppercase mb-2">Precio Base
                                        *</label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-3 text-slate-400 font-bold">$</span>
                                        <input type="number" id="product-price" step="0.01" required
                                            class="w-full pl-10 rounded-xl border border-slate-300 bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all py-3 text-sm font-bold text-slate-700"
                                            placeholder="0.00">
                                    </div>
                                </div>
                                <div id="product-stock-container">
                                    <label for="product-stock"
                                        class="block text-xs font-bold text-slate-500 uppercase mb-2">Existencias</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="product-stock" value="0" min="0"
                                            class="flex-1 rounded-xl border border-slate-300 bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all py-3 px-4 text-sm"
                                            placeholder="0">
                                        <label
                                            class="flex items-center gap-2 cursor-pointer bg-slate-100 hover:bg-slate-200 px-4 py-3 rounded-xl border border-slate-400 transition-all flex-shrink-0 group">
                                            <input type="checkbox" id="product-infinite-stock"
                                                class="w-4 h-4 text-blue-600 rounded">
                                            <span class="text-lg text-slate-400 group-hover:text-slate-600">‚àû</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="pt-4 border-t border-slate-100">
                                <label class="flex items-center gap-3 cursor-pointer select-none group">
                                    <input type="checkbox" id="enable-tiered-pricing"
                                        class="w-4 h-4 text-blue-600 rounded">
                                    <span
                                        class="text-sm font-bold text-slate-600 group-hover:text-blue-600 transition-colors">Configurar
                                        Precios por Volumen (Mayoreo)</span>
                                </label>

                                <div id="tiered-pricing-container"
                                    class="hidden mt-6 p-4 bg-slate-50 rounded-2xl border border-slate-200 space-y-4 animate-in fade-in zoom-in-95">
                                    <div class="flex justify-between items-center">
                                        <h5 class="text-[10px] font-bold text-slate-400 uppercase">Tabla de Rangos</h5>
                                        <button type="button" id="add-tier-btn"
                                            class="text-[10px] bg-white border border-slate-200 hover:bg-slate-100 text-slate-600 font-bold py-1.5 px-3 rounded-lg transition-all flex items-center gap-1.5 shadow-sm">
                                            <i data-lucide="plus" class="w-3 h-3"></i> AGREGAR
                                        </button>
                                    </div>
                                    <div class="overflow-hidden rounded-xl border border-slate-200 bg-white">
                                        <table class="w-full text-left text-[11px]">
                                            <thead class="bg-slate-50 text-slate-400 font-bold border-b">
                                                <tr>
                                                    <th class="px-3 py-2 text-xs uppercase tracking-wider w-1/4">Min.
                                                        Unidades</th>
                                                    <th class="px-3 py-2 text-xs uppercase tracking-wider w-1/4">Max.
                                                        Unidades</th>
                                                    <th class="px-3 py-2 text-xs uppercase tracking-wider w-1/3">Precio
                                                        Unitario</th>
                                                    <th class="px-3 py-2 w-16 text-center"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="pricing-tiers-body" class="divide-y divide-slate-50"></tbody>
                                        </table>
                                        <div id="tiers-empty-state" class="p-6 text-center">
                                            <p class="text-slate-400 text-[10px] italic">No hay rangos definidos.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- SECCI√ìN 3: IA & CONTENIDO -->
                    <section class="space-y-4">
                        <div class="flex items-center gap-2 mb-4">
                            <div
                                class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600">
                                <i data-lucide="brain" class="w-5 h-5"></i>
                            </div>
                            <h4 class="font-bold text-sm text-slate-700 uppercase tracking-wider">Contenido e
                                Inteligencia</h4>
                        </div>

                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-6">
                            <div>
                                <div class="flex justify-between items-center mb-3">
                                    <label for="product-description"
                                        class="block text-xs font-bold text-slate-500 uppercase">Descripci√≥n para el
                                        Cliente</label>
                                    <button type="button" onclick="optimizeSingleProduct()"
                                        class="text-[10px] bg-purple-600 text-white font-bold py-1.5 px-4 rounded-full hover:bg-purple-700 flex items-center gap-2 transition-all shadow-md">
                                        <i data-lucide="sparkles" class="w-3.5 h-3.5"></i> MEJORAR CON IA
                                    </button>
                                </div>
                                <textarea id="product-description" rows="4"
                                    class="w-full rounded-xl border border-slate-300 bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all text-sm py-4 px-4 leading-relaxed"
                                    placeholder="Describe qu√© es y por qu√© deber√≠an comprarlo..."></textarea>
                                <div class="mt-2 text-[10px] text-slate-400 font-bold uppercase"
                                    id="product-description-word-count-container">
                                    <span id="product-description-word-count">0 PALABRAS</span>
                                </div>
                            </div>

                            <div class="pt-4 border-t border-slate-100">
                                <label for="product-labels"
                                    class="block text-xs font-bold text-slate-500 uppercase mb-3">Etiquetas de
                                    B√∫squeda</label>
                                <div class="relative group">
                                    <i data-lucide="tag" class="absolute left-4 top-3.5 w-4 h-4 text-slate-400"></i>
                                    <input type="text" id="product-labels"
                                        class="w-full pl-11 pr-4 rounded-2xl border border-slate-300 bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all py-3.5 text-xs font-bold text-slate-600"
                                        placeholder="Ej: Premium, Nuevo, Oferta">
                                </div>
                            </div>
                        </div>
                    </section>
                    <!-- SECCI√ìN 4: MULTIMEDIA -->
                    <section class="space-y-4">
                        <div class="flex items-center gap-2 mb-4">
                            <div
                                class="w-8 h-8 rounded-lg bg-orange-100 flex items-center justify-center text-orange-600">
                                <i data-lucide="image" class="w-5 h-5"></i>
                            </div>
                            <h4 class="font-bold text-sm text-slate-700 uppercase tracking-wider">Multimedia</h4>
                        </div>

                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-8">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="space-y-4">
                                    <label
                                        class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest">Portada
                                        Principal</label>
                                    <div class="relative aspect-square rounded-3xl border-2 border-dashed border-slate-300 bg-white overflow-hidden group hover:border-blue-400 hover:bg-blue-50 transition-all cursor-pointer shadow-inner"
                                        onclick="document.getElementById('product-media-file').click()">
                                        <img id="product-image-preview" src=""
                                            class="hidden w-full h-full object-cover">
                                        <div id="image-placeholder"
                                            class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center">
                                            <div
                                                class="w-12 h-12 rounded-full bg-white shadow-sm flex items-center justify-center text-slate-300 mb-3">
                                                <i data-lucide="plus" class="w-6 h-6"></i>
                                            </div>
                                            <p class="text-[9px] font-bold text-slate-400 uppercase">SUBIR PORTADA</p>
                                        </div>
                                        <input type="file" id="product-media-file" accept="image/*,video/*"
                                            class="hidden">
                                    </div>
                                </div>

                                <div class="space-y-4">
                                    <label
                                        class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest">Galer√≠a
                                        Adicional</label>
                                    <div id="product-gallery-preview" class="grid grid-cols-2 gap-3 min-h-[120px]">
                                    </div>
                                    <button type="button"
                                        onclick="document.getElementById('product-gallery-input').click()"
                                        class="w-full py-4 rounded-2xl border-2 border-dashed border-slate-300 bg-white text-slate-500 hover:text-blue-600 hover:border-blue-300 transition-all flex flex-col items-center justify-center gap-1">
                                        <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                                        <span class="text-[9px] font-bold uppercase">A√ëADIR A GALER√çA</span>
                                    </button>
                                    <input type="file" id="product-gallery-input" accept="image/*" multiple
                                        class="hidden">
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- SECCI√ìN 5: FAQ -->
                    <section class="space-y-4 mb-4">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <div
                                    class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-slate-600">
                                    <i data-lucide="help-circle" class="w-5 h-5"></i>
                                </div>
                                <h4 class="font-bold text-sm text-slate-700 uppercase tracking-wider">Preguntas
                                    Frecuentes</h4>
                            </div>
                            <button type="button" id="add-faq-btn"
                                class="text-[10px] bg-slate-800 text-white hover:bg-black font-bold py-2 px-5 rounded-xl transition-all flex items-center gap-2 shadow-md">
                                <i data-lucide="plus" class="w-3.5 h-3.5"></i> NUEVA PREGUNTA
                            </button>
                        </div>

                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <div id="product-faq-container" class="space-y-4"></div>
                            <div id="faq-empty-state"
                                class="hidden py-8 text-center bg-slate-50/50 rounded-2xl border-2 border-dashed border-slate-100">
                                <p class="text-[10px] font-bold text-slate-300 uppercase">Sin preguntas cargadas</p>
                            </div>
                        </div>
                    </section>
                </div>

                <div
                    class="p-6 bg-white border-t border-slate-200 flex flex-col sm:flex-row gap-3 rounded-b-2xl shadow-lg">
                    <button type="button" id="cancel-product-btn"
                        class="w-full sm:flex-1 py-4 rounded-2xl font-bold text-slate-400 hover:text-slate-600 transition-all uppercase text-[10px] tracking-widest">
                        Cancelar
                    </button>
                    <button type="submit" id="save-new-product-btn"
                        class="w-full sm:flex-[2] py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-2xl transition-all shadow-xl hover:shadow-blue-200 active:scale-[0.98] uppercase text-[10px] tracking-widest flex items-center justify-center gap-2 disabled:opacity-50">
                        <i data-lucide="check" class="w-4 h-4"></i>
                        Guardar Producto
                    </button>
            </form>
        </div>
    </div>

    <!-- Modal para mapeo de columnas CSV -->
    <div id="column-mapping-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[90] px-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
            <div class="flex items-start justify-between p-6 border-b border-slate-200">
                <div>
                    <h3 class="text-xl font-bold text-slate-900">Mapeo de Columnas</h3>
                    <p class="text-sm text-slate-500 mt-1">Elige qu√© columna de tu archivo corresponde a cada campo de
                        Elina.</p>
                </div>
                <button id="close-column-mapping-btn" class="text-slate-400 hover:text-slate-600" aria-label="Cerrar">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="px-6 pt-4 pb-6 overflow-y-auto">
                <div class="overflow-x-auto rounded-lg border border-slate-200">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead
                            class="bg-slate-50 text-left text-sm font-semibold text-slate-600 uppercase tracking-wide">
                            <tr>
                                <th class="px-4 py-3">Campo en Elina</th>
                                <th class="px-4 py-3">Columna del CSV</th>
                            </tr>
                        </thead>
                        <tbody id="column-mapping-table-body" class="divide-y divide-slate-200 bg-white text-sm">
                        </tbody>
                    </table>
                </div>
                <div id="column-mapping-error" class="hidden mt-4 text-sm font-medium text-red-500"></div>
            </div>
            <div class="flex justify-end gap-3 px-6 pb-6 border-t border-slate-200 bg-slate-50">
                <button id="cancel-column-mapping-btn"
                    class="py-2 px-4 rounded-lg font-semibold text-slate-700 bg-slate-200 hover:bg-slate-300">Cancelar</button>
                <button id="confirm-column-mapping-btn"
                    class="py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700">Confirmar e
                    Importar</button>
            </div>
        </div>
    </div>


    <div id="verify-contacts-file-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[90] px-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="flex items-start justify-between p-6 border-b border-slate-200">
                <div>
                    <h3 class="text-xl font-bold text-slate-900">Comprobar Contactos</h3>
                    <p class="text-sm text-slate-500 mt-1">Carga un archivo XLSX o CSV para verificar qu√© n√∫meros tienen
                        WhatsApp.</p>
                </div>
                <button id="close-verify-file-modal-btn" class="text-slate-400 hover:text-slate-600"
                    aria-label="Cerrar">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="verify-contacts-file-input" class="block text-sm font-medium text-slate-700 mb-2">
                        Seleccionar archivo
                    </label>
                    <input type="file" id="verify-contacts-file-input" accept=".csv,.xlsx,.xls"
                        class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <p class="mt-2 text-xs text-slate-500">Formatos soportados: CSV, XLSX, XLS</p>
                </div>
                <div id="verify-file-error" class="hidden mt-4 text-sm font-medium text-red-500"></div>
            </div>
            <div class="flex justify-end gap-3 px-6 pb-6 border-t border-slate-200 bg-slate-50">
                <button id="cancel-verify-file-btn"
                    class="py-2 px-4 rounded-lg font-semibold text-slate-700 bg-slate-200 hover:bg-slate-300">Cancelar</button>
                <button id="confirm-verify-file-btn"
                    class="py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700">Continuar</button>
            </div>
        </div>
    </div>

    <!-- Modal para selecci√≥n de hoja (XLSX) -->
    <div id="verify-contacts-sheet-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[90] px-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="flex items-start justify-between p-6 border-b border-slate-200">
                <div>
                    <h3 class="text-xl font-bold text-slate-900">Seleccionar Hoja</h3>
                    <p class="text-sm text-slate-500 mt-1">Elige qu√© hoja del archivo Excel deseas procesar.</p>
                </div>
                <button id="close-verify-sheet-modal-btn" class="text-slate-400 hover:text-slate-600"
                    aria-label="Cerrar">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="verify-sheet-select" class="block text-sm font-medium text-slate-700 mb-2">
                        Hoja a procesar
                    </label>
                    <select id="verify-sheet-select"
                        class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Cargando hojas...</option>
                    </select>
                </div>
                <div id="verify-sheet-error" class="hidden mt-4 text-sm font-medium text-red-500"></div>
            </div>
            <div class="flex justify-end gap-3 px-6 pb-6 border-t border-slate-200 bg-slate-50">
                <button id="cancel-verify-sheet-btn"
                    class="py-2 px-4 rounded-lg font-semibold text-slate-700 bg-slate-200 hover:bg-slate-300">Cancelar</button>
                <button id="confirm-verify-sheet-btn"
                    class="py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700">Continuar</button>
            </div>
        </div>
    </div>

    <!-- Modal para mapeo y nombre de lista (verificaci√≥n) -->
    <div id="verify-contacts-mapping-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[90] px-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="flex items-start justify-between p-6 border-b border-slate-200">
                <div>
                    <h3 class="text-xl font-bold text-slate-900">Configurar Verificaci√≥n</h3>
                    <p class="text-sm text-slate-500 mt-1">Mapea las columnas y asigna un nombre a la lista de contactos
                        verificados.</p>
                </div>
                <button id="close-verify-mapping-modal-btn" class="text-slate-400 hover:text-slate-600"
                    aria-label="Cerrar">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="px-6 pt-4 pb-6 overflow-y-auto">
                <div class="mb-6">
                    <label for="verify-list-name-input" class="block text-sm font-medium text-slate-700 mb-2">
                        Nombre de la lista/etiqueta <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="verify-list-name-input" placeholder="Ej: Lista Verificada Enero 2025"
                        class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="mt-1 text-xs text-slate-500">Este nombre se usar√° como etiqueta para todos los contactos
                        verificados.</p>
                </div>
                <div class="mb-4">
                    <h4 class="text-sm font-semibold text-slate-700 mb-3">Vista previa (primeras 10 filas)</h4>
                    <div class="overflow-x-auto rounded-lg border border-slate-200 max-h-64 overflow-y-auto">
                        <table class="min-w-full divide-y divide-slate-200 text-xs">
                            <thead class="bg-slate-50 sticky top-0">
                                <tr id="verify-preview-headers"></tr>
                            </thead>
                            <tbody id="verify-preview-body" class="divide-y divide-slate-200 bg-white"></tbody>
                        </table>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-lg border border-slate-200">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead
                            class="bg-slate-50 text-left text-sm font-semibold text-slate-600 uppercase tracking-wide">
                            <tr>
                                <th class="px-4 py-3">Campo en Elina</th>
                                <th class="px-4 py-3">Columna del archivo</th>
                            </tr>
                        </thead>
                        <tbody id="verify-column-mapping-table-body" class="divide-y divide-slate-200 bg-white text-sm">
                        </tbody>
                    </table>
                </div>
                <div id="verify-mapping-error" class="hidden mt-4 text-sm font-medium text-red-500"></div>
            </div>
            <div class="flex justify-end gap-3 px-6 pb-6 border-t border-slate-200 bg-slate-50">
                <button id="cancel-verify-mapping-btn"
                    class="py-2 px-4 rounded-lg font-semibold text-slate-700 bg-slate-200 hover:bg-slate-300">Cancelar</button>
                <button id="confirm-verify-mapping-btn"
                    class="py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700">Verificar e
                    Importar</button>
            </div>
        </div>
    </div>

    <!-- Men√∫ de Navegaci√≥n Inferior para M√≥vil -->
    <!-- CORRECCI√ìN: A√±adir 'md:hidden' para ocultar en desktop -->
    <div
        class="mobile-bottom-nav fixed bottom-0 left-0 w-full bg-slate-900 border-t border-slate-700 flex justify-around items-center px-2 py-3 z-40 md:hidden">
        <a href="#" class="nav-link text-sm flex flex-col items-center text-slate-400 hover:text-white"
            data-target="dashboard">
            <i data-lucide="layout-dashboard" class="w-6 h-6"></i><span class="text-xs mt-1">Dashboard</span>
        </a>
        <a href="/superadmin.html" id="mobile-superadmin-link"
            class="hidden nav-link text-sm flex flex-col items-center text-slate-400 hover:text-white">
            <i data-lucide="shield" class="w-6 h-6"></i><span class="text-xs mt-1">Admin</span>
        </a>
        <a href="#" class="nav-link text-sm flex flex-col items-center text-slate-400 hover:text-white"
            data-target="products">
            <i data-lucide="boxes" class="w-6 h-6"></i><span class="text-xs mt-1">Productos</span>
        </a>
        <a href="#" class="nav-link text-sm flex flex-col items-center text-slate-400 hover:text-white"
            data-target="sales-context">
            <i data-lucide="scroll-text" class="w-6 h-6"></i><span class="text-xs mt-1">Contexto</span>
        </a>
        <a href="#" class="nav-link text-sm flex flex-col items-center text-slate-400 hover:text-white"
            data-target="kanban">
            <i data-lucide="columns-3" class="w-6 h-6"></i><span class="text-xs mt-1">Kanban</span>
        </a>
        <a href="#" class="nav-link text-sm flex flex-col items-center text-slate-400 hover:text-white"
            data-target="settings">
            <i data-lucide="settings" class="w-6 h-6"></i><span class="text-xs mt-1">Ajustes</span>
        </a>
        <!-- CORRECCI√ìN: Bot√≥n de men√∫ hamburguesa movido a la barra inferior -->
        <button id="mobile-menu-btn" class="flex flex-col items-center text-slate-400 hover:text-white">
            <i data-lucide="menu" class="w-6 h-6"></i><span class="text-xs mt-1">Men√∫</span>
        </button>
    </div>

    <!-- Modal de Selecci√≥n de Plan (Pricing) -->
    <div id="pricing-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl">
            <div class="p-6 text-center border-b">
                <h3 class="text-2xl font-bold">Elige el Plan Perfecto para Ti</h3>
                <p class="text-slate-500 mt-1">Tu prueba gratuita est√° por terminar. ¬°Sigue creciendo con Elina IA!</p>
            </div>
            <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Plan Starter -->
                <div class="border rounded-lg p-6 flex flex-col">
                    <h4 class="text-xl font-bold text-cyan-600">Starter</h4>
                    <p class="plan-price text-3xl font-bold my-4">$499 <span
                            class="text-sm font-normal text-slate-500">/mes</span></p>
                    <ul class="space-y-2 text-slate-600 mb-auto">
                        <li class="flex items-center gap-2"><i data-lucide="check"
                                class="w-4 h-4 text-green-500"></i>500 Env√≠os Masivos</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500"></i>5
                            Mejoras con IA</li>
                        <li class="flex items-center gap-2"><i data-lucide="check"
                                class="w-4 h-4 text-green-500"></i>Manejo de Productos</li>
                        <li class="flex items-center gap-2"><i data-lucide="check"
                                class="w-4 h-4 text-green-500"></i>Plantillas de Mensajes</li>
                        <li class="flex items-center gap-2"><i data-lucide="check"
                                class="w-4 h-4 text-green-500"></i>Gesti√≥n de Etiquetas</li>
                        <li class="flex items-center gap-2"><i data-lucide="x"
                                class="w-4 h-4 text-red-500"></i>Seguimientos Autom√°ticos</li>
                    </ul>
                    <button
                        class="upgrade-btn mt-6 w-full bg-cyan-600 text-white font-bold py-3 rounded-lg hover:bg-cyan-700"
                        data-plan="starter">
                        Elegir Starter
                    </button>
                </div>
                <!-- Plan Grow -->
                <div class="border-2 border-purple-500 rounded-lg p-6 flex flex-col relative">
                    <span
                        class="absolute top-0 -translate-y-1/2 bg-purple-500 text-white text-xs font-bold px-3 py-1 rounded-full">M√°s
                        Popular</span>
                    <h4 class="text-xl font-bold text-purple-600">Grow</h4>
                    <p class="plan-price text-3xl font-bold my-4">$1499 <span
                            class="text-sm font-normal text-slate-500">/mes</span></p>
                    <ul class="space-y-2 text-slate-600 mb-auto">
                        <li class="flex items-center gap-2"><i data-lucide="check"
                                class="w-4 h-4 text-green-500"></i>1000 Env√≠os Masivos</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500"></i>20
                            Mejoras con IA</li>
                        <li class="flex items-center gap-2"><i data-lucide="check"
                                class="w-4 h-4 text-green-500"></i>Manejo de Productos</li>
                        <li class="flex items-center gap-2"><i data-lucide="check"
                                class="w-4 h-4 text-green-500"></i>Plantillas de Mensajes</li>
                        <li class="flex items-center gap-2"><i data-lucide="check"
                                class="w-4 h-4 text-green-500"></i>Gesti√≥n de Etiquetas</li>
                        <li class="flex items-center gap-2"><i data-lucide="check"
                                class="w-4 h-4 text-green-500"></i>Seguimientos Autom√°ticos</li>
                    </ul>
                    <button
                        class="upgrade-btn mt-6 w-full bg-purple-600 text-white font-bold py-3 rounded-lg hover:bg-purple-700"
                        data-plan="grow">
                        Elegir Grow
                    </button>
                </div>
            </div>
            <div class="p-4 bg-slate-50 text-center rounded-b-lg">
                <button id="cancel-pricing-modal-btn" class="text-sm text-slate-600 hover:underline">Seguir con la
                    prueba</button>
            </div>
        </div>
    </div>

    <!-- Modal Global de Informaci√≥n del Contacto -->
    <div id="contact-info-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <!-- Cabecera -->
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Informaci√≥n del Contacto</h3>
                <button id="close-contact-info-modal-btn" class="p-2 rounded-full hover:bg-slate-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <!-- Cuerpo -->
            <div id="contact-info-modal-body" class="p-6 space-y-4">
                <!-- El contenido se llenar√° din√°micamente -->
                <div class="text-center text-slate-500">Cargando...</div>
            </div>
            <!-- Pie de p√°gina con acciones -->
            <div class="p-6 bg-slate-50 flex justify-end gap-3 rounded-b-lg">
                <button id="contact-info-modal-labels-btn"
                    class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">
                    Gestionar Etiquetas
                </button>
                <button id="contact-info-modal-chat-btn"
                    class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                    Abrir Chat
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Visor de Im√°genes -->
    <div id="image-viewer-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[80] p-4 cursor-pointer">
        <div class="relative w-[90vw] h-[80vh] cursor-default flex flex-col items-center justify-center">
            <div id="image-viewer-content"
                class="w-full h-full bg-black rounded-lg overflow-hidden flex items-center justify-center">
                <!-- El contenido (imagen o iframe) se insertar√° aqu√≠ -->
            </div>
            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-3 z-10">
                <button id="download-image-viewer-btn"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 flex items-center gap-2 shadow-lg">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    Descargar
                </button>
            </div>
            <button id="close-image-viewer-btn"
                class="absolute -top-3 -right-3 bg-white text-slate-800 rounded-full p-2 shadow-lg hover:bg-slate-200 z-10 cursor-pointer">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <!-- Modal para Galer√≠a Completa -->
    <div id="full-gallery-modal"
        class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[70] p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col">
            <!-- Cabecera -->
            <div class="p-4 border-b flex justify-between items-center flex-shrink-0">
                <h3 class="text-xl font-bold text-slate-800">Mi Galer√≠a de Creaciones</h3>
                <button id="close-full-gallery-modal-btn" class="p-2 rounded-full hover:bg-slate-100">
                    <i data-lucide="x" class="w-6 h-6 text-slate-600"></i>
                </button>
            </div>
            <!-- Cuerpo con scroll -->
            <div id="full-gallery-content" class="p-6 flex-grow overflow-y-auto">
                <!-- Las im√°genes se insertar√°n aqu√≠ -->
                <div class="text-center text-slate-500">Cargando galer√≠a...</div>
            </div>
        </div>
    </div>

    <!-- Modal Promos Inteligentes -->
    <div id="smart-promo-modal" class="hidden fixed inset-0 z-40 items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" data-modal-close></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-3xl mx-auto p-6 overflow-y-auto max-h-[90vh]">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-xs uppercase font-semibold text-slate-400">Promos Inteligentes</p>
                    <h3 id="smart-promo-modal-title" class="text-2xl font-bold text-slate-900">Nueva Promo</h3>
                </div>
                <button class="p-2 rounded-full hover:bg-slate-100" data-modal-close><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <form id="smart-promo-form" class="grid gap-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <label class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                        T√≠tulo
                        <input id="smart-promo-title" type="text" class="form-input" placeholder="Ej. 2x1 en noviembre"
                            required>
                    </label>
                    <label class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                        CTA sugerido
                        <input id="smart-promo-cta" type="text" class="form-input" placeholder="Agenda tu demo hoy">
                    </label>
                </div>
                <label class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                    Descripci√≥n breve
                    <textarea id="smart-promo-description" rows="3" class="form-input"
                        placeholder="Describe la promo en 1 o 2 frases" required></textarea>
                </label>
                <label class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                    Beneficios / detalles (opcional)
                    <textarea id="smart-promo-benefits" rows="3" class="form-input"
                        placeholder="Incluye condiciones, beneficios u objeciones"></textarea>
                </label>
                <div class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                    Im√°genes de la promoci√≥n
                    <div id="smart-promo-images-container"
                        class="grid grid-cols-2 md:grid-cols-4 gap-3 min-h-[100px] p-3 border border-slate-200 rounded-lg bg-slate-50">
                        <!-- Las im√°genes se renderizar√°n aqu√≠ din√°micamente -->
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Haz clic en el √°rea de subida para agregar im√°genes. Tambi√©n
                        puedes ingresar URLs manualmente:</p>
                    <input id="smart-promo-images" type="text" class="form-input text-xs"
                        placeholder="O ingresa URLs separadas por comas: https://...">
                </div>
                <div class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                    Inserci√≥n autom√°tica
                    <label class="inline-flex items-center gap-2 text-sm font-normal text-slate-600">
                        <input id="smart-promo-auto" type="checkbox" class="form-checkbox h-5 w-5 text-blue-600"
                            checked>
                        Permitir que la IA la inserte cuando conviene
                    </label>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <label class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                        Inicio
                        <input id="smart-promo-start" type="datetime-local" class="form-input">
                    </label>
                    <label class="flex flex-col gap-2 text-sm font-semibold text-slate-700">
                        Fin
                        <input id="smart-promo-end" type="datetime-local" class="form-input">
                    </label>
                </div>
                <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between border rounded-xl p-4">
                    <label class="inline-flex items-center gap-2 text-sm font-semibold text-slate-700">
                        <input id="smart-promo-no-schedule" type="checkbox" class="form-checkbox h-5 w-5 text-blue-600">
                        Sin horario definido
                    </label>
                    <label class="inline-flex items-center gap-2 text-sm font-semibold text-slate-700">
                        <input id="smart-promo-active" type="checkbox" class="form-checkbox h-5 w-5 text-blue-600"
                            checked>
                        Activa inmediatamente
                    </label>
                    <label class="flex items-center gap-2 text-sm font-semibold text-slate-700">
                        M√°x. menciones/d√≠a
                        <input id="smart-promo-max-mentions" type="number" min="1" max="20"
                            class="form-input w-24 text-right" value="3">
                    </label>
                </div>
                <div class="flex flex-col gap-2">
                    <button type="button" id="smart-promo-ai-btn"
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-blue-200 text-blue-600 text-sm font-semibold hover:bg-blue-50 w-fit">
                        <i data-lucide="wand-2" class="w-4 h-4"></i> Mejorar con IA
                    </button>
                    <p class="text-xs text-slate-500">Usa el asistente de IA para reescribir la promo con tono
                        comercial.</p>
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button"
                        class="px-4 py-2 rounded-lg border border-slate-200 text-sm font-semibold text-slate-600 hover:bg-slate-100"
                        data-modal-close>Cancelar</button>
                    <button type="submit"
                        class="px-6 py-2 rounded-lg bg-blue-600 text-white font-semibold text-sm hover:bg-blue-700">Guardar
                        Promo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- INICIO: Modal del Asistente de Configuraci√≥n -->
    <div id="wizard-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[90] p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
            <!-- Cabecera -->
            <div class="p-5 border-b flex justify-between items-center flex-shrink-0">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="wand-2" class="text-purple-500"></i>
                    Asistente de Configuraci√≥n de IA
                </h3>
                <button id="close-wizard-btn" class="p-2 rounded-full hover:bg-slate-100">
                    <i data-lucide="x" class="w-6 h-6 text-slate-600"></i>
                </button>
            </div>
            <!-- Contenido de los Pasos -->
            <div class="flex-grow overflow-y-auto p-8">
                <!-- Paso 1: Conectar WhatsApp -->
                <div id="wizard-step-1" class="wizard-step hidden">
                    <div class="text-center">
                        <h4 class="text-2xl font-bold mb-4">Paso 1: Conecta tu WhatsApp</h4>
                        <p class="text-slate-600 max-w-2xl mx-auto mb-6">Para que Elina pueda responder, primero
                            necesita acceso a tu WhatsApp. Haz clic en "Solicitar QR" y escanea el c√≥digo con tu celular
                            desde <strong>WhatsApp > Dispositivos Vinculados > Vincular un dispositivo</strong>.</p>
                        <div id="wizard-qr-container"
                            class="bg-slate-100 rounded-lg p-4 min-h-[240px] flex items-center justify-center w-full max-w-sm mx-auto">
                            <!-- El QR o estado de conexi√≥n se mostrar√° aqu√≠ -->
                        </div>
                        <button id="wizard-request-qr-btn"
                            class="mt-6 bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition">
                            Solicitar QR
                        </button>
                    </div>
                </div>

                <!-- Paso 2: Sincronizar Contactos -->
                <div id="wizard-step-2" class="wizard-step hidden">
                    <div class="text-center">
                        <h4 class="text-2xl font-bold mb-4">Paso 2: Sincroniza tus Contactos</h4>
                        <p class="text-slate-600 max-w-2xl mx-auto mb-6">Ahora, vamos a importar tus contactos de
                            WhatsApp para que Elina los conozca. Presiona el bot√≥n "Sincronizar".</p>
                        <p class="text-slate-500 text-sm mb-8">(Este proceso puede tardar unos minutos. Puedes continuar
                            con el siguiente paso mientras se completa).</p>
                        <button id="wizard-sync-contacts-btn"
                            class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center justify-center gap-2 mx-auto">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i><span>Sincronizar</span>
                        </button>
                    </div>
                </div>

                <!-- Paso 3: Informaci√≥n de la Empresa -->
                <div id="wizard-step-3" class="wizard-step hidden">
                    <h4 class="text-2xl font-bold mb-4 text-center">Paso 3: Datos de tu Empresa</h4>
                    <p class="text-slate-500 mb-8 text-center">Informaci√≥n b√°sica para que Elina entienda tu negocio</p>
                    <form id="wizard-company-form" class="space-y-6 max-w-3xl mx-auto">
                        <!-- Nombre de la Empresa -->
                        <div class="bg-white rounded-2xl shadow-lg border-2 border-blue-100 overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                        <i data-lucide="building-2" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h5 class="text-lg font-bold text-white">Informaci√≥n B√°sica</h5>
                                        <p class="text-xs text-blue-100">Datos principales de tu empresa</p>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6 space-y-4">
                                <div>
                                    <label class="block text-sm font-bold text-slate-800 mb-2">
                                        Nombre de la Empresa <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="wizard-company-name" placeholder="Ej: Mi Empresa S.A."
                                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all"
                                        required>
                                    <p class="text-xs text-slate-500 mt-1.5">Aparecer√° en cotizaciones y comunicaciones
                                    </p>
                                </div>

                                <div>
                                    <label class="block text-sm font-bold text-slate-800 mb-2">
                                        ¬øQu√© vendes? <span class="text-red-500">*</span>
                                    </label>
                                    <textarea id="wizard-company-description" rows="5"
                                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none resize-none transition-all"
                                        placeholder="Ej: Tienda de electr√≥nica especializada en Arduino, Raspberry Pi y filamentos 3D. NO vendemos celulares."></textarea>
                                    <p class="text-xs text-slate-500 mt-1.5">La IA usar√° esto para saber qu√© S√ç y qu√© NO
                                        vendes</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-bold text-slate-800 mb-2">
                                        Tipo de Negocio <span class="text-red-500">*</span>
                                    </label>
                                    <select id="wizard-business-type"
                                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all"
                                        required>
                                        <option value="both">üõçÔ∏è Ambos (E-commerce y Servicios)</option>
                                        <option value="ecommerce">üì¶ E-commerce (Productos F√≠sicos)</option>
                                        <option value="services">‚öôÔ∏è Servicios</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Horario de Atenci√≥n -->
                        <div class="bg-white rounded-2xl shadow-lg border-2 border-emerald-100 overflow-hidden">
                            <div class="bg-gradient-to-r from-emerald-500 to-teal-600 px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                        <i data-lucide="clock" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h5 class="text-lg font-bold text-white">Horario</h5>
                                        <p class="text-xs text-emerald-100">Atenci√≥n al cliente</p>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-bold text-slate-800 mb-2">Apertura</label>
                                        <input type="time" id="wizard-work-start-hour"
                                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-800 mb-2">Cierre</label>
                                        <input type="time" id="wizard-work-end-hour"
                                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none transition-all">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Paso 4: Comportamiento de la IA -->
                <div id="wizard-step-4" class="wizard-step hidden">
                    <h4 class="text-2xl font-bold mb-4 text-center">Paso 4: Personalidad de Elina</h4>
                    <p class="text-slate-500 mb-8 text-center">Define c√≥mo quieres que se comporte tu asistente IA</p>
                    <form id="wizard-qa-form" class="space-y-8 max-w-4xl mx-auto">

                        <!-- Personalidad del Asistente -->
                        <div class="bg-white rounded-2xl shadow-lg border-2 border-purple-100 overflow-hidden">
                            <div class="bg-gradient-to-r from-purple-500 to-pink-600 px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                        <i data-lucide="sparkles" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h5 class="text-lg font-bold text-white">Tono y Estilo</h5>
                                        <p class="text-xs text-purple-100">Selecciona c√≥mo quieres que responda</p>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6">
                                <div class="grid md:grid-cols-3 gap-4">
                                    <label class="cursor-pointer">
                                        <input type="radio" name="persona" value="friendly" class="peer hidden" checked>
                                        <div
                                            class="h-full p-5 rounded-xl border-2 border-slate-200 peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:bg-slate-50 transition-all shadow-sm hover:shadow-md">
                                            <div
                                                class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center mb-3">
                                                <i data-lucide="smile" class="w-6 h-6 text-white"></i>
                                            </div>
                                            <div class="font-bold text-slate-800 text-lg mb-1">Amigable</div>
                                            <p class="text-xs text-slate-500">C√°lido, emp√°tico y usa emojis. Perfecto
                                                para B2C y marcas cercanas.</p>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="persona" value="professional" class="peer hidden">
                                        <div
                                            class="h-full p-5 rounded-xl border-2 border-slate-200 peer-checked:border-purple-500 peer-checked:bg-purple-50 hover:bg-slate-50 transition-all shadow-sm hover:shadow-md">
                                            <div
                                                class="w-12 h-12 bg-gradient-to-br from-purple-400 to-purple-600 rounded-full flex items-center justify-center mb-3">
                                                <i data-lucide="briefcase" class="w-6 h-6 text-white"></i>
                                            </div>
                                            <div class="font-bold text-slate-800 text-lg mb-1">Profesional</div>
                                            <p class="text-xs text-slate-500">Formal, directo y experto. Ideal para B2B,
                                                legal o m√©dico.</p>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="persona" value="sales" class="peer hidden">
                                        <div
                                            class="h-full p-5 rounded-xl border-2 border-slate-200 peer-checked:border-green-500 peer-checked:bg-green-50 hover:bg-slate-50 transition-all shadow-sm hover:shadow-md">
                                            <div
                                                class="w-12 h-12 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center mb-3">
                                                <i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
                                            </div>
                                            <div class="font-bold text-slate-800 text-lg mb-1">Vendedor</div>
                                            <p class="text-xs text-slate-500">Persuasivo y propositivo. Perfecto para
                                                e-commerce y promociones.</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Instrucciones Adicionales (Opcional) -->
                        <div class="bg-white rounded-2xl shadow-lg border-2 border-slate-100 overflow-hidden">
                            <div class="bg-gradient-to-r from-slate-600 to-slate-800 px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                        <i data-lucide="file-text" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h5 class="text-lg font-bold text-white">Instrucciones Especiales</h5>
                                        <p class="text-xs text-slate-100">Opcional - Comportamientos espec√≠ficos</p>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6">
                                <textarea name="custom_instructions" rows="4"
                                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-slate-500 outline-none resize-none transition-all"
                                    placeholder="Ej: Siempre mencionar env√≠o gratis en compras mayores a $500. Usar lenguaje inclusivo. Preguntar por presupuesto antes de ofrecer servicios premium."></textarea>
                                <p class="text-xs text-slate-500 mt-2">üí° Agrega reglas espec√≠ficas sobre c√≥mo debe
                                    responder en ciertas situaciones</p>
                            </div>
                        </div>

                    </form>
                </div>

                <!-- Paso 4: Finalizaci√≥n -->
                <div id="wizard-step-5" class="wizard-step hidden text-center">
                    <div id="wizard-loading" class="flex flex-col items-center justify-center h-full">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600"></div>
                        <p class="text-slate-600 mt-4 font-semibold">Analizando tus respuestas y creando el prompt
                            perfecto...</p>
                    </div>
                    <div id="wizard-success" class="hidden">
                        <i data-lucide="party-popper" class="w-20 h-20 text-green-500 mx-auto mb-4"></i>
                        <h4 class="text-2xl font-bold mb-2">¬°Todo Listo!</h4>
                        <p class="text-slate-600 max-w-2xl mx-auto">Hemos generado y guardado un prompt de IA optimizado
                            para tu negocio. Ahora Elina est√° lista para empezar a trabajar. Puedes revisar y ajustar el
                            prompt en cualquier momento en el panel principal.</p>
                    </div>
                </div>

            </div>
            <!-- Pie de p√°gina con botones -->
            <div class="p-5 bg-slate-50 border-t flex justify-between items-center flex-shrink-0">
                <button id="wizard-prev-btn"
                    class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 disabled:opacity-50 disabled:cursor-not-allowed">Anterior</button>
                <div id="wizard-step-indicator" class="text-sm font-semibold text-slate-500">Paso 1 de 4</div>
                <button id="wizard-next-btn"
                    class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 w-40 text-center">Siguiente</button>
                <button id="wizard-finish-btn"
                    class="hidden bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Finalizar y
                    Generar Prompt</button>
            </div>
        </div>
    </div>
    <!-- FIN: Modal del Asistente de Configuraci√≥n -->

    <!-- Modal para Importar N√∫meros con Etiqueta -->
    <div id="import-numbers-label-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold text-slate-800">Importar N√∫meros con Etiqueta</h3>
                    <button id="close-import-numbers-modal" class="text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="block font-semibold text-slate-800 mb-2">1. Selecciona el archivo con los
                        n√∫meros</label>
                    <p class="text-sm text-slate-600 mb-3">El archivo debe contener n√∫meros de tel√©fono. Formatos
                        aceptados: TXT, CSV, XLSX, XLS</p>
                    <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50"
                        id="numbers-file-drop-zone">
                        <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto text-slate-400 mb-2"></i>
                        <p class="text-slate-600">Arrastra un archivo o <span class="text-blue-600 font-semibold">haz
                                clic para seleccionar</span></p>
                        <p class="text-xs text-slate-400 mt-1">TXT, CSV, XLSX, XLS (se extraer√°n los n√∫meros de todas
                            las celdas)</p>
                        <input type="file" id="numbers-file-input" class="hidden" accept=".txt,.csv,.xlsx,.xls">
                    </div>
                    <div id="numbers-file-preview" class="hidden mt-4 p-3 bg-slate-100 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i data-lucide="file-check" class="text-green-500"></i>
                                <span id="numbers-file-name" class="text-sm font-medium"></span>
                                <span id="numbers-count" class="text-xs text-slate-500"></span>
                            </div>
                            <button type="button" id="remove-numbers-file"
                                class="text-red-500 hover:bg-red-100 p-1 rounded-full">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block font-semibold text-slate-800 mb-2">2. Seleccionar o crear etiqueta</label>
                    <p class="text-sm text-slate-600 mb-3">Elige una etiqueta existente o crea una nueva. Todos los
                        n√∫meros se asociar√°n con esta etiqueta. Si el contacto ya existe, se le agregar√° la etiqueta.
                    </p>

                    <!-- Selector de etiquetas existentes -->
                    <div class="mb-3">
                        <select id="label-select" class="form-input w-full">
                            <option value="">-- Selecciona una etiqueta existente --</option>
                            <option value="__new__">+ Crear nueva etiqueta</option>
                        </select>
                    </div>

                    <!-- Input para crear nueva etiqueta (oculto por defecto) -->
                    <div id="new-label-input-container" class="hidden">
                        <input type="text" id="label-name-input" class="form-input w-full"
                            placeholder="Ej: Clientes-23-24">
                    </div>
                </div>
                <div id="import-numbers-progress" class="hidden">
                    <div class="bg-slate-100 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span id="import-progress-text"
                                class="text-sm font-medium text-slate-700">Procesando...</span>
                            <span id="import-progress-percent" class="text-sm text-slate-500">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2">
                            <div id="import-progress-bar"
                                class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="import-numbers-results" class="hidden">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="font-semibold text-green-800 mb-2">Resultados de la importaci√≥n:</h4>
                        <ul class="text-sm text-green-700 space-y-1">
                            <li id="result-new-contacts">‚Ä¢ Contactos nuevos: 0</li>
                            <li id="result-updated-contacts">‚Ä¢ Contactos actualizados: 0</li>
                            <li id="result-skipped-contacts">‚Ä¢ N√∫meros omitidos: 0</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-slate-200 flex justify-end gap-3">
                <button id="cancel-import-numbers"
                    class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300">
                    Cancelar
                </button>
                <button id="confirm-import-numbers"
                    class="bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    Importar N√∫meros
                </button>
            </div>
        </div>
    </div>
    <!-- FIN: Modal para Importar N√∫meros con Etiqueta -->

    <!-- INICIO: Modal para Iniciar Chat Nuevo -->
    <div id="new-chat-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[90] px-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
            <div class="p-6 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold text-slate-800">Iniciar Chat Nuevo</h3>
                    <button id="close-new-chat-modal" class="text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <!-- Opci√≥n: Contacto existente o nuevo -->
                <div>
                    <label class="block font-semibold text-slate-800 mb-2">Selecciona una opci√≥n</label>
                    <div class="space-y-2">
                        <label
                            class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                            <input type="radio" name="chat-option" value="existing" class="w-4 h-4 text-blue-600"
                                checked>
                            <div>
                                <span class="font-medium text-slate-800">Contacto existente</span>
                                <p class="text-xs text-slate-500">Selecciona de tus contactos registrados</p>
                            </div>
                        </label>
                        <label
                            class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                            <input type="radio" name="chat-option" value="new" class="w-4 h-4 text-blue-600">
                            <div>
                                <span class="font-medium text-slate-800">Contacto nuevo</span>
                                <p class="text-xs text-slate-500">Ingresa un n√∫mero de tel√©fono nuevo</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Selector de contacto existente -->
                <div id="existing-contact-container">
                    <label for="existing-contact-search" class="block font-semibold text-slate-800 mb-2">Buscar
                        contacto</label>
                    <input type="text" id="existing-contact-search" class="form-input w-full"
                        placeholder="Buscar por nombre o n√∫mero de tel√©fono..." autocomplete="off">
                    <input type="hidden" id="existing-contact-select" value="">
                    <div id="existing-contact-results"
                        class="hidden mt-2 max-h-60 overflow-y-auto border border-slate-200 rounded-lg bg-white shadow-lg">
                        <!-- Los resultados de b√∫squeda se mostrar√°n aqu√≠ -->
                    </div>
                </div>

                <!-- Input para contacto nuevo -->
                <div id="new-contact-container" class="hidden">
                    <label for="new-contact-phone" class="block font-semibold text-slate-800 mb-2">N√∫mero de
                        tel√©fono</label>
                    <input type="tel" id="new-contact-phone" class="form-input w-full" placeholder="Ej: +521234567890">
                    <p class="text-xs text-slate-500 mt-1">Ingresa el n√∫mero en formato internacional (ej:
                        +521234567890)</p>

                    <label for="new-contact-name" class="block font-semibold text-slate-800 mb-2 mt-4">Nombre
                        (opcional)</label>
                    <input type="text" id="new-contact-name" class="form-input w-full"
                        placeholder="Nombre del contacto">
                </div>
            </div>
            <div class="p-6 border-t border-slate-200 flex justify-end gap-3">
                <button id="cancel-new-chat"
                    class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300">
                    Cancelar
                </button>
                <button id="confirm-new-chat"
                    class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    Iniciar Chat
                </button>
            </div>
        </div>
    </div>
    <!-- FIN: Modal para Iniciar Chat Nuevo -->

    <!-- Carga de Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

    <!-- FIX INMEDIATO PARA QR - Sin depender de cache de app.js -->
    <script>
        console.log('üîß QR FIX INLINE CARGADO');
        // Observar cambios en el DOM para corregir QRs con prefijo duplicado
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                        // Buscar imgs en el nodo agregado
                        const imgs = node.tagName === 'IMG' ? [node] : node.querySelectorAll?.('img') || [];
                        imgs.forEach((img) => {
                            if (img.src && img.src.includes('data:image/png;base64,data:image/png;base64,')) {
                                console.log('üîß Corrigiendo QR con prefijo duplicado');
                                // Extraer solo la parte base64
                                const parts = img.src.split(',');
                                if (parts.length >= 3) {
                                    const cleanBase64 = parts[2]; // Tomar la segunda parte base64
                                    img.src = `data:image/png;base64,${cleanBase64}`;
                                    console.log('‚úÖ QR corregido');
                                }
                            }
                        });
                    }
                });
            });
        });

        // Observar todo el body
        document.addEventListener('DOMContentLoaded', () => {
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            console.log('üëÄ Observer de QR activado');
        });
    </script>

    <script>
        // üîß HACK 1: Interceptar fetch ANTES de cargar app.js
        const originalFetch = window.fetch;
        window.fetch = async function (...args) {
            const response = await originalFetch(...args);
            if (args[0]?.includes?.('manage-whatsapp-instance')) {
                const clone = response.clone();
                clone.json().then(data => {
                    console.log('üì¶ [HACK] Respuesta capturada:', data);

                    // Si es pairing code, renderizar inmediatamente
                    if (data.pairingCode) {
                        setTimeout(() => {
                            const container = document.getElementById('whatsapp-connection-container');
                            if (container) {
                                const formattedCode = data.pairingCode.length === 8
                                    ? `${data.pairingCode.substring(0, 4)}-${data.pairingCode.substring(4)}`
                                    : data.pairingCode;

                                console.log('üéØ [HACK] Forzando pairing code:', formattedCode);
                                container.innerHTML = `
                                    <div class="flex flex-col items-center justify-center p-6 bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl border-2 border-purple-200">
                                        <div class="text-6xl font-black text-purple-700 tracking-widest mb-4 font-mono">
                                            ${formattedCode}
                                        </div>
                                        <p class="font-bold text-slate-800">C√≥digo de Emparejamiento</p>
                                        <p class="text-sm text-slate-600 mt-2 text-center">
                                            Ingresa este c√≥digo en WhatsApp > Dispositivos Vinculados > Vincular con n√∫mero de tel√©fono
                                        </p>
                                    </div>`;
                            }
                        }, 100);
                    }
                }).catch(() => { });
            }
            return response;
        };
        console.log('‚úÖ [HACK] Fetch interceptor instalado');
    </script>

    <script type="module" src="/app.js"></script>

    <!-- Componente de Notificaci√≥n Toast (Global) -->
    <div id="toast-notification"
        class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-3 px-5 rounded-lg shadow-lg flex items-center gap-3 z-[100] transform translate-y-[150%] transition-transform duration-300 ease-in-out">
        <i id="toast-icon" data-lucide="check-circle" class="w-5 h-5"></i>
        <span id="toast-message"></span>
    </div>

    <!-- Sistema de Modales Personalizados (Reemplazo de alert/prompt/confirm) -->
    <!-- Modal de Confirmaci√≥n -->
    <div id="app-confirm-modal"
        class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-[200]"
        onclick="window.appModal?.closeConfirm?.()">
        <div class="bg-white w-full max-w-md m-4 p-6 rounded-xl shadow-2xl border border-slate-200"
            onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h2 id="app-confirm-title" class="text-xl font-bold text-slate-800">Confirmar</h2>
                <button type="button" onclick="window.appModal?.closeConfirm?.()"
                    class="text-slate-400 hover:text-slate-600 transition-colors" aria-label="Cerrar">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="mb-6">
                <p id="app-confirm-message" class="text-slate-600"></p>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="app-confirm-cancel" onclick="window.appModal?.closeConfirm?.()"
                    class="px-4 py-2 bg-slate-200 text-slate-700 font-semibold rounded-md hover:bg-slate-300 transition-colors">
                    Cancelar
                </button>
                <button type="button" id="app-confirm-ok" onclick="window.appModal?.confirmOk?.()"
                    class="px-4 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 transition-colors">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Prompt (Input) -->
    <div id="app-prompt-modal"
        class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-[200]"
        onclick="window.appModal?.closePrompt?.()">
        <div class="bg-white w-full max-w-md m-4 p-6 rounded-xl shadow-2xl border border-slate-200"
            onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h2 id="app-prompt-title" class="text-xl font-bold text-slate-800">Ingresar</h2>
                <button type="button" onclick="window.appModal?.closePrompt?.()"
                    class="text-slate-400 hover:text-slate-600 transition-colors" aria-label="Cerrar">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="mb-6">
                <p id="app-prompt-message" class="text-slate-600 mb-3"></p>
                <input type="text" id="app-prompt-input"
                    class="w-full px-4 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                    placeholder="Escribe aqu√≠...">
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="app-prompt-cancel" onclick="window.appModal?.closePrompt?.()"
                    class="px-4 py-2 bg-slate-200 text-slate-700 font-semibold rounded-md hover:bg-slate-300 transition-colors">
                    Cancelar
                </button>
                <button type="button" id="app-prompt-ok" onclick="window.appModal?.promptOk?.()"
                    class="px-4 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 transition-colors">
                    Aceptar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Selecci√≥n (Para confirm con opciones) -->
    <div id="app-select-modal"
        class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-[200]"
        onclick="window.appModal?.closeSelect?.()">
        <div class="bg-white w-full max-w-md m-4 p-6 rounded-xl shadow-2xl border border-slate-200"
            onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h2 id="app-select-title" class="text-xl font-bold text-slate-800">Seleccionar</h2>
                <button type="button" onclick="window.appModal?.closeSelect?.()"
                    class="text-slate-400 hover:text-slate-600 transition-colors" aria-label="Cerrar">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="mb-6">
                <p id="app-select-message" class="text-slate-600 mb-4"></p>
                <div id="app-select-options" class="space-y-2"></div>
            </div>
            <div class="flex justify-end">
                <button type="button" id="app-select-cancel" onclick="window.appModal?.closeSelect?.()"
                    class="px-4 py-2 bg-slate-200 text-slate-700 font-semibold rounded-md hover:bg-slate-300 transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Script para sistema de modales -->
    <script>
        // Sistema de Modales Personalizados (Reemplazo de alert/prompt/confirm)
        window.appModal = {
            // Confirmaci√≥n (reemplaza confirm())
            confirm: function (message, title = 'Confirmar') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('app-confirm-modal');
                    const titleEl = document.getElementById('app-confirm-title');
                    const messageEl = document.getElementById('app-confirm-message');
                    const okBtn = document.getElementById('app-confirm-ok');
                    const cancelBtn = document.getElementById('app-confirm-cancel');

                    titleEl.textContent = title;
                    messageEl.textContent = message;
                    modal.classList.remove('hidden');

                    // Limpiar listeners anteriores
                    const newOkBtn = okBtn.cloneNode(true);
                    const newCancelBtn = cancelBtn.cloneNode(true);
                    okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                    newOkBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(true);
                    };
                    newCancelBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(false);
                    };

                    if (window.lucide?.createIcons) {
                        window.lucide.createIcons({ root: modal });
                    }
                });
            },

            closeConfirm: function () {
                const modal = document.getElementById('app-confirm-modal');
                modal.classList.add('hidden');
            },

            confirmOk: function () {
                const okBtn = document.getElementById('app-confirm-ok');
                okBtn.click();
            },

            // Prompt (reemplaza prompt())
            prompt: function (message, defaultValue = '', title = 'Ingresar') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('app-prompt-modal');
                    const titleEl = document.getElementById('app-prompt-title');
                    const messageEl = document.getElementById('app-prompt-message');
                    const inputEl = document.getElementById('app-prompt-input');
                    const okBtn = document.getElementById('app-prompt-ok');
                    const cancelBtn = document.getElementById('app-prompt-cancel');

                    titleEl.textContent = title;
                    messageEl.textContent = message;
                    inputEl.value = defaultValue;
                    modal.classList.remove('hidden');
                    inputEl.focus();
                    inputEl.select();

                    // Limpiar listeners anteriores
                    const newOkBtn = okBtn.cloneNode(true);
                    const newCancelBtn = cancelBtn.cloneNode(true);
                    okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                    const handleOk = () => {
                        const value = inputEl.value.trim();
                        modal.classList.add('hidden');
                        resolve(value || null);
                    };

                    const handleCancel = () => {
                        modal.classList.add('hidden');
                        resolve(null);
                    };

                    newOkBtn.onclick = handleOk;
                    newCancelBtn.onclick = handleCancel;

                    inputEl.onkeydown = (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleOk();
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            handleCancel();
                        }
                    };

                    if (window.lucide?.createIcons) {
                        window.lucide.createIcons({ root: modal });
                    }
                });
            },

            closePrompt: function () {
                const modal = document.getElementById('app-prompt-modal');
                modal.classList.add('hidden');
            },

            promptOk: function () {
                const okBtn = document.getElementById('app-prompt-ok');
                okBtn.click();
            },

            // Select (para confirm con opciones)
            select: function (message, options, title = 'Seleccionar') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('app-select-modal');
                    const titleEl = document.getElementById('app-select-title');
                    const messageEl = document.getElementById('app-select-message');
                    const optionsEl = document.getElementById('app-select-options');
                    const cancelBtn = document.getElementById('app-select-cancel');

                    titleEl.textContent = title;
                    messageEl.textContent = message;
                    optionsEl.innerHTML = '';

                    options.forEach((option, index) => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'w-full px-4 py-3 text-left bg-slate-50 hover:bg-green-50 border border-slate-200 rounded-md transition-colors font-medium text-slate-700';
                        btn.textContent = option.label || option;
                        btn.onclick = () => {
                            modal.classList.add('hidden');
                            resolve(option.value !== undefined ? option.value : option);
                        };
                        optionsEl.appendChild(btn);
                    });

                    modal.classList.remove('hidden');

                    const newCancelBtn = cancelBtn.cloneNode(true);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                    newCancelBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(null);
                    };

                    if (window.lucide?.createIcons) {
                        window.lucide.createIcons({ root: modal });
                    }
                });
            },

            closeSelect: function () {
                const modal = document.getElementById('app-select-modal');
                modal.classList.add('hidden');
            }
        };
    </script>

    <!-- Modal para Crear Cr√≠tico con IA -->
    <div id="critical-rule-ai-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold text-slate-800">Crear Cr√≠tico Personalizado</h3>
                    <button id="close-critical-rule-ai-modal" class="text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-6">
                <!-- Paso 1: Nombre del cr√≠tico -->
                <div>
                    <label class="block font-semibold text-slate-800 mb-2">1. Nombra tu Asunto cr√≠tico</label>
                    <input type="text" id="critical-rule-name-input" class="form-input w-full"
                        placeholder="Ej: Consulta de env√≠o">
                </div>

                <!-- Paso 2: Descripci√≥n de qu√© detectar -->
                <div>
                    <label class="block font-semibold text-slate-800 mb-2">2. Cu√©ntame qu√© es lo que debemos
                        detectar</label>
                    <textarea id="critical-rule-description-input" class="form-input w-full h-24 resize-none"
                        placeholder="Ej: Quiero detectar cuando un cliente pregunta por el estado de su env√≠o o pedido, usando palabras como d√≥nde, env√≠o, pedido, paquete..."></textarea>
                    <p class="text-xs text-slate-500 mt-1">Describe en lenguaje natural qu√© tipo de mensajes quieres
                        detectar</p>
                </div>

                <!-- Bot√≥n de optimizar por IA -->
                <div>
                    <button id="optimize-pattern-ai-btn"
                        class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="sparkles" class="w-5 h-5"></i>
                        <span>Generar Patr√≥n de Detecci√≥n con IA</span>
                    </button>
                    <p class="text-xs text-center text-slate-500 mt-2">Debes hacer clic aqu√≠ para crear la regla t√©cnica
                    </p>
                </div>

                <!-- Resultado de la IA -->
                <div id="ai-pattern-result-container" class="hidden space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-semibold text-blue-900 mb-2">La IA interpret√≥ que debe reconocer lo siguiente:
                        </h4>
                        <p id="ai-pattern-explanation" class="text-sm text-blue-800 mb-3"></p>
                        <div class="bg-white border border-blue-300 rounded p-3">
                            <code id="ai-generated-pattern" class="text-sm text-slate-800 font-mono break-all"></code>
                        </div>
                    </div>

                    <!-- Campo editable para el patr√≥n -->
                    <div>
                        <label class="block font-semibold text-slate-800 mb-2">¬øQuisieras modificarle algo?</label>
                        <textarea id="critical-rule-pattern-input"
                            class="form-input w-full h-20 resize-none font-mono text-sm"
                            placeholder="Puedes editar el patr√≥n generado por la IA aqu√≠..."></textarea>
                        <p class="text-xs text-slate-500 mt-1">Puedes editar el patr√≥n si necesitas ajustarlo</p>
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="flex gap-3 pt-4 border-t border-slate-200">
                    <button id="cancel-critical-rule-ai"
                        class="flex-1 py-2 px-4 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 font-semibold">
                        Cancelar
                    </button>
                    <button id="save-critical-rule-ai"
                        class="flex-1 py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                        Guardar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Configuraci√≥n de Cotizaciones -->
        <div id="quote-settings-modal"
            class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex justify-between items-center">
                    <h3 class="text-2xl font-bold">Personalizar Cotizaciones PDF</h3>
                    <button id="close-quote-settings-btn" class="p-2 text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="p-6 space-y-6">
                    <!-- Mensaje informativo -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-blue-800">
                            <i data-lucide="info" class="w-4 h-4 inline-block mr-2"></i>
                            Los datos mostrados provienen de tu configuraci√≥n general. Puedes editarlos aqu√≠ o en
                            Configuraci√≥n.
                        </p>
                    </div>

                    <!-- Informaci√≥n de la Empresa -->
                    <div class="border-b border-slate-200 pb-6">
                        <h4 class="text-lg font-semibold mb-4">Informaci√≥n de la Empresa</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Nombre de la Empresa
                                    *</label>
                                <input type="text" id="quote-company-name"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Tipo de Empresa</label>
                                <select id="quote-company-type"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                                    <option value="individual">Persona Individual</option>
                                    <option value="business">Negocio</option>
                                    <option value="corporation">Corporaci√≥n</option>
                                    <option value="other">Otro</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Direcci√≥n</label>
                                <input type="text" id="quote-company-address"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Tel√©fono</label>
                                <input type="tel" id="quote-company-phone"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Email</label>
                                <input type="email" id="quote-company-email"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Sitio Web</label>
                                <input type="url" id="quote-company-website"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">RFC / ID Fiscal</label>
                                <input type="text" id="quote-tax-id"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Horarios de
                                    Atenci√≥n</label>
                                <input type="text" id="quote-business-hours"
                                    placeholder="Ej: Lunes a Viernes 9:00 - 18:00"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <!-- Logo -->
                    <div class="border-b border-slate-200 pb-6">
                        <h4 class="text-lg font-semibold mb-4">Logo de la Empresa</h4>
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <label class="block text-sm font-semibold text-slate-700 mb-2">URL del Logo</label>
                                <input type="url" id="quote-logo-url" placeholder="https://..."
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                                <p class="text-xs text-slate-500 mt-1">Sube tu logo a Bunny.net o usa una URL p√∫blica
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="quote-show-logo" checked class="w-5 h-5">
                                <label for="quote-show-logo" class="text-sm font-semibold text-slate-700">Mostrar
                                    Logo</label>
                            </div>
                        </div>
                        <div id="quote-logo-preview"
                            class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
                            <p class="text-sm text-slate-600 mb-2">Vista Previa:</p>
                            <img id="quote-logo-preview-img" src="" alt="Logo preview" class="max-h-20">
                        </div>
                    </div>

                    <!-- Elementos a Mostrar -->
                    <div class="border-b border-slate-200 pb-6">
                        <h4 class="text-lg font-semibold mb-4">Elementos a Mostrar en el PDF</h4>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="quote-show-address" checked class="w-5 h-5">
                                <span class="text-sm">Direcci√≥n</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="quote-show-phone" checked class="w-5 h-5">
                                <span class="text-sm">Tel√©fono</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="quote-show-email" checked class="w-5 h-5">
                                <span class="text-sm">Email</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="quote-show-website" class="w-5 h-5">
                                <span class="text-sm">Sitio Web</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="quote-show-tax-id" class="w-5 h-5">
                                <span class="text-sm">RFC / ID Fiscal</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="quote-show-hours" checked class="w-5 h-5">
                                <span class="text-sm">Horarios</span>
                            </label>
                        </div>
                    </div>

                    <!-- Colores -->
                    <div class="border-b border-slate-200 pb-6">
                        <h4 class="text-lg font-semibold mb-4">Colores del PDF</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Color Principal</label>
                                <input type="color" id="quote-primary-color" value="#000000"
                                    class="w-full h-10 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Color Secundario</label>
                                <input type="color" id="quote-secondary-color" value="#666666"
                                    class="w-full h-10 border border-slate-300 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <!-- Pie de P√°gina -->
                    <div>
                        <h4 class="text-lg font-semibold mb-4">Pie de P√°gina Personalizado</h4>
                        <textarea id="quote-footer-text" rows="3"
                            placeholder="Texto que aparecer√° en el pie de p√°gina del PDF..."
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg"></textarea>
                    </div>
                </div>

                <div class="sticky bottom-0 bg-white border-t border-slate-200 p-6 flex justify-end gap-3">
                    <button id="cancel-quote-settings-btn"
                        class="px-4 py-2 text-slate-600 border border-slate-300 rounded-lg hover:bg-slate-50">
                        Cancelar
                    </button>
                    <button id="save-quote-settings-btn"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Guardar Configuraci√≥n
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Cotizaci√≥n -->
        <div id="quote-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex justify-between items-center">
                    <h3 id="quote-modal-title" class="text-2xl font-bold">Nueva Cotizaci√≥n</h3>
                    <button id="cancel-quote-btn" class="p-2 text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="p-6 space-y-6">
                    <!-- Informaci√≥n del Contacto -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Contacto *</label>
                        <div class="relative">
                            <input type="text" id="quote-contact-search"
                                placeholder="Buscar contacto por nombre o tel√©fono..." autocomplete="off"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <input type="hidden" id="quote-contact-id" value="">
                            <div id="quote-contact-results"
                                class="hidden absolute z-50 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                <!-- Los resultados se mostrar√°n aqu√≠ -->
                            </div>
                        </div>
                    </div>

                    <!-- Productos -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <label class="block text-sm font-semibold text-slate-700">Productos *</label>
                            <button onclick="addQuoteItem()"
                                class="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                                Agregar Producto
                            </button>
                        </div>
                        <div id="quote-items-container" class="space-y-3">
                            <p class="text-slate-500 text-center py-4">No hay productos agregados</p>
                        </div>
                    </div>

                    <!-- Totales -->
                    <div class="bg-slate-50 p-4 rounded-lg space-y-2">
                        <div class="flex justify-between">
                            <span class="text-slate-600">Subtotal:</span>
                            <span id="quote-subtotal" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-600">Descuento:</span>
                            <div class="flex items-center gap-2">
                                <input type="number" id="quote-discount" min="0" max="100" step="0.01" value="0"
                                    placeholder="%" class="w-20 px-2 py-1 border border-slate-300 rounded text-sm">
                                <span class="text-slate-500 text-sm">%</span>
                                <span id="quote-discount-display" class="font-semibold text-red-600">-$0.00</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="text-slate-600">IVA/Impuestos:</span>
                                <label class="flex items-center gap-1 text-xs text-slate-500">
                                    <input type="checkbox" id="quote-prices-include-tax" class="w-4 h-4">
                                    <span>Precios incluyen IVA</span>
                                </label>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" id="quote-tax" min="0" max="100" step="0.01" value="16"
                                    placeholder="%" class="w-20 px-2 py-1 border border-slate-300 rounded text-sm">
                                <span class="text-slate-500 text-sm">%</span>
                                <span id="quote-tax-display" class="font-semibold">$0.00</span>
                            </div>
                        </div>
                        <div class="flex justify-between pt-2 border-t border-slate-300">
                            <span class="text-lg font-bold text-slate-800">Total:</span>
                            <span id="quote-total" class="text-lg font-bold text-green-600">$0.00</span>
                        </div>
                    </div>

                    <!-- Fecha de validez y notas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">V√°lido hasta</label>
                            <input type="date" id="quote-valid-until"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Estado</label>
                            <select id="quote-status" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                                <option value="draft">Borrador</option>
                                <option value="sent">Enviada</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Notas adicionales</label>
                        <textarea id="quote-notes" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg"
                            placeholder="Notas internas o informaci√≥n adicional..."></textarea>
                    </div>
                </div>

                <div class="sticky bottom-0 bg-white border-t border-slate-200 p-6 flex justify-end gap-3">
                    <button id="cancel-quote-btn-bottom"
                        class="px-4 py-2 text-slate-600 border border-slate-300 rounded-lg hover:bg-slate-50">
                        Cancelar
                    </button>
                    <button id="create-quote-btn"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Crear Cotizaci√≥n
                    </button>
                    <button id="save-quote-btn"
                        class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Nueva Cita Manual -->
    <div id="new-appointment-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex items-center justify-between">
                <div>
                    <h3 class="text-xl font-bold">Nueva Cita</h3>
                    <p class="text-sm text-slate-500 mt-1">Agrega una cita manualmente a tu calendario</p>
                </div>
                <button id="close-new-appointment-modal-btn"
                    class="p-2 text-slate-400 hover:text-slate-600 rounded-lg hover:bg-slate-100 transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="new-appointment-form" class="p-6 space-y-4">
                <div class="relative">
                    <label for="appointment-contact-search"
                        class="block text-sm font-medium text-slate-700 mb-1">Contacto (Opcional)</label>
                    <div class="relative">
                        <input type="text" id="appointment-contact-search" class="form-input w-full text-sm pr-10"
                            placeholder="Buscar contacto por nombre o tel√©fono...">
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
                            <i data-lucide="search" class="w-4 h-4"></i>
                        </div>
                    </div>
                    <div id="appointment-contact-results"
                        class="hidden absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                    </div>
                    <input type="hidden" id="appointment-contact-select">
                </div>
                <div>
                    <label for="appointment-service-select"
                        class="block text-sm font-medium text-slate-700 mb-1">Servicio (Opcional)</label>
                    <select id="appointment-service-select" class="form-input w-full text-sm">
                        <option value="">Sin servicio</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-1">Si seleccionas un servicio, la duraci√≥n se calcular√°
                        autom√°ticamente</p>
                </div>
                <div>
                    <label for="appointment-title" class="block text-sm font-medium text-slate-700 mb-1">T√≠tulo de la
                        Cita *</label>
                    <input type="text" id="appointment-title" required class="form-input w-full text-sm"
                        placeholder="Ej: Consulta con Juan P√©rez">
                </div>
                <div>
                    <label for="appointment-start-date" class="block text-sm font-medium text-slate-700 mb-1">Fecha de
                        la Cita *</label>
                    <div class="relative date-input-wrapper" id="appointment-date-wrapper">
                        <input type="date" id="appointment-start-date" required
                            class="form-input w-full text-sm pr-10 relative z-10"
                            style="color: transparent !important; cursor: pointer;">
                        <div id="appointment-date-display"
                            class="absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none text-sm font-medium text-black z-20"
                            style="color: #000000 !important;">
                            Selecciona una fecha
                        </div>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none z-20">
                            <i data-lucide="calendar" class="w-5 h-5 text-green-600"></i>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Selecciona una fecha para ver los horarios disponibles</p>
                </div>
                <div id="appointment-time-slots-container" class="hidden">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Horarios Disponibles *</label>
                    <div id="appointment-time-slots"
                        class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 max-h-60 overflow-y-auto p-2 border border-slate-200 rounded-lg">
                        <!-- Los slots se cargar√°n din√°micamente aqu√≠ -->
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Selecciona un horario disponible</p>
                </div>
                <div id="appointment-selected-time-info"
                    class="hidden p-3 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-green-800">Horario seleccionado:</p>
                            <p class="text-sm text-green-700" id="appointment-selected-time-text"></p>
                        </div>
                        <button type="button" id="appointment-clear-time-btn"
                            class="text-xs text-green-600 hover:text-green-800 underline">Cambiar</button>
                    </div>
                </div>
                <input type="hidden" id="appointment-start-time" value="">
                <input type="hidden" id="appointment-end-time" value="">
                <input type="hidden" id="appointment-end-date" value="">
                <div>
                    <label for="appointment-status" class="block text-sm font-medium text-slate-700 mb-1">Estado</label>
                    <select id="appointment-status" class="form-input w-full text-sm">
                        <option value="pending">Pendiente</option>
                        <option value="confirmed" selected>Confirmada</option>
                        <option value="completed">Completada</option>
                        <option value="cancelled">Cancelada</option>
                    </select>
                </div>
                <div>
                    <label for="appointment-notes" class="block text-sm font-medium text-slate-700 mb-1">Notas
                        (Opcional)</label>
                    <textarea id="appointment-notes" rows="3" class="form-input w-full text-sm"
                        placeholder="Notas adicionales sobre la cita..."></textarea>
                </div>
            </form>
            <div class="p-6 bg-slate-50 flex justify-end gap-3 rounded-b-lg border-t">
                <button id="cancel-appointment-btn"
                    class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                <button id="save-appointment-btn"
                    class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Guardar
                    Cita</button>
            </div>
        </div>
    </div>

    <!-- Modal para Detalles/Edici√≥n de Cita -->
    <div id="appointment-details-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex items-center justify-between">
                <div>
                    <h3 class="text-xl font-bold">Detalles de la Cita</h3>
                    <p class="text-sm text-slate-500 mt-1">Ver y editar informaci√≥n de la cita</p>
                </div>
                <button id="close-appointment-details-modal-btn"
                    class="p-2 text-slate-400 hover:text-slate-600 rounded-lg hover:bg-slate-100 transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="appointment-details-form" class="p-6 space-y-4">
                <input type="hidden" id="appointment-details-id">
                <div class="relative">
                    <label for="appointment-details-contact-search"
                        class="block text-sm font-medium text-slate-700 mb-1">Contacto (Opcional)</label>
                    <div class="relative">
                        <input type="text" id="appointment-details-contact-search"
                            class="form-input w-full text-sm pr-10"
                            placeholder="Buscar contacto por nombre o tel√©fono...">
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
                            <i data-lucide="search" class="w-4 h-4"></i>
                        </div>
                    </div>
                    <div id="appointment-details-contact-results"
                        class="hidden absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                    </div>
                    <input type="hidden" id="appointment-details-contact-select">
                </div>
                <div>
                    <label for="appointment-details-service-select"
                        class="block text-sm font-medium text-slate-700 mb-1">Servicio (Opcional)</label>
                    <select id="appointment-details-service-select" class="form-input w-full text-sm">
                        <option value="">Sin servicio</option>
                    </select>
                </div>
                <div>
                    <label for="appointment-details-title" class="block text-sm font-medium text-slate-700 mb-1">T√≠tulo
                        de la Cita *</label>
                    <input type="text" id="appointment-details-title" required class="form-input w-full text-sm"
                        placeholder="Ej: Consulta con Juan P√©rez">
                </div>
                <div>
                    <label for="appointment-details-start-date"
                        class="block text-sm font-medium text-slate-700 mb-1">Fecha de la Cita *</label>
                    <div class="relative date-input-wrapper" id="appointment-details-date-wrapper">
                        <input type="date" id="appointment-details-start-date" required
                            class="form-input w-full text-sm pr-10 relative z-10"
                            style="color: transparent !important; cursor: pointer;">
                        <div id="appointment-details-date-display"
                            class="absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none text-sm font-medium text-black z-20"
                            style="color: #000000 !important;">
                            Selecciona una fecha
                        </div>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none z-20">
                            <i data-lucide="calendar" class="w-5 h-5 text-green-600"></i>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Selecciona una fecha para ver los horarios disponibles</p>
                </div>
                <div id="appointment-details-time-slots-container" class="hidden">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Horarios Disponibles *</label>
                    <div id="appointment-details-time-slots"
                        class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 max-h-60 overflow-y-auto p-2 border border-slate-200 rounded-lg">
                        <!-- Los slots se cargar√°n din√°micamente aqu√≠ -->
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Selecciona un horario disponible</p>
                </div>
                <div id="appointment-details-selected-time-info"
                    class="hidden p-3 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-green-800">Horario seleccionado:</p>
                            <p class="text-sm text-green-700" id="appointment-details-selected-time-text"></p>
                        </div>
                        <button type="button" id="appointment-details-clear-time-btn"
                            class="text-xs text-green-600 hover:text-green-800 underline">Cambiar</button>
                    </div>
                </div>
                <input type="hidden" id="appointment-details-start-time" value="">
                <input type="hidden" id="appointment-details-end-time" value="">
                <input type="hidden" id="appointment-details-end-date" value="">
                <div>
                    <label for="appointment-details-status"
                        class="block text-sm font-medium text-slate-700 mb-1">Estado</label>
                    <select id="appointment-details-status" class="form-input w-full text-sm">
                        <option value="pending">Pendiente</option>
                        <option value="confirmed">Confirmada</option>
                        <option value="completed">Completada</option>
                        <option value="cancelled">Cancelada</option>
                    </select>
                </div>
                <div>
                    <label for="appointment-details-notes" class="block text-sm font-medium text-slate-700 mb-1">Notas
                        (Opcional)</label>
                    <textarea id="appointment-details-notes" rows="3" class="form-input w-full text-sm"
                        placeholder="Notas adicionales sobre la cita..."></textarea>
                </div>
            </form>
            <div class="p-6 bg-slate-50 flex justify-between items-center rounded-b-lg border-t">
                <button id="delete-appointment-btn"
                    class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 flex items-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    Eliminar
                </button>
                <button id="send-reminder-btn"
                    class="bg-blue-100 text-blue-700 font-bold py-2 px-4 rounded-lg hover:bg-blue-200 flex items-center gap-2 mr-auto ml-3">
                    <i data-lucide="bell-ring" class="w-4 h-4"></i>
                    Enviar Recordatorio
                </button>
                <div class="flex gap-3">
                    <button id="cancel-appointment-details-btn"
                        class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                    <button id="save-appointment-details-btn"
                        class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Guardar
                        Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configuraci√≥n R√°pida de Citas -->
    <div id="appointments-quick-config-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                <div>
                    <h3 class="text-xl font-bold text-slate-800">Configuraci√≥n de Citas</h3>
                    <p class="text-sm text-slate-500 mt-1">Configura horarios, slots y opciones de citas</p>
                </div>
                <button id="close-appointments-config-modal-btn" class="p-2 rounded-full hover:bg-slate-100">
                    <i data-lucide="x" class="w-5 h-5 text-slate-600"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6">

                <!-- Horarios de Atenci√≥n -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-md font-semibold text-slate-800">Horarios de Atenci√≥n</h4>
                        <button id="refresh-hours-btn"
                            class="text-xs bg-slate-100 text-slate-700 px-2 py-1 rounded hover:bg-slate-200 flex items-center gap-1">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i> Actualizar
                        </button>
                    </div>
                    <p class="text-xs text-slate-500 mb-3">Configura los horarios disponibles para cada d√≠a de la
                        semana. Estos horarios se usan para calcular los slots disponibles.</p>
                    <div id="quick-config-hours-container" class="space-y-2">
                        <!-- Los horarios se cargar√°n din√°micamente aqu√≠ -->
                    </div>
                </div>

                <!-- Configuraci√≥n General -->
                <div class="border-t pt-4">
                    <h4 class="text-md font-semibold text-slate-800 mb-3">Configuraci√≥n General</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="quick-config-buffer-time"
                                class="block text-sm font-medium text-slate-700 mb-1">Tiempo entre Citas
                                (minutos)</label>
                            <input type="number" id="quick-config-buffer-time" min="0" step="5"
                                class="form-input w-full text-sm">
                            <p class="text-xs text-slate-500 mt-1">Tiempo de espera entre citas consecutivas</p>
                        </div>
                        <div>
                            <label for="quick-config-max-per-day"
                                class="block text-sm font-medium text-slate-700 mb-1">M√°ximo de Citas por D√≠a</label>
                            <input type="number" id="quick-config-max-per-day" min="1" placeholder="Sin l√≠mite"
                                class="form-input w-full text-sm">
                            <p class="text-xs text-slate-500 mt-1">Deja vac√≠o para permitir citas ilimitadas</p>
                        </div>
                        <div>
                            <label for="quick-config-default-duration"
                                class="block text-sm font-medium text-slate-700 mb-1">Duraci√≥n por Defecto
                                (minutos)</label>
                            <input type="number" id="quick-config-default-duration" min="15" step="15"
                                class="form-input w-full text-sm">
                            <p class="text-xs text-slate-500 mt-1">Duraci√≥n cuando no se especifica un servicio</p>
                        </div>
                        <div>
                            <label for="quick-config-timezone"
                                class="block text-sm font-medium text-slate-700 mb-1">Zona Horaria</label>
                            <select id="quick-config-timezone" class="form-input w-full text-sm">
                                <option value="America/Mexico_City">Ciudad de M√©xico (GMT-6)</option>
                                <option value="America/New_York">Nueva York (GMT-5)</option>
                                <option value="America/Los_Angeles">Los √Ångeles (GMT-8)</option>
                                <option value="America/Bogota">Bogot√° (GMT-5)</option>
                                <option value="America/Argentina/Buenos_Aires">Buenos Aires (GMT-3)</option>
                                <option value="America/Santiago">Santiago (GMT-3)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Servicios Disponibles -->
                <div class="border-t pt-4">
                    <h4 class="text-md font-semibold text-slate-800 mb-3">Servicios Disponibles</h4>
                    <p class="text-xs text-slate-500 mb-3">Estos servicios se usan para calcular los slots. Puedes
                        gestionarlos en el panel de Productos.</p>
                    <div id="quick-config-services-list" class="bg-slate-50 rounded-lg p-3 max-h-40 overflow-y-auto">
                        <!-- Los servicios se cargar√°n din√°micamente aqu√≠ -->
                    </div>
                </div>

                <!-- Acceso R√°pido -->
                <div class="border-t pt-4">
                    <h4 class="text-md font-semibold text-slate-800 mb-3">Acceso R√°pido</h4>
                    <div class="flex flex-wrap gap-2">
                        <button id="open-full-settings-btn"
                            class="text-xs bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-slate-200 flex items-center gap-1.5">
                            <i data-lucide="settings" class="w-3.5 h-3.5"></i>
                            Configuraci√≥n Completa
                        </button>
                        <button id="open-products-btn"
                            class="text-xs bg-blue-100 text-blue-700 px-3 py-2 rounded-lg hover:bg-blue-200 flex items-center gap-1.5">
                            <i data-lucide="boxes" class="w-3.5 h-3.5"></i>
                            Gestionar Servicios
                        </button>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-slate-50 flex justify-end gap-3 border-t flex-shrink-0">
                <button id="cancel-appointments-config-btn"
                    class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                <button id="save-appointments-config-btn"
                    class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Guardar
                    Cambios</button>
            </div>
        </div>
        <!-- Support Chat Widget -->
        <div id="support-chat-widget" class="fixed bottom-6 right-6 z-[60] hidden flex flex-col items-end font-sans">
            <!-- Chat Window -->
            <div
                class="bg-white rounded-2xl shadow-2xl w-80 sm:w-96 h-[500px] flex flex-col border border-slate-200 mb-4 animate-in slide-in-from-bottom-5 fade-in duration-300">
                <!-- Header -->
                <div class="bg-slate-900 text-white p-4 rounded-t-2xl flex justify-between items-center shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="bg-green-500 p-1.5 rounded-full"><i data-lucide="bot"
                                class="w-5 h-5 text-white"></i></div>
                        <div>
                            <h4 class="font-bold text-sm">Soporte Elina</h4>
                            <span class="text-[10px] text-green-400 flex items-center gap-1 font-medium"><span
                                    class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span> En l√≠nea</span>
                        </div>
                    </div>
                    <button id="support-close-btn" class="text-white/70 hover:text-white transition-colors"><i
                            data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <!-- Messages -->
                <div id="support-messages-container" class="flex-1 overflow-y-auto p-4 bg-slate-50 space-y-3">
                    <!-- Intro Msg -->
                    <div class="flex justify-start mb-3">
                        <div class="flex flex-col items-start">
                            <span class="text-[10px] text-slate-400 mb-1 px-1">Elina AI</span>
                            <div
                                class="max-w-[85%] bg-white border border-slate-100 text-slate-700 rounded-2xl rounded-bl-none p-3 text-sm shadow-sm">
                                Hola üëã, soy tu asistente de soporte. Puedo ayudarte con dudas sobre Elina o contactar a
                                un
                                humano si algo no funciona. ¬øEn qu√© te ayudo hoy?
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Input -->
                <div class="p-3 border-t bg-white rounded-b-2xl">
                    <div
                        class="flex items-center gap-2 bg-slate-100 rounded-full px-3 py-2 border border-transparent focus-within:border-blue-300 focus-within:ring-2 focus-within:ring-blue-100 transition-all">
                        <input id="support-input" type="text" placeholder="Escribe tu duda..."
                            class="flex-1 bg-transparent border-none text-sm focus:ring-0 placeholder:text-slate-400 outline-none">
                        <button id="support-send-btn"
                            class="bg-blue-600 text-white p-1.5 rounded-full hover:bg-blue-700 transition shadow-sm active:scale-95"><i
                                data-lucide="send" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Script eliminado: El wizard se maneja desde app.js -->
        <!-- Scripts for knowledge and sales context are now imported in app.js -->
        <!-- Logic moved to app.js -->

        <!-- HACK: Forzar bot√≥n de Verificar Estado si el cache impide que se cargue -->
        <script>
            (function () {
                console.log('üîß [HACK] Verificador de bot√≥n iniciado...');

                function ensureVerifyButton() {
                    const container = document.getElementById('whatsapp-connection-container');
                    const verifyBtn = document.getElementById('verify-whatsapp-status-btn');
                    const disconnectBtn = document.getElementById('disconnect-whatsapp-btn');

                    // Si el bot√≥n de desconectar est√° visible (= estamos conectados)
                    // PERO el bot√≥n de verificar NO existe, crearlo
                    if (disconnectBtn && disconnectBtn.style.display === 'block' && !verifyBtn) {
                        console.log('üîß [HACK] Detectado estado conectado SIN bot√≥n de verificar. Cre√°ndolo...');

                        // Crear el bot√≥n
                        const newBtn = document.createElement('button');
                        newBtn.id = 'verify-whatsapp-status-btn';
                        newBtn.className = 'w-full bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition shadow-md flex items-center justify-center gap-2';
                        newBtn.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i> Verificar Estado';

                        // Insertar ANTES del bot√≥n de desconectar
                        disconnectBtn.parentNode.insertBefore(newBtn, disconnectBtn);

                        // Agregar event listener
                        newBtn.addEventListener('click', async function () {
                            console.log('[HACK] Bot√≥n Verificar Estado clickeado');

                            if (!window.app || !window.app.verifyWhatsappStatus) {
                                console.error('[HACK] app.verifyWhatsappStatus no disponible');
                                return;
                            }

                            await window.app.verifyWhatsappStatus();
                        });

                        // Actualizar iconos de lucide
                        if (window.lucide) {
                            window.lucide.createIcons();
                        }

                        console.log('‚úÖ [HACK] Bot√≥n de Verificar Estado creado exitosamente');
                    }
                }

                // Ejecutar al cargar
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        setTimeout(ensureVerifyButton, 2000); // Esperar 2s para que app.js cargue
                    });
                } else {
                    setTimeout(ensureVerifyButton, 2000);
                }

                // Observar cambios en el contenedor (cuando cambia de desconectado a conectado)
                const observer = new MutationObserver(() => {
                    setTimeout(ensureVerifyButton, 500);
                });

                setTimeout(() => {
                    const container = document.getElementById('whatsapp-connection-container');
                    if (container) {
                        observer.observe(container, { childList: true, subtree: true });
                    }
                }, 1000);
            })();
        </script>

        <!-- Main Application Module - Entry Point -->
        <script type="module" src="./app.js"></script>
</body>

</html>